<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - MALEO TOOLS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-glass: rgba(26, 26, 46, 0.8);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0b0;
            --accent-primary: #3b82f6;
            --accent-secondary: #2563eb;
            --danger-primary: #ef4444;
            --danger-secondary: #dc2626;
            --success-primary: #22c55e;
            --warning-primary: #f59e0b;
            --premium-gold: #FBBF24;
            --subscription-cyan: #06b6d4;
        }

        html { height: 100%; }
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
        }

        /* --- LAYOUT UTAMA --- */
        #login-page {
            width: 100%;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .dashboard-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        /* --- TOP HEADER & NAVIGATION --- */
        .top-header {
            background: var(--bg-secondary);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-title {
            font-size: 1.5em;
            color: white;
            margin: 0;
            font-weight: 600;
        }
        .header-title i { color: var(--accent-primary); }
        .top-nav { display: flex; gap: 10px; flex-wrap: wrap; }
        .top-nav a {
            padding: 10px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.3s, color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .top-nav a:hover { background-color: var(--bg-primary); color: white; }
        .top-nav a.active { background: var(--accent-primary); color: white; font-weight: 600; }
        .header-actions { display: flex; gap: 10px; }


        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px;}
        .view-header h1 { margin: 0; text-shadow: 0 0 12px rgba(59, 130, 246, 0.5); }
        .view-header .actions { display: flex; gap: 10px; }


        /* --- KARTU STATISTIK --- */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            padding: 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .stat-card .icon {
            font-size: 2em;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .stat-card:nth-child(1) .icon { background: rgba(59, 130, 246, 0.2); color: var(--accent-primary); }
        .stat-card:nth-child(2) .icon { background: rgba(34, 197, 94, 0.2); color: var(--success-primary); }
        .stat-card:nth-child(3) .icon { background: rgba(245, 158, 11, 0.2); color: var(--warning-primary); }
        .stat-card:nth-child(4) .icon { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .stat-card .info h3 { margin: 0 0 5px 0; font-size: 1.8em; color: white; }
        .stat-card .info p { margin: 0; color: var(--text-secondary); }

        /* --- KONTROL --- */
        .controls-container {
             background: var(--bg-glass);
             border: 1px solid var(--border-color);
             border-radius: 12px;
             padding: 20px;
             margin-bottom: 20px;
        }
        .controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .search-bar { position: relative; flex-grow: 1; }
        .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .search-bar .input-field { padding-left: 40px; width: 100%; max-width: 400px; box-sizing: border-box;}

        /* --- KARTU PENGGUNA, TRANSAKSI, & AKUN JUAL --- */
        #user-card-container, #pending-transaction-container, #account-card-container, #stok-akun-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            position: relative;
        }
        
        .section-heading {
            grid-column: 1 / -1;
            color: var(--accent-primary);
            margin-bottom: -5px;
            margin-top: 10px;
            font-size: 1.2em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .user-profile-card, .transaction-card, .account-card, .stok-akun-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative; /* Diperlukan untuk stempel SOLD */
            overflow: hidden; /* Mencegah stempel keluar dari kartu */
        }
        .user-profile-card:hover, .transaction-card:hover, .account-card:hover, .stok-akun-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .transaction-card {
            border-left: 4px solid var(--warning-primary);
        }
        .account-card {
             border-left: 4px solid var(--accent-primary);
        }
        .stok-akun-card {
            border-left: 4px solid var(--subscription-cyan);
        }

        .sold-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            font-size: 5em;
            font-weight: 800;
            color: rgba(239, 68, 68, 0.35);
            border: 4px solid rgba(239, 68, 68, 0.35);
            padding: 0 15px;
            border-radius: 10px;
            z-index: 1;
            pointer-events: none; /* PENTING: agar tombol di bawahnya bisa diklik */
            text-transform: uppercase;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .card-header .user-title {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .card-header .user-title h3 {
            margin: 0;
            font-size: 1.2rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
         .card-header .user-title h3 .pending-indicator {
            color: var(--warning-primary);
            font-size: 0.9em;
            animation: pulse 1.5s infinite;
         }
         @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
         }
        
        .card-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .info-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .info-value {
            font-size: 0.95em;
            font-weight: 600;
            word-break: break-all;
        }
        .info-value .copy-btn {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            font-size: 1.1em; margin-left: 5px; vertical-align: middle;
        }
        .info-value .copy-btn:hover { color: var(--accent-primary); }
        .info-value.voucher-code {
            color: var(--premium-gold);
            font-family: monospace;
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
            letter-spacing: 1px;
        }

        .transaction-details-section {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning-primary);
            padding: 12px;
            border-radius: 8px;
        }
        .transaction-details-section h4 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            text-transform: uppercase;
            color: var(--warning-primary);
        }
        .transaction-amount {
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            text-align: center;
        }
        
        .card-actions {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }
        .card-actions .action-button {
            flex-grow: 1;
        }
        
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; color: var(--text-secondary); flex-wrap: wrap; gap: 15px;}
        .pagination button { width: auto; }
        
        /* --- Gaya untuk Status User & Akun --- */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; display: inline-block; }
        .status-user { background-color: rgba(100, 116, 139, 0.2); color: #94a3b8; }
        .status-premium { background-color: rgba(251, 191, 36, 0.2); color: var(--premium-gold); }
        .status-langganan { background-color: rgba(6, 182, 212, 0.2); color: var(--subscription-cyan); }
        .status-available { background-color: rgba(34, 197, 94, 0.2); color: var(--success-primary); }
        .status-processing { background-color: rgba(245, 158, 11, 0.2); color: var(--warning-primary); }
        .status-verified { background-color: rgba(59, 130, 246, 0.2); color: var(--accent-primary); }
        
        .status-select {
            background-color: var(--bg-secondary); border: 2px solid var(--border-color); color: var(--text-primary);
            border-radius: 6px; padding: 5px 8px; font-family: 'Poppins', sans-serif; font-weight: 500; transition: all 0.2s ease;
            width: 100%;
        }
        .status-select:focus { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .status-select.processing { border-color: var(--warning-primary); color: var(--warning-primary); }
        .status-select.verified { border-color: var(--accent-primary); color: var(--accent-primary); }

        /* --- KOMPONEN UMUM --- */
        .form-container {
            background: var(--bg-secondary); backdrop-filter: blur(15px); border: 1px solid var(--border-color);
            padding: 40px; border-radius: 15px; width: 100%; max-width: 400px;
            box-sizing: border-box; text-align: center;
        }
        .form-container h2 { margin-top: 0; color: white; }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .input-field, textarea.input-field, select.input-field {
            width: 100%; padding: 15px; box-sizing: border-box; background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 1em;
            transition: border-color 0.3s; font-family: 'Poppins', sans-serif;
        }
        select.input-field {
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%23a0a0b0' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E%0A");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 1.2em;
        }
        .input-field:focus, textarea.input-field:focus, select.input-field:focus { outline: none; border-color: var(--accent-primary); }
        .password-wrapper { position: relative; }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; }

        .action-button {
            padding: 12px 20px; border-radius: 8px; color: white; font-size: 1em; font-weight: 600; cursor: pointer;
            border: none; transition: opacity 0.3s; display: inline-flex; align-items: center; gap: 8px; justify-content: center;
        }
        .action-button:hover { opacity: 0.9; }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: linear-gradient(45deg, var(--accent-secondary), var(--accent-primary)); }
        .btn-danger { background: linear-gradient(45deg, var(--danger-secondary), var(--danger-primary)); }
        .btn-secondary { background: #64748b; }
        .btn-success { background: var(--success-primary); }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            align-items: center; justify-content: center; padding: 15px; box-sizing: border-box;
        }
        .modal-content {
            background-color: var(--bg-secondary); margin: auto; padding: 30px;
            border: 1px solid var(--border-color); width: 100%; max-width: 550px; border-radius: 15px;
            animation: modal-fade-in 0.3s ease;
        }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content h2 { margin-top: 0; color: white; }
        .modal-actions { margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* --- TOAST / NOTIFIKASI --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background-color: var(--bg-secondary); color: white; padding: 15px 20px;
            border-radius: 8px; margin-bottom: 10px; border-left: 4px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;
            opacity: 0; transform: translateX(100%); animation: toast-in 0.5s forwards;
        }
        .toast.success { border-color: var(--success-primary); }
        .toast.error { border-color: var(--danger-primary); }
        @keyframes toast-in { to { opacity: 1; transform: translateX(0); } }

        /* --- LOADING SPINNER --- */
        .spinner-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 46, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10; border-radius: 12px; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.2); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- Kustomisasi Form Edit User --- */
        #subscription-fields { display: none; }
        .date-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .date-buttons button { flex-grow: 1; padding: 10px; font-size: 0.9em; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        #admin-panel { display: none; }
        #login-page { display: flex; }
        
        /* --- [MODIFIKASI] TAMPILAN SUPER KOMPAK --- */
        :root {
            font-size: 10px;
        }
        .main-content { padding: 8px; }
        .top-header { padding: 4px 10px; gap: 8px; }
        .header-title { font-size: 1.2em; }
        .top-nav { gap: 5px; }
        .top-nav a { padding: 4px 8px; font-size: 1em; gap: 4px; }
        .header-actions { gap: 5px; }
        .header-actions .action-button { padding: 4px 8px; font-size: 1em; }

        .view-header { margin-bottom: 12px; gap: 10px; }
        .view-header h1 { font-size: 1.6em; }
        .view-header .actions .action-button { font-size: 1em; }
        
        .stat-cards { gap: 8px; margin-bottom: 12px; }
        .stat-card { padding: 8px; gap: 8px; border-radius: 6px; }
        .stat-card .icon { width: 32px; height: 32px; font-size: 1.4em; }
        .stat-card .info h3 { font-size: 1.5em; margin-bottom: 2px; }
        .stat-card .info p { font-size: 0.9em; }
        
        .controls-container { padding: 10px; margin-bottom: 12px; }
        .controls { gap: 10px; }
        
        #user-card-container, #pending-transaction-container, #stok-akun-card-container { gap: 10px; }
        .user-profile-card, .transaction-card, .stok-akun-card { padding: 12px; border-radius: 8px; gap: 10px; }
        .card-header { padding-bottom: 8px; margin-bottom: 10px; }
        .card-header .user-title h3 { font-size: 1.3em; }
        .card-info-grid { gap: 10px; }
        .info-label { font-size: 0.9em; }
        .info-value { font-size: 1em; }
        
        .transaction-details-section { padding: 8px; }
        .transaction-details-section h4 { font-size: 0.9em; margin-bottom: 6px; }
        .transaction-amount { font-size: 1.3em; }
        
        .card-actions { padding-top: 10px; gap: 8px; }
        .card-actions .action-button { font-size: 1em; }

        .pagination { margin-top: 15px; }
        .pagination, .pagination .action-button { font-size: 1em; }
        
        .input-group { margin-bottom: 12px; }
        .input-group label { margin-bottom: 4px; font-size: 1em; }
        .input-field, textarea.input-field, select.input-field { padding: 8px; font-size: 1.1em; border-radius: 5px; }
        
        .action-button { padding: 7px 14px; font-size: 1em; border-radius: 5px; gap: 5px; }
        
        .modal-content { padding: 20px; max-width: 480px; }
        .modal-content h2 { font-size: 1.3em; margin-bottom: 15px; }
        .modal-actions { margin-top: 20px; }
        
        .status-badge { padding: 3px 7px; font-size: 0.9em; }
        .status-select { padding: 3px 5px; font-size: 1em; }
        
        /* --- [MODIFIKASI SPESIFIK] Perkecil Kartu Akun Jual --- */
        #account-card-container, #stok-akun-card-container {
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px;
        }
        #account-card-container .account-card, #stok-akun-card-container .stok-akun-card {
            padding: 10px;
            gap: 8px;
        }
        #account-card-container .card-header, #stok-akun-card-container .card-header {
            padding-bottom: 6px;
            margin-bottom: 8px;
        }
        #account-card-container .card-header h3, #stok-akun-card-container .card-header h3 {
            font-size: 1.1em;
        }
        #account-card-container .card-header .info-value, #stok-akun-card-container .card-header .info-value {
            font-size: 1em;
        }
        #account-card-container .card-info-grid, #stok-akun-card-container .card-info-grid {
            gap: 8px;
        }
        #account-card-container .info-label, #stok-akun-card-container .info-label {
            font-size: 0.85em;
        }
         #account-card-container .info-value, #stok-akun-card-container .info-value {
            font-size: 0.95em;
        }
        #account-card-container .card-actions, #stok-akun-card-container .card-actions {
            padding-top: 8px;
            gap: 6px;
        }
        #account-card-container .action-button, #stok-akun-card-container .action-button {
            padding: 4px 8px;
            font-size: 0.9em;
        }
        
        /* [MODIFIKASI BARU] Gaya untuk Stok Akun yang Terpakai */
        .stok-akun-card.claimed {
            border-left-color: var(--warning-primary);
            background: rgba(30, 30, 46, 0.7);
        }
        .info-value.owner {
            color: var(--premium-gold);
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .main-content { padding: 5px; }
            .top-header { padding: 5px; }
            #user-card-container, #pending-transaction-container, #account-card-container, #stok-akun-card-container { grid-template-columns: 1fr; }
            .modal-content { padding: 15px; }
        }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="form-container">
            <h2><i class="fas fa-shield-halved"></i> Admin Panel Login</h2>
            <form id="login-form">
                <div class="input-group"> <input type="email" id="email" class="input-field" placeholder="Email Admin" required> </div>
                <div class="input-group"> <input type="password" id="password" class="input-field" placeholder="Password Admin" required> </div>
                <button type="submit" class="action-button btn-primary" style="width:100%;"> <i class="fas fa-sign-in-alt"></i> Login </button>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="dashboard-layout">
        <header class="top-header">
            <h2 class="header-title"><i class="fas fa-gamepad"></i> Auth Tools</h2>
            <nav class="top-nav"> 
                <a href="#" id="nav-users" class="active"><i class="fas fa-users"></i> User</a> 
                <a href="#" id="nav-transactions"><i class="fas fa-exchange-alt"></i> Transaction</a>
                <a href="#" id="nav-accounts"><i class="fas fa-tags"></i> Akun Jual</a>
                <a href="#" id="nav-stok-akun"><i class="fas fa-archive"></i> Stok Akun</a>
            </nav>
            <div class="header-actions">
                <button id="logout-btn" class="action-button btn-danger"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>

        <main class="main-content">
            <div id="user-management-view">
                <header class="view-header">
                    <h1>User Management</h1>
                    <div class="actions">
                        <button id="add-user-btn" class="action-button btn-success"><i class="fas fa-plus"></i> Add User</button>
                    </div>
                </header>

                <div class="stat-cards">
                    <div class="stat-card"> <div class="icon"><i class="fas fa-users"></i></div> <div class="info"> <h3 id="stat-total-users">0</h3> <p>Total Users</p> </div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-tags"></i></div> <div class="info"> <h3 id="stat-accounts-for-sale">0</h3> <p>Akun Dijual</p> </div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-hourglass-half"></i></div> <div class="info"> <h3 id="stat-pending-trx">0</h3> <p>Pending Requests</p> </div> </div>
                    <div class="stat-card"> <div class="icon"><i class="fas fa-cash-register"></i></div> <div class="info"> <h3 id="stat-total-spent">0</h3> <p>Total Dibelanjakan</p> </div> </div>
                </div>

                <div class="controls-container">
                    <div class="controls">
                        <div class="search-bar"> <i class="fas fa-search"></i> <input type="text" id="search-input" class="input-field" placeholder="Search by username, whatsapp, device ID..."> </div>
                        <button id="refresh-users-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>

                <div id="user-card-container">
                    </div>
                <div class="spinner-overlay" id="user-spinner" style="display:none;"><div class="spinner"></div></div>

                <div class="pagination">
                    <span id="page-info"></span>
                    <div class="pagination-controls">
                        <button id="prev-page-btn" class="action-button btn-secondary"><i class="fas fa-arrow-left"></i> Prev</button>
                        <button id="next-page-btn" class="action-button btn-secondary">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                <small id="last-refreshed" style="display: block; margin-top: 15px; text-align: right; color: var(--text-secondary);"></small>
            </div>

            <div id="transaction-management-view" style="display: none;">
                <header class="view-header">
                    <h1>Pending Transactions</h1>
                     <div class="actions">
                        <button id="refresh-transactions-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </header>
                <div id="pending-transaction-container">
                    </div>
                 <div class="spinner-overlay" id="transaction-spinner" style="display:none;"><div class="spinner"></div></div>
            </div>


            <div id="account-management-view" style="display: none;">
                 <header class="view-header">
                    <h1>Manajemen Akun Jual</h1>
                    <div class="actions">
                        <button id="add-account-btn" class="action-button btn-success"><i class="fas fa-plus"></i> Tambah Akun</button>
                    </div>
                </header>
                <div class="controls-container">
                    <div class="controls">
                         <button id="refresh-accounts-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div id="account-card-container">
                    </div>
                <div class="spinner-overlay" id="account-spinner" style="display:none;"><div class="spinner"></div></div>
            </div>
            
            <div id="stok-akun-management-view" style="display: none;">
                 <header class="view-header">
                    <h1>Manajemen Stok Akun</h1>
                    <div class="actions">
                        <button id="add-stok-akun-btn" class="action-button btn-success"><i class="fas fa-plus"></i> Tambah Stok</button>
                    </div>
                </header>
                <div class="controls-container">
                    <div class="controls">
                         <button id="refresh-stok-akun-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div id="stok-akun-card-container">
                    </div>
                <div class="spinner-overlay" id="stok-akun-spinner" style="display:none;"><div class="spinner"></div></div>
            </div>

        </main>
    </div>

    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Edit User Data</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-doc-id">
                <div class="input-group"> <label for="edit-username">Username</label> <input type="text" id="edit-username" class="input-field" required> </div>
                <div class="input-group">
                    <label for="edit-accountType">Account Type</label>
                    <select id="edit-accountType" class="input-field" required>
                        <option value="USER">USER</option>
                        <option value="PREMIUM">PREMIUM</option>
                        <option value="Langganan">Langganan</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div id="subscription-fields">
                    <div class="input-group">
                        <label for="edit-masaAktifHingga">Masa Aktif Hingga</label>
                        <input type="date" id="edit-masaAktifHingga" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Tambah / Kurangi Masa Aktif</label>
                        <div class="date-buttons">
                            <button type="button" class="action-button btn-danger date-mod-btn" data-days="-30">-30 Hari</button>
                            <button type="button" class="action-button btn-danger date-mod-btn" data-days="-7">-7 Hari</button>
                            <button type="button" class="action-button btn-success date-mod-btn" data-days="7">+7 Hari</button>
                            <button type="button" class="action-button btn-success date-mod-btn" data-days="30">+30 Hari</button>
                        </div>
                    </div>
                </div>
                <div class="input-group"> <label for="edit-saldo">Saldo (Angka saja)</label> <input type="number" id="edit-saldo" class="input-field" required> </div>
                <div class="input-group"> <label for="edit-pendingTransaction">Pending Transaction (Angka saja)</label> <input type="number" id="edit-pendingTransaction" class="input-field" required> </div>
                <div class="input-group"> <label for="edit-whatsapp">WhatsApp</label> <input type="text" id="edit-whatsapp" class="input-field" required> </div>
                <div class="input-group"> <label for="edit-password">Password</label> <div class="password-wrapper"> <input type="password" id="edit-password" class="input-field" required> <button type="button" class="password-toggle"><i class="fas fa-eye"></i></button> </div> </div>
                <div class="modal-actions"> <button type="button" class="action-button btn-secondary cancel-modal-btn">Cancel</button> <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Save</button> </div>
            </form>
        </div>
    </div>
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-user-plus"></i> Add New User</h2>
            <form id="add-user-form">
                <div class="input-group"> <label for="add-username">Username</label> <input type="text" id="add-username" class="input-field" required> </div>
                <div class="input-group"> <label for="add-saldo">Saldo (Angka saja)</label> <input type="number" id="add-saldo" class="input-field" value="0" required> </div>
                <div class="input-group"> <label for="add-pendingTransaction">Pending Transaction</label> <input type="number" id="add-pendingTransaction" class="input-field" value="0" required> </div>
                <div class="input-group"> <label for="add-whatsapp">WhatsApp</label> <input type="text" id="add-whatsapp" class="input-field" required> </div>
                <div class="input-group"> <label for="add-password">Password</label> <div class="password-wrapper"> <input type="password" id="add-password" class="input-field" required> <button type="button" class="password-toggle"><i class="fas fa-eye"></i></button> </div> </div>
                <div class="modal-actions"> <button type="button" class="action-button btn-secondary cancel-modal-btn">Cancel</button> <button type="submit" class="action-button btn-success"><i class="fas fa-plus"></i> Create</button> </div>
            </form>
        </div>
    </div>

    <div id="edit-account-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Edit Akun Jual</h2>
            <form id="edit-account-form">
                <input type="hidden" id="edit-account-id">
                <div class="form-grid">
                    <div class="input-group">
                        <label for="edit-account-gameType">Jenis Game</label>
                        <select id="edit-account-gameType" class="input-field" required>
                            <option value="BUSSID">BUSSID</option>
                            <option value="TRUCKSID">TRUCKSID</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="edit-account-linkedTo">Kelengkapan Akun</label>
                        <select id="edit-account-linkedTo" class="input-field" required>
                            <option value="Google">Google</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="edit-account-price">Harga Jual (Rp)</label>
                        <input type="number" id="edit-account-price" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-account-ubAmount">Jumlah UB</label>
                        <input type="number" id="edit-account-ubAmount" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-account-leaderboard">Peringkat S. Masa</label>
                        <input type="number" id="edit-account-leaderboard" class="input-field" placeholder="Contoh: 150">
                    </div>
                     <div class="input-group" style="display: none;">
                        <label for="edit-account-status">Status</label>
                        <select id="edit-account-status" class="input-field">
                            <option value="available">Available</option>
                            <option value="processing">Processing</option>
                            <option value="verified">Verified</option>
                        </select>
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 15px 0;">
                <h3 style="color: var(--text-secondary); font-weight: 500;">Kredensial Akun (Untuk Pembeli)</h3>
                <div class="input-group">
                    <label for="edit-account-email">Email / No. HP Akun</label>
                    <input type="text" id="edit-account-email" class="input-field">
                </div>
                <div class="input-group">
                    <label for="edit-account-password">Password Akun</label>
                    <input type="text" id="edit-account-password" class="input-field">
                </div>
                <div class="input-group">
                    <label for="edit-account-additionalInfo">Info Tambahan</label>
                    <textarea id="edit-account-additionalInfo" class="input-field" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-account-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-plus-circle"></i> Tambah Akun untuk Dijual</h2>
            <form id="add-account-form">
                 <div class="form-grid">
                    <div class="input-group">
                        <label for="add-account-gameType">Jenis Game</label>
                        <select id="add-account-gameType" class="input-field" required>
                            <option value="BUSSID">BUSSID</option>
                            <option value="TRUCKSID">TRUCKSID</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="add-account-linkedTo">Kelengkapan Akun</label>
                        <select id="add-account-linkedTo" class="input-field" required>
                            <option value="Google">Google</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="add-account-price">Harga Jual (Rp)</label>
                        <input type="number" id="add-account-price" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="add-account-ubAmount">Jumlah UB</label>
                        <input type="number" id="add-account-ubAmount" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label for="add-account-leaderboard">Peringkat S. Masa</label>
                        <input type="number" id="add-account-leaderboard" class="input-field" placeholder="Contoh: 150">
                    </div>
                </div>
                <hr style="border-color: var(--border-color); margin: 15px 0;">
                <h3 style="color: var(--text-secondary); font-weight: 500;">Kredensial Akun (Wajib Diisi)</h3>
                <div class="input-group">
                    <label for="add-account-email">Email / No. HP Akun</label>
                    <input type="text" id="add-account-email" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="add-account-password">Password Akun</label>
                    <input type="text" id="add-account-password" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="add-account-additionalInfo">Info Tambahan</label>
                    <textarea id="add-account-additionalInfo" class="input-field" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-success"><i class="fas fa-plus"></i> Posting</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-stok-akun-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Edit Stok Akun</h2>
            <form id="edit-stok-akun-form">
                <input type="hidden" id="edit-stok-akun-id">
                <div class="form-grid">
                    <div class="input-group">
                        <label for="edit-stok-akun-gameType">Jenis Game</label>
                        <select id="edit-stok-akun-gameType" class="input-field" required>
                            <option value="BUSSID">BUSSID</option>
                            <option value="TRUCKSID">TRUCKSID</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="edit-stok-akun-loginType">Jenis Login</label>
                        <select id="edit-stok-akun-loginType" class="input-field" required>
                            <option value="Google">Google</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                </div>
                 <div class="input-group">
                    <label for="edit-stok-akun-gameName">Nama Akun di Game</label>
                    <input type="text" id="edit-stok-akun-gameName" class="input-field" required>
                </div>
                <hr style="border-color: var(--border-color); margin: 15px 0;">
                <div class="input-group">
                    <label for="edit-stok-akun-email">Email / No. HP</label>
                    <input type="text" id="edit-stok-akun-email" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="edit-stok-akun-password">Password</label>
                    <input type="text" id="edit-stok-akun-password" class="input-field" required>
                </div>
                 <div class="input-group">
                    <label for="edit-stok-akun-deviceId">Device ID</label>
                    <input type="text" id="edit-stok-akun-deviceId" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="edit-stok-akun-voucherCode">Kode Voucher</label>
                    <input type="text" id="edit-stok-akun-voucherCode" class="input-field" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-stok-akun-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-plus-circle"></i> Tambah ke Stok Akun</h2>
            <form id="add-stok-akun-form">
                 <div class="form-grid">
                    <div class="input-group">
                        <label for="add-stok-akun-gameType">Jenis Game</label>
                        <select id="add-stok-akun-gameType" class="input-field" required>
                            <option value="BUSSID">BUSSID</option>
                            <option value="TRUCKSID">TRUCKSID</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="add-stok-akun-loginType">Jenis Login</label>
                        <select id="add-stok-akun-loginType" class="input-field" required>
                            <option value="Google">Google</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                </div>
                 <div class="input-group">
                    <label for="add-stok-akun-gameName">Nama Akun di Game</label>
                    <input type="text" id="add-stok-akun-gameName" class="input-field" required>
                </div>
                <hr style="border-color: var(--border-color); margin: 15px 0;">
                <div class="input-group">
                    <label for="add-stok-akun-email">Email / No. HP</label>
                    <input type="text" id="add-stok-akun-email" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="add-stok-akun-password">Password</label>
                    <input type="text" id="add-stok-akun-password" class="input-field" required>
                </div>
                 <div class="input-group">
                    <label for="add-stok-akun-deviceId">Device ID</label>
                    <input type="text" id="add-stok-akun-deviceId" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="add-stok-akun-voucherCode">Kode Voucher</label>
                    <input type="text" id="add-stok-akun-voucherCode" class="input-field" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-success"><i class="fas fa-plus"></i> Tambah ke Stok</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <h2 id="confirm-title" style="color: var(--danger-primary);"><i class="fas fa-exclamation-triangle"></i> Confirmation</h2>
            <p id="confirm-message" style="font-size: 1.1em; color: var(--text-primary); margin: 20px 0;">Are you sure?</p>
            <div class="modal-actions" style="justify-content: center;">
                 <button type="button" id="confirm-cancel-btn" class="action-button btn-secondary">Cancel</button>
                 <button type="button" id="confirm-ok-btn" class="action-button btn-danger">Yes, I'm sure</button>
            </div>
        </div>
    </div>
    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, serverTimestamp, setDoc, getDoc, deleteField, orderBy, query } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3KJT9eh42V6ytLoY5e4ozzDXY4sHhado",
            authDomain: "donitata1717-f10f7.firebaseapp.com",
            projectId: "donitata1717-f10f7",
            storageBucket: "donitata1717-f10f7.appspot.com",
            messagingSenderId: "760325542999",
            appId: "1:760325542999:web:be97c17580f64407e33f12",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State variables
        let allUsers = [], displayedUsers = [], currentPage = 1, allAccountsForSale = [], allStokAkun = [];
        const rowsPerPage = 10;

        // DOM element references
        const dom = { 
            loginPage: document.getElementById('login-page'), 
            adminPanel: document.getElementById('admin-panel'), 
            userCardContainer: document.getElementById('user-card-container'),
            pendingTransactionContainer: document.getElementById('pending-transaction-container'),
            accountCardContainer: document.getElementById('account-card-container'),
            stokAkunCardContainer: document.getElementById('stok-akun-card-container'),
            searchInput: document.getElementById('search-input'),
            userSpinner: document.getElementById('user-spinner'),
            transactionSpinner: document.getElementById('transaction-spinner'),
            accountSpinner: document.getElementById('account-spinner'),
            stokAkunSpinner: document.getElementById('stok-akun-spinner'),
            editUserModal: document.getElementById('edit-user-modal'), 
            addUserModal: document.getElementById('add-user-modal'), 
            editAccountModal: document.getElementById('edit-account-modal'),
            addAccountModal: document.getElementById('add-account-modal'),
            editStokAkunModal: document.getElementById('edit-stok-akun-modal'),
            addStokAkunModal: document.getElementById('add-stok-akun-modal'),
            confirmModal: document.getElementById('confirm-modal'),
            nav: {
                users: document.getElementById('nav-users'),
                transactions: document.getElementById('nav-transactions'),
                accounts: document.getElementById('nav-accounts'),
                stokAkun: document.getElementById('nav-stok-akun')
            },
            views: {
                users: document.getElementById('user-management-view'),
                transactions: document.getElementById('transaction-management-view'),
                accounts: document.getElementById('account-management-view'),
                stokAkun: document.getElementById('stok-akun-management-view')
            }
        };

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i> ${message}`;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3500);
        };

        // --- VIEW MANAGEMENT ---
        const showView = async (viewName) => {
            Object.values(dom.views).forEach(view => view.style.display = 'none');
            Object.values(dom.nav).forEach(navLink => navLink.classList.remove('active'));
            
            dom.views[viewName].style.display = 'block';
            dom.nav[viewName].classList.add('active');
            
            if (viewName === 'users') {
                await fetchUsers();
            } else if (viewName === 'accounts') {
                await fetchAccountsForSale();
            } else if (viewName === 'transactions') {
                await fetchAndRenderTransactions();
            } else if (viewName === 'stokAkun') {
                await fetchStokAkun();
            }
        };

        // --- USER MANAGEMENT FUNCTIONS ---
        const fetchUsers = async () => {
            dom.userSpinner.style.display = 'flex';
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                allUsers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentPage = 1;
                filterAndDisplayUsers();
                updateStats();
                updateTotalSpentStat();
                document.getElementById('last-refreshed').textContent = `Last refreshed: ${new Date().toLocaleTimeString('id-ID')}`;
            } catch (error) {
                console.error("Error fetching users:", error);
                showToast('Error fetching user data.', 'error');
                dom.userCardContainer.innerHTML = `<p style="text-align:center; color: var(--danger-primary);">Error fetching data.</p>`;
            } finally {
                dom.userSpinner.style.display = 'none';
            }
        };
        
        const filterAndDisplayUsers = () => {
            const searchTerm = dom.searchInput.value.toLowerCase();
            displayedUsers = allUsers.filter(user => 
                (user.username?.toLowerCase() || '').includes(searchTerm) || 
                (user.whatsapp?.toString() || '').includes(searchTerm) || 
                (user.device_id?.toLowerCase() || '').includes(searchTerm)
            );
            renderUserCards();
        };

        const renderUserCards = () => {
            dom.userCardContainer.innerHTML = '';
            if (displayedUsers.length === 0) {
                dom.userCardContainer.innerHTML = '<p style="text-align:center;">No users found.</p>';
                document.getElementById('page-info').textContent = 'Showing 0-0 of 0';
                updatePaginationControls();
                return;
            }

            const paginatedUsers = displayedUsers.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);

            paginatedUsers.forEach(user => {
                const accountType = user.accountType || 'USER';
                let statusBadgeClass = 'status-user';
                if (accountType === 'PREMIUM') statusBadgeClass = 'status-premium';
                if (accountType === 'Langganan') statusBadgeClass = 'status-langganan';
                if (accountType === 'Admin') statusBadgeClass = 'status-premium';

                let saldoOrMasaAktifHTML = `Rp ${(user.saldo || 0).toLocaleString('id-ID')}`;
                if (accountType === 'Langganan') {
                    const endDateString = user.masaAktifHingga;
                    if (endDateString) {
                        const parts = endDateString.split('-').map(p => parseInt(p, 10));
                        const endDate = new Date(parts[0], parts[1] - 1, parts[2], 23, 59, 59, 999);
                        const diffTime = endDate.getTime() - new Date().getTime();
                        saldoOrMasaAktifHTML = (diffTime < 0) ? `<span style="color: var(--danger-primary);">Expired</span>` : `${Math.ceil(diffTime / (1000 * 60 * 60 * 24))} hari`;
                    } else {
                        saldoOrMasaAktifHTML = 'Belum diatur';
                    }
                }
                
                let pendingIndicatorHTML = '';
                if ((user.pendingTransaction && user.pendingTransaction > 0) || user.pendingSubscription) {
                    pendingIndicatorHTML = '<i class="fas fa-bell pending-indicator" title="Pending Transaction"></i>';
                }

                const cardHTML = `
                    <div class="user-profile-card">
                        <div class="card-header">
                            <div class="user-title">
                                <h3>${user.username || ''} ${pendingIndicatorHTML}</h3>
                                <span class="status-badge ${statusBadgeClass}">${accountType}</span>
                            </div>
                        </div>
                        <div class="card-info-grid">
                            <div class="info-item">
                                <span class="info-label">Saldo / Sisa Aktif</span>
                                <span class="info-value">${saldoOrMasaAktifHTML}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">WhatsApp</span>
                                <span class="info-value">${user.whatsapp || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Device ID</span>
                                <span class="info-value">
                                    ${user.device_id || 'N/A'}
                                    <button class="copy-btn" data-text="${user.device_id || ''}" title="Copy ID"><i class="far fa-copy"></i></button>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Password</span>
                                <span class="info-value"></span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="action-button btn-primary edit-user-btn" data-doc-id="${user.id}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="action-button btn-danger delete-user-btn" data-doc-id="${user.id}" data-username="${user.username}"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                dom.userCardContainer.innerHTML += cardHTML;
            });

            addCardButtonListeners();
            updatePaginationControls();
        };

        // --- TRANSACTION MANAGEMENT FUNCTIONS ---
        const fetchAndRenderTransactions = async () => {
            dom.transactionSpinner.style.display = 'flex';
            try {
                const usersQuery = await getDocs(collection(db, "users"));
                allUsers = usersQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const accountsQuery = await getDocs(collection(db, "accountsForSale"));
                allAccountsForSale = accountsQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderTransactionCards();
                updateStats();
            } catch (error) {
                console.error("Error fetching data for transactions:", error);
                showToast('Error fetching transaction data.', 'error');
            } finally {
                dom.transactionSpinner.style.display = 'none';
            }
        };

        const renderTransactionCards = () => {
            dom.pendingTransactionContainer.innerHTML = '';
            const pendingUsers = allUsers.filter(user => (user.pendingTransaction && user.pendingTransaction > 0) || user.pendingSubscription);
            const processingAccounts = allAccountsForSale.filter(acc => acc.status === 'processing');

            let contentRendered = false;

            if (pendingUsers.length > 0) {
                contentRendered = true;
                dom.pendingTransactionContainer.innerHTML += `<h2 class="section-heading">Pending Top-ups & Subscriptions</h2>`;
                pendingUsers.forEach(user => {
                    const accountType = user.accountType || 'USER';
                    let statusBadgeClass = 'status-user';
                    let statusOrSaldoHTML = `<span class="info-label">Current Saldo</span><span class="info-value">Rp ${(user.saldo || 0).toLocaleString('id-ID')}</span>`;
                    
                    if (accountType === 'PREMIUM') { statusBadgeClass = 'status-premium'; statusOrSaldoHTML = ''; }
                    if (accountType === 'Langganan') { statusBadgeClass = 'status-langganan'; statusOrSaldoHTML = ''; }
                    
                    let transactionDetailsHTML = '';
                    let actionButtonsHTML = '';
                    
                    if (user.pendingSubscription) {
                        const sub = user.pendingSubscription;
                        transactionDetailsHTML = `<h4>Pending Subscription</h4><p class="transaction-amount">${sub.type} - Rp ${(sub.uniqueAmount || sub.amount).toLocaleString('id-ID')}</p>`;
                        actionButtonsHTML = `<button class="action-button btn-success" data-action="accept-sub" data-doc-id="${user.id}"><i class="fas fa-check"></i> Accept</button><button class="action-button btn-danger" data-action="reject-sub" data-doc-id="${user.id}"><i class="fas fa-times"></i> Reject</button>`;
                    } else if (user.pendingTransaction > 0) {
                        transactionDetailsHTML = `<h4>Pending Top-up</h4><p class="transaction-amount">Rp ${user.pendingTransaction.toLocaleString('id-ID')}</p>`;
                        actionButtonsHTML = `<button class="action-button btn-success" data-action="accept-topup" data-doc-id="${user.id}"><i class="fas fa-check"></i> Accept</button><button class="action-button btn-danger" data-action="reject-topup" data-doc-id="${user.id}"><i class="fas fa-times"></i> Reject</button>`;
                    }

                    dom.pendingTransactionContainer.innerHTML += `
                        <div class="transaction-card">
                            <div class="card-header"><div class="user-title"><h3>${user.username}</h3><span class="status-badge ${statusBadgeClass}">${accountType}</span></div></div>
                            <div class="card-info-grid"><div class="info-item"><span class="info-label">Email</span><span class="info-value">${user.email || 'N/A'}</span></div><div class="info-item">${statusOrSaldoHTML}</div></div>
                            <div class="transaction-details-section">${transactionDetailsHTML}</div>
                            <div class="card-actions">${actionButtonsHTML}</div>
                        </div>`;
                });
            }

            if (processingAccounts.length > 0) {
                contentRendered = true;
                dom.pendingTransactionContainer.innerHTML += `<h2 class="section-heading">Pending Account Sales</h2>`;
                processingAccounts.forEach(acc => {
                    dom.pendingTransactionContainer.innerHTML += `
                        <div class="transaction-card">
                            <div class="card-header"><div class="user-title"><h3>Akun ${acc.gameType}</h3><span class="info-value" style="color: var(--success-primary);">Rp ${acc.price.toLocaleString('id-ID')}</span></div></div>
                            <div class="card-info-grid">
                                <div class="info-item"><span class="info-label">Pembeli</span><span class="info-value">${acc.soldTo || 'Unknown'}</span></div>
                                <div class="info-item"><span class="info-label">UB Akun</span><span class="info-value">${acc.ubAmount.toLocaleString('id-ID')}</span></div>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Update Status Penjualan</span>
                                <select class="status-select processing account-status-select" data-doc-id="${acc.id}">
                                    <option value="processing" selected>Processing</option>
                                    <option value="verified">Verified (Selesai)</option>
                                </select>
                            </div>
                        </div>`;
                });
            }

            if (!contentRendered) {
                dom.pendingTransactionContainer.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">No pending transactions.</p>';
            }

            addTransactionCardButtonListeners();
        };

        const updatePaginationControls = () => {
            const totalPages = Math.ceil(displayedUsers.length / rowsPerPage);
            const startRecord = displayedUsers.length > 0 ? (currentPage - 1) * rowsPerPage + 1 : 0;
            const endRecord = Math.min(currentPage * rowsPerPage, displayedUsers.length);
            document.getElementById('page-info').textContent = `Showing ${startRecord}-${endRecord} of ${displayedUsers.length}`;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages || totalPages === 0;
        };
        
        const updateStats = () => {
            if(!allUsers || !allAccountsForSale) return; // Guard clause
            const totalUsers = allUsers.length;
            const pendingTrxCount = allUsers.filter(u => (u.pendingTransaction && u.pendingTransaction > 0) || u.pendingSubscription).length;
            const processingAccountsCount = allAccountsForSale.filter(acc => acc.status === 'processing').length;
            
            document.getElementById('stat-total-users').textContent = totalUsers.toLocaleString('id-ID');
            document.getElementById('stat-pending-trx').textContent = pendingTrxCount + processingAccountsCount;
            const availableAccountsCount = allAccountsForSale.filter(acc => acc.status === 'available').length;
            document.getElementById('stat-accounts-for-sale').textContent = availableAccountsCount;
        };

        const updateTotalSpentStat = async () => {
            const statElement = document.getElementById('stat-total-spent');
            try {
                const querySnapshot = await getDocs(collection(db, "topup_history"));
                const totalSpent = querySnapshot.docs.reduce((sum, doc) => sum + (doc.data().amount || 0), 0);
                statElement.textContent = `Rp ${totalSpent.toLocaleString('id-ID')}`;
            } catch (error) {
                console.error("Error calculating total spent from topup_history:", error);
                statElement.textContent = 'Error';
                showToast('Could not calculate total spent.', 'error');
            }
        };

        const openEditUserModal = (docId) => {
            const user = allUsers.find(u => u.id === docId);
            if (user) {
                document.getElementById('edit-doc-id').value = docId;
                document.getElementById('edit-username').value = user.username || '';
                document.getElementById('edit-accountType').value = user.accountType || 'USER';
                document.getElementById('edit-saldo').value = user.saldo || 0;
                document.getElementById('edit-pendingTransaction').value = user.pendingTransaction || 0;
                document.getElementById('edit-whatsapp').value = user.whatsapp || '';
                document.getElementById('edit-password').value = user.password || '';

                const subscriptionFields = document.getElementById('subscription-fields');
                const saldoField = document.getElementById('edit-saldo').closest('.input-group');
                if (user.accountType === 'Langganan') {
                    subscriptionFields.style.display = 'block';
                    saldoField.style.display = 'none'; 
                    document.getElementById('edit-masaAktifHingga').value = user.masaAktifHingga || '';
                } else {
                    subscriptionFields.style.display = 'none';
                    saldoField.style.display = 'block';
                }
                
                dom.editUserModal.style.display = 'flex';
            }
        };
        
        const handleSaveChanges = async (event) => {
            event.preventDefault();
            const docId = document.getElementById('edit-doc-id').value;
            if (!docId) return;
            const updatedData = {
                username: document.getElementById('edit-username').value,
                accountType: document.getElementById('edit-accountType').value,
                saldo: Number(document.getElementById('edit-saldo').value),
                pendingTransaction: Number(document.getElementById('edit-pendingTransaction').value),
                whatsapp: document.getElementById('edit-whatsapp').value,
                password: document.getElementById('edit-password').value,
            };

            if (updatedData.accountType === 'Langganan') {
                updatedData.masaAktifHingga = document.getElementById('edit-masaAktifHingga').value;
                updatedData.saldo = 0; 
            } else {
                updatedData.masaAktifHingga = deleteField();
            }

            try {
                await updateDoc(doc(db, "users", docId), updatedData);
                showToast('User updated successfully!', 'success');
                dom.editUserModal.style.display = 'none';
                await fetchUsers();
            } catch (error) { showToast('Failed to update user.', 'error'); }
        };

        const handleSaveNewUser = async (event) => {
            event.preventDefault();
            const newData = { 
                username: document.getElementById('add-username').value, 
                saldo: Number(document.getElementById('add-saldo').value), 
                pendingTransaction: Number(document.getElementById('add-pendingTransaction').value), 
                whatsapp: document.getElementById('add-whatsapp').value, 
                device_id: '',
                password: document.getElementById('add-password').value, 
                accountType: 'USER',
                createdAt: serverTimestamp() 
            };
            try {
                await addDoc(collection(db, "users"), newData);
                showToast('User added successfully!', 'success');
                dom.addUserModal.style.display = 'none';
                document.getElementById('add-user-form').reset();
                await fetchUsers();
            } catch (error) { showToast('Failed to add user.', 'error'); }
        };
        
        const handleAcceptTransaction = (docId) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingTransaction || user.pendingTransaction <= 0) return;
            
            const confirmAction = async () => {
                const updatedUserData = {
                    saldo: (user.saldo || 0) + user.pendingTransaction,
                    pendingTransaction: 0
                };
                const topupHistoryData = {
                    userId: docId,
                    username: user.username,
                    amount: user.pendingTransaction,
                    status: "Success",
                    timestamp: serverTimestamp()
                };
                try {
                    await updateDoc(doc(db, "users", docId), updatedUserData);
                    await addDoc(collection(db, "topup_history"), topupHistoryData);
                    showToast('Transaction accepted!', 'success');
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Failed to accept transaction.', 'error');
                }
            };
            
            showConfirmation(
                `Tambahkan Rp ${user.pendingTransaction.toLocaleString('id-ID')} ke saldo ${user.username}?`,
                'Terima Top-up',
                'btn-success',
                confirmAction
            );
        };
        
        const handleRejectTransaction = (docId) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingTransaction || user.pendingTransaction <= 0) return;
            
            const confirmAction = async () => {
                try {
                    await updateDoc(doc(db, "users", docId), { pendingTransaction: 0 });
                    showToast('Pending top-up rejected.', 'success');
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Failed to reject transaction.', 'error');
                }
            };
            
            showConfirmation(
                `Tolak permintaan top-up untuk ${user.username}?`,
                'Tolak Top-up',
                'btn-danger',
                confirmAction
            );
        };

        const handleAcceptSubscription = (docId) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingSubscription) return;
            
            const confirmAction = async () => {
                const subData = user.pendingSubscription;
                const updatedUserData = {
                    accountType: subData.type,
                    pendingSubscription: deleteField()
                };

                if (subData.type === 'Langganan') {
                    const currentEndDate = user.masaAktifHingga ? new Date(user.masaAktifHingga) : new Date();
                    const startDate = currentEndDate > new Date() ? currentEndDate : new Date();
                    startDate.setDate(startDate.getDate() + 30);
                    updatedUserData.masaAktifHingga = startDate.toISOString().split('T')[0];
                } else {
                    updatedUserData.masaAktifHingga = deleteField();
                }

                const historyData = {
                    userId: docId, username: user.username, type: 'Subscription',
                    package: subData.type, amount: subData.uniqueAmount || subData.amount,
                    status: "Success", timestamp: serverTimestamp()
                };

                try {
                    await updateDoc(doc(db, "users", docId), updatedUserData);
                    await addDoc(collection(db, "purchase_history"), historyData);
                    showToast('Subscription activated!', 'success');
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Failed to activate subscription.', 'error');
                }
            };

            showConfirmation(
                `Aktifkan ${user.pendingSubscription.type} untuk ${user.username}?`,
                'Terima Langganan',
                'btn-success',
                confirmAction
            );
        };

        const handleRejectSubscription = (docId) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingSubscription) return;

            const confirmAction = async () => {
                try {
                    await updateDoc(doc(db, "users", docId), { pendingSubscription: deleteField() });
                    showToast('Subscription request rejected.', 'success');
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Failed to reject subscription.', 'error');
                }
            };

            showConfirmation(
                `Tolak permintaan ${user.pendingSubscription.type} untuk ${user.username}?`,
                'Tolak Langganan',
                'btn-danger',
                confirmAction
            );
        };

        const handleDeleteUser = (docId, username) => {
            const confirmAction = async () => {
                try {
                    await deleteDoc(doc(db, "users", docId));
                    showToast('User deleted successfully.', 'success');
                    await fetchUsers();
                } catch (error) { showToast('Failed to delete user.', 'error'); } 
            };
            showConfirmation(`Yakin ingin menghapus user: ${username}?`, 'Hapus User', 'btn-danger', confirmAction);
        };
        
        const togglePasswordVisibility = (e) => {
            const input = e.currentTarget.closest('.password-wrapper').querySelector('input');
            const icon = e.currentTarget.querySelector('i');
            if (input.type === 'password') { input.type = 'text'; icon.classList.replace('fa-eye', 'fa-eye-slash'); } 
            else { input.type = 'password'; icon.classList.replace('fa-eye-slash', 'fa-eye'); }
        };
        
        // --- ACCOUNT FOR SALE MANAGEMENT FUNCTIONS ---
        const fetchAccountsForSale = async () => {
            dom.accountSpinner.style.display = 'flex';
            try {
                const q = query(collection(db, "accountsForSale"));
                const querySnapshot = await getDocs(q);
                allAccountsForSale = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAccountsForSaleCards();
                updateStats(); 
            } catch (error) {
                console.error("Error fetching account posts:", error);
                showToast('Error fetching account posts.', 'error');
                dom.accountCardContainer.innerHTML = `<p style="text-align:center; color: var(--danger-primary);">Error fetching data.</p>`;
            } finally {
                dom.accountSpinner.style.display = 'none';
            }
        };

        const renderAccountsForSaleCards = () => {
            dom.accountCardContainer.innerHTML = '';

            // Sort accounts: 'verified' (sold) go to the top, then by creation date
            allAccountsForSale.sort((a, b) => {
                if (a.status === 'verified' && b.status !== 'verified') return -1;
                if (a.status !== 'verified' && b.status === 'verified') return 1;
                const dateA = a.createdAt?.seconds || 0;
                const dateB = b.createdAt?.seconds || 0;
                return dateB - dateA;
            });

            if (allAccountsForSale.length === 0) {
                dom.accountCardContainer.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">Belum ada akun yang dijual.</p>';
                return;
            }

            allAccountsForSale.forEach(acc => {
                const status = acc.status || 'available';
                let soldStampHTML = '';
                if (status === 'verified') {
                    soldStampHTML = '<div class="sold-stamp">SOLD</div>';
                }
                
                const cardHTML = `
                <div class="account-card">
                    ${soldStampHTML}
                    <div class="card-header">
                        <div class="user-title">
                            <h3>${acc.gameType}</h3>
                            <span class="info-value" style="color: var(--success-primary);">${acc.price ? 'Rp ' + acc.price.toLocaleString('id-ID') : ''}</span>
                        </div>
                    </div>
                    <div class="card-info-grid">
                        <div class="info-item">
                            <span class="info-label">Jumlah UB</span>
                            <span class="info-value">${(acc.ubAmount || 0).toLocaleString('id-ID')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Pembeli</span>
                            <span class="info-value">${acc.soldTo || 'N/A'}</span>
                        </div>
                        <div class="info-item" style="grid-column: 1 / -1;">
                             <span class="info-label">Status</span>
                             <span class="status-badge status-${status}">${status}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-button btn-primary edit-account-btn" data-doc-id="${acc.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="action-button btn-danger delete-account-btn" data-doc-id="${acc.id}" data-game-type="${acc.gameType}"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>`;
                dom.accountCardContainer.innerHTML += cardHTML;
            });
            addAccountCardButtonListeners();
        };

        const handleAccountSaleStatusChange = async (e) => {
            const select = e.target;
            const docId = select.dataset.docId;
            const newStatus = select.value;
            
            try {
                await updateDoc(doc(db, "accountsForSale", docId), { status: newStatus });
                showToast(`Status penjualan akun diupdate ke ${newStatus}.`, 'success');
                await fetchAndRenderTransactions();
            } catch (error) {
                showToast('Gagal mengupdate status.', 'error');
                console.error("Error updating account sale status:", error);
            }
        };

        const openEditAccountModal = (akunId) => {
            const akun = allAccountsForSale.find(a => a.id === akunId);
            if (akun) {
                document.getElementById('edit-account-id').value = akunId;
                document.getElementById('edit-account-gameType').value = akun.gameType || 'BUSSID';
                document.getElementById('edit-account-price').value = akun.price || 0;
                document.getElementById('edit-account-ubAmount').value = akun.ubAmount || 0;
                document.getElementById('edit-account-linkedTo').value = akun.linkedTo || 'Google';
                document.getElementById('edit-account-leaderboard').value = akun.leaderboard?.allTime || '';
                document.getElementById('edit-account-additionalInfo').value = akun.additionalInfo || '';
                document.getElementById('edit-account-email').value = akun.accountEmail || '';
                document.getElementById('edit-account-password').value = akun.accountPassword || '';
                dom.editAccountModal.style.display = 'flex';
            }
        };
        
        const handleUpdateAccount = async (event) => {
            event.preventDefault();
            const akunId = document.getElementById('edit-account-id').value;
            if (!akunId) return;

            const updatedData = {
                gameType: document.getElementById('edit-account-gameType').value,
                price: Number(document.getElementById('edit-account-price').value),
                ubAmount: Number(document.getElementById('edit-account-ubAmount').value),
                linkedTo: document.getElementById('edit-account-linkedTo').value,
                leaderboard: { allTime: Number(document.getElementById('edit-account-leaderboard').value) || null },
                additionalInfo: document.getElementById('edit-account-additionalInfo').value,
                accountEmail: document.getElementById('edit-account-email').value,
                accountPassword: document.getElementById('edit-account-password').value
            };

            try {
                await updateDoc(doc(db, "accountsForSale", akunId), updatedData);
                showToast('Postingan akun berhasil diperbarui!', 'success');
                dom.editAccountModal.style.display = 'none';
                await fetchAccountsForSale();
            } catch (error) {
                showToast('Gagal memperbarui postingan.', 'error');
                console.error(error);
            }
        };

        const handleSaveNewAccount = async (event) => {
            event.preventDefault();
            const newData = {
                gameType: document.getElementById('add-account-gameType').value,
                price: Number(document.getElementById('add-account-price').value),
                ubAmount: Number(document.getElementById('add-account-ubAmount').value),
                linkedTo: document.getElementById('add-account-linkedTo').value,
                leaderboard: { allTime: Number(document.getElementById('add-account-leaderboard').value) || null },
                additionalInfo: document.getElementById('add-account-additionalInfo').value,
                accountEmail: document.getElementById('add-account-email').value,
                accountPassword: document.getElementById('add-account-password').value,
                status: 'available',
                soldTo: null,
                createdAt: serverTimestamp(),
            };
            
            try {
                await addDoc(collection(db, "accountsForSale"), newData);
                showToast('Postingan akun berhasil ditambahkan!', 'success');
                dom.addAccountModal.style.display = 'none';
                document.getElementById('add-account-form').reset();
                await fetchAccountsForSale();
            } catch (error) {
                showToast('Gagal menambah postingan.', 'error');
                console.error(error);
            }
        };

        const handleDeleteAccount = (akunId, gameType) => {
            const confirmAction = async () => {
                try {
                    await deleteDoc(doc(db, "accountsForSale", akunId));
                    showToast('Postingan akun berhasil dihapus.', 'success');
                    await fetchAccountsForSale();
                } catch (error) {
                    showToast('Gagal menghapus postingan.', 'error');
                }
            };
            showConfirmation(`Yakin ingin menghapus postingan akun ${gameType} ini?`, 'Hapus Postingan', 'btn-danger', confirmAction);
        };
        
        // --- STOK AKUN MANAGEMENT FUNCTIONS ---
        const fetchStokAkun = async () => {
            dom.stokAkunSpinner.style.display = 'flex';
            try {
                const q = query(collection(db, "stokAkun"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                allStokAkun = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStokAkunCards();
            } catch (error) {
                console.error("Error fetching stok akun:", error);
                showToast('Gagal mengambil data stok akun.', 'error');
            } finally {
                dom.stokAkunSpinner.style.display = 'none';
            }
        };
        
        const renderStokAkunCards = () => {
            dom.stokAkunCardContainer.innerHTML = '';
            if (allStokAkun.length === 0) {
                dom.stokAkunCardContainer.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">Belum ada akun di dalam stok.</p>';
                return;
            }
            allStokAkun.forEach(akun => {
                let claimedByHTML = '';
                let cardClass = '';

                if (akun.ownedBy) {
                    cardClass = 'claimed';
                    claimedByHTML = `
                        <div class="info-item" style="grid-column: 1 / -1;">
                             <span class="info-label">Telah Terpakai Oleh</span>
                             <span class="info-value owner">${akun.ownedBy}</span>
                        </div>
                    `;
                }

                const cardHTML = `
                <div class="stok-akun-card ${cardClass}">
                    <div class="card-header">
                        <div class="user-title">
                            <h3>${akun.gameType} - ${akun.gameName || 'No Name'}</h3>
                        </div>
                    </div>
                    <div class="card-info-grid">
                        <div class="info-item">
                            <span class="info-label">Jenis Login</span>
                            <span class="info-value">${akun.loginType || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email / No.HP</span>
                            <span class="info-value">${akun.email || 'N/A'}</span>
                        </div>
                        ${claimedByHTML}
                        <div class="info-item" style="grid-column: 1 / -1;">
                             <span class="info-label">Kode Voucher</span>
                             <span class="info-value voucher-code">${akun.voucherCode || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="action-button btn-primary edit-stok-akun-btn" data-doc-id="${akun.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="action-button btn-danger delete-stok-akun-btn" data-doc-id="${akun.id}" data-game-type="${akun.gameType}"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>`;
                dom.stokAkunCardContainer.innerHTML += cardHTML;
            });
            addStokAkunCardButtonListeners();
        };

        const openEditStokAkunModal = (akunId) => {
            const akun = allStokAkun.find(a => a.id === akunId);
            if (akun) {
                document.getElementById('edit-stok-akun-id').value = akunId;
                document.getElementById('edit-stok-akun-gameType').value = akun.gameType;
                document.getElementById('edit-stok-akun-loginType').value = akun.loginType;
                document.getElementById('edit-stok-akun-gameName').value = akun.gameName;
                document.getElementById('edit-stok-akun-email').value = akun.email;
                document.getElementById('edit-stok-akun-password').value = akun.password;
                document.getElementById('edit-stok-akun-deviceId').value = akun.deviceId;
                document.getElementById('edit-stok-akun-voucherCode').value = akun.voucherCode;
                dom.editStokAkunModal.style.display = 'flex';
            }
        };

        const handleUpdateStokAkun = async (event) => {
            event.preventDefault();
            const akunId = document.getElementById('edit-stok-akun-id').value;
            if (!akunId) return;

            const updatedData = {
                gameType: document.getElementById('edit-stok-akun-gameType').value,
                loginType: document.getElementById('edit-stok-akun-loginType').value,
                gameName: document.getElementById('edit-stok-akun-gameName').value,
                email: document.getElementById('edit-stok-akun-email').value,
                password: document.getElementById('edit-stok-akun-password').value,
                deviceId: document.getElementById('edit-stok-akun-deviceId').value,
                voucherCode: document.getElementById('edit-stok-akun-voucherCode').value,
            };

            try {
                await updateDoc(doc(db, "stokAkun", akunId), updatedData);
                showToast('Stok akun berhasil diperbarui!', 'success');
                dom.editStokAkunModal.style.display = 'none';
                await fetchStokAkun();
            } catch (error) {
                showToast('Gagal memperbarui stok akun.', 'error');
            }
        };
        
        const handleSaveNewStokAkun = async (event) => {
            event.preventDefault();
            const newData = {
                gameType: document.getElementById('add-stok-akun-gameType').value,
                loginType: document.getElementById('add-stok-akun-loginType').value,
                gameName: document.getElementById('add-stok-akun-gameName').value,
                email: document.getElementById('add-stok-akun-email').value,
                password: document.getElementById('add-stok-akun-password').value,
                deviceId: document.getElementById('add-stok-akun-deviceId').value,
                voucherCode: document.getElementById('add-stok-akun-voucherCode').value,
                createdAt: serverTimestamp(),
            };
            
            try {
                await addDoc(collection(db, "stokAkun"), newData);
                showToast('Akun berhasil ditambahkan ke stok!', 'success');
                dom.addStokAkunModal.style.display = 'none';
                document.getElementById('add-stok-akun-form').reset();
                await fetchStokAkun();
            } catch (error) {
                showToast('Gagal menambah ke stok.', 'error');
            }
        };
        
        const handleDeleteStokAkun = (akunId, gameType) => {
            const confirmAction = async () => {
                try {
                    await deleteDoc(doc(db, "stokAkun", akunId));
                    showToast('Stok akun berhasil dihapus.', 'success');
                    await fetchStokAkun();
                } catch (error) {
                    showToast('Gagal menghapus stok akun.', 'error');
                }
            };
            showConfirmation(`Yakin ingin menghapus stok akun ${gameType} ini?`, 'Hapus Stok Akun', 'btn-danger', confirmAction);
        };


        // --- UNIVERSAL FUNCTIONS ---
        const showConfirmation = (message, title, btnClass, callback) => {
            const confirmBtn = document.getElementById('confirm-ok-btn');
            document.getElementById('confirm-title').innerHTML = title;
            document.getElementById('confirm-message').textContent = message;
            confirmBtn.className = `action-button ${btnClass}`;
            dom.confirmModal.style.display = 'flex';
            
            const handleConfirm = () => {
                callback();
                dom.confirmModal.style.display = 'none';
                confirmBtn.replaceWith(confirmBtn.cloneNode(true)); 
            };
            
            document.getElementById('confirm-ok-btn').addEventListener('click', handleConfirm, { once: true });
        };

        // --- AUTH & EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button');
                button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value)
                    .catch((error) => showToast(`Login failed: ${error.code}`, 'error'))
                    .finally(() => { button.disabled = false; button.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login'; });
            });
            
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            dom.nav.users.addEventListener('click', (e) => { e.preventDefault(); showView('users'); });
            dom.nav.transactions.addEventListener('click', (e) => { e.preventDefault(); showView('transactions'); });
            dom.nav.accounts.addEventListener('click', (e) => { e.preventDefault(); showView('accounts'); });
            dom.nav.stokAkun.addEventListener('click', (e) => { e.preventDefault(); showView('stokAkun'); });

            document.getElementById('refresh-users-btn').addEventListener('click', fetchUsers);
            document.getElementById('refresh-transactions-btn').addEventListener('click', fetchAndRenderTransactions);
            document.getElementById('refresh-accounts-btn').addEventListener('click', fetchAccountsForSale);
            document.getElementById('refresh-stok-akun-btn').addEventListener('click', fetchStokAkun);
            
            document.getElementById('add-user-btn').addEventListener('click', () => dom.addUserModal.style.display = 'flex');
            dom.searchInput.addEventListener('input', () => { currentPage = 1; filterAndDisplayUsers(); });
            document.getElementById('prev-page-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderUserCards(); } });
            document.getElementById('next-page-btn').addEventListener('click', () => { const totalPages = Math.ceil(displayedUsers.length / rowsPerPage); if (currentPage < totalPages) { currentPage++; renderUserCards(); } });
            document.getElementById('edit-user-form').addEventListener('submit', handleSaveChanges);
            document.getElementById('add-user-form').addEventListener('submit', handleSaveNewUser);
            
            document.getElementById('add-account-btn').addEventListener('click', () => dom.addAccountModal.style.display = 'flex');
            document.getElementById('add-account-form').addEventListener('submit', handleSaveNewAccount);
            document.getElementById('edit-account-form').addEventListener('submit', handleUpdateAccount);

            document.getElementById('add-stok-akun-btn').addEventListener('click', () => dom.addStokAkunModal.style.display = 'flex');
            document.getElementById('add-stok-akun-form').addEventListener('submit', handleSaveNewStokAkun);
            document.getElementById('edit-stok-akun-form').addEventListener('submit', handleUpdateStokAkun);
            
            document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal').style.display = 'none'));
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                dom.confirmModal.style.display = 'none';
                const confirmBtn = document.getElementById('confirm-ok-btn');
                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            });
            document.querySelectorAll('.password-toggle').forEach(btn => btn.addEventListener('click', togglePasswordVisibility));

            document.getElementById('edit-accountType').addEventListener('change', (e) => {
                const subscriptionFields = document.getElementById('subscription-fields');
                const saldoField = document.getElementById('edit-saldo').closest('.input-group');
                if (e.target.value === 'Langganan') {
                    subscriptionFields.style.display = 'block';
                    saldoField.style.display = 'none';
                } else {
                    subscriptionFields.style.display = 'none';
                    saldoField.style.display = 'block';
                }
            });

            document.querySelectorAll('.date-mod-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const days = parseInt(e.currentTarget.dataset.days);
                    const dateInput = document.getElementById('edit-masaAktifHingga');
                    const currentDate = dateInput.value ? new Date(dateInput.value) : new Date();
                    
                    const currentUTCDate = new Date(Date.UTC(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()));
                    currentUTCDate.setUTCDate(currentUTCDate.getUTCDate() + days);

                    const year = currentUTCDate.getUTCFullYear();
                    const month = String(currentUTCDate.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(currentUTCDate.getUTCDate()).padStart(2, '0');
                    
                    dateInput.value = `${year}-${month}-${day}`;
                });
            });
        }
        
        function addCardButtonListeners() {
            dom.userCardContainer.querySelectorAll('.edit-user-btn').forEach(button => button.addEventListener('click', (e) => openEditUserModal(e.currentTarget.dataset.docId)));
            dom.userCardContainer.querySelectorAll('.delete-user-btn').forEach(button => button.addEventListener('click', (e) => handleDeleteUser(e.currentTarget.dataset.docId, e.currentTarget.dataset.username)));
            dom.userCardContainer.querySelectorAll('.copy-btn').forEach(button => button.addEventListener('click', (e) => {
                navigator.clipboard.writeText(e.currentTarget.dataset.text).then(() => showToast('Device ID copied!', 'success')).catch(() => showToast('Failed to copy.', 'error'));
            }));
        }

        function addTransactionCardButtonListeners() {
             dom.pendingTransactionContainer.querySelectorAll('.action-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const target = e.currentTarget;
                    const action = target.dataset.action;
                    const docId = target.dataset.docId;

                    switch(action) {
                        case 'accept-topup': handleAcceptTransaction(docId); break;
                        case 'reject-topup': handleRejectTransaction(docId); break;
                        case 'accept-sub': handleAcceptSubscription(docId); break;
                        case 'reject-sub': handleRejectSubscription(docId); break;
                    }
                });
            });
            dom.pendingTransactionContainer.querySelectorAll('.account-status-select').forEach(select => {
                select.addEventListener('change', handleAccountSaleStatusChange);
            });
        }
        
        function addAccountCardButtonListeners() {
            dom.accountCardContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-account-btn');
                const deleteBtn = e.target.closest('.delete-account-btn');
                if (editBtn) openEditAccountModal(editBtn.dataset.docId);
                if (deleteBtn) handleDeleteAccount(deleteBtn.dataset.docId, deleteBtn.dataset.gameType);
            });
        }

        function addStokAkunCardButtonListeners() {
            dom.stokAkunCardContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-stok-akun-btn');
                const deleteBtn = e.target.closest('.delete-stok-akun-btn');
                if (editBtn) openEditStokAkunModal(editBtn.dataset.docId);
                if (deleteBtn) handleDeleteStokAkun(deleteBtn.dataset.docId, deleteBtn.dataset.gameType);
            });
        }
        
        const initializeAdminPanel = () => {
            showView('users');
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                dom.loginPage.style.display = 'none';
                dom.adminPanel.style.display = 'flex';
                initializeAdminPanel();
            } else {
                dom.loginPage.style.display = 'none';
                dom.adminPanel.style.display = 'flex';
            }
        });

        setupEventListeners();
    </script>
</body>
</html>