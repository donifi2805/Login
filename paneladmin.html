<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - MALEO TOOLS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-glass: rgba(26, 26, 46, 0.8);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0b0;
            --accent-primary: #3b82f6;
            --accent-secondary: #2563eb;
            --danger-primary: #ef4444;
            --danger-secondary: #dc2626;
            --success-primary: #22c55e;
            --warning-primary: #f59e0b;
            --premium-gold: #FBBF24;
            --subscription-cyan: #06b6d4;
            --online-green: #2ecc71;
        }

        html { height: 100%; }
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            background: var(--bg-primary);
            min-height: 100vh;
        }

        /* --- LAYOUT UTAMA --- */
        #login-page {
            width: 100%;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .dashboard-layout {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        /* --- TOP HEADER & NAVIGATION --- */
        .top-header {
            background: var(--bg-secondary);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-title {
            font-size: 1.5em;
            color: white;
            margin: 0;
            font-weight: 600;
        }
        .header-title i { color: var(--accent-primary); }
        .header-actions { display: flex; gap: 10px; }


        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 10px;}
        .view-header h1 { margin: 0; text-shadow: 0 0 12px rgba(59, 130, 246, 0.5); }
        .view-header .actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* --- REVISED MENU GRID (ELEGANT LAYOUT) --- */
        .menu-grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: minmax(140px, auto);
            gap: 20px;
        }

        .menu-grid-button {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-size: 1.1em;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            position: relative;
        }

        .menu-grid-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-color: var(--accent-primary);
        }

        .menu-grid-button i {
            font-size: 2.5em;
            color: var(--accent-primary);
        }
        
        /* Specific sizes for irregular layout */
        .menu-stok-penawaran {
            grid-column: span 2;
        }
        .menu-settings {
            grid-column: span 3;
        }

        /* Style untuk Notifikasi Badge */
        .notification-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--danger-primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: 700;
            border: 2px solid var(--bg-secondary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Kontainer untuk toggle maintenance di menu utama */
        .quick-settings-container {
            margin-top: 30px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        /* --- KARTU STATISTIK --- */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            padding: 25px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.2s ease;
        }
        .stat-card.clickable:hover {
            cursor: pointer;
            transform: translateY(-3px);
            border-color: var(--accent-primary);
        }

        .stat-card .icon {
            font-size: 2em;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .stat-card:nth-child(1) .icon { background: rgba(59, 130, 246, 0.2); color: var(--accent-primary); }
        .stat-card:nth-child(2) .icon { background: rgba(34, 204, 113, 0.2); color: var(--online-green); }
        .stat-card:nth-child(3) .icon { background: rgba(245, 158, 11, 0.2); color: var(--warning-primary); }
        .stat-card:nth-child(4) .icon { background: rgba(34, 197, 94, 0.2); color: var(--success-primary); }
        
        .stat-card .info h3 { margin: 0 0 5px 0; font-size: 1.8em; color: white; }
        .stat-card .info p { margin: 0; color: var(--text-secondary); }

        /* --- KONTROL --- */
        .controls-container {
             background: var(--bg-glass);
             border: 1px solid var(--border-color);
             border-radius: 12px;
             padding: 20px;
             margin-bottom: 20px;
        }
        .controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .search-bar { position: relative; flex-grow: 1; }
        .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .search-bar .input-field { padding-left: 40px; width: 100%; max-width: 400px; box-sizing: border-box;}

        /* --- KARTU PENGGUNA, TRANSAKSI, & AKUN JUAL --- */
        #user-card-container, #pending-transaction-container, #stok-akun-card-container, #stok-kredensial-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            position: relative;
        }
        
        .section-heading {
            grid-column: 1 / -1;
            color: var(--accent-primary);
            margin-bottom: -5px;
            margin-top: 10px;
            font-size: 1.2em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .user-profile-card, .transaction-card, .stok-akun-card, .stok-kredensial-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .user-profile-card:hover, .transaction-card:hover, .stok-akun-card:hover, .stok-kredensial-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .transaction-card {
            border-left: 4px solid var(--warning-primary);
        }
        .stok-akun-card {
            border-left: 4px solid var(--subscription-cyan);
        }
         .stok-kredensial-card {
            border-left: 4px solid #a855f7;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }
        
        .stok-header-available {
            background: rgba(34, 197, 94, 0.15);
        }
        .stok-header-sold {
            background: rgba(239, 68, 68, 0.15);
        }

        .card-header .user-title {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .card-header .user-title h3 {
            margin: 0;
            font-size: 1.2rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }
         .card-header .user-title h3 .pending-indicator {
            color: var(--warning-primary);
            font-size: 0.9em;
            animation: pulse 1.5s infinite;
         }
         @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
         }
        
        .card-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .info-label {
            font-size: 0.8em;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .info-value {
            font-size: 0.95em;
            font-weight: 600;
            word-break: break-all;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .info-value .copy-btn {
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            font-size: 1.1em; margin-left: 5px; vertical-align: middle;
        }
        .info-value .copy-btn:hover { color: var(--accent-primary); }
        
        .transaction-details-section {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning-primary);
            padding: 12px;
            border-radius: 8px;
        }
        .transaction-details-section h4 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            text-transform: uppercase;
            color: var(--warning-primary);
        }
        .transaction-amount {
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            text-align: center;
        }
        
        .card-actions {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            flex-wrap: wrap; /* Allow wrapping */
        }
        .card-actions .action-button {
            flex-grow: 1;
        }
        
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; color: var(--text-secondary); flex-wrap: wrap; gap: 15px;}
        .pagination button { width: auto; }
        
        /* --- Gaya untuk Status User & Akun --- */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; display: inline-block; }
        .status-user { background-color: rgba(100, 116, 139, 0.2); color: #94a3b8; }
        .status-premium { background-color: rgba(251, 191, 36, 0.2); color: var(--premium-gold); }
        .status-langganan { background-color: rgba(6, 182, 212, 0.2); color: var(--subscription-cyan); }
        
        /* --- START: Admin Status Header Toggle --- */
        .admin-status-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 15px;
            border-left: 1px solid var(--border-color);
            margin-left: 5px;
        }
        .admin-status-label {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        /* Override untuk toggle di header */
        .admin-header-toggle label {
            background: var(--danger-primary); /* Merah saat Offline */
        }
        .admin-header-toggle input:checked + label {
            background: var(--online-green); /* Hijau terang saat Online */
        }
        /* --- END: Admin Status Header Toggle --- */

        /* --- KOMPONEN UMUM --- */
        .form-container {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            padding: 40px; border-radius: 15px; width: 100%; max-width: 400px;
            box-sizing: border-box; text-align: center;
        }
        .form-container h2 { margin-top: 0; color: white; }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .input-field, textarea.input-field, select.input-field {
            width: 100%; padding: 15px; box-sizing: border-box; background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color); border-radius: 8px; color: white; font-size: 1em;
            transition: border-color 0.3s; font-family: 'Poppins', sans-serif;
        }
        select.input-field {
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%23a0a0b0' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E%0A");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 1.2em;
        }
        .input-field:focus, textarea.input-field:focus, select.input-field:focus { outline: none; border-color: var(--accent-primary); }
        .password-wrapper { position: relative; }
        .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; }

        .action-button {
            padding: 12px 20px; border-radius: 8px; color: white; font-size: 1em; font-weight: 600; cursor: pointer;
            border: none; transition: opacity 0.3s; display: inline-flex; align-items: center; gap: 8px; justify-content: center;
        }
        .action-button:hover { opacity: 0.9; }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: linear-gradient(45deg, var(--accent-secondary), var(--accent-primary)); }
        .btn-danger { background: linear-gradient(45deg, var(--danger-secondary), var(--danger-primary)); }
        .btn-secondary { background: #64748b; }
        .btn-success { background: var(--success-primary); }
        .btn-warning { background: var(--warning-primary); }


        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7); 
            align-items: center; justify-content: center; padding: 15px; box-sizing: border-box;
        }
        .modal-content {
            background-color: var(--bg-secondary); margin: auto; padding: 30px;
            border: 1px solid var(--border-color); width: 100%; max-width: 550px; border-radius: 15px;
            animation: modal-fade-in 0.3s ease;
        }
        @keyframes modal-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content h2 { margin-top: 0; color: white; }
        .modal-actions { margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* --- TOAST / NOTIFIKASI --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background-color: var(--bg-secondary); color: white; padding: 15px 20px;
            border-radius: 8px; margin-bottom: 10px; border-left: 4px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px;
            opacity: 0; transform: translateX(100%); animation: toast-in 0.5s forwards;
        }
        .toast.success { border-color: var(--success-primary); }
        .toast.error { border-color: var(--danger-primary); }
        @keyframes toast-in { to { opacity: 1; transform: translateX(0); } }

        /* --- LOADING SPINNER --- */
        .spinner-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 26, 46, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10; border-radius: 12px; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.2); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* --- Kustomisasi Form Edit User --- */
        #subscription-fields { display: none; }
        .date-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .date-buttons button { flex-grow: 1; padding: 10px; font-size: 0.9em; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        #admin-panel { display: none; }
        #login-page { display: flex; }

        /* --- REKAP VIEW STYLES --- */
        #rekap-table-container {
            width: 100%;
            overflow-x: auto;
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
        }
        #rekap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        #rekap-table th, #rekap-table td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        #rekap-table th {
            background-color: var(--bg-secondary);
            font-weight: 600;
            color: var(--accent-primary);
        }
        #rekap-table tbody tr:nth-child(even) {
            background-color: rgba(0,0,0,0.1);
        }
        #rekap-table .amount-spent {
            color: var(--danger-primary);
            font-weight: 600;
        }
         #rekap-table .amount-topup {
            color: var(--success-primary);
            font-weight: 600;
        }
        #rekap-table .current-balance {
            color: var(--premium-gold);
        }
        
        /* --- Filter Buttons --- */
        .filter-buttons {
            display: flex;
            gap: 5px;
            background-color: var(--bg-secondary);
            padding: 5px;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: 500;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .filter-btn.active {
            background-color: var(--accent-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        /* --- Tampilan Kompak & Responsif --- */
        @media (max-width: 1024px) {
            :root { font-size: 10px; }
            .main-content { padding: 8px; }
            .top-header { padding: 4px 10px; gap: 8px; }
            .header-title { font-size: 1.2em; }
            
            .header-actions { gap: 5px; }
            .header-actions .action-button { padding: 4px 8px; font-size: 1em; }
            .view-header { margin-bottom: 12px; gap: 10px; }
            .view-header h1 { font-size: 1.6em; }
            .view-header .actions .action-button { font-size: 1em; }
            .stat-cards { gap: 8px; margin-bottom: 12px; }
            .stat-card { padding: 8px; gap: 8px; border-radius: 6px; }
            .stat-card .icon { width: 32px; height: 32px; font-size: 1.4em; }
            .stat-card .info h3 { font-size: 1.5em; margin-bottom: 2px; }
            .stat-card .info p { font-size: 0.9em; }
            .controls-container { padding: 10px; margin-bottom: 12px; }
            .controls { gap: 10px; }
            #user-card-container, #pending-transaction-container, #stok-akun-card-container, #stok-kredensial-card-container { gap: 10px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
            .user-profile-card, .transaction-card, .stok-akun-card, .stok-kredensial-card { padding: 12px; border-radius: 8px; gap: 10px; }
            .card-header { padding-bottom: 8px; }
            .card-header .user-title h3 { font-size: 1.3em; }
            .card-info-grid { gap: 10px; }
            .info-label { font-size: 0.9em; }
            .info-value { font-size: 1em; }
            .transaction-details-section { padding: 8px; }
            .transaction-details-section h4 { font-size: 0.9em; margin-bottom: 6px; }
            .transaction-amount { font-size: 1.3em; }
            .card-actions { padding-top: 10px; gap: 8px; }
            .card-actions .action-button { font-size: 1em; }
            .pagination { margin-top: 15px; }
            .pagination, .pagination .action-button { font-size: 1em; }
            .input-group { margin-bottom: 12px; }
            .input-group label { margin-bottom: 4px; font-size: 1em; }
            .input-field, textarea.input-field, select.input-field { padding: 8px; font-size: 1.1em; border-radius: 5px; }
            .action-button { padding: 7px 14px; font-size: 1em; border-radius: 5px; gap: 5px; }
            .modal-content { padding: 20px; max-width: 480px; }
            .modal-content h2 { font-size: 1.3em; margin-bottom: 15px; }
            .modal-actions { margin-top: 20px; }
            .status-badge { padding: 3px 7px; font-size: 0.9em; }
        }
        
        .reset-owner-btn {
            padding: 2px 8px !important;
            font-size: 0.85em !important;
            flex-grow: 0 !important;
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-color);
        }
        .info-value.owner { color: var(--premium-gold); font-weight: 700; }

        /* --- STYLES FOR SETTINGS VIEW --- */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        .settings-card {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }
        .settings-card h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.4em;
            color: var(--accent-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        /* General Toggle Switch styles */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-switch span { font-weight: 500; }
        .toggle-switch input { display: none; }
        .toggle-switch label {
            width: 50px; height: 26px; background: #333;
            border-radius: 13px; position: relative; cursor: pointer;
            transition: background 0.3s;
        }
        .toggle-switch label::after {
            content: ''; position: absolute;
            width: 20px; height: 20px; background: white;
            border-radius: 50%; top: 3px; left: 4px;
            transition: transform 0.3s;
        }
        .toggle-switch input:checked + label { background: var(--success-primary); }
        .toggle-switch input:checked + label::after { transform: translateX(23px); }
        
        /* Ban Toggle Specific styles */
        .ban-toggle-switch input:checked + label { background: var(--danger-primary); }
        .card-ban-toggle { grid-column: 1 / -1; margin-top: 10px; }


        .settings-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        .tab-button {
            padding: 10px 15px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            font-size: 1em;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-button:hover {
            color: var(--text-primary);
        }
        .tab-button.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .time-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .time-input-group .input-group {
            flex: 1;
        }

        @media (max-width: 768px) {
            .main-content { padding: 5px; }
            .top-header { padding: 10px; justify-content: center; }
            .header-title { text-align: center; width: 100%; margin-bottom: 10px; }
            #user-card-container, #pending-transaction-container, #stok-akun-card-container, #stok-kredensial-card-container, .settings-grid { 
                grid-template-columns: 1fr; 
            }
            .controls { flex-direction: column; align-items: stretch; }
            .search-bar .input-field { max-width: 100%; }
            .modal-content { padding: 15px; }
            .form-grid { grid-template-columns: 1fr; }
            .menu-grid-container { 
                grid-template-columns: repeat(2, 1fr);
                grid-auto-rows: minmax(120px, auto);
                gap: 15px;
            }
            /* On mobile, reset all spans to be more uniform */
            .menu-users, .menu-transactions, .menu-rekap, .menu-stok-penawaran, .menu-stok-kredensial, .menu-settings {
                grid-column: span 1;
            }
            .menu-stok-penawaran, .menu-settings {
                grid-column: span 2;
            }
        }
        
        /* Floating Transaction Modal */
        #floating-transaction-modal .modal-content {
            max-width: 420px;
            border-left: 5px solid var(--warning-primary);
        }
        #floating-transaction-modal .modal-actions {
            justify-content: space-between;
        }
        #floating-transaction-modal .action-button {
            flex-grow: 1;
        }

        /* Online Users Modal */
        #online-users-list {
            list-style: none;
            padding: 0;
            max-height: 40vh;
            overflow-y: auto;
        }
        #online-users-list li {
            background-color: var(--bg-primary);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #online-users-list .online-indicator {
            width: 10px;
            height: 10px;
            background-color: var(--online-green);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--online-green);
        }
    /* --- Styles for Live Chat View --- */
#live-chat-view {
    display: none; /* Defaultnya tersembunyi */
    height: calc(100vh - 150px); /* Sesuaikan tinggi agar pas di layar */
}

.chat-layout {
    display: grid;
    grid-template-columns: 300px 1fr; /* Kolom kiri (daftar chat) dan kolom kanan (jendela chat) */
    height: 100%;
    gap: 20px;
    background: var(--bg-glass);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

#chat-session-list {
    display: flex;
    flex-direction: column;
    height: 100%;
    border-right: 1px solid var(--border-color);
    background: var(--bg-primary);
}

#chat-list-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
    font-size: 1.1em;
    color: var(--accent-primary);
}

#chat-session-list-items {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
}

.chat-session-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid var(--border-color);
}

.chat-session-item:hover {
    background-color: var(--bg-secondary);
}

.chat-session-item.active {
    background-color: var(--accent-primary);
    color: white;
}

.chat-session-item .session-username {
    font-weight: 600;
    font-size: 0.95em;
}

.chat-session-item .unread-indicator {
    width: 10px;
    height: 10px;
    background-color: var(--online-green); /* MOD: Ganti ke Hijau */
    border-radius: 50%;
    box-shadow: 0 0 8px var(--online-green); /* MOD: Ganti ke Hijau */
    display: none; /* Tampil jika ada pesan baru */
}

.chat-session-item.has-unread .unread-indicator {
    display: block;
}
.chat-session-item.has-unread .session-username {
    color: var(--online-green); /* MOD: Ganti ke Hijau */
}
.chat-session-item.active.has-unread .session-username {
    color: white; /* Tetap putih jika aktif */
}

#chat-window-admin {
    display: flex;
    flex-direction: column;
    height: 100%;
}

#chat-window-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
    font-size: 1.1em;
    color: white;
}

#chat-messages-admin {
    flex-grow: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    font-size: 0.9em;
}

.chat-message-admin-container {
    display: flex;
    flex-direction: column;
    max-width: 80%;
}

.chat-message-admin-container.admin-message {
    align-self: flex-end;
    align-items: flex-end;
}

.chat-message-admin-container.user-message {
    align-self: flex-start;
    align-items: flex-start;
}

.chat-message-bubble {
    padding: 10px 15px;
    border-radius: 18px;
    line-height: 1.5;
    word-wrap: break-word;
}

.admin-message .chat-message-bubble {
    background: var(--accent-primary);
    color: white;
    border-bottom-right-radius: 4px;
}

.user-message .chat-message-bubble {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-bottom-left-radius: 4px;
}

.chat-message-bubble img.chat-message-image {
    max-width: 250px;
    height: auto;
    border-radius: 10px;
    cursor: pointer;
    margin-top: 5px;
}

.chat-message-sender {
    font-size: 0.8em;
    font-weight: 600;
    color: var(--accent-secondary);
    margin-bottom: 4px;
}
.admin-message .chat-message-sender {
    color: var(--subscription-cyan);
}

#chat-input-area-admin {
    display: flex;
    align-items: center;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    gap: 10px;
}

#chat-text-admin {
    flex-grow: 1;
    resize: none;
}

.card-actions .action-button.btn-start-chat {
    background: var(--subscription-cyan); /* Warna berbeda */
    flex-grow: 0; /* Jangan memanjang */
    padding: 8px 12px; /* Lebih kecil */
    font-size: 0.9em;
}

/* Responsive Chat Layout */
@media (max-width: 1024px) {
/* Responsive Chat Layout */
@media (max-width: 1024px) {
    .chat-layout {
        grid-template-columns: 240px 1fr; /* Kecilkan sidebar */
        gap: 10px;
    }
}

@media (max-width: 768px) {
    #live-chat-view {
        height: calc(100vh - 120px); /* Sesuaikan tinggi untuk mobile */
    }
    .chat-layout {
        grid-template-columns: 1fr; /* Tumpuk */
        height: 100%;
    }
    #chat-session-list {
        height: auto; /* FIX: Biarkan tinggi otomatis menyesuaikan parent */
        border-right: none;
        border-bottom: none; /* FIX: Hapus border, sudah di-handle .chat-list-full-view */
    }
    #chat-window-admin {
        height: 100%; /* Jendela chat ambil sisa ruang */
    }
    #chat-session-list-items {
        display: flex;
        flex-direction: column; /* FIX: Tetap vertikal */
        overflow-x: hidden;
        overflow-y: auto;
        padding: 10px; /* FIX: Beri padding di container */
        gap: 10px; /* FIX: Beri jarak antar item */
    }
    .chat-session-item {
        flex-shrink: 1; 
        width: auto; 
        flex-direction: row; 
        gap: 15px;
        padding: 15px 20px;
        
        /* FIX: Tambahan override untuk style kartu */
        background: var(--bg-secondary);
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border-color);
    }
}/* --- CSS Utama Jendela Chat Mengambang --- */
.floating-chat-container {
    display: none; /* Sembunyi by default */
    position: fixed;
    bottom: 0;
    right: 30px; /* Posisi di kanan bawah */
    width: 370px;
    max-width: 90vw;
    height: 500px;
    max-height: 80vh;
    z-index: 1002; /* Di atas modal biasa */
    flex-direction: column;
    transition: all 0.3s ease;
    /* Style baru dari Mod 8 dipindahkan ke sini */
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-bottom: 0;
    border-radius: 12px 12px 0 0;
    box-shadow: 0 -5px 25px rgba(0,0,0,0.4);
}
.floating-chat-container.minimized {
    height: 50px; /* Hanya header */
    bottom: 0;
    transform: translateY(0);
}
.floating-chat-container.minimized .chat-messages-admin-panel,
.floating-chat-container.minimized .chat-input-area-admin-panel {
    display: none;
}/* --- New/Improved Styles for Chat List Full View (FIXED) --- */
.chat-list-full-view {
    border: none;
    border-radius: 12px;
    background: none;
    overflow: hidden;
    height: calc(100vh - 220px);
    display: flex;
    flex-direction: column;
    padding: 15px;
    gap: 10px;
}

#chat-list-header {
    font-size: 1.2em;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 15px;
    padding: 0 5px;
}

#chat-session-list-items {
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.chat-session-item {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    background: var(--bg-secondary);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    position: relative;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.chat-session-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    border-color: var(--accent-secondary);
}

.chat-session-item.active {
    border-color: var(--accent-primary);
    background: rgba(59, 130, 246, 0.1);
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
}

.chat-session-item.has-unread {
    border-left: 5px solid var(--online-green); /* MOD: Ganti ke Hijau */
    padding-left: 15px;
}
.chat-session-item.has-unread:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 5px;
    background-color: var(--online-green); /* MOD: Ganti ke Hijau */
}

.chat-session-item .session-username {
    font-size: 1.1em;
    font-weight: 600;
    color: var(--text-primary);
    display: block;
}

.chat-session-item.active .session-username {
    color: var(--accent-primary);
}

.chat-session-item .session-last-message {
    font-size: 0.9em;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 5px;
    max-width: 100%;
}

.chat-session-item.active .session-last-message {
    color: var(--text-secondary);
}

.new-chat-user-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s ease;
    color: var(--text-primary);
}
.new-chat-user-item:last-child { border-bottom: none; }
.new-chat-user-item:hover { background-color: var(--bg-secondary); }
.new-chat-user-item i { margin-right: 10px; color: var(--accent-primary); }

/* === START PERBAIKAN CSS JENDELA MENGAMBANG === */

#floating-chat-header {
    background: var(--accent-primary);
    color: white;
    font-weight: 600;
    border-radius: 12px 12px 0 0;
    cursor: pointer;
    padding: 12px 18px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    /* TAMBAHKAN INI UNTUK LAYOUT HEADER */
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.floating-chat-container.minimized #floating-chat-header {
    border-radius: 12px;
}

#floating-chat-username {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-window-controls { 
    /* TAMBAHKAN INI */
    display: flex; 
    gap: 5px; 
}
.chat-control-btn {
    /* TAMBAHKAN INI - PERBAIKAN TOMBOL PUTIH */
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1em;
    cursor: pointer;
    padding: 5px;
    line-height: 1;
    border-radius: 4px;
    transition: all 0.2s ease;
}
        .chat-control-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.2);
        }

        /* Lightbox Styles */
        .lightbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 10005; }
        .lightbox-content { position: relative; max-width: 90%; max-height: 90%; display: flex; justify-content: center; align-items: center; }
        .lightbox-content img { max-width: 100%; max-height: 80vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); object-fit: contain; }
        .lightbox-close { position: absolute; top: 20px; right: 30px; font-size: 3em; color: white; cursor: pointer; font-weight: bold; transition: color 0.3s; z-index: 10006; line-height: 1;}
        .lightbox-close:hover { color: var(--accent-primary); }
.lightbox-nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.4);color:white;border:none;padding:15px 20px;font-size:2em;cursor:pointer;border-radius:50%;z-index:10007;transition:all .3s ease;user-select:none;outline:none}.lightbox-nav-btn:hover{background:rgba(0,0,0,0.8);transform:translateY(-50%) scale(1.1)}.lightbox-prev{left:20px}.lightbox-next{right:20px}.lightbox-counter{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);color:white;background:rgba(0,0,0,0.6);padding:8px 16px;border-radius:20px;font-size:1em;font-weight:600;pointer-events:none;z-index:10007}

/* Styling untuk pesan admin/user di jendela mengambang */
.chat-messages-admin-panel {
    background: var(--bg-primary); 
    padding: 15px 20px;
    /* TAMBAHKAN INI - PERBAIKAN POSISI INPUT */
    flex-grow: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 15px;
    font-size: 0.9em;
}

/* TAMBAHKAN INI - PERBAIKAN POSISI LABEL NAMA */
.chat-messages-admin-panel .chat-message-admin-container { 
    display: flex; 
    flex-direction: column; 
    max-width: 80%; 
}
.chat-messages-admin-panel .admin-message { align-self: flex-end; align-items: flex-end; }
.chat-messages-admin-panel .user-message { align-self: flex-start; align-items: flex-start; }
.chat-messages-admin-panel .chat-message-sender { 
    font-size: 0.8em; 
    font-weight: 600; 
    color: var(--text-secondary); 
    margin-bottom: 4px; 
}
.chat-messages-admin-panel .admin-message .chat-message-sender { 
    color: var(--subscription-cyan); 
}
/* ========================================= */

.chat-messages-admin-panel .chat-message-bubble {
    border-radius: 20px;
    /* TAMBAHKAN INI */
    line-height: 1.5;
    word-wrap: break-word;
    padding: 10px 15px; /* Pastikan padding ada */
}

.chat-messages-admin-panel .admin-message .chat-message-bubble {
    background: var(--accent-primary);
    color: white;
    border-bottom-right-radius: 6px;
}

.chat-messages-admin-panel .user-message .chat-message-bubble {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-bottom-left-radius: 6px;
}

/* TAMBAHKAN INI */
.chat-messages-admin-panel .chat-message-bubble img.chat-message-image { 
    max-width: 250px; 
    border-radius: 10px; 
    cursor: pointer; 
    margin-top: 5px; 
}

/* Input area chat */
.chat-input-area-admin-panel {
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    padding: 15px 20px;
    /* TAMBAHKAN INI */
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-input-area-admin-panel textarea {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 20px; /* Buat lebih rounded */
    padding: 10px 15px;
    color: var(--text-primary);
    /* TAMBAHKAN INI */
    flex-grow: 1;
    resize: none;
}
.chat-input-area-admin-panel textarea:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}

.chat-input-area-admin-panel .action-button {
    /* PERBAIKI TOMBOL KIRIM */
    background: var(--accent-primary);
    color: white;
    border-radius: 50%; /* Buat jadi bulat */
    padding: 0;
    width: 44px;
    height: 44px;
    flex-shrink: 0; /* Jaga agar tidak gepeng */
    font-size: 1.1em;
}
.chat-input-area-admin-panel .action-button:hover:not(:disabled) {
    background: var(--accent-secondary);
}

/* Modifikasi tampilan modal secara umum jika belum ada */
.modal-content {
    background: var(--bg-secondary);
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    border: 1px solid var(--border-color);
}
.modal-content h2 {
    color: var(--text-primary);
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 20px;
    text-align: center;
}

.modal-content label {
    color: var(--text-secondary);
}

.modal-content .input-field {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 8px;
    padding: 10px 12px;
}
.modal-content .input-field:focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}

/* Warna background untuk pesan "Memuat user..." di modal */
#new-chat-user-list {
    background: var(--bg-primary); /* Pastikan ini sesuai */
    border: 1px solid var(--border-color);
    border-radius: 8px;
}/* --- Styles for Chat Message Deletion (MODIFIED) --- */
.chat-message-bubble {
    position: relative;
    /* Beri sedikit ruang tambahan di kanan untuk tombol hapus */
    padding-right: 30px !important; /* Paksa padding untuk semua */
}
/* Hapus rule spesifik untuk admin-message */
/* .admin-message .chat-message-bubble { ... } */

.chat-delete-btn {
    position: absolute;
    top: 2px;
    right: 5px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.9em;
    opacity: 0; /* Sembunyi by default */
    transition: opacity 0.2s;
}
/* Tampilkan tombol hapus di SEMUA pesan bubble (user dan admin) */
.chat-message-bubble:hover .chat-delete-btn {
    opacity: 0.7; /* Tampil saat hover di bubble */
}
.chat-delete-btn:hover {
    color: var(--danger-primary);
    opacity: 1;
}
/* Hapus rule yang menyembunyikan tombol di pesan admin */
/* .admin-message .chat-delete-btn { display: none; } */
/* --- Styles for Etalase View --- */
        /* Sembunyikan H1 dan Tombol Back, tapi TAMPILKAN tombol actions (Tambah, etc) */
        #etalase-view #stok-akun-management-view > .view-header h1,
        #etalase-view #stok-kredensial-management-view > .view-header h1,
        #etalase-view #stok-akun-management-view > .view-header .back-to-menu-btn,
        #etalase-view #stok-kredensial-management-view > .view-header .back-to-menu-btn {
            display: none;
        }
        /* Atur ulang header agar tombol 'actions' tetap terlihat rapi */
        #etalase-view #stok-akun-management-view > .view-header,
        #etalase-view #stok-kredensial-management-view > .view-header {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
            justify-content: flex-end; /* Dorong tombol 'actions' ke kanan */
        }

        #etalase-view #stok-akun-management-view,
        #etalase-view #stok-kredensial-management-view {
            display: block; /* HAPUS !important agar JS bisa override */
        }

/* --- End of Live Chat View Styles --- */

/* Quick OTP Toggle on Menu */
.quick-otp-toggle {
    position: absolute;
    top: 10px;
    left: 10px;
}
.quick-otp-toggle .toggle-switch label {
    width: 40px;
    height: 22px;
    background: var(--danger-primary); /* Merah saat Off */
}
.quick-otp-toggle .toggle-switch label::after {
    width: 16px;
    height: 16px;
    top: 3px;
    left: 3px;
}
.quick-otp-toggle .toggle-switch input:checked + label {
    background: var(--success-primary); /* Hijau saat On */
}
.quick-otp-toggle .toggle-switch input:checked + label::after {
    transform: translateX(18px);
}

.buyer-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color); background: var(--bg-primary); transition: background 0.2s; } .buyer-list-item:hover { background: var(--bg-secondary); } .buyer-info { display: flex; flex-direction: column; } .buyer-name { font-weight: 600; color: var(--text-primary); font-size: 0.95em; } .buyer-date { font-size: 0.8em; color: var(--text-secondary); } .revoke-btn { background: rgba(239, 68, 68, 0.1); color: var(--danger-primary); border: 1px solid var(--danger-primary); padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8em; transition: all 0.2s; } .revoke-btn:hover { background: var(--danger-primary); color: white; }
</style>
</head>
<body>

    <div id="login-page">
        <div class="form-container">
            <h2><i class="fas fa-shield-halved"></i> Admin Panel Login</h2>
            <form id="login-form">
                <div class="input-group"> <input type="email" id="email" class="input-field" placeholder="Email Admin" required> </div>
                <div class="input-group"> <input type="password" id="password" class="input-field" placeholder="Password Admin" required> </div>
                <button type="submit" class="action-button btn-primary" style="width:100%;"> <i class="fas fa-sign-in-alt"></i> Login </button>
            </form>
        </div>
    </div>
    
    <div id="admin-panel" class="dashboard-layout">
        <header class="top-header">
            <h2 class="header-title"><i class="fas fa-gamepad"></i> Auth Tools</h2>
            <div class="header-actions">
                <button id="logout-btn" class="action-button btn-danger"><i class="fas fa-sign-out-alt"></i> Logout</button>
                <div class="admin-status-toggle-container">
                    <span class="admin-status-label">Offline</span>
                    <div class="toggle-switch admin-header-toggle">
                        <input type="checkbox" id="admin-online-toggle">
                        <label for="admin-online-toggle"></label>
                    </div>
                    <span class="admin-status-label">Online</span>
                </div>
                </div>
        </header>

        <main class="main-content">
            <div id="main-menu-view">
                 <header class="view-header">
                    <h1>Admin Dashboard</h1>
                    <div class="actions">
                        <button id="quick-add-user-btn" class="action-button btn-success"><i class="fas fa-user-plus"></i> Add User</button>
                        <button id="quick-add-stok-btn" class="action-button btn-primary"><i class="fas fa-archive"></i> Add Stok</button>
                        <button id="quick-add-credential-btn" class="action-button btn-warning"><i class="fas fa-key"></i> Add Credential</button>
                    </div>
                </header>
                 <div class="stat-cards" id="main-menu-stats">
                    <div class="stat-card"> <div class="icon"><i class="fas fa-users"></i></div> <div class="info"> <h3 id="stat-total-users">0</h3> <p>Total Users</p> </div> </div>
                    
                    
                    <div class="stat-card"> <div class="icon"><i class="fas fa-cash-register"></i></div> <div class="info"> <h3 id="stat-total-spent">0</h3> <p>Total Dibelanjakan</p> </div> </div>
                </div>
                <div class="menu-grid-container">
                    <button class="menu-grid-button menu-users" data-view="users"> <i class="fas fa-users"></i> <span>Users</span> </button>
<button class="menu-grid-button" data-view="otpGenerator">
    <div class="quick-otp-toggle" onclick="event.stopPropagation();">
        <div class="toggle-switch">
            <input type="checkbox" id="main-menu-otp-toggle">
            <label for="main-menu-otp-toggle"></label>
        </div>
        <small class="toggle-label">Fitur OTP</small>
    </div>
    <i class="fas fa-key"></i> 
    <span>Kode Otp</span> 
</button>
                    <button class="menu-grid-button menu-transactions" data-view="transactions">
                        <span class="notification-badge" id="pending-trx-badge" style="display: none;">0</span>
                        <i class="fas fa-exchange-alt"></i> 
                        <span>Transactions</span> 
                    </button>
                    <button class="menu-grid-button menu-rekap" data-view="rekap"> <i class="fas fa-receipt"></i> <span>Rekap</span> </button>
<button class="menu-grid-button menu-live-chat" data-view="liveChat">
            <span class="notification-badge" id="chat-notification-badge" style="display: none;">0</span>
            <i class="fas fa-headset"></i> 
            <span>Live Chat</span> 
        </button>
                    <button class="menu-grid-button" data-view="etalase" style="grid-column: span 3;"><i class="fas fa-store"></i> <span>Etalase Saya</span></button>

                    <button class="menu-grid-button menu-settings" data-view="settings"> <i class="fas fa-cogs"></i> <span>Settings</span> </button>
                </div>
                 <div class="quick-settings-container">
                    <div class="settings-card">
                        <h2><i class="fas fa-tools"></i> Maintenance Mode</h2>
                        <div class="input-group" style="margin-bottom: 0;">
                            <div class="toggle-switch">
                                <input type="checkbox" id="main-menu-maintenance-toggle">
                                <label for="main-menu-maintenance-toggle"></label>
                                <span>Aktifkan Mode Perbaikan (Global)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div><div id="live-chat-view">
    <header class="view-header">
        <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
        <h1>Live Chat</h1>
        <div class="actions">
            <button id="new-chat-message-btn" class="action-button btn-success"><i class="fas fa-plus"></i> Pesan Baru</button>
        </div>
    </header>
    
    <div id="chat-session-list" class="chat-list-full-view">
        <div id="chat-list-header">Active Chats</div>
        <div id="chat-session-list-items">
            <p style="padding: 15px; text-align: center; color: var(--text-secondary);">Memuat sesi...</p>
        </div>
    </div>
    
    </div>

<div id="user-management-view" style="display: none;">
                <header class="view-header">
                     <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
                    <h1>User Management</h1>
                    <div class="actions">
                        <button id="add-user-btn" class="action-button btn-success"><i class="fas fa-plus"></i> Add User</button>
                    </div>
                </header>

                <div class="controls-container">
                    <div class="controls">
                        <div class="filter-buttons" id="user-account-type-filters">
                
                <button class="filter-btn active" data-filter="USER"><i class="fas fa-user"></i> User</button>
                <button class="filter-btn" data-filter="Langganan"><i class="fas fa-star"></i> Langganan</button>
                <button class="filter-btn" data-filter="PREMIUM"><i class="fas fa-gem"></i> Premium</button>
                                <button class="filter-btn" data-filter="Admin"><i class="fas fa-shield-halved"></i> Admin</button>
                <button class="filter-btn" data-filter="BANNED" style="color: var(--danger-primary);"><i class="fas fa-ban"></i> Blokir</button>
            </div>
<div class="search-bar"> <i class="fas fa-search"></i> <input type="text" id="search-input" class="input-field" placeholder="Search by username, whatsapp, device ID..."> </div>
                        <button id="refresh-users-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>

                <div id="user-card-container">
                </div>
                <div class="spinner-overlay" id="user-spinner" style="display:none;"><div class="spinner"></div></div>

                <div class="pagination">
                    <span id="page-info"></span>
                    <div class="pagination-controls">
                        <button id="prev-page-btn" class="action-button btn-secondary"><i class="fas fa-arrow-left"></i> Prev</button>
                        <button id="next-page-btn" class="action-button btn-secondary">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                <small id="last-refreshed" style="display: block; margin-top: 15px; text-align: right; color: var(--text-secondary);"></small>
            </div>

            <div id="transaction-management-view" style="display: none;">
                <header class="view-header">
                    <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
                    <h1>Pending Transactions</h1>
                     <div class="actions">
                        <button id="refresh-transactions-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </header>
                <div id="pending-transaction-container">
                </div>
                 <div class="spinner-overlay" id="transaction-spinner" style="display:none;"><div class="spinner"></div></div>
            </div>
            
                        </div><div id="etalase-view" style="display: none;">
                <header class="view-header">
                    <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
                    <h1>Etalase Saya</h1>
                    <div class="actions">
                        <button id="refresh-etalase-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </header>
                <div class="controls-container">
                    <div class="filter-buttons" id="etalase-filters">
                        <button class="filter-btn active" data-etalase-view="kredensial"><i class="fas fa-key"></i> Stok Kredensial</button>
                        <button class="filter-btn" data-etalase-view="penawaran"><i class="fas fa-archive"></i> Stok Penawaran</button>
                        <button class="filter-btn" data-etalase-view="mod"><i class="fas fa-cube"></i> Stok MOD</button>
                    </div>
                </div>
            
<div id="stok-akun-management-view" style="display: none;">
                 <header class="view-header">
                    <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
                    <h1>Manajemen Stok Penawaran</h1>
                    <div class="actions">
                        <button id="add-stok-akun-btn" class="action-button btn-success"><i class="fas fa-plus"></i> Tambah Penawaran</button>
                    </div>
                </header>
                <div class="controls-container">
                    <div class="controls">
                         <div class="filter-buttons" id="stok-akun-filters">
                            <button class="filter-btn active" data-filter="all">Semua Penawaran</button>
                            <button class="filter-btn" data-filter="available">Tersedia</button>
                            <button class="filter-btn" data-filter="sold">Terjual</button>
                         </div>
                         <button id="refresh-stok-akun-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div id="stok-akun-card-container">
                </div>
                <div class="spinner-overlay" id="stok-akun-spinner" style="display:none;"><div class="spinner"></div></div>
            </div>
            
            <div id="stok-kredensial-management-view" style="display: none;">
                 <header class="view-header">
                    <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
                    <h1>Manajemen Stok Kredensial</h1>
                    <div class="actions">
                        <button id="add-stok-kredensial-btn" class="action-button btn-success"><i class="fas fa-plus"></i> Tambah Kredensial</button>
                    </div>
                </header>
                <div class="controls-container">
                    <div class="controls">
                        <div class="filter-buttons" id="stok-kredensial-filters">
                            <button class="filter-btn active" data-filter="available">Tersedia</button>
                            <button class="filter-btn" data-filter="used">Terpakai</button>
                        </div>
                         <button id="refresh-stok-kredensial-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div id="stok-kredensial-card-container">
                </div>
                <div class="spinner-overlay" id="stok-kredensial-spinner" style="display:none;"><div class="spinner"></div></div>
            </div>

            </div> 

            
            <div id="stok-mod-management-view" style="display: none;">
                 <header class="view-header">
                    <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
                    <h1>Manajemen Stok MOD</h1>
                    <div class="actions">
                        <button id="add-stok-mod-btn" class="action-button btn-success"><i class="fas fa-plus"></i> Tambah MOD</button>
                    </div>
                </header>
                <div class="controls-container">
                    <div class="controls">
                         <button id="refresh-stok-mod-btn" class="action-button btn-primary"> <i class="fas fa-sync-alt"></i> Refresh</button>
                    </div>
                </div>
                <div id="stok-mod-card-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                </div>
                <div class="spinner-overlay" id="stok-mod-spinner" style="display:none;"><div class="spinner"></div></div>
            </div>
<div id="rekap-view" style="display: none;">
                <header class="view-header">
                    <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
                    <h1>Rekap Transaksi</h1>
                    <div class="actions">
                        <button id="reset-rekap-btn" class="action-button btn-danger"><i class="fas fa-trash-alt"></i> Reset Rekap</button>
                    </div>
                </header>
                 <div class="controls-container">
                    <div class="filter-buttons" id="rekap-filters">
                        <button class="filter-btn active" data-filter="all">Tampilkan Semua</button>
                        <button class="filter-btn" data-filter="today">Hari Ini</button>
                        <button class="filter-btn" data-filter="yesterday">Kemarin</button>
                        <button class="filter-btn" data-filter="this_week">Minggu Ini</button>
                    </div>
                </div>
                <div id="rekap-table-container">
                    <table id="rekap-table">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Nama User</th>
                                <th>WhatsApp</th>
                                <th>Jenis Transaksi</th>
                                <th>Detail Transaksi</th>
                                <th>Saldo Terpakai</th>
                                <th>Saldo Saat Ini</th>
                            </tr>
                        </thead>
                        <tbody id="rekap-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="spinner-overlay" id="rekap-spinner" style="display:none;"><div class="spinner"></div></div>
            </div>

            <div id="settings-view" style="display: none;">
                <header class="view-header">
                    <button class="action-button btn-secondary back-to-menu-btn"><i class="fas fa-arrow-left"></i> Menu</button>
                    <h1>App Settings</h1>
                </header>
                <div class="settings-grid">
                    <div class="settings-card">
                        <h2><i class="fas fa-tools"></i> Maintenance Mode</h2>
                        <div class="input-group">
                            <div class="toggle-switch">
                                <input type="checkbox" id="maintenance-toggle">
                                <label for="maintenance-toggle"></label>
                                <span>Aktifkan Mode Perbaikan</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="maintenance-message">Pesan Perbaikan</label>
                            <textarea id="maintenance-message" class="input-field" rows="3" placeholder="Contoh: Perbaikan rutin hingga 10:00 WIB"></textarea>
                        </div>
                        </div>
<div class="settings-card">
                    <h2><i class="fas fa-key"></i> Mode Verifikasi OTP</h2>
                    <div class="input-group" style="margin-bottom: 0;">
                        <div class="toggle-switch">
                            <input type="checkbox" id="otp-toggle">
                            <label for="otp-toggle"></label>
                            <span>Aktifkan Verifikasi OTP Saat Pendaftaran</span>
                        </div>
                    </div>
                    <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 10px;">
                        Jika dinonaktifkan, pengguna baru bisa mendaftar tanpa kode OTP.
                    </p>
                </div>
                    <div class="settings-card">
                        <h2><i class="fas fa-comment-dots"></i> Pesan Sambutan</h2>
                        <div class="settings-tabs">
                            <button class="tab-button active" data-tab="global">Global</button>
                            <button class="tab-button" data-tab="newUser">User Baru</button>
                            <button class="tab-button" data-tab="specific">Spesifik</button>
                        </div>

                        <div id="tab-content-global" class="tab-content active">
                            <form id="global-message-form">
                                <div class="input-group">
                                    <label for="global-message-title">Judul Pesan</label>
                                    <input type="text" id="global-message-title" class="input-field" placeholder="Pemberitahuan">
                                </div>
                                <div class="input-group">
                                    <label for="global-message-content">Isi Pesan</label>
                                    <textarea id="global-message-content" class="input-field" rows="4" placeholder="Fitur baru telah ditambahkan!"></textarea>
                                </div>
                                <div class="input-group">
                                    <label for="global-message-logins">Tampilkan berapa kali (per user)</label>
                                    <input type="number" id="global-message-logins" class="input-field" value="1" min="1">
                                </div>
                                <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Simpan Pesan Global</button>
                            </form>
                        </div>

                        <div id="tab-content-newUser" class="tab-content">
                            <form id="newUser-message-form">
                                <div class="input-group">
                                    <label for="newUser-message-title">Judul Pesan</label>
                                    <input type="text" id="newUser-message-title" class="input-field" placeholder="Selamat Datang!">
                                </div>
                                <div class="input-group">
                                    <label for="newUser-message-content">Isi Pesan</label>
                                    <textarea id="newUser-message-content" class="input-field" rows="4" placeholder="Terima kasih telah bergabung..."></textarea>
                                </div>
                                <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Simpan Pesan User Baru</button>
                            </form>
                        </div>

                        <div id="tab-content-specific" class="tab-content">
                            <form id="specific-message-form">
                                 <div class="input-group">
                                    <label for="specific-user-select">Pilih User</label>
                                    <select id="specific-user-select" class="input-field">
                                        <option value="">-- Memuat user... --</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="specific-message-title">Judul Pesan</label>
                                    <input type="text" id="specific-message-title" class="input-field" placeholder="Pesan Khusus Untuk Anda">
                                </div>
                                <div class="input-group">
                                    <label for="specific-message-content">Isi Pesan</label>
                                    <textarea id="specific-message-content" class="input-field" rows="4"></textarea>
                                </div>
                                <div class="input-group">
                                    <label for="specific-message-logins">Tampilkan berapa kali</label>
                                    <input type="number" id="specific-message-logins" class="input-field" value="1" min="1">
                                </div>
                                <button type="submit" class="action-button btn-success"><i class="fas fa-paper-plane"></i> Kirim ke User</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="floating-transaction-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-bell" style="color:var(--warning-primary);"></i> Transaksi Pending Ditemukan</h2>
            <div id="floating-transaction-content" style="margin-top: 20px;">
                </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button type="button" id="floating-reject-btn" class="action-button btn-danger">Tolak</button>
                <button type="button" id="floating-accept-btn" class="action-button btn-success">Terima</button>
                <button type="button" class="action-button btn-secondary cancel-modal-btn">Tutup</button>
            </div>
        </div>
    </div>

    <div id="online-users-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-wifi" style="color:var(--online-green);"></i> Pengguna Online</h2>
            <ul id="online-users-list">
                <p>Tidak ada pengguna yang online saat ini.</p>
            </ul>
            <div class="modal-actions">
                <button type="button" class="action-button btn-secondary cancel-modal-btn">Tutup</button>
            </div>
        </div>
    </div>

    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Edit User Data</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-doc-id">
                <div class="input-group"> <label for="edit-username">Username</label> <input type="text" id="edit-username" class="input-field" required> </div>
                <div class="input-group">
                    <label for="edit-accountType">Account Type</label>
                    <select id="edit-accountType" class="input-field" required>
                        <option value="USER">USER</option>
                        <option value="PREMIUM">PREMIUM</option>
                        <option value="Langganan">Langganan</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div><div id="subscription-fields">
                    <div class="input-group">
                        <label for="edit-masaAktifHingga">Masa Aktif Hingga</label>
                        <input type="date" id="edit-masaAktifHingga" class="input-field">
                    </div>
                    <div class="input-group">
                        <label>Tambah / Kurangi Masa Aktif</label>
                        <div class="date-buttons">
                            <button type="button" class="action-button btn-danger date-mod-btn" data-days="-30">-30 Hari</button>
                            <button type="button" class="action-button btn-danger date-mod-btn" data-days="-7">-7 Hari</button>
                            <button type="button" class="action-button btn-success date-mod-btn" data-days="7">+7 Hari</button>
                            <button type="button" class="action-button btn-success date-mod-btn" data-days="30">+30 Hari</button>
                        </div>
                    </div>
                </div>
                <div class="input-group"> <label for="edit-saldo">Saldo (Angka saja)</label> <input type="number" id="edit-saldo" class="input-field" required> </div>
                <div class="input-group"> <label for="edit-akunGratisQuota">Kuota Akun Gratis (Langganan/Premium)</label> <input type="number" id="edit-akunGratisQuota" class="input-field" value="0"> </div>
                <div class="input-group"> <label for="edit-whatsapp">WhatsApp</label> <input type="text" id="edit-whatsapp" class="input-field" required> </div>
                <div class="input-group"> <label for="edit-password">Password</label> <div class="password-wrapper"> <input type="password" id="edit-password" class="input-field" required> <button type="button" class="password-toggle"><i class="fas fa-eye"></i></button> </div> </div>
                <div class="modal-actions"> <button type="button" class="action-button btn-secondary cancel-modal-btn">Cancel</button> <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Save</button> </div>
            </form>
        </div>
    </div>
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-user-plus"></i> Add New User</h2>
            <form id="add-user-form">
                <div class="input-group"> <label for="add-username">Username</label> <input type="text" id="add-username" class="input-field" required> </div>
                <div class="input-group"> <label for="add-saldo">Saldo (Angka saja)</label> <input type="number" id="add-saldo" class="input-field" value="0" required> </div>
                <div class="input-group"> <label for="add-pendingTransaction">Pending Transaction</label> <input type="number" id="add-pendingTransaction" class="input-field" value="0" required> </div>
                <div class="input-group"> <label for="add-whatsapp">WhatsApp</label> <input type="text" id="add-whatsapp" class="input-field" required> </div>
                <div class="input-group"> <label for="add-password">Password</label> <div class="password-wrapper"> <input type="password" id="add-password" class="input-field" required> <button type="button" class="password-toggle"><i class="fas fa-eye"></i></button> </div> </div>
                <div class="modal-actions"> <button type="button" class="action-button btn-secondary cancel-modal-btn">Cancel</button> <button type="submit" class="action-button btn-success"><i class="fas fa-plus"></i> Create</button> </div>
            </form>
        </div>
    </div>

    <div id="edit-stok-akun-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Edit Penawaran Akun</h2>
            <form id="edit-stok-akun-form">
                <input type="hidden" id="edit-stok-akun-id">
                 <div class="input-group">
                    <label for="edit-stok-akun-usernameTampilan">Nama Tampilan Penawaran</label>
                    <input type="text" id="edit-stok-akun-usernameTampilan" class="input-field" placeholder="Cth: Akun Sultan Spek A" required>
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="edit-stok-akun-gameType">Jenis Game</label>
                        <select id="edit-stok-akun-gameType" class="input-field" required>
                            <option value="BUSSID">BUSSID</option>
                            <option value="TRUCKSID">TRUCKSID</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="edit-stok-akun-loginType">Jenis Login</label>
                        <select id="edit-stok-akun-loginType" class="input-field" required>
                            <option value="Google">Google</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                </div>
                 <div class="form-grid">
                    <div class="input-group">
                        <label for="edit-stok-akun-jumlahUB">Jumlah UB</label>
                        <input type="number" id="edit-stok-akun-jumlahUB" class="input-field" placeholder="Cth: 500000000" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-stok-akun-price">Harga (Cth: 10000)</label>
                        <input type="number" id="edit-stok-akun-price" class="input-field" required>
                    </div>
                </div>
                 <div class="form-grid">
                    <div class="input-group">
                        <label for="edit-stok-akun-stok">Stok</label>
                        <input type="number" id="edit-stok-akun-stok" class="input-field" value="0" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-stok-akun-terjual">Terjual</label>
                        <input type="number" id="edit-stok-akun-terjual" class="input-field" value="0" required>
                    </div>
                 </div>
                 <div class="input-group">
                    <label for="edit-stok-akun-rating">Rating (0-5)</label>
                    <input type="number" id="edit-stok-akun-rating" class="input-field" value="0" min="0" max="5" required>
                </div>
                <div class="input-group">
                    <label for="edit-stok-akun-detailInfo">Detail Info Akun (opsional)</label>
                    <textarea id="edit-stok-akun-detailInfo" class="input-field" rows="3" placeholder="Info tambahan..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-stok-akun-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-plus-circle"></i> Tambah Penawaran Akun</h2>
            <form id="add-stok-akun-form">
                 <div class="input-group">
                    <label for="add-stok-akun-usernameTampilan">Nama Tampilan Penawaran</label>
                    <input type="text" id="add-stok-akun-usernameTampilan" class="input-field" placeholder="Cth: Akun Spek Dewa" required>
                </div>
                 <div class="form-grid">
                    <div class="input-group">
                        <label for="add-stok-akun-gameType">Jenis Game</label>
                        <select id="add-stok-akun-gameType" class="input-field" required>
                            <option value="BUSSID">BUSSID</option>
                            <option value="TRUCKSID">TRUCKSID</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="add-stok-akun-loginType">Jenis Login</label>
                        <select id="add-stok-akun-loginType" class="input-field" required>
                            <option value="Google">Google</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="add-stok-akun-jumlahUB">Jumlah UB</label>
                        <input type="number" id="add-stok-akun-jumlahUB" class="input-field" placeholder="Cth: 1000000000" required>
                    </div>
                    <div class="input-group">
                        <label for="add-stok-akun-price">Harga (Cth: 25000)</label>
                        <input type="number" id="add-stok-akun-price" class="input-field" required>
                    </div>
                </div>
                <div class="form-grid">
                     <div class="input-group">
                        <label for="add-stok-akun-stok">Stok</label>
                        <input type="number" id="add-stok-akun-stok" class="input-field" value="1" required>
                    </div>
                    <div class="input-group">
                        <label for="add-stok-akun-terjual">Terjual</label>
                        <input type="number" id="add-stok-akun-terjual" class="input-field" value="0" required>
                    </div>
                </div>
                <div class="input-group">
                    <label for="add-stok-akun-rating">Rating (0-5)</label>
                    <input type="number" id="add-stok-akun-rating" class="input-field" value="5" min="0" max="5" required>
                </div>
                <div class="input-group">
                    <label for="add-stok-akun-detailInfo">Detail Info Akun (opsional)</label>
                    <textarea id="add-stok-akun-detailInfo" class="input-field" rows="3" placeholder="Info tambahan..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-success"><i class="fas fa-plus"></i> Tambah Penawaran</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-stok-kredensial-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Edit Stok Kredensial</h2>
            <form id="edit-stok-kredensial-form">
                <input type="hidden" id="edit-stok-kredensial-id">
                <div class="form-grid">
                    <div class="input-group">
                        <label for="edit-stok-kredensial-gameType">Jenis Game</label>
                        <select id="edit-stok-kredensial-gameType" class="input-field" required>
                            <option value="BUSSID">BUSSID</option>
                            <option value="TRUCKSID">TRUCKSID</option>
                            <option value="BUSSID/TRUCKSID">BUSSID/TRUCKSID</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="edit-stok-kredensial-loginType">Jenis Login</label>
                        <select id="edit-stok-kredensial-loginType" class="input-field" required>
                            <option value="Google">Google</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label for="edit-stok-kredensial-email">Email / No. HP</label>
                    <input type="text" id="edit-stok-kredensial-email" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="edit-stok-kredensial-password">Password</label>
                    <input type="text" id="edit-stok-kredensial-password" class="input-field" required>
                </div>
                 <div class="input-group">
                    <label for="edit-stok-kredensial-deviceId">Device ID</label>
                    <input type="text" id="edit-stok-kredensial-deviceId" class="input-field" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </form>
        </div>
    </div>
    <div id="add-stok-kredensial-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-plus-circle"></i> Tambah ke Stok Kredensial</h2>
            <form id="add-stok-kredensial-form">
                 <div class="form-grid">
                    <div class="input-group">
                        <label for="add-stok-kredensial-gameType">Jenis Game</label>
                        <select id="add-stok-kredensial-gameType" class="input-field" required>
                            <option value="BUSSID">BUSSID</option>
                            <option value="TRUCKSID">TRUCKSID</option>
                            <option value="BUSSID/TRUCKSID">BUSSID/TRUCKSID</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="add-stok-kredensial-loginType">Jenis Login</label>
                        <select id="add-stok-kredensial-loginType" class="input-field" required>
                            <option value="Google">Google</option>
                            <option value="Facebook">Facebook</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label for="add-stok-kredensial-email">Email / No. HP</label>
                    <input type="text" id="add-stok-kredensial-email" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="add-stok-kredensial-password">Password</label>
                    <input type="text" id="add-stok-kredensial-password" class="input-field" required>
                </div>
                 <div class="input-group">
                    <label for="add-stok-kredensial-deviceId">Device ID</label>
                    <input type="text" id="add-stok-kredensial-deviceId" class="input-field" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-success"><i class="fas fa-plus"></i> Tambah Kredensial</button>
                </div>
            </form>
        </div>
    </div>
    
    
    <div id="add-stok-mod-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-plus-circle"></i> Tambah Produk MOD</h2>
            <form id="add-stok-mod-form">
                 <div class="input-group">
                    <label>Foto Produk (Maks 5 Foto)</label>
                    <input type="file" id="add-stok-mod-images" class="input-field" accept="image/*" multiple required>
                    <small style="color:var(--text-secondary)">Foto pertama akan menjadi thumbnail.</small>
                </div>
                <div class="input-group">
                    <label>Nama MOD</label>
                    <input type="text" id="add-stok-mod-name" class="input-field" placeholder="Contoh: Mod Truck Canter Full Anim" required>
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Harga (Rp)</label>
                        <input type="number" id="add-stok-mod-price" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label>Terjual (Fake Count)</label>
                        <input type="number" id="add-stok-mod-sold" class="input-field" value="0">
                    </div>
                </div>
                <div class="input-group">
                    <label>Rating (0-5)</label>
                    <input type="number" id="add-stok-mod-rating" class="input-field" value="5" min="0" max="5" step="0.1">
                </div>
                <div class="input-group">
                    <label>Link Download File</label>
                    <input type="url" id="add-stok-mod-link" class="input-field" placeholder="https://..." required>
                </div>
                <div class="input-group">
                    <label>Pesan / Cara Pemakaian</label>
                    <textarea id="add-stok-mod-instruction" class="input-field" rows="4" placeholder="Tulis langkah-langkah pemasangan atau password zip disini..." required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-success"><i class="fas fa-save"></i> Simpan Produk</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-stok-mod-modal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-edit"></i> Edit Produk MOD</h2>
            <form id="edit-stok-mod-form">
                <input type="hidden" id="edit-stok-mod-id">
                 <div class="input-group">
                    <label>Ganti Foto (Biarkan kosong jika tidak ingin mengubah)</label>
                    <input type="file" id="edit-stok-mod-images" class="input-field" accept="image/*" multiple>
                </div>
                <div class="input-group">
                    <label>Nama MOD</label>
                    <input type="text" id="edit-stok-mod-name" class="input-field" required>
                </div>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Harga (Rp)</label>
                        <input type="number" id="edit-stok-mod-price" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label>Terjual</label>
                        <input type="number" id="edit-stok-mod-sold" class="input-field" required>
                    </div>
                </div>
                <div class="input-group">
                    <label>Rating (0-5)</label>
                    <input type="number" id="edit-stok-mod-rating" class="input-field" min="0" max="5" step="0.1" required>
                </div>
                <div class="input-group">
                    <label>Link Download File</label>
                    <input type="url" id="edit-stok-mod-link" class="input-field" required>
                </div>
                <div class="input-group">
                    <label>Pesan / Cara Pemakaian</label>
                    <textarea id="edit-stok-mod-instruction" class="input-field" rows="4" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-primary"><i class="fas fa-save"></i> Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>
<div id="confirm-modal" class="modal" style="z-index: 1003;">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <h2 id="confirm-title" style="color: var(--danger-primary);"><i class="fas fa-exclamation-triangle"></i> Confirmation</h2>
            <p id="confirm-message" style="font-size: 1.1em; color: var(--text-primary); margin: 20px 0;">Are you sure?</p>
            <div class="modal-actions" style="justify-content: center;">
                 <button type="button" id="confirm-cancel-btn" class="action-button btn-secondary">Cancel</button>
                 <button type="button" id="confirm-ok-btn" class="action-button btn-danger">Yes, I'm sure</button>
            </div>
        </div>
    </div>

    <div id="pin-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2><i class="fas fa-key"></i> Masukkan PIN Keamanan</h2>
            <form id="pin-form">
                <div class="input-group">
                    <label for="pin-input">Untuk melanjutkan, masukkan PIN Anda.</label>
                    <input type="password" id="pin-input" class="input-field" required pattern="[0-9]*" inputmode="numeric">
                </div>
                <div class="modal-actions">
                    <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                    <button type="submit" class="action-button btn-primary">Konfirmasi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="otp-generator-modal" class="modal" style="z-index: 1003;">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <span class="modal-close cancel-modal-btn" style="top: 10px; right: 12px; font-size: 2em; color: var(--text-secondary); cursor: pointer; line-height: 1;"></span>
            <h2><i class="fas fa-key" style="color:var(--premium-gold);"></i> Generator Kode OTP</h2>
            <p class="subtitle" style="font-size: 1em; color: var(--text-primary); margin: 20px 0;">Gunakan tombol ini untuk membuat kode OTP 5 digit baru untuk pendaftaran user.</p>
            
            <div id="otp-display-area" style="margin-bottom: 25px; display: none;">
                <h3 style="color: var(--text-secondary); font-size: 1.1em; margin-bottom: 10px;">Kode OTP Aktif Saat Ini:</h3>
                <p id="generated-otp-display" style="font-size: 2.8em; font-weight: 700; color: var(--accent-green); letter-spacing: 5px; background: var(--bg-primary); padding: 15px; border-radius: 8px; border: 1px dashed var(--accent-green);"></p>
            </div>
            
            <div class="modal-actions" style="justify-content: center;">
                 <button type="button" id="generate-otp-btn" class="action-button btn-primary" style="width: 100%;"><i class="fas fa-sync-alt"></i> Generate Kode OTP Baru</button>
            </div>
            <p class="subtitle" style="font-size: 0.8em; color: var(--text-secondary); margin-top: 15px;">Meng-generate kode baru akan otomatis menghanguskan kode lama (jika ada).</p>
        </div>
    </div>

        <div id="ban-reason-modal" class="modal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 400px;">
            <h2><i class="fas fa-ban" style="color: var(--danger-primary);"></i> Blokir User</h2>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Masukkan alasan pemblokiran untuk user ini:</p>
            <div class="input-group">
                <textarea id="ban-reason-input" class="input-field" rows="4" placeholder="Contoh: Melanggar aturan spam..." required></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-button btn-secondary cancel-modal-btn">Batal</button>
                <button type="button" id="confirm-ban-btn" class="action-button btn-danger">Konfirmasi Blokir</button>
            </div>
        </div>
    </div>

            <div id="admin-image-lightbox" class="lightbox-overlay">
        <span class="lightbox-close" id="admin-close-lightbox-btn">&times;</span>
        <button class="lightbox-nav-btn lightbox-prev" id="admin-lightbox-prev-btn" style="display:none"></button>
        <button class="lightbox-nav-btn lightbox-next" id="admin-lightbox-next-btn" style="display:none"></button>
        <div class="lightbox-content">
            <img src="" alt="Full Size" id="admin-lightbox-image">
            <div id="admin-lightbox-counter" class="lightbox-counter" style="display:none"></div>
        </div>
    </div>

    <div id="toast-container"></div>
<div id="toast-container"></div>
<div id="toast-container"></div>
<div id="floating-chat-window" class="floating-chat-container">
    <div id="floating-chat-header">
        <span id="floating-chat-username">Memuat...</span>
        <div class="chat-window-controls">
            <button id="floating-chat-clear" class="chat-control-btn" title="Hapus Riwayat Chat"><i class="fas fa-trash-alt"></i></button>
            <button id="floating-chat-minimize"
<button id="floating-chat-minimize" class="chat-control-btn" title="Minimize"><i class="fas fa-window-minimize"></i></button>
            <button id="floating-chat-close" class="chat-control-btn" title="Close"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div id="floating-chat-messages" class="chat-messages-admin-panel">
        <p style="text-align:center; color: var(--text-secondary);">Memuat pesan...</p>
    </div>
    <div id="floating-chat-input-area" class="chat-input-area-admin-panel">
        <input type="file" id="admin-chat-file-input" accept="image/*" style="display: none;">
            <button type="button" id="admin-chat-attach-btn" class="action-button" style="border-radius: 50%; width: 44px; height: 44px; padding: 0; background: var(--bg-tertiary); flex-shrink: 0; margin-right: 5px;" title="Kirim Gambar">
                <i class="fas fa-paperclip"></i>
            </button>
            <textarea id="floating-chat-text" class="input-field" rows="2" placeholder="Ketik balasan..." disabled></textarea>
        <button id="floating-chat-send" class="action-button btn-primary" disabled><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div id="mod-buyers-window" class="floating-chat-container" style="right: 50%; transform: translateX(50%); bottom: 10%; height: 600px; width: 400px; z-index: 10002;">
    <div id="floating-chat-header" style="background: var(--warning-primary);">
        <span id="mod-buyers-title" style="flex-grow:1; font-weight:600;">Daftar Pembeli</span>
        <button id="close-mod-buyers" class="chat-control-btn"><i class="fas fa-times"></i></button>
    </div>
    <div class="chat-messages-admin-panel" id="mod-buyers-list" style="padding: 0;">
        <p style="text-align:center; padding: 20px; color: var(--text-secondary);">Memuat data...</p>
    </div>
</div>
<div id="new-chat-modal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <h2><i class="fas fa-user-plus"></i> Mulai Chat Baru</h2>
        <div class="input-group">
            <label for="new-chat-search">Cari User</label>
            <input type="text" id="new-chat-search" class="input-field" placeholder="Ketik nama user...">
        </div>
        <ul id="new-chat-user-list" style="list-style: none; padding: 0; max-height: 40vh; overflow-y: auto; background: var(--bg-primary); border-radius: 8px;">
            <p style="text-align: center; padding: 20px; color: var(--text-secondary);">Memuat user...</p>
        </ul>
        <div class="modal-actions">
            <button type="button" class="action-button btn-secondary cancel-modal-btn">Tutup</button>
        </div>
    </div>
</div>
    
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, serverTimestamp, setDoc, getDoc, deleteField, orderBy, query, onSnapshot, writeBatch, where, limit, runTransaction, Timestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getDatabase, ref, onValue, onChildChanged, onChildRemoved, push, serverTimestamp as dbServerTimestamp, set, remove, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3KJT9eh42V6ytLoY5e4ozzDXY4sHhado",
            authDomain: "donitata1717-f10f7.firebaseapp.com",
            projectId: "donitata1717-f10f7",
            storageBucket: "donitata1717-f10f7.appspot.com",
            messagingSenderId: "760325542999",
            appId: "1:760325542999:web:be97c17580f64407e33f12",
            databaseURL: "https://donitata1717-f10f7-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);

        // --- START: Admin Status Ref ---
        const adminStatusRef = ref(rtdb, 'appStatus/adminOnline');
        // --- END: Admin Status Ref ---

        // State variables
        let allUsers = [], displayedUsers = [], currentPage = 1, allStokAkun = [], allStokKredensial = [], allRekapData = [];
        const rowsPerPage = 10;
        let appSettings = {};
        let unsubscribeListeners = []; // Untuk menyimpan semua listener realtime
                let isFloatingModalShown = false;
        let currentBanTargetId = null;


        // DOM element references
        const dom = { 
            loginPage: document.getElementById('login-page'), 
            adminPanel: document.getElementById('admin-panel'), 
            mainMenuView: document.getElementById('main-menu-view'),
            userCardContainer: document.getElementById('user-card-container'),
            pendingTransactionContainer: document.getElementById('pending-transaction-container'),
            stokAkunCardContainer: document.getElementById('stok-akun-card-container'),
            stokKredensialCardContainer: document.getElementById('stok-kredensial-card-container'),
            stokModCardContainer: document.getElementById('stok-mod-card-container'),
            stokModSpinner: document.getElementById('stok-mod-spinner'),
            addStokModModal: document.getElementById('add-stok-mod-modal'),
            editStokModModal: document.getElementById('edit-stok-mod-modal'),
            searchInput: document.getElementById('search-input'),
            userSpinner: document.getElementById('user-spinner'),
            transactionSpinner: document.getElementById('transaction-spinner'),
            stokAkunSpinner: document.getElementById('stok-akun-spinner'),
            stokKredensialSpinner: document.getElementById('stok-kredensial-spinner'),
            rekapSpinner: document.getElementById('rekap-spinner'),
            editUserModal: document.getElementById('edit-user-modal'), 
            addUserModal: document.getElementById('add-user-modal'), 
            editStokAkunModal: document.getElementById('edit-stok-akun-modal'),
            addStokAkunModal: document.getElementById('add-stok-akun-modal'),
            editStokKredensialModal: document.getElementById('edit-stok-kredensial-modal'),
            addStokKredensialModal: document.getElementById('add-stok-kredensial-modal'),
            confirmModal: document.getElementById('confirm-modal'),
            pinModal: document.getElementById('pin-modal'),
            onlineUsersModal: document.getElementById('online-users-modal'),
            floatingTransactionModal: document.getElementById('floating-transaction-modal'),
            views: {
                users: document.getElementById('user-management-view'),
                transactions: document.getElementById('transaction-management-view'),
                stokAkun: document.getElementById('stok-akun-management-view'),
                stokKredensial: document.getElementById('stok-kredensial-management-view'),
                stokMod: document.getElementById('stok-mod-management-view'),
                settings: document.getElementById('settings-view'),
                rekap: document.getElementById('rekap-view'),
                etalase: document.getElementById('etalase-view') // <-- TAMBAHKAN ETALASE
, // <-- Pastikan ada koma di baris sebelumnya
            liveChat: document.getElementById('live-chat-view') // <-- TAMBAHKAN INI
            }
        };

                                function resizeAndCompressImage(file, maxWidth, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    // LOGIK BARU: Cek ukuran file (950KB = 972800 bytes)
                    if (file.size <= 972800) {
                        console.log("File < 950KB, pakai original.");
                        resolve(event.target.result);
                        return;
                    }

                    console.log("File > 950KB, compressing...");
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width, height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } }
                        else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                        const canvas = document.createElement('canvas');
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Kompresi bertahap agar muat di bawah ~950KB (sekitar 1.3jt karakter base64)
                        let currentQuality = quality;
                        let dataUrl = canvas.toDataURL('image/jpeg', currentQuality);
                        while (dataUrl.length > 1300000 && currentQuality > 0.5) {
                            currentQuality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', currentQuality);
                        }
                        resolve(dataUrl);
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }

        // --- Admin Gallery Logic ---
        let curAdminGal = [];
        let curAdminIdx = 0;

        window.openAdminGallery = (el) => {
            try {
                curAdminGal = JSON.parse(el.dataset.images);
                if(!curAdminGal.length) return;
                curAdminIdx = 0;
                updateAdminGalUI();
                document.getElementById('admin-image-lightbox').style.display = 'flex';
            } catch(e) { console.error(e); }
        };

        function updateAdminGalUI() {
            const img = document.getElementById('admin-lightbox-image');
            const prev = document.getElementById('admin-lightbox-prev-btn');
            const next = document.getElementById('admin-lightbox-next-btn');
            const cnt = document.getElementById('admin-lightbox-counter');
            
            img.src = curAdminGal[curAdminIdx];
            if(curAdminGal.length > 1) {
                prev.style.display = 'block'; next.style.display = 'block'; cnt.style.display = 'block';
                cnt.textContent = `${curAdminIdx + 1} / ${curAdminGal.length}`;
            } else {
                prev.style.display = 'none'; next.style.display = 'none'; cnt.style.display = 'none';
            }
        }

        // Bind Gallery Buttons
        const _prevBtn = document.getElementById('admin-lightbox-prev-btn');
        const _nextBtn = document.getElementById('admin-lightbox-next-btn');
        if(_prevBtn) _prevBtn.onclick = (e) => { e.stopPropagation(); curAdminIdx = (curAdminIdx > 0) ? curAdminIdx - 1 : curAdminGal.length - 1; updateAdminGalUI(); };
        if(_nextBtn) _nextBtn.onclick = (e) => { e.stopPropagation(); curAdminIdx = (curAdminIdx < curAdminGal.length - 1) ? curAdminIdx + 1 : 0; updateAdminGalUI(); };
        
        window.openAdminImageLightbox = window.openAdminGallery; // Fallback compatibility

        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}"></i> ${message}`;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3500);
        };

        // --- VIEW MANAGEMENT ---
        const showMainMenu = () => {
        Object.values(dom.views).forEach(view => view.style.display = 'none');
        dom.mainMenuView.style.display = 'block';
        document.querySelector('.header-title').innerHTML = '<i class="fas fa-gamepad"></i> Auth Tools';
        updateMainMenuStats();
        // checkAndShowFloatingTransaction(); // Dihapus agar tidak auto-popup
    };

        const showView = async (viewName) => {
            Object.values(dom.views).forEach(view => view.style.display = 'none');
            dom.mainMenuView.style.display = 'none';
            
            dom.views[viewName].style.display = 'block';

            const viewTitle = dom.views[viewName].querySelector('h1').textContent;
            document.querySelector('.header-title').innerHTML = `<i class="fas fa-bars"></i> ${viewTitle}`;
            
            if (viewName === 'users') await fetchUsers();
            else if (viewName === 'transactions') await fetchAndRenderTransactions();
            // else if (viewName === 'stokAkun') await fetchStokAkun(); // Dinonaktifkan, di-handle Etalase

            // else if (viewName === 'stokKredensial') await fetchStokKredensial(); // Dinonaktifkan, di-handle Etalase

            else if (viewName === 'settings') await loadAndDisplaySettings();
            else if (viewName === 'rekap') await fetchAndRenderRekap('all');
            else if (viewName === 'etalase') {
                // Default ke kredensial
                document.getElementById('stok-kredensial-management-view').style.display = 'block';
                document.getElementById('stok-akun-management-view').style.display = 'none';
                document.querySelector('#etalase-filters .filter-btn[data-etalase-view="kredensial"]').classList.add('active');
                document.querySelector('#etalase-filters .filter-btn[data-etalase-view="penawaran"]').classList.remove('active');
                await fetchStokKredensial(); // Muat data default
            }
else if (viewName === 'liveChat') { // <-- TAMBAHKAN BLOK INI
        loadChatSessions(); // Panggil fungsi untuk memuat daftar chat
    }
        };

        // --- REALTIME LISTENERS ---
        const setupRealtimeListeners = () => {
            // Listener untuk Notifikasi Transaksi Pending & Jumlah Pending
            const usersRef = collection(db, "users");
            const unsubscribeUsers = onSnapshot(usersRef, (querySnapshot) => {
                const pendingCount = querySnapshot.docs.reduce((count, doc) => {
                    const user = doc.data();
                    if ((user.pendingTransaction && user.pendingTransaction > 0) || user.pendingSubscription || user.pendingAkunPurchase || (user.akunJualStatus && user.akunJualStatus.status === 'Di Proses')) {
                        return count + 1;
                    }
                    return count;
                }, 0);
                
                const badge = document.getElementById('pending-trx-badge');
            // const statPending = document.getElementById('stat-pending-trx'); // Dihapus karena bug
            if (pendingCount > 0) {
                badge.textContent = pendingCount;
                badge.style.display = 'flex';
                // statPending.textContent = pendingCount; // Dihapus karena bug
            } else {
            badge.style.display = 'none';
            // statPending.textContent = 0; // Dihapus karena bug
        }

        // Cek apakah ada pending trx dan modal belum muncul
            if (pendingCount > 0 && !isFloatingModalShown) {
                checkAndShowFloatingTransaction();
            }
        });
        unsubscribeListeners.push(unsubscribeUsers);

            // Listener untuk Status Maintenance
            const settingsRef = doc(db, "settings", "appConfig");
            const unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
                appSettings = docSnap.exists() ? docSnap.data() : {};
                const isActive = appSettings.maintenance?.isActive || false;
                
                document.getElementById('maintenance-toggle').checked = isActive;
                document.getElementById('main-menu-maintenance-toggle').checked = isActive;

                // --- FIX: Sinkronisasi OTP Toggle ---
                const isOtpActive = appSettings.otp?.isActive === false ? false : true; 
                // Cek dulu apakah elemennya ada (jika user di menu settings)
                const settingsOtpToggle = document.getElementById('otp-toggle');
                if (settingsOtpToggle) {
                    settingsOtpToggle.checked = isOtpActive;
                }
                document.getElementById('main-menu-otp-toggle').checked = isOtpActive;
                // --- END FIX ---
                
                if(document.getElementById('maintenance-message')) {
                    document.getElementById('maintenance-message').value = appSettings.maintenance?.message || '';
                }
            });
            unsubscribeListeners.push(unsubscribeSettings);

            // Listener untuk Pengguna Online
        const presenceRef = collection(db, "presence");
        const unsubscribePresence = onSnapshot(presenceRef, (snapshot) => {
            const onlineUsers = [];
            snapshot.forEach(doc => {
                if (doc.data().status === 'online') {
                    onlineUsers.push(doc.data().username);
                }
            }); // <-- FIX: Kurung tutup yang hilang ditambahkan di sini
            // document.getElementById('stat-online-users').textContent = onlineUsers.length; // Dihapus karena bug

            const onlineList = document.getElementById('online-users-list');
            onlineList.innerHTML = '';
            if (onlineUsers.length > 0) {
                onlineUsers.forEach(username => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="online-indicator"></span> ${username}`;
                    onlineList.appendChild(li);
                });
            } else {
                onlineList.innerHTML = '<p>Tidak ada pengguna yang online.</p>';
            }
        });
        unsubscribeListeners.push(unsubscribePresence);
        };

        const cleanupListeners = () => {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
        };

        // --- USER MANAGEMENT FUNCTIONS ---
        const fetchUsers = async () => {
            dom.userSpinner.style.display = 'flex';
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                allUsers = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentPage = 1;
                filterAndDisplayUsers();
                document.getElementById('last-refreshed').textContent = `Last refreshed: ${new Date().toLocaleTimeString('id-ID')}`;
            } catch (error) {
                console.error("Error fetching users:", error);
                showToast('Error fetching user data.', 'error');
            } finally {
                dom.userSpinner.style.display = 'none';
            }
        };
        
        const filterAndDisplayUsers = () => {
            // 1. Ambil filter pencarian
            const searchTerm = dom.searchInput.value.toLowerCase();
            
            // 2. Ambil filter tipe akun
            const accountTypeFilter = document.querySelector('#user-account-type-filters .filter-btn.active').dataset.filter;

                        displayedUsers = allUsers.filter(user => {
                const isBanned = user.isBanned === true;
                let typeMatch = false;

                // Logika Filter Khusus Banned
                if (accountTypeFilter === 'BANNED') {
                    typeMatch = isBanned;
                } else {
                    // Filter normal: Sembunyikan user banned, dan cek tipe akun
                    if (!isBanned) {
                        typeMatch = (accountTypeFilter === 'all') || (user.accountType || 'USER') === accountTypeFilter;
                    }
                }
                
                // Cek filter search
                const searchMatch = (user.username?.toLowerCase() || '').includes(searchTerm) || 
                                    (user.whatsapp?.toString() || '').includes(searchTerm) || 
                                    (user.device_id?.toLowerCase() || '').includes(searchTerm);
                
                return typeMatch && searchMatch;
            });
            
            renderUserCards();
        };

        const renderUserCards = () => {
            dom.userCardContainer.innerHTML = '';
            if (displayedUsers.length === 0) {
                dom.userCardContainer.innerHTML = '<p style="text-align:center;">No users found.</p>';
                document.getElementById('page-info').textContent = 'Showing 0-0 of 0';
                updatePaginationControls();
                return;
            }

            const paginatedUsers = displayedUsers.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);

            paginatedUsers.forEach(user => {
                const accountType = user.accountType || 'USER';
                let statusBadgeClass = 'status-user';
                if (accountType === 'PREMIUM') statusBadgeClass = 'status-premium';
                if (accountType === 'Langganan') statusBadgeClass = 'status-langganan';
                if (accountType === 'Admin') statusBadgeClass = 'status-premium';

                let saldoOrMasaAktifHTML = `Rp ${(user.saldo || 0).toLocaleString('id-ID')}`;
                if (accountType === 'Langganan') {
                    const endDateString = user.masaAktifHingga;
                    if (endDateString) {
                        const parts = endDateString.split('-').map(p => parseInt(p, 10));
                        const endDate = new Date(parts[0], parts[1] - 1, parts[2], 23, 59, 59, 999);
                        const diffTime = endDate.getTime() - new Date().getTime();
                        saldoOrMasaAktifHTML = (diffTime < 0) ? `<span style="color: var(--danger-primary);">Expired</span>` : `${Math.ceil(diffTime / (1000 * 60 * 60 * 24))} hari`;
                    } else {
                        saldoOrMasaAktifHTML = 'Belum diatur';
                    }
                }
                
                let pendingIndicatorHTML = '';
                if ((user.pendingTransaction && user.pendingTransaction > 0) || user.pendingSubscription || user.pendingAkunPurchase || user.akunJualStatus) {
                    pendingIndicatorHTML = '<i class="fas fa-bell pending-indicator" title="Pending Transaction"></i>';
                }
                
                                const isBanned = user.isBanned || false;

                // Format Tanggal Daftar
                let joinedDate = 'Tidak diketahui';
                if (user.createdAt) {
                    const date = user.createdAt.seconds ? new Date(user.createdAt.seconds * 1000) : new Date(user.createdAt);
                    joinedDate = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                }

                const cardHTML = `
                    <div class="user-profile-card">
                        <div class="card-header">
                            <div class="user-title">
                                <h3>${user.username || ''} ${pendingIndicatorHTML}</h3>
                                <span class="status-badge ${statusBadgeClass}">${accountType}</span>
                            </div>
                            <div style="width: 50px; height: 50px; border-radius: 50%; overflow: hidden; border: 2px solid var(--accent-primary); flex-shrink: 0; background: var(--bg-tertiary); box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer;" onclick="openAdminImageLightbox('${user.profilePictureBase64 || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-D-aJ8x_Wu0k_4yL-h2Jb0jQ1wG-m2a3G1zB3n2a3H1j2B1H1G2B1h1g-h2j_b0jQ1wG-m2a3G1zB3n2a3/s1600/avatar.png'}')">
                                <img src="${user.profilePictureBase64 || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-D-aJ8x_Wu0k_4yL-h2Jb0jQ1wG-m2a3G1zB3n2a3H1j2B1H1G2B1h1g-h2j_b0jQ1wG-m2a3G1zB3n2a3/s1600/avatar.png'}" alt="Profile" style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                        </div>
                        <div class="card-info-grid">
                            <div class="info-item">
                                <span class="info-label">Terdaftar</span>
                                <span class="info-value"><span>${joinedDate}</span></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Saldo / Sisa Aktif</span>
                                <span class="info-value"><span>${saldoOrMasaAktifHTML}</span></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">WhatsApp</span>
                                <span class="info-value"><span>${user.whatsapp || 'N/A'}</span></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Device ID</span>
                                <span class="info-value">
                                    <span>${user.device_id || 'N/A'}</span>
                                    <button class="copy-btn" data-text="${user.device_id || ''}" title="Copy ID"><i class="far fa-copy"></i></button>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Password</span>
                                <span class="info-value"><span></span></span>
                            </div>
                            <div class="info-item card-ban-toggle">
                                <span class="info-label">Status Akun (Normal / Banned)</span>
                                <div class="toggle-switch ban-toggle-switch">
                                    <input type="checkbox" id="ban-toggle-${user.id}" class="ban-toggle-input" data-doc-id="${user.id}" ${isBanned ? 'checked' : ''}>
                                    <label for="ban-toggle-${user.id}"></label>
                                    <span id="ban-status-text-${user.id}">${isBanned ? 'Banned' : 'Normal'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="action-button btn-primary edit-user-btn" data-doc-id="${user.id}"><i class="fas fa-edit"></i> Edit</button>
                                                        <button class="action-button btn-start-chat" data-action="start-chat" data-username="${user.username}"><i class="fas fa-comment-dots"></i> Chat</button>
                            <button class="action-button" style="background-color: #10b981;" onclick="handleSendWhatsApp('${user.whatsapp}')"><i class="fab fa-whatsapp"></i> WA</button>
<button class="action-button btn-danger delete-user-btn" data-doc-id="${user.id}" data-username="${user.username}"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    </div>
                `;
                dom.userCardContainer.innerHTML += cardHTML;
            });

            addCardButtonListeners();
            updatePaginationControls();
        };

        // --- TRANSACTION MANAGEMENT FUNCTIONS ---
            // --- MODIFIKASI: Unified Transaction Logic ---
    const fetchAndRenderTransactions = async () => {
        dom.transactionSpinner.style.display = 'flex';
        try {
            // 1. Ambil Transaksi Aktif (Pending) dari Users
            const usersQuery = await getDocs(collection(db, "users"));
            // FIX: Update variabel global allUsers agar tombol aksi bisa menemukan data user
            allUsers = usersQuery.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const activeItems = [];
                        usersQuery.forEach(doc => {
                const u = { id: doc.id, ...doc.data() };
                // PERBAIKAN KRUSIAL: Prioritaskan transactionTimestamp. Jika tidak ada (transaksi lama/error), gunakan waktu sekarang (agar transaksi baru tidak dianggap Expired).
                const timestamp = u.transactionTimestamp || Timestamp.now();
                
                if (u.pendingTransaction > 0) activeItems.push({...u, type: 'Top Up Saldo', amount: u.pendingTransaction, status: 'Pending', timestamp: timestamp, docId: doc.id});
                else if (u.pendingSubscription) activeItems.push({...u, type: u.pendingSubscription.type, amount: u.pendingSubscription.uniqueAmount, status: 'Pending', timestamp: timestamp, docId: doc.id});
                else if (u.pendingAkunPurchase) activeItems.push({...u, type: 'Beli Akun', amount: u.pendingAkunPurchase.uniqueAmount, status: 'Pending', timestamp: timestamp, docId: doc.id});
                else if (u.akunJualStatus && u.akunJualStatus.status === 'Di Proses') activeItems.push({...u, type: 'Jual Akun', amount: 0, status: 'Pending', timestamp: timestamp, docId: doc.id});
            });

            // 2. Ambil Riwayat (Sukses/Gagal/Cancel) - Limit 10
            const historyItems = [];
            // Mengambil 10 riwayat transaksi terbaru dari semua koleksi riwayat
            const topupHist = await getDocs(query(collection(db, "topup_history"), orderBy("timestamp", "desc"), limit(10)));
            const purchHist = await getDocs(query(collection(db, "purchase_history"), orderBy("timestamp", "desc"), limit(10)));
            
            topupHist.forEach(d => historyItems.push({ ...d.data(), id: d.id, type: 'Top Up Saldo', status: d.data().status, isHistory: true, timestamp: d.data().timestamp, docId: d.id }));
            purchHist.forEach(d => historyItems.push({ ...d.data(), id: d.id, type: d.data().game || 'Pembelian', amount: d.data().rpCost, status: d.data().status, isHistory: true, timestamp: d.data().timestamp, docId: d.id }));

                        // 3. Gabung dengan Prioritas: Pending DULUAN, baru History
            // Urutkan activeItems berdasarkan timestamp terbaru
            activeItems.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            
            // Urutkan historyItems berdasarkan timestamp terbaru
            historyItems.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            // Gabungkan: Semua Active Items + History (sampai total 20 item agar tidak terlalu panjang)
            const allTransactions = [...activeItems, ...historyItems].slice(0, 20);

            renderTransactionCards(allTransactions);
        } catch (error) {
            console.error("Error fetching transactions:", error);
            showToast('Gagal memuat data transaksi.', 'error');
        } finally {
            dom.transactionSpinner.style.display = 'none';
        }
    };

    const renderTransactionCards = (transactions) => {
        dom.pendingTransactionContainer.innerHTML = '';
        if (!transactions || transactions.length === 0) {
            dom.pendingTransactionContainer.innerHTML = '<p style="text-align:center; grid-column: 1 / -1;">Tidak ada riwayat transaksi terbaru.</p>';
            return;
        }
        
        dom.pendingTransactionContainer.innerHTML += `<h2 class="section-heading">Riwayat & Pending Transaction (10 Terbaru)</h2>`;
        
        transactions.forEach(item => {
            const cardHTML = createTransactionCardHTML(item);
            dom.pendingTransactionContainer.innerHTML += cardHTML;
        });

        addTransactionCardButtonListeners();
    };

        
            // --- FITUR KIRIM INVOICE ---
    window.handleSendInvoice = (username, phone, amount, type) => {
        if (!phone || phone === 'undefined') { showToast('Nomor WhatsApp tidak tersedia.', 'error'); return; }
        
        // Format nomor HP (08xx -> 628xx)
        let cleanPhone = phone.toString().replace(/[^0-9]/g, '');
        if (cleanPhone.startsWith('0')) cleanPhone = '62' + cleanPhone.slice(1);
        
        // Format Rupiah
        const formattedAmount = amount.toLocaleString('id-ID');
        
        // Pesan Invoice
        const message = `Halo Kak *${username}*,\n\nBerikut adalah invoice untuk transaksi pending Anda:\n\nJenis: *${type}*\nTotal Tagihan: *Rp ${formattedAmount}*\n\nMohon segera diselesaikan pembayarannya ya kak agar bisa segera diproses. Terima kasih!`;
        
        const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    };

    const getInvoiceBtnHTML = (user) => {
        let amount = 0;
        let type = '';
        
        // Cek jenis transaksi pending
        if (user.pendingTransaction > 0) {
            amount = user.pendingTransaction;
            type = 'Top Up Saldo';
        } else if (user.pendingSubscription) {
            amount = user.pendingSubscription.uniqueAmount || user.pendingSubscription.amount;
            type = user.pendingSubscription.type;
        } else if (user.pendingAkunPurchase) {
            amount = user.pendingAkunPurchase.uniqueAmount;
            type = `Beli Akun (${user.pendingAkunPurchase.usernameTampilan || 'Paket'})`;
        } else {
            return ''; // Tidak ada transaksi yang butuh invoice
        }

        return `<button class="action-button" style="background-color: #0ea5e9; flex-basis: 100%; margin-top: 8px; justify-content: center;" onclick="handleSendInvoice('${user.username}', '${user.whatsapp}', ${amount}, '${type}')"><i class="fab fa-whatsapp"></i> Kirim Invoice</button>`;
    };

            window.handleSendWhatsApp = (phone) => {
        if (!phone || phone === 'undefined') { showToast('Nomor WhatsApp tidak tersedia.', 'error'); return; }
        
        let cleanPhone = phone.toString().replace(/[^0-9]/g, '');
        if (cleanPhone.startsWith('0')) cleanPhone = '62' + cleanPhone.slice(1);
        
        const url = `https://wa.me/${cleanPhone}`;
        window.open(url, '_blank');
    };

    const getManualWaBtnHTML = (user) => {
        if (user.pendingTransaction > 0 || user.pendingSubscription || user.pendingAkunPurchase) {
             return `<button class="action-button" style="background-color: #10b981; flex-basis: 100%; margin-top: 5px; justify-content: center;" onclick="handleSendWhatsApp('${user.whatsapp}')"><i class="fab fa-whatsapp"></i> Kirim pesan WhatsApp</button>`;
        }
        return '';
    };



    const createTransactionCardHTML = (user) => {
        // Hitung status Expired (misal batas 24 jam)
        const now = new Date();
        // Jika isHistory true, gunakan timestamp yang sudah ada. Jika tidak, gunakan createdAt/lastLogin
        const txTime = user.timestamp ? new Date(user.timestamp.seconds * 1000) : new Date(user.createdAt?.seconds * 1000 || user.lastLogin?.seconds * 1000 || Date.now());
        const diffHours = (now - txTime) / 36e5;
        
        let statusLabel = user.status;
        let ribbonColor = '#10b981'; // Default Green for Success
        let borderColor = 'var(--success-primary)';

        if (user.status === 'Pending') {
            if (diffHours > 24) {
                statusLabel = 'Expired';
                ribbonColor = '#ef4444'; // Red
                borderColor = 'var(--danger-primary)';
            } else {
                statusLabel = 'Aktif';
                ribbonColor = '#f59e0b'; // Orange
                borderColor = 'var(--warning-primary)';
            }
        } else if (user.status?.toLowerCase().includes('cancel')) {
             statusLabel = user.status; 
             ribbonColor = '#ef4444';
             borderColor = 'var(--danger-primary)';
        } else if (user.status?.toLowerCase().includes('success')) {
             statusLabel = 'Transaksi Success';
             ribbonColor = '#10b981';
             borderColor = 'var(--success-primary)';
        }
        
        // Ambil nilai amount yang benar
        const displayAmount = user.amount || user.pendingTransaction || user.pendingSubscription?.uniqueAmount || user.pendingAkunPurchase?.uniqueAmount || 0;

        const ribbonHTML = `<div style="position:absolute; top:0; right:0; background:${ribbonColor}; color:white; padding:4px 10px; font-size:0.7em; font-weight:bold; border-bottom-left-radius:10px; z-index:2;">${statusLabel}</div>`;

        // Tombol aksi hanya muncul jika status masih Pending dan Aktif
        let actionButtons = '';
        if (user.status === 'Pending' && diffHours <= 24) {
             // Gunakan logika tombol yang sudah ada
             let mainActions = '';
            if (user.type === 'Top Up Saldo') {
                mainActions = `<button class="action-button btn-success" data-action="accept-topup" data-doc-id="${user.docId}">Accept</button><button class="action-button btn-danger" data-action="reject-topup" data-doc-id="${user.docId}">Reject</button>`;
            } else if (user.type === 'Beli Akun') {
                mainActions = `<button class="action-button btn-success" data-action="accept-purchase" data-doc-id="${user.docId}">Accept</button><button class="action-button btn-danger" data-action="reject-purchase" data-doc-id="${user.docId}">Reject</button>`;
            } else if (user.type === 'Jual Akun') {
                 mainActions = `<button class="action-button btn-success" data-action="accept-sale" data-doc-id="${user.docId}">Terima</button><button class="action-button btn-danger" data-action="reject-sale" data-doc-id="${user.docId}">Tolak</button>`;
            } else {
                 mainActions = `<button class="action-button btn-success" data-action="accept-sub" data-doc-id="${user.docId}">Accept</button><button class="action-button btn-danger" data-action="reject-sub" data-doc-id="${user.docId}">Reject</button>`;
            }
            
            actionButtons = `
                ${mainActions}
                ${getInvoiceBtnHTML(user)}
                ${getManualWaBtnHTML(user)}
            `;
        } else {
             actionButtons = `<div style="width:100%; text-align:center; color:var(--text-secondary); font-size:0.8em; margin-top:10px;">Riwayat Transaksi (No Actions)</div>`;
        }

        return `
            <div class="transaction-card" style="border-left: 4px solid ${borderColor}; position:relative; overflow:hidden;">
                ${ribbonHTML}
                <div class="card-header"><div class="user-title"><h3>${user.username || user.userId || 'N/A'}</h3><span class="status-badge status-user">${user.accountType || 'USER'}</span></div></div>
                <div class="card-info-grid"><div class="info-item"><span class="info-label">Email/WA</span><span class="info-value"><span>${user.whatsapp || user.email || 'N/A'}</span></span></div><div class="info-item"><span class="info-label">Nominal</span><span class="info-value">Rp ${displayAmount.toLocaleString('id-ID')}</span></div></div>
                <div class="transaction-details-section">
                    <h4>${user.type}</h4>
                    <p class="transaction-amount">${user.status}</p>
                </div>
                <div class="card-actions" style="flex-wrap: wrap;">${actionButtons}</div>
            </div>`;
    };

        const updatePaginationControls = () => {
            const totalPages = Math.ceil(displayedUsers.length / rowsPerPage);
            const startRecord = displayedUsers.length > 0 ? (currentPage - 1) * rowsPerPage + 1 : 0;
            const endRecord = Math.min(currentPage * rowsPerPage, displayedUsers.length);
            document.getElementById('page-info').textContent = `Showing ${startRecord}-${endRecord} of ${displayedUsers.length}`;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages || totalPages === 0;
        };
        
        const updateMainMenuStats = async () => {
            try {
                // Fetch user count
                const usersQuerySnapshot = await getDocs(collection(db, "users"));
                document.getElementById('stat-total-users').textContent = usersQuerySnapshot.size.toLocaleString('id-ID');

                // Fetch total spent
                const purchaseHistorySnapshot = await getDocs(collection(db, "purchase_history"));
                const totalSpent = purchaseHistorySnapshot.docs.reduce((sum, doc) => sum + (doc.data().rpCost || 0), 0);
                document.getElementById('stat-total-spent').textContent = `Rp ${totalSpent.toLocaleString('id-ID')}`;

            } catch (error) {
                console.error("Error updating main menu stats:", error);
            }
        };

        const openEditUserModal = (docId) => {
            const user = allUsers.find(u => u.id === docId);
            if (user) {
                document.getElementById('edit-doc-id').value = docId;
                document.getElementById('edit-username').value = user.username || '';
                document.getElementById('edit-accountType').value = user.accountType || 'USER';
                document.getElementById('edit-saldo').value = user.saldo || 0;
                document.getElementById('edit-akunGratisQuota').value = user.akunGratisQuota || 0; 
                document.getElementById('edit-whatsapp').value = user.whatsapp || '';
                document.getElementById('edit-password').value = user.password || '';

                const subscriptionFields = document.getElementById('subscription-fields');
                const saldoField = document.getElementById('edit-saldo').closest('.input-group');
                if (user.accountType === 'Langganan') {
                    subscriptionFields.style.display = 'block';
                    saldoField.style.display = 'none'; 
                    document.getElementById('edit-masaAktifHingga').value = user.masaAktifHingga || '';
                } else {
                    subscriptionFields.style.display = 'none';
                    saldoField.style.display = 'block';
                }
                
                dom.editUserModal.style.display = 'flex';
            }
        };
        
        const handleSaveChanges = async (event) => {
            event.preventDefault();
            const docId = document.getElementById('edit-doc-id').value;
            if (!docId) return;
            const updatedData = {
                username: document.getElementById('edit-username').value,
                accountType: document.getElementById('edit-accountType').value,
                saldo: Number(document.getElementById('edit-saldo').value),
                akunGratisQuota: Number(document.getElementById('edit-akunGratisQuota').value), 
                whatsapp: document.getElementById('edit-whatsapp').value,
                password: document.getElementById('edit-password').value,
            };

            if (updatedData.accountType === 'Langganan') {
                updatedData.masaAktifHingga = document.getElementById('edit-masaAktifHingga').value;
                updatedData.saldo = 0; 
            } else {
                updatedData.masaAktifHingga = deleteField();
            }

            try {
                await updateDoc(doc(db, "users", docId), updatedData);
                showToast('User updated successfully!', 'success');
                dom.editUserModal.style.display = 'none';
                await fetchUsers();
            } catch (error) { showToast('Failed to update user.', 'error'); }
        };

        const handleSaveNewUser = async (event) => {
            event.preventDefault();
            const newData = { 
                username: document.getElementById('add-username').value, 
                saldo: Number(document.getElementById('add-saldo').value), 
                pendingTransaction: Number(document.getElementById('add-pendingTransaction').value), 
                whatsapp: document.getElementById('add-whatsapp').value, 
                device_id: '',
                password: document.getElementById('add-password').value, 
                accountType: 'USER',
                createdAt: serverTimestamp(),
                isBanned: false
            };
            try {
                await addDoc(collection(db, "users"), newData);
                showToast('User added successfully!', 'success');
                dom.addUserModal.style.display = 'none';
                document.getElementById('add-user-form').reset();
                await fetchUsers();
            } catch (error) { showToast('Failed to add user.', 'error'); }
        };
        
        const handleAcceptTransaction = (docId, isFromFloating = false) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingTransaction || user.pendingTransaction <= 0) return;
            
            const confirmAction = async () => {
                const updatedUserData = {
                    saldo: (user.saldo || 0) + user.pendingTransaction,
                    pendingTransaction: 0
                };
                const topupHistoryData = {
                    userId: docId,
                    username: user.username,
                    amount: user.pendingTransaction,
                    status: "Success",
                    timestamp: serverTimestamp()
                };
                try {
                    await updateDoc(doc(db, "users", docId), updatedUserData);
                    await addDoc(collection(db, "topup_history"), topupHistoryData);
                    showToast('Transaction accepted!', 'success');
                    if (isFromFloating) {
                        dom.floatingTransactionModal.style.display = 'none';
                        isFloatingModalShown = false; 
                    }
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Failed to accept transaction.', 'error');
                }
            };
            
            showConfirmation(
                `Tambahkan Rp ${user.pendingTransaction.toLocaleString('id-ID')} ke saldo ${user.username}?`,
                'Terima Top-up',
                'btn-success',
                confirmAction
            );
        };
        
                const handleRejectTransaction = (docId, isFromFloating = false) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user) return;
            
            const confirmAction = async () => {
                try {
                    // Simpan Riwayat Cancel ke Topup History sebelum dihapus
                    const historyData = {
                        userId: docId,
                        username: user.username,
                        amount: user.pendingTransaction || 0,
                        status: "Cancel with Admin", // Status baru
                        timestamp: serverTimestamp()
                    };
                    await addDoc(collection(db, "topup_history"), historyData);

                    await updateDoc(doc(db, "users", docId), { pendingTransaction: 0 });
                    showToast('Pending top-up rejected and logged.', 'success');
                    if (isFromFloating) {
                        dom.floatingTransactionModal.style.display = 'none';
                        isFloatingModalShown = false;
                    }
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Failed to reject transaction.', 'error');
                }
            };
            
            showConfirmation(
                `Tolak permintaan top-up untuk ${user.username}?`,
                'Tolak Top-up',
                'btn-danger',
                confirmAction
            );
        };

        const handleAcceptSubscription = (docId, isFromFloating = false) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingSubscription) return;
            
            const confirmAction = async () => {
                const subData = user.pendingSubscription;
                const updatedUserData = {
                    accountType: subData.type,
                    pendingSubscription: deleteField()
                };

                if (subData.type === 'Langganan') {
                    const currentEndDate = user.masaAktifHingga ? new Date(user.masaAktifHingga) : new Date();
                    const startDate = currentEndDate > new Date() ? currentEndDate : new Date();
                    startDate.setDate(startDate.getDate() + 30);
                    updatedUserData.masaAktifHingga = startDate.toISOString().split('T')[0];
                } else {
                    updatedUserData.masaAktifHingga = deleteField();
                }

                const historyData = {
                    userId: docId, username: user.username, type: 'Subscription',
                    package: subData.type, amount: subData.uniqueAmount || subData.amount,
                    status: "Success", timestamp: serverTimestamp()
                };

                try {
                    await updateDoc(doc(db, "users", docId), updatedUserData);
                    await addDoc(collection(db, "purchase_history"), historyData);
                    showToast('Subscription activated!', 'success');
                    if(isFromFloating){
                        dom.floatingTransactionModal.style.display = 'none';
                        isFloatingModalShown = false;
                    }
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Failed to activate subscription.', 'error');
                }
            };

            showConfirmation(
                `Aktifkan ${user.pendingSubscription.type} untuk ${user.username}?`,
                'Terima Langganan',
                'btn-success',
                confirmAction
            );
        };

        const handleRejectSubscription = (docId, isFromFloating = false) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingSubscription) return;

            const confirmAction = async () => {
                try {
                    await updateDoc(doc(db, "users", docId), { pendingSubscription: deleteField() });
                    showToast('Subscription request rejected.', 'success');
                     if(isFromFloating){
                        dom.floatingTransactionModal.style.display = 'none';
                        isFloatingModalShown = false;
                    }
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Failed to reject subscription.', 'error');
                }
            };

            showConfirmation(
                `Tolak permintaan ${user.pendingSubscription.type} untuk ${user.username}?`,
                'Tolak Langganan',
                'btn-danger',
                confirmAction
            );
        };
        
        // --- NEW FUNCTIONS FOR ACCOUNT PURCHASE ---
        const handleAcceptAkunPurchase = (docId) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingAkunPurchase) return;
            const purchaseData = user.pendingAkunPurchase;

            const confirmAction = async () => {
                showToast('Memproses pembelian akun... Mohon tunggu.', 'success');
                const userRef = doc(db, "users", docId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const offeringDocRef = doc(db, "stokAkun", purchaseData.offeringId);
                        const offeringDoc = await transaction.get(offeringDocRef);
                        if (!offeringDoc.exists() || offeringDoc.data().ownedBy) {
                            throw new Error("Penawaran akun ini sudah tidak tersedia.");
                        }

                        const kredensialQuery = query(collection(db, "stokKredensial"), where("gameType", "==", offeringDoc.data().gameType), where("ownedBy", "==", null), limit(1));
                        const kredensialSnapshot = await getDocs(kredensialQuery); // Use getDocs, not transaction.get for queries
                        if (kredensialSnapshot.empty) {
                            throw new Error("Stok kredensial untuk game ini habis. Hubungi developer.");
                        }
                        const kredensialDoc = kredensialSnapshot.docs[0];
                        const kredensialDocRef = kredensialDoc.ref;
                        
                        transaction.update(kredensialDocRef, { 
                            ownedBy: user.username, 
                            usernameTampilan: purchaseData.newUsername, 
                            jumlahUB: offeringDoc.data().jumlahUB,
                            gameType: offeringDoc.data().gameType 
                        });

                        const purchaseHistoryRef = doc(collection(db, "purchase_history"));
                        transaction.set(purchaseHistoryRef, { 
                            userId: docId, 
                            username: user.username, 
                            game: offeringDoc.data().gameType, 
                            rpCost: purchaseData.uniqueAmount, 
                            ubAmount: `Akun: ${purchaseData.usernameTampilan}`, 
                            status: "Success (QRIS)", 
                            timestamp: serverTimestamp() 
                        });

                        transaction.update(userRef, { 
                            pendingAkunPurchase: deleteField() 
                        });
                    });

                    showToast('Pembelian akun berhasil dikonfirmasi!', 'success');
                } catch (error) {
                    console.error("Gagal mengkonfirmasi pembelian akun:", error);
                    showToast(`Error: ${error.message}`, 'error');
                    // We don't revert here because the transaction already failed and rolled back.
                } finally {
                    await fetchAndRenderTransactions();
                }
            };

            showConfirmation(
                `Konfirmasi pembelian paket "${purchaseData.usernameTampilan}" oleh ${user.username}?`,
                'Terima Pembelian Akun',
                'btn-success',
                confirmAction
            );
        };

        const handleRejectAkunPurchase = (docId) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.pendingAkunPurchase) return;

            const confirmAction = async () => {
                try {
                    await updateDoc(doc(db, "users", docId), { pendingAkunPurchase: deleteField() });
                    showToast('Permintaan pembelian akun ditolak.', 'success');
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Gagal menolak permintaan.', 'error');
                }
            };
            
            showConfirmation(
                `Tolak permintaan pembelian akun dari ${user.username}?`,
                'Tolak Pembelian Akun',
                'btn-danger',
                confirmAction
            );
        };
        // --- END OF NEW FUNCTIONS ---

        const handleAcceptAccountSale = (docId, isFromFloating = false) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.akunJualStatus) return;

            const confirmAction = async () => {
                try {
                    await updateDoc(doc(db, "users", docId), {
                        'akunJualStatus.status': 'Selesai(Terbayar Admin)'
                    });
                    showToast(`Penjualan akun dari ${user.username} telah diterima.`, 'success');
                    if(isFromFloating){
                        dom.floatingTransactionModal.style.display = 'none';
                        isFloatingModalShown = false;
                    }
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Gagal menerima penjualan akun.', 'error');
                }
            };

            showConfirmation(
                `Konfirmasi pembayaran dan selesaikan transaksi penjualan akun dari ${user.username}?`,
                'Terima Penjualan Akun',
                'btn-success',
                confirmAction
            );
        };

        const handleRejectAccountSale = (docId, isFromFloating = false) => {
            const user = allUsers.find(u => u.id === docId);
            if (!user || !user.akunJualStatus) return;

            const confirmAction = async () => {
                try {
                    await updateDoc(doc(db, "users", docId), {
                        akunJualStatus: deleteField()
                    });
                    showToast(`Penjualan akun dari ${user.username} telah ditolak.`, 'success');
                    if(isFromFloating){
                        dom.floatingTransactionModal.style.display = 'none';
                        isFloatingModalShown = false;
                    }
                    await fetchAndRenderTransactions();
                } catch (error) {
                    showToast('Gagal menolak penjualan akun.', 'error');
                }
            };

            showConfirmation(
                `Yakin ingin menolak permintaan penjualan akun dari ${user.username}?`,
                'Tolak Penjualan Akun',
                'btn-danger',
                confirmAction
            );
        };


        const handleDeleteUser = (docId, username) => {
            const confirmAction = async () => {
                try {
                    await deleteDoc(doc(db, "users", docId));
                    showToast('User deleted successfully.', 'success');
                    await fetchUsers();
                } catch (error) { showToast('Failed to delete user.', 'error'); } 
            };
            showConfirmation(`Yakin ingin menghapus user: ${username}?`, 'Hapus User', 'btn-danger', confirmAction);
        };
        
        const togglePasswordVisibility = (e) => {
            const input = e.currentTarget.closest('.password-wrapper').querySelector('input');
            const icon = e.currentTarget.querySelector('i');
            if (input.type === 'password') { input.type = 'text'; icon.classList.replace('fa-eye', 'fa-eye-slash'); } 
            else { input.type = 'password'; icon.classList.replace('fa-eye-slash', 'fa-eye'); }
        };
        
        // --- STOK AKUN (OFFERING) MANAGEMENT ---
        const fetchStokAkun = async () => {
            dom.stokAkunSpinner.style.display = 'flex';
            try {
                const q = query(collection(db, "stokAkun"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                allStokAkun = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStokAkunCards('all'); // Show all by default
            } catch (error) {
                console.error("Error fetching stok akun:", error);
                showToast('Gagal mengambil data penawaran.', 'error');
            } finally {
                dom.stokAkunSpinner.style.display = 'none';
            }
        };
        
        const renderStokAkunCards = (filter = 'all') => {
            dom.stokAkunCardContainer.innerHTML = '';
            
            const filteredData = allStokAkun.filter(akun => {
                if (filter === 'available') return !akun.ownedBy;
                if (filter === 'sold') return !!akun.ownedBy;
                return true; // 'all'
            });

            if (filteredData.length === 0) {
                dom.stokAkunCardContainer.innerHTML = `<p style="text-align:center; grid-column: 1 / -1;">Tidak ada data untuk filter "${filter}".</p>`;
                return;
            }
            filteredData.forEach(akun => {
                let claimedByHTML = '';
                if (akun.ownedBy) {
                    claimedByHTML = `<div class="info-item" style="grid-column: 1 / -1;"><span class="info-label">Terjual Kepada</span><span class="info-value owner"><span>${akun.ownedBy}</span><button class="action-button reset-owner-btn" data-doc-id="${akun.id}" data-type="stokAkun" title="Batalkan status terjual"><i class="fas fa-times"></i> Batal</button></span></div>`;
                }
                const headerClass = akun.ownedBy ? 'stok-header-sold' : 'stok-header-available';

                const cardHTML = `
                <div class="stok-akun-card">
                    <div class="card-header ${headerClass}"><div class="user-title"><h3>${akun.usernameTampilan || 'Tanpa Nama'}</h3></div></div>
                    <div class="card-info-grid">
                        <div class="info-item"><span class="info-label">Game</span><span class="info-value"><span>${akun.gameType}</span></span></div>
                        <div class="info-item"><span class="info-label">Jenis Login</span><span class="info-value"><span>${akun.loginType}</span></span></div>
                        <div class="info-item"><span class="info-label">Jumlah UB</span><span class="info-value"><span>${(akun.jumlahUB || 0).toLocaleString('id-ID')}</span></span></div>
                        <div class="info-item"><span class="info-label">Harga</span><span class="info-value" style="color: var(--success-primary);"><span>${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(akun.price || 0)}</span></span></div>
                        <div class="info-item"><span class="info-label">Stok</span><span class="info-value"><span>${akun.stok || 0}</span></span></div>
                        <div class="info-item"><span class="info-label">Terjual</span><span class="info-value"><span>${akun.terjual || 0}</span></span></div>
                        <div class="info-item"><span class="info-label">Rating</span><span class="info-value"><span>${akun.rating || 0} / 5</span></span></div>
                        ${claimedByHTML}
                    </div>
                    <div class="card-actions">
                        <button class="action-button btn-primary edit-stok-akun-btn" data-doc-id="${akun.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="action-button btn-danger delete-stok-akun-btn" data-doc-id="${akun.id}" data-username="${akun.usernameTampilan}"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>`;
                dom.stokAkunCardContainer.innerHTML += cardHTML;
            });
            addStokAkunCardButtonListeners();
        };

        const openEditStokAkunModal = (akunId) => {
            const akun = allStokAkun.find(a => a.id === akunId);
            if (akun) {
                document.getElementById('edit-stok-akun-id').value = akunId;
                document.getElementById('edit-stok-akun-usernameTampilan').value = akun.usernameTampilan || '';
                document.getElementById('edit-stok-akun-gameType').value = akun.gameType;
                document.getElementById('edit-stok-akun-loginType').value = akun.loginType;
                document.getElementById('edit-stok-akun-jumlahUB').value = akun.jumlahUB || 0;
                document.getElementById('edit-stok-akun-price').value = akun.price || 0;
                document.getElementById('edit-stok-akun-detailInfo').value = akun.detailInfo || '';
                document.getElementById('edit-stok-akun-stok').value = akun.stok || 0;
                document.getElementById('edit-stok-akun-terjual').value = akun.terjual || 0;
                document.getElementById('edit-stok-akun-rating').value = akun.rating || 0;
                dom.editStokAkunModal.style.display = 'flex';
            }
        };

        const handleUpdateStokAkun = async (event) => {
            event.preventDefault();
            const akunId = document.getElementById('edit-stok-akun-id').value;
            const updatedData = {
                usernameTampilan: document.getElementById('edit-stok-akun-usernameTampilan').value,
                gameType: document.getElementById('edit-stok-akun-gameType').value,
                loginType: document.getElementById('edit-stok-akun-loginType').value,
                jumlahUB: Number(document.getElementById('edit-stok-akun-jumlahUB').value),
                price: Number(document.getElementById('edit-stok-akun-price').value),
                detailInfo: document.getElementById('edit-stok-akun-detailInfo').value,
                stok: Number(document.getElementById('edit-stok-akun-stok').value),
                terjual: Number(document.getElementById('edit-stok-akun-terjual').value),
                rating: Number(document.getElementById('edit-stok-akun-rating').value)
            };
            try {
                await updateDoc(doc(db, "stokAkun", akunId), updatedData);
                showToast('Penawaran berhasil diperbarui!', 'success');
                dom.editStokAkunModal.style.display = 'none';
                await fetchStokAkun();
            } catch (error) { showToast('Gagal memperbarui penawaran.', 'error'); }
        };
        
        const handleSaveNewStokAkun = async (event) => {
            event.preventDefault();
            const newData = {
                usernameTampilan: document.getElementById('add-stok-akun-usernameTampilan').value,
                gameType: document.getElementById('add-stok-akun-gameType').value,
                loginType: document.getElementById('add-stok-akun-loginType').value,
                jumlahUB: Number(document.getElementById('add-stok-akun-jumlahUB').value),
                price: Number(document.getElementById('add-stok-akun-price').value),
                detailInfo: document.getElementById('add-stok-akun-detailInfo').value,
                stok: Number(document.getElementById('add-stok-akun-stok').value),
                terjual: Number(document.getElementById('add-stok-akun-terjual').value),
                rating: Number(document.getElementById('add-stok-akun-rating').value),
                createdAt: serverTimestamp(),
                ownedBy: null
            };
            try {
                await addDoc(collection(db, "stokAkun"), newData);
                showToast('Penawaran berhasil ditambahkan!', 'success');
                dom.addStokAkunModal.style.display = 'none';
                document.getElementById('add-stok-akun-form').reset();
                await fetchStokAkun();
            } catch (error) { showToast('Gagal menambah penawaran.', 'error'); }
        };
        
        const handleDeleteStokAkun = (akunId, username) => {
            const confirmAction = async () => {
                try {
                    await deleteDoc(doc(db, "stokAkun", akunId));
                    showToast('Penawaran berhasil dihapus.', 'success');
                    await fetchStokAkun();
                } catch (error) { showToast('Gagal menghapus penawaran.', 'error'); }
            };
            showConfirmation(`Yakin ingin menghapus penawaran: ${username}?`, 'Hapus Penawaran', 'btn-danger', confirmAction);
        };

        // --- STOK KREDENSIAL MANAGEMENT ---
        const fetchStokKredensial = async () => {
            dom.stokKredensialSpinner.style.display = 'flex';
            try {
                const q = query(collection(db, "stokKredensial"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                allStokKredensial = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStokKredensialCards('available');
            } catch (error) {
                console.error("Error fetching stok kredensial:", error);
                showToast('Gagal mengambil data kredensial.', 'error');
            } finally {
                dom.stokKredensialSpinner.style.display = 'none';
            }
        };

        const renderStokKredensialCards = (filter = 'all') => {
            dom.stokKredensialCardContainer.innerHTML = '';
             const filteredData = allStokKredensial.filter(akun => {
                if (filter === 'available') return !akun.ownedBy;
                if (filter === 'used') return !!akun.ownedBy;
                return true; // 'all'
            });

            if (filteredData.length === 0) {
                dom.stokKredensialCardContainer.innerHTML = `<p style="text-align:center; grid-column: 1 / -1;">Tidak ada data untuk filter "${filter}".</p>`;
                return;
            }
            filteredData.forEach(akun => {
                let claimedByHTML = '';
                if (akun.ownedBy) {
                    claimedByHTML = `<div class="info-item" style="grid-column: 1 / -1;"><span class="info-label">Terpakai Oleh</span><span class="info-value owner"><span>${akun.ownedBy}</span><button class="action-button reset-owner-btn" data-doc-id="${akun.id}" data-type="stokKredensial" title="Batalkan status terpakai"><i class="fas fa-times"></i> Batal</button></span></div>`;
                }
                const headerClass = akun.ownedBy ? 'stok-header-sold' : 'stok-header-available';

                const cardHTML = `
                <div class="stok-kredensial-card">
                    <div class="card-header ${headerClass}"><div class="user-title"><h3>${akun.gameType} - ${akun.loginType}</h3></div></div>
                    <div class="card-info-grid">
                        <div class="info-item" style="grid-column: 1 / -1;"><span class="info-label">Email / No.HP</span><span class="info-value"><span>${akun.email}</span></span></div>
                        <div class="info-item" style="grid-column: 1 / -1;"><span class="info-label">Device ID</span><span class="info-value"><span>${akun.deviceId}</span></span></div>
                        ${claimedByHTML}
                    </div>
                    <div class="card-actions">
                        <button class="action-button btn-primary edit-stok-kredensial-btn" data-doc-id="${akun.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="action-button btn-danger delete-stok-kredensial-btn" data-doc-id="${akun.id}" data-email="${akun.email}"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>`;
                dom.stokKredensialCardContainer.innerHTML += cardHTML;
            });
            addStokKredensialCardButtonListeners();
        };
        
        const openEditStokKredensialModal = (akunId) => {
            const akun = allStokKredensial.find(a => a.id === akunId);
            if(akun) {
                document.getElementById('edit-stok-kredensial-id').value = akunId;
                document.getElementById('edit-stok-kredensial-gameType').value = akun.gameType;
                document.getElementById('edit-stok-kredensial-loginType').value = akun.loginType;
                document.getElementById('edit-stok-kredensial-email').value = akun.email;
                document.getElementById('edit-stok-kredensial-password').value = akun.password;
                document.getElementById('edit-stok-kredensial-deviceId').value = akun.deviceId;
                dom.editStokKredensialModal.style.display = 'flex';
            }
        };

        const handleUpdateStokKredensial = async (event) => {
            event.preventDefault();
            const akunId = document.getElementById('edit-stok-kredensial-id').value;
            const updatedData = {
                gameType: document.getElementById('edit-stok-kredensial-gameType').value,
                loginType: document.getElementById('edit-stok-kredensial-loginType').value,
                email: document.getElementById('edit-stok-kredensial-email').value,
                password: document.getElementById('edit-stok-kredensial-password').value,
                deviceId: document.getElementById('edit-stok-kredensial-deviceId').value
            };
            try {
                await updateDoc(doc(db, "stokKredensial", akunId), updatedData);
                showToast('Kredensial berhasil diperbarui!', 'success');
                dom.editStokKredensialModal.style.display = 'none';
                await fetchStokKredensial();
            } catch (error) { showToast('Gagal memperbarui Kredensial.', 'error'); }
        };

        const handleSaveNewStokKredensial = async (event) => {
            event.preventDefault();
            const newData = {
                gameType: document.getElementById('add-stok-kredensial-gameType').value,
                loginType: document.getElementById('add-stok-kredensial-loginType').value,
                email: document.getElementById('add-stok-kredensial-email').value,
                password: document.getElementById('add-stok-kredensial-password').value,
                deviceId: document.getElementById('add-stok-kredensial-deviceId').value,
                createdAt: serverTimestamp(),
                ownedBy: null
            };
            try {
                await addDoc(collection(db, "stokKredensial"), newData);
                showToast('Kredensial berhasil ditambahkan!', 'success');
                dom.addStokKredensialModal.style.display = 'none';
                document.getElementById('add-stok-kredensial-form').reset();
                await fetchStokKredensial();
            } catch (error) { showToast('Gagal menambah Kredensial.', 'error'); }
        };

        const handleDeleteStokKredensial = (akunId, email) => {
            const confirmAction = async () => {
                try {
                    await deleteDoc(doc(db, "stokKredensial", akunId));
                    showToast('Kredensial berhasil dihapus.', 'success');
                    await fetchStokKredensial();
                } catch (error) { showToast('Gagal menghapus Kredensial.', 'error'); }
            };
            showConfirmation(`Yakin ingin menghapus kredensial ${email}?`, 'Hapus Kredensial', 'btn-danger', confirmAction);
        };
        
        const handleResetOwner = (akunId, type) => {
            const collectionName = type === 'stokAkun' ? 'stokAkun' : 'stokKredensial';
            const fetchFunction = type === 'stokAkun' ? fetchStokAkun : fetchStokKredensial;
            const confirmAction = async () => {
                try {
                    await updateDoc(doc(db, collectionName, akunId), { ownedBy: null });
                    showToast('Status berhasil direset.', 'success');
                    await fetchFunction();
                } catch (error) {
                    showToast('Gagal mereset status.', 'error');
                }
            };
            showConfirmation('Yakin ingin mengembalikan item ini ke stok?', 'Reset Status', 'btn-warning', confirmAction);
        };
        
        
        // --- STOK MOD MANAGEMENT ---
        let allStokMod = [];

        const fetchStokMod = async () => {
            dom.stokModSpinner.style.display = 'flex';
            try {
                const q = query(collection(db, "stokMod"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                allStokMod = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStokModCards();
            } catch (error) {
                console.error("Error fetching stok mod:", error);
                showToast('Gagal mengambil data MOD.', 'error');
            } finally {
                dom.stokModSpinner.style.display = 'none';
            }
        };

        const renderStokModCards = () => {
            dom.stokModCardContainer.innerHTML = '';
            if (allStokMod.length === 0) {
                dom.stokModCardContainer.innerHTML = `<p style="text-align:center; grid-column: 1 / -1; color: var(--text-secondary);">Belum ada produk MOD.</p>`;
                return;
            }

                        allStokMod.forEach(mod => {
                const imgList = (mod.images && mod.images.length > 0) ? mod.images : ['https://via.placeholder.com/300x200?text=No+Image'];
                const thumbnail = imgList[0];
                const imgJson = JSON.stringify(imgList).replace(/"/g, '&quot;');
                
                const cardHTML = `
                <div class="stok-akun-card" style="padding: 0; overflow: hidden;">
                    <div style="width: 100%; height: 150px; background-color: #000; position: relative;">
                        <img src="${thumbnail}" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="openAdminGallery(this)" data-images="${imgJson}">
                        <span style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">
                            <i class="fas fa-star" style="color: #fbbf24;"></i> ${mod.rating}
                        </span>
                    </div>
                    <div style="padding: 15px;">
                        <h3 style="margin: 0 0 10px 0; color: white; font-size: 1.1em;">${mod.name}</h3>
                        <div class="card-info-grid" style="gap: 8px; margin-bottom: 15px;">
                            <div class="info-item"><span class="info-label">Harga</span><span class="info-value" style="color: var(--success-primary);">Rp ${(mod.price||0).toLocaleString('id-ID')}</span></div>
                            <div class="info-item"><span class="info-label">Terjual</span><span class="info-value">${mod.sold || 0}</span></div>
                        </div>
                                                <div class="card-actions" style="border-top: 1px solid var(--border-color); padding-top: 10px;">
                            <button class="action-button btn-warning view-mod-buyers-btn" data-doc-id="${mod.id}" data-name="${mod.name}"><i class="fas fa-users"></i> Pembeli (${mod.sold || 0})</button>
                            <button class="action-button btn-primary edit-stok-mod-btn" data-doc-id="${mod.id}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="action-button btn-danger delete-stok-mod-btn" data-doc-id="${mod.id}" data-name="${mod.name}"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
                dom.stokModCardContainer.innerHTML += cardHTML;
            });
            addStokModCardButtonListeners();
        };

        const addStokModCardButtonListeners = () => {
            dom.stokModCardContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-stok-mod-btn');
                const deleteBtn = e.target.closest('.delete-stok-mod-btn');
                                if (editBtn) openEditStokModModal(editBtn.dataset.docId);
                if (deleteBtn) handleDeleteStokMod(deleteBtn.dataset.docId, deleteBtn.dataset.name);
                
                // Listener untuk tombol Pembeli
                const buyersBtn = e.target.closest('.view-mod-buyers-btn');
                if (buyersBtn) {
                    openModBuyersModal(buyersBtn.dataset.docId, buyersBtn.dataset.name);
                }
            });
        };

                const handleSaveNewStokMod = async (event) => {
            event.preventDefault();
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.innerHTML = 'Memproses...';

            try {
                const imageInput = document.getElementById('add-stok-mod-images');
                const processedImages = [];
                if (imageInput.files.length > 0) {
                    for (let i = 0; i < Math.min(imageInput.files.length, 5); i++) {
                        // Resize lebih agresif (500px, 0.6) agar muat di Firestore (max 1MB)
                        const base64 = await resizeAndCompressImage(imageInput.files[i], 1280, 0.9);
                        processedImages.push(base64);
                    }
                }

                const newData = {
                    name: document.getElementById('add-stok-mod-name').value,
                    price: Number(document.getElementById('add-stok-mod-price').value),
                    sold: Number(document.getElementById('add-stok-mod-sold').value),
                    rating: Number(document.getElementById('add-stok-mod-rating').value),
                    downloadLink: document.getElementById('add-stok-mod-link').value,
                    instruction: document.getElementById('add-stok-mod-instruction').value,
                    images: processedImages,
                    createdAt: serverTimestamp()
                };

                await addDoc(collection(db, "stokMod"), newData);
                showToast('Produk MOD berhasil ditambahkan!', 'success');
                dom.addStokModModal.style.display = 'none';
                document.getElementById('add-stok-mod-form').reset();
                fetchStokMod();
            } catch (e) {
                console.error("ADD MOD ERROR:", e);
                let msg = 'Gagal: ' + e.message;
                if(e.code === 'failed-precondition') msg = 'Index Firebase Belum Dibuat (Cek Console Browser)';
                else if(e.code === 'resource-exhausted') msg = 'Ukuran File Terlalu Besar (Kurangi Foto)';
                showToast(msg, 'error');
            } finally {
                submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Produk';
            }
        };

        const openEditStokModModal = (modId) => {
            const mod = allStokMod.find(m => m.id === modId);
            if (!mod) return;
            document.getElementById('edit-stok-mod-id').value = modId;
            document.getElementById('edit-stok-mod-name').value = mod.name;
            document.getElementById('edit-stok-mod-price').value = mod.price;
            document.getElementById('edit-stok-mod-sold').value = mod.sold;
            document.getElementById('edit-stok-mod-rating').value = mod.rating;
            document.getElementById('edit-stok-mod-link').value = mod.downloadLink;
            document.getElementById('edit-stok-mod-instruction').value = mod.instruction;
            document.getElementById('edit-stok-mod-images').value = ''; // Reset file input
            dom.editStokModModal.style.display = 'flex';
        };

                const handleUpdateStokMod = async (event) => {
            event.preventDefault();
            const modId = document.getElementById('edit-stok-mod-id').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.innerHTML = 'Memproses...';

            try {
                const updateData = {
                    name: document.getElementById('edit-stok-mod-name').value,
                    price: Number(document.getElementById('edit-stok-mod-price').value),
                    sold: Number(document.getElementById('edit-stok-mod-sold').value),
                    rating: Number(document.getElementById('edit-stok-mod-rating').value),
                    downloadLink: document.getElementById('edit-stok-mod-link').value,
                    instruction: document.getElementById('edit-stok-mod-instruction').value,
                };

                const imageInput = document.getElementById('edit-stok-mod-images');
                if (imageInput.files.length > 0) {
                    const processedImages = [];
                    for (let i = 0; i < Math.min(imageInput.files.length, 5); i++) {
                        // Resize agresif untuk update juga
                        const base64 = await resizeAndCompressImage(imageInput.files[i], 1280, 0.9);
                        processedImages.push(base64);
                    }
                    updateData.images = processedImages;
                }

                await updateDoc(doc(db, "stokMod", modId), updateData);
                showToast('Produk MOD berhasil diperbarui!', 'success');
                dom.editStokModModal.style.display = 'none';
                fetchStokMod();
            } catch (e) {
                console.error(e);
                showToast('Gagal update: ' + e.message, 'error');
            } finally {
                submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-save"></i> Simpan Perubahan';
            }
        };

        const handleDeleteStokMod = (modId, name) => {
            showConfirmation(`Yakin ingin menghapus MOD: ${name}?`, 'Hapus MOD', 'btn-danger', async () => {
                try {
                    await deleteDoc(doc(db, "stokMod", modId));
                    showToast('MOD berhasil dihapus.', 'success');
                    fetchStokMod();
                } catch (e) {
                    showToast('Gagal menghapus MOD.', 'error');
                }
            });
        };

// --- REKAP MANAGEMENT FUNCTIONS ---
        const fetchAndRenderRekap = async (filter = 'all') => {
            dom.rekapSpinner.style.display = 'flex';
            const tableBody = document.getElementById('rekap-table-body');
            tableBody.innerHTML = '';
            try {
                // Fetch data only if it's empty
                if (allRekapData.length === 0) {
                    const usersSnapshot = await getDocs(collection(db, "users"));
                    const usersMap = new Map();
                    usersSnapshot.forEach(doc => usersMap.set(doc.id, doc.data()));

                    const topupHistorySnapshot = await getDocs(collection(db, "topup_history"));
                    const purchaseHistorySnapshot = await getDocs(collection(db, "purchase_history"));
                    
                    let combinedTransactions = [];

                    topupHistorySnapshot.forEach(doc => {
                        const data = doc.data();
                        combinedTransactions.push({ type: 'Top Up Saldo', detail: `+ Rp ${(data.amount || 0).toLocaleString('id-ID')}`, amount: data.amount || 0, isTopUp: true, ...data });
                    });
                    purchaseHistorySnapshot.forEach(doc => {
                        const data = doc.data();
                        let detail = `Beli UB ${data.game || 'N/A'}`;
                        if(data.ubAmount && typeof data.ubAmount === 'string' && data.ubAmount.startsWith('Akun:')){
                            detail = `Beli Akun (${data.game || 'N/A'})`;
                        }
                        combinedTransactions.push({ type: 'Pembelian', detail: detail, amount: data.rpCost || 0, isTopUp: false, ...data });
                    });
                    
                    allRekapData = combinedTransactions.map(trx => ({ ...trx, user: usersMap.get(trx.userId) })).filter(trx => trx.user);
                }

                // Apply filters
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const startOfWeek = new Date(today);
                startOfWeek.setDate(startOfWeek.getDate() - today.getDay());

                const filteredData = allRekapData.filter(trx => {
                    if (!trx.timestamp || typeof trx.timestamp.seconds !== 'number') return false;
                    const trxDate = new Date(trx.timestamp.seconds * 1000);
                    switch (filter) {
                        case 'today': return trxDate >= today;
                        case 'yesterday': return trxDate >= yesterday && trxDate < today;
                        case 'this_week': return trxDate >= startOfWeek;
                        case 'all': default: return true;
                    }
                });

                // Sort by timestamp
                filteredData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                if (filteredData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">Tidak ada riwayat transaksi untuk filter "${filter}".</td></tr>`;
                } else {
                    filteredData.forEach(trx => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(trx.timestamp.seconds * 1000).toLocaleString('id-ID')}</td>
                            <td>${trx.user.username || 'N/A'}</td>
                            <td>${trx.user.whatsapp || 'N/A'}</td>
                            <td>${trx.type}</td>
                            <td>${trx.detail}</td>
                            <td class="${trx.isTopUp ? 'amount-topup' : 'amount-spent'}">${trx.isTopUp ? '+' : '-'} Rp ${trx.amount.toLocaleString('id-ID')}</td>
                            <td class="current-balance">Rp ${(trx.user.saldo || 0).toLocaleString('id-ID')}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error("Error fetching rekap data:", error);
                showToast('Gagal memuat data rekap.', 'error');
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger-primary);">Gagal memuat data.</td></tr>';
            } finally {
                dom.rekapSpinner.style.display = 'none';
            }
        };

        const handleResetRekap = async () => {
            const pinForm = document.getElementById('pin-form');
            const pinInput = document.getElementById('pin-input');
            pinInput.value = '';
            dom.pinModal.style.display = 'flex';
            
            pinForm.onsubmit = (e) => {
                e.preventDefault();
                if (pinInput.value === '050213') {
                    dom.pinModal.style.display = 'none';
                    showConfirmation(
                        'Anda YAKIN ingin menghapus SEMUA riwayat transaksi (topup & pembelian)? Tindakan ini tidak dapat dibatalkan.',
                        'Konfirmasi Reset Rekap',
                        'btn-danger',
                        async () => {
                            dom.rekapSpinner.style.display = 'flex';
                            try {
                                const collectionsToDelete = ["topup_history", "purchase_history"];
                                for (const coll of collectionsToDelete) {
                                    const snapshot = await getDocs(collection(db, coll));
                                    const batch = writeBatch(db);
                                    snapshot.forEach(doc => batch.delete(doc.ref));
                                    await batch.commit();
                                }
                                allRekapData = []; // Clear cached data
                                showToast('Rekap berhasil direset!', 'success');
                                await fetchAndRenderRekap('all');
                            } catch (error) {
                                console.error("Error resetting rekap:", error);
                                showToast('Gagal mereset rekap.', 'error');
                            } finally {
                                dom.rekapSpinner.style.display = 'none';
                            }
                        }
                    );
                } else {
                    showToast('PIN salah!', 'error');
                }
            };
        };

        // --- SETTINGS MANAGEMENT FUNCTIONS ---
        const updateMaintenanceStatusInFirestore = async (isActive) => {
             const message = document.getElementById('maintenance-message')?.value || appSettings.maintenance?.message || '';
            try {
                await setDoc(doc(db, "settings", "appConfig"), { maintenance: { isActive, message } }, { merge: true });
                showToast(`Mode perbaikan ${isActive ? 'diaktifkan' : 'dinonaktifkan'}.`, 'success');
            } catch (error) { 
                showToast('Gagal menyimpan pengaturan maintenance.', 'error');
            }
        };

        // --- FUNGSI BARU: Update Status OTP ---
    const updateOtpStatusInFirestore = async (isActive) => {
        try {
            // Menyimpan status OTP ke appConfig
            await setDoc(doc(db, "settings", "appConfig"), { otp: { isActive: isActive } }, { merge: true });
            showToast(`Verifikasi OTP ${isActive ? 'diaktifkan' : 'dinonaktifkan'}.`, 'success');
        } catch (error) { 
            showToast('Gagal menyimpan pengaturan OTP.', 'error');
        }
    };

    const loadAndDisplaySettings = async () => {
        try {
            // Set status toggle OTP (default 'true' jika tidak ada)
            const isOtpActive = appSettings.otp?.isActive === false ? false : true; 
            document.getElementById('otp-toggle').checked = isOtpActive;
            document.getElementById('main-menu-otp-toggle').checked = isOtpActive; // <-- SINKRONISASI

            // Data sudah diambil oleh listener realtime, tinggal update UI
            document.getElementById('global-message-title').value = appSettings.welcomeMessages?.global?.title || '';
                // Data sudah diambil oleh listener realtime, tinggal update UI
                document.getElementById('global-message-title').value = appSettings.welcomeMessages?.global?.title || '';
                document.getElementById('global-message-content').value = appSettings.welcomeMessages?.global?.content || '';
                document.getElementById('global-message-logins').value = appSettings.welcomeMessages?.global?.targetLogins || 1;
                document.getElementById('newUser-message-title').value = appSettings.welcomeMessages?.newUser?.title || '';
                document.getElementById('newUser-message-content').value = appSettings.welcomeMessages?.newUser?.content || '';

                const userSelect = document.getElementById('specific-user-select');
                userSelect.innerHTML = '<option value="">-- Pilih User --</option>';
                if (allUsers.length === 0) await fetchUsers();
                allUsers.sort((a,b) => a.username.localeCompare(b.username)).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;
                    userSelect.appendChild(option);
                });
            } catch (error) { showToast('Gagal memuat pengaturan pesan.', 'error'); }
        };

        const handleSaveWelcomeMessage = async (type) => {
            let messageData;
            if (type === 'global') {
                messageData = {
                    id: `global_${Date.now()}`,
                    title: document.getElementById('global-message-title').value,
                    content: document.getElementById('global-message-content').value,
                    targetLogins: Number(document.getElementById('global-message-logins').value)
                };
            } else if (type === 'newUser') {
                messageData = {
                    id: `newUser_${Date.now()}`,
                    title: document.getElementById('newUser-message-title').value,
                    content: document.getElementById('newUser-message-content').value
                };
            }
            try {
                const key = `welcomeMessages.${type}`;
                await setDoc(doc(db, "settings", "appConfig"), { welcomeMessages: { [type]: messageData } }, { merge: true });
                showToast(`Pesan ${type} berhasil disimpan!`, 'success');
            } catch (e) { showToast('Gagal menyimpan pesan.', 'error'); }
        };

        const handleSendSpecificMessage = async (e) => {
            e.preventDefault();
            const userId = document.getElementById('specific-user-select').value;
            if (!userId) { showToast('Silakan pilih user.', 'error'); return; }

            const messageData = {
                title: document.getElementById('specific-message-title').value,
                content: document.getElementById('specific-message-content').value,
                targetLogins: Number(document.getElementById('specific-message-logins').value),
                timesShown: 0
            };
            if(!messageData.content) { showToast('Isi pesan tidak boleh kosong.', 'error'); return; }
            try {
                await updateDoc(doc(db, "users", userId), { welcomeMessage: messageData });
                showToast('Pesan berhasil dikirim!', 'success');
                e.target.reset();
            } catch (error) { showToast('Gagal mengirim pesan.', 'error'); }
        };

        // --- FLOATING TRANSACTION MODAL ---
        const checkAndShowFloatingTransaction = async () => {
            if (isFloatingModalShown) return;

            const q = query(collection(db, "users"), where("pendingTransaction", ">", 0), limit(1));
            const subQuery = query(collection(db, "users"), where("pendingSubscription", "!=", null), limit(1));
            const saleQuery = query(collection(db, "users"), where("akunJualStatus.status", "==", "Di Proses"), limit(1));
            
            try {
                const [querySnapshot, subSnapshot, saleSnapshot] = await Promise.all([getDocs(q), getDocs(subQuery), getDocs(saleQuery)]);
                let pendingUserDoc = null;

                if (!querySnapshot.empty) {
                    pendingUserDoc = querySnapshot.docs[0];
                } else if (!subSnapshot.empty) {
                    pendingUserDoc = subSnapshot.docs[0];
                } else if (!saleSnapshot.empty){
                    pendingUserDoc = saleSnapshot.docs[0];
                }

                if (pendingUserDoc) {
                    const user = { id: pendingUserDoc.id, ...pendingUserDoc.data() };
                    const cardHTML = createTransactionCardHTML(user);
                    
                    document.getElementById('floating-transaction-content').innerHTML = cardHTML;
                    
                    const acceptBtn = document.getElementById('floating-accept-btn');
                    const rejectBtn = document.getElementById('floating-reject-btn');
                    
                    // Detach old listeners
                    acceptBtn.replaceWith(acceptBtn.cloneNode(true));
                    rejectBtn.replaceWith(rejectBtn.cloneNode(true));
                    
                    // Add new listeners
                    document.getElementById('floating-accept-btn').addEventListener('click', () => {
                         if (user.pendingTransaction > 0) handleAcceptTransaction(user.id, true);
                         else if (user.pendingSubscription) handleAcceptSubscription(user.id, true);
                         else if (user.pendingAkunPurchase) handleAcceptAkunPurchase(user.id, true); // ADDED
                         else if (user.akunJualStatus) handleAcceptAccountSale(user.id, true);
                    });
                     document.getElementById('floating-reject-btn').addEventListener('click', () => {
                         if (user.pendingTransaction > 0) handleRejectTransaction(user.id, true);
                         else if (user.pendingSubscription) handleRejectSubscription(user.id, true);
                         else if (user.pendingAkunPurchase) handleRejectAkunPurchase(user.id, true); // ADDED
                         else if (user.akunJualStatus) handleRejectAccountSale(user.id, true);
                    });

                    dom.floatingTransactionModal.style.display = 'flex';
                    isFloatingModalShown = true;
                }
            } catch (error) {
                console.error("Error checking for floating transaction:", error);
            }
        };

        // --- UNIVERSAL FUNCTIONS ---
        const showConfirmation = (message, title, btnClass, callback) => {
            const confirmBtn = document.getElementById('confirm-ok-btn');
            document.getElementById('confirm-title').innerHTML = title;
            document.getElementById('confirm-message').textContent = message;
            confirmBtn.className = `action-button ${btnClass}`;
            dom.confirmModal.style.display = 'flex';
            
            const handleConfirm = () => {
                callback();
                dom.confirmModal.style.display = 'none';
                confirmBtn.replaceWith(confirmBtn.cloneNode(true)); 
            };
            
            document.getElementById('confirm-ok-btn').addEventListener('click', handleConfirm, { once: true });
        };

        function syncPresenceFromRtdbToFirestore() {
            const statusRef = ref(rtdb, 'status');

            onChildChanged(statusRef, (snapshot) => {
                const uid = snapshot.key;
                const statusData = snapshot.val();
                if (uid && statusData.status === 'offline') {
                    console.log(`RTDB change detected for ${uid}: offline. Syncing to Firestore.`);
                    const firestoreDocRef = doc(db, 'presence', uid);
                    setDoc(firestoreDocRef, {
                        status: 'offline',
                        last_seen: serverTimestamp()
                    }, { merge: true });
                }
            });

            onChildRemoved(statusRef, (snapshot) => {
                const uid = snapshot.key;
                if (uid) {
                    console.log(`RTDB data for ${uid} removed. Syncing to Firestore.`);
                    const firestoreDocRef = doc(db, 'presence', uid);
                    setDoc(firestoreDocRef, {
                        status: 'offline',
                        last_seen: serverTimestamp()
                    }, { merge: true });
                }
            });
        }// --- START: LIVE CHAT MANAGEMENT FUNCTIONS ---
let activeChatSessionId = null;
let allChatSessions = {}; // Objek untuk menyimpan data sesi chat
let unsubscribeChatList = null; // Listener untuk daftar chat
let unsubscribeMessages = null; // Listener untuk pesan di chat aktif
let allChatUsers = []; // Cache untuk daftar user (untuk "Pesan Baru")
let didFetchChatUsers = false;

// DOM Referensi baru untuk chat
const chatDom = {
    floatingWindow: document.getElementById('floating-chat-window'),
    chatHeader: document.getElementById('floating-chat-header'),
    chatUsername: document.getElementById('floating-chat-username'),
    chatMessages: document.getElementById('floating-chat-messages'),
    chatText: document.getElementById('floating-chat-text'),
    chatSend: document.getElementById('floating-chat-send'),
    chatMinimize: document.getElementById('floating-chat-minimize'),
    chatClose: document.getElementById('floating-chat-close'),
    chatClear: document.getElementById('floating-chat-clear'),
    
    newChatModal: document.getElementById('new-chat-modal'),
    newChatSearch: document.getElementById('new-chat-search'),
    newChatUserList: document.getElementById('new-chat-user-list'),

    mainChatListContainer: document.getElementById('chat-session-list-items') // Ini adalah list di halaman utama
};

// Fungsi untuk membersihkan username agar aman sebagai key Firebase RTDB
const sanitizeUsernameForFirebaseKey = (username) => username.replace(/[.#$[\]]/g, '_');

// Fungsi untuk memuat daftar sesi chat dari RTDB
const loadChatSessions = () => {
    const chatListRef = ref(rtdb, 'chats');

    if (unsubscribeChatList) unsubscribeChatList(); // Hapus listener lama

    unsubscribeChatList = onValue(chatListRef, (snapshot) => {
        allChatSessions = snapshot.val() || {};
        renderChatSessionList();
        updateChatNotificationBadge();
    }, (error) => {
        console.error("Error loading chat sessions:", error);
        showToast('Gagal memuat daftar chat.', 'error');
        chatDom.mainChatListContainer.innerHTML = '<p style="color:var(--danger-primary); padding: 15px;">Gagal memuat sesi.</p>';
    });
};

// Fungsi untuk merender daftar sesi chat di halaman utama
const renderChatSessionList = () => {
    const listContainer = chatDom.mainChatListContainer;
    listContainer.innerHTML = ''; // Kosongkan daftar

    const sortedSessionIds = Object.keys(allChatSessions).sort((a, b) => {
        const lastMsgA = getLastMessageData(allChatSessions[a]);
        const lastMsgB = getLastMessageData(allChatSessions[b]);
        return (lastMsgB?.timestamp || 0) - (lastMsgA?.timestamp || 0);
    });

    if (sortedSessionIds.length === 0) {
         listContainer.innerHTML = '<p style="padding: 15px; text-align: center; color: var(--text-secondary);">Belum ada chat.</p>';
         return;
    }

    sortedSessionIds.forEach(sessionId => {
        const sessionData = allChatSessions[sessionId];
        const lastMessage = getLastMessageData(sessionData);
        if (!lastMessage) return; // Jangan render sesi yang kosong (cth: _init)

        const username = lastMessage.username || sessionId.replace(/_/g, '.');
        const lastMessagePreview = getLastMessagePreview(lastMessage); // Mendapatkan 1 baris chat terbaru

        const item = document.createElement('div');
        item.className = 'chat-session-item';
        item.dataset.sessionId = sessionId;

        const hasUnread = lastMessage.sender === 'user';
        if (hasUnread) item.classList.add('has-unread');
        
        // Cek apakah chat ini sedang dibuka di jendela mengambang
        if (sessionId === activeChatSessionId && chatDom.floatingWindow.style.display === 'flex') {
            item.classList.add('active');
            if (hasUnread) item.classList.remove('has-unread'); // Dianggap terbaca jika sedang dibuka
        }

        item.innerHTML = `
            <div style="flex-grow: 1; min-width: 0;"> <span class="session-username">${username}</span>
                <p class="session-last-message">${lastMessagePreview}</p> </div>
            <span class="unread-indicator"></span>
        `;
        listContainer.appendChild(item);
    });
};

// Helper untuk mendapatkan OBJEK pesan terakhir
const getLastMessageData = (sessionData) => {
    if (!sessionData) return null;
    const messageIds = Object.keys(sessionData).filter(id => id !== '_init'); // Filter _init
    if (messageIds.length === 0) return null;

    let latestMessage = null;
    let latestTimestamp = 0;

    messageIds.forEach(id => {
        const msg = sessionData[id];
        if (msg && (msg.timestamp || 0) > latestTimestamp) {
            latestTimestamp = msg.timestamp;
            latestMessage = msg;
        }
    });
    return latestMessage;
};

// Helper untuk mendapatkan 1 BARIS PREVIEW pesan terakhir
const getLastMessagePreview = (lastMessage) => {
    if (!lastMessage) return "Belum ada pesan.";
    let preview = "";
    if (lastMessage.sender === 'admin') {
        preview += "Anda: ";
    }
    if (lastMessage.text) {
        preview += lastMessage.text;
    } else if (lastMessage.image) {
        preview = "[Gambar]";
        if (lastMessage.sender === 'admin') preview = "Anda: [Gambar]";
    }
    return preview;
};

// Fungsi untuk memperbarui badge notifikasi chat
const updateChatNotificationBadge = () => {
    let unreadCount = 0;
    Object.keys(allChatSessions).forEach(sessionId => {
        // Jangan hitung sesi yang sedang aktif
        if (sessionId === activeChatSessionId && chatDom.floatingWindow.style.display === 'flex' && !chatDom.floatingWindow.classList.contains('minimized')) {
            return;
        }
        const lastMessage = getLastMessageData(allChatSessions[sessionId]);
        if (lastMessage?.sender === 'user') {
            unreadCount++;
        }
    });

    const badge = document.getElementById('chat-notification-badge');
    if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
};

// Fungsi untuk MEMBUKA JENDELA CHAT MENGAMBANG
const openFloatingChat = (sessionId) => {
    if (activeChatSessionId === sessionId && !chatDom.floatingWindow.classList.contains('minimized')) {
         chatDom.floatingWindow.style.display = 'flex'; // Pastikan terlihat
         return; // Sudah aktif
    }

    // Hapus listener pesan lama jika ada
    if (unsubscribeMessages) unsubscribeMessages();

    activeChatSessionId = sessionId;

    // Update tampilan daftar sesi (tandai yang aktif)
    document.querySelectorAll('.chat-session-item').forEach(item => {
        item.classList.toggle('active', item.dataset.sessionId === sessionId);
        if(item.dataset.sessionId === sessionId) {
            item.classList.remove('has-unread');
        }
    });
    updateChatNotificationBadge(); // Hitung ulang notif

    // Tampilkan jendela & atur header
    const sessionData = allChatSessions[sessionId];
    const lastMessage = getLastMessageData(sessionData);
    const username = lastMessage?.username || sessionId.replace(/_/g, '.');
    
    chatDom.floatingWindow.style.display = 'flex';
    chatDom.floatingWindow.classList.remove('minimized');
    chatDom.chatUsername.textContent = `Chat with ${username}`;
    chatDom.chatMessages.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Memuat pesan...</p>';
    chatDom.chatText.disabled = false;
    chatDom.chatSend.disabled = false;
    chatDom.chatText.focus();

    // Setup listener baru untuk pesan di sesi ini
    const messagesRef = ref(rtdb, `chats/${sessionId}`);
    unsubscribeMessages = onValue(messagesRef, (snapshot) => {
        chatDom.chatMessages.innerHTML = ''; // Kosongkan
        const messages = snapshot.val();
        if (messages) {
            // Urutkan pesan berdasarkan timestamp
            const sortedKeys = Object.keys(messages).sort((a, b) => (messages[a]?.timestamp || 0) - (messages[b]?.timestamp || 0));
            sortedKeys.forEach(key => {
                if (key !== '_init') {
                    displayAdminChatMessage(messages[key], key); // Kirim 'key' untuk ID pesan
                }
            });
        } else {
             chatDom.chatMessages.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Belum ada pesan.</p>';
        }
    }, (error) => {
        console.error(`Error loading messages for ${sessionId}:`, error);
        chatDom.chatMessages.innerHTML = '<p style="color:var(--danger-primary); text-align:center;">Gagal memuat pesan.</p>';
    });
};

// Fungsi untuk MENUTUP JENDELA CHAT MENGAMBANG
const closeFloatingChat = () => {
    chatDom.floatingWindow.style.display = 'none';
    if (unsubscribeMessages) unsubscribeMessages(); // Hentikan listener
    unsubscribeMessages = null;
    activeChatSessionId = null;

    // Hapus status 'active' dari daftar chat
    document.querySelectorAll('.chat-session-item.active').forEach(item => {
        item.classList.remove('active');
    });
    updateChatNotificationBadge(); // Hitung ulang
};

// Fungsi untuk MINIMIZE JENDELA CHAT
const minimizeFloatingChat = () => {
    chatDom.floatingWindow.classList.toggle('minimized');
    // Jika di-maximize (bukan minimize), update notif (karena dianggap terbaca)
    if (!chatDom.floatingWindow.classList.contains('minimized')) {
        updateChatNotificationBadge();
        chatDom.chatText.focus();
    }
};

// Fungsi untuk menampilkan satu pesan di jendela chat admin
// MODIFIKASI: Tambahkan messageId untuk tombol hapus
const displayAdminChatMessage = (msg, messageId) => {
    if (!msg || !msg.sender) return; // Abaikan jika data tidak lengkap

    const container = document.createElement('div');
    container.className = 'chat-message-admin-container';
    container.classList.add(msg.sender === 'admin' ? 'admin-message' : 'user-message');

    const senderSpan = document.createElement('span');
    senderSpan.className = 'chat-message-sender';
    senderSpan.textContent = msg.sender === 'admin' ? 'Admin' : (msg.username || 'User');
    container.appendChild(senderSpan);

    const bubble = document.createElement('div');
    bubble.className = 'chat-message-bubble';
    
    // Tombol Hapus (hanya untuk pesan user)
    bubble.innerHTML = `
        <button class="chat-delete-btn" data-message-id="${messageId}" title="Hapus pesan">
            <i class="fas fa-trash-alt"></i>
        </button>
    `;

    if (msg.text) {
        // Buat text node agar aman dari HTML injection
        const textNode = document.createTextNode(msg.text);
        bubble.appendChild(textNode);
    } else if (msg.image) {
        const img = document.createElement('img');
        img.src = msg.image;
        img.className = 'chat-message-image';
        img.alt = 'User image';
        bubble.appendChild(img);
    }
    
    container.appendChild(bubble);
    chatDom.chatMessages.appendChild(container);
    chatDom.chatMessages.scrollTop = chatDom.chatMessages.scrollHeight; // Auto-scroll
};

// Fungsi untuk mengirim balasan dari admin (via jendela mengambang)
// MODIFIKASI: Diubah untuk menangani Teks atau Gambar
const sendAdminReply = (content, type = 'text') => {
    if (!content || !activeChatSessionId) return;

    const message = {
        sender: 'admin',
        timestamp: dbServerTimestamp() // Gunakan serverTimestamp dari RTDB
    };

    if (type === 'text') {
        message.text = content;
    } else if (type === 'image') {
        message.image = content;
    }

    const messageRef = ref(rtdb, `chats/${activeChatSessionId}`);
    push(messageRef, message) // Gunakan push dari RTDB
        .then(() => {
            if (type === 'text') {
                chatDom.chatText.value = ''; // Kosongkan input jika berhasil
            }
        })
        .catch((error) => {
            console.error("Error sending admin reply:", error);
            showToast('Gagal mengirim balasan.', 'error');
        });
};

// Fungsi untuk menangani klik tombol "Mulai Chat" dari User Management
const handleStartChatButtonClick = (username) => {
    if (!username) return;

    const targetSessionId = sanitizeUsernameForFirebaseKey(username);
    showView('liveChat'); // Pindah ke view chat (jika belum)

    const checkSessionAndOpen = () => {
        if (allChatSessions[targetSessionId] !== undefined) {
             openFloatingChat(targetSessionId); // Buka chat mengambang
        } else {
            // Jika sesi belum ada, buat entri dummy agar muncul di list
            const dummyRef = ref(rtdb, `chats/${targetSessionId}/_init`);
            set(dummyRef, { timestamp: dbServerTimestamp() }); 
            
            // Langsung buka jendela mengambang
            activeChatSessionId = targetSessionId; // Set ID
            
            chatDom.floatingWindow.style.display = 'flex';
            chatDom.floatingWindow.classList.remove('minimized');
            chatDom.chatUsername.textContent = `Chat with ${username}`;
            chatDom.chatMessages.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Mulai percakapan...</p>';
            chatDom.chatText.disabled = false;
            chatDom.chatSend.disabled = false;
            chatDom.chatText.focus();
            
            // Kita belum setup listener pesan karena belum ada pesan
            // Listener akan dibuat saat openFloatingChat dipanggil (setelah pesan pertama)
            // Atau kita bisa setup listener kosong
            if (unsubscribeMessages) unsubscribeMessages();
            const messagesRef = ref(rtdb, `chats/${targetSessionId}`);
            unsubscribeMessages = onValue(messagesRef, (snapshot) => {
                 chatDom.chatMessages.innerHTML = '';
                 const messages = snapshot.val();
                 if (!messages || Object.keys(messages).filter(k => k !== '_init').length === 0) {
                     chatDom.chatMessages.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Mulai percakapan...</p>';
                     return;
                 }
                 const sortedKeys = Object.keys(messages).sort((a, b) => (messages[a]?.timestamp || 0) - (messages[b]?.timestamp || 0));
                 sortedKeys.forEach(key => {
                    if (key !== '_init') {
                        displayAdminChatMessage(messages[key], key);
                    }
                 });
            });
        }
    };

    checkSessionAndOpen();
};

// --- FUNGSI BARU UNTUK MODAL "PESAN BARU" ---

const openNewChatModal = async () => {
    chatDom.newChatModal.style.display = 'flex';
    chatDom.newChatSearch.value = '';
    
    // Cek cache dulu
    if (didFetchChatUsers) {
        populateNewChatUserList();
        return;
    }

    // Jika belum, fetch dari Firestore
    chatDom.newChatUserList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">Memuat user...</p>';
    try {
        if (allUsers.length === 0) { // Jika allUsers (dari user management) kosong, fetch
            const querySnapshot = await getDocs(collection(db, "users"));
            allChatUsers = querySnapshot.docs.map(doc => ({ id: doc.id, username: doc.data().username }));
        } else {
            allChatUsers = allUsers.map(user => ({ id: user.id, username: user.username }));
        }
        
        allChatUsers.sort((a, b) => a.username.localeCompare(b.username)); // Urutkan
        didFetchChatUsers = true;
        populateNewChatUserList();
    } catch (error) {
        console.error("Error fetching users for chat:", error);
        chatDom.newChatUserList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--danger-primary);">Gagal memuat user.</p>';
    }
};

const populateNewChatUserList = (filter = '') => {
    chatDom.newChatUserList.innerHTML = '';
    const lowerFilter = filter.toLowerCase();
    
    const filteredUsers = allChatUsers.filter(user => user.username.toLowerCase().includes(lowerFilter));
    
    if (filteredUsers.length === 0) {
        chatDom.newChatUserList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-secondary);">User tidak ditemukan.</p>';
        return;
    }
    
    filteredUsers.forEach(user => {
        const li = document.createElement('li');
        li.className = 'new-chat-user-item'; // Buat style untuk ini jika perlu
        li.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer;';
        li.dataset.username = user.username;
        li.innerHTML = `<i class="fas fa-user" style="margin-right: 10px; color: var(--accent-primary);"></i> ${user.username}`;
        
        // Hover effect
        li.onmouseover = () => li.style.backgroundColor = 'var(--bg-secondary)';
        li.onmouseout = () => li.style.backgroundColor = 'transparent';
        
        chatDom.newChatUserList.appendChild(li);
    });
};

// --- FUNGSI BARU UNTUK HAPUS PESAN ---

const handleDeleteMessage = (sessionId, messageId) => {
    if (!sessionId || !messageId) return;
    
    showConfirmation(
        'Yakin ingin menghapus pesan ini? Pesan akan hilang di sisi user juga.',
        'Hapus Pesan',
        'btn-danger',
        () => {
            const messageRef = ref(rtdb, `chats/${sessionId}/${messageId}`);
            remove(messageRef)
                .then(() => {
                    showToast('Pesan dihapus.', 'success');
                })
                .catch((error) => {
                    showToast('Gagal menghapus pesan.', 'error');
                    console.error("Error removing message:", error);
                });
        }
    );
};

const handleClearChat = (sessionId) => {
    if (!sessionId) return;
    
    showConfirmation(
        'YAKIN ingin menghapus SELURUH riwayat chat ini? Tindakan ini tidak dapat dibatalkan.',
        'Hapus Riwayat Chat',
        'btn-danger',
        () => {
            const sessionRef = ref(rtdb, `chats/${sessionId}`);
            set(sessionRef, null) // Hapus semua data di bawah node sesi ini
                .then(() => {
                    showToast('Riwayat chat dibersihkan.', 'success');
                    closeFloatingChat(); // Tutup jendela chat yang sudah kosong
                })
                .catch((error) => {
                    showToast('Gagal membersihkan chat.', 'error');
                    console.error("Error clearing chat:", error);
                });
        }
    );
};

// --- END: LIVE CHAT MANAGEMENT FUNCTIONS ---
// --- AUTH & EVENT LISTENERS SETUP ---
        function setupEventListeners() {
                        // Lightbox Listeners
            document.getElementById('admin-close-lightbox-btn').addEventListener('click', () => {
                document.getElementById('admin-image-lightbox').style.display = 'none';
            });
            document.getElementById('admin-image-lightbox').addEventListener('click', (e) => {
                if (e.target.id === 'admin-image-lightbox') {
                    document.getElementById('admin-image-lightbox').style.display = 'none';
                }
            });

            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const button = e.target.querySelector('button');
                button.disabled = true; button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value)
                    .catch((error) => showToast(`Login failed: ${error.code}`, 'error'))
                    .finally(() => { button.disabled = false; button.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login'; });
            });
            
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

            document.querySelectorAll('.menu-grid-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const viewName = e.currentTarget.dataset.view;
                    if (viewName === 'otpGenerator') {
                        document.getElementById('generated-otp-display').textContent = '...';
                        document.getElementById('otp-display-area').style.display = 'block';
                        // Ambil OTP saat ini saat membuka
                        get(ref(rtdb, 'settings/activeOTP')).then((snapshot) => {
                            if (snapshot.exists()) {
                                document.getElementById('generated-otp-display').textContent = snapshot.val();
                            } else {
                                document.getElementById('generated-otp-display').textContent = 'Belum Ada';
                            }
                        });
                        // --- PERBAIKAN DI BAWAH INI ---
                        document.getElementById('otp-generator-modal').style.display = 'flex';
                    } else {
                        showView(viewName);
                    }
                });
            });

            document.querySelectorAll('.back-to-menu-btn').forEach(button => {
                button.addEventListener('click', showMainMenu);
            });
            
            document.getElementById('refresh-users-btn').addEventListener('click', fetchUsers);
            document.getElementById('refresh-transactions-btn').addEventListener('click', fetchAndRenderTransactions);
            document.getElementById('refresh-stok-akun-btn').addEventListener('click', fetchStokAkun);
            document.getElementById('refresh-stok-kredensial-btn').addEventListener('click', fetchStokKredensial);

            // --- ETALASE VIEW LISTENERS ---
                        document.getElementById('etalase-filters').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    document.querySelectorAll('#etalase-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    const viewToShow = e.target.dataset.etalaseView;
                    if (viewToShow === 'kredensial') {
                        document.getElementById('stok-kredensial-management-view').style.display = 'block';
                        document.getElementById('stok-akun-management-view').style.display = 'none';
                        document.getElementById('stok-mod-management-view').style.display = 'none';
                        fetchStokKredensial();
                    } else if (viewToShow === 'mod') {
                        document.getElementById('stok-kredensial-management-view').style.display = 'none';
                        document.getElementById('stok-akun-management-view').style.display = 'none';
                        document.getElementById('stok-mod-management-view').style.display = 'block';
                        fetchStokMod();
                    } else { // 'penawaran'
                        document.getElementById('stok-kredensial-management-view').style.display = 'none';
                        document.getElementById('stok-akun-management-view').style.display = 'block';
                        document.getElementById('stok-mod-management-view').style.display = 'none';
                        fetchStokAkun();
                    }
                }
            });

            document.getElementById('refresh-etalase-btn').addEventListener('click', () => {
                const activeFilter = document.querySelector('#etalase-filters .filter-btn.active').dataset.etalaseView;
                if (activeFilter === 'kredensial') fetchStokKredensial();
                else if (activeFilter === 'mod') fetchStokMod();
                else fetchStokAkun();
            });


            
            document.getElementById('add-stok-mod-btn').addEventListener('click', () => dom.addStokModModal.style.display = 'flex');
            document.getElementById('add-stok-mod-form').addEventListener('submit', handleSaveNewStokMod);
            document.getElementById('edit-stok-mod-form').addEventListener('submit', handleUpdateStokMod);
            document.getElementById('refresh-stok-mod-btn').addEventListener('click', fetchStokMod);

document.getElementById('reset-rekap-btn').addEventListener('click', handleResetRekap);
            
            document.getElementById('add-user-btn').addEventListener('click', () => dom.addUserModal.style.display = 'flex');
            document.getElementById('quick-add-user-btn').addEventListener('click', () => dom.addUserModal.style.display = 'flex');
            document.getElementById('quick-add-stok-btn').addEventListener('click', () => dom.addStokAkunModal.style.display = 'flex');
            
            dom.searchInput.addEventListener('input', () => { currentPage = 1; filterAndDisplayUsers(); });
            document.getElementById('prev-page-btn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderUserCards(); } });
            document.getElementById('next-page-btn').addEventListener('click', () => { const totalPages = Math.ceil(displayedUsers.length / rowsPerPage); if (currentPage < totalPages) { currentPage++; renderUserCards(); } });
                        // --- Listener untuk Modal Ban Reason ---
            document.getElementById('confirm-ban-btn').addEventListener('click', () => {
                const reason = document.getElementById('ban-reason-input').value.trim();
                if (!reason) {
                    showToast('Harap masukkan alasan pemblokiran!', 'error');
                    return;
                }
                if (currentBanTargetId) {
                    handleBanToggle(currentBanTargetId, true, reason);
                    document.getElementById('ban-reason-modal').style.display = 'none';
                    currentBanTargetId = null;
                }
            });
            
            // Cancel button logic khusus untuk ban modal (mengembalikan toggle ke posisi off)
            document.querySelector('#ban-reason-modal .cancel-modal-btn').addEventListener('click', () => {
                if (currentBanTargetId) {
                    const toggle = document.getElementById(`ban-toggle-${currentBanTargetId}`);
                    if (toggle) toggle.checked = false; // Kembalikan ke posisi off
                    currentBanTargetId = null;
                }
                document.getElementById('ban-reason-modal').style.display = 'none';
            });            document.getElementById('edit-user-form').addEventListener('submit', handleSaveChanges);document.getElementById('add-user-form').addEventListener('submit', handleSaveNewUser);
            
            document.getElementById('add-stok-akun-btn').addEventListener('click', () => dom.addStokAkunModal.style.display = 'flex');
            document.getElementById('add-stok-akun-form').addEventListener('submit', handleSaveNewStokAkun);
            document.getElementById('edit-stok-akun-form').addEventListener('submit', handleUpdateStokAkun);

            document.getElementById('add-stok-kredensial-btn').addEventListener('click', () => dom.addStokKredensialModal.style.display = 'flex');
            document.getElementById('add-stok-kredensial-form').addEventListener('submit', handleSaveNewStokKredensial);
            document.getElementById('edit-stok-kredensial-form').addEventListener('submit', handleUpdateStokKredensial);
            
            document.getElementById('quick-add-credential-btn').addEventListener('click', () => dom.addStokKredensialModal.style.display = 'flex');
            document.getElementById('main-menu-maintenance-toggle').addEventListener('change', (e) => updateMaintenanceStatusInFirestore(e.target.checked));
            document.getElementById('maintenance-toggle').addEventListener('change', (e) => updateMaintenanceStatusInFirestore(e.target.checked));

        // Listener untuk toggle OTP
        // Listener untuk toggle OTP
        document.getElementById('otp-toggle').addEventListener('change', (e) => {
            const isOtpActive = e.target.checked;
            document.getElementById('main-menu-otp-toggle').checked = isOtpActive; // <-- SINKRONISASI
            updateOtpStatusInFirestore(isOtpActive);
        });
        
        // <-- LISTENER BARU UNTUK TOGGLE DI MENU UTAMA -->
        document.getElementById('main-menu-otp-toggle').addEventListener('change', (e) => {
            const isOtpActive = e.target.checked;
            // Cek jika toggle di settings ada sebelum mengubahnya
            const settingsToggle = document.getElementById('otp-toggle');
            if (settingsToggle) {
                settingsToggle.checked = isOtpActive;
            }
            updateOtpStatusInFirestore(isOtpActive);
        });

        document.getElementById('maintenance-message').addEventListener('input', () => {
                const isActive = document.getElementById('maintenance-toggle').checked;
                updateMaintenanceStatusInFirestore(isActive);
            });

            document.getElementById('global-message-form').addEventListener('submit', (e) => { e.preventDefault(); handleSaveWelcomeMessage('global'); });
            document.getElementById('newUser-message-form').addEventListener('submit', (e) => { e.preventDefault(); handleSaveWelcomeMessage('newUser'); });
            document.getElementById('specific-message-form').addEventListener('submit', handleSendSpecificMessage);
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(`tab-content-${tabName}`).classList.add('active');
                });
            });

                        document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if (modal.id !== 'ban-reason-modal') { // Skip ban modal karena logic khususnya di atas
                    modal.style.display = 'none';
                }
                if (modal.id === 'floating-transaction-modal') {
                    isFloatingModalShown = true; // Mark as shown so it doesn't pop up again
                }
            }));

            document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                dom.confirmModal.style.display = 'none';
                const confirmBtn = document.getElementById('confirm-ok-btn');
                confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            });
            document.querySelectorAll('.password-toggle').forEach(btn => btn.addEventListener('click', togglePasswordVisibility));

            document.getElementById('edit-accountType').addEventListener('change', (e) => {
                const subscriptionFields = document.getElementById('subscription-fields');
                const saldoField = document.getElementById('edit-saldo').closest('.input-group');
                if (e.target.value === 'Langganan') {
                    subscriptionFields.style.display = 'block';
                    saldoField.style.display = 'none';
                } else {
                    subscriptionFields.style.display = 'none';
                    saldoField.style.display = 'block';
                }
            });

            document.querySelectorAll('.date-mod-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const days = parseInt(e.currentTarget.dataset.days);
                    const dateInput = document.getElementById('edit-masaAktifHingga');
                    const currentDate = dateInput.value ? new Date(dateInput.value) : new Date();
                    const currentUTCDate = new Date(Date.UTC(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()));
                    currentUTCDate.setUTCDate(currentUTCDate.getUTCDate() + days);
                    dateInput.value = currentUTCDate.toISOString().split('T')[0];
                });
            });// Filter listeners
            document.getElementById('user-account-type-filters').addEventListener('click', (e) => {
                if(e.target.classList.contains('filter-btn')) {
                    document.querySelectorAll('#user-account-type-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    currentPage = 1; // Reset ke halaman 1
                    filterAndDisplayUsers(); // Panggil fungsi filter utama
                }
            });

            document.getElementById('rekap-filters').addEventListener('click', (e) => {
                if(e.target.classList.contains('filter-btn')) {
                    document.querySelectorAll('#rekap-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    fetchAndRenderRekap(e.target.dataset.filter);
                }
            });
            document.getElementById('stok-akun-filters').addEventListener('click', (e) => {
                if(e.target.classList.contains('filter-btn')) {
                    document.querySelectorAll('#stok-akun-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderStokAkunCards(e.target.dataset.filter);
                }
            });
            document.getElementById('stok-kredensial-filters').addEventListener('click', (e) => {
                if(e.target.classList.contains('filter-btn')) {
                    document.querySelectorAll('#stok-kredensial-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderStokKredensialCards(e.target.dataset.filter);
                }
            });

            // --- START: Event Listener Toggle Status Admin ---
            document.getElementById('admin-online-toggle').addEventListener('change', (e) => {
                const isOnline = e.target.checked;
                set(adminStatusRef, isOnline)
                    .then(() => {
                        showToast(`Status diubah ke ${isOnline ? 'Online' : 'Offline'}.`, 'success');
                    })
                    .catch((err) => {
                        showToast('Gagal mengubah status.', 'error');
                        e.target.checked = !isOnline; // Kembalikan toggle jika gagal
                    });
            });
            // --- END: Event Listener Toggle Status Admin ---

            // --- START: OTP Generator Listener ---
            document.getElementById('generate-otp-btn').addEventListener('click', async (e) => {
                const btn = e.currentTarget;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

                try {
                    // 1. Generate 5-digit random code
                    const newOtp = Math.floor(10000 + Math.random() * 90000).toString();
                    
                    // 2. Save to Firebase RTDB (menggantikan yang lama)
                    const otpRef = ref(rtdb, 'settings/activeOTP');
                    await set(otpRef, newOtp);
                    
                    // 3. Update display
                    document.getElementById('generated-otp-display').textContent = newOtp;
                    document.getElementById('otp-display-area').style.display = 'block';
                    
                    showToast('Kode OTP baru telah di-generate!', 'success');

                } catch (error) {
                    console.error("Error generating OTP:", error);
                    showToast('Gagal meng-generate OTP.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Generate Kode OTP Baru';
                }
            });
            // --- END: OTP Generator Listener ---
        }
        
                async function handleBanToggle(docId, isBanned, reason = null) {
            const userRef = doc(db, "users", docId);
            try {
                const updateData = { isBanned: isBanned };
                if (isBanned && reason) {
                    updateData.banReason = reason;
                } else if (!isBanned) {
                    updateData.banReason = deleteField();
                }

                await updateDoc(userRef, updateData);
                const statusText = document.getElementById(`ban-status-text-${docId}`);
                if(statusText) statusText.textContent = isBanned ? 'Banned' : 'Normal';
                showToast(`User status updated to ${isBanned ? 'Banned' : 'Normal'}.`, 'success');
            } catch (error) {
                showToast('Failed to update user status.', 'error');
                // Revert toggle on error
                const toggleInput = document.getElementById(`ban-toggle-${docId}`);
                if(toggleInput) toggleInput.checked = !isBanned;
            }
        }

        function addCardButtonListeners() {
            dom.userCardContainer.querySelectorAll('.edit-user-btn').forEach(button => button.addEventListener('click', (e) => openEditUserModal(e.currentTarget.dataset.docId)));
            dom.userCardContainer.querySelectorAll('.delete-user-btn').forEach(button => button.addEventListener('click', (e) => handleDeleteUser(e.currentTarget.dataset.docId, e.currentTarget.dataset.username)));
            dom.userCardContainer.querySelectorAll('.copy-btn').forEach(button => button.addEventListener('click', (e) => {
                navigator.clipboard.writeText(e.currentTarget.dataset.text).then(() => showToast('Device ID copied!', 'success')).catch(() => showToast('Failed to copy.', 'error'));
            }));
                         dom.userCardContainer.querySelectorAll('.ban-toggle-input').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const docId = e.target.dataset.docId;
                    const isChecking = e.target.checked;
                    
                    if (isChecking) {
                        // Jika mau memblokir, buka modal dulu
                        currentBanTargetId = docId;
                        document.getElementById('ban-reason-input').value = '';
                        document.getElementById('ban-reason-modal').style.display = 'flex';
                    } else {
                        // Jika membuka blokir, langsung eksekusi
                        handleBanToggle(docId, false);
                    }
                });
            });
        }

        function addTransactionCardButtonListeners() {
             dom.pendingTransactionContainer.querySelectorAll('.action-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const target = e.currentTarget;
                    const action = target.dataset.action;
                    const docId = target.dataset.docId;
                    switch(action) {
                        case 'accept-topup': handleAcceptTransaction(docId); break;
                        case 'reject-topup': handleRejectTransaction(docId); break;
                        case 'accept-sub': handleAcceptSubscription(docId); break;
                        case 'reject-sub': handleRejectSubscription(docId); break;
                        case 'accept-sale': handleAcceptAccountSale(docId); break;
                        case 'reject-sale': handleRejectAccountSale(docId); break;
                        // MODIFIED: ADDED THESE CASES
                        case 'accept-purchase': handleAcceptAkunPurchase(docId); break;
                        case 'reject-purchase': handleRejectAkunPurchase(docId); break;
                    }
                });
            });
        }
        
        function addStokAkunCardButtonListeners() {
            dom.stokAkunCardContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-stok-akun-btn');
                const deleteBtn = e.target.closest('.delete-stok-akun-btn');
                const resetBtn = e.target.closest('.reset-owner-btn');

                if (editBtn) openEditStokAkunModal(editBtn.dataset.docId);
                if (deleteBtn) handleDeleteStokAkun(deleteBtn.dataset.docId, deleteBtn.dataset.username);
                if (resetBtn) handleResetOwner(resetBtn.dataset.docId, resetBtn.dataset.type);
            });
        }
         function addStokKredensialCardButtonListeners() {
            dom.stokKredensialCardContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-stok-kredensial-btn');
                const deleteBtn = e.target.closest('.delete-stok-kredensial-btn');
                const resetBtn = e.target.closest('.reset-owner-btn');

                if (editBtn) openEditStokKredensialModal(editBtn.dataset.docId);
                if (deleteBtn) handleDeleteStokKredensial(deleteBtn.dataset.docId, deleteBtn.dataset.email);
                if (resetBtn) handleResetOwner(resetBtn.dataset.docId, resetBtn.dataset.type);
            });
        }// --- START: Live Chat Event Listeners ---
document.getElementById('floating-chat-send').addEventListener('click', () => {
    const messageText = chatDom.chatText.value.trim();
    if (messageText) sendAdminReply(messageText, 'text');
});
document.getElementById('floating-chat-text').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { // Kirim jika Enter ditekan (tanpa Shift)
        e.preventDefault();
        const messageText = chatDom.chatText.value.trim();
        if (messageText) sendAdminReply(messageText, 'text');
    }
});

// Listener untuk tombol attach file
document.getElementById('admin-chat-attach-btn').addEventListener('click', () => {
    document.getElementById('admin-chat-file-input').click();
});

document.getElementById('admin-chat-file-input').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
        showToast("Hanya file gambar yang diizinkan.", 'error');
        return;
    }
    if (file.size > 3700000) { // Batas ~3.5MB
        showToast("Ukuran gambar terlalu besar. Maksimal ~3.5 MB.", 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        const base64String = e.target.result;
        showToast('Mengirim gambar...', 'success');
        sendAdminReply(base64String, 'image');
    };
    reader.onerror = (e) => {
        console.error("Gagal membaca file:", e);
        showToast("Gagal memuat gambar.", 'error');
    };
    reader.readAsDataURL(file);
    event.target.value = null; // Reset input file
});

// Listener untuk tombol di header chat
document.getElementById('floating-chat-header').addEventListener('click', (e) => {
    // Hanya minimize jika klik di header, BUKAN di tombol
    if (e.target.id === 'floating-chat-header' || e.target.id === 'floating-chat-username') {
        minimizeFloatingChat();
    }
});
document.getElementById('floating-chat-minimize').addEventListener('click', minimizeFloatingChat);
document.getElementById('floating-chat-close').addEventListener('click', closeFloatingChat);
document.getElementById('floating-chat-clear').addEventListener('click', () => {
    if (activeChatSessionId) {
        handleClearChat(activeChatSessionId);
    }
});

// Listener untuk tombol "Pesan Baru" & daftar chat (Delegasi event)
dom.views.liveChat.addEventListener('click', (e) => {
    const newChatBtn = e.target.closest('#new-chat-message-btn');
    const sessionItem = e.target.closest('.chat-session-item');
    
    if (newChatBtn) {
        openNewChatModal();
    } else if (sessionItem) {
        const sessionId = sessionItem.dataset.sessionId;
        openFloatingChat(sessionId);
    }
});

// Listener untuk modal "Pesan Baru"
document.getElementById('new-chat-search').addEventListener('input', (e) => {
    populateNewChatUserList(e.target.value);
});
document.getElementById('new-chat-user-list').addEventListener('click', (e) => {
    const userItem = e.target.closest('.new-chat-user-item');
    if (userItem) {
        const username = userItem.dataset.username;
        handleStartChatButtonClick(username); // Fungsi ini akan membuka chat
        document.getElementById('new-chat-modal').style.display = 'none'; // Tutup modal
    }
});

// Listener untuk tombol hapus per pesan (delegasi event)
document.getElementById('floating-chat-messages').addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('.chat-delete-btn');
    if (deleteBtn && activeChatSessionId) {
        const messageId = deleteBtn.dataset.messageId;
        handleDeleteMessage(activeChatSessionId, messageId);
    }
});

// Listener untuk tombol "Mulai Chat" di kartu user (User Management View)
dom.views.users.addEventListener('click', (e) => {
    const startChatButton = e.target.closest('[data-action="start-chat"]');
    if (startChatButton) {
        const username = startChatButton.dataset.username;
        handleStartChatButtonClick(username);
    }
});
        // --- Mod Buyers Management ---
        const openModBuyersModal = async (modId, modName) => {
            const modal = document.getElementById('mod-buyers-window');
            const listContainer = document.getElementById('mod-buyers-list');
            const title = document.getElementById('mod-buyers-title');
            
            modal.style.display = 'flex';
            title.textContent = `Pembeli: ${modName}`;
            listContainer.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--text-secondary);"><i class="fas fa-spinner fa-spin"></i> Memuat data...</p>';

            try {
                // Mengambil data dari purchase_history
                const q = query(collection(db, "purchase_history"), 
                    where("game", "==", "MOD SHOP"), 
                    where("ubAmount", "==", `Beli MOD: ${modName}`),
                    where("status", "==", "Success")
                );
                const snapshot = await getDocs(q);
                
                // Filter duplikat user
                const buyersMap = new Map();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (!buyersMap.has(data.userId)) {
                        buyersMap.set(data.userId, { 
                            ...data, 
                            historyId: doc.id,
                            date: data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString('id-ID') : 'N/A'
                        });
                    }
                });

                if (buyersMap.size === 0) {
                    listContainer.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--text-secondary);">Belum ada pembeli untuk MOD ini.</p>';
                    return;
                }

                listContainer.innerHTML = '';
                buyersMap.forEach((buyer) => {
                    const item = document.createElement('div');
                    item.className = 'buyer-list-item';
                    item.innerHTML = `
                        <div class="buyer-info">
                            <span class="buyer-name"><i class="fas fa-user"></i> ${buyer.username}</span>
                            <span class="buyer-date">Dibeli: ${buyer.date}</span>
                        </div>
                        <button class="revoke-btn" onclick="handleRevokeMod('${buyer.userId}', '${modId}', '${buyer.username}', '${buyer.historyId}')">
                            <i class="fas fa-ban"></i> Hapus Akses
                        </button>
                    `;
                    listContainer.appendChild(item);
                });

            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<p style="text-align:center; color:var(--danger-primary);">Gagal memuat data.</p>';
            }
        };

        window.handleRevokeMod = (userId, modId, username, historyId) => {
            showConfirmation(`Hapus akses MOD untuk user <b>${username}</b>? User tidak akan bisa mendownload lagi.`, 'Hapus Akses', 'btn-danger', async () => {
                try {
                    // 1. Hapus dari subkoleksi user
                    await deleteDoc(doc(db, "users", userId, "myMods", modId));
                    
                    // 2. Update status di history (opsional, agar tidak muncul lagi di list)
                    if (historyId) {
                       await updateDoc(doc(db, "purchase_history", historyId), { status: "Revoked by Admin" });
                    }
                    
                    // 3. Update stok count (opsional)
                    // const modRef = doc(db, "stokMod", modId);
                    // await updateDoc(modRef, { sold: increment(-1) }); 

                    showToast(`Akses untuk ${username} berhasil dicabut.`, 'success');
                    // Refresh list pembeli dengan menutup dan membuka ulang (atau refresh manual)
                    document.getElementById('mod-buyers-window').style.display = 'none';
                } catch (e) {
                    console.error(e);
                    showToast('Gagal menghapus akses.', 'error');
                }
            });
        };

        document.getElementById('close-mod-buyers').addEventListener('click', () => {
            document.getElementById('mod-buyers-window').style.display = 'none';
        });
// --- END: Live Chat Event Listeners ---
onAuthStateChanged(auth, (user) => {
            if (user) {
                dom.loginPage.style.display = 'none';
                dom.adminPanel.style.display = 'flex';
                isFloatingModalShown = false; // Reset on login
                cleanupListeners(); // Hapus listener lama jika ada (untuk mencegah duplikasi)
                setupRealtimeListeners(); // Siapkan listener baru
                syncPresenceFromRtdbToFirestore();

                // --- START: Baca Status Admin Saat Login ---
                get(adminStatusRef).then((snapshot) => {
                    const isOnline = snapshot.val();
                    document.getElementById('admin-online-toggle').checked = (isOnline === true);
                }).catch((err) => {
                    console.error("Gagal membaca status admin: ", err);
                });
                // --- END: Baca Status Admin Saat Login ---

                showMainMenu();
            } else {
                dom.loginPage.style.display = 'flex';
                dom.adminPanel.style.display = 'none';
                cleanupListeners(); // Hapus listener saat logout
            }
        });

        setupEventListeners();
    </script>
</body>
</html>