<!DOCTYPE html>
<html lang=id>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Bussid&Trucksid SHOP</title>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel=stylesheet>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel=stylesheet>
<script src=https://unpkg.com/@phosphor-icons/web></script>
<style>
:root{--bg-primary:#111827;--bg-secondary:#1f2937;--bg-tertiary:#374151;--border-color:#4b5563;--text-primary:#f9fafb;--text-secondary:#d1d5db;--accent-blue:#3b82f6;--accent-green:#22c55e;--accent-red:#ef4444;--accent-cyan:#06b6d4;--premium-gold:#fbbf24}*{margin:0;padding:0;box-sizing:border-box}html,body{font-family:'Inter',sans-serif;background-color:var(--bg-primary);color:var(--text-primary);-webkit-user-select:none;user-select:none;font-size:10px}#app-layout{display:none;flex-direction:column;min-height:100vh;width:100%}

/* --- Start: Rombak Header --- */
#top-navbar{display:flex;flex-direction:column;background-color:var(--bg-secondary);position:sticky;top:0;z-index:1001;box-shadow:0 4px 12px rgba(0,0,0,0.4);border-bottom:1px solid var(--border-color);}
.header-brand{padding:8px 12px;text-align:center;border-bottom:1px solid var(--border-color)}
.header-brand h1{font-size:1.4em;font-weight:900;line-height:1;color:transparent;background:linear-gradient(45deg,#3b82f6,#06b6d4,#22c55e);-webkit-background-clip:text;background-clip:text;text-shadow:0 2px 8px rgba(0,0,0,0.3)}
.subtitle-brand{display:block;font-size:.4em;font-weight:500;color:var(--text-secondary);margin-top:2px}
#page-title-header{font-size:1em;font-weight:700;color:var(--text-primary);text-align:center;padding:6px 12px;background-color:var(--bg-primary);}
#top-navbar nav{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding:6px 10px;border-top:1px solid var(--border-color);border-bottom:1px solid var(--border-color)}
#top-navbar nav::-webkit-scrollbar{display:none}
.sidebar-nav{display:flex;justify-content:space-around;gap:5px;list-style:none;padding:0;flex-wrap:nowrap}
.nav-item a{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:5px;border-radius:6px;color:var(--text-secondary);text-decoration:none;font-weight:600;font-size:.8em;white-space:nowrap;transition:all .3s ease-in-out;background-color:var(--bg-tertiary);border:1px solid var(--border-color);width:48px;height:42px}
.nav-item a:hover{color:var(--text-primary);border-color:var(--accent-blue);transform:translateY(-2px);}
.nav-item a.active{background:linear-gradient(45deg, var(--accent-blue), #2563eb);color:white;font-weight:700;border-color:var(--accent-blue);box-shadow:0 0 15px rgba(59,130,246,0.4)}
.nav-icon{font-size:1.5em;transition:all .3s ease}.nav-icon-img{width:22px;height:22px;border-radius:4px;object-fit:cover;transition:all .3s ease}
.nav-text{display:none!important}
.header-actions-bar{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px 12px;}
.sidebar-balance-card{display:flex;align-items:center;gap:8px;background-color:var(--bg-tertiary);padding:5px 10px;border-radius:20px;border:1px solid var(--border-color);cursor:pointer;transition:all .2s ease;flex-grow:1; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}
.sidebar-balance-card:hover{border-color:var(--accent-blue);transform:scale(1.02)}
.balance-info{text-align:left;flex-grow:1;overflow:hidden;}.sidebar-balance-card .balance-label{display:block;font-size:.7em;color:var(--text-secondary);line-height:1.1}
.sidebar-balance-card .balance-amount{display:block;font-size:.8em;font-weight:700;color:var(--accent-green);line-height:1.2}
.sidebar-balance-card .balance-username{display:block;font-size:.75em;font-weight:600;color:var(--text-primary);line-height:1.1;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;margin-bottom:2px}
.sidebar-balance-card .balance-amount.premium,.sidebar-balance-card .balance-amount.subscription,.sidebar-balance-card .balance-amount.admin{color:var(--premium-gold);font-size:.75em}
.add-balance-icon{font-size:1.6em;color:var(--accent-green);cursor:pointer;transition:transform .2s;display:flex;align-items:center;justify-content:center;background-color:rgba(34,197,94,0.1); border-radius: 50%; width: 26px; height: 26px;}
.add-balance-icon:hover{transform:scale(1.1); background-color:rgba(34,197,94,0.2);}
.header-actions{display:flex;align-items:center;gap:8px}
.header-action-btn{display:flex;align-items:center;justify-content:center;padding:0!important;font-size:1.5em!important;line-height:1;background-color:var(--bg-tertiary);width:36px;height:36px;border-radius:50%;border:1px solid var(--border-color); transition: all 0.2s ease;}
.header-action-btn:hover{transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.3);}
#cs-admin-btn{color:var(--accent-cyan)}#cs-admin-btn:hover{background-color:var(--accent-cyan);color:white}
#header-my-account-btn{color:var(--text-secondary)}#header-my-account-btn:hover{background-color:var(--accent-blue); color: white;}
#logout-btn{color:var(--accent-red)} #logout-btn:hover{background-color:var(--accent-red); color: white;}
#logout-btn i{font-size:1em!important}
.logout-text{display:none!important}
/* --- End: Rombak Header --- */

.main-content{padding:10px;min-height:100vh;background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhI8j1iJeFgIagFemTu0q3_yxUph06s4T6K03apxFf11HmQagnDM-PkaUNlV-VK0k2O-Mj93P4cnVZSWjf6jbmt1imTeAP_woH6aUMEsp9YgyMzCdHNoixyuWtvUf9pmhXlYIvwVt1Tb9CuSFi-Jk6D3pB6-ggMzhKMGkpoJD9ZT-d5T3LcJkW4d_mfGLA/s1600/1750238969835.jpg');background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:center}.content-container{max-width:1200px;margin:0 auto}.content-card{max-width:600px;margin:0 auto;background-color:var(--bg-secondary);padding:12px 15px;border-radius:12px;border:1px solid var(--border-color)}

/* --- Start: Login Page Redesign --- */
#auth-wrapper{display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;padding:16px;background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi7vQ0Y3_j_i_8-b-c-d_e-f_g_h-i-j-k_l-m_n-o-p_q-r_s-t_u-v_w-x_y-z/s1600/maleo-store-bg.jpeg');background-size:cover;background-position:center;gap:15px}
#login-container,#register-container,#forgot-password-container{width:100%;max-width:400px;background-color:rgba(17, 24, 39, 0.8);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:25px 30px;border-radius:16px;border:1px solid var(--border-color);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.login-header h1{font-size:1.8em;font-weight:900;color:transparent;background:linear-gradient(45deg,#3b82f6,#06b6d4,#22c55e);-webkit-background-clip:text;background-clip:text;text-shadow:0 2px 8px rgba(0,0,0,0.3)}
#login-container h2 {font-size: 1.5em; text-align: center;}
#login-container .subtitle {text-align: center;}
/* --- End: Login Page Redesign --- */

#register-container,#forgot-password-container{display:none}
#app-layout,#profile-container,#topup-container,#buy-ub-container,#qris-display-container,#my-account-container,#subscription-container,#subscription-qris-container,#stok-akun-container,#jual-akun-container{display:none}
h2{font-size:1.3em;font-weight:700;margin-bottom:8px;color:var(--text-primary)}.subtitle{font-size:.8em;color:var(--text-secondary);margin-bottom:15px}.input-group{margin-bottom:12px;position:relative}.input-group .input-icon{position:absolute;top:50%;left:13px;transform:translateY(-50%);color:var(--text-secondary);font-size:1.1em}.input-field{width:100%;padding:10px 12px 10px 40px;background-color:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.9em}.input-field.password-input{padding-right:40px}.password-toggle{position:absolute;top:50%;right:10px;transform:translateY(-50%);cursor:pointer;color:var(--text-secondary);width:20px;height:20px}.input-field:focus{outline:0;border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(59,130,246,0.2)}.action-button{width:100%;padding:10px;border-radius:8px;color:white;font-size:1em;font-weight:600;cursor:pointer;border:0;transition:all .2s ease}.action-button:hover{opacity:.9;transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,0.2)}.action-button:disabled{background-color:var(--bg-tertiary);cursor:not-allowed;opacity:.7}.btn-green{background-color:var(--accent-green)}.btn-primary{background:linear-gradient(45deg,var(--accent-blue),#2563eb)}.btn-red{background-color:var(--accent-red)}.btn-secondary{background-color:var(--bg-tertiary)}.btn-cyan{background-color:var(--accent-cyan)}.switch-link{margin-top:15px;font-size:.85em;color:var(--text-secondary);text-align:center}.switch-link a{color:var(--accent-blue);text-decoration:none;font-weight:600}.switch-link a:hover{text-decoration:underline}.switch-link.admin-link{margin-top:8px;font-size:0.75em}#other-account-form-container{padding:8px 12px;max-width:300px;margin:0 auto}#other-account-form-container .subtitle{font-size:.7em;margin-bottom:8px;line-height:1.3}
#all-profiles-grid{display:grid;grid-template-columns:1fr;gap:12px}
.profile-card{background-color:#2d2e33;border-radius:8px;border:1px solid var(--border-color);position:relative;overflow:hidden;transition:transform .3s ease,box-shadow .3s ease;perspective:1000px;display:flex;flex-direction:column;width:100%;max-width:350px;margin:0 auto}
.profile-card.hidden{display:none}.profile-card:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,0.2)}.profile-card-main-view,.profile-card-settings-view{padding:10px;display:flex;flex-direction:column;backface-visibility:hidden;transition:transform .6s ease;width:100%;flex-grow:1}.profile-card-main-view{transform:rotateY(0deg)}.profile-card-settings-view{position:absolute;top:0;left:0;right:0;bottom:0;background-color:var(--bg-secondary);transform:rotateY(180deg)}.profile-card.settings-active .profile-card-main-view{transform:rotateY(-180deg)}.profile-card.settings-active .profile-card-settings-view{transform:rotateY(0deg)}.profile-card-settings-view h3{font-size:.75em;margin-bottom:6px}.settings-info-item{padding:1px 5px;margin-bottom:2px}.settings-info-item .label{font-size:.55em;line-height:1.1}.settings-info-item .value{font-size:.65em;line-height:1.1}.settings-actions{margin-top:8px}.settings-actions .action-button{padding:4px;font-size:.65em}.player-display-container{margin:6px 0 8px 0;display:flex;flex-direction:column;gap:5px}
.player-name-plate,.player-ub-plate{background-size:100% 100%;background-repeat:no-repeat;background-position:center;height:38px;display:flex;align-items:center;justify-content:space-between;padding:0 10px;width:78%;margin:0 auto;border-radius:6px}
.player-name-plate{background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiy8bkfRaz2UWiO9tnX8IDy9OJwti__IkaN5CBSsybGTzWG7_sSqWTmOBRj0X3NEQQv1cW1thZcmPSjVcpS2JSamwsCN4_u_QQqzdYa7BhyfM8QwQAsPMVeokL1rUfxRAZx_s_46Gb27M1u40kP55xVpyjBgBcuDGs-CD9t0B4IgnkyS9DS228u_sgdkc4/s1600/IMG_20250812_161453.jpg')}.player-ub-plate{background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhJhoq7BI37iRAjcjRibzR3_-YgzMDy00OkGH_omg-c8FC1K2OmJdgyhiw8ARhhbLa7Bnip1h9_nBk2bdPJ3lhsdjgi9NTL43KQSH8Z4g8pT7RQLnUzdqqZc8Sn1ZZJm_3zJ-WwEhnWGCyW8cIAE_u8HewZspCCvr7l-EHkq8ln3pAXe_MkVVOx-9WA5UM/s1600/IMG_20250812_161504.jpg')}.player-name-text,.player-ub-text{color:#fff;font-weight:700;font-size:.765em;text-shadow:1px 1px 2px rgba(0,0,0,0.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-grow:1;text-align:center}.plate-icon{font-size:1.2em;color:white;cursor:pointer;opacity:.8;transition:opacity .2s,transform .2s;flex-shrink:0}.plate-icon:hover{opacity:1;transform:scale(1.1)}.plate-icon-placeholder{width:1.2em;flex-shrink:0}.info-banner{border:1px solid var(--accent-green);color:var(--text-primary);background-color:rgba(34,197,94,0.1);padding:10px 12px;border-radius:6px;text-align:center;font-weight:500;margin-bottom:15px;font-size:.8em}.current-balance-display{color:var(--text-secondary);background-color:var(--bg-primary);padding:8px 10px;border-radius:6px;margin-bottom:12px;text-align:center;font-size:.9em}.current-balance-display span{font-weight:700;color:var(--accent-green);font-size:1em}.ub-store-display{background:var(--bg-tertiary);border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid var(--border-color)}.display-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.display-label{font-weight:600;color:var(--text-secondary);font-size:.85em}.display-value{font-weight:700;font-size:1.1em}.display-value.rp{color:#f59e0b}.display-value.ub{color:var(--accent-green)}#ub-slider{width:100%;margin:6px 0}.buy-ub-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}.buy-ub-extra-actions{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px}.hasil-text.error{background-color:#991b1b;color:#fee2e2;margin-top:12px;padding:8px;border-radius:6px;font-weight:600;display:block;font-size:.85em}

/* --- Start: Topup Saldo Redesign --- */
#topup-container h2 { text-align: center; font-size: 1.5em; }
#topup-container .subtitle { text-align: center; }
.topup-card-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 20px 0; }
.topup-card { background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
.topup-card:hover { transform: translateY(-4px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); border-color: var(--accent-blue); }
.topup-card .amount { font-size: 1.4em; font-weight: 800; color: var(--text-primary); margin-bottom: 5px; }
.topup-card .icon { font-size: 2.5em; color: var(--accent-green); margin-bottom: 10px; }
.topup-card .label { font-size: 0.9em; font-weight: 600; }
.custom-topup-section { margin-top: 20px; }
.custom-topup-section .subtitle { margin-bottom: 10px; }
#custom-topup-form .input-group { display: flex; align-items: center; background-color: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color); padding: 0 10px; }
#custom-topup-form .input-group:focus-within { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.2); }
#custom-topup-form .input-field { border: none; background: transparent; padding: 10px 0; font-size: 1.1em; text-align: center; letter-spacing: 1px; }
#custom-topup-form .input-field:focus { outline: 0; box-shadow: none; }
#custom-topup-form .rp-prefix { font-size: 1.1em; font-weight: 700; color: var(--text-secondary); }
#topup-pending-view { padding: 20px; text-align: center; }
/* --- End: Topup Saldo Redesign --- */

#qris-display-container img,#subscription-qris-container img{width:100%;max-width:200px;border-radius:8px;margin-bottom:12px;background:white;cursor:pointer}.important-notice{background-color:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.5);padding:10px;border-radius:6px;margin-bottom:15px}.important-notice .notice-title{font-weight:700;color:#f59e0b;display:block;margin-bottom:4px;font-size:.9em}.important-notice .notice-amount{font-weight:700;color:#fff;font-size:1.2em;letter-spacing:1px}.history-section{margin-top:25px;padding-top:20px;border-top:1px solid var(--border-color)}.history-section h3{font-size:1.2em;margin-bottom:12px;text-align:center}.history-tables-container{display:grid;grid-template-columns:1fr;gap:20px}.history-table h4{font-size:.9em;margin-bottom:10px;color:var(--text-secondary)}.history-list{list-style:none;max-height:300px;overflow-y:auto;padding-right:6px;border:1px solid var(--border-color);border-radius:6px;padding:6px}.history-list li{background-color:var(--bg-tertiary);padding:10px;border-radius:6px;margin-bottom:6px;border-left:3px solid var(--border-color)}.history-list li.topup{border-left-color:var(--accent-green)}.history-list li.purchase{border-left-color:var(--accent-red)}.history-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}.history-item-header .amount{font-size:1em;font-weight:700}.history-item-header .amount.topup{color:var(--accent-green)}.history-item-header .amount.purchase{color:var(--accent-red)}.history-item-footer{font-size:.7em;color:var(--text-secondary)}.history-list .no-history{text-align:center;padding:12px;color:var(--text-secondary);background:0;border:0}#toast-container{position:fixed;top:15px;right:15px;z-index:10005;display:flex;flex-direction:column;align-items:flex-end;gap:10px;pointer-events:none}.toast{background:rgba(55,65,81,0.9);color:#fff;padding:10px 15px;border-radius:6px;box-shadow:0 6px 25px rgba(0,0,0,0.3);min-width:220px;max-width:320px;text-align:center;font-size:.9em;font-weight:600;border-left-width:4px;border-left-style:solid;border-left-color:var(--border-color);pointer-events:all;opacity:0;transform:translateX(100%);transition:all .3s ease-in-out}.toast.show{opacity:1;transform:translateX(0)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10002;display:none;padding:16px}.modal-content{background-color:var(--bg-secondary);padding:20px;border-radius:10px;width:100%;max-width:450px;position:relative;border:1px solid var(--border-color)}.modal-close{position:absolute;top:10px;right:12px;font-size:2em;color:var(--text-secondary);cursor:pointer;line-height:1}.modal-warning{background-color:rgba(239,68,68,0.1);border:1px solid var(--accent-red);padding:10px;border-radius:6px;margin-top:12px;margin-bottom:15px;color:var(--text-primary)}.modal-warning p{margin-bottom:6px;line-height:1.5;font-size:.85em}.modal-actions{display:flex;flex-direction:column;gap:10px}.modal-actions .action-button{text-align:center;text-decoration:none;padding:8px;font-size:.9em}.account-info-details{margin-top:20px;margin-bottom:25px;border-top:1px solid var(--border-color);padding-top:12px}.info-row{display:flex;justify-content:space-between;align-items:center;padding:10px 6px;border-bottom:1px solid var(--border-color);flex-wrap:wrap;gap:5px}.info-row:last-child{border-bottom:0}.info-label{font-weight:500;color:var(--text-secondary);font-size:.9em}.info-value{font-weight:600;font-size:.95em;text-align:right}.info-value.accent-green{color:var(--accent-green)}.info-value.premium,.info-value.subscription,.info-value.admin{color:var(--premium-gold)}.info-value.small-text{font-size:.8em;font-family:monospace;word-break:break-all;cursor:pointer}.account-actions{display:flex;flex-direction:column;gap:10px}#akun-showcase-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-top:20px}.akun-card{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;overflow:hidden;padding:15px;font-size:.8em;transition:all .3s ease}.akun-card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,0.25);border-color:var(--accent-cyan)}.akun-card-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}.akun-card-logo{width:40px;height:40px;border-radius:8px}.akun-card h3{font-size:1.6em;margin-bottom:0;color:var(--text-primary)}.akun-card .info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px 10px;margin-bottom:12px}.akun-card .info-item{background-color:var(--bg-tertiary);padding:6px 8px;border-radius:6px}.akun-card .info-label{display:block;font-size:.9em;color:var(--text-secondary);margin-bottom:3px}.akun-card .info-value{font-size:1.2em;font-weight:700}.akun-card .info-value.price{color:var(--accent-green);font-size:1.5em}.akun-card .info-additional{margin-top:12px;padding-top:10px;border-top:1px solid var(--border-color)}.akun-card .info-additional .info-label{margin-bottom:4px}.akun-card .info-additional .info-value{font-size:1em;font-weight:400;white-space:pre-wrap;color:var(--text-primary)}.akun-card-footer{margin-top:15px}.lightbox-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:10004}.lightbox-content{position:relative;max-width:90vw;max-height:90vh}.lightbox-content img{width:100%;height:100%;object-fit:contain;border-radius:8px}.lightbox-close{position:absolute;top:-35px;right:0;font-size:2.5em;color:#fff;cursor:pointer;line-height:1;font-weight:700}.skeleton-card{background-color:var(--bg-secondary);padding:12px;border-radius:10px;border:1px solid var(--border-color)}.skeleton{animation:skeleton-loading 1s linear infinite alternate;opacity:.7;background-color:var(--bg-tertiary)}@keyframes skeleton-loading{0%{background-color:var(--bg-tertiary)}100%{background-color:#4b5563}}.skeleton-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}.skeleton-avatar{width:40px;height:40px;border-radius:50%}.skeleton-text-group{flex-grow:1}.skeleton-text{height:14px;border-radius:4px;margin-bottom:6px}.skeleton-text.short{width:50%}.skeleton-line{height:8px;border-radius:4px;margin-bottom:8px}.skeleton-button{height:34px;border-radius:6px;margin-top:12px}
#maintenance-modal .modal-content{text-align:center;max-width:400px;background-color:var(--bg-primary);border: 1px solid var(--premium-gold);}
#maintenance-modal i {font-size: 3em;color: var(--premium-gold);margin-bottom: 15px;}
#maintenance-modal-message{font-size:1em;line-height:1.6;color:var(--text-secondary);margin-bottom:0}

#confirmation-modal .modal-content { max-width: 380px; }
.invoice-style-confirmation { font-family: 'Courier New', Courier, monospace; background-color: #f5f5f5; color: #333; padding: 15px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.9em; }
.invoice-style-confirmation h4 { text-align: center; margin-bottom: 10px; font-size: 1.1em; border-bottom: 1px dashed #333; padding-bottom: 5px; }
.invoice-style-confirmation .invoice-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
.invoice-style-confirmation .invoice-row.total { font-weight: bold; border-top: 1px solid #333; padding-top: 5px; margin-top: 10px; font-size: 1.1em; }
.invoice-style-confirmation .invoice-row .price { text-align: right; }
#confirmation-modal{z-index:10003}
.error-message{color:#fca5a5;font-size:.8rem;margin-top:.4rem;min-height:1.1rem}
#admin-price-modal .modal-content{background:var(--bg-primary);border-color:var(--border-color)}.modal-header-custom{display:flex;align-items:center;gap:10px;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}.modal-header-custom .ph-bold{font-size:1.5em;color:var(--accent-cyan)}.modal-header-custom h2{margin-bottom:0;font-size:1.2em}
.price-option-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.8rem;max-height:60vh;overflow-y:auto;padding-right:5px}.price-option{background-color:var(--bg-tertiary);border:1px solid var(--border-color);transition:all .2s ease;padding:.8rem;border-radius:.5rem;cursor:pointer;text-align:left;display:flex;flex-direction:column;justify-content:space-between}.price-option:hover{transform:translateY(-3px);box-shadow:0 6px 15px rgba(0,0,0,0.2);border-color:var(--accent-cyan)}.price-option.selected{border-color:var(--accent-cyan);box-shadow:0 0 15px rgba(6,182,212,0.3);transform:translateY(-3px);background-color:var(--bg-secondary)}.price-option .ph-coins{display:none}.price-option .amount{font-weight:700;font-size:.9em;color:var(--text-primary);line-height:1.3;margin-bottom:8px}.price-option .price{font-size:.8em;font-weight:600;background-color:var(--bg-primary);color:var(--accent-green);padding:3px 8px;border-radius:5px;display:inline-block;margin-top:.5rem;border:1px solid var(--border-color)}
#admin-game-choice-container{text-align:center}.admin-choice-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-top:15px}.admin-choice-btn{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:25px 15px;cursor:pointer;transition:all .2s ease-in-out;font-size:1.2em;font-weight:700;color:var(--text-primary)}.admin-choice-btn:hover{transform:translateY(-4px);box-shadow:0 6px 20px rgba(0,0,0,0.2);border-color:var(--accent-cyan)}.admin-choice-btn .game-icon{font-size:2.2em;display:block;margin-bottom:10px}.back-button{background:0;border:0;color:var(--accent-blue);cursor:pointer;font-weight:600;margin-bottom:12px;font-size:.85em;padding:4px}.back-button:hover{text-decoration:underline}
.joki-warning-box{background:rgba(153,27,27,0.15);color:var(--text-primary);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(252,165,165,0.4);font-size:0.8em}.joki-warning-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}.joki-warning-header .ph-warning-octagon{font-size:1.8em;color:#fca5a5}.joki-warning-header h3{font-size:1.1em;font-weight:700;color:white;margin:0}.joki-warning-box p.warning-intro{font-size:0.9em;line-height:1.5;margin:8px 0;color:#fee2e2}.joki-warning-box p.warning-intro strong{color:white}.joki-warning-box .warning-points{display:flex;flex-direction:column;gap:8px;margin:10px 0}.joki-warning-box .warning-item{display:flex;align-items:flex-start;gap:8px}.joki-warning-box .warning-icon{font-size:1.2em;color:#fca5a5;margin-top:1px}.joki-warning-box .warning-text{font-size:0.9em;line-height:1.5;color:#fee2e2}.joki-warning-box .warning-text strong{color:white}.joki-warning-box .wa-input-section{margin-top:10px;padding-top:10px;border-top:1px solid rgba(252,165,165,0.2)}.joki-warning-box .wa-label{font-weight:600;display:block;margin-bottom:6px;font-size:1em;color:white}.joki-warning-box .input-field{background-color:rgba(0,0,0,0.2);border-color:#fca5a5;color:white;padding-top:8px;padding-bottom:8px;font-size:0.9em}.joki-warning-box .input-field::placeholder{color:rgba(254,202,202,0.7)}.joki-warning-box .input-field:focus{border-color:white;box-shadow:0 0 0 2px rgba(255,255,255,0.2)}
.fb-login-style-container{background-color:#fff;font-family:'Helvetica','Arial',sans-serif;color:#1c1e21;border-radius:8px;padding:0;overflow:hidden;max-width:420px;margin:0 auto;border:1px solid #dddfe2}.fb-login-style-container .input-field{background-color:#f5f6f7;border:1px solid #dddfe2;color:#1c1e21}.fb-login-style-container .input-field::placeholder{color:#90949c}.fb-login-style-container .input-field:focus{border-color:#1877f2;box-shadow:0 0 0 2px #e7f3ff}.fb-login-style-container .error-message,.gmail-login-style-container .error-message{color:#fa3e3e;text-align:left}.fb-login-header{padding:12px;text-align:center;border-bottom:1px solid #dddfe2}.fb-login-header img{height:30px}.fb-login-body{padding:15px}.action-button.btn-fb{background-color:#1877f2;font-weight:700;border-radius:6px}.fb-login-links{text-align:center;margin-top:12px}.fb-login-links a{color:#1877f2;text-decoration:none;font-weight:500;font-size:.85em}.gmail-login-style-container{background-color:#fff;font-family:'Roboto','Arial',sans-serif;color:#202124;border:1px solid #dadce0;border-radius:8px;padding:40px 30px 30px;max-width:450px;margin:0 auto;text-align:center}.gmail-login-style-container .input-field{background-color:#fff;border:1px solid #ccc;color:#202124;border-radius:4px}.gmail-login-style-container .input-field:focus{border-color:#1a73e8;box-shadow:0 0 0 1px #1a73e8}.gmail-logo{width:70px;margin-bottom:12px}.gmail-header h1{font-size:22px;font-weight:400;margin-bottom:6px}.gmail-header p{font-size:14px;margin-bottom:20px}.gmail-form .input-group{margin-bottom:12px}.gmail-links{text-align:left;margin:12px 0}.gmail-links a{font-family:'Roboto',sans-serif;color:#1a73e8;text-decoration:none;font-weight:500;font-size:13px}.gmail-actions{display:flex;justify-content:space-between;align-items:center;margin-top:28px}.gmail-actions .create-account-link{font-family:'Roboto',sans-serif;color:#1a73e8;text-decoration:none;font-weight:500;font-size:13px;background:0;border:0;cursor:pointer;padding:8px 0}.action-button.btn-gmail{background-color:#1a73e8;padding:0 20px;height:32px;line-height:32px;font-size:13px;font-weight:500;width:auto}#offline-modal .modal-content{text-align:center}#offline-modal .subtitle{margin-bottom:0}#subscription-expired-modal .modal-content{text-align:center;border-color:var(--accent-red)}#subscription-expired-modal .modal-content h2{color:var(--accent-red)}.subscription-grid{display:grid;grid-template-columns:1fr;gap:20px;margin-top:20px}.subscription-card{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:20px;text-align:center;transition:all .3s ease;display:flex;flex-direction:column}.subscription-card:hover{transform:translateY(-5px);border-color:var(--accent-blue)}.subscription-card.premium{border-left:4px solid var(--accent-blue)}.subscription-card.permanent{border-left:4px solid var(--accent-green)}.subscription-card h3{font-size:1.2em;margin-bottom:10px;color:var(--text-primary)}.subscription-card .sub-price{font-size:1.8em;font-weight:800;margin-bottom:15px}.subscription-card .promo-price{color:var(--accent-blue)}.subscription-card.permanent .sub-price{color:var(--accent-green)}.subscription-card .original-price{text-decoration:line-through;color:var(--text-secondary);font-size:.6em;margin-left:8px;font-weight:500}.subscription-card .sub-price .sub-duration{font-size:.5em;font-weight:500;color:var(--text-secondary)}.subscription-card ul{list-style:none;padding:0;margin:20px 0;text-align:left;font-size:.9em;flex-grow:1}.subscription-card ul li{margin-bottom:10px;display:flex;align-items:center;gap:8px;color:var(--text-secondary)}.subscription-card ul li .ph-bold{font-size:1.2em}.subscription-card ul li .ph-check-circle{color:var(--accent-green)}.subscription-card .action-button{margin-top:auto}#status-modal-content h4{font-size:1.1em;color:var(--premium-gold);margin-bottom:10px;text-align:center}#status-modal-content p{color:var(--text-secondary);text-align:center;margin-bottom:20px;font-size:.9em}#status-modal-content ul{list-style:none;padding:0;margin-top:15px}#status-modal-content ul li{background-color:var(--bg-primary);padding:8px 12px;border-radius:6px;margin-bottom:6px;font-size:.85em}.login-header{text-align:center;margin-bottom:15px}.promo-list{list-style:none;padding:12px;margin:15px 0;background-color:rgba(0,0,0,0.2);border-radius:8px;font-size:.8em}.promo-list li{display:flex;align-items:flex-start;gap:8px;margin-bottom:8px;line-height:1.5}.promo-list li:last-child{margin-bottom:0}.promo-list i{color:var(--accent-green);font-size:1.2em;margin-top:2px}
/* --- Start: Captcha --- */
.captcha-group { background-color: var(--bg-primary); border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.captcha-question { font-size: 1.2em; font-weight: 700; color: var(--text-secondary); user-select: none; letter-spacing: 2px; }
#captcha-input { width: 80px; text-align: center; font-size: 1.2em; font-weight: 700; padding: 5px; }
/* --- End: Captcha --- */
@media screen and (min-width:768px){
.logout-text{display:inline-block}
.nav-text{display:inline-block;margin-left:8px;font-size: 0.95em;}
.nav-icon-img{display:inline-block!important;vertical-align:middle}.history-tables-container{grid-template-columns:1fr 1fr}.price-option-grid{grid-template-columns:repeat(3,1fr)}.admin-choice-grid{grid-template-columns:1fr 1fr}.subscription-grid{grid-template-columns:repeat(3,1fr)}
#akun-showcase-grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
#all-profiles-grid{grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap: 20px;}
}
@media screen and (min-width: 1024px) {
    .nav-text { font-size: 1em; } /* Ukuran normal di layar besar */
}
@media screen and (max-width:767px){
.nav-item a .nav-icon-img{margin-right:0}
.nav-text { font-size: 3.2vw; } /* Ukuran fleksibel di mobile */
}
@media screen and (max-width:480px){h2{font-size:1.2em}.subtitle{font-size:.75em}.content-card{padding:10px 15px}#login-container,#register-container,#forgot-password-container{padding:20px 25px}.info-banner,.important-notice{padding:8px;font-size:.8em}#akun-showcase-grid{grid-template-columns:1fr}.modal-content{padding:15px}.history-tables-container{gap:12px}.history-list li{padding:8px}#topup-options-grid{grid-template-columns:1fr}.buy-ub-actions,.buy-ub-extra-actions{grid-template-columns:1fr}.gmail-login-style-container{padding:25px 15px 20px}.fb-login-body{padding:12px}.subscription-grid{grid-template-columns:1fr}
.nav-text { font-size: 3.5vw; }
.topup-card-grid { grid-template-columns: 1fr; }
}
.akun-card .credential-info-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}.akun-card .credential-item{display:flex;align-items:center;background-color:var(--bg-tertiary);padding:8px 10px;border-radius:6px}.akun-card .credential-label{font-size:.9em;color:var(--text-secondary);flex-basis:100px}.akun-card .credential-value{font-size:1.1em;font-weight:700;flex-grow:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.akun-card .copy-btn{background:none;border:none;color:var(--accent-blue);font-size:1.4em;cursor:pointer;padding:0 5px;margin-left:10px}.akun-card .processing-status{text-align:center;padding:20px;font-size:1.1em;font-weight:700;color:var(--accent-cyan)}
.admin-choice-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}.admin-choice-logo{width:48px;height:48px;border-radius:10px;object-fit:cover}

/* --- Start: Beli Akun Card Redesign --- */
#stok-akun-header-controls { background-color: var(--bg-secondary); padding: 12px; border-radius: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); }
#stok-akun-header-controls h2 { text-align: center; margin-bottom: 12px; }
#stok-akun-header-controls .subtitle { text-align: center; margin-bottom: 12px; }
.stok-akun-controls-wrapper { display: flex; flex-direction: column; gap: 8px; }
#beli-akun-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.game-column h3 { text-align: center; margin-bottom: 10px; font-size: 1.1em; color: var(--text-secondary); }
#stok-akun-grid-bussid, #stok-akun-grid-trucksid {display:grid; grid-template-columns: 1fr; gap:10px}
#purchased-akun-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px}

.stok-akun-card{background: rgba(42, 58, 80, 0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border:1px solid rgba(75, 85, 99, 0.6);border-radius:10px;padding:8px;transition:all .3s ease;display:flex;flex-direction:column;gap:6px;font-size:.7em;box-shadow:0 4px 15px rgba(0,0,0,0.4);position:relative;overflow:hidden}
.stok-akun-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px}
.stok-akun-card.bussid-card::before{background:var(--accent-blue)}
.stok-akun-card.trucksid-card::before{background:var(--accent-green)}
.stok-akun-card:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,0.35);border-color:var(--accent-cyan)}
.stok-akun-card.owned{border-left:3px solid var(--accent-cyan)}.stok-akun-card .stok-card-header{display:flex;align-items:center;gap:6px;padding-bottom:5px;border-bottom:1px solid var(--border-color);justify-content: space-between;}.stok-akun-card .stok-card-logo{width:20px;height:20px;border-radius:5px}.stok-akun-card h3{font-size:1em;margin:0;color:var(--text-primary)}.stok-akun-card .info-grid{display:grid;grid-template-columns:1fr;gap:4px}.stok-akun-card .info-item{background-color:rgba(0,0,0,0.2);padding:4px;border-radius:4px}.stok-akun-card .info-label{display:flex;align-items:center;gap:3px;font-size:.7em;color:var(--text-secondary);margin-bottom:2px}.stok-akun-card .info-label i{font-size:1.1em}.stok-akun-card .info-value{font-size:.8em;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.stok-akun-card .price .info-value{color:var(--accent-green);font-size:.9em}.stok-akun-card .unlocked-grid{display:flex;flex-direction:column;gap:5px}.stok-akun-card .unlocked-item{display:flex;align-items:center;background-color:var(--bg-tertiary);padding:5px 6px;border-radius:4px}.stok-akun-card .unlocked-label{font-size:.8em;color:var(--text-secondary);flex-basis:50px}.stok-akun-card .unlocked-value{font-family:monospace;font-size:.9em;font-weight:600;flex-grow:1}.stok-akun-card .copy-icon{color:var(--accent-blue);cursor:pointer;margin-left:auto;font-size:1.1em}
.stok-akun-card .action-button {font-size: 0.8em; padding: 5px; margin-top: auto;}
/* MODIFIKASI: Style untuk header akun terbeli yang menonjol */
.purchased-header-info {
    padding: 8px;
    background-color: rgba(0,0,0,0.2);
    border-radius: 6px;
    margin-bottom: 8px;
    text-align: center;
}
.purchased-username {
    font-size: 1.3em;
    font-weight: 800;
    color: var(--text-primary);
    display: block;
    line-height: 1.2;
}
.purchased-ub {
    font-size: 1.1em;
    font-weight: 700;
    color: var(--accent-green);
    display: block;
}
/* AKHIR MODIFIKASI */
.purchased-info-display { margin-top: 5px; border-top: 1px solid var(--border-color); padding-top: 5px; font-size: 0.9em; }
.purchased-info-row { display: flex; justify-content: space-between; align-items: center; }
.purchased-info-row .label { color: var(--text-secondary); }
.purchased-info-row .value { font-weight: 700; }
/* --- End: Beli Akun Card Redesign --- */

.ub-fill-section{margin-top:12px;padding-top:8px;border-top:1px solid var(--border-color)}.ub-fill-section h4{font-size:.85em;margin-bottom:8px;color:var(--text-primary)}.ub-fill-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}.ub-fill-btn{background-color:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:6px 4px;border-radius:5px;cursor:pointer;font-weight:600;font-size:.7em;transition:all .2s ease}.ub-fill-btn:hover{background-color:var(--accent-green);border-color:var(--accent-green)}.ub-fill-section .input-group{margin-top:8px}
#akun-purchase-modal .modal-content { max-height: 80vh; transform: scale(0.95); transform-origin: center; }
#akun-purchase-modal h4{margin-top:15px;margin-bottom:8px;border-bottom:1px solid var(--border-color);padding-bottom:5px}
#akun-purchase-details{font-size:.9em;max-height:150px;overflow-y:auto;background-color:var(--bg-primary);padding:8px;border-radius:6px;line-height:1.5;color:var(--text-secondary)}
#akun-purchase-total{margin-top:15px;text-align:center;font-size:1.2em}#akun-purchase-total span{font-weight:bold;color:var(--accent-green)}

/* --- Start: Jual Akun & Status Display --- */
#jual-akun-area .jual-akun-info{background-color:var(--bg-tertiary);border:1px solid var(--accent-cyan);padding:12px;border-radius:8px;font-size:.8em;line-height:1.5;color:var(--text-primary);text-align:center;}
#jual-akun-area .action-button { margin-top: 10px; background: linear-gradient(45deg, var(--accent-cyan), #0891b2); box-shadow: 0 4px 15px rgba(6, 182, 212, 0.2); }
#jual-akun-status-display { display: none; margin-top: 15px; background-color: var(--bg-primary); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center; }
#jual-akun-status-display .status-title { font-size: 1em; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }
#jual-akun-status-display .status-text { font-size: 1.2em; font-weight: 800; }
#jual-akun-status-display .status-text.processed { color: var(--accent-cyan); }
#jual-akun-status-display .status-text.completed { color: var(--accent-green); }
/* --- End: Jual Akun & Status Display --- */

#sell-account-floating-menu{position:fixed;bottom:0;left:0;right:0;background-color:var(--bg-secondary);padding:15px;border-top:1px solid var(--border-color);z-index:1002;transform:translateY(100%);transition:transform 0.3s ease-in-out;max-height:90vh;overflow-y:auto}
#sell-account-floating-menu.visible{transform:translateY(0)}
.sell-account-item{display:flex;align-items:center;justify-content:space-between;padding:8px;background-color:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;font-size:0.9em}
.sell-account-item .info{display:flex;align-items:center;gap:10px}
.sell-account-item .price{font-weight:700;color:var(--accent-green)}
.sdk-checkbox-container{display:flex;align-items:flex-start;gap:10px;background:rgba(251,191,36,0.1);border:1px solid var(--premium-gold);padding:10px;border-radius:6px;margin:10px 0}
.sdk-checkbox-container input{margin-top:4px}
.sdk-checkbox-container label{font-size:0.85em;line-height:1.5}
.payment-options-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:15px 0}
.payment-option-btn{background-color:var(--bg-tertiary);border:1px solid var(--border-color);padding:10px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:600;color:var(--text-primary)}
.payment-option-btn.selected{border-color:var(--accent-green);background-color:rgba(34,197,94,0.1)}
.payment-option-btn img{height:20px}
.stok-akun-filter-buttons { display: flex; gap: 5px; background-color:var(--bg-primary); padding:4px; border-radius:8px;}
.stok-akun-filter-buttons .filter-btn { padding: 5px 10px; font-size: 0.8em; font-weight: 600; border: none; background-color: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
.stok-akun-filter-buttons .filter-btn.active { background-color: var(--accent-blue); color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }

#admin-profile-modal .modal-content, #sell-status-modal .modal-content { text-align: center; }
#admin-profile-modal .admin-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent-cyan); margin-bottom: 10px; }
#admin-profile-modal .admin-info { font-size: 0.9em; line-height: 1.6; color: var(--text-secondary); margin-bottom: 20px; }
#admin-profile-modal .admin-socials { display: flex; gap: 15px; justify-content: center; }
#admin-profile-modal .social-btn { display: flex; align-items: center; gap: 8px; padding: 8px 15px; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.2s ease; }
#admin-profile-modal .social-btn.whatsapp { background-color: #25D366; color: white; }
#admin-profile-modal .social-btn.instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; }
#admin-profile-modal .social-btn i { font-size: 1.4em; }
#sell-status-modal .status-account-list { list-style: none; padding: 0; margin-top: 15px; max-height: 50vh; overflow-y: auto; }
#sell-status-modal .status-account-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-primary); padding: 10px; border-radius: 6px; margin-bottom: 8px; }
#sell-status-modal .status-value { font-weight: 700; }
#sell-status-modal .status-value.processed { color: var(--accent-cyan); }
#sell-status-modal .status-value.completed { color: var(--accent-green); }

/* --- Start: Rework Tampilan Toko UB --- */
#buy-ub-container {
    padding: 10px 15px;
    max-width: 450px;
    margin: 0 auto;
    font-size: 0.9em; /* Perkecil font dasar di card ini */
}
#buy-ub-container h2 {
    font-size: 1.3em; /* Sesuaikan ukuran font relatif terhadap parent */
    margin-bottom: 8px;
}
.player-info-display {
    font-size: 0.9em; /* Sedikit lebih kecil */
    margin-bottom: 10px;
}
.ub-store-display .display-row {
    align-items: center;
    margin-bottom: 8px;
}
#ub-display-row .display-label {
    flex-shrink: 0;
    margin-right: 10px;
    font-size: 1em;
}
#ub-input {
    flex-grow: 1;
    text-align: right;
    font-weight: 700;
    color: var(--accent-green);
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 1.2em; /* Ukuran font input */
    width: auto;
}
#ub-input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(59,130,246,0.2);
    border-color: var(--accent-blue);
}
.ub-input-group {
    margin: 10px 0 !important;
    padding: 0;
    display: block;
}
#ub-slider {
    width: 100%;
}
.buy-ub-extra-actions {
    grid-template-columns: 1fr;
    margin-bottom: 8px;
}
.buy-ub-actions {
    grid-template-columns: 1fr 1fr;
}
.buy-ub-actions .action-button, .buy-ub-extra-actions .action-button {
    font-size: 1em;
    padding: 9px;
}
/* --- End: Rework Tampilan Toko UB --- */

#maintenance-notice {
    display: none; /* Initially hidden */
    text-align: center;
    background-color: var(--bg-secondary);
    padding: 25px;
    border-radius: 16px;
    border: 1px solid var(--premium-gold);
}
#maintenance-notice i {
    font-size: 3em;
    color: var(--premium-gold);
    margin-bottom: 15px;
}
#welcome-message-modal .modal-content {
    text-align: center;
}
#welcome-message-content {
    font-size: 1em;
    line-height: 1.6;
    color: var(--text-secondary);
    margin-bottom: 25px;
    white-space: pre-wrap; /* To respect newlines from admin input */
}
</style>
</head>
<body style="visibility:hidden;opacity:0;transition:opacity .5s">
<div id=toast-container></div>
<div id=auth-wrapper>
<div id="maintenance-notice">
    <i class="ph-fill ph-warning-octagon"></i>
    <h2>Dalam Perbaikan</h2>
    <p class="subtitle" id="maintenance-message">Maaf, situs sedang dalam perbaikan rutin. Silakan coba lagi nanti.</p>
</div>
<div id=login-container>
<div class=login-header>
<h1>Bussid&Trucksid SHOP<span class=subtitle-brand>by@donitata1717Â®</span></h1>
</div>
<h2>Selamat Datang</h2>
<p class=subtitle>Masuk untuk melanjutkan ke toko.</p>
<form id=login-form>
<div class=input-group>
<i class="ph-bold ph-user input-icon"></i>
<input type=text id=username class=input-field placeholder="Nama Pengguna" required>
</div>
<div class=input-group>
<i class="ph-bold ph-lock-key input-icon"></i>
<input type=password id=password class="input-field password-input" placeholder="Kata Sandi" required>
<span class=password-toggle id=login-password-toggle></span>
</div>
<button type=submit id=login-btn class="action-button btn-primary">Masuk</button>
</form>
<ul class=promo-list>
<li><i class="ph-bold ph-star"></i><span><b>Website No.1</b> Topup & Jual Beli Akun Bussid & Trucksid terpercaya sejak 2019.</span></li>
<li><i class="ph-bold ph-shield-check"></i><span><b>100% Bergaransi</b> uang kembali jika ada masalah.</span></li>
<li><i class="ph-bold ph-users-three"></i><span><b>Pelayanan Penuh</b> oleh admin langsung, tanpa perantara, 24 jam.</span></li>
<li><i class="ph-bold ph-rocket-launch"></i><span><b>Langganan terjangkau</b> untuk kebebasan topup instan tanpa delay.</span></li>
</ul>
<p class=switch-link> Belum punya akun? <a href=# id=show-register-link>Buat akun baru</a></p>
<p class=switch-link><a href=# id=show-forgot-password-link>Lupa kata sandi</a></p>
<p class="switch-link admin-link">bukan user? <a href=panel.html>Login sebagai admin</a></p>
</div>
<div id=register-container>
<h2>Buat Akun Baru</h2>
<form id=register-form>
<div class=input-group>
<i class="ph-bold ph-user-circle input-icon"></i>
<input type=text id=reg-username class=input-field placeholder=Username required>
</div>
<div class=input-group>
<i class="ph-bold ph-at input-icon"></i>
<input type=email id=reg-email class=input-field placeholder=Email required>
</div>
<div class=input-group>
<i class="ph-bold ph-whatsapp-logo input-icon"></i>
<input type=text id=reg-whatsapp class=input-field placeholder="Nomor WhatsApp (62...)" required>
</div>
<div class=input-group>
<i class="ph-bold ph-lock-key input-icon"></i>
<input type=password id=reg-password class="input-field password-input" placeholder="Sandi Akun" required>
<span class=password-toggle id=reg-password-toggle></span>
</div>
<div class="captcha-group">
    <span id="captcha-question" class="captcha-question"></span>
    <input type="number" id="captcha-input" class="input-field" placeholder="Jawaban" required>
</div>
<button type=submit id=register-btn class="action-button btn-primary">Daftar</button>
</form>
<p class=switch-link>Sudah punya akun? <a href=# id=show-login-link-from-reg>Login</a></p>
</div>
<div id=forgot-password-container>
<div id=verify-user-view>
<h2>Lupa Kata Sandi</h2>
<p class=subtitle>Masukkan data akun Anda untuk verifikasi.</p>
<form id=verify-user-form>
<div class=input-group>
<i class="ph-bold ph-user-circle input-icon"></i>
<input type=text id=verify-username class=input-field placeholder=Username required>
</div>
<div class=input-group>
<i class="ph-bold ph-at input-icon"></i>
<input type=email id=verify-email class=input-field placeholder=Email required>
</div>
<div class=input-group>
<i class="ph-bold ph-whatsapp-logo input-icon"></i>
<input type=text id=verify-whatsapp class=input-field placeholder="Nomor WhatsApp (62...)" required>
</div>
<button type=submit id=verify-user-btn class="action-button btn-primary">Verifikasi Akun</button>
</form>
<p class=switch-link>Ingat sandi Anda? <a href=# id=show-login-link-from-forgot>Login</a></p>
</div>
<div id=reset-password-view style=display:none>
<h2>Buat Sandi Baru</h2>
<p class=subtitle>Verifikasi berhasil. Silakan masukkan kata sandi baru Anda.</p>
<form id=reset-password-form>
<div class=input-group>
<i class="ph-bold ph-lock-key input-icon"></i>
<input type=password id=reset-new-password class="input-field password-input" placeholder="Sandi Baru" required>
<span class=password-toggle id=reset-password-toggle></span>
</div>
<div class=input-group>
<i class="ph-bold ph-password input-icon"></i>
<input type=password id=reset-confirm-password class=input-field placeholder="Konfirmasi Sandi Baru" required>
</div>
<button type=submit id=reset-password-btn class="action-button btn-green">Simpan Sandi Baru</button>
</form>
</div>
</div>
</div>
<div id=app-layout>
<header id=top-navbar>
    <div class="header-brand">
        <h1>Bussid&Trucksid SHOP<span class=subtitle-brand>by@donitata1717Â®</span></h1>
    </div>
    <h2 id="page-title-header"></h2>
    <nav>
        <ul class=sidebar-nav>
            <li class="nav-item"><a href=# id=nav-stok-akun><i class="ph-bold ph-shopping-bag-open nav-icon"></i><span class=nav-text>Beli Akun</span></a></li>
            <li class="nav-item"><a href=# id=nav-jual-akun><i class="ph-bold ph-tag nav-icon"></i><span class=nav-text>Jual Akun</span></a></li>
            <li class=nav-item><a href=# id=nav-topupBussid><img src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjyQYodaXJAK1A9Bi0YOIU2BhQubEYchhFx-2PZYB8hOIopqXIQ1FXK_goAxP0GPaXyXk6L5jnO3aOL6EuzkEgGxa2tohs7YJazYrVPZ8czUi8BSjWWkrTKVCTwk7wmhEZRWFPP1U2S-FjXUwDbi9duZ9ejBNm0xTLBFblyee8yY_Jk2MLtQj6v3E_bePI/s1600/Bussid.png class=nav-icon-img alt="BUSSID Icon"><span class=nav-text>Topup BUSSID</span></a></li>
            <li class=nav-item><a href=# id=nav-topupTrucksid><img src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4Q0wYqZDSD7VH-0QlvsqTDi4xnKg5NfRDLJHt92A-4qMcVNMXHpZPkGOQARhJWeZXr0VCCbMCUXJn2iAL-xbCOGELYZQqEgnJXD-VneGmLKQgjO5C9XhyphenhypheneMWD0RBl_bv3VKAGfhYxDzKLPhFjujKFMy7ITYuvLyiW-aDEp3AkM_Tn-jEAPuZXmPqarJY/s1600/images__1_-removebg-preview.png class=nav-icon-img alt="TRUCKSID Icon"><span class=nav-text>Topup TRUCKSID</span></a></li>
            <li class="nav-item user-only"><a href=# id=nav-topup><i class="ph-bold ph-wallet nav-icon"></i><span class=nav-text>Topup Saldo</span></a></li>
            <li class="nav-item user-only"><a href=# id=nav-subscription><i class="ph-bold ph-crown nav-icon"></i><span class=nav-text>Langganan</span></a></li>
        </ul>
    </nav>
    <div class="header-actions-bar">
        <div class=sidebar-balance-card>
            <div class=balance-info>
                <span class="balance-username" id="sidebar-username"></span>
                <span class=balance-label id=sidebar-balance-label>Saldo</span>
                <span class=balance-amount id=sidebar-balance-amount>Rp 0</span>
            </div>
            <span id=add-balance-btn class=add-balance-icon title="Top Up Saldo">
                <i class="ph-bold ph-plus-circle"></i>
            </span>
        </div>
        <div class="header-actions">
            <button id="cs-admin-btn" class="header-action-btn" title="Hubungi Admin"><i class="ph-bold ph-headset"></i></button>
            <button id=header-my-account-btn class="header-action-btn" title="Akun Saya">
                <i class="ph-bold ph-user-circle"></i>
            </button>
            <button id=logout-btn class="header-action-btn" title=Logout>
                <i class="ph-bold ph-sign-out"></i>
            </button>
        </div>
    </div>
</header><main class=main-content id=main-content>
<div id=my-account-container class=content-card>
<h2>Informasi Akun Saya</h2>
<div class=account-info-details>
<div class=info-row>
<span class=info-label>Username</span>
<span id=account-username class=info-value></span>
</div><div class=info-row>
<span class=info-label id=account-saldo-label>Status & Saldo</span>
<span id=account-saldo class="info-value accent-green"></span>
</div>
<div class=info-row>
<span class=info-label>Device ID</span>
<span id=account-device-id class="info-value small-text" title="Tahan untuk menyalin"></span>
</div>
<div class=info-row>
<span class=info-label>Email Terdaftar</span>
<span id=account-email class=info-value></span>
</div>
<div class=info-row>
<span class=info-label>WhatsApp Terdaftar</span>
<span id=account-whatsapp class=info-value></span>
</div>
</div>
<div class=account-actions>
<button id=change-device-id-btn class="action-button btn-secondary">Ganti Device ID</button>
<button id=change-password-btn class="action-button btn-secondary">Ubah Sandi</button>
<button id=account-logout-btn class="action-button btn-red">Logout</button>
</div>
</div>
<div id=profile-container class=content-container>
<div id=other-account-section style="margin-bottom:15px">
<div id=other-account-form-container class=content-card>
<p class=subtitle style="margin-bottom:10px; font-size: 0.75em;">Tambahkan akun via Device ID atau X-Auth Token.</p>
<form id=other-account-form>
<div class=input-group style=display:none>
<select id=other-account-game class=input-field>
<option value disabled selected>Pilih Game</option>
<option value=BUSSID>BUSSID</option>
<option value=TRUCKSID>TRUCKSID</option>
</select>
</div>
<div class=input-group style="display:flex; align-items:center; gap: 5px;">
<input type=text id=other-account-key class=input-field placeholder="Device ID / X-Auth Token" required style="font-size: 0.8em; padding-right: 35px;">
<button type="button" id="paste-key-btn" title="Tempel dari clipboard" style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.3em; color: var(--text-secondary); cursor: pointer; padding: 5px;">
<i class="ph ph-clipboard-text"></i>
</button>
</div>
<button type=submit id=find-account-btn class="action-button btn-primary" style="font-size: 0.8em; padding: 7px;">Cari & Tambah Akun</button>
</form>
</div>
</div>
<div id="search-account-section" style="margin-bottom: 20px; max-width: 450px; margin-left: auto; margin-right: auto;">
    <div class="input-group">
        <input type="text" id="search-account-input" class="input-field" placeholder="ð Cari akun berdasarkan nama atau Device ID...">
    </div>
</div>
<div id=all-profiles-grid></div>
</div>
<div id=jual-akun-container class=content-container>
    <div id="jual-akun-area">
        <div class="jual-akun-info">
            Apakah Anda ingin menjual akun Facebook/Google milik Anda? Kami bisa membelinya dengan harga Rp 2.000 - Rp 3.000.
            <br>
            Pastikan tidak terkait verifikasi 2 langkah, tidak terkait email/nomor pemulihan, dan pastikan akun Anda tidak bermasalah.
            <button id="show-sell-account-menu-btn" class="action-button">
                <i class="ph-bold ph-paper-plane-tilt"></i> Jual Akun Anda
            </button>
        </div>
        <div id="jual-akun-status-display">
            <p class="status-title">Status Penjualan Terakhir Anda</p>
            <p class="status-text" id="sell-status-text">Memuat...</p>
        </div>
    </div>
</div>
<div id=stok-akun-container class=content-container>
<div id="stok-akun-header-controls">
    <h2>Beli Akun</h2>
    <p class=subtitle>Daftar akun yang tersedia. Beli akun menggunakan saldo Anda.</p>
    <div class="stok-akun-controls-wrapper">
        <div class="stok-akun-filter-buttons">
            <button class="filter-btn active" id="show-available-btn">Tersedia</button>
            <button class="filter-btn" id="show-purchased-btn">Akun Terbeli</button>
        </div>
        <div id="stok-akun-sort-controls" class="stok-akun-filter-buttons">
            <button class="filter-btn active" data-sort="termurah">Termurah</button>
            <button class="filter-btn" data-sort="termahal">Termahal</button>
        </div>
    </div>
</div>
<div id="beli-akun-wrapper">
    <div class="game-column">
        <h3>BUSSID</h3>
        <div id="stok-akun-grid-bussid"></div>
    </div>
    <div class="game-column">
        <h3>TRUCKSID</h3>
        <div id="stok-akun-grid-trucksid"></div>
    </div>
</div>

<p id="purchased-akun-info" class="subtitle" style="display: none; text-align:center;">Harap simpan informasi login anda dengan aman.</p>
<div id="purchased-akun-grid" style="display: none;"></div>
</div>
<div id=topup-container class=content-card>
<div id=topup-options-view>
<h2>Pilih Nominal Top Up</h2>
<p class="subtitle">Pembayaran cepat dan aman via QRIS.</p>
<div class="topup-card-grid">
    <div class="topup-card" data-amount="50000">
        <i class="ph-fill ph-wallet icon"></i>
        <div class="amount">Rp 50.000</div>
        <div class="label">Paket Hemat</div>
    </div>
    <div class="topup-card" data-amount="100000">
        <i class="ph-fill ph-rocket-launch icon"></i>
        <div class="amount">Rp 100.000</div>
        <div class="label">Paket Cepat</div>
    </div>
</div>
<div class="custom-topup-section">
    <p class=subtitle>Atau masukkan jumlah lain</p>
    <form id=custom-topup-form>
        <div class=input-group>
            <span class="rp-prefix">Rp</span>
            <input type=number id=custom-amount-input class="input-field" placeholder="Minimal 10.000" min=10000 required>
        </div>
        <button type=submit class="action-button btn-primary">Lanjutkan</button>
    </form>
</div>
</div>
<div id=topup-pending-view style=display:none>
<h2>Transaksi Dalam Proses</h2>
<div class=important-notice>
<span class=notice-title>Anda memiliki transaksi yang belum selesai.</span>
<p id=pending-info-text></p>
</div>
<button id=check-status-again-btn class="action-button btn-primary">Cek Status Lagi</button>
<button id=cancel-from-pending-btn class="action-button btn-red" style=margin-top:8px>Batalkan Transaksi</button>
</div>
<div class=history-section>
<h3>Riwayat Transaksi</h3>
<div class=history-tables-container>
<div class=history-table>
<h4>Riwayat Top Up Saldo</h4>
<ul class=history-list id=topup-history-list></ul>
</div>
<div class=history-table>
<h4>Riwayat Pembelian</h4>
<ul class=history-list id=purchase-history-list></ul>
</div>
</div>
</div>
</div>
<div id=qris-display-container class=content-card>
<h2>Scan untuk Membayar</h2>
<div style=text-align:center>
<img id=qris-image src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifsIlVyECfE7iW14IC6-_Ot5pFguYRxkupdUFmzeAHMBDgMJ_KXJs14w3C6k1w7sY2cr2aFoAA7YBQWNtQC_JA8CjE3qyrdi0Rhes3aJ7czf_Qkui6Ha128LUN6fCI0DcazF2Inm9EivNZmiiQciH8XwLQad19BFXIlrOevmgHICqm9vALCXBYn2o7cj4/s1600/IMG_20250629_202856.jpg alt="QRIS Code">
</div>
<div class=important-notice>
<span class=notice-title>PENTING: Transfer Sesuai Nominal Unik</span>
<span id=qris-amount-display class=notice-amount>Rp 0</span>
</div>
<div class=buy-ub-actions>
<button id=cancel-qris-btn class="action-button btn-red">Batalkan Transaksi</button>
<button id=confirm-payment-btn class="action-button btn-green">Saya Sudah Transfer</button>
</div>
</div><div id=buy-ub-container class=content-card>
<h2>Toko UB (<span id=buy-ub-game-name></span>)</h2>
<div id=buy-ub-balance-display-wrapper class=current-balance-display>Saldo Akun Anda: <span id=buy-ub-current-saldo>Rp 0</span></div>
<div class=player-info-display>
<p>Nama Player: <span id=player-name-display></span></p>
<p>UB yang dimiliki: <span id=player-ub-display></span></p>
</div>
<div class=ub-store-display>
<div class="display-row" id="ub-display-row">
<span class=display-label>Jumlah UB:</span>
<input type="text" inputmode="numeric" id="ub-input" class="input-field" placeholder="0" maxlength="12">
</div>
<div class=display-row id=rp-display-row>
<span class=display-label>Harga:</span>
<span class="display-value rp" id=rp-display>Rp 0</span>
</div>
</div>
<div class="ub-input-group">
<input type="range" min="0" max="100" value="0" step="0.1" class="input-field" id="ub-slider" style="padding: 0;">
</div>
<form id=buy-ub-form>
<div id=buy-ub-error class="hasil-text error" style=display:none></div>
<div class=buy-ub-extra-actions>
<button id=confirm-buy-ub-btn type=submit class="action-button btn-green">Tambah UB</button>
</div>
<div class=buy-ub-actions>
<button type=button id=cancel-buy-ub-btn class="action-button btn-secondary">Batal</button>
<button type=button id=max-ub-btn class="action-button btn-primary">Max UB</button>
</div>
</form>
</div>
<div id=subscription-container class=content-container>
<div id=subscription-packages-view>
<h2>Paket Langganan</h2>
<p class=subtitle>Pilih paket untuk menikmati fitur-fitur eksklusif tanpa batas.</p>
<div class=subscription-grid>
<div class=subscription-card>
<h3>User Biasa</h3>
<p class=sub-price>GRATIS</p>
<ul>
<li><i class="ph-bold ph-check-circle"></i>Akses dasar ke aplikasi</li>
<li><i class="ph-bold ph-check-circle"></i>Top-up UB menggunakan saldo</li>
</ul>
<button class="action-button btn-secondary" disabled>Paket Anda Saat Ini</button>
</div>
<div class="subscription-card premium">
<h3>Langganan Bulanan</h3>
<p class=sub-price>
<span class=promo-price>Rp 35.000</span>
<span class=original-price>Rp 65.000</span>
<span class=sub-duration>/ bulan</span>
</p>
<ul>
<li><i class="ph-bold ph-check-circle"></i>Top-up UB tanpa batas (GRATIS)</li>
<li><i class="ph-bold ph-check-circle"></i>Akses Joki via Admin (GRATIS)</li>
<li><i class="ph-bold ph-check-circle"></i>Tanpa perlu top-up saldo</li>
</ul>
<button id=buy-monthly-sub-btn class="action-button btn-primary">Beli Langganan</button>
</div>
<div class="subscription-card permanent">
<h3>Premium Permanen</h3>
<p class=sub-price>Rp 199.000 <span class=sub-duration>/ sekali bayar</span></p>
<ul>
<li><i class="ph-bold ph-check-circle"></i>Semua keuntungan Langganan Bulanan</li>
<li><i class="ph-bold ph-check-circle"></i>Top-up UB tanpa batas (GRATIS)</li>
<li><i class="ph-bold ph-check-circle"></i>Tanpa perlu Top-up Saldo</li>
<li><i class="ph-bold ph-check-circle"></i>Akses premium selamanya</li>
<li><i class="ph-bold ph-check-circle"></i>Satu kali pembayaran</li>
<li><i class="ph-bold ph-check-circle"></i>Dukungan prioritas dari admin</li>
</ul>
<button id=buy-permanent-sub-btn class="action-button btn-green">Beli Premium</button>
</div>
</div>
</div>
</div>
<div id=subscription-qris-container class=content-card>
<h2>Pembayaran Langganan</h2>
<p class=subtitle id=sub-qris-package-name style=text-align:center;font-weight:bold;color:var(--text-primary)></p>
<div style=text-align:center>
<img id=sub-qris-image src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifsIlVyECfE7iW14IC6-_Ot5pFguYRxkupdUFmzeAHMBDgMJ_KXJs14w3C6k1w7sY2cr2aFoAA7YBQWNtQC_JA8CjE3qyrdi0Rhes3aJ7czf_Qkui6Ha128LUN6fCI0DcazF2Inm9EivNZmiiQciH8XwLQad19BFXIlrOevmgHICqm9vALCXBYn2o7cj4/s1600/IMG_20250629_202856.jpg alt="QRIS Code">
</div>
<div class=important-notice>
<span class=notice-title>PENTING: Transfer Sesuai Nominal Unik</span>
<span id=sub-qris-amount-display class=notice-amount>Rp 0</span>
</div>
<p class=subtitle style=text-align:center;font-weight:600 id=sub-qris-timer>Batal Otomatis dalam: 06:00:00</p>
<div class=buy-ub-actions>
<button id=cancel-sub-qris-btn class="action-button btn-red">Batalkan Transaksi</button>
<button id=confirm-sub-payment-btn class="action-button btn-green">Saya Sudah Transfer</button>
</div>
</div>
</main>
</div><div id=device-id-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-device-id-modal-btn>Ã</span>
<h2>Cara Mendapatkan Device ID</h2>
<div class=modal-warning>
<p><strong>PERINGATAN:</strong></p>
<p>Download bussid 3.6.1 Dan Canary di bawah ini lalu instal, sebelum itu hapus bussid anda terlebih dahulu!</p>
<p>Setelah bussid 3.6.1 dan canary telah diinstal, Klik tombol "Tutorial Menggunakan" untuk lanjut!.</p>
</div>
<div class=modal-actions>
<a href="https://d.apkpure.net/b/XAPK/com.maleo.bussimulatorid?versionCode=200635" target=_blank class="action-button btn-primary">Bussid 3.6.1</a>
<a href="https://d.apkpure.com/b/APK/com.guoshi.httpcanary?versionCode=19" target=_blank class="action-button btn-primary">Canary</a>
<a href="https://m.youtube.com/watch?v=kGtflL4TdyM&pp=0gcJCfwAo7VqN5tD" target=_blank class="action-button btn-green">Tutorial Menggunakan</a>
</div>
</div>
</div>
<div id=account-status-modal class=modal-overlay><div class=modal-content>
<span class=modal-close id=close-status-modal-btn>Ã</span>
<h2 id=status-modal-title>Kelebihan Akun</h2>
<div id=status-modal-content></div>
</div>
</div>
<div id=change-device-id-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-device-id-modal>Ã</span>
<h2>Ganti Device ID</h2>
<form id=change-device-id-form>
<div class=input-group>
<input type=text id=new-device-id class=input-field placeholder="Masukkan Device ID Baru (16 Karakter)" required minlength=16 maxlength=16>
</div>
<button type=submit class="action-button btn-primary">Simpan Device ID</button>
</form>
</div>
</div>
<div id=change-password-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-password-modal>Ã</span>
<h2>Ubah Sandi</h2>
<form id=change-password-form>
<div class=input-group>
<input type=password id=new-password class=input-field placeholder="Masukkan Sandi Baru" required>
</div>
<div class=input-group>
<input type=password id=confirm-new-password class=input-field placeholder="Konfirmasi Sandi Baru" required>
</div>
<button type=submit class="action-button btn-primary">Simpan Sandi</button>
</form>
</div>
</div>
<div id=reduce-ub-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-reduce-ub-modal>Ã</span>
<div style=text-align:center;margin-bottom:20px>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256">
<path d=M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm48-88a8,8,0,0,1-8,8H88a8,8,0,0,1,0-16h80A8,8,0,0,1,176,128Z></path>
</svg>
</div>
<h2 style=text-align:center>Kurangi Uang Game (UB)</h2>
<p class=subtitle style=text-align:center;max-width:350px;margin-left:auto;margin-right:auto>Masukkan jumlah UB yang ingin Anda kurangi dari akun game. Tindakan ini tidak akan mengurangi saldo Rupiah Anda.</p>
<div class=modal-warning style=background-color:rgba(239,68,68,0.1);border-color:var(--accent-red);margin-top:0;margin-bottom:25px>
<p style=margin:0><strong>Peringatan:</strong> Pastikan jumlah yang dimasukkan benar. Pengurangan UB tidak dapat dibatalkan.</p>
</div>
<form id=reduce-ub-form>
<div class=input-group>
<input type=number id=reduce-ub-amount class=input-field placeholder="Contoh: 50000" required min=1>
</div>
<button type=submit id=confirm-reduce-ub-btn class="action-button btn-red">Konfirmasi & Kurangi UB</button>
</form>
</div>
</div><div id=image-lightbox class=lightbox-overlay>
<span class=lightbox-close id=close-lightbox-btn>Ã</span>
<div class=lightbox-content>
<img src alt="Tampilan Penuh" id=lightbox-image>
</div>
</div>
<div id=confirmation-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=confirm-modal-close-btn>Ã</span>
<h2 id=confirm-modal-title>Konfirmasi Pembelian</h2>
<p id=confirm-modal-message class=subtitle style=margin-bottom:25px;line-height:1.6></p>
<div class=modal-actions style=flex-direction:row;gap:15px>
<button id=confirm-modal-cancel-btn class="action-button btn-secondary" style=width:50%>Batal</button>
<button id=confirm-modal-confirm-btn class="action-button btn-green" style=width:50%>Konfirmasi</button>
</div>
</div>
</div>
<div id=akun-purchase-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-akun-purchase-modal-btn>Ã</span>
<h2>Beli Akun</h2>
<form id=akun-purchase-form>
<input type=hidden id=purchase-stok-id>
<p class=subtitle>Atur nama game baru sebelum membeli.</p>
<div class=input-group>
<i class="ph-bold ph-user-circle input-icon"></i>
<input type=text id=purchase-new-username class=input-field placeholder="Masukkan Username Game Baru" required>
</div>
<h4 style="margin-top:15px;margin-bottom:8px;border-bottom:1px solid var(--border-color);padding-bottom:5px">Detail Akun</h4>
<div id=akun-purchase-details style="font-size:.9em;max-height:150px;overflow-y:auto;background-color:var(--bg-primary);padding:8px;border-radius:6px;line-height:1.5;color:var(--text-secondary)"></div>
<div id=akun-purchase-total style="margin-top:15px;text-align:center;font-size:1.2em">Total Harga: <span>Memuat...</span></div>
<button type=submit class="action-button btn-green" style="margin-top:15px">Beli Akun</button>
</form>
</div>
</div>
<div id=maintenance-modal class="modal-overlay" style="z-index: 10006;">
    <div class="modal-content">
        <i class="ph-fill ph-warning-octagon"></i>
        <h2>Dalam Perbaikan</h2>
        <p id="maintenance-modal-message"></p>
    </div>
</div>
<div id=offline-modal class=modal-overlay>
<div class=modal-content>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256" style=margin-bottom:20px>
<path d=M128,24a104,104,0,1,0,232,128,104.11,104.11,0,0,0-128-24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-112a8,8,0,0,1,8-8h0a8,8,0,0,1,8,8v48a8,8,0,0,1-8,8h0a8,8,0,0,1-8-8ZM128,176a12,12,0,1,1,12-12A12,12,0,0,1,128,176Z></path>
</svg>
<h2 style=margin-bottom:15px>Koneksi Terputus</h2>
<p class=subtitle>Anda sedang OFFLINE atau koneksi Internet anda bermasalah, mohon cek koneksi internet anda!!!</p>
</div>
</div>
<div id=subscription-expired-modal class=modal-overlay>
<div class=modal-content>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256" style=margin-bottom:20px>
<path d=M128,24a104,104,0,1,0,232,128,104.11,104.11,0,0,0-128-24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-112a8,8,0,0,1,8-8h0a8,8,0,0,1,8,8v48a8,8,0,0,1-8,8h0a8,8,0,0,1-8-8ZM128,176a12,12,0,1,1,12-12A12,12,0,0,1,128,176Z></path>
</svg>
<h2>Masa Aktif Habis</h2>
<p class=subtitle style=line-height:1.6;margin-bottom:25px>Masa Aktif Akun Anda Telah Berakhir. Harap hubungi Admin @donitata1717@dt17corp untuk memperpanjang.</p>
</div>
</div>
<div id="welcome-message-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" id="close-welcome-modal-btn">Ã</span>
        <h2 id="welcome-message-title">Pesan dari Admin</h2>
        <p id="welcome-message-content"></p>
        <div class="modal-actions">
            <button id="ok-welcome-modal-btn" class="action-button btn-primary">Mengerti</button>
        </div>
    </div>
</div>
<div id="sell-account-floating-menu">
    <div id="sell-step-1">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="font-size: 1.2em;">Jual Akun Anda</h3>
            <span class="modal-close" id="close-sell-menu-btn">Ã</span>
        </div>
        <div id="sell-account-list" style="margin-bottom: 15px;">
            <p class="subtitle" id="no-sell-account-msg">Anda belum menambahkan akun untuk dijual.</p>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.1em; font-weight: bold;">
            <span>Total Bayaran:</span>
            <span id="sell-total-price" style="color: var(--accent-green);">Rp 0</span>
        </div>
        <button id="add-account-to-sell-btn" class="action-button btn-primary" style="margin-bottom: 10px;">
            <i class="ph-bold ph-plus-circle"></i> Tambah Akun untuk Dijual
        </button>
        <button id="process-sell-btn" class="action-button btn-green" disabled>JUAL AKUN</button>
    </div>

    <div id="sell-step-2" style="display: none;">
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <button id="back-to-sell-list-btn" class="back-button" style="margin-right: 10px; font-size: 1.5em; padding: 0;"><i class="ph-bold ph-arrow-left"></i></button>
            <h3 style="font-size: 1.2em;">Tambah Akun</h3>
        </div>
        <form id="add-sell-account-form">
            <div class="input-group">
                <label for="sell-login-type" class="subtitle" style="margin-bottom: 5px; display: block;">Jenis Login</label>
                <select id="sell-login-type" class="input-field" required>
                    <option value="" disabled selected>Pilih Jenis Login</option>
                    <option value="Google">Google</option>
                    <option value="Facebook">Facebook</option>
                </select>
            </div>
            <div id="sell-google-inputs" style="display: none;">
                <div class="input-group">
                    <input type="email" id="sell-google-email" class="input-field" placeholder="Email Google">
                </div>
                <div class="input-group">
                    <input type="password" id="sell-google-password" class="input-field" placeholder="Sandi">
                </div>
            </div>
            <div id="sell-facebook-inputs" style="display: none;">
                <div class="input-group">
                    <input type="text" id="sell-facebook-credential" class="input-field" placeholder="Email / No. HP / Username">
                </div>
                <div class="input-group">
                    <input type="password" id="sell-facebook-password" class="input-field" placeholder="Sandi">
                </div>
            </div>
            <div class="sdk-checkbox-container">
                <input type="checkbox" id="sell-sdk-agree" required>
                <label for="sell-sdk-agree">Akun harus dalam kondisi tidak terkait Nomor/email pemulihan!!! Pastikan sudah tidak terkait.</label>
            </div>
            <button type="submit" class="action-button btn-primary">Tambah Akun</button>
        </form>
    </div>

    <div id="sell-step-3" style="display: none;">
        <h3 style="font-size: 1.2em; margin-bottom: 15px;">Detail Pembayaran</h3>
        <p class="subtitle">Admin akan membayarkan <strong><span id="payment-total-amount" style="color: var(--accent-green);"></span></strong> kepada Anda.</p>
        <form id="sell-payment-form">
            <label class="subtitle">Pilih Metode Pembayaran:</label>
            <div class="payment-options-grid">
                <button type="button" class="payment-option-btn" data-payment="Dana">Dana</button>
                <button type="button" class="payment-option-btn" data-payment="Ovo">OVO</button>
                <button type="button" class="payment-option-btn" data-payment="Gopay">GoPay</button>
                <button type="button" class="payment-option-btn" data-payment="S-Pay">ShopeePay</button>
            </div>
            <div class="input-group">
                <input type="tel" id="sell-payment-phone" class="input-field" placeholder="Nomor HP E-Wallet" required>
            </div>
            <button type="submit" class="action-button btn-green">Oke, Kirim ke Admin</button>
        </form>
    </div>
    
    <div id="sell-step-4" style="display: none;">
        <h3 style="font-size: 1.2em; text-align: center; margin-bottom: 10px;">Penjualan Akun dalam Proses</h3>
        <p class="subtitle" style="text-align: center;">Ini membutuhkan waktu cukup lama. <strong>Admin sedang mengecek akun secara manual.</strong></p>
        <div id="processing-account-list" style="margin: 15px 0;">
            </div>
        <div style="text-align: center; font-size: 1.1em; font-weight: bold;">
            Status: <span id="sell-status-display" style="color: var(--accent-cyan);">Di Proses</span>
        </div>
        <button id="close-sell-process-view-btn" class="action-button btn-secondary" style="margin-top: 15px;">Tutup</button>
    </div>
</div>

<div id="admin-profile-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" id="close-admin-profile-modal-btn">Ã</span>
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-D-aJ8x_Wu0k_4yL-h2Jb0jQ1wG-m2a3G1zB3n2a3H1j2B1H1G2B1h1g-h2j_b0jQ1wG-m2a3G1zB3n2a3/s1600/avatar.png" alt="Admin Avatar" class="admin-avatar">
        <h2>Admin @donitata1717</h2>
        <p class="admin-info">
            Hai saya admin panggil saja Doni, jika butuh bantuan atau kendala masalah silakan hubungi saya, biasanya saya aktif antara jam 8.00 sampai 00.00 tetapi kalo lagi sibuk biasanya saya off jadi silakan hubungi saya jika saya lihat akan langsung saya balas. terimakasihððð
        </p>
        <div class="admin-socials">
            <a href="https://wa.me/6285156776974" target="_blank" class="social-btn whatsapp">
                <i class="ph-bold ph-whatsapp-logo"></i>
                <span>WhatsApp</span>
            </a>
            <a href="https://www.instagram.com/donitata1717" target="_blank" class="social-btn instagram">
                <i class="ph-bold ph-instagram-logo"></i>
                <span>Instagram</span>
            </a>
        </div>
    </div>
</div>

<div id="sell-status-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" id="close-sell-status-modal-btn">Ã</span>
        <h2>Status Penjualan Akun</h2>
        <div id="sell-status-content">
            <p class="subtitle">Belum ada data penjualan.</p>
        </div>
    </div>
</div><script type=module>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFirestore, doc, onSnapshot, query, collection, where, getDocs, updateDoc, getDoc, addDoc, serverTimestamp, orderBy, limit, setDoc, deleteDoc, Timestamp, writeBatch, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyB3KJT9eh42V6ytLoY5e4ozzDXY4sHhado", authDomain: "donitata1717-f10f7.firebaseapp.com", projectId: "donitata1717-f10f7", storageBucket: "donitata1717-f10f7.appspot.com", messagingSenderId: "760325542999", appId: "1:760325542999:web:be97c17580f64407e33f12" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const TELEGRAM_BOT_TOKEN = "7899731117:AAEpxfFIMiTR_Y-L8ad-VRR5qBF1y5kg4t4"; // Token untuk notif pembayaran, jual akun, dll.
        const userActionBotToken = "8409996364:AAGoO10QZJqNEUdNOuy9vkwsdB89m_-s-TI"; // Token khusus notif login, logout, topup, daftar.
        const TELEGRAM_CHAT_ID = "7348139166";
        const formBotToken = "7899731117:AAEpxfFIMiTR_Y-L8ad-VRR5qBF1y5kg4t4";
        const formChatId = "7348139166";

        const gameConfigs = {
            "BUSSID": { name: "BUSSID", icon: "ð", host: '4ae9.playfabapi.com', titleId: '4AE9', profileImage: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjyQYodaXJAK1A9Bi0YOIU2BhQubEYchhFx-2PZYB8hOIopqXIQ1FXK_goAxP0GPaXyXk6L5jnO3aOL6EuzkEgGxa2tohs7YJazYrVPZ8czUi8BSjWWkrTKVCTwk7wmhEZRWFPP1U2S-FjXUwDbi9duZ9ejBNm0xTLBFblyee8yY_Jk2MLtQj6v3E_bePI/s1600/Bussid.png' },
            "TRUCKSID": { name: "TRUCKSID", icon: "ð", host: '89a0b.playfabapi.com', titleId: '89A0B', profileImage: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4Q0wYqZDSD7VH-0QlvsqTDi4xnKg5NfRDLJHt92A-4qMcVNMXHpZPkGOQARhJWeZXr0VCCbMCUXJn2iAL-xbCOGELYZQqEgnJXD-VneGmLKQgjO5C9XhyphenhypheneMWD0RBl_bv3VKAGfhYxDzKLPhFjujKFMy7ITYuvLyiW-aDEp3AkM_Tn-jEAPuZXmPqarJY/s1600/images__1_-removebg-preview.png' }
        };
        const priceOptions = [{ text: "150.000.000 UB", price: 10000 }, { text: "371.000.000 UB", price: 22000 }, { text: "593.000.000 UB", price: 35000 }, { text: "815.000.000 UB", price: 48000 }, { text: "1,03M UB", price: 61000 }, { text: "1,26M UB", price: 73000 }, { text: "1,48M UB", price: 86000 }, { text: "1,7M UB", price: 99000 }, { text: "1,92M UB", price: 112000 }, { text: "2,1M UB", price: 125000 }];
        const SELL_PRICES = { Google: 2000, Facebook: 2200 };

        let loggedInUser = null;
        let isProfileLoading = false;
        let balanceListenerUnsubscribe = null;
        let stokAkunUnsubscribe = null;
        let appSettingsListenerUnsubscribe = null;
        let activeGameSessions = {};
        let currentTransactionTarget = null;
        let activeTopupRequest = {};
        let otherAccounts = [];
        let longPressTimer;
        let activeGameTab = 'topupBussid';
        let isSubscriptionExpired = false;
        let initialContentLoaded = false;
        let subQrisTimerInterval = null;
        let userToResetPasswordId = null;
        let accountsToSell = [];
        let captchaAnswer = 0;
        
        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639l4.433-7.447A1 1 0 017 4h10a1 1 0 01.531.175l4.433 7.447a1.012 1.012 0 010 .639l-4.433 7.447A1 1 0 0117 20H7a1 1 0 01-.531-.175L2.036 12.322z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
        const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" /></svg>`;
        
        const dom = {
            authWrapper: document.getElementById('auth-wrapper'),
            appLayout: document.getElementById('app-layout'),
            pageTitleHeader: document.getElementById('page-title-header'),
            content: {
                myAccount: document.getElementById('my-account-container'),
                profile: document.getElementById("profile-container"),
                topup: document.getElementById("topup-container"),
                buyUb: document.getElementById("buy-ub-container"),
                qris: document.getElementById('qris-display-container'),
                subscription: document.getElementById('subscription-container'),
                subscriptionQris: document.getElementById('subscription-qris-container'),
                stokAkun: document.getElementById('stok-akun-container'),
                jualAkun: document.getElementById('jual-akun-container'),
            },
            nav: {
                stokAkun: document.getElementById('nav-stok-akun'),
                jualAkun: document.getElementById('nav-jual-akun'),
                topupBussid: document.getElementById('nav-topupBussid'),
                topupTrucksid: document.getElementById('nav-topupTrucksid'),
                topup: document.getElementById('nav-topup'),
                subscription: document.getElementById('nav-subscription'),
            },
            lightbox: {
                overlay: document.getElementById('image-lightbox'),
                image: document.getElementById('lightbox-image'),
                closeBtn: document.getElementById('close-lightbox-btn')
            },
            confirmationModal: {
                overlay: document.getElementById('confirmation-modal'),
                title: document.getElementById('confirm-modal-title'),
                message: document.getElementById('confirm-modal-message'),
                confirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                closeBtn: document.getElementById('confirm-modal-close-btn')
            },
            maintenanceModal: {
                overlay: document.getElementById('maintenance-modal'),
                message: document.getElementById('maintenance-modal-message'),
            },
            subscriptionExpiredModal: {
                overlay: document.getElementById('subscription-expired-modal'),
            },
            statusModal: {
                overlay: document.getElementById('account-status-modal'),
                content: document.getElementById('status-modal-content'),
                closeBtn: document.getElementById('close-status-modal-btn'),
            },
            adminProfileModal: {
                 overlay: document.getElementById('admin-profile-modal'),
                 closeBtn: document.getElementById('close-admin-profile-modal-btn')
            },
            sellStatusModal: {
                overlay: document.getElementById('sell-status-modal'),
                content: document.getElementById('sell-status-content'),
                closeBtn: document.getElementById('close-sell-status-modal-btn')
            },
            akunPurchaseModal: {
                overlay: document.getElementById('akun-purchase-modal'),
                form: document.getElementById('akun-purchase-form'),
                stokIdInput: document.getElementById('purchase-stok-id'),
                usernameInput: document.getElementById('purchase-new-username'),
                totalDisplay: document.getElementById('akun-purchase-total').querySelector('span'),
                closeBtn: document.getElementById('close-akun-purchase-modal-btn')
            },
            sellMenu: {
                floatingMenu: document.getElementById('sell-account-floating-menu'),
                step1: document.getElementById('sell-step-1'),
                step2: document.getElementById('sell-step-2'),
                step3: document.getElementById('sell-step-3'),
                step4: document.getElementById('sell-step-4'),
                showBtn: document.getElementById('show-sell-account-menu-btn'),
                statusDisplay: document.getElementById('jual-akun-status-display'),
                statusText: document.getElementById('sell-status-text'),
                closeBtn: document.getElementById('close-sell-menu-btn'),
                closeProcessViewBtn: document.getElementById('close-sell-process-view-btn'),
                addAccountBtn: document.getElementById('add-account-to-sell-btn'),
                backToListBtn: document.getElementById('back-to-sell-list-btn'),
                processSellBtn: document.getElementById('process-sell-btn'),
                accountList: document.getElementById('sell-account-list'),
                totalPrice: document.getElementById('sell-total-price'),
                addForm: document.getElementById('add-sell-account-form'),
                loginType: document.getElementById('sell-login-type'),
                googleInputs: document.getElementById('sell-google-inputs'),
                facebookInputs: document.getElementById('sell-facebook-inputs'),
                paymentForm: document.getElementById('sell-payment-form'),
                paymentTotal: document.getElementById('payment-total-amount'),
                processingList: document.getElementById('processing-account-list'),
                statusDisplay: document.getElementById('sell-status-display'),
            },
            welcomeModal: {
                overlay: document.getElementById('welcome-message-modal'),
                title: document.getElementById('welcome-message-title'),
                content: document.getElementById('welcome-message-content'),
                closeBtn: document.getElementById('close-welcome-modal-btn'),
                okBtn: document.getElementById('ok-welcome-modal-btn')
            }
        };

        async function sendTelegramMessage(message, token) {
            if (!token) {
                console.error("Telegram bot token not provided.");
                return;
            }
            const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}&parse_mode=Markdown`;
            try {
                await fetch(url);
            } catch (error) {
                console.error("Gagal mengirim notifikasi Telegram:", error);
            }
        }
        
        async function sendTelegramSimpleMessage(message) {
            await sendTelegramMessage(message, TELEGRAM_BOT_TOKEN);
        }

        function showToast(msg, type = 'success', dur = 3000) { const c = document.getElementById('toast-container'); if (!c) return; const t = document.createElement('div'); t.className = `toast`; if (type === 'error') { t.style.borderLeftColor = 'var(--accent-red)'; } else { t.style.borderLeftColor = 'var(--accent-green)'; } t.innerText = msg; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, dur); }
        function setupPasswordToggle(inputId, toggleId) { const i = document.getElementById(inputId); const t = document.getElementById(toggleId); if (!i || !t) return; t.innerHTML = eyeIcon; t.addEventListener('click', () => { if (i.type === 'password') { i.type = 'text'; t.innerHTML = eyeSlashIcon; } else { i.type = 'password'; t.innerHTML = eyeIcon; } }); }
        function showModal(modalElement) { if (modalElement) modalElement.style.display = 'flex'; }
        function hideModal(modalElement) { if (modalElement) modalElement.style.display = 'none'; }
        function copyToClipboard(text, successMessage) { navigator.clipboard.writeText(text).then(() => { showToast(successMessage, "success"); }, (err) => { showToast("Gagal menyalin.", "error"); console.error('Clipboard copy failed: ', err); }); }
        function addLongPressListener(element, callback) { const start = (e) => { e.preventDefault(); longPressTimer = setTimeout(() => { callback(e); }, 800); }; const end = () => { clearTimeout(longPressTimer); }; element.addEventListener('mousedown', start); element.addEventListener('mouseup', end); element.addEventListener('mouseleave', end); element.addEventListener('touchstart', start, { passive: false }); element.addEventListener('touchend', end); element.addEventListener('contextmenu', e => e.preventDefault()); }
        
        async function showPage(pageName) {
            if (!checkSubscriptionStatus()) return;

            const pageToShow = (pageName === 'topupBussid' || pageName === 'topupTrucksid') ? 'profile' : pageName;
            const pageTitles = {
                stokAkun: "Beli Akun",
                jualAkun: "Jual Akun",
                topupBussid: "Top Up BUSSID",
                topupTrucksid: "Top Up TRUCKSID",
                topup: "Top Up Saldo",
                subscription: "Langganan Premium",
                myAccount: "Akun Saya",
                buyUb: "Toko UB",
                qris: "Pembayaran QRIS"
            };
            dom.pageTitleHeader.textContent = pageTitles[pageName] || "Bussid&Trucksid SHOP";
            
            Object.values(dom.content).forEach(container => {
                if(container) container.style.display = 'none';
            });
            Object.values(dom.nav).forEach(link => {
                if(link) link.parentElement.querySelector('a').classList.remove('active');
            });
            
            if (dom.nav[pageName]) {
                dom.nav[pageName].classList.add('active');
            }

            if (dom.content[pageToShow]) {
                dom.content[pageToShow].style.display = 'block';
                 if (pageToShow === 'profile') {
                    if (pageName === 'topupBussid' || pageName === 'topupTrucksid') {
                        activeGameTab = pageName;
                    }
                    await fetchAllGameProfiles();
                    await loadOtherAccounts();
                    const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
                    filterProfileCards(gameToShow);
                    document.getElementById('search-account-input').value = ''; 
                    filterProfileCardsBySearch(); 
                } else if (pageToShow === 'myAccount') {
                    displayMyAccountInfo();
                } else if (pageToShow === 'subscription') {
                    updateSubscriptionPage();
                } else if (pageToShow === 'stokAkun') {
                    setupStokAkunListener();
                } else if (pageToShow === 'jualAkun') {
                    displayJualAkunStatus();
                }
            }
        }
        function displayJualAkunStatus() {
            const statusDisplay = dom.sellMenu.statusDisplay;
            const statusText = dom.sellMenu.statusText;
            const statusData = loggedInUser.akunJualStatus;

            if (statusData && statusData.status) {
                statusDisplay.style.display = 'block';
                statusText.textContent = statusData.status;
                statusText.className = 'status-text'; 
                if (statusData.status === "Selesai(Terbayar Admin)") {
                    statusText.classList.add('completed');
                } else {
                    statusText.classList.add('processed');
                }
            } else {
                statusDisplay.style.display = 'none';
            }
        }function filterProfileCards(gameName) {
            document.querySelectorAll('#all-profiles-grid .profile-card').forEach(card => {
                card.classList.toggle('hidden', card.dataset.gameName !== gameName);
            });
        }
        function showLoginScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'block'; document.getElementById('register-container').style.display = 'none'; document.getElementById('forgot-password-container').style.display = 'none';}
        function showRegisterScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'none'; document.getElementById('register-container').style.display = 'block'; document.getElementById('forgot-password-container').style.display = 'none'; generateCaptcha(); }
        function showForgotPasswordScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'none'; document.getElementById('register-container').style.display = 'none'; document.getElementById('forgot-password-container').style.display = 'block'; document.getElementById('verify-user-view').style.display = 'block'; document.getElementById('reset-password-view').style.display = 'none'; }
        
        function manageNavVisibility() {
            const isAdmin = loggedInUser.accountType === 'Admin';
            document.querySelectorAll('.user-only').forEach(el => el.style.display = isAdmin ? 'none' : 'list-item');
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'list-item' : 'none');
        }

        async function showAppLayout() {
            if (initialContentLoaded) return;
            dom.authWrapper.style.display = 'none';
            if (!checkSubscriptionStatus()) {
                dom.appLayout.style.display = 'flex';
                return;
            }
            manageNavVisibility();
            dom.appLayout.style.display = 'flex';
            
            showPage('stokAkun'); // Default page is now Beli Akun
            
            initialContentLoaded = true;
        }

        function getRemainingDays(dateString) {
            if (!dateString) return 0;
            const endDate = new Date(dateString);
            const today = new Date();
            endDate.setUTCHours(0, 0, 0, 0);
            today.setUTCHours(0, 0, 0, 0);
            const diffTime = endDate.getTime() - today.getTime();
            if (diffTime < 0) return 0;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            return diffDays + 1;
        }
        function checkSubscriptionStatus() {
            if (loggedInUser?.accountType === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                if (remainingDays <= 0) {
                    showModal(dom.subscriptionExpiredModal.overlay);
                    dom.appLayout.style.pointerEvents = 'none';
                    dom.appLayout.style.opacity = '0.5';
                    isSubscriptionExpired = true;
                    return false;
                }
            }
            hideModal(dom.subscriptionExpiredModal.overlay);
            dom.appLayout.style.pointerEvents = 'auto';
            dom.appLayout.style.opacity = '1';
            isSubscriptionExpired = false;
            return true;
        }

        function updateHeaderInfo() {
             if (!loggedInUser) return;
            // Update username
            document.getElementById('sidebar-username').textContent = loggedInUser.username;
            
            // Update balance/status
            const balanceLabelEl = document.getElementById('sidebar-balance-label');
            const balanceAmountEl = document.getElementById('sidebar-balance-amount');
            const addBalanceBtn = document.getElementById('add-balance-btn');
            balanceAmountEl.className = 'balance-amount';
            if (loggedInUser.accountType === 'Admin') {
                balanceLabelEl.textContent = 'Status';
                balanceAmountEl.textContent = 'ADMIN';
                balanceAmountEl.classList.add('admin');
                addBalanceBtn.style.display = 'none';
            } else if (loggedInUser.accountType === 'PREMIUM') {
                balanceLabelEl.textContent = 'Status';
                balanceAmountEl.textContent = 'PREMIUM';
                balanceAmountEl.classList.add('premium');
                addBalanceBtn.style.display = 'none';
                dom.nav.topup.parentElement.style.display = 'none';
            } else if (loggedInUser.accountType === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                balanceLabelEl.textContent = 'Masa Aktif';
                balanceAmountEl.textContent = `${remainingDays} hari`;
                balanceAmountEl.classList.add('subscription');
                addBalanceBtn.style.display = 'none';
                dom.nav.topup.parentElement.style.display = 'none';
            } else {
                balanceLabelEl.textContent = 'Saldo';
                const balance = loggedInUser.saldo || 0;
                balanceAmountEl.textContent = `Rp ${balance.toLocaleString('id-ID')}`;
                addBalanceBtn.style.display = 'flex';
                dom.nav.topup.parentElement.style.display = 'list-item';
            }
        }

        function setupRealtimeBalanceListener() {
            if (!loggedInUser?.docId) return;
            if (balanceListenerUnsubscribe) balanceListenerUnsubscribe();
            const userRef = doc(db, "users", loggedInUser.docId);
            balanceListenerUnsubscribe = onSnapshot(userRef, async (d) => {
                if (d.exists()) {
                    const oldData = { ...loggedInUser };
                    const newData = d.data();
                    loggedInUser = { ...newData, docId: d.id };
                    
                    const wasPreviouslyExpired = isSubscriptionExpired;
                    updateHeaderInfo();
                    const isCurrentlyExpired = !checkSubscriptionStatus();

                    if (wasPreviouslyExpired && !isCurrentlyExpired) {
                        showToast("Masa aktif diperpanjang! Memuat ulang data...", "success");
                        initialContentLoaded = false;
                        await showAppLayout();
                    } else if (!initialContentLoaded) {
                        await showAppLayout();
                    }

                    if (oldData.pendingSubscription && !newData.pendingSubscription) {
                        if (newData.accountType !== oldData.accountType) {
                           showToast(`Selamat! Akun Anda telah di-upgrade ke ${newData.accountType}.`, 'success', 5000);
                        }
                        if (dom.content.subscription.style.display === 'block' || dom.content.subscriptionQris.style.display === 'block') {
                            showPage('subscription');
                        }
                    }
                    
                     // Cek status penjualan akun
                    if (newData.akunJualStatus && newData.akunJualStatus.status) {
                        if (dom.content.jualAkun.style.display === 'block') {
                            displayJualAkunStatus();
                        }
                        if (dom.sellMenu.floatingMenu.classList.contains('visible') && newData.akunJualStatus.status !== "Selesai(Terbayar Admin)") {
                           showSellStep(4);
                           updateProcessingList(newData.akunJualStatus.accounts);
                        }
                    }

                } else {
                    showToast("Data pengguna tidak ditemukan lagi.", "error");
                    logout();
                }
            }, (e) => {
                console.error("Firestore snapshot error: ", e);
                showToast("Koneksi data akun terputus.", "error");
            });
        }
        async function login(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Memeriksa...";
            try {
                const q = query(collection(db, "users"), where("username", "==", document.getElementById("username").value.trim()));
                const s = await getDocs(q);
                if (s.empty) { showToast("User tidak ditemukan!", "error"); return; }
                let f = false;
                s.forEach(d => {
                    if (d.data().password === document.getElementById("password").value) {
                        loggedInUser = { ...d.data(), docId: d.id };
                        initialContentLoaded = false;
                        isSubscriptionExpired = false;
                        f = true;
                    }
                });
                if (f) {
                    showToast("Login Berhasil! Memuat data...", "success");
                    sendTelegramMessage(`â *Login Berhasil*\n*Username:* \`${loggedInUser.username}\``, userActionBotToken);
                    
                    const newLoginCount = (loggedInUser.loginCount || 0) + 1;
                    const userRef = doc(db, "users", loggedInUser.docId);
                    await updateDoc(userRef, { loginCount: newLoginCount });
                    loggedInUser.loginCount = newLoginCount;
                    
                    checkAndShowWelcomeMessage();
                    
                    setupRealtimeBalanceListener();
                } else {
                    showToast("Kata Sandi salah!", "error");
                }
            } catch (e) {
                showToast("Gagal terhubung.", "error");
                console.error("Login error: ", e);
            } finally {
                btn.disabled = false; btn.innerText = "Masuk";
            }
        }
        function generateCaptcha() {
            const num1 = Math.floor(Math.random() * 10) + 1;
            const num2 = Math.floor(Math.random() * 10) + 1;
            captchaAnswer = num1 + num2;
            document.getElementById('captcha-question').textContent = `${num1} + ${num2} = ?`;
        }
        async function register(event) {
            event.preventDefault();

            const userAnswer = parseInt(document.getElementById('captcha-input').value, 10);
            if (userAnswer !== captchaAnswer) {
                showToast("Jawaban Captcha salah!", "error");
                generateCaptcha();
                document.getElementById('captcha-input').value = '';
                return;
            }

            const btn = event.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Mendaftar...";
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const whatsapp = document.getElementById('reg-whatsapp').value.trim();
            const password = document.getElementById('reg-password').value;
            if (!username || !email || !whatsapp || !password) {
                showToast("Semua kolom harus diisi!", "error");
                btn.disabled = false; btn.innerText = "Daftar";
                generateCaptcha();
                return;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast("Format email tidak valid!", "error");
                btn.disabled = false; btn.innerText = "Daftar";
                generateCaptcha();
                return;
            }
            try {
                const usernameQuery = query(collection(db, "users"), where("username", "==", username));
                const emailQuery = query(collection(db, "users"), where("email", "==", email));
                const [usernameSnapshot, emailSnapshot] = await Promise.all([getDocs(usernameQuery), getDocs(emailQuery)]);
                if (!usernameSnapshot.empty) { showToast("Username sudah digunakan.", "error"); return; }
                if (!emailSnapshot.empty) { showToast("Email sudah terdaftar.", "error"); return; }
                await addDoc(collection(db, "users"), {
                    username: username,
                    email: email,
                    whatsapp: whatsapp,
                    password: password,
                    saldo: 0,
                    accountType: 'USER',
                    loginCount: 0,
                    masaAktifHingga: null,
                    pendingTransaction: 0,
                    pendingSubscription: null,
                    pendingAkunPurchase: null,
                    otherAccountsList: [],
                    akunJualStatus: null,
                });
                showToast("Pendaftaran berhasil! Silakan masuk.", "success");
                sendTelegramMessage(`ð *Pendaftaran Baru*\n*Username:* \`${username}\`\n*Email:* \`${email}\``, userActionBotToken);
                event.target.reset();
                showLoginScreen();
            } catch (e) {
                console.error("Error saat pendaftaran: ", e);
                showToast("Gagal mendaftar. Coba lagi nanti.", "error");
            } finally {
                btn.disabled = false; btn.innerText = "Daftar";
                generateCaptcha();
            }
        }
        function logout() {
            if (loggedInUser) {
                sendTelegramMessage(`ð *Logout*\n*Username:* \`${loggedInUser.username}\``, userActionBotToken);
            }
            if (balanceListenerUnsubscribe) { balanceListenerUnsubscribe(); balanceListenerUnsubscribe = null; }
            if (stokAkunUnsubscribe) { stokAkunUnsubscribe(); stokAkunUnsubscribe = null; }
            if (subQrisTimerInterval) { clearInterval(subQrisTimerInterval); subQrisTimerInterval = null; }
            loggedInUser = null;
            activeGameSessions = {};
            currentTransactionTarget = null;
            initialContentLoaded = false;
            isSubscriptionExpired = false;
            accountsToSell = [];
            showToast('Logout berhasil.', "success");
            setTimeout(showLoginScreen, 500);
        }
        async function getSingleGameProfile(gp) {
            const { host, titleId, deviceId } = gp;
            const sRes = await fetch(`https://${host}/Client/LoginWithAndroidDeviceID?sdk=UnitySDK-2.206.241122`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ AndroidDevice: "AndroidPhone", AndroidDeviceId: deviceId, CreateAccount: true, TitleId: titleId }) });
            const sData = await sRes.json();
            if (sData.code !== 200 || !sData.data?.SessionTicket) throw new Error(sData.errorMessage || 'Akun tidak ditemukan.');
            const sessionTicket = sData.data.SessionTicket;

            const pRes = await fetch(`https://${host}/Client/GetPlayerCombinedInfo?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ InfoRequestParameters: { GetUserAccountInfo: true, GetUserVirtualCurrency: true, GetPlayerProfile: true } }) });
            const pResult = await pRes.json();
            if (pResult.code !== 200 || !pResult.data?.InfoResultPayload) throw new Error(pResult.errorMessage || 'Gagal mengambil info player.');
            
            return { profile: pResult.data.InfoResultPayload, session: sData.data, host: host };
        }
        function displayMyAccountInfo() {
            if (!loggedInUser) return;
            document.getElementById('account-username').textContent = loggedInUser.username;
            const saldoEl = document.getElementById('account-saldo');
            const saldoLabelEl = document.getElementById('account-saldo-label');
            saldoEl.className = 'info-value';

            if (loggedInUser.accountType === 'Admin') {
                saldoLabelEl.textContent = 'Status Akun';
                saldoEl.textContent = 'ADMIN';
                saldoEl.classList.add('admin');
            } else if (loggedInUser.accountType === 'PREMIUM') {
                saldoLabelEl.textContent = 'Status Akun';
                saldoEl.textContent = 'PREMIUM';
                saldoEl.classList.add('premium');
            } else if (loggedInUser.accountType === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                saldoLabelEl.textContent = 'Masa Aktif';
                saldoEl.textContent = `${remainingDays} hari lagi`;
                saldoEl.classList.add('subscription');
            } else {
                saldoLabelEl.textContent = 'Saldo Akun';
                saldoEl.textContent = `Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`;
                saldoEl.classList.add('accent-green');
            }

            const deviceIdValue = document.getElementById('account-device-id');
            const changeIdBtn = document.getElementById('change-device-id-btn');
            if (loggedInUser.device_id) {
                deviceIdValue.textContent = loggedInUser.device_id;
                addLongPressListener(deviceIdValue, () => copyToClipboard(loggedInUser.device_id, 'Device ID disalin!'));
                changeIdBtn.textContent = 'Ganti Device ID';
            } else {
                deviceIdValue.textContent = 'Belum ditambahkan';
                deviceIdValue.classList.remove('small-text');
                changeIdBtn.textContent = 'Tambahkan Device ID';
            }

            document.getElementById('account-email').textContent = loggedInUser.email || 'Tidak ada';
            document.getElementById('account-whatsapp').textContent = loggedInUser.whatsapp || 'Tidak ada';
        }
        function createSkeletonCardHTML() { return `<div class="profile-card skeleton-card"><div class="skeleton-header"><div class="skeleton skeleton-avatar"></div><div class="skeleton-text-group"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text short"></div></div></div><div class="account-details"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line"></div></div><div class="fill-balance-btn"><div class="skeleton skeleton-button"></div></div></div>`; }
        
        async function fetchAllGameProfiles() {
            if (isProfileLoading || !loggedInUser) return;
            isProfileLoading = true;
            const grid = document.getElementById('all-profiles-grid');
            grid.innerHTML = '';
            if (!loggedInUser.device_id) {
                isProfileLoading = false;
                return;
            }
            grid.innerHTML = createSkeletonCardHTML() + createSkeletonCardHTML();
            const profilePromises = Object.values(gameConfigs).map(config =>
                getSingleGameProfile({ ...config, deviceId: loggedInUser.device_id })
                    .then(result => ({ status: 'fulfilled', value: result, config }))
                    .catch(error => ({ status: 'rejected', reason: error, config }))
            );
            const results = await Promise.all(profilePromises);
            grid.innerHTML = '';
            results.forEach(res => {
                const { config } = res;
                if (res.status === 'fulfilled') {
                    const result = res.value;
                    activeGameSessions[config.name] = result;
                    grid.insertAdjacentHTML('beforeend', createProfileCardHTML(config, result.profile));
                } else {
                    grid.insertAdjacentHTML('beforeend', createErrorCardHTML(config, res.reason));
                }
            });
            const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            filterProfileCards(gameToShow);
            
            isProfileLoading = false;
        }

        function createProfileCardHTML(game, pInfo, customName = null, index = null) {
            const displayName = pInfo.PlayerProfile?.DisplayName;
            const dName = customName || displayName || 'Nama Belum Diatur';
            const hasValidName = !!displayName;
            const deviceId = pInfo.AccountInfo.AndroidDeviceInfo?.AndroidDeviceId || 'N/A';
            const xAuth = pInfo.sessionTicket || activeGameSessions[game.name]?.session?.SessionTicket || 'N/A';
            const cardIdBase = index !== null ? `other-account-card-${index}` : `my-account-card-${game.name}`;
            const playerUb = pInfo.UserVirtualCurrency?.RP?.toLocaleString('id-ID') || '0';
            const dataIndexAttr = index !== null ? `data-index="${index}"` : '';

            const leaderboardPlaceholderHTML = `
                <div class="leaderboard-placeholder" style="display: flex; align-items: center; justify-content: center;">
                    <button class="action-button btn-secondary" data-action="check-rank" data-host="${gameConfigs[game.name].host}" data-xauth="${xAuth}" style="padding: 3px 8px; font-size: 0.6em; line-height: 1;">
                        Cek Peringkat
                    </button>
                </div>
                <div class="leaderboard-container" style="display: none; font-size: 0.45em; text-align: center; line-height: 1.1;">
                </div>`;
            
            const settingsView = `
                <div class="profile-card-settings-view">
                    <i class="ph ph-arrow-left profile-settings-icon" data-action="flip-back"></i>
                    <h3>Pengaturan Akun</h3>
                    <div class="settings-info-list">
                        <div class="settings-info-item" data-copy-value="${deviceId}" title="Tahan untuk menyalin Device ID"><span class="label">Device ID</span><div class="value">${deviceId}</div></div>
                    </div>
                    <div class="settings-actions">
                        <button class="action-button btn-secondary" data-action="change-name" data-game-name="${game.name}" data-x-auth="${xAuth}"><i class="ph ph-pencil-simple"></i> Ganti Nama</button>
                        <button class="action-button btn-red" data-action="delete-account" data-game-name="${game.name}" data-x-auth="${xAuth}"><i class="ph ph-trash"></i> Hapus Akun</button>
                    </div>
                </div>`;
            
            const deleteFromListButton = index !== null 
                ? `<button class="action-button btn-red" data-action="delete-from-list" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px; background-color: #991b1b;">
                       <i class="ph-bold ph-x-circle" style="vertical-align: middle; margin-right: 4px;"></i>
                       Hapus
                   </button>`
                : `<div style="flex-basis: calc(50% - 2.5px);"></div>`;

            return `
                <div class="profile-card" id="${cardIdBase}" data-game-name="${game.name}" ${dataIndexAttr}>
                    <div class="profile-card-main-view">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <img src="${game.profileImage}" alt="${game.name} Logo" style="width: 24px; height: 24px; border-radius: 50%;">
                                <h3 class="game-title" style="font-size: 0.75em;">${game.name}</h3>
                            </div>
                            ${leaderboardPlaceholderHTML}
                        </div>
                        
                        <div class="player-display-container">
                            <div class="player-name-plate">
                                <span class="plate-icon-placeholder"></span>
                                <span class="player-name-text" title="${dName}">${dName}</span>
                                <i class="ph-bold ph-pencil-simple plate-icon" data-action="change-name" data-game-name="${game.name}" data-x-auth="${xAuth}" title="Ganti Nama"></i>
                            </div>
                            <div class="player-ub-plate">
                                <span class="plate-icon-placeholder"></span>
                                <span class="player-ub-text">Rp. ${playerUb}</span>
                                <i class="ph-bold ph-plus-circle plate-icon" data-action="topup" data-game="${game.name}" data-session="${xAuth}" data-valid-name="${hasValidName}" data-index="${index}" title="Top Up"></i>
                            </div>
                        </div>

                        <div class="fill-balance-btn-grid" style="display: flex; flex-direction: column; gap: 5px; margin-top: auto;">
                            <div class="button-row" style="display: flex; gap: 5px; justify-content: space-between;">
                                <button class="action-button btn-green" data-action="topup" data-game="${game.name}" data-session="${xAuth}" data-valid-name="${hasValidName}" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                    <i class="ph-bold ph-rocket-launch" style="vertical-align: middle; margin-right: 4px;"></i>
                                    Top Up
                                </button>
                                <button class="action-button btn-cyan" data-action="reduce-ub" data-game="${game.name}" data-session="${xAuth}" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                   <i class="ph-bold ph-arrow-down" style="vertical-align: middle; margin-right: 4px;"></i>
                                   Kurangi UB
                                </button>
                            </div>
                            <div class="button-row" style="display: flex; gap: 5px; justify-content: space-between;">
                                <button class="action-button btn-secondary" data-action="flip" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                    <i class="ph-bold ph-gear-six" style="vertical-align: middle; margin-right: 4px;"></i>
                                    Pengaturan
                                </button>
                                ${deleteFromListButton}
                            </div>
                        </div>
                    </div>
                    ${settingsView}
                </div>`;
        }
        function createErrorCardHTML(game, error, customName = null, index = null) { const dName = customName || game.name; const cardId = index !== null ? `other-account-card-${index}` : `my-account-card-error-${game.name}`; return `<div class="profile-card" id="${cardId}" data-game-name="${game.name}"><div class="profile-card-main-view"><div class="profile-card-header"><h3 class="game-title" style="font-size:0.9em;">${dName}</h3><span class="game-icon">${game.icon}</span></div><div class="profile-card-error" style="padding: 15px; text-align: center; color: var(--accent-red); flex-grow: 1; display: flex; flex-direction: column; justify-content: center;"><h4>Gagal Muat</h4><p style="font-size: 0.8em; margin-top: 8px; color: var(--text-secondary);">${error.message}</p></div></div></div>`; }
        async function fetchProfileByKey(gameName, key) {
            const config = gameConfigs[gameName];
            if (!config) throw new Error("Game tidak valid.");
            let sessionTicket = '';
            if (key.length === 16 && /^[a-fA-F0-9]+$/.test(key)) {
                const sRes = await fetch(`https://${config.host}/Client/LoginWithAndroidDeviceID?sdk=UnitySDK-2.206.241122`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ AndroidDevice: "AndroidPhone", AndroidDeviceId: key, CreateAccount: false, TitleId: config.titleId }) });
                const sData = await sRes.json();
                if (sData.code !== 200 || !sData.data?.SessionTicket) throw new Error(sData.errorMessage || 'Device ID tidak ditemukan.');
                sessionTicket = sData.data.SessionTicket;
            } else {
                sessionTicket = key;
            }
            const pRes = await fetch(`https://${config.host}/Client/GetPlayerCombinedInfo?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ InfoRequestParameters: { GetUserAccountInfo: true, GetUserVirtualCurrency: true, GetPlayerProfile: true } }) });
            const pResult = await pRes.json();
            if (pResult.code === 401) throw new Error('Token tidak valid atau telah kadaluarsa.');
            if (pResult.code !== 200 || !pResult.data?.InfoResultPayload) throw new Error(pResult.errorMessage || 'Gagal mengambil info player.');
            pResult.data.InfoResultPayload.sessionTicket = sessionTicket;
            
            return pResult.data.InfoResultPayload;
        }
        async function handleAddOtherAccount(event) {
            event.preventDefault();
            const btn = document.getElementById('find-account-btn');
            btn.disabled = true; btn.innerText = "Mencari...";
            const game = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            const key = document.getElementById('other-account-key').value.trim();
            try {
                if (!game) { throw new Error("Silakan pilih game terlebih dahulu dari menu utama."); }
                if (otherAccounts.some(acc => acc.key.toLowerCase() === key.toLowerCase() && acc.game === game)) {
                    throw new Error("Akun ini sudah ada di dalam daftar Anda.");
                }
                const profileInfo = await fetchProfileByKey(game, key);
                const name = profileInfo.PlayerProfile?.DisplayName || `Akun ${key.substring(0, 5)}`;
                otherAccounts.unshift({ name, game, key });
                await saveOtherAccounts();
                await renderOtherAccounts();
                showToast("Akun berhasil ditambahkan!", "success");
                event.target.reset();
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                btn.disabled = false; btn.innerText = "Cari & Tambah Akun";
            }
        }
        async function saveOtherAccounts() { if (!loggedInUser?.docId) return; try { const userRef = doc(db, "users", loggedInUser.docId); await updateDoc(userRef, { otherAccountsList: otherAccounts }); } catch (error) { console.error("Gagal menyimpan akun ke Firebase:", error); showToast("Gagal menyimpan akun tambahan.", "error"); } }
        async function loadOtherAccounts() { if (!loggedInUser) return; otherAccounts = loggedInUser.otherAccountsList || []; await renderOtherAccounts(); }
        
        async function renderOtherAccounts() {
            const grid = document.getElementById('all-profiles-grid');
            
            grid.querySelectorAll('.profile-card[data-index]').forEach(card => card.remove());
            
            if (otherAccounts.length === 0) {
                filterProfileCardsBySearch();
                return;
            }
            
            const profilePromises = otherAccounts.map(account => fetchProfileByKey(account.game, account.key)
                .then(profileInfo => ({ status: 'fulfilled', value: profileInfo, account }))
                .catch(error => ({ status: 'rejected', reason: error, account }))
            );
            const results = await Promise.all(profilePromises);
            
            results.forEach((result, index) => {
                const { account } = result;
                const gameConfig = gameConfigs[account.game];
                let cardHTML;
                if (result.status === 'fulfilled') {
                    const profileInfo = result.value;
                    cardHTML = createProfileCardHTML(gameConfig, profileInfo, account.name, index);
                    activeGameSessions[`${account.name}-${account.game}`] = { profile: profileInfo, session: { SessionTicket: profileInfo.sessionTicket }, host: gameConfig.host };
                } else {
                    cardHTML = createErrorCardHTML(gameConfig, result.reason, account.name, index);
                }
                grid.insertAdjacentHTML('beforeend', cardHTML);
            });
            
            const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            filterProfileCards(gameToShow);
            filterProfileCardsBySearch();
        }

        function filterProfileCardsBySearch() {
            const searchTerm = document.getElementById('search-account-input').value.toLowerCase();
            const grid = document.getElementById('all-profiles-grid');
            const cards = Array.from(grid.querySelectorAll('.profile-card:not(.skeleton-card)'));

            const matches = [];
            const other = [];

            cards.forEach(card => {
                const gameName = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
                if (card.dataset.gameName !== gameName) {
                    card.style.display = 'none';
                    return;
                }

                const playerName = (card.querySelector('.player-name-text')?.textContent || '').toLowerCase();
                const deviceId = (card.querySelector('.settings-info-item[data-copy-value]')?.dataset.copyValue || '').toLowerCase();
                
                const isMatch = playerName.includes(searchTerm) || deviceId.includes(searchTerm);

                if (isMatch) {
                    if (playerName.startsWith(searchTerm) || deviceId.startsWith(searchTerm)) {
                        matches.unshift(card); 
                    } else {
                        matches.push(card);
                    }
                } else {
                    other.push(card);
                }
            });

            matches.forEach(card => {
                card.style.display = 'flex';
                grid.appendChild(card);
            });
            other.forEach(card => {
                card.style.display = 'none';
                grid.appendChild(card);
            });
        }

        async function handleDeleteOtherAccount(index) { 
            const isConfirmed = await showConfirmation(`Apakah Anda yakin ingin menghapus akun ini dari daftar?`, "Konfirmasi Hapus"); 
            if (isConfirmed) { 
                otherAccounts.splice(index, 1); 
                await saveOtherAccounts(); 
                document.getElementById(`other-account-card-${index}`)?.remove();
                showToast("Akun telah dihapus dari daftar.", "success"); 
            } 
        }
        async function handleUpdatePassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            if (!newPassword || newPassword !== confirmPassword) { showToast("Sandi baru tidak cocok atau kosong!", "error"); return; }
            const btn = event.target.querySelector('button');
            btn.disabled = true;
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { password: newPassword });
                loggedInUser.password = newPassword;
                showToast("Sandi berhasil diperbarui!", "success");
                hideModal(document.getElementById('change-password-modal'));
                event.target.reset();
            } catch (error) {
                showToast("Gagal memperbarui sandi: " + error.message, "error");
            } finally {
                btn.disabled = false;
            }
        }
        async function handleUpdateDeviceId(event) {
            event.preventDefault();
            const newDeviceId = document.getElementById('new-device-id').value.trim();
            if (newDeviceId.length !== 16) { showToast("Device ID harus 16 karakter!", "error"); return; }
            const btn = event.target.querySelector('button');
            btn.disabled = true;
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { device_id: newDeviceId });
                loggedInUser.device_id = newDeviceId;
                showToast("Device ID berhasil diperbarui! Memuat ulang profil...", "success");
                hideModal(document.getElementById('change-device-id-modal'));
                displayMyAccountInfo();
                event.target.reset();
                await fetchAllGameProfiles();
            } catch (error) {
                showToast("Gagal memperbarui Device ID: " + error.message, "error");
            } finally {
                btn.disabled = false;
            }
        }
        function showConfirmation(message, title = "Konfirmasi") {
            return new Promise(resolve => {
                const modal = dom.confirmationModal;
                const messageEl = modal.message;
                
                messageEl.classList.remove('invoice-style-confirmation');

                if (message.startsWith('<div class="invoice-style-confirmation">')) {
                    messageEl.classList.add('invoice-style-confirmation');
                }
                
                modal.title.textContent = title;
                messageEl.innerHTML = message;
                showModal(modal.overlay);
                const close = (result) => { hideModal(modal.overlay); modal.confirmBtn.onclick = null; modal.cancelBtn.onclick = null; modal.closeBtn.onclick = null; modal.overlay.onclick = null; resolve(result); };
                modal.confirmBtn.onclick = () => close(true);
                modal.cancelBtn.onclick = () => close(false);
                modal.closeBtn.onclick = () => close(false);
                modal.overlay.onclick = (e) => { if (e.target === modal.overlay) { close(false); } };
            });
        }
        
        function calculateRpFromUb(ub) {
            const maxUb = 2147483647;
            const maxRp = 130000;
            if (ub <= 0) return 0;
            if (ub >= maxUb) return maxRp;
            const price = 2.805 * Math.sqrt(ub);
            return Math.ceil(price / 100) * 100;
        }
        
        function updateUbDisplay(source = 'slider') {
            const slider = document.getElementById('ub-slider');
            const input = document.getElementById('ub-input');
            const maxUb = 2147483647;
            let ubVal;

            if (source === 'slider') {
                const percentage = parseFloat(slider.value) / 100;
                ubVal = Math.round(percentage * maxUb);
                input.value = ubVal > 0 ? ubVal.toLocaleString('id-ID') : '0';
            } else { 
                const cleanValue = input.value.replace(/\./g, '');
                ubVal = parseInt(cleanValue, 10);

                if (isNaN(ubVal) || ubVal < 0) ubVal = 0;
                if (ubVal > maxUb) ubVal = maxUb;
                
                input.value = ubVal.toLocaleString('id-ID');

                const newPercentage = (ubVal / maxUb) * 100;
                slider.value = newPercentage;
            }
            
            const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || loggedInUser.accountType === 'Admin' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
            
            if (isFreeAccess) {
                document.getElementById('rp-display-row').style.display = 'none';
            } else {
                const rpVal = calculateRpFromUb(ubVal);
                document.getElementById('rp-display').textContent = `Rp ${rpVal.toLocaleString('id-ID')}`;
                document.getElementById('rp-display-row').style.display = 'flex';
            }
        }

        function showBuyUbScreen(gameName, sessionTicket = null, otherAccountIndex = null) {
            let targetSessionKey = gameName;
            if (sessionTicket) { targetSessionKey = Object.keys(activeGameSessions).find(key => activeGameSessions[key]?.session?.SessionTicket === sessionTicket); }
            const sessionData = activeGameSessions[targetSessionKey];
            if (!sessionData) { showToast("Sesi game tidak valid atau kadaluarsa. Coba refresh.", "error"); return; }
            currentTransactionTarget = { name: gameName, otherAccountIndex: otherAccountIndex, ...sessionData };
            const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || loggedInUser.accountType === 'Admin' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
            const slider = document.getElementById('ub-slider');
            const input = document.getElementById('ub-input');
            
            slider.value = 0;
            input.value = '0';

            document.getElementById('buy-ub-game-name').textContent = gameName;
            const saldoDisplayWrapper = document.getElementById('buy-ub-balance-display-wrapper');
            const saldoDisplay = document.getElementById('buy-ub-current-saldo');
            if (isFreeAccess) {
                saldoDisplayWrapper.style.display = 'none';
            } else {
                saldoDisplayWrapper.style.display = 'block';
                saldoDisplay.textContent = `Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`;
                saldoDisplay.style.color = 'var(--accent-green)';
            }
            document.getElementById('player-name-display').textContent = sessionData.profile.PlayerProfile?.DisplayName || 'Tidak Ada Nama';
            document.getElementById('player-ub-display').textContent = (sessionData.profile.UserVirtualCurrency?.RP || 0).toLocaleString('id-ID');
            document.getElementById('buy-ub-error').style.display = 'none';
            updateUbDisplay();
            showPage('buyUb');
        }
        async function executeUbTransaction(amount) {
            const ub = parseInt(String(amount).replace(/\./g, ''), 10);
            if (isNaN(ub) || ub === 0) { showToast("Jumlah UB tidak valid.", "error"); return; }
            const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || loggedInUser.accountType === 'Admin' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
            const isAdding = ub > 0;
            const actionText = isAdding ? "menambahkan" : "mengurangi";
            const cost = isAdding && !isFreeAccess ? calculateRpFromUb(ub) : 0;
            const ubAbs = Math.abs(ub);
            
            if (isAdding && !isFreeAccess && loggedInUser.saldo < cost) {
                document.getElementById('buy-ub-error').innerText = 'Saldo tidak cukup.';
                document.getElementById('buy-ub-error').style.display = 'block';
                sendTelegramMessage(`â *Topup Saldo GAGAL (Saldo Kurang)*\n*Username:* \`${loggedInUser.username}\`\n*Game:* ${currentTransactionTarget.name}\n*Ingin Beli:* ${ubAbs.toLocaleString('id-ID')} UB (Rp ${cost.toLocaleString('id-ID')})\n*Saldo:* Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`, userActionBotToken);
                return;
            }
            if (!currentTransactionTarget) { showToast("Target transaksi tidak valid.", "error"); return; }
            
            const message = `Anda akan <strong>${actionText} ${ubAbs.toLocaleString('id-ID')} UB</strong> ${isAdding && !isFreeAccess ? `seharga <strong style="color: var(--accent-green);">Rp ${cost.toLocaleString('id-ID')}</strong>` : (isAdding ? 'secara <strong>GRATIS</strong>' : '')}. Lanjutkan?`;
            const isConfirmed = await showConfirmation(message, `Konfirmasi ${actionText} UB`);
            if (!isConfirmed) { showToast("Tindakan dibatalkan.", "success"); return; }
            
            const btn = document.getElementById('confirm-buy-ub-btn');
            const reduceBtn = document.getElementById('confirm-reduce-ub-btn');
            btn.disabled = true; btn.innerText = "Memproses...";
            if (reduceBtn) { reduceBtn.disabled = true; reduceBtn.innerText = "Memproses..."; }
            document.getElementById('buy-ub-error').style.display = 'none';
            
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                if (isAdding && !isFreeAccess) { const newSaldo = loggedInUser.saldo - cost; await updateDoc(userRef, { saldo: newSaldo }); }
                const payload = { FunctionName: "AddRp", FunctionParameter: { addValue: ub }, GeneratePlayStreamEvent: false };
                const res = await fetch(`https://${currentTransactionTarget.host}/Client/ExecuteCloudScript?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': currentTransactionTarget.session.SessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.code !== 200) { if (isAdding && !isFreeAccess) { await updateDoc(userRef, { saldo: loggedInUser.saldo }); } throw new Error(result.errorMessage || 'Gagal mengubah UB.'); }
                await addDoc(collection(db, "purchase_history"), { userId: loggedInUser.docId, username: loggedInUser.username, game: currentTransactionTarget.name, rpCost: cost, ubAmount: ub, status: "Success", timestamp: serverTimestamp() });
                
                if (isAdding) {
                    if (isFreeAccess) {
                        sendTelegramMessage(`ð *Topup Gratis Berhasil*\n*Username:* \`${loggedInUser.username}\`\n*Status:* ${loggedInUser.accountType}\n*Game:* ${currentTransactionTarget.name}\n*Jumlah:* ${ubAbs.toLocaleString('id-ID')} UB`, userActionBotToken);
                    } else {
                        sendTelegramMessage(`ð° *Topup Saldo Berhasil*\n*Username:* \`${loggedInUser.username}\`\n*Game:* ${currentTransactionTarget.name}\n*Jumlah:* ${ubAbs.toLocaleString('id-ID')} UB\n*Harga:* Rp ${cost.toLocaleString('id-ID')}`, userActionBotToken);
                    }
                }

                showToast(`Berhasil! ${ubAbs.toLocaleString('id-ID')} UB telah di${actionText}.`, "success");
                
                if (currentTransactionTarget.otherAccountIndex !== null && currentTransactionTarget.otherAccountIndex !== undefined) {
                    const indexToMove = parseInt(currentTransactionTarget.otherAccountIndex, 10);
                    if (indexToMove >= 0 && indexToMove < otherAccounts.length) {
                        const [accountToMove] = otherAccounts.splice(indexToMove, 1);
                        otherAccounts.unshift(accountToMove);
                        await saveOtherAccounts();
                    }
                }

                await fetchAllGameProfiles();
                await renderOtherAccounts();
                showPage(activeGameTab);
                if (!isAdding) hideModal(document.getElementById('reduce-ub-modal'));
            } catch (e) {
                 if(isAdding && !isFreeAccess){ sendTelegramMessage(`â *Topup Saldo GAGAL*\n*Username:* \`${loggedInUser.username}\`\n*Game:* ${currentTransactionTarget.name}\n*Error:* ${e.message}`, userActionBotToken); }
                showToast(`Gagal: ${e.message}`, 'error');
                document.getElementById('buy-ub-error').innerText = `Error: ${e.message}`;
                document.getElementById('buy-ub-error').style.display = 'block';
            } finally {
                btn.disabled = false; btn.innerText = "Tambah UB";
                if (reduceBtn) { reduceBtn.disabled = false; reduceBtn.innerText = "Kurangi UB"; }
            }
        }
        async function showTopupMenu() { 
            showPage('topup'); 
            const opts = document.getElementById('topup-options-view'); 
            const pend = document.getElementById('topup-pending-view'); 
            const userRef = doc(db, "users", loggedInUser.docId); 
            const docSnap = await getDoc(userRef); 
            if (docSnap.exists()) loggedInUser = { ...docSnap.data(), docId: docSnap.id }; 
            if (loggedInUser.pendingTransaction > 0) { 
                opts.style.display = 'none'; 
                pend.style.display = 'block'; 
                document.getElementById('pending-info-text').innerHTML = `Selesaikan pembayaran <strong style="color: #f59e0b; font-size: 1.2em;">Rp ${loggedInUser.pendingTransaction.toLocaleString('id-ID')}</strong>.`; 
            } else { 
                opts.style.display = 'block'; 
                pend.style.display = 'none'; 
            } 
            displayTransactionHistory(); 
        }
        async function generateQrisScreen(baseAmount) { if (baseAmount < 10000) { showToast("Minimum top up Rp 10.000", "error"); return; } const uniqueCode = Math.floor(100 + Math.random() * 900); const totalAmount = baseAmount + uniqueCode; try { const userRef = doc(db, "users", loggedInUser.docId); await updateDoc(userRef, { pendingTransaction: totalAmount }); loggedInUser.pendingTransaction = totalAmount; activeTopupRequest = { baseAmount, totalAmount, username: loggedInUser.username, whatsapp: loggedInUser.whatsapp }; document.getElementById('qris-amount-display').innerText = `Rp ${totalAmount.toLocaleString('id-ID')}`; showPage('qris'); } catch (e) { showToast("Gagal memulai transaksi.", "error"); } }
        async function sendTelegramNotification() { const btn = document.getElementById('confirm-payment-btn'); btn.disabled = true; btn.innerText = "Mengirim..."; const { totalAmount, username, whatsapp } = activeTopupRequest; const msg = `ð *Konfirmasi Pembayaran*\n\n*Username:* \`${username}\`\n*No. WA:* \`${whatsapp}\`\n*Jumlah Transfer:* *Rp ${totalAmount.toLocaleString('id-ID')}*\n\nPengguna telah mengkonfirmasi.`; const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`; try { const res = await fetch(url); if (!res.ok) throw new Error('Gagal kirim notifikasi.'); showToast("Konfirmasi terkirim! Admin akan segera memproses.", "success"); showTopupMenu(); } catch (e) { showToast("Gagal kirim notifikasi. Hubungi admin manual.", "error"); } finally { btn.disabled = false; btn.innerText = "Saya Sudah Transfer"; } }
        async function cancelTopupTransaction(event) {
            const clickedButton = event.target;
            const isConfirmed = await showConfirmation(`Apakah Anda yakin ingin membatalkan transaksi top up ini? Nominal yang harus dibayar akan dihapus.`, "Konfirmasi Pembatalan");
            if (!isConfirmed) {
                return;
            }
            const originalText = clickedButton.innerText;
            clickedButton.disabled = true;
            clickedButton.innerText = "Membatalkan...";
            const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
            if (confirmPaymentBtn) {
                confirmPaymentBtn.disabled = true;
            }
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, {
                    pendingTransaction: 0
                });
                loggedInUser.pendingTransaction = 0;
                activeTopupRequest = {};
                showToast("Transaksi top up berhasil dibatalkan.", "success");
                showTopupMenu();
            } catch (e) {
                showToast("Gagal membatalkan transaksi: " + e.message, "error");
                console.error("Error cancelling transaction:", e);
            } finally {
                clickedButton.disabled = false;
                clickedButton.innerText = originalText;
                if (confirmPaymentBtn) {
                    confirmPaymentBtn.disabled = false;
                }
            }
        }
        async function displayTransactionHistory() {
            const topupList = document.getElementById('topup-history-list');
            const purchaseList = document.getElementById('purchase-history-list');
            topupList.innerHTML = '<li>Memuat...</li>';
            purchaseList.innerHTML = '<li>Memuat...</li>';
            const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
            try {
                const topupQuery = query(collection(db, "topup_history"), where("userId", "==", loggedInUser.docId), orderBy("timestamp", "desc"), limit(20));
                const topupSnapshot = await getDocs(topupQuery);
                topupList.innerHTML = '';
                if (topupSnapshot.empty) { topupList.innerHTML = '<li class="no-history">Tidak ada riwayat.</li>'; }
                else { topupSnapshot.forEach(doc => { const data = doc.data(); topupList.innerHTML += `<li class="topup"><div class="history-item-header"><span class="amount topup">+ Rp ${data.amount.toLocaleString('id-ID')}</span><span>${data.status}</span></div><div class="history-item-footer">${formatDate(data.timestamp)}</div></li>`; }); }
            } catch (error) { console.error("Error fetching topup history:", error); topupList.innerHTML = '<li class="no-history">Gagal memuat riwayat.</li>'; }
            try {
                const purchaseQuery = query(collection(db, "purchase_history"), where("userId", "==", loggedInUser.docId), orderBy("timestamp", "desc"), limit(40));
                const purchaseSnapshot = await getDocs(purchaseQuery);
                purchaseList.innerHTML = '';
                if (purchaseSnapshot.empty) { purchaseList.innerHTML = '<li class="no-history">Tidak ada riwayat pembelian.</li>'; }
                else {
                    purchaseSnapshot.forEach(doc => {
                        const item = doc.data();
                        let actionText;
                        if (typeof item.ubAmount === 'number') {
                             const isAdding = item.ubAmount > 0;
                             actionText = (isAdding ? `+${item.ubAmount.toLocaleString('id-ID')} UB` : `${item.ubAmount.toLocaleString('id-ID')} UB`);
                        } else {
                            actionText = `Beli: ${item.ubAmount}`; 
                        }
                        const costText = item.rpCost > 0 ? `- Rp ${item.rpCost.toLocaleString('id-ID')}` : 'Gratis'; 
                        const costClass = item.rpCost > 0 ? 'purchase' : 'topup'; 
                        purchaseList.innerHTML += `<li class="${costClass}"><div class="history-item-header"><span class="amount ${costClass}">${costText}</span><span>${item.game}</span></div><div class="history-item-footer"><span>${actionText}</span> | <span>${formatDate(item.timestamp)}</span></div></li>`; 
                    });
                }
            } catch (error) { console.error("Error fetching purchase history:", error); purchaseList.innerHTML = '<li class="no-history">Gagal memuat riwayat.</li>'; }
        }
        
        async function moveOtherAccountToTop(index) {
            const indexNum = parseInt(index, 10);
            if (isNaN(indexNum) || indexNum < 0 || indexNum >= otherAccounts.length) return;
            
            const [accountToMove] = otherAccounts.splice(indexNum, 1);
            otherAccounts.unshift(accountToMove);
            
            await saveOtherAccounts();
            await fetchAllGameProfiles();
            await renderOtherAccounts();
        }

        async function handleDeleteAccount(gameName, xAuth, index) {
            const confirmation = prompt('Apakah Anda yakin ingin menghapus akun ini secara permanen? Tindakan ini tidak dapat diurungkan. Ketik "ok" untuk melanjutkan.');
            if (confirmation?.toLowerCase() !== 'ok') { showToast("Penghapusan akun dibatalkan.", "success"); return; }
            const button = document.querySelector(`.settings-actions button[data-action="delete-account"][data-game-name="${gameName}"]`);
            button.disabled = true; button.innerText = "Menghapus...";
            const host = gameConfigs[gameName].host;
            try {
                const res = await fetch(`https://${host}/Client/ExecuteCloudScript?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': xAuth, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ FunctionName: "DeleteUsers", FunctionParameter: null, GeneratePlayStreamEvent: false }) });
                const result = await res.json();
                if (result.code !== 200) throw new Error(result.errorMessage || 'Gagal menghapus akun.');
                showToast("Akun game berhasil dihapus secara permanen.", "success");
                if (index !== null && index !== undefined) {
                    await moveOtherAccountToTop(index);
                } else {
                    await fetchAllGameProfiles();
                    await renderOtherAccounts();
                }
            } catch (e) { showToast(`Gagal menghapus akun: ${e.message}`, 'error'); button.disabled = false; button.innerText = "Hapus Akun"; }
        }
        async function handleChangeName(gameName, xAuth, index) {
            const newName = prompt("Masukkan nama baru untuk akun game Anda:");
            if (!newName || newName.trim() === '') { showToast("Penggantian nama dibatalkan.", "success"); return; }
            const button = document.querySelector(`.settings-actions button[data-action="change-name"][data-game-name="${gameName}"]`);
            if (button) { button.disabled = true; button.innerText = "Menyimpan..."; }
            const host = gameConfigs[gameName].host;
            try {
                const res = await fetch(`https://${host}/Client/UpdateUserTitleDisplayName?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': xAuth, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ DisplayName: newName.trim() }) });
                const result = await res.json();
                if (result.code !== 200) throw new Error(result.errorMessage || 'Gagal mengganti nama.');
                showToast("Nama berhasil diganti!", "success");
                if (index !== null && index !== undefined) {
                    otherAccounts[index].name = newName.trim();
                    await moveOtherAccountToTop(index);
                } else {
                    await fetchAllGameProfiles();
                    await renderOtherAccounts();
                }
            } catch (e) { showToast(`Gagal mengganti nama: ${e.message}`, 'error'); } finally { if(button) { button.disabled = false; button.innerText = "Ganti Nama"; } }
        }
        
        async function refreshCurrentPageContent() {
            showToast("Koneksi kembali terhubung. Memuat ulang data...", "success");
            if (!loggedInUser) { return; }
            if(loggedInUser.accountType === 'Admin'){
                 showPage('stokAkun');
                 return;
            }
            await fetchAllGameProfiles();
            await renderOtherAccounts();
            const activePageKey = Object.keys(dom.nav).find(key => dom.nav[key].classList.contains('active'));
            if (!activePageKey) {
                if (dom.content.myAccount.style.display === 'block') {
                    displayMyAccountInfo();
                }
                return;
            };
            switch (activePageKey) {
                case 'topup': await showTopupMenu(); break;
                case 'subscription': updateSubscriptionPage(); break;
            }
        }

        function showAccountStatusModal() {
            const contentEl = dom.statusModal.content;
            let contentHTML = '';
            const type = loggedInUser?.accountType || 'USER';

            if (type === 'Admin') {
                contentHTML = `
                    <h4>Status: Administrator</h4>
                    <p>Anda memiliki akses penuh ke semua fitur tanpa biaya.</p>
                    <ul>
                        <li>â­ Akses berlaku <strong>selamanya</strong>.</li>
                        <li>âï¸ Top-up UB sepuasnya (GRATIS).</li>
                        <li>âï¸ Akses ke menu Stok Akun.</li>
                    </ul>`;
            } else if (type === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                contentHTML = `
                    <h4>Status: Langganan</h4>
                    <p>Anda memiliki akses penuh selama masa langganan aktif.</p>
                    <ul>
                        <li>â­ Sisa masa aktif: <strong>${remainingDays} hari</strong>.</li>
                        <li>âï¸ Top-up UB sepuasnya tanpa biaya.</li>
                        <li>âï¸ Gunakan fitur Joki via Admin tanpa biaya.</li>
                    </ul>`;
            } else if (type === 'PREMIUM') {
                contentHTML = `
                    <h4>Status: PREMIUM</h4>
                    <p>Anda memiliki akses penuh dan permanen ke semua fitur.</p>
                    <ul>
                        <li>â­ Akses berlaku <strong>selamanya</strong>.</li>
                        <li>âï¸ Top-up UB sepuasnya tanpa biaya (GRATIS).</li>
                        <li>âï¸ Gunakan fitur Joki via Admin tanpa biaya (GRATIS).</li>
                        <li>âï¸ Prioritas dukungan dari admin.</li>
                    </ul>`;
            }
            contentEl.innerHTML = contentHTML;
            showModal(dom.statusModal.overlay);
        }

        function updateSubscriptionPage() {
            if (loggedInUser.pendingSubscription) {
                document.getElementById('subscription-packages-view').style.display = 'none';
                showSubscriptionQrisScreen(loggedInUser.pendingSubscription);
            } else {
                dom.content.subscriptionQris.style.display = 'none';
                document.getElementById('subscription-packages-view').style.display = 'block';
                
                const monthlyBtn = document.getElementById('buy-monthly-sub-btn');
                const permanentBtn = document.getElementById('buy-permanent-sub-btn');

                monthlyBtn.disabled = false;
                monthlyBtn.innerText = 'Beli Langganan';
                permanentBtn.disabled = false;
                permanentBtn.innerText = 'Beli Premium';
                
                if (loggedInUser.accountType === 'Langganan') {
                    monthlyBtn.disabled = true;
                    monthlyBtn.innerText = 'Terbeli';
                } else if (loggedInUser.accountType === 'PREMIUM') {
                    monthlyBtn.disabled = true;
                    monthlyBtn.innerText = 'Terbeli';
                    permanentBtn.disabled = true;
                    permanentBtn.innerText = 'Terbeli';
                }
            }
        }

        async function initiateSubscriptionPayment(type, baseAmount) {
            if (loggedInUser.pendingSubscription || loggedInUser.pendingTransaction > 0) {
                showToast("Anda memiliki transaksi yang belum selesai.", "error");
                return;
            }

            const uniqueAmount = baseAmount + Math.floor(100 + Math.random() * 900);
            const expiryDate = new Date();
            expiryDate.setHours(expiryDate.getHours() + 6);
            const expiryTimestamp = Timestamp.fromDate(expiryDate);

            const pendingData = { type, amount: baseAmount, uniqueAmount, expiryTimestamp };
            const userRef = doc(db, "users", loggedInUser.docId);

            try {
                await updateDoc(userRef, { pendingSubscription: pendingData });
                loggedInUser.pendingSubscription = pendingData;
                updateSubscriptionPage();
                showToast("Memulai pembayaran...", "success");
            } catch (error) {
                console.error("Error initiating subscription payment:", error);
                showToast("Gagal memulai pembayaran langganan.", "error");
            }
        }

        function showSubscriptionQrisScreen(pendingData) {
            dom.content.subscription.style.display = 'none';
            dom.content.subscriptionQris.style.display = 'block';
            
            const packageName = pendingData.type === 'Langganan' ? 'Langganan Bulanan' : 'Premium Permanen';
            document.getElementById('sub-qris-package-name').textContent = `Paket: ${packageName}`;
            document.getElementById('sub-qris-amount-display').textContent = `Rp ${pendingData.uniqueAmount.toLocaleString('id-ID')}`;

            startSubscriptionTimer(pendingData.expiryTimestamp);
        }

        function startSubscriptionTimer(expiryTimestamp) {
            if (subQrisTimerInterval) clearInterval(subQrisTimerInterval);

            const timerEl = document.getElementById('sub-qris-timer');
            const expiryDate = expiryTimestamp.toDate();

            subQrisTimerInterval = setInterval(() => {
                const now = new Date();
                const diff = expiryDate.getTime() - now.getTime();

                if (diff <= 0) {
                    clearInterval(subQrisTimerInterval);
                    timerEl.textContent = "Waktu pembayaran habis.";
                    if (loggedInUser && loggedInUser.pendingSubscription) {
                       cancelSubscriptionTransaction(true);
                    }
                    return;
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                timerEl.textContent = `Batal Otomatis dalam: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        async function sendSubscriptionTelegramNotification() {
            const btn = document.getElementById('confirm-sub-payment-btn');
            btn.disabled = true; btn.innerText = "Mengirim...";
            
            const { type, uniqueAmount } = loggedInUser.pendingSubscription;
            const packageName = type === 'Langganan' ? 'Langganan Bulanan' : 'Premium Permanen';
            const msg = `ð *Konfirmasi Langganan*\n\n*Username:* \`${loggedInUser.username}\`\n*No. WA:* \`${loggedInUser.whatsapp}\`\n*Paket:* *${packageName}*\n*Jumlah Transfer:* *Rp ${uniqueAmount.toLocaleString('id-ID')}*\n\nPengguna telah mengkonfirmasi pembayaran.`;
            
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Gagal kirim notifikasi.');
                showToast("Konfirmasi terkirim! Admin akan segera memproses.", "success");
            } catch (e) {
                showToast("Gagal kirim notifikasi. Hubungi admin manual.", "error");
            } finally {
                btn.disabled = false; btn.innerText = "Saya Sudah Transfer";
            }
        }

        async function cancelSubscriptionTransaction(isSilent = false) {
            if (!isSilent) {
                const isConfirmed = await showConfirmation(`Apakah Anda yakin ingin membatalkan pembelian langganan ini?`, "Konfirmasi Pembatalan");
                if (!isConfirmed) return;
            }

            if (subQrisTimerInterval) clearInterval(subQrisTimerInterval);
            
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { pendingSubscription: null });
                showToast("Pembelian langganan dibatalkan.", "success");
            } catch (error) {
                showToast("Gagal membatalkan: " + error.message, "error");
            }
        }

        async function handleVerifyUser(event) {
            event.preventDefault();
            const btn = document.getElementById('verify-user-btn');
            btn.disabled = true; btn.innerText = 'Memverifikasi...';
            const username = document.getElementById('verify-username').value;
            const email = document.getElementById('verify-email').value;
            const whatsapp = document.getElementById('verify-whatsapp').value;

            try {
                const q = query(collection(db, "users"), 
                    where("username", "==", username),
                    where("email", "==", email),
                    where("whatsapp", "==", whatsapp)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    showToast("Data pengguna tidak ditemukan atau tidak cocok.", "error");
                } else {
                    const userDoc = querySnapshot.docs[0];
                    userToResetPasswordId = userDoc.id;
                    document.getElementById('verify-user-view').style.display = 'none';
                    document.getElementById('reset-password-view').style.display = 'block';
                    showToast("Verifikasi berhasil! Silakan buat sandi baru.", "success");
                }
            } catch (e) {
                console.error("Verification error:", e);
                showToast("Terjadi kesalahan saat verifikasi.", "error");
            } finally {
                btn.disabled = false; btn.innerText = 'Verifikasi Akun';
            }
        }

        async function handleResetPassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('reset-new-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;

            if (newPassword.length < 6) {
                showToast("Sandi minimal 6 karakter.", "error");
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast("Sandi baru tidak cocok.", "error");
                return;
            }

            const btn = document.getElementById('reset-password-btn');
            btn.disabled = true; btn.innerText = 'Menyimpan...';

            try {
                const userRef = doc(db, "users", userToResetPasswordId);
                await updateDoc(userRef, { password: newPassword });
                showToast("Kata sandi berhasil direset! Silakan login.", "success", 4000);
                userToResetPasswordId = null;
                setTimeout(showLoginScreen, 1000);
            } catch(e) {
                console.error("Password reset error:", e);
                showToast("Gagal menyimpan sandi baru.", "error");
            } finally {
                btn.disabled = false; btn.innerText = 'Simpan Sandi Baru';
            }
        }
        
        async function fetchAndDisplayLeaderboard(event) {
            const btn = event.target.closest('[data-action="check-rank"]');
            if (!btn) return;

            const host = btn.dataset.host;
            const sessionTicket = btn.dataset.xauth;
            const card = btn.closest('.profile-card');
            const placeholder = card.querySelector('.leaderboard-placeholder');
            const container = card.querySelector('.leaderboard-container');
            
            btn.disabled = true;
            btn.textContent = 'Memuat...';

            try {
                const weeklyPromise = fetch(`https://${host}/Client/GetLeaderboardAroundPlayer?sdk=UnitySDK-2.206.241122`,{method:'POST',headers:{'Content-Type':'application/json','X-Authorization':sessionTicket,'X-ReportErrorAsSuccess':'true'},body:JSON.stringify({StatisticName:"KekayaanMingguan"})}).then(res => res.json());
                const monthlyPromise = fetch(`https://${host}/Client/GetLeaderboardAroundPlayer?sdk=UnitySDK-2.206.241122`,{method:'POST',headers:{'Content-Type':'application/json','X-Authorization':sessionTicket,'X-ReportErrorAsSuccess':'true'},body:JSON.stringify({StatisticName:"KekayaanBulanan"})}).then(res => res.json());
                const allTimePromise = fetch(`https://${host}/Client/GetLeaderboardAroundPlayer?sdk=UnitySDK-2.206.241122`,{method:'POST',headers:{'Content-Type':'application/json','X-Authorization':sessionTicket,'X-ReportErrorAsSuccess':'true'},body:JSON.stringify({StatisticName:"Kekayaan"})}).then(res => res.json());

                const [weeklyData, monthlyData, allTimeData] = await Promise.all([weeklyPromise, monthlyData, allTimePromise]);

                const formatRank = (rank) => rank !== null ? `#${(rank + 1).toLocaleString('id-ID')}` : '-';
                const formatValue = (value) => value !== null ? value.toLocaleString('id-ID') : '-';
                const createRankColumn = (title, rank, value) => `<div class="rank-column" style="display:flex;flex-direction:column;align-items:center;"><span style="color:var(--text-secondary);font-weight:500;font-size:0.8em;">${title}</span><div style="font-weight:700;color:var(--premium-gold);font-size:1.2em;">${formatRank(rank)}</div><div style="font-weight:500;color:var(--text-secondary);font-size:0.9em;letter-spacing:-0.5px;">${formatValue(value)}</div></div>`;
                
                let leaderboardHTML = '<div style="display: flex; gap: 6px; width: 100%; justify-content: space-around;">';
                leaderboardHTML += createRankColumn('S. MASA', allTimeData.data?.Leaderboard[0]?.Position, allTimeData.data?.Leaderboard[0]?.StatValue);
                leaderboardHTML += createRankColumn('MINGGUAN', weeklyData.data?.Leaderboard[0]?.Position, weeklyData.data?.Leaderboard[0]?.StatValue);
                leaderboardHTML += createRankColumn('BULANAN', monthlyData.data?.Leaderboard[0]?.Position, monthlyData.data?.Leaderboard[0]?.StatValue);
                leaderboardHTML += '</div><button data-action="close-rank" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:1.5em;position:absolute;top:-2px;right:-2px;line-height:1;">&times;</button>';
                
                container.innerHTML = leaderboardHTML;
                placeholder.style.display = 'none';
                container.style.display = 'flex';

            } catch(e) {
                showToast('Gagal memuat peringkat.', 'error');
                btn.disabled = false;
                btn.textContent = 'Cek Peringkat';
            }
        }
        
        function sortStokAkun(sortType = 'termurah') {
            const bussidGrid = document.getElementById('stok-akun-grid-bussid');
            const trucksidGrid = document.getElementById('stok-akun-grid-trucksid');
            
            const sortGrid = (grid) => {
                const cards = Array.from(grid.querySelectorAll('.stok-akun-card'));
                if (cards.length <= 1) return;

                cards.sort((a, b) => {
                    const priceA = parseFloat(a.dataset.price) || 0;
                    const priceB = parseFloat(b.dataset.price) || 0;
                    return sortType === 'termahal' ? priceB - priceA : priceA - priceB;
                });
                
                cards.forEach(card => grid.appendChild(card));
            };

            sortGrid(bussidGrid);
            sortGrid(trucksidGrid);
        }

        function setupStokAkunListener() {
            const bussidGrid = document.getElementById('stok-akun-grid-bussid');
            const trucksidGrid = document.getElementById('stok-akun-grid-trucksid');
            const purchasedGrid = document.getElementById('purchased-akun-grid');
            bussidGrid.innerHTML = '<p>Memuat...</p>';
            trucksidGrid.innerHTML = '<p>Memuat...</p>';
            purchasedGrid.innerHTML = '<p>Memuat...</p>';
            
            if (stokAkunUnsubscribe) stokAkunUnsubscribe();

            const q = query(collection(db, "stokAkun"), orderBy("createdAt", "desc"));
            stokAkunUnsubscribe = onSnapshot(q, (snapshot) => {
                const availableBussid = [];
                const availableTrucksid = [];
                const purchasedAccountsData = [];
                
                snapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (data.ownedBy) {
                        if (data.ownedBy === loggedInUser.username) {
                            purchasedAccountsData.push(data);
                        }
                    } else {
                        if (data.gameType === 'BUSSID') {
                            availableBussid.push(data);
                        } else if (data.gameType === 'TRUCKSID') {
                            availableTrucksid.push(data);
                        }
                    }
                });
                
                bussidGrid.innerHTML = '';
                if (availableBussid.length === 0) {
                     bussidGrid.innerHTML = '<p style="text-align: center; font-size: 0.8em;">Stok kosong.</p>';
                } else {
                    availableBussid.forEach(data => bussidGrid.innerHTML += createStokAkunCardHTML(data, false));
                }

                trucksidGrid.innerHTML = '';
                if (availableTrucksid.length === 0) {
                     trucksidGrid.innerHTML = '<p style="text-align: center; font-size: 0.8em;">Stok kosong.</p>';
                } else {
                    availableTrucksid.forEach(data => trucksidGrid.innerHTML += createStokAkunCardHTML(data, false));
                }
                
                purchasedGrid.innerHTML = '';
                if (purchasedAccountsData.length === 0) {
                    purchasedGrid.innerHTML = '<p style="text-align: center;">Anda belum membeli akun apapun.</p>';
                } else {
                    purchasedAccountsData.forEach(data => purchasedGrid.innerHTML += createStokAkunCardHTML(data, true));
                }

                sortStokAkun('termurah');
            });
        }
        
        function createStokAkunCardHTML(data, isUnlocked = false) {
            const { id, gameType, loginType, gameName, ub, price } = data;
            const gameLogo = gameConfigs[gameType]?.profileImage || '';
            const loginIcon = loginType === 'Facebook' ? '<i class="ph-fill ph-facebook-logo" style="color:#1877f2;"></i>' : '<i class="ph-fill ph-google-logo" style="color:#ea4335;"></i>';
            
            if (isUnlocked) {
                 const { email, password, deviceId, provisionedUsername, provisionedUb } = data;
                return `
                    <div class="stok-akun-card owned">
                         <div class="purchased-header-info">
                            <span class="purchased-username">${provisionedUsername || 'Nama Akun'}</span>
                            <span class="purchased-ub">UB: ${(provisionedUb || 0).toLocaleString('id-ID')}</span>
                        </div>
                        <div class="unlocked-grid">
                            <div class="unlocked-item">
                                <span class="unlocked-label">Login</span>
                                <span class="unlocked-value">${loginIcon} ${loginType}</span>
                            </div>
                            <div class="unlocked-item">
                                <span class="unlocked-label">Email/HP</span>
                                <span class="unlocked-value">${email}</span>
                                <i class="ph ph-copy copy-icon" onclick="copyToClipboard('${email}', 'Email disalin!')" title="Salin"></i>
                            </div>
                            <div class="unlocked-item">
                                <span class="unlocked-label">Sandi</span>
                                <span class="unlocked-value">${password}</span>
                                <i class="ph ph-copy copy-icon" onclick="copyToClipboard('${password}', 'Sandi disalin!')" title="Salin"></i>
                            </div>
                            <div class="unlocked-item">
                                <span class="unlocked-label">Device ID</span>
                                <span class="unlocked-value">${deviceId}</span>
                                <i class="ph ph-copy copy-icon" onclick="copyToClipboard('${deviceId}', 'Device ID disalin!')" title="Salin"></i>
                            </div>
                        </div>
                    </div>`;
            } else {
                 return `
                    <div class="stok-akun-card ${gameType.toLowerCase()}-card" id="stok-akun-${id}" data-price="${price || 0}">
                        <div class="stok-card-header">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <img src="${gameLogo}" alt="${gameType} Logo" class="stok-card-logo">
                                <h3 style="font-size: 1.1em; margin: 0;">${gameName || gameType}</h3>
                            </div>
                        </div>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label"><i class="ph ph-coins"></i> Uang Game (UB)</span>
                                <span class="info-value">${(ub || 0).toLocaleString('id-ID')}</span>
                            </div>
                            <div class="info-item price">
                                <span class="info-label"><i class="ph ph-tag"></i> Harga Akun</span>
                                <span class="info-value">Rp ${(price || 0).toLocaleString('id-ID')}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">${loginIcon} Login via</span>
                                <span class="info-value">${loginType}</span>
                            </div>
                        </div>
                        <button class="action-button btn-green" data-action="buy-stok-akun" data-id="${id}">Beli Akun</button>
                    </div>`;
            }
        }

        async function showAkunPurchaseModal(stokId) {
            const modal = dom.akunPurchaseModal;
            modal.form.reset();
            modal.stokIdInput.value = stokId;
            
            const detailsEl = document.getElementById('akun-purchase-details');
            const totalEl = dom.akunPurchaseModal.totalDisplay;
            detailsEl.innerHTML = '<p>Memuat detail...</p>';
            totalEl.textContent = 'Memuat...';
            showModal(modal.overlay);

            try {
                const docRef = doc(db, "stokAkun", stokId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error("Akun tidak ditemukan.");
                
                const data = docSnap.data();
                modal.usernameInput.value = data.gameName || '';
                detailsEl.innerHTML = data.detailInfo ? data.detailInfo.replace(/\n/g, '<br>') : 'Tidak ada detail tambahan.';
                totalEl.textContent = `Rp ${(data.price || 0).toLocaleString('id-ID')}`;
                
            } catch (error) {
                showToast(error.message, "error");
                detailsEl.innerHTML = `<p style="color: var(--accent-red);">${error.message}</p>`;
                totalEl.textContent = 'Error';
            }
        }

        async function handleExecuteAkunPurchase(event) {
            event.preventDefault();
            const modal = dom.akunPurchaseModal;
            const btn = modal.form.querySelector('button[type="submit"]');
            const stokId = modal.stokIdInput.value;
            const newUsername = modal.usernameInput.value.trim();

            if (!newUsername) {
                showToast("Username game baru tidak boleh kosong.", "error");
                return;
            }

            btn.disabled = true; btn.innerText = "Memproses...";
            let stokData;

            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", loggedInUser.docId);
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw new Error("User data not found.");
                    const currentUserData = userDoc.data();

                    const stokDocRef = doc(db, "stokAkun", stokId);
                    const stokDocSnap = await transaction.get(stokDocRef);
                    if (!stokDocSnap.exists() || stokDocSnap.data().ownedBy) throw new Error("Akun ini sudah tidak tersedia.");
                    
                    stokData = stokDocSnap.data();
                    const accountPrice = stokData.price || 0;

                    if (currentUserData.saldo < accountPrice) throw new Error("Saldo Anda tidak mencukupi.");

                    const confirmationMessage = `<div class="invoice-style-confirmation"><h4>** Struk Pembelian **</h4><div class="invoice-row"><span>Pembelian Akun ${stokData.gameType}</span><span class="price"></span></div><div class="invoice-row total"><span>TOTAL</span> <span class="price">Rp ${accountPrice.toLocaleString('id-ID')}</span></div></div>`;
                    const isConfirmed = await showConfirmation(confirmationMessage, "Struk Konfirmasi Pembelian");
                    if (!isConfirmed) throw new Error("Pembelian dibatalkan oleh pengguna.");
                    
                    const stokEmailQuery = query(collection(db, "stokEmail"), where("loginType", "==", stokData.loginType), where("isUsed", "==", false), limit(1));
                    const stokEmailSnapshot = await getDocs(stokEmailQuery);
                    if (stokEmailSnapshot.empty) throw new Error(`Stok akun dasar ${stokData.loginType} habis. Hubungi admin.`);

                    const baseAccountDoc = stokEmailSnapshot.docs[0];
                    const baseAccountData = baseAccountDoc.data();
                    const config = gameConfigs[stokData.gameType];

                    const loginRes = await fetch(`https://${config.host}/Client/LoginWithAndroidDeviceID?sdk=UnitySDK-2.206.241122`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ AndroidDevice: "AndroidPhone", AndroidDeviceId: baseAccountData.deviceId, CreateAccount: false, TitleId: config.titleId }) });
                    const loginData = await loginRes.json();
                    if (loginData.code !== 200 || !loginData.data?.SessionTicket) throw new Error("Gagal login ke akun dasar.");
                    const sessionTicket = loginData.data.SessionTicket;

                    const profileRes = await fetch(`https://${config.host}/Client/GetPlayerCombinedInfo?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket }, body: JSON.stringify({ InfoRequestParameters: { GetUserVirtualCurrency: true } }) });
                    const profileData = await profileRes.json();
                    const currentUb = profileData.data.InfoResultPayload.UserVirtualCurrency.RP || 0;
                    const targetUb = stokData.ub;
                    const ubDifference = targetUb - currentUb;

                    if (ubDifference !== 0) {
                        const payload = { FunctionName: "AddRp", FunctionParameter: { addValue: ubDifference } };
                        const execRes = await fetch(`https://${config.host}/Client/ExecuteCloudScript?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket }, body: JSON.stringify(payload) });
                        if (!execRes.ok) throw new Error("Gagal menyesuaikan UB akun.");
                    }
                    
                    await fetch(`https://${config.host}/Client/UpdateUserTitleDisplayName?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket }, body: JSON.stringify({ DisplayName: newUsername }) });

                    transaction.update(userRef, { saldo: currentUserData.saldo - accountPrice });
                    transaction.update(stokDocRef, {
                        ownedBy: currentUserData.username,
                        provisionedUsername: newUsername,
                        provisionedUb: targetUb,
                        ...baseAccountData
                    });
                    transaction.update(baseAccountDoc.ref, { isUsed: true, usedBy: currentUserData.username, usedAt: serverTimestamp() });
                });

                await addDoc(collection(db, "purchase_history"), { userId: loggedInUser.docId, username: loggedInUser.username, game: stokData.gameType, rpCost: stokData.price, ubAmount: `Akun (${stokData.gameName})`, status: "Success", timestamp: serverTimestamp() });
                showToast("Pembelian akun berhasil!", "success", 4000);
                hideModal(modal.overlay);
                await displayTransactionHistory();

            } catch (error) {
                showToast(`Gagal: ${error.message}`, "error", 5000);
            } finally {
                btn.disabled = false; btn.innerText = "Beli Akun";
            }
        }
        
        function manageSellAccountMenu() {
            dom.sellMenu.showBtn.addEventListener('click', () => {
                dom.sellMenu.floatingMenu.classList.add('visible');
                 if (loggedInUser.akunJualStatus && loggedInUser.akunJualStatus.status !== "Selesai(Terbayar Admin)") {
                    showSellStep(4);
                    updateProcessingList(loggedInUser.akunJualStatus.accounts);
                } else {
                    showSellStep(1);
                }
            });

            dom.sellMenu.closeProcessViewBtn.addEventListener('click', () => dom.sellMenu.floatingMenu.classList.remove('visible'));
            dom.sellMenu.closeBtn.addEventListener('click', () => dom.sellMenu.floatingMenu.classList.remove('visible'));
            dom.sellMenu.addAccountBtn.addEventListener('click', () => showSellStep(2));
            dom.sellMenu.backToListBtn.addEventListener('click', () => showSellStep(1));
            dom.sellMenu.processSellBtn.addEventListener('click', () => showSellStep(3));

            dom.sellMenu.loginType.addEventListener('change', (e) => {
                const type = e.target.value;
                dom.sellMenu.googleInputs.style.display = type === 'Google' ? 'block' : 'none';
                dom.sellMenu.facebookInputs.style.display = type === 'Facebook' ? 'block' : 'none';
            });

            dom.sellMenu.addForm.addEventListener('submit', handleAddAccountToSellList);
            dom.sellMenu.paymentForm.addEventListener('submit', handleFinalizeSale);

            document.querySelectorAll('.payment-option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.payment-option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
        }

        function showSellStep(step) {
            [dom.sellMenu.step1, dom.sellMenu.step2, dom.sellMenu.step3, dom.sellMenu.step4].forEach(s => s.style.display = 'none');
            document.getElementById(`sell-step-${step}`).style.display = 'block';
        }
        
        function handleAddAccountToSellList(e) {
            e.preventDefault();
            const type = dom.sellMenu.loginType.value;
            let credential, password;

            if (type === 'Google') {
                credential = document.getElementById('sell-google-email').value.trim();
                password = document.getElementById('sell-google-password').value;
            } else {
                credential = document.getElementById('sell-facebook-credential').value.trim();
                password = document.getElementById('sell-facebook-password').value;
            }

            if (!type || !credential || !password) {
                showToast("Semua kolom harus diisi.", "error");
                return;
            }

            const price = SELL_PRICES[type];
            accountsToSell.push({ type, credential, password, price });
            updateSellList();
            showSellStep(1);
            dom.sellMenu.addForm.reset();
             dom.sellMenu.googleInputs.style.display = 'none';
            dom.sellMenu.facebookInputs.style.display = 'none';
        }

        function updateSellList() {
            const listEl = dom.sellMenu.accountList;
            if (accountsToSell.length === 0) {
                listEl.innerHTML = '<p class="subtitle" id="no-sell-account-msg">Anda belum menambahkan akun untuk dijual.</p>';
                dom.sellMenu.processSellBtn.disabled = true;
            } else {
                listEl.innerHTML = '';
                accountsToSell.forEach((acc, index) => {
                    const item = document.createElement('div');
                    item.className = 'sell-account-item';
                    item.innerHTML = `
                        <div class="info">
                            <i class="ph-bold ${acc.type === 'Google' ? 'ph-google-logo' : 'ph-facebook-logo'}"></i>
                            <span>${acc.credential}</span>
                        </div>
                        <div class="price">Rp ${acc.price.toLocaleString('id-ID')}</div>
                    `;
                    listEl.appendChild(item);
                });
                dom.sellMenu.processSellBtn.disabled = false;
            }
            updateSellTotal();
        }

        function updateSellTotal() {
            const total = accountsToSell.reduce((sum, acc) => sum + acc.price, 0);
            dom.sellMenu.totalPrice.textContent = `Rp ${total.toLocaleString('id-ID')}`;
            dom.sellMenu.paymentTotal.textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }
        
        async function handleFinalizeSale(e) {
            e.preventDefault();
            const selectedPayment = document.querySelector('.payment-option-btn.selected');
            const phone = document.getElementById('sell-payment-phone').value.trim();

            if (!selectedPayment) {
                showToast("Pilih metode pembayaran.", "error");
                return;
            }
            if (!phone) {
                showToast("Masukkan nomor HP e-wallet.", "error");
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = "Mengirim...";

            const totalAmount = accountsToSell.reduce((sum, acc) => sum + acc.price, 0);
            const paymentMethod = selectedPayment.dataset.payment;
            
            let message = `ð *PENJUALAN AKUN BARU*\n\n`;
            message += `*Username App:* \`${loggedInUser.username}\`\n`;
            message += `*Total Bayaran:* *Rp ${totalAmount.toLocaleString('id-ID')}*\n`;
            message += `*Metode Bayar:* ${paymentMethod}\n`;
            message += `*No. HP:* \`${phone}\`\n\n`;
            message += `*--- DAFTAR AKUN ---*\n`;
            accountsToSell.forEach((acc, i) => {
                message += `${i + 1}. *Tipe:* ${acc.type}\n`;
                message += `   *Login:* \`${acc.credential}\`\n`;
                message += `   *Sandi:* \`${acc.password}\`\n\n`;
            });
            
            try {
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}&parse_mode=Markdown`;
                const res = await fetch(url);
                if (!res.ok) throw new Error("Gagal mengirim data ke admin.");

                const sellStatus = {
                    status: "Di Proses",
                    accounts: accountsToSell.map(a => a.credential)
                };
                
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { akunJualStatus: sellStatus });
                
                showSellStep(4);
                updateProcessingList(sellStatus.accounts);
                accountsToSell = [];
                updateSellList();
                
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerText = "Oke, Kirim ke Admin";
            }
        }

        function updateProcessingList(accountCredentials) {
            const listEl = dom.sellMenu.processingList;
            listEl.innerHTML = '';
            accountCredentials.forEach(cred => {
                const item = document.createElement('div');
                item.className = 'sell-account-item';
                item.innerHTML = `<span>${cred}</span>`;
                listEl.appendChild(item);
            });
        }
        
        function setupRealtimeAppSettings() {
            if (appSettingsListenerUnsubscribe) appSettingsListenerUnsubscribe();

            const appConfigRef = doc(db, "settings", "appConfig");
            appSettingsListenerUnsubscribe = onSnapshot(appConfigRef, (docSnap) => {
                const loginContainer = document.getElementById('login-container');
                const maintenanceNotice = document.getElementById('maintenance-notice');
                const maintenanceModal = dom.maintenanceModal.overlay;
                const maintenanceModalMessage = dom.maintenanceModal.message;

                if (docSnap.exists()) {
                    const config = docSnap.data();
                    
                    if (config.maintenance && config.maintenance.isActive) {
                        const message = config.maintenance.message || "Maaf, situs sedang dalam perbaikan rutin. Silakan coba lagi nanti.";
                        
                        if(loginContainer) loginContainer.style.display = 'none';
                        if(maintenanceNotice) {
                            maintenanceNotice.querySelector('#maintenance-message').textContent = message;
                            maintenanceNotice.style.display = 'block';
                        }
                        
                        if (loggedInUser) {
                           maintenanceModalMessage.textContent = message;
                           showModal(maintenanceModal);
                        }
                    } else {
                        if(maintenanceNotice) maintenanceNotice.style.display = 'none';
                        if(loginContainer && !loggedInUser) loginContainer.style.display = 'block';

                        if (loggedInUser) {
                           hideModal(maintenanceModal);
                        }
                    }
                }
            }, (error) => {
                console.error("Error listening to app settings:", error);
            });
        }

        async function checkAndShowWelcomeMessage() {
            const showMessage = async (msgData, type) => {
                dom.welcomeModal.title.textContent = msgData.title || "Pesan dari Admin";
                dom.welcomeModal.content.textContent = msgData.content;
                showModal(dom.welcomeModal.overlay);

                let statusUpdate = {};
                if (type === 'user') {
                    statusUpdate['welcomeMessage.timesShown'] = (loggedInUser.welcomeMessage?.timesShown || 0) + 1;
                } else {
                    const statusKey = type === 'global' ? 'globalMessageStatus' : 'newUserMessageStatus';
                    let currentStatus = loggedInUser[statusKey] || {};
                    if (currentStatus.messageId !== msgData.id) {
                        currentStatus = { messageId: msgData.id, timesShown: 0 };
                    }
                    currentStatus.timesShown += 1;
                    statusUpdate[statusKey] = currentStatus;
                }
                
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, statusUpdate);
            };

            try {
                if (loggedInUser.welcomeMessage && loggedInUser.welcomeMessage.content) {
                    const msg = loggedInUser.welcomeMessage;
                    const timesShown = msg.timesShown || 0;
                    if (msg.targetLogins > timesShown) {
                        await showMessage(msg, 'user');
                        return;
                    }
                }

                const appConfigRef = doc(db, "settings", "appConfig");
                const docSnap = await getDoc(appConfigRef);
                if (!docSnap.exists()) return;
                
                const config = docSnap.data();

                if (loggedInUser.loginCount === 1 && config.welcomeMessages?.newUser?.content) {
                    const msg = config.welcomeMessages.newUser;
                     await showMessage(msg, 'newUser');
                     return;
                }

                if (config.welcomeMessages?.global?.content) {
                    const msg = config.welcomeMessages.global;
                    const status = loggedInUser.globalMessageStatus || { messageId: null, timesShown: 0 };
                    
                    if (status.messageId !== msg.id || status.timesShown < msg.targetLogins) {
                         await showMessage(msg, 'global');
                    }
                }
            } catch (error) {
                console.error("Error checking welcome message:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            window.copyToClipboard = copyToClipboard;
            
            setupRealtimeAppSettings();

            setupPasswordToggle('password', 'login-password-toggle');
            setupPasswordToggle('reg-password', 'reg-password-toggle');
            setupPasswordToggle('reset-new-password', 'reset-password-toggle');
            document.getElementById('login-form').addEventListener('submit', login);
            document.getElementById('register-form').addEventListener('submit', register);
            document.getElementById('verify-user-form').addEventListener('submit', handleVerifyUser);
            document.getElementById('reset-password-form').addEventListener('submit', handleResetPassword);
            document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
            document.getElementById('show-login-link-from-reg').addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
            document.getElementById('show-forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); showForgotPasswordScreen(); });
            document.getElementById('show-login-link-from-forgot').addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });


            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('cs-admin-btn').addEventListener('click', () => showModal(dom.adminProfileModal.overlay));
            dom.adminProfileModal.closeBtn.addEventListener('click', () => hideModal(dom.adminProfileModal.overlay));
            dom.sellStatusModal.closeBtn.addEventListener('click', () => hideModal(dom.sellStatusModal.overlay));
            dom.welcomeModal.closeBtn.addEventListener('click', () => hideModal(dom.welcomeModal.overlay));
            dom.welcomeModal.okBtn.addEventListener('click', () => hideModal(dom.welcomeModal.overlay));

            
            document.getElementById('header-my-account-btn').addEventListener('click', () => {
                if (!checkSubscriptionStatus()) return;
                showPage('myAccount');
            });

            Object.keys(dom.nav).forEach(key => {
                if (dom.nav[key]) {
                    dom.nav[key].addEventListener('click', async (e) => {
                        e.preventDefault();
                        if (!checkSubscriptionStatus()) return;
                        
                        if (stokAkunUnsubscribe && key !== 'stokAkun') {
                             stokAkunUnsubscribe();
                             stokAkunUnsubscribe = null;
                        }

                        if (key === 'topup') { await showTopupMenu(); }
                        else { await showPage(key); }
                    });
                }
            });
            
            document.getElementById('stok-akun-container').addEventListener('click', (e) => {
                const availableBtn = document.getElementById('show-available-btn');
                const purchasedBtn = document.getElementById('show-purchased-btn');
                const headerControls = document.getElementById('stok-akun-header-controls');
                const beliAkunWrapper = document.getElementById('beli-akun-wrapper');
                const purchasedGrid = document.getElementById('purchased-akun-grid');
                const purchasedInfo = document.getElementById('purchased-akun-info');

                if (e.target.id === 'show-available-btn' || e.target.id === 'show-purchased-btn') {
                    availableBtn.classList.toggle('active', e.target.id === 'show-available-btn');
                    purchasedBtn.classList.toggle('active', e.target.id === 'show-purchased-btn');
                    const isAvailableView = e.target.id === 'show-available-btn';
                    beliAkunWrapper.style.display = isAvailableView ? 'grid' : 'none';
                    headerControls.querySelector('h2').style.display = 'block';
                    headerControls.querySelector('.subtitle').style.display = 'block';
                    document.getElementById('stok-akun-sort-controls').style.display = isAvailableView ? 'flex' : 'none';
                    purchasedGrid.style.display = isAvailableView ? 'none' : 'grid';
                    if(purchasedInfo) purchasedInfo.style.display = isAvailableView ? 'none' : 'block';
                }

                const sortBtn = e.target.closest('[data-sort]');
                if (sortBtn) {
                    document.querySelectorAll('#stok-akun-sort-controls .filter-btn').forEach(btn => btn.classList.remove('active'));
                    sortBtn.classList.add('active');
                    const sortType = sortBtn.dataset.sort;
                    sortStokAkun(sortType);
                }

                const buyBtn = e.target.closest('[data-action="buy-stok-akun"]');
                 if (buyBtn) {
                    const { id } = buyBtn.dataset;
                    showAkunPurchaseModal(id);
                    return;
                }
            });

            document.getElementById('profile-container').addEventListener('click', (e) => {
                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget) return;

                const action = actionTarget.dataset.action;
                const card = actionTarget.closest('.profile-card');
                const index = card?.dataset.index !== undefined ? card.dataset.index : null;

                switch (action) {
                    case 'topup': {
                        const isValidName = actionTarget.dataset.validName === 'true';
                        const gameName = actionTarget.dataset.game;
                        if (!isValidName) {
                            const modal = dom.maintenanceModal;
                            const modalTitle = modal.overlay.querySelector('h2');
                            if (modalTitle) modalTitle.textContent = 'AKUN GAGAL DIMUAT';
                            modal.message.innerHTML = `Hai pelanggan yang terhormat, akun gagal dimuat. Oleh karena itu, pengisian UB tidak dapat dilaksanakan. Ini terjadi karena <strong>NICKNAME</strong> player tidak terbaca oleh sistem kami.<br><br>Pastikan Anda sudah mengatur Nickname di dalam game <strong>${gameName}</strong> Anda. Jika sudah diatur namun masih gagal, mungkin terdapat masalah pada data akun Anda.<br><br>Silakan hubungi admin @donitata1717 untuk bantuan lebih lanjut.`;
                            showModal(modal.overlay);
                        } else {
                            const session = actionTarget.dataset.session;
                            showBuyUbScreen(gameName, session || null, index);
                        }
                        break;
                    }
                    case 'reduce-ub': {
                        const gameName = actionTarget.dataset.game;
                        let targetSessionKey;
                        if (index !== null) {
                            const account = otherAccounts[parseInt(index, 10)];
                            targetSessionKey = activeGameSessions[`${account.name}-${account.game}`];
                        } else {
                            targetSessionKey = activeGameSessions[gameName];
                        }
                        if (!targetSessionKey) { showToast("Sesi game tidak valid atau kadaluarsa.", "error"); return; }
                        currentTransactionTarget = { name: gameName, otherAccountIndex: index, ...targetSessionKey };
                        document.getElementById('reduce-ub-amount').value = ''; 
                        showModal(document.getElementById('reduce-ub-modal'));
                        break;
                    }
                    case 'flip':
                    case 'flip-back':
                        card.classList.toggle('settings-active');
                        break;
                    case 'change-name': {
                        const gameName = actionTarget.dataset.gameName;
                        const xAuth = actionTarget.dataset.xAuth;
                        handleChangeName(gameName, xAuth, index);
                        break;
                    }
                    case 'delete-account': {
                        const gameName = actionTarget.dataset.gameName;
                        const xAuth = actionTarget.dataset.xAuth;
                        handleDeleteAccount(gameName, xAuth, index);
                        break;
                    }
                    case 'delete-from-list':
                        handleDeleteOtherAccount(actionTarget.dataset.index);
                        break;
                    case 'check-rank':
                        fetchAndDisplayLeaderboard(e);
                        break;
                    case 'close-rank': {
                         const placeholder = card.querySelector('.leaderboard-placeholder');
                         const container = card.querySelector('.leaderboard-container');
                         const btn = placeholder.querySelector('button');
                         container.style.display = 'none';
                         placeholder.style.display = 'flex';
                         btn.disabled = false;
                         btn.textContent = 'Cek Peringkat';
                         break;
                    }
                }
            });
            
            document.getElementById('search-account-input').addEventListener('input', filterProfileCardsBySearch);
            document.getElementById('profile-container').addEventListener('contextmenu', e => e.preventDefault());
            document.getElementById('profile-container').addEventListener('mousedown', e => { const item = e.target.closest('.settings-info-item'); if (item) { addLongPressListener(item, () => copyToClipboard(item.dataset.copyValue, `${item.querySelector('.label').innerText} disalin!`)); } });
            
            document.getElementById('ub-slider').addEventListener('input', () => updateUbDisplay('slider'));
            document.getElementById('ub-input').addEventListener('input', () => updateUbDisplay('input'));
            document.getElementById('ub-input').addEventListener('blur', () => {
                const cleanValue = document.getElementById('ub-input').value.replace(/\./g, '');
                const numValue = parseInt(cleanValue, 10) || 0;
                document.getElementById('ub-input').value = numValue.toLocaleString('id-ID');
            });


            document.getElementById('buy-ub-form').addEventListener('submit', (e) => { e.preventDefault(); const ubAmount = document.getElementById('ub-input').value; executeUbTransaction(ubAmount); });
            document.getElementById('cancel-buy-ub-btn').addEventListener('click', () => showPage(activeGameTab));
            document.getElementById('max-ub-btn').addEventListener('click', () => {
                const slider = document.getElementById('ub-slider');
                const input = document.getElementById('ub-input');
                slider.value = 100;
                input.value = (2147483647).toLocaleString('id-ID');
                updateUbDisplay('slider');
                showToast(`UB diatur ke nilai maksimal!`, 'success');
            });
            document.getElementById('close-reduce-ub-modal').addEventListener('click', () => hideModal(document.getElementById('reduce-ub-modal')));
            document.getElementById('reduce-ub-form').addEventListener('submit', (e) => { e.preventDefault(); const ubAmount = document.getElementById('reduce-ub-amount').value; executeUbTransaction(-Math.abs(parseInt(ubAmount, 10))); });
            
            document.querySelectorAll('.topup-card').forEach(card => card.addEventListener('click', () => generateQrisScreen(parseInt(card.dataset.amount, 10))));
            document.getElementById('custom-topup-form').addEventListener('submit', (e) => { e.preventDefault(); const amount = parseInt(document.getElementById('custom-amount-input').value, 10); if (amount) generateQrisScreen(amount); });

            document.getElementById('confirm-payment-btn').addEventListener('click', sendTelegramNotification);
            document.getElementById('cancel-qris-btn').addEventListener('click', cancelTopupTransaction);
            document.getElementById('check-status-again-btn').addEventListener('click', () => {
                if (loggedInUser && loggedInUser.pendingTransaction > 0) {
                    document.getElementById('qris-amount-display').innerText = `Rp ${loggedInUser.pendingTransaction.toLocaleString('id-ID')}`;
                    showPage('qris');
                } else {
                    showTopupMenu();
                }
            });
            document.getElementById('cancel-from-pending-btn').addEventListener('click', cancelTopupTransaction);
            document.getElementById('other-account-form').addEventListener('submit', handleAddOtherAccount);
            document.getElementById('paste-key-btn').addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('other-account-key').value = text;
                    showToast('Teks berhasil ditempel!', 'success');
                } catch (err) {
                    showToast('Gagal menempel dari clipboard.', 'error');
                }
            });

            dom.akunPurchaseModal.closeBtn.addEventListener('click', () => hideModal(dom.akunPurchaseModal.overlay));
            dom.akunPurchaseModal.overlay.addEventListener('click', e => { if (e.target === dom.akunPurchaseModal.overlay) hideModal(dom.akunPurchaseModal.overlay); });
            dom.akunPurchaseModal.form.addEventListener('submit', handleExecuteAkunPurchase);

            document.getElementById('close-device-id-modal-btn').addEventListener('click', () => hideModal(document.getElementById('device-id-modal')));
            document.getElementById('device-id-modal').addEventListener('click', (e) => { if (e.target.id === 'device-id-modal') hideModal(e.target); });
            document.getElementById('change-password-btn').addEventListener('click', () => showModal(document.getElementById('change-password-modal')));
            document.getElementById('close-password-modal').addEventListener('click', () => hideModal(document.getElementById('change-password-modal')));
            document.getElementById('change-password-form').addEventListener('submit', handleUpdatePassword);
            document.getElementById('change-device-id-btn').addEventListener('click', () => showModal(document.getElementById('change-device-id-modal')));
            document.getElementById('close-device-id-modal').addEventListener('click', () => hideModal(document.getElementById('change-device-id-modal')));
            document.getElementById('change-device-id-form').addEventListener('submit', handleUpdateDeviceId);
            document.getElementById('account-logout-btn').addEventListener('click', logout);
            document.getElementById('change-password-modal').addEventListener('click', (e) => { if (e.target.id === 'change-password-modal') hideModal(e.target); });
            document.getElementById('change-device-id-modal').addEventListener('click', (e) => { if (e.target.id === 'change-device-id-modal') hideModal(e.target); });
            document.getElementById('reduce-ub-modal').addEventListener('click', (e) => { if (e.target.id === 'reduce-ub-modal') hideModal(e.target); });
            document.getElementById('add-balance-btn').addEventListener('click', showTopupMenu);
            document.getElementById('buy-monthly-sub-btn').addEventListener('click', () => initiateSubscriptionPayment('Langganan', 35000));
            document.getElementById('buy-permanent-sub-btn').addEventListener('click', () => initiateSubscriptionPayment('PREMIUM', 199000));
            document.getElementById('confirm-sub-payment-btn').addEventListener('click', sendSubscriptionTelegramNotification);
            document.getElementById('cancel-sub-qris-btn').addEventListener('click', () => cancelSubscriptionTransaction(false));
            document.querySelector('.sidebar-balance-card').addEventListener('click', () => {
                if (loggedInUser && (loggedInUser.accountType === 'USER' || loggedInUser.accountType === 'Admin')) {
                    if (loggedInUser.accountType === 'USER') showTopupMenu();
                    else showAccountStatusModal();
                } else {
                    showAccountStatusModal();
                }
            });
            dom.statusModal.closeBtn.addEventListener('click', () => hideModal(dom.statusModal.overlay));
            dom.statusModal.overlay.addEventListener('click', (e) => { if (e.target === dom.statusModal.overlay) hideModal(dom.statusModal.overlay); });

            const mainContent = document.getElementById('main-content');
            mainContent.addEventListener('click', (e) => {
                if (e.target.id === 'qris-image' || e.target.id === 'sub-qris-image') { dom.lightbox.image.src = e.target.src; showModal(dom.lightbox.overlay); }
            });
            const closeLightbox = () => { hideModal(dom.lightbox.overlay); dom.lightbox.image.src = ''; };
            dom.lightbox.closeBtn.addEventListener('click', closeLightbox);
            dom.lightbox.overlay.addEventListener('click', (e) => { if (e.target === dom.lightbox.overlay) closeLightbox(); });
            const offlineModal = document.getElementById('offline-modal');
            window.addEventListener('offline', () => { showModal(offlineModal); });
            window.addEventListener('online', () => { hideModal(offlineModal); refreshCurrentPageContent(); });
            
            manageSellAccountMenu();

            document.body.style.visibility = 'visible';
            document.body.style.opacity = 1;
        });
    </script>
</body>
</html>
