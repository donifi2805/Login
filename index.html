<!DOCTYPE html>
<html lang=id>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Bussid&Trucksid SHOP</title>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel=stylesheet>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel=stylesheet>
<script src=https://unpkg.com/@phosphor-icons/web></script>
<style>
:root{--bg-primary:#111827;--bg-secondary:#1f2937;--bg-tertiary:#374151;--border-color:#4b5563;--text-primary:#f9fafb;--text-secondary:#d1d5db;--accent-blue:#3b82f6;--accent-green:#22c55e;--accent-red:#ef4444;--accent-cyan:#06b6d4;--premium-gold:#fbbf24}*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;font-family:'Inter',sans-serif;background-color:var(--bg-primary);color:var(--text-primary);-webkit-user-select:none;user-select:none;font-size:10px}#app-layout{display:none;flex-direction:column;min-height:100vh;width:100%; transition: filter 0.3s ease-in-out;}

/* --- Start: Pre-loader --- */
#preloader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-primary); z-index: 20000; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
#preloader-overlay.hidden { opacity: 0; pointer-events: none; }
.loader-square { width: 120px; height: 120px; border: 4px solid var(--border-color); border-top-color: var(--accent-cyan); border-radius: 10px; display: flex; align-items: center; justify-content: center; animation: spin 1.5s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
#loading-percentage { font-size: 1.8em; font-weight: 600; color: var(--text-primary); animation: none; transform: rotate(0); }
/* --- End: Pre-loader --- */

/* --- Start: Header Modifications --- */
#top-navbar {
    display: flex;
    flex-direction: column;
    background-color: rgba(31, 41, 55, 0.85);
    -webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);
    position: sticky;
    top: 0;
    z-index: 1001;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid rgba(75, 85, 99, 0.5);
}
.header-brand {
    padding: 12px 16px;
    text-align: center;
    border-bottom: none; display: flex; justify-content: center; align-items: center;}
.brand-container { display: flex; justify-content: center; align-items: center; gap: 10px; }
.brand-logo { height: 18px; width: auto; object-fit: contain; }
.header-brand h1{font-size:1.7em;font-weight:900;line-height:1;color:transparent;background:linear-gradient(45deg,#3b82f6,#06b6d4,#22c55e);-webkit-background-clip:text;background-clip:text;text-shadow:0 2px 8px rgba(0,0,0,0.3)}
.subtitle-brand{display:block;font-size:.35em;font-weight:500;color:var(--text-secondary);margin-top:2px}
#top-navbar nav {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding: 8px 12px;
    border-top: none;
    border-bottom: none;
}
#top-navbar nav::-webkit-scrollbar{display:none}
.sidebar-nav{display:flex;justify-content:center;gap:6px;list-style:none;padding:0;flex-wrap:nowrap;align-items:center;}
.nav-item a {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    padding: 8px 10px;
    border-radius: 6px;
    color: var(--text-secondary);
    text-decoration: none;
    font-weight: 600;
    font-size: .8em;
    white-space: nowrap;
    transition: all .3s ease-in-out;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    min-width: 40px;
    height: 38px;
}
#nav-topup{display: none !important;}
.nav-item a:hover{color:var(--text-primary);border-color:var(--accent-blue);transform:translateY(-2px);}
.nav-item a.active{background:linear-gradient(45deg, var(--accent-blue), #2563eb);color:white;font-weight:700;border-color:var(--accent-blue);box-shadow:0 0 15px rgba(59,130,246,0.4)}
.nav-icon{font-size:1.5em;transition:all .3s ease}.nav-icon-img{width:20px;height:20px;border-radius:4px;object-fit:cover;transition:all .3s ease}
.nav-text { display: inline-block; font-size: 0.9em; font-weight: 700; white-space: nowrap; overflow: hidden; width: 0; opacity: 0; transition: width 0.4s ease, opacity 0.3s ease, margin-left 0.4s ease; margin-left: 0; }
.nav-item a.active .nav-text { width: auto; opacity: 1; margin-left: 8px; }

.header-actions-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border-top: 1px solid rgba(75, 85, 99, 0.5);
}
.sidebar-balance-card {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 6px;
    background: linear-gradient(45deg, var(--bg-tertiary), var(--bg-secondary));
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    cursor: pointer;
    transition: all .2s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.sidebar-balance-card:hover{border-color:var(--accent-green);transform:scale(1.02); box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);}
.balance-info{text-align:left;flex-grow:1;overflow:hidden;}.sidebar-balance-card .balance-label{display:block;font-size:.7em;color:var(--text-secondary);line-height:1.1}
.sidebar-balance-card .balance-amount{display:block;font-size:1em;font-weight:700;color:var(--accent-green);line-height:1.2}
.sidebar-balance-card .balance-username{display:block;font-size:.8em;font-weight:600;color:var(--text-primary);line-height:1.1;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;margin-bottom:2px}
.sidebar-balance-card .balance-amount.premium,.sidebar-balance-card .balance-amount.subscription,.sidebar-balance-card .balance-amount.admin{color:var(--premium-gold);font-size:.8em}
.add-balance-icon{font-size:1.6em;color:var(--accent-green);cursor:pointer;transition:transform .2s;display:flex;align-items:center;justify-content:center}
.add-balance-icon:hover{transform:scale(1.1)}
.header-actions{display:flex;align-items:center;gap:6px}
#cs-admin-btn, #header-my-account-btn, #logout-btn{display:flex;align-items:center;justify-content:center;padding:0!important;font-size:1.3em!important;line-height:1;background-color:var(--bg-tertiary);width:32px;height:32px;border-radius:6px;border:1px solid var(--border-color)}
#cs-admin-btn{color:var(--accent-cyan)}#cs-admin-btn:hover{background-color:var(--accent-cyan);color:white}
#header-my-account-btn:hover{background-color:var(--accent-blue)}
#logout-btn { background-color: var(--accent-red); color: white; }
#logout-btn:hover{background-color:#dc2626;}
#logout-btn i{font-size:1em!important}
.logout-text{display:none!important}
#header-profile-pic-container{width:42px;height:42px;border-radius:50%;overflow:hidden;border:2px solid var(--accent-blue);margin-right:6px;flex-shrink:0;cursor:pointer;transition:transform .2s ease}
#header-profile-pic-container:hover{transform:scale(1.05)}
#header-profile-img{width:100%;height:100%;object-fit:cover}
/* --- End: Header Modifications --- */

.main-content{padding:10px;min-height:100vh;background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhI8j1iJeFgIagFemTu0q3_yxUph06s4T6K03apxFf11HmQagnDM-PkaUNlV-VK0k2O-Mj93P4cnVZSWjf6jbmt1imTeAP_woH6aUMEsp9YgyMzCdHNoixyuWtvUf9pmhXlYIvwVt1Tb9CuSFi-Jk6D3pB6-ggMzhKMGkpoJD9ZT-d5T3LcJkW4d_mfGLA/s1600/1750238969835.jpg');background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:center}.content-container{max-width:1200px;margin:0 auto}.content-card{max-width:600px;margin:0 auto;background-color:var(--bg-secondary);padding:12px 15px;border-radius:12px;border:1px solid var(--border-color)}

/* --- Start: Login Page Redesign --- */
#auth-wrapper{display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;padding:16px;background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjJ-b-c-d_e-f_g_h-i-j_k-l-m_n-o-p_q-r_s-t-u_v-w-x_y_z/s1600/bussid-truck-bg.jpg');background-size:cover;background-position:center;gap:15px}
#login-container,#register-container,#forgot-password-container{width:100%;max-width:400px;background-color:rgba(17, 24, 39, 0.8);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:25px 30px;border-radius:16px;border:1px solid var(--border-color);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
.login-header h1{font-size:1.8em;font-weight:900;color:transparent;background:linear-gradient(45deg,#3b82f6,#06b6d4,#22c55e);-webkit-background-clip:text;background-clip:text;text-shadow:0 2px 8px rgba(0,0,0,0.3)}
#login-container h2 {font-size: 1.5em; text-align: center;}
#login-container .subtitle {text-align: center;}
/* --- End: Login Page Redesign --- */

#register-container,#forgot-password-container{display:none}
#app-layout,#profile-container,#topup-container,#buy-ub-container,#qris-display-container,#my-account-container,#subscription-container,#stok-akun-container,#jual-akun-container{display:none}
h2{font-size:1.3em;font-weight:700;margin-bottom:8px;color:var(--text-primary)}.subtitle{font-size:.8em;color:var(--text-secondary);margin-bottom:15px}.input-group{margin-bottom:12px;position:relative}.input-group .input-icon{position:absolute;top:50%;left:13px;transform:translateY(-50%);color:var(--text-secondary);font-size:1.1em}.input-field{width:100%;padding:10px 12px 10px 40px;background-color:var(--bg-primary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.9em}.input-field.password-input{padding-right:40px}.password-toggle{position:absolute;top:50%;right:10px;transform:translateY(-50%);cursor:pointer;color:var(--text-secondary);width:20px;height:20px}.input-field:focus{outline:0;border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(59,130,246,0.2)}.action-button{width:100%;padding:10px;border-radius:8px;color:white;font-size:1em;font-weight:600;cursor:pointer;border:0;transition:all .2s ease}.action-button:hover{opacity:.9;transform:translateY(-2px);box-shadow:0 4px 15px rgba(0,0,0,0.2)}.action-button:disabled{background-color:var(--bg-tertiary);cursor:not-allowed;opacity:.7}.btn-green{background-color:var(--accent-green)}.btn-primary{background:linear-gradient(45deg,var(--accent-blue),#2563eb)}.btn-red{background-color:var(--accent-red)}.btn-secondary{background-color:var(--bg-tertiary)}.btn-cyan{background-color:var(--accent-cyan)}.switch-link{margin-top:15px;font-size:.85em;color:var(--text-secondary);text-align:center}.switch-link a{color:var(--accent-blue);text-decoration:none;font-weight:600}.switch-link a:hover{text-decoration:underline}.switch-link.admin-link{margin-top:8px;font-size:0.75em}#other-account-form-container{padding:8px 12px;max-width:300px;margin:0 auto}#other-account-form-container .subtitle{font-size:.7em;margin-bottom:8px;line-height:1.3}
#all-profiles-grid{display:grid;grid-template-columns:1fr;gap:12px}
.profile-card{background-color:#2d2e33;border-radius:8px;border:1px solid var(--border-color);position:relative;overflow:hidden;transition:transform .3s ease,box-shadow .3s ease;perspective:1000px;display:flex;flex-direction:column;width:100%;max-width:350px;margin:0 auto}
.profile-card.hidden{display:none}.profile-card:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,0.2)}.profile-card-main-view,.profile-card-settings-view{padding:10px;display:flex;flex-direction:column;backface-visibility:hidden;transition:transform .6s ease;width:100%;flex-grow:1}.profile-card-main-view{transform:rotateY(0deg)}.profile-card-settings-view{position:absolute;top:0;left:0;right:0;bottom:0;background-color:var(--bg-secondary);transform:rotateY(180deg)}.profile-card.settings-active .profile-card-main-view{transform:rotateY(-180deg)}.profile-card.settings-active .profile-card-settings-view{transform:rotateY(0deg)}.profile-card-settings-view h3{font-size:.75em;margin-bottom:6px}.settings-info-item{padding:1px 5px;margin-bottom:2px}.settings-info-item .label{font-size:.55em;line-height:1.1}.settings-info-item .value{font-size:.65em;line-height:1.1}.settings-actions{margin-top:8px}.settings-actions .action-button{padding:4px;font-size:.65em}.player-display-container{margin:6px 0 8px 0;display:flex;flex-direction:column;gap:5px}
.player-name-plate,.player-ub-plate{background-size:100% 100%;background-repeat:no-repeat;background-position:center;height:38px;display:flex;align-items:center;justify-content:space-between;padding:0 10px;width:78%;margin:0 auto;border-radius:6px}
.player-name-plate{background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiy8bkfRaz2UWiO9tnX8IDy9OJwti__IkaN5CBSsybGTzWG7_sSqWTmOBRj0X3NEQQv1cW1thZcmPSjVcpS2JSamwsCN4_u_QQqzdYa7BhyfM8QwQAsPMVeokL1rUfxRAZx_s_46Gb27M1u40kP55xVpyjBgBcuDGs-CD9t0B4IgnkyS9DS228u_sgdkc4/s1600/IMG_20250812_161453.jpg')}.player-ub-plate{background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhJhoq7BI37iRAjcjRibzR3_-YgzMDy00OkGH_omg-c8FC1K2OmJdgyhiw8ARhhbLa7Bnip1h9_nBk2bdPJ3lhsdjgi9NTL43KQSH8Z4g8pT7RQLnUzdqqZc8Sn1ZZJm_3zJ-WwEhnWGCyW8cIAE_u8HewZspCCvr7l-EHkq8ln3pAXe_MkVVOx-9WA5UM/s1600/IMG_20250812_161504.jpg')}.player-name-text,.player-ub-text{color:#fff;font-weight:700;font-size:.765em;text-shadow:1px 1px 2px rgba(0,0,0,0.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-grow:1;text-align:center}.plate-icon{font-size:1.2em;color:white;cursor:pointer;opacity:.8;transition:opacity .2s,transform .2s;flex-shrink:0}.plate-icon:hover{opacity:1;transform:scale(1.1)}.plate-icon-placeholder{width:1.2em;flex-shrink:0}.info-banner{border:1px solid var(--accent-green);color:var(--text-primary);background-color:rgba(34,197,94,0.1);padding:10px 12px;border-radius:6px;text-align:center;font-weight:500;margin-bottom:15px;font-size:.8em}.current-balance-display{color:var(--text-secondary);background-color:var(--bg-primary);padding:8px 10px;border-radius:6px;margin-bottom:12px;text-align:center;font-size:.9em}.current-balance-display span{font-weight:700;color:var(--accent-green);font-size:1em}.ub-store-display{background:var(--bg-tertiary);border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid var(--border-color)}.display-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.display-label{font-weight:600;color:var(--text-secondary);font-size:.85em}.display-value{font-weight:700;font-size:1.1em}.display-value.rp{color:#f59e0b}.display-value.ub{color:var(--accent-green)}#ub-slider{width:100%;margin:6px 0}.buy-ub-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}.buy-ub-extra-actions{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px}.hasil-text.error{background-color:#991b1b;color:#fee2e2;margin-top:12px;padding:8px;border-radius:6px;font-weight:600;display:block;font-size:.85em}.topup-options-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}.topup-option-btn{background-color:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:12px 8px;border-radius:8px;cursor:pointer;font-weight:600;font-size:.9em;transition:all .2s ease}.topup-option-btn:hover{background-color:var(--bg-primary);border-color:var(--accent-blue)}
#qris-display-container .qris-image-wrapper img{width:100%;max-width:200px;border-radius:8px;margin-bottom:12px;background:white;cursor:pointer}
.important-notice{background-color:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.5);padding:10px;border-radius:6px;margin-bottom:15px}.important-notice .notice-title{font-weight:700;color:#f59e0b;display:block;margin-bottom:4px;font-size:.9em}.important-notice .notice-amount{font-weight:700;color:#fff;font-size:1.2em;letter-spacing:1px}
.qris-actions-wrapper {display: flex; flex-direction: column; gap: 10px;}
.qris-main-actions {display: flex; gap: 10px;}
.qris-main-actions .action-button {flex: 1;}
.history-section{margin-top:25px;padding-top:20px;border-top:1px solid var(--border-color)}.history-section h3{font-size:1.2em;margin-bottom:12px;text-align:center}.history-tables-container{display:grid;grid-template-columns:1fr;gap:20px}.history-table h4{font-size:.9em;margin-bottom:10px;color:var(--text-secondary)}.history-list{list-style:none;max-height:300px;overflow-y:auto;padding-right:6px;border:1px solid var(--border-color);border-radius:6px;padding:6px}.history-list li{background-color:var(--bg-tertiary);padding:10px;border-radius:6px;margin-bottom:6px;border-left:3px solid var(--border-color)}.history-list li.topup{border-left-color:var(--accent-green)}.history-list li.purchase{border-left-color:var(--accent-red)}.history-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}.history-item-header .amount{font-size:1em;font-weight:700}.history-item-header .amount.topup{color:var(--accent-green)}.history-item-header .amount.purchase{color:var(--accent-red)}.history-item-footer{font-size:.7em;color:var(--text-secondary)}.history-list .no-history{text-align:center;padding:12px;color:var(--text-secondary);background:0;border:0}#toast-container{position:fixed;top:15px;right:15px;z-index:10005;display:flex;flex-direction:column;align-items:flex-end;gap:10px;pointer-events:none}.toast{background:rgba(55,65,81,0.9);color:#fff;padding:10px 15px;border-radius:6px;box-shadow:0 6px 25px rgba(0,0,0,0.3);min-width:220px;max-width:320px;text-align:center;font-size:.9em;font-weight:600;border-left-width:4px;border-left-style:solid;border-left-color:var(--border-color);pointer-events:all;opacity:0;transform:translateX(100%);transition:all .3s ease-in-out}.toast.show{opacity:1;transform:translateX(0)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10002;display:none;padding:16px}.modal-content{background-color:var(--bg-secondary);padding:20px;border-radius:10px;width:100%;max-width:450px;position:relative;border:1px solid var(--border-color)}.modal-close{position:absolute;top:10px;right:12px;font-size:2em;color:var(--text-secondary);cursor:pointer;line-height:1}.modal-warning{background-color:rgba(239,68,68,0.1);border:1px solid var(--accent-red);padding:10px;border-radius:6px;margin-top:12px;margin-bottom:15px;color:var(--text-primary)}.modal-warning p{margin-bottom:6px;line-height:1.5;font-size:.85em}.modal-actions{display:flex;flex-direction:column;gap:10px}.modal-actions .action-button{text-align:center;text-decoration:none;padding:8px;font-size:.9em}

/* --- Start: My Account Page Redesign --- */
#my-account-container h2 { text-align: center; font-size: 1.5em; margin-bottom: 20px; }
.account-info-details{ display: flex; flex-direction: column; gap: 10px; margin-bottom: 25px; }
.account-info-item{ background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-left: 3px solid var(--accent-blue); padding: 12px 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; }
.account-info-item .info-icon { font-size: 1.8em; color: var(--accent-cyan); }
.account-info-item .info-text-wrapper { flex-grow: 1; }
.account-info-item .info-label { display: block; font-size: 0.8em; color: var(--text-secondary); margin-bottom: 2px; }
.account-info-item .info-value { display: block; font-size: 1em; font-weight: 600; color: var(--text-primary); word-break: break-all; }
.account-info-item .info-value.accent-green{ color: var(--accent-green); }
.account-info-item .info-value.premium,.account-info-item .info-value.subscription,.account-info-item .info-value.admin{ color: var(--premium-gold); }
.account-info-item .info-value.small-text { font-family: monospace; cursor: pointer; }
.account-actions{display:flex;flex-direction:column;gap:10px}

.profile-picture-container{display:flex;justify-content:center;margin-bottom:25px;position:relative;width:110px;height:110px;margin-left:auto;margin-right:auto;cursor:pointer}.profile-picture-container img{width:100%;height:100%;border-radius:50%;object-fit:cover;border:3px solid var(--accent-blue);transition:all .3s ease;background-color:var(--bg-tertiary)}.profile-picture-container:hover img{opacity:.8;transform:scale(1.05)}.camera-icon-badge{position:absolute;bottom:5px;right:5px;background-color:var(--accent-cyan);color:var(--bg-primary);width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2em;border:3px solid var(--bg-secondary);transition:all .2s ease}.profile-picture-container:hover .camera-icon-badge{transform:scale(1.1);background-color:var(--accent-green)}
/* --- End: My Account Page Redesign --- */

.info-row{display:flex;justify-content:space-between;align-items:center;padding:10px 6px;border-bottom:1px solid var(--border-color);flex-wrap:wrap;gap:5px}.info-row:last-child{border-bottom:0}
#akun-showcase-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-top:20px}.akun-card{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;overflow:hidden;padding:15px;font-size:.8em;transition:all .3s ease}.akun-card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,0.25);border-color:var(--accent-cyan)}.akun-card-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}.akun-card-logo{width:40px;height:40px;border-radius:8px}.akun-card h3{font-size:1.6em;margin-bottom:0;color:var(--text-primary)}.akun-card .info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px 10px;margin-bottom:12px}.akun-card .info-item{background-color:var(--bg-tertiary);padding:6px 8px;border-radius:6px}.akun-card .info-label{display:block;font-size:.9em;color:var(--text-secondary);margin-bottom:3px}.akun-card .info-value{font-size:1.2em;font-weight:700}.akun-card .info-value.price{color:var(--accent-green);font-size:1.5em}.akun-card .info-additional{margin-top:12px;padding-top:10px;border-top:1px solid var(--border-color)}.akun-card .info-additional .info-label{margin-bottom:4px}.akun-card .info-additional .info-value{font-size:1em;font-weight:400;white-space:pre-wrap;color:var(--text-primary)}.akun-card-footer{margin-top:15px}.lightbox-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:10004}.lightbox-content{position:relative;max-width:90vw;max-height:90vh}.lightbox-content img{width:100%;height:100%;object-fit:contain;border-radius:8px}.lightbox-close{position:absolute;top:-35px;right:0;font-size:2.5em;color:#fff;cursor:pointer;line-height:1;font-weight:700}.skeleton-card{background-color:var(--bg-secondary);padding:12px;border-radius:10px;border:1px solid var(--border-color)}.skeleton{animation:skeleton-loading 1s linear infinite alternate;opacity:.7;background-color:var(--bg-tertiary)}@keyframes skeleton-loading{0%{background-color:var(--bg-tertiary)}100%{background-color:#4b5563}}.skeleton-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}.skeleton-avatar{width:40px;height:40px;border-radius:50%}.skeleton-text-group{flex-grow:1}.skeleton-text{height:14px;border-radius:4px;margin-bottom:6px}.skeleton-text.short{width:50%}.skeleton-line{height:8px;border-radius:4px;margin-bottom:8px}.skeleton-button{height:34px;border-radius:6px;margin-top:12px}
#maintenance-modal .modal-content{text-align:center;max-width:400px;background-color:var(--bg-primary);border: 1px solid var(--premium-gold);}
#maintenance-modal i {font-size: 3em;color: var(--premium-gold);margin-bottom: 15px;}
#maintenance-modal-message{font-size:1em;line-height:1.6;color:var(--text-secondary);margin-bottom:0}

/* Ban Modal Styling */
#ban-modal {z-index: 20000;} /* Ensure it's on top of everything */
#ban-modal .modal-content { text-align: center; border-color: var(--accent-red); background-color: var(--bg-primary); }
#ban-modal i { font-size: 3em; color: var(--accent-red); margin-bottom: 15px; }
#ban-modal h2 { color: var(--accent-red); }

#confirmation-modal .modal-content { max-width: 380px; }
.invoice-style-confirmation { font-family: 'Courier New', Courier, monospace; background-color: #f5f5f5; color: #333; padding: 15px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.9em; }
.invoice-style-confirmation h4 { text-align: center; margin-bottom: 10px; font-size: 1.1em; border-bottom: 1px dashed #333; padding-bottom: 5px; }
.invoice-style-confirmation .invoice-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
.invoice-style-confirmation .invoice-row.total { font-weight: bold; border-top: 1px solid #333; padding-top: 5px; margin-top: 10px; font-size: 1.1em; }
.invoice-style-confirmation .invoice-row .price { text-align: right; }
#confirmation-modal{z-index:10003}
.error-message{color:#fca5a5;font-size:.8rem;margin-top:.4rem;min-height:1.1rem}
#admin-price-modal .modal-content{background:var(--bg-primary);border-color:var(--border-color)}.modal-header-custom{display:flex;align-items:center;gap:10px;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}.modal-header-custom .ph-bold{font-size:1.5em;color:var(--accent-cyan)}.modal-header-custom h2{margin-bottom:0;font-size:1.2em}
.price-option-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.8rem;max-height:60vh;overflow-y:auto;padding-right:5px}.price-option{background-color:var(--bg-tertiary);border:1px solid var(--border-color);transition:all .2s ease;padding:.8rem;border-radius:.5rem;cursor:pointer;text-align:left;display:flex;flex-direction:column;justify-content:space-between}.price-option:hover{transform:translateY(-3px);box-shadow:0 6px 15px rgba(0,0,0,0.2);border-color:var(--accent-cyan)}.price-option.selected{border-color:var(--accent-cyan);box-shadow:0 0 15px rgba(6,182,212,0.3);transform:translateY(-3px);background-color:var(--bg-secondary)}.price-option .ph-coins{display:none}.price-option .amount{font-weight:700;font-size:.9em;color:var(--text-primary);line-height:1.3;margin-bottom:8px}.price-option .price{font-size:.8em;font-weight:600;background-color:var(--bg-primary);color:var(--accent-green);padding:3px 8px;border-radius:5px;display:inline-block;margin-top:.5rem;border:1px solid var(--border-color)}
#admin-game-choice-container{text-align:center}.admin-choice-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-top:15px}.admin-choice-btn{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:25px 15px;cursor:pointer;transition:all .2s ease-in-out;font-size:1.2em;font-weight:700;color:var(--text-primary)}.admin-choice-btn:hover{transform:translateY(-4px);box-shadow:0 6px 20px rgba(0,0,0,0.2);border-color:var(--accent-cyan)}.admin-choice-btn .game-icon{font-size:2.2em;display:block;margin-bottom:10px}.back-button{background:0;border:0;color:var(--accent-blue);cursor:pointer;font-weight:600;margin-bottom:12px;font-size:.85em;padding:4px}.back-button:hover{text-decoration:underline}
.joki-warning-box{background:rgba(153,27,27,0.15);color:var(--text-primary);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(252,165,165,0.4);font-size:0.8em}.joki-warning-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}.joki-warning-header .ph-warning-octagon{font-size:1.8em;color:#fca5a5}.joki-warning-header h3{font-size:1.1em;font-weight:700;color:white;margin:0}.joki-warning-box p.warning-intro{font-size:0.9em;line-height:1.5;margin:8px 0;color:#fee2e2}.joki-warning-box p.warning-intro strong{color:white}.joki-warning-box .warning-points{display:flex;flex-direction:column;gap:8px;margin:10px 0}.joki-warning-box .warning-item{display:flex;align-items:flex-start;gap:8px}.joki-warning-box .warning-icon{font-size:1.2em;color:#fca5a5;margin-top:1px}.joki-warning-box .warning-text{font-size:0.9em;line-height:1.5;color:#fee2e2}.joki-warning-box .warning-text strong{color:white}.joki-warning-box .wa-input-section{margin-top:10px;padding-top:10px;border-top:1px solid rgba(252,165,165,0.2)}.joki-warning-box .wa-label{font-weight:600;display:block;margin-bottom:6px;font-size:1em;color:white}.joki-warning-box .input-field{background-color:rgba(0,0,0,0.2);border-color:#fca5a5;color:white;padding-top:8px;padding-bottom:8px;font-size:0.9em}.joki-warning-box .input-field::placeholder{color:rgba(254,202,202,0.7)}.joki-warning-box .input-field:focus{border-color:white;box-shadow:0 0 0 2px rgba(255,255,255,0.2)}
.fb-login-style-container{background-color:#fff;font-family:'Helvetica','Arial',sans-serif;color:#1c1e21;border-radius:8px;padding:0;overflow:hidden;max-width:420px;margin:0 auto;border:1px solid #dddfe2}.fb-login-style-container .input-field{background-color:#f5f6f7;border:1px solid #dddfe2;color:#1c1e21}.fb-login-style-container .input-field::placeholder{color:#90949c}.fb-login-style-container .input-field:focus{border-color:#1877f2;box-shadow:0 0 0 2px #e7f3ff}.fb-login-style-container .error-message,.gmail-login-style-container .error-message{color:#fa3e3e;text-align:left}.fb-login-header{padding:12px;text-align:center;border-bottom:1px solid #dddfe2}.fb-login-header img{height:30px}.fb-login-body{padding:15px}.action-button.btn-fb{background-color:#1877f2;font-weight:700;border-radius:6px}.fb-login-links{text-align:center;margin-top:12px}.fb-login-links a{color:#1877f2;text-decoration:none;font-weight:500;font-size:.85em}.gmail-login-style-container{background-color:#fff;font-family:'Roboto','Arial',sans-serif;color:#202124;border:1px solid #dadce0;border-radius:8px;padding:40px 30px 30px;max-width:450px;margin:0 auto;text-align:center}.gmail-login-style-container .input-field{background-color:#fff;border:1px solid #ccc;color:#202124;border-radius:4px}.gmail-login-style-container .input-field:focus{border-color:#1a73e8;box-shadow:0 0 0 1px #1a73e8}.gmail-logo{width:70px;margin-bottom:12px}.gmail-header h1{font-size:22px;font-weight:400;margin-bottom:6px}.gmail-header p{font-size:14px;margin-bottom:20px}.gmail-form .input-group{margin-bottom:12px}.gmail-links{text-align:left;margin:12px 0}.gmail-links a{font-family:'Roboto',sans-serif;color:#1a73e8;text-decoration:none;font-weight:500;font-size:13px}.gmail-actions{display:flex;justify-content:space-between;align-items:center;margin-top:28px}.gmail-actions .create-account-link{font-family:'Roboto',sans-serif;color:#1a73e8;text-decoration:none;font-weight:500;font-size:13px;background:0;border:0;cursor:pointer;padding:8px 0}.action-button.btn-gmail{background-color:#1a73e8;padding:0 20px;height:32px;line-height:32px;font-size:13px;font-weight:500;width:auto}#offline-modal .modal-content{text-align:center}#offline-modal .subtitle{margin-bottom:0}#subscription-expired-modal .modal-content{text-align:center;border-color:var(--accent-red)}#subscription-expired-modal .modal-content h2{color:var(--accent-red)}.subscription-grid{display:grid;grid-template-columns:1fr;gap:20px;margin-top:20px}.subscription-card{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:20px;text-align:center;transition:all .3s ease;display:flex;flex-direction:column}.subscription-card:hover{transform:translateY(-5px);border-color:var(--accent-blue)}.subscription-card.premium{border-left:4px solid var(--accent-blue)}.subscription-card.permanent{border-left:4px solid var(--accent-green)}.subscription-card h3{font-size:1.2em;margin-bottom:10px;color:var(--text-primary)}.subscription-card .sub-price{font-size:1.8em;font-weight:800;margin-bottom:15px}.subscription-card .promo-price{color:var(--accent-blue)}.subscription-card.permanent .sub-price{color:var(--accent-green)}.subscription-card .original-price{text-decoration:line-through;color:var(--text-secondary);font-size:.6em;margin-left:8px;font-weight:500}.subscription-card .sub-price .sub-duration{font-size:.5em;font-weight:500;color:var(--text-secondary)}.subscription-card ul{list-style:none;padding:0;margin:20px 0;text-align:left;font-size:.9em;flex-grow:1}.subscription-card ul li{margin-bottom:10px;display:flex;align-items:flex-start;gap:8px;color:var(--text-secondary)}.subscription-card ul li .ph-bold{font-size:1.2em; margin-top: 1px;}.subscription-card ul li .ph-check-circle{color:var(--accent-green)}.subscription-card .action-button{margin-top:auto}#status-modal-content h4{font-size:1.1em;color:var(--premium-gold);margin-bottom:10px;text-align:center}#status-modal-content p{color:var(--text-secondary);text-align:center;margin-bottom:20px;font-size:.9em}#status-modal-content ul{list-style:none;padding:0;margin-top:15px}#status-modal-content ul li{background-color:var(--bg-primary);padding:8px 12px;border-radius:6px;margin-bottom:6px;font-size:.85em}.login-header{text-align:center;margin-bottom:15px}.promo-list{list-style:none;padding:12px;margin:15px 0;background-color:rgba(0,0,0,0.2);border-radius:8px;font-size:.8em}.promo-list li{display:flex;align-items:flex-start;gap:8px;margin-bottom:8px;line-height:1.5}.promo-list li:last-child{margin-bottom:0}.promo-list i{color:var(--accent-green);font-size:1.2em;margin-top:2px}
@keyframes ph-spin { 100% { transform: rotate(360deg); } }
.ph-spin { animation: ph-spin 1s linear infinite; }
@media screen and (min-width:768px){
.logout-text{display:inline-block}
.nav-text{font-size: 0.95em;}
.nav-icon-img{display:inline-block!important;vertical-align:middle}.history-tables-container{grid-template-columns:1fr 1fr}.price-option-grid{grid-template-columns:repeat(3,1fr)}.admin-choice-grid{grid-template-columns:1fr 1fr}.subscription-grid{grid-template-columns:repeat(3,1fr)}
#akun-showcase-grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
#all-profiles-grid{grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));gap: 20px;}
}
@media screen and (min-width: 1024px) {
    .nav-text { font-size: 1em; } /* Ukuran normal di layar besar */
}
@media screen and (max-width:767px){
.nav-item a .nav-icon-img{margin-right:0}
.nav-text { font-size: 3.2vw; } /* Ukuran fleksibel di mobile */
}@media screen and (max-width:480px){h2{font-size:1.2em}.subtitle{font-size:.75em}.content-card{padding:10px 15px}#login-container,#register-container,#forgot-password-container{padding:20px 25px}.info-banner,.important-notice{padding:8px;font-size:.8em}#akun-showcase-grid{grid-template-columns:1fr}.modal-content{padding:15px}.history-tables-container{gap:12px}.history-list li{padding:8px}.topup-options-grid{grid-template-columns:1fr}.buy-ub-actions,.buy-ub-extra-actions{grid-template-columns:1fr}.gmail-login-style-container{padding:25px 15px 20px}.fb-login-body{padding:12px}.subscription-grid{grid-template-columns:1fr}
.nav-text { font-size: 3.5vw; }
}
.akun-card .credential-info-grid{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}.akun-card .credential-item{display:flex;align-items:center;background-color:var(--bg-tertiary);padding:8px 10px;border-radius:6px}.akun-card .credential-label{font-size:.9em;color:var(--text-secondary);flex-basis:100px}.akun-card .credential-value{font-size:1.1em;font-weight:700;flex-grow:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.akun-card .copy-btn{background:none;border:none;color:var(--accent-blue);font-size:1.4em;cursor:pointer;padding:0 5px;margin-left:10px}.akun-card .processing-status{text-align:center;padding:20px;font-size:1.1em;font-weight:700;color:var(--accent-cyan)}
.admin-choice-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}.admin-choice-logo{width:48px;height:48px;border-radius:10px;object-fit:cover}

/* --- Start: Beli Akun Card Redesign (-50% size & 2 columns) --- */
.stok-akun-header-controls { background-color: var(--bg-secondary); padding: 12px; border-radius: 12px; margin-bottom: 15px; }
.stok-akun-header-controls h2, .stok-akun-header-controls .subtitle { padding: 0 5px; }
.game-column h3 { display: none; } /* Sembunyikan judul kolom lama */
#beli-akun-wrapper { display: none; } /* Sembunyikan wrapper lama */

/* Grid baru yang digabung */
#stok-akun-grid-merged {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 kolom di HP */
    gap: 8px;
}
/* 3 kolom di layar lebih besar */
@media screen and (min-width: 500px) {
    #stok-akun-grid-merged {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }
}

#stok-akun-grid-bussid, #stok-akun-grid-trucksid {display:grid; grid-template-columns: 1fr; gap:10px} /* Aturan ini tidak terpakai tapi biarkan saja */
#purchased-akun-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px}

/* Ukuran kartu diperkecil */
.stok-akun-card{background-color:var(--bg-secondary);border:1px solid rgba(75,85,99,0.6);border-radius:8px;padding:6px;transition:all .3s ease;display:flex;flex-direction:column;gap:5px;font-size:.7em;box-shadow:0 4px 15px rgba(0,0,0,0.4);position:relative;overflow:hidden}
.stok-akun-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:3px}
.stok-akun-card.bussid-card::before{background:var(--accent-blue)}
.stok-akun-card.trucksid-card::before{background:var(--accent-green)}
.stok-akun-card:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,0.35);border-color:var(--accent-cyan)}
.stok-akun-card.owned{border-left:3px solid var(--accent-cyan)}
.stok-habis-badge { display: none; position: absolute; top: 5px; right: -30px; background-color: var(--accent-red); color: white; font-weight: 700; padding: 2px 30px; font-size: 0.9em; transform: rotate(45deg); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
.stok-akun-card.out-of-stock .stok-habis-badge { display: block; }
.stok-akun-card .stok-card-header{display:flex;align-items:center;gap:5px;padding-bottom:4px;border-bottom:1px solid var(--border-color);justify-content:space-between;}.stok-akun-card .stok-card-logo{width:20px;height:20px;border-radius:4px}.stok-akun-card h3{font-size:1.05em;margin:0;color:var(--text-primary)}
.stok-akun-card .info-grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:4px}
.stok-akun-card .info-item{background-color:rgba(0,0,0,0.2);padding:4px 5px;border-radius:4px}.stok-akun-card .info-label{display:flex;align-items:center;gap:4px;font-size:.7em;color:var(--text-secondary);margin-bottom:2px}.stok-akun-card .info-label i{font-size:1.2em}
.stok-akun-card .info-value{font-size:.8em;font-weight:700;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}.stok-akun-card .price .info-value{color:var(--accent-green);font-size:1.1em}
.stok-akun-card .rating-stars { color: var(--premium-gold); font-size: 1.1em; }
.stok-akun-card .rating-stars .ph-star { color: var(--border-color); }
.stok-akun-card .unlocked-grid{display:flex;flex-direction:column;gap:5px}.stok-akun-card .unlocked-item{display:flex;align-items:center;background-color:var(--bg-tertiary);padding:5px 6px;border-radius:4px}.stok-akun-card .unlocked-label{font-size:.8em;color:var(--text-secondary);flex-basis:50px}.stok-akun-card .unlocked-value{font-family:monospace;font-size:.9em;font-weight:600;flex-grow:1}.stok-akun-card .copy-icon{color:var(--accent-blue);cursor:pointer;margin-left:auto;font-size:1.1em}
.stok-akun-card .action-button {font-size: 0.8em; padding: 5px; margin-top: auto;}
.stok-akun-card .action-button:disabled { background-color: var(--bg-tertiary); cursor: not-allowed; opacity: 0.6; }
.stok-akun-card .package-info { font-size: 0.8em; color: var(--text-secondary); background-color: rgba(0,0,0,0.2); padding: 5px 6px; border-radius: 4px; line-height: 1.4; }
.stok-akun-card .detail-info { font-size: 0.8em; color: var(--text-primary); background-color: rgba(6, 182, 212, 0.1); border-left: 2px solid var(--accent-cyan); padding: 5px 8px; border-radius: 4px; line-height: 1.4; margin-top: 4px; }
.purchased-info-grid { display: flex; flex-direction: column; gap: 4px; background-color: var(--bg-primary); padding: 6px; border-radius: 5px; margin-bottom: 5px; }
.purchased-info-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
.purchased-info-item .info-label { color: var(--text-secondary); font-weight: 500; }
.purchased-info-item .info-value { color: var(--text-primary); font-weight: 700; }
.purchased-info-item .info-value.ub-display { color: var(--accent-green); }
.purchased-info-item .ph-spinner { animation: ph-spin 1s linear infinite; }
/* --- End: Beli Akun Card Redesign --- */

.ub-fill-section{margin-top:12px;padding-top:8px;border-top:1px solid var(--border-color)}.ub-fill-section h4{font-size:.85em;margin-bottom:8px;color:var(--text-primary)}.ub-fill-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}.ub-fill-btn{background-color:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:6px 4px;border-radius:5px;cursor:pointer;font-weight:600;font-size:.7em;transition:all .2s ease}.ub-fill-btn:hover{background-color:var(--accent-green);border-color:var(--accent-green)}.ub-fill-section .input-group{margin-top:8px}
#akun-purchase-modal .modal-content { max-height: 80vh; transform: scale(0.95); transform-origin: center; }
#akun-purchase-modal h4{margin-top:15px;margin-bottom:8px;border-bottom:1px solid var(--border-color);padding-bottom:5px}
#akun-purchase-details{font-size:.9em;max-height:150px;overflow-y:auto;background-color:var(--bg-primary);padding:8px;border-radius:6px;line-height:1.5;color:var(--text-secondary)}
#akun-purchase-total{margin-top:15px;text-align:center;font-size:1.2em}#akun-purchase-total span{font-weight:bold;color:var(--accent-green)}

/* --- Start: Perbaikan Latar Belakang Teks Jual Akun --- */
#jual-akun-area .jual-akun-info{background-color:var(--bg-tertiary);border:1px solid var(--accent-cyan);padding:12px;border-radius:8px 8px 0 0;font-size:.8em;line-height:1.5;color:var(--text-primary);text-align:center;}
/* --- End: Perbaikan Latar Belakang Teks Jual Akun --- */

#jual-akun-area .action-button { margin-top: -1px; border-radius: 0 0 8px 8px; margin-bottom: 10px; background: linear-gradient(45deg, var(--accent-cyan), #0891b2); box-shadow: 0 4px 15px rgba(6, 182, 212, 0.2); }
#jual-akun-area { display: flex; flex-direction: column; }
#jual-akun-controls { display: flex; gap: 10px; margin-bottom: 15px; }
#check-sell-status-btn { flex-grow: 1; }
#sell-account-floating-menu{position:fixed;bottom:0;left:0;right:0;background-color:var(--bg-secondary);padding:15px;border-top:1px solid var(--border-color);z-index:1002;transform:translateY(100%);transition:transform 0.3s ease-in-out;max-height:90vh;overflow-y:auto}
#sell-account-floating-menu.visible{transform:translateY(0)}
.sell-account-item{display:flex;align-items:center;justify-content:space-between;padding:8px;background-color:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;font-size:0.9em}
.sell-account-item .info{display:flex;align-items:center;gap:10px}
.sell-account-item .price{font-weight:700;color:var(--accent-green)}
.sdk-checkbox-container{display:flex;align-items:flex-start;gap:10px;background:rgba(251,191,36,0.1);border:1px solid var(--premium-gold);padding:10px;border-radius:6px;margin:10px 0}
.sdk-checkbox-container input{margin-top:4px}
.sdk-checkbox-container label{font-size:0.85em;line-height:1.5}
.payment-options-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:15px 0}
.payment-option-btn{background-color:var(--bg-tertiary);border:1px solid var(--border-color);padding:10px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-weight:600;color:var(--text-primary)}
.payment-option-btn.selected{border-color:var(--accent-green);background-color:rgba(34,197,94,0.1)}
.payment-option-btn img{height:20px}
.stok-akun-filter-buttons { display: flex; gap: 5px; background-color:var(--bg-primary); padding:4px; border-radius:8px;}
.stok-akun-filter-buttons .filter-btn { padding: 5px 10px; font-size: 0.8em; font-weight: 600; border: none; background-color: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
.stok-akun-filter-buttons .filter-btn.active { background-color: var(--accent-blue); color: white; box-shadow: 0 2px 8px rgba(59,130,246,0.3); }#admin-profile-modal .modal-content, #sell-status-modal .modal-content { text-align: center; }
#admin-profile-modal .admin-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent-cyan); margin-bottom: 10px; }
#admin-profile-modal .admin-info { font-size: 0.9em; line-height: 1.6; color: var(--text-secondary); margin-bottom: 20px; }
#admin-profile-modal .admin-socials { display: flex; gap: 15px; justify-content: center; }
#admin-profile-modal .social-btn { display: flex; align-items: center; gap: 8px; padding: 8px 15px; border-radius: 6px; text-decoration: none; font-weight: 600; transition: all 0.2s ease; }
#admin-profile-modal .social-btn.whatsapp { background-color: #25D366; color: white; }
#admin-profile-modal .social-btn.instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; }
#admin-profile-modal .social-btn i { font-size: 1.4em; }
#sell-status-modal .status-account-list { list-style: none; padding: 0; margin-top: 15px; max-height: 50vh; overflow-y: auto; }
#sell-status-modal .status-account-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-primary); padding: 10px; border-radius: 6px; margin-bottom: 8px; }#sell-status-modal .status-value { font-weight: 700; }
#sell-status-modal .status-value.processed { color: var(--accent-cyan); }
#sell-status-modal .status-value.completed { color: var(--accent-green); }/* --- Start: Rework Tampilan Toko UB --- */
#buy-ub-container {
    padding: 10px 15px;
    max-width: 450px;
    margin: 0 auto;
    font-size: 0.9em; /* Perkecil font dasar di card ini */
}
#buy-ub-container h2 {
    font-size: 1.3em; /* Sesuaikan ukuran font relatif terhadap parent */
    margin-bottom: 8px;
}
.player-info-display {
    font-size: 0.9em; /* Sedikit lebih kecil */
    margin-bottom: 10px;
}
.ub-store-display .display-row {
    align-items: center;
    margin-bottom: 8px;
}
#ub-display-row .display-label {
    flex-shrink: 0;
    margin-right: 10px;
    font-size: 1em;
}
#ub-input {
    flex-grow: 1;
    text-align: right;
    font-weight: 700;
    color: var(--accent-green);
    background-color: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 1.2em; /* Ukuran font input */
    width: auto;
}
#ub-input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(59,130,246,0.2);
    border-color: var(--accent-blue);
}
.ub-input-group {
    margin: 10px 0 !important;
    padding: 0;
    display: block;
}
#ub-slider {
    width: 100%;
}
.buy-ub-extra-actions {
    grid-template-columns: 1fr;
    margin-bottom: 8px;
}
.buy-ub-actions {
    grid-template-columns: 1fr 1fr;
}
.buy-ub-actions .action-button, .buy-ub-extra-actions .action-button {
    font-size: 1em;
    padding: 9px;
}
/* --- End: Rework Tampilan Toko UB --- */

#maintenance-notice {
    display: none; /* Initially hidden */
    text-align: center;
    background-color: var(--bg-secondary);
    padding: 25px;
    border-radius: 16px;
    border: 1px solid var(--premium-gold);
}
#maintenance-notice i {
    font-size: 3em;
    color: var(--premium-gold);
    margin-bottom: 15px;
}
#welcome-message-modal .modal-content {
    text-align: center;
}
#welcome-message-content {
    font-size: 1em;
    line-height: 1.6;
    color: var(--text-secondary);
    margin-bottom: 25px;
    white-space: pre-wrap; /* To respect newlines from admin input */
}
.subscription-card ul li .ph-x-circle { color: var(--accent-red); }
/* --- Start: Live Chat Widget --- */
#admin-status-container {
    /* Dihapus: position: fixed, bottom, right, z-index */
    position: relative; /* Menjadi relatif terhadap bubble-container */
    margin-top: 4px; /* Memberi jarak dari teks "Live Chat Admin" */
    display: flex;
    align-items: center;
    background-color: var(--bg-secondary);
    padding: 4px 8px; /* Dikecilkan agar lebih pas */
    border-radius: 20px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    font-size: 1.0em; /* Disesuaikan ukurannya */
    font-weight: 600;
    transition: all 0.3s ease;
    pointer-events: none; /* Agar tidak mengganggu klik pada bubble */
}
#admin-status-dot {
    width: 8px; /* Dikecilkan */
    height: 8px; /* Dikecilkan */
    border-radius: 50%;
    margin-right: 5px; /* Disesuaikan */
    transition: all 0.3s ease;
}
#admin-status-container.online {
    background-color: rgba(34, 197, 94, 0.1);
    border-color: var(--accent-green);
}
#admin-status-container.online #admin-status-dot {
    background-color: var(--accent-green);
    box-shadow: 0 0 6px var(--accent-green);
}
#admin-status-container.online #admin-status-text {
    color: var(--text-primary);
}
#admin-status-container.offline {
     background-color: rgba(239, 68, 68, 0.1);
     border-color: var(--accent-red);
}
#admin-status-container.offline #admin-status-dot {
    background-color: var(--accent-red);
}
#admin-status-container.offline #admin-status-text {
    color: var(--text-secondary);
}

#live-chat-widget * { box-sizing: border-box; font-family: Arial, sans-serif; }
/* --- Start: Live Chat Widget --- */
#live-chat-widget * { box-sizing: border-box; font-family: Arial, sans-serif; }
#chat-bubble-container { position: fixed; bottom: 25px; right: 25px; z-index: 999; display: none; flex-direction: column; align-items: center; cursor: pointer; }
#chat-bubble { width: 60px; height: 60px; background-color: var(--accent-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: transform 0.2s ease; }
#chat-bubble:hover { transform: scale(1.1); }
#chat-bubble-text { font-size: 11px; color: var(--text-primary); margin-top: 4px; font-weight: 500; text-shadow: 0 0 8px rgba(255,255,255,0.9); pointer-events: none; }
#chat-window { position: fixed; bottom: 85px; right: 15px; width: 375px; max-width: 95%; height: 500px; max-height: 75vh; background: #fff; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; z-index: 10001; overflow: hidden; font-size:10px; }
.chat-hidden { display: none !important; }
#chat-header { background: var(--accent-blue); color: white; padding: 15px; border-top-left-radius: 10px; border-top-right-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
#chat-header span { font-weight: bold; font-size: 0.9em; }
#chat-close { 
    cursor: pointer; 
    font-size: 20px; /* Sedikit lebih besar */
    font-weight: bold; 
    width: 26px; /* Memberi lebar */
    height: 26px; /* Memberi tinggi */
    border-radius: 50%; /* Membuatnya bulat */
    background-color: rgba(0, 0, 0, 0.2); /* Latar belakang tembus pandang */
    display: flex; /* Untuk menengahkan 'x' */
    align-items: center;
    justify-content: center;
    line-height: 1; /* Memperbaiki posisi vertikal 'x' */
    transition: background-color 0.2s ease, transform 0.2s ease; /* Transisi halus */
}
#chat-close:hover {
    background-color: rgba(0, 0, 0, 0.4); /* Lebih gelap saat disentuh */
    transform: scale(1.1); /* Sedikit membesar */
}
#chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; font-size: 10px; }
.chat-message { padding: 10px 14px; border-radius: 18px; max-width: 80%; line-height: 1.4; word-wrap: break-word; color: #333; }
.chat-message.user { background: var(--accent-blue); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
.chat-message.admin { background: #e9e9eb; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; }
img.chat-message-image { width: 150px; height: auto; border-radius: 10px; cursor: pointer; border: 1px solid #eee; }
img.chat-message-image.user { align-self: flex-end; }
img.chat-message-image.admin { align-self: flex-start; }
#chat-input-area { display: flex; align-items: center; padding: 10px; border-top: 1px solid #eee; background: #fff; position: relative; }
#chat-loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; z-index: 10; }
@keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
#chat-attach-button { background: none; border: none; cursor: pointer; padding: 8px; margin-right: 5px; }
#chat-attach-button:hover { opacity: 0.7; }
#chat-file-input { display: none; }
#chat-text { flex-grow: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; margin-right: 10px; font-size: 9px; color: #333; }
#chat-text:disabled, #chat-send:disabled, #chat-attach-button:disabled { opacity: 0.5; cursor: not-allowed; }
#chat-send { background: var(--accent-blue); color: white; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer; font-weight: bold; font-size: 10px; }
#image-preview-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: flex; align-items: center; justify-content: center; z-index: 10004; }
#modal-close { position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; }
#preview-image { max-width: 90%; max-height: 90%; object-fit: contain; }
/* --- End: Live Chat Widget --- */
#google-new-user-form input:invalid {
    border-color: var(--accent-red);
}
#google-reg-whatsapp:invalid + #whatsapp-hint {
    display: block;
}
/* --- Start: Styling Card Akun Terbeli --- */
.purchased-card {
    background: linear-gradient(145deg, var(--bg-secondary), #2a3a50);
    border-color: var(--accent-cyan);
    border-width: 1px;
    box-shadow: 0 0 20px rgba(6, 182, 212, 0.2), 0 4px 10px rgba(0,0,0,0.3);
    gap: 10px; /* Jarak antar elemen di dalam card */
    padding: 10px;
    font-size: 0.8em; /* Ukuran font sedikit lebih besar dari card stok */
}

.purchased-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}

.purchased-card-logo {
    width: 32px;
    height: 32px;
    border-radius: 6px;
    flex-shrink: 0;
}

.purchased-header-info {
    flex-grow: 1;
    overflow: hidden;
}

.purchased-game-type {
    display: block;
    font-size: 0.9em;
    color: var(--text-secondary);
    font-weight: 500;
}

.purchased-username {
    display: block;
    font-size: 1.3em;
    font-weight: 700;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.purchased-check-icon {
    font-size: 2.2em;
    color: var(--accent-green);
    flex-shrink: 0;
    margin-left: auto;
}

.purchased-main-info {
    background-color: rgba(6, 182, 212, 0.1);
    border: 1px solid var(--accent-cyan);
    border-radius: 8px;
    padding: 8px 12px;
    text-align: center;
}

.purchased-info-label {
    display: block;
    font-size: 0.9em;
    color: var(--accent-cyan);
    margin-bottom: 2px;
}

.purchased-info-value {
    display: block;
    font-size: 1.5em;
    font-weight: 800;
    color: var(--text-primary);
}

.purchased-credential-grid {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.purchased-credential-item {
    display: flex;
    align-items: center;
    background-color: var(--bg-tertiary);
    border-radius: 6px;
    padding: 8px 10px;
    gap: 10px;
}

/* Grup Label Baru (Ikon + Teks) */
.purchased-credential-label-group {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    color: var(--text-secondary);
    width: 90px; /* Memberi lebar tetap agar rapi */
}
.purchased-credential-label-group i {
    font-size: 1.4em;
}
.purchased-credential-label-group span {
    font-size: 0.95em;
    font-weight: 500;
}

.purchased-credential-item > i:first-child {
    /* Aturan ini tidak lagi digunakan, dikosongkan */
    font-size: inherit;
    color: inherit;
    flex-shrink: inherit;
}

.purchased-credential-value {
    flex-grow: 1;
    font-size: 1em;
    font-weight: 600;
    color: var(--text-primary);
    font-family: monospace;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex; /* Untuk ikon login */
    align-items: center; /* Untuk ikon login */
    gap: 5px; /* Untuk ikon login */
}

.purchased-credential-item .copy-icon {
    font-size: 1.4em;
    color: var(--accent-blue);
    cursor: pointer;
    margin-left: auto;
    flex-shrink: 0;
    padding: 2px;
}
.purchased-credential-item .copy-icon:hover {
    opacity: 0.8;
}
/* --- Styling Pesan Instruksi --- */
.purchased-card-notice {
    font-size: 0.9em;
    line-height: 1.5;
    color: var(--text-secondary);
    background-color: var(--bg-tertiary);
    padding: 8px 10px;
    border-radius: 6px;
    margin: 0; /* Dihapus oleh gap di .purchased-card */
    border-left: 3px solid var(--premium-gold);
}
/* --- End: Styling Card Akun Terbeli --- */
</style>

    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bussid & Trucksid SHOP">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => console.log('ServiceWorker registration successful: ', registration.scope))
            .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
      }
    </script>
</head>
<body>
<div id="preloader-overlay">
    <div class="loader-square">
        <span id="loading-percentage">0%</span>
    </div>
</div>
<div id=toast-container></div>
<div id=auth-wrapper>
<div id="maintenance-notice">
    <i class="ph-fill ph-warning-octagon"></i>
    <h2>Dalam Perbaikan</h2>
    <p class=subtitle id="maintenance-message">Maaf, situs sedang dalam perbaikan rutin. Silakan coba lagi nanti.</p>
</div>
<div id=login-container>
<div class=login-header>
<h1>Bussid&Trucksid SHOP<span class=subtitle-brand>by@donitata1717</span></h1>
</div>
<h2>Selamat Datang Kembali</h2>
<p class=subtitle>Masuk untuk melanjutkan ke toko.</p>
<form id=login-form>
<div class=input-group>
<i class="ph-bold ph-user input-icon"></i>
<input type=text id=username class=input-field placeholder="Nama Pengguna" required>
</div>
<div class=input-group>
<i class="ph-bold ph-lock-key input-icon"></i>
<input type=password id=password class="input-field password-input" placeholder="Kata Sandi" required>
<span class=password-toggle id=login-password-toggle></span>
</div>
<button type=submit id=login-btn class="action-button btn-primary">Masuk</button>
</form>
<p class=switch-link style="text-align:center; margin-top:15px; margin-bottom:15px;"> atau </p>
<button type="button" id="google-login-btn" class="action-button btn-secondary" style="background-color: #fff; color: #4285F4; display: flex; align-items: center; justify-content: center; gap: 10px; line-height: 1; border: 1px solid #ccc;">
    <i class="ph-fill ph-google-logo" style="font-size: 1.2em;"></i>
    <span>Masuk dengan Google</span>
</button>
<ul class=promo-list>
<li><i class="ph-bold ph-star"></i><span><b>Website No.1</b> Topup & Jual Beli Akun Bussid & Trucksid terpercaya sejak 2019.</span></li>
<li><i class="ph-bold ph-shield-check"></i><span><b>100% Bergaransi</b> uang kembali jika ada masalah.</span></li>
<li><i class="ph-bold ph-users-three"></i><span><b>Pelayanan Penuh</b> oleh admin langsung, tanpa perantara, 24 jam.</span></li>
<li><i class="ph-bold ph-rocket-launch"></i><span><b>Langganan terjangkau</b> untuk kebebasan topup instan tanpa delay.</span></li>
</ul>
<p class=switch-link> Belum punya akun? <a href=# id=show-register-link>Buat akun baru</a></p>
<p class=switch-link><a href=# id=show-forgot-password-link>Lupa kata sandi</a></p>
<p class="switch-link admin-link">bukan user? <a href=paneladmin.html>Login sebagai admin</a></p>
</div>
<div id=register-container>
<h2>Buat Akun Baru</h2>
<p class=subtitle>Daftar dan mulai petualanganmu.</p>
<form id=register-form>
<div class=input-group>
<i class="ph-bold ph-user-circle input-icon"></i>
<input type=text id=reg-username class=input-field placeholder=Username required>
</div>
<div class=input-group>
<i class="ph-bold ph-at input-icon"></i>
<input type=email id=reg-email class=input-field placeholder=Email required>
</div>
<div class=input-group>
<i class="ph-bold ph-whatsapp-logo input-icon"></i>
<input type=text id=reg-whatsapp class=input-field placeholder="Nomor WhatsApp (62...)" required>
</div>
<div class=input-group>
<i class="ph-bold ph-lock-key input-icon"></i>
<input type=password id=reg-password class="input-field password-input" placeholder="Sandi Akun" required>
<span class=password-toggle id=reg-password-toggle></span>
</div>
<div class="input-group">
<i class="ph-bold ph-image input-icon"></i>
<input type="file" id="reg-profile-pic" class="input-field" accept="image/*" required style="padding-top: 8px;">
</div>
<button type=submit id=register-btn class="action-button btn-primary">Daftar</button>
</form>
<p class=switch-link>Sudah punya akun? <a href=# id=show-login-link-from-reg>Login</a></p>
</div>
<div id=otp-verification-container style=display:none>
    <h2>Verifikasi Nomor WhatsApp</h2>
    <p class=subtitle>Silakan minta kode OTP 5 digit kepada Admin. Kode akan dikirimkan ke nomor WhatsApp Anda.</p>
    <p class=subtitle style="font-weight: bold; color: var(--text-primary);">Nomor WhatsApp: <span id="otp-wa-display"></span></p>
    
    <form id="otp-verify-form">
        <div class=input-group>
            <i class="ph-bold ph-key input-icon"></i>
            <input type=text id="otp-input" class=input-field placeholder="Masukkan 5 Digit Kode OTP" required maxlength=5 inputmode=numeric pattern="\d*">
        </div>
        <button type=submit id="verify-otp-btn" class="action-button btn-primary">Verifikasi</button>
    </form>
    
    <div class="switch-link" style="margin-top: 20px;">
        <button id="resend-otp-btn" class="action-button btn-secondary" style="width: 100%;" disabled>
            Minta OTP Baru (<span id="otp-timer">50</span>s)
        </button>
    </div>
    
    <div class="switch-link" style="margin-top: 10px;">
        <button id="cancel-otp-btn" class="action-button btn-red" style="width: 100%;">Batalkan Pendaftaran</button>
    </div>
    
    <p class=switch-link>Salah nomor? <a href=# id=show-register-link-from-otp>Kembali ke Pendaftaran</a></p>
</div>
<div id=forgot-password-container>
<div id=verify-user-view>
<h2>Lupa Kata Sandi</h2>
<p class=subtitle>Masukkan data akun Anda untuk verifikasi.</p>
<form id=verify-user-form>
<div class=input-group>
<i class="ph-bold ph-user-circle input-icon"></i>
<input type=text id=verify-username class=input-field placeholder=Username required>
</div>
<div class=input-group>
<i class="ph-bold ph-at input-icon"></i>
<input type=email id=verify-email class=input-field placeholder=Email required>
</div>
<div class=input-group>
<i class="ph-bold ph-whatsapp-logo input-icon"></i>
<input type=text id=verify-whatsapp class=input-field placeholder="Nomor WhatsApp (62...)" required>
</div>
<button type=submit id=verify-user-btn class="action-button btn-primary">Verifikasi Akun</button>
</form>
<p class=switch-link>Ingat sandi Anda? <a href=# id=show-login-link-from-forgot>Login</a></p>
</div>
<div id=reset-password-view style=display:none>
<h2>Buat Sandi Baru</h2>
<p class=subtitle>Verifikasi berhasil. Silakan masukkan kata sandi baru Anda.</p>
<form id=reset-password-form>
<div class=input-group>
<i class="ph-bold ph-lock-key input-icon"></i>
<input type=password id=reset-new-password class="input-field password-input" placeholder="Sandi Baru" required>
<span class=password-toggle id=reset-password-toggle></span>
</div>
<div class=input-group>
<i class="ph-bold ph-password input-icon"></i>
<input type=password id=reset-confirm-password class=input-field placeholder="Konfirmasi Sandi Baru" required>
</div>
<button type=submit id=reset-password-btn class="action-button btn-green">Simpan Sandi Baru</button>
</form>
</div>
</div>
</div>
<div id=app-layout>
<header id=top-navbar>
    <div class="header-brand">
        <div class="brand-container">
            <img src="https://bussimulator.id/wp-content/uploads/2017/03/logo-wide-super-small.png" alt="BUSSID Logo" class="brand-logo">
            <h1>Bussid&Trucksid SHOP<span class=subtitle-brand>by@donitata1717</span></h1>
            <img src="https://trucksimulator.id/wp-content/uploads/2024/12/logo.png" alt="TRUCKSID Logo" class="brand-logo">
        </div>
    </div>
    
    <nav>
        <ul class=sidebar-nav>
            <li class="nav-item"><a href=# id=nav-stok-akun><i class="ph-bold ph-shopping-bag-open nav-icon"></i><span class=nav-text>Beli Akun</span></a></li>
            <li class="nav-item"><a href=# id=nav-jual-akun><i class="ph-bold ph-tag nav-icon"></i><span class=nav-text>Jual Akun</span></a></li>
            <li class=nav-item><a href=# id=nav-topupBussid><img src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjyQYodaXJAK1A9Bi0YOIU2BhQubEYchhFx-2PZYB8hOIopqXIQ1FXK_goAxP0GPaXyXk6L5jnO3aOL6EuzkEgGxa2tohs7YJazYrVPZ8czUi8BSjWWkrTKVCTwk7wmhEZRWFPP1U2S-FjXUwDbi9duZ9ejBNm0xTLBFblyee8yY_Jk2MLtQj6v3E_bePI/s1600/Bussid.png class=nav-icon-img alt="BUSSID Icon"><span class=nav-text>Topup BUSSID</span></a></li>
            <li class=nav-item><a href=# id=nav-topupTrucksid><img src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4Q0wYqZDSD7VH-0QlvsqTDi4xnKg5NfRDLJHt92A-4qMcVNMXHpZPkGOQARhJWeZXr0VCCbMCUXJn2iAL-xbCOGELYZQqEgnJXD-VneGmLKQgjO5C9XhyphenhypheneMWD0RBl_bv3VKAGfhYxDzKLPhFjujKFMy7ITYuvLyiW-aDEp3AkM_Tn-jEAPuZXmPqarJY/s1600/images__1_-removebg-preview.png class=nav-icon-img alt="TRUCKSID Icon"><span class=nav-text>Topup TRUCKSID</span></a></li>
            <li class="nav-item user-only" style="display:none;"><a href=# id=nav-topup><i class="ph-bold ph-wallet nav-icon"></i><span class=nav-text>Topup Saldo</span></a></li>
            <li class="nav-item user-only"><a href=# id=nav-subscription><i class="ph-bold ph-crown nav-icon"></i><span class=nav-text>Langganan</span></a></li>
        </ul>
    </nav>
    <div class="header-actions-bar">
        <div id="header-profile-pic-container">
            <img id="header-profile-img" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-D-aJ8x_Wu0k_4yL-h2Jb0jQ1wG-m2a3G1zB3n2a3H1j2B1H1G2B1h1g-h2j_b0jQ1wG-m2a3G1zB3n2a3/s1600/avatar.png" alt="Profile">
        </div>
        <div class=sidebar-balance-card>
            <div class=balance-info>
                <span class="balance-username" id="sidebar-username"></span>
            
<div class="balance-status-wrapper" style="display: flex; justify-content: space-between; align-items: baseline; gap: 8px;">
    <div class="balance-primary-info" style="flex-grow: 1;">
        <span class=balance-label id=sidebar-balance-label>Saldo</span>
        <span class=balance-amount id=sidebar-balance-amount>Rp 0</span>
    </div>
    
    <div id="sidebar-quota-display" style="display: none; text-align: right; flex-shrink: 0;">
        <span class=balance-label style="font-size: 0.8em; line-height: 1; font-weight: 600; color: var(--text-secondary);">Kuota Akun</span>
        <span class=balance-amount id="sidebar-quota-amount" style="font-size: 1.1em; color: var(--premium-gold); line-height: 1.1; font-weight: 700;">0</span>
    </div>
</div>
            </div>
            <span id=add-balance-btn class=add-balance-icon title="Top Up Saldo">
                <i class="ph-bold ph-plus-circle"></i>
            </span>
        </div>
        <div class="header-actions">
            <button id="cs-admin-btn" class="action-button" title="Hubungi Admin"><i class="ph-bold ph-headset"></i></button>
            <button id=header-my-account-btn class=action-button title="Akun Saya">
                <i class="ph-bold ph-gear"></i>
            </button>
            <button id=logout-btn class=action-button title=Logout>
                <i class="ph-bold ph-sign-out"></i>
                <span class=logout-text>Logout</span>
            </button>
        </div>
    </div>
</header><main class=main-content id=main-content>
<div id=my-account-container class=content-card>
<h2>Informasi Akun Saya</h2>
<div class="profile-picture-container" id="open-profile-modal-btn">
<img id="current-profile-picture" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-D-aJ8x_Wu0k_4yL-h2Jb0jQ1wG-m2a3G1zB3n2a3H1j2B1H1G2B1h1g-h2j_b0jQ1wG-m2a3G1zB3n2a3/s1600/avatar.png" alt="Profile Picture">
<div class="camera-icon-badge"><i class="ph-bold ph-camera"></i></div>
</div>
<div class=account-info-details>
    <div class="account-info-item">
        <i class="ph-bold ph-user-circle info-icon"></i>
        <div class="info-text-wrapper">
            <span class=info-label>Username</span>
            <span id=account-username class=info-value></span>
        </div>
    </div>
    <div class="account-info-item">
<div class="account-info-item" id="account-quota-item" style="display: none;">
        <i class="ph-bold ph-package info-icon" style="color: var(--accent-blue);"></i>
        <div class="info-text-wrapper">
            <span class=info-label>Sisa Kuota Akun Gratis</span>
            <span id=account-quota class="info-value" style="color: var(--accent-blue);">0</span>
        </div>
    </div>
        <i class="ph-bold ph-wallet info-icon"></i>
        <div class="info-text-wrapper">
            <span class=info-label id=account-saldo-label>Status & Saldo</span>
            <span id=account-saldo class="info-value accent-green"></span>
        </div>
    </div>
    <div class="account-info-item">
        <i class="ph-bold ph-device-mobile info-icon"></i>
        <div class="info-text-wrapper">
            <span class=info-label>Device ID</span>
            <span id=account-device-id class="info-value small-text" title="Tahan untuk menyalin"></span>
        </div>
    </div>
    <div class="account-info-item">
        <i class="ph-bold ph-at info-icon"></i>
        <div class="info-text-wrapper">
            <span class=info-label>Email Terdaftar</span>
            <span id=account-email class=info-value></span>
        </div>
    </div>
    <div class="account-info-item">
        <i class="ph-bold ph-whatsapp-logo info-icon"></i>
        <div class="info-text-wrapper">
            <span class=info-label>WhatsApp Terdaftar</span>
            <span id=account-whatsapp class=info-value></span>
        </div>
    </div>
</div><div class=account-actions>
<button id="link-google-btn" class="action-button btn-secondary" style="display: none; background-color: #fff; color: #4285F4; display: flex; align-items: center; justify-content: center; gap: 10px; line-height: 1; border: 1px solid #ccc;">
        <i class="ph-fill ph-google-logo" style="font-size: 1.2em;"></i>
        <span>Tautkan Akun Google</span>
    </button>
<button id=change-device-id-btn class="action-button btn-secondary">Ganti Device ID</button>
<button id=change-password-btn class="action-button btn-secondary">Ubah Sandi</button>
<button id=account-logout-btn class="action-button btn-red">Logout</button>
</div>
</div>
<div id=profile-container class=content-container>
<div id=other-account-section style="margin-bottom:15px">
<div id=other-account-form-container class=content-card>
<p class=subtitle style="margin-bottom:10px; font-size: 0.75em;">Tambahkan akun via Device ID atau X-Auth Token.</p>
<form id=other-account-form>
<div class=input-group style=display:none>
<select id=other-account-game class=input-field>
<option value disabled selected>Pilih Game</option>
<option value=BUSSID>BUSSID</option>
<option value=TRUCKSID>TRUCKSID</option>
</select>
</div>
<div class=input-group style="display:flex; align-items:center; gap: 5px;">
<input type=text id=other-account-key class=input-field placeholder="Device ID / X-Auth Token" required style="font-size: 0.8em; padding-right: 35px;">
<button type="button" id="paste-key-btn" title="Tempel dari clipboard" style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 1.3em; color: var(--text-secondary); cursor: pointer; padding: 5px;">
<i class="ph ph-clipboard-text"></i>
</button>
</div>
<button type=submit id=find-account-btn class="action-button btn-primary" style="font-size: 0.8em; padding: 7px;">Cari & Tambah Akun</button>
</form>
</div>
<div id="device-id-tutorial-container" style="max-width:300px; margin: 10px auto 0 auto;">
<button id="show-device-id-modal-btn" class="action-button btn-secondary" style="font-size: 0.8em; padding: 7px; background-color: var(--bg-tertiary);">
<i class="ph-bold ph-question"></i> Cara Mendapatkan Device ID
</button>
</div>
</div>
<div id="search-account-section" style="margin-bottom: 20px; max-width: 450px; margin-left: auto; margin-right: auto;">
    <div class="input-group">
        <input type="text" id="search-account-input" class="input-field" placeholder=" Cari akun berdasarkan nama atau Device ID...">
    </div>
</div>
<div id=all-profiles-grid></div>
</div>
<div id=jual-akun-container class=content-container>
    <div id="jual-akun-area">
        <div class="jual-akun-info">
            Apakah Anda ingin menjual akun Facebook/Google milik Anda? Kami bisa membelinya dengan harga Rp 2.000 - Rp 3.000.
            <br>
            Pastikan tidak terkait verifikasi 2 langkah, tidak terkait email/nomor pemulihan, dan pastikan akun Anda tidak bermasalah.
            <button id="show-sell-account-menu-btn" class="action-button" style="margin-top: 10px;">
                <i class="ph-bold ph-paper-plane-tilt"></i> Jual Akun Anda
            </button>
        </div>
        <div id="jual-akun-controls">
            <button id="check-sell-status-btn" class="action-button btn-secondary">
                 <i class="ph-bold ph-info"></i> Cek Status Penjualan
            </button>
        </div>
    </div>
</div><div id=stok-akun-container class=content-container>
<div class="stok-akun-header-controls">
    <h2>Beli Akun</h2>
    <p class=subtitle>Daftar akun yang tersedia. Beli akun menggunakan saldo atau pembayaran langsung.</p>

<div id="stok-akun-quota-display" style="display: none; background-color: var(--bg-primary); border: 1px solid var(--accent-cyan); border-radius: 8px; padding: 12px; text-align: center; margin-bottom: 10px;">
    <span class=balance-label style="font-size: 1.1em; color: var(--text-secondary); display: block;">Sisa Kuota Akun Gratis Anda:</span>
    <span id="stok-akun-quota-amount" class=balance-amount style="font-size: 2.2em; color: var(--accent-cyan); font-weight: 700; display: block; line-height: 1.2;">0</span>
</div>
    <div class="stok-akun-controls-wrapper" style="display: flex; gap: 10px; align-items: center;">
        <div class="stok-akun-filter-buttons">
            <button class="filter-btn active" id="show-available-btn">Tersedia</button>
            <button class="filter-btn" id="show-purchased-btn">Akun Terbeli</button>
        </div>
        <div id="stok-akun-sort-controls" class="stok-akun-filter-buttons">
            <button class="filter-btn active" data-sort="termurah">Termurah</button>
            <button class="filter-btn" data-sort="termahal">Termahal</button>
        </div>
    </div>
</div>

<div id="stok-akun-grid-merged">
    </div>

<p id="purchased-akun-info" class="subtitle" style="display: none; text-align:center;">Harap simpan informasi login anda dengan aman.</p>
<div id="purchased-akun-grid" style="display: none;"></div>
</div>
<div id=topup-container class=content-card>
<div id=topup-options-view>
<h2>Pilih Nominal Top Up</h2>
<div class=topup-options-grid>
<button class=topup-option-btn data-amount=50000>Rp 50.000</button>
<button class=topup-option-btn data-amount=100000>Rp 100.000</button>
</div>
<p class=subtitle style=margin-top:8px;margin-bottom:12px>Atau masukkan jumlah lain</p>
<form id=custom-topup-form>
<div class=input-group>
<input type=number id=custom-amount-input class=input-field placeholder="Minimal 10.000" min=10000 required>
</div>
<button type=submit class="action-button btn-primary">Lanjutkan</button>
</form>
</div>
<div id=topup-pending-view style=display:none>
<h2>Transaksi Dalam Proses</h2>
<div class=important-notice>
<span class=notice-title>Anda memiliki transaksi yang belum selesai.</span>
<p id=pending-info-text></p>
</div>
<button id=check-status-again-btn class="action-button btn-primary">Cek Status Lagi</button>
<button id=cancel-from-pending-btn class="action-button btn-red" style=margin-top:8px>Batalkan Transaksi</button>
</div>
<div class=history-section>
<h3>Riwayat Transaksi</h3>
<div class=history-tables-container>
<div class=history-table>
<h4>Riwayat Top Up Saldo</h4>
<ul class=history-list id=topup-history-list></ul>
</div>
<div class=history-table>
<h4>Riwayat Pembelian</h4>
<ul class=history-list id=purchase-history-list></ul>
</div>
</div>
</div>
</div>
<div id=qris-display-container class=content-card>
<h2 id="qris-title">Scan untuk Membayar</h2>
<p class=subtitle id="qris-subtitle" style="text-align:center;font-weight:bold;color:var(--text-primary)"></p>
<div style=text-align:center class="qris-image-wrapper">
<img id=qris-image src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjYrQgd8P1fWDAzUWlgGSVCCOGsgIq9g92fKW8Y4FHNw_ztExhdgNq0nx8L1IHLAaVjBvjW6wxCqMU_0lBSAkVhDULa2BEX0MvkUWxTeBCwrWTDxzMNcpgEgVkcrIfG4ZGakv3ldA8okm1jlHOPV6tvy1WQQ2ubpP4jQVv6PGDDzCKetaN8mdt_EOO0UKY/s1600/QRIS.png alt="QRIS Code">
</div>
<div class=important-notice>
<span class=notice-title>PENTING: Transfer Sesuai Nominal Unik</span>
<span id=qris-amount-display class=notice-amount>Rp 0</span>
</div>
<div class="qris-actions-wrapper">
    <div class="qris-main-actions">
        <button id=cancel-qris-btn class="action-button btn-red">Batalkan</button>
        <button id=confirm-payment-btn class="action-button btn-green">Saya Sudah Transfer</button>
    </div>
    <a href="https://wa.me/6285156776974" target="_blank" class="action-button btn-secondary"><i class="ph-bold ph-whatsapp-logo"></i> Hubungi Admin</a>
</div>
</div><div id=buy-ub-container class=content-card>
<h2>Toko UB (<span id=buy-ub-game-name></span>)</h2>
<div id=buy-ub-balance-display-wrapper class=current-balance-display>Saldo Akun Anda: <span id=buy-ub-current-saldo>Rp 0</span></div>
<div class=player-info-display>
<p>Nama Player: <span id=player-name-display></span></p>
<p>UB yang dimiliki: <span id=player-ub-display></span></p>
</div>
<div class=ub-store-display>
<div class="display-row" id="ub-display-row">
<span class=display-label>Jumlah UB:</span>
<input type="text" inputmode="numeric" id="ub-input" class="input-field" placeholder="0" maxlength="12">
</div>
<div class=display-row id=rp-display-row>
<span class=display-label>Harga:</span>
<span class="display-value rp" id=rp-display>Rp 0</span>
</div>
</div><div class="ub-input-group">
<input type="range" min="0" max="100" value="0" step="0.1" class="input-field" id="ub-slider" style="padding: 0;">
</div>
<form id=buy-ub-form>
<div id=buy-ub-error class="hasil-text error" style=display:none></div>
<div class=buy-ub-extra-actions>
<button id=confirm-buy-ub-btn type=submit class="action-button btn-green">Tambah UB</button>
</div>
<div class=buy-ub-actions>
<button type=button id=cancel-buy-ub-btn class="action-button btn-secondary">Batal</button>
<button type=button id=max-ub-btn class="action-button btn-primary">Max UB</button>
</div>
</form>
</div>
<div id=subscription-container class=content-container>
<div id=subscription-packages-view>
<h2>Paket Langganan</h2>
<p class=subtitle>Pilih paket untuk menikmati fitur-fitur eksklusif tanpa batas.</p>
<div class=subscription-grid>
<div class=subscription-card>
<h3>User Biasa</h3>
<p class=sub-price>GRATIS</p>
<ul>
    <li><i class="ph-bold ph-check-circle"></i>Akses dasar ke semua fitur toko.</li>
    <li><i class="ph-bold ph-check-circle"></i>Bisa melakukan Top-up UB.</li>
    <li><i class="ph-bold ph-check-circle"></i>Bisa Jual & Beli Akun.</li>
    <li><i class="ph-bold ph-x-circle"></i>Top-up UB menggunakan saldo (berbayar).</li>
    <li><i class="ph-bold ph-x-circle"></i>Ada kemungkinan delay saat top-up di jam sibuk.</li>
    <li><i class="ph-bold ph-x-circle"></i>Tidak ada akses Joki gratis.</li>
</ul>
<button class="action-button btn-secondary" disabled>Paket Anda Saat Ini</button>
</div>
<div class="subscription-card premium">
<h3>Langganan Bulanan</h3>
<p class=sub-price>
<span class=promo-price>Rp 65.000</span>
<span class=original-price>Rp 85.000</span>
<span class=sub-duration>/ bulan</span>
</p>
<ul>
    <li><i class="ph-bold ph-check-circle"></i><b>Semua keuntungan User Biasa.</b></li>
    <li><i class="ph-bold ph-check-circle"></i><b>Diskon Spesial</b> (Harga Normal Rp 85.000).</li>
    <li><i class="ph-bold ph-check-circle"></i>Mendapatkan <b>Kuota Akun Gratis</b> (terbatas).</li>
    <li><i class="ph-bold ph-check-circle"></i>Top-up UB sepuasnya <b>(GRATIS)</b>.</li>
    <li><i class="ph-bold ph-check-circle"></i>Tidak perlu isi saldo untuk Top-up UB.</li>
    <li><i class="ph-bold ph-check-circle"></i>Akses Joki via Admin <b>(GRATIS)</b>.</li>
    <li><i class="ph-bold ph-check-circle"></i>Prioritas layanan saat jam sibuk.</li>
    <li><i class="ph-bold ph-x-circle"></i>Akses premium akan hangus jika tidak diperpanjang.</li>
</ul>
<button id=buy-monthly-sub-btn class="action-button btn-primary">Beli Langganan</button>
</div>
<div class="subscription-card permanent">
<h3>Premium Permanen</h3>
<p class=sub-price>Rp 199.000 <span class=sub-duration>/ sekali bayar</span></p>
<ul>
    <li><i class="ph-bold ph-check-circle"></i><b>Semua keuntungan Langganan Bulanan.</b></li>
    <li><i class="ph-bold ph-check-circle"></i>Mendapatkan <b>Kuota Akun Gratis</b> (terbatas).</li>
    <li><i class="ph-bold ph-check-circle"></i>Akses premium <b>SELAMANYA</b>.</li>
    <li><i class="ph-bold ph-check-circle"></i><b>Satu kali bayar</b> untuk keuntungan permanen.</li>
    <li><i class="ph-bold ph-check-circle"></i>Dukungan prioritas tertinggi dari admin.</li>
    <li><i class="ph-bold ph-check-circle"></i>Prioritas penuh untuk <b>menjadi bagian dari Admin</b>.</li>
    <li><i class="ph-bold ph-check-circle"></i>Bebas khawatir biaya bulanan.</li>
    <li><i class="ph-bold ph-x-circle"></i>Biaya awal lebih tinggi.</li>
</ul>
<button id=buy-permanent-sub-btn class="action-button btn-green">Beli Premium</button>
</div>
</div>
</div>
</div>
</main>
</div><div id="google-new-user-modal" class="modal-overlay" style="z-index: 10003;">
    <div class="modal-content" style="max-width: 400px;">
        <h2>Lengkapi Akun Anda</h2>
        <p class="subtitle" style="line-height: 1.5;">
            Hampir selesai! Karena ini pertama kalinya Anda masuk dengan Google, kami perlu beberapa info tambahan untuk menyelesaikan pendaftaran Anda.
        </p>
        <form id="google-new-user-form" style="margin-top: 15px;">
            <div class="input-group">
                <i class="ph-bold ph-user-circle input-icon"></i>
                <input type="text" id="google-reg-username" class="input-field" placeholder="Username (wajib)" required>
            </div>
            <div class="input-group">
                <i class="ph-bold ph-whatsapp-logo input-icon"></i>
                <input type="tel" id="google-reg-whatsapp" class="input-field" placeholder="Nomor WhatsApp (wajib: 62...)" required pattern="^62\d{8,13}$" title="Harus diawali dengan 62, contoh: 628123456789">
                <p id="whatsapp-hint" style="font-size: 0.8em; color: var(--text-secondary); display: none; margin-top: 4px;">
                    Format salah. Contoh: 628123456789
                </p>
            </div>
            <div class="input-group">
                <i class="ph-bold ph-lock-key input-icon"></i>
                <input type="password" id="google-reg-password-cadangan" class="input-field password-input" placeholder="Sandi Cadangan (Opsional)">
                <span class="password-toggle" id="google-reg-password-toggle"></span>
            </div>
            <div class="input-group">
<label for="google-reg-profile-pic" style="display:block; margin-bottom:5px; font-size:0.9em; color:var(--text-secondary);">Foto Profil (Wajib)</label>
<input type="file" id="google-reg-profile-pic" class="input-field" accept="image/*" required style="padding: 8px;">
</div>
<div class="modal-actions" style="margin-top: 15px;">
                <button type="submit" id="google-reg-submit-btn" class="action-button btn-primary">Simpan & Lanjutkan</button>
            </div>
        </form>
    </div>
</div>
<div id="profile-picture-modal" class="modal-overlay" style="z-index:10008;">
<div class="modal-content" style="text-align:center;max-width:350px;">
<span class="modal-close" id="close-profile-picture-modal-btn"></span>
<h2>Foto Profil</h2>
<div style="margin:20px auto;width:250px;height:250px;border-radius:12px;overflow:hidden;border:2px solid var(--border-color);background:var(--bg-primary);display:flex;align-items:center;justify-content:center;">
<img id="full-size-profile-picture" src="" alt="Full Size" style="width:100%;height:100%;object-fit:contain;">
</div>
<div class="modal-actions">
<input type="file" id="profile-picture-input" accept="image/*" style="display:none">
<button id="trigger-change-photo-btn" class="action-button btn-primary"><i class="ph-bold ph-image"></i> Ganti Foto</button>
</div>
</div>
</div>

<div id="force-profile-picture-modal" class="modal-overlay" style="z-index:10009; background-color: rgba(0,0,0,0.9);">
<div class="modal-content" style="text-align:center;max-width:350px;">
<h2>Upload Foto Profil</h2>
<p class="subtitle" style="margin-bottom:20px;">Maaf, Anda wajib menggunakan foto profil untuk melanjutkan akses ke aplikasi ini.</p>
<form id="force-profile-pic-form">
<div class="input-group" style="margin-bottom:20px;">
<input type="file" id="force-profile-pic-input" class="input-field" accept="image/*" required style="padding: 10px;">
</div>
<button type="submit" class="action-button btn-primary">Upload & Lanjutkan</button>
</form>
</div>
</div>
<div id=device-id-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-device-id-modal-btn></span>
<h2>Cara Mendapatkan Device ID</h2>
<div class=modal-warning>
<p><strong>PERINGATAN:</strong></p>
<p>Download bussid 3.6.1 Dan Canary di bawah ini lalu instal, sebelum itu hapus bussid anda terlebih dahulu!</p>
<p>Setelah bussid 3.6.1 dan canary telah diinstal, Klik tombol "Tutorial Menggunakan" untuk lanjut!.</p>
</div>
<div class=modal-actions>
<a href="https://d.apkpure.net/b/XAPK/com.maleo.bussimulatorid?versionCode=200635" target=_blank class="action-button btn-primary">Bussid 3.6.1</a>
<a href="https://d.apkpure.com/b/APK/com.guoshi.httpcanary?versionCode=19" target=_blank class="action-button btn-primary">Canary</a>
<a href="https://m.youtube.com/watch?v=kGtflL4TdyM&pp=0gcJCfwAo7VqN5tD" target=_blank class="action-button btn-green">Tutorial Menggunakan</a>
</div>
</div>
</div>
<div id=account-status-modal class=modal-overlay><div class=modal-content>
<span class=modal-close id=close-status-modal-btn></span>
<h2 id=status-modal-title>Kelebihan Akun</h2>
<div id=status-modal-content></div>
</div>
</div>
<div id=change-device-id-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-device-id-modal></span>
<h2>Ganti Device ID</h2>
<form id=change-device-id-form>
<div class=input-group>
<input type=text id=new-device-id class=input-field placeholder="Masukkan Device ID Baru (16 Karakter)" required minlength=16 maxlength=16>
</div>
<button type=submit class="action-button btn-primary">Simpan Device ID</button>
</form>
</div>
</div>
<div id=change-password-modal class=modal-overlay><div class=modal-content>
<span class=modal-close id=close-password-modal></span>
<h2>Ubah Sandi</h2>
<form id=change-password-form>
<div class=input-group>
<input type=password id=new-password class=input-field placeholder="Masukkan Sandi Baru" required>
</div>
<div class=input-group>
<input type=password id=confirm-new-password class=input-field placeholder="Konfirmasi Sandi Baru" required>
</div>
<button type=submit class="action-button btn-primary">Simpan Sandi</button>
</form>
</div>
</div>
<div id=reduce-ub-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-reduce-ub-modal></span>
<div style=text-align:center;margin-bottom:20px>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256">
<path d=M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm48-88a8,8,0,0,1-8,8H88a8,8,0,0,1,0-16h80A8,8,0,0,1,176,128Z></path>
</svg>
</div>
<h2 style=text-align:center>Kurangi Uang Game (UB)</h2>
<p class=subtitle style=text-align:center;max-width:350px;margin-left:auto;margin-right:auto>Masukkan jumlah UB yang ingin Anda kurangi dari akun game. Tindakan ini tidak akan mengurangi saldo Rupiah Anda.</p>
<div class=modal-warning style=background-color:rgba(239,68,68,0.1);border-color:var(--accent-red);margin-top:0;margin-bottom:25px>
<p style=margin:0><strong>Peringatan:</strong> Pastikan jumlah yang dimasukkan benar. Pengurangan UB tidak dapat dibatalkan.</p>
</div>
<form id=reduce-ub-form>
<div class=input-group>
<input type=number id=reduce-ub-amount class=input-field placeholder="Contoh: 50000" required min=1>
</div>
<button type=submit id=confirm-reduce-ub-btn class="action-button btn-red">Konfirmasi & Kurangi UB</button>
</form>
</div>
</div><div id=image-lightbox class=lightbox-overlay>
<span class=lightbox-close id=close-lightbox-btn></span>
<div class=lightbox-content>
<img src alt="Tampilan Penuh" id=lightbox-image>
</div>
</div>
<div id=confirmation-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=confirm-modal-close-btn></span>
<h2 id=confirm-modal-title>Konfirmasi Pembelian</h2>
<p id=confirm-modal-message class=subtitle style=margin-bottom:25px;line-height:1.6></p>
<div class=modal-actions style=flex-direction:row;gap:15px>
<button id=confirm-modal-cancel-btn class="action-button btn-secondary" style=width:50%>Batal</button>
<button id=confirm-modal-confirm-btn class="action-button btn-green" style=width:50%>Konfirmasi</button>
</div>
</div>
</div>
<div id=akun-purchase-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-akun-purchase-modal-btn></span>
<h2>Beli Akun</h2>
<form id=akun-purchase-form>
<input type=hidden id=purchase-stok-id>
<p class=subtitle>Atur nama game baru sebelum membeli.</p>
<div class=input-group>
<i class="ph-bold ph-user-circle input-icon"></i>
<input type=text id=purchase-new-username class=input-field placeholder="Masukkan Username Game Baru" required>
</div>
<h4 style="margin-top:15px;margin-bottom:8px;border-bottom:1px solid var(--border-color);padding-bottom:5px">Detail Penawaran Akun</h4>
<div id=akun-purchase-details style="font-size:.9em;max-height:150px;overflow-y:auto;background-color:var(--bg-primary);padding:8px;border-radius:6px;line-height:1.5;color:var(--text-secondary)"></div>
<div id=akun-purchase-total style="margin-top:15px;text-align:center;font-size:1.2em">Total Harga: <span>Memuat...</span></div>
<button type=submit class="action-button btn-green" style="margin-top:15px">Beli Akun</button>
</form>
</div>
</div>
<div id="purchase-loading-overlay" class="modal-overlay" style="display: none; z-index: 10007;">
    <div class="loading-content" style="text-align: center; color: var(--text-primary);">
        <i class="ph-bold ph-spinner ph-spin" style="font-size: 3em; color: var(--accent-cyan); margin-bottom: 20px;"></i>
        <h3 id="loading-status-title" style="font-size: 1.2em; margin-bottom: 10px;">Mempersiapkan Akun...</h3>
        <p id="loading-status-message" class="subtitle" style="margin-bottom: 0;">Mohon tunggu sebentar.</p>
    </div>
</div>
<div id=maintenance-modal class="modal-overlay" style="z-index: 10006;">
    <div class="modal-content">
        <i class="ph-fill ph-warning-octagon"></i>
        <h2>Dalam Perbaikan</h2>
        <p id="maintenance-modal-message"></p>
    </div>
</div>
<div id=offline-modal class=modal-overlay>
<div class=modal-content>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256" style=margin-bottom:20px>
<path d=M128,24a104,104,0,1,0,232,128,104.11,104.11,0,0,0-128-24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-112a8,8,0,0,1,8-8h0a8,8,0,0,1,8,8v48a8,8,0,0,1-8,8h0a8,8,0,0,1-8-8ZM128,176a12,12,0,1,1,12-12A12,12,0,0,1,128,176Z></path>
</svg>
<h2 style=margin-bottom:15px>Koneksi Terputus</h2>
<p class=subtitle>Anda sedang OFFLINE atau koneksi Internet anda bermasalah, mohon cek koneksi internet anda!!!</p>
</div>
</div>
<div id=subscription-expired-modal class=modal-overlay>
<div class=modal-content>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256" style=margin-bottom:20px>
<path d=M128,24a104,104,0,1,0,232,128,104.11,104.11,0,0,0-128-24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-112a8,8,0,0,1,8-8h0a8,8,0,0,1,8,8v48a8,8,0,0,1-8,8h0a8,8,0,0,1-8-8ZM128,176a12,12,0,1,1,12-12A12,12,0,0,1,128,176Z></path>
</svg>
<h2>Masa Aktif Habis</h2>
<p class=subtitle style=line-height:1.6;margin-bottom:25px>Masa Aktif Akun Anda Telah Berakhir. Harap hubungi Admin @donitata1717@dt17corp untuk memperpanjang.</p>
</div>
</div>
<div id="ban-modal" class="modal-overlay">
    <div class="modal-content">
        <i class="ph-fill ph-prohibit"></i>
        <h2>Akun Anda Diblokir</h2>
        <p class="subtitle" style="line-height:1.6;margin-bottom:25px">
            Akun ini telah ditangguhkan oleh admin. Silakan hubungi admin untuk informasi lebih lanjut atau untuk membuka blokir.
        </p>
        <a href="https://wa.me/6285156776974" target="_blank" class="action-button btn-green"><i class="ph-bold ph-whatsapp-logo"></i> Hubungi Admin</a>
    </div>
</div>
<div id="welcome-message-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" id="close-welcome-modal-btn"></span>
        <h2 id="welcome-message-title">Pesan dari Admin</h2>
        <p id="welcome-message-content"></p>
        <div class="modal-actions">
            <button id="ok-welcome-modal-btn" class="action-button btn-primary">Mengerti</button>
        </div>
    </div>
</div>
<div id="sell-account-floating-menu">
    <div id="sell-step-1">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="font-size: 1.2em;">Jual Akun Anda</h3>
            <span class="modal-close" id="close-sell-menu-btn"></span>
        </div>
        <div id="sell-account-list" style="margin-bottom: 15px;">
            <p class="subtitle" id="no-sell-account-msg">Anda belum menambahkan akun untuk dijual.</p>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 1.1em; font-weight: bold;">
            <span>Total Bayaran:</span>
            <span id="sell-total-price" style="color: var(--accent-green);">Rp 0</span>
        </div>
        <button id="add-account-to-sell-btn" class="action-button btn-primary" style="margin-bottom: 10px;">
            <i class="ph-bold ph-plus-circle"></i> Tambah Akun untuk Dijual
        </button>
        <button id="process-sell-btn" class="action-button btn-green" disabled>JUAL AKUN</button>
    </div>

    <div id="sell-step-2" style="display: none;">
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <button id="back-to-sell-list-btn" class="back-button" style="margin-right: 10px; font-size: 1.5em; padding: 0;"><i class="ph-bold ph-arrow-left"></i></button>
            <h3 style="font-size: 1.2em;">Tambah Akun</h3>
        </div>
        <form id="add-sell-account-form">
            <div class="input-group">
                <label for="sell-login-type" class="subtitle" style="margin-bottom: 5px; display: block;">Jenis Login</label>
                <select id="sell-login-type" class="input-field" required>
                    <option value="" disabled selected>Pilih Jenis Login</option>
                    <option value="Google">Google</option>
                    <option value="Facebook">Facebook</option>
                </select>
            </div>
            <div id="sell-google-inputs" style="display: none;">
                <div class="input-group">
                    <input type="email" id="sell-google-email" class="input-field" placeholder="Email Google">
                </div>
                <div class="input-group">
                    <input type="password" id="sell-google-password" class="input-field" placeholder="Sandi">
                </div>
            </div>
            <div id="sell-facebook-inputs" style="display: none;">
                <div class="input-group">
                    <input type="text" id="sell-facebook-credential" class="input-field" placeholder="Email / No. HP / Username">
                </div>
                <div class="input-group">
                    <input type="password" id="sell-facebook-password" class="input-field" placeholder="Sandi">
                </div>
            </div>
            <div class="sdk-checkbox-container">
                <input type="checkbox" id="sell-sdk-agree" required>
                <label for="sell-sdk-agree">Akun harus dalam kondisi tidak terkait Nomor/email pemulihan!!! Pastikan sudah tidak terkait.</label>
            </div>
            <button type="submit" class="action-button btn-primary">Tambah Akun</button>
        </form>
    </div>

    <div id="sell-step-3" style="display: none;">
        <h3 style="font-size: 1.2em; margin-bottom: 15px;">Detail Pembayaran</h3>
        <p class="subtitle">Admin akan membayarkan <strong><span id="payment-total-amount" style="color: var(--accent-green);"></span></strong> kepada Anda.</p>
        <form id="sell-payment-form">
            <label class="subtitle">Pilih Metode Pembayaran:</label>
            <div class="payment-options-grid">
                <button type="button" class="payment-option-btn" data-payment="Dana">Dana</button>
                <button type="button" class="payment-option-btn" data-payment="Ovo">OVO</button>
                <button type="button" class="payment-option-btn" data-payment="Gopay">GoPay</button>
                <button type="button" class="payment-option-btn" data-payment="S-Pay">ShopeePay</button>
            </div>
            <div class="input-group">
                <input type="tel" id="sell-payment-phone" class="input-field" placeholder="Nomor HP E-Wallet" required>
            </div>
            <button type="submit" class="action-button btn-green">Oke, Kirim ke Admin</button>
        </form>
    </div>
    
    <div id="sell-step-4" style="display: none;">
        <h3 style="font-size: 1.2em; text-align: center; margin-bottom: 10px;">Penjualan Akun dalam Proses</h3>
        <p class="subtitle" style="text-align: center;">Ini membutuhkan waktu cukup lama. <strong>Admin sedang mengecek akun secara manual.</strong></p>
        <div id="processing-account-list" style="margin: 15px 0;">
            </div>
        <div style="text-align: center; font-size: 1.1em; font-weight: bold;">
            Status: <span id="sell-status-display" style="color: var(--accent-cyan);">Di Proses</span>
        </div>
        <button id="close-sell-process-view-btn" class="action-button btn-secondary" style="margin-top: 15px;">Tutup</button>
    </div>
</div><div id="admin-profile-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" id="close-admin-profile-modal-btn"></span>
        <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-D-aJ8x_Wu0k_4yL-h2Jb0jQ1wG-m2a3G1zB3n2a3H1j2B1H1G2B1h1g-h2j_b0jQ1wG-m2a3G1zB3n2a3/s1600/avatar.png" alt="Admin Avatar" class="admin-avatar">
        <h2>Admin @donitata1717</h2>
        <p class="admin-info">
            Hai saya admin panggil saja Doni, jika butuh bantuan atau kendala masalah silakan hubungi saya, biasanya saya aktif antara jam 8.00 sampai 00.00 tetapi kalo lagi sibuk biasanya saya off jadi silakan hubungi saya jika saya lihat akan langsung saya balas. terimakasih
        </p>
        <div class="admin-socials">
            <a href="https://wa.me/6285156776974" target="_blank" class="social-btn whatsapp">
                <i class="ph-bold ph-whatsapp-logo"></i>
                <span>WhatsApp</span>
            </a>
            <a href="https://www.instagram.com/donitata1717" target="_blank" class="social-btn instagram">
                <i class="ph-bold ph-instagram-logo"></i>
                <span>Instagram</span>
            </a>
        </div>
    </div>
</div><div id="sell-status-modal" class="modal-overlay">
    <div class="modal-content">
        <span class="modal-close" id="close-sell-status-modal-btn"></span>
        <h2>Status Penjualan Akun</h2>
        <div id="sell-status-content">
            <p class="subtitle">Belum ada data penjualan.</p>
        </div>
    </div>
</div><script type=module>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, query, collection, where, getDocs, updateDoc, getDoc, addDoc, serverTimestamp, orderBy, limit, setDoc, deleteDoc, Timestamp, runTransaction, deleteField } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getDatabase, ref, onValue, onDisconnect, set, serverTimestamp as dbServerTimestamp, push, onChildAdded, get } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
        
        const firebaseConfig = { apiKey: "AIzaSyB3KJT9eh42V6ytLoY5e4ozzDXY4sHhado", authDomain: "donitata1717-f10f7.firebaseapp.com", projectId: "donitata1717-f10f7", storageBucket: "donitata1717-f10f7.appspot.com", messagingSenderId: "760325542999", appId: "1:760325542999:web:be97c17580f64407e33f12", databaseURL: "https://donitata1717-f10f7-default-rtdb.asia-southeast1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
// --- Tambahan untuk Login Google ---
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
const auth = getAuth(app);
const googleProvider = new GoogleAuthProvider();

async function handleGoogleLogin() {
    const btn = document.getElementById('google-login-btn');
    btn.disabled = true;
    btn.querySelector('span').textContent = 'Memeriksa...';

    try {
        const result = await signInWithPopup(auth, googleProvider);
        const user = result.user;

        // INI BAGIAN KUNCI: Menghubungkan Auth ke Firestore
        await cekAtauBuatUserDiFirestore(user);

    } catch (error) {
        if (error.code === 'auth/popup-closed-by-user') {
            showToast("Login Google dibatalkan.", "info");
        } else {
            console.error("Gagal login Google:", error);
            showToast("Gagal login Google: " + error.message, "error");
        }
    } finally {
        if (btn) { // Pastikan tombol masih ada
            btn.disabled = false;
            btn.querySelector('span').textContent = 'Masuk dengan Google';
        }
    }
}

async function cekAtauBuatUserDiFirestore(authUser) {
    // 1. Cari user di Firestore berdasarkan EMAIL
    const usersRef = collection(db, "users");
    const q = query(usersRef, where("email", "==", authUser.email));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
        // --- PENGGUNA LAMA DITEMUKAN (Blok ini tidak berubah) ---
        const userDoc = querySnapshot.docs[0];
        loggedInUser = { ...userDoc.data(), docId: userDoc.id };

        // (Ini adalah kode sukses dari fungsi login manual Anda)
        showToast("Login Google Berhasil! Memuat data...", "success");
        new Audio('sambutan.wav').play();
        sendTelegramMessage(` *Login Google Berhasil*\n*Username:* \`${loggedInUser.username}\`\n*Email:* \`${loggedInUser.email}\``, userActionBotToken);

        const newLoginCount = (loggedInUser.loginCount || 0) + 1;
        const userRef = doc(db, "users", loggedInUser.docId);
        await updateDoc(userRef, { loginCount: newLoginCount });
        loggedInUser.loginCount = newLoginCount;

        setupPresenceSystem();
        checkAndShowWelcomeMessage();
        activateLiveChat(loggedInUser.username);
        setupRealtimeBalanceListener();

    } else {
        // --- PENGGUNA BARU, TAMPILKAN MODAL ---
        // Alih-alih mendaftar, kita simpan data auth & tampilkan modal
        pendingGoogleAuthUser = authUser;

        // Coba isi otomatis username dari email
        const usernameDariEmail = authUser.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, '');
        document.getElementById('google-reg-username').value = usernameDariEmail;

        // Reset form & tombol
        const btn = document.getElementById('google-reg-submit-btn');
        btn.disabled = false;
        btn.innerText = "Simpan & Lanjutkan";
        document.getElementById('google-reg-whatsapp').value = '';
        document.getElementById('google-reg-password-cadangan').value = '';

        // Tampilkan modal
        showModal(document.getElementById('google-new-user-modal'));

        // Setup password toggle untuk modal baru jika belum
        if (!document.getElementById('google-reg-password-toggle')._listenerAttached) {
             setupPasswordToggle('google-reg-password-cadangan', 'google-reg-password-toggle');
             document.getElementById('google-reg-password-toggle')._listenerAttached = true;
        }
    }
}
// --- Selesai Tambahan ---
async function handleGoogleNewUserSubmit(event) {
    event.preventDefault();
    const btn = document.getElementById('google-reg-submit-btn');
    btn.disabled = true;
    btn.innerText = "Memproses...";

    const username = document.getElementById('google-reg-username').value.trim();
    const whatsapp = document.getElementById('google-reg-whatsapp').value.trim();
    const passwordCadangan = document.getElementById('google-reg-password-cadangan').value;

    const authUser = pendingGoogleAuthUser;

    try {
        if (!authUser) {
            throw new Error("Sesi Google Anda telah berakhir. Silakan coba lagi.");
        }
        if (!username || !whatsapp) {
            throw new Error("Username dan Nomor WhatsApp wajib diisi.");
        }
        if (!whatsapp.startsWith('62')) {
            throw new Error("Nomor WhatsApp harus diawali dengan 62.");
        }
        if (!document.getElementById('google-reg-profile-pic').files[0]) {
             throw new Error("Wajib upload foto profil.");
        }

        btn.innerText = "Mengompres Foto...";
        const profileBase64 = await resizeAndCompressImage(document.getElementById('google-reg-profile-pic').files[0], 500, 0.8);
        btn.innerText = "Memproses...";

        // Cek duplikat username
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("username", "==", username));
        const querySnapshot = await getDocs(q);
        if (!querySnapshot.empty) {
            throw new Error("Username ini sudah digunakan. Silakan pilih nama lain.");
        }

        // Tentukan sandi cadangan
        const finalPassword = passwordCadangan || "google_login";

        // Buat data pengguna baru
        const newUserData = {
            username: username,
            email: authUser.email,
            isGoogleLinked: true,
            password: finalPassword,
            whatsapp: whatsapp,
            profilePictureBase64: profileBase64,
            saldo: 0,
            accountType: 'USER',
            loginCount: 1,
            isBanned: false,
            masaAktifHingga: null,
            pendingTransaction: 0,
            pendingSubscription: null,
            pendingAkunPurchase: null,
            otherAccountsList: [],
            akunJualStatus: null,
            createdAt: serverTimestamp()
        };

        const docRef = await addDoc(collection(db, "users"), newUserData);
        loggedInUser = { ...newUserData, docId: docRef.id };

        // Bersihkan
        pendingGoogleAuthUser = null;
        hideModal(document.getElementById('google-new-user-modal'));
        document.getElementById('google-new-user-form').reset();

        // Lanjutkan alur login
        showToast("Pendaftaran berhasil! Memuat data...", "success");
        new Audio('sambutan.wav').play();
        sendTelegramMessage(` *Pendaftaran Baru (via Google)*\n*Username:* \`${loggedInUser.username}\`\n*Email:* \`${loggedInUser.email}\``, userActionBotToken);

        setupPresenceSystem();
        checkAndShowWelcomeMessage();
        activateLiveChat(loggedInUser.username);
        setupRealtimeBalanceListener();

    } catch (error) {
        showToast(error.message, "error");
        btn.disabled = false;
        btn.innerText = "Simpan & Lanjutkan";
    }
}
async function handleLinkGoogleAccount() {
    const btn = document.getElementById('link-google-btn');
    btn.disabled = true;
    btn.querySelector('span').textContent = 'Memeriksa...';

    try {
        const result = await signInWithPopup(auth, googleProvider);
        const googleUser = result.user;
        const googleEmail = googleUser.email;

        // Cek apakah email Google ini sudah dipakai akun LAIN
        const usersRef = collection(db, "users");
        const q = query(usersRef, where("email", "==", googleEmail));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
            const existingUser = querySnapshot.docs[0];
            if (existingUser.id !== loggedInUser.docId) {
                // Email dipakai oleh orang lain
                throw new Error("Akun Google ini sudah tertaut ke pengguna lain.");
            }
            // Jika tidak, email ini sudah terdaftar di akun INI, tidak masalah.
        }

        // Tautkan akun
        const userRef = doc(db, "users", loggedInUser.docId);
        await updateDoc(userRef, {
            email: googleEmail,
            isGoogleLinked: true // Tandai sebagai akun yang terhubung Google
        });

        // Perbarui data lokal
        loggedInUser.email = googleEmail;
        loggedInUser.isGoogleLinked = true;

        showToast("Akun Google berhasil ditautkan!", "success");
        displayMyAccountInfo(); // Muat ulang info akun untuk menyembunyikan tombol

    } catch (error) {
        if (error.code === 'auth/popup-closed-by-user') {
            showToast("Proses tautan dibatalkan.", "info");
        } else {
            console.error("Gagal menautkan Akun Google:", error);
            showToast("Gagal menautkan: " + error.message, "error");
        }
    } finally {
        btn.disabled = false;
        btn.querySelector('span').textContent = 'Tautkan Akun Google';
    }
}
        
        const TELEGRAM_BOT_TOKEN = "7899731117:AAEpxfFIMiTR_Y-L8ad-VRR5qBF1y5kg4t4"; // Token untuk notif pembayaran, jual akun, dll.
        const userActionBotToken = "8409996364:AAGoO10QZJqNEUdNOuy9vkwsdB89m_-s-TI"; // Token khusus notif login, logout, topup, daftar.
        const TELEGRAM_CHAT_ID = "7348139166";
        const formBotToken = "7899731117:AAEpxfFIMiTR_Y-L8ad-VRR5qBF1y5kg4t4";
        const formChatId = "7348139166";
const CHAT_NOTIF_BOT_TOKEN = "8313365155:AAGrDtEwhjfu72rbiqD__BT5nUaJy9IfRq4"; // Token untuk notif live chat

        const gameConfigs = {
            "BUSSID": { name: "BUSSID", icon: "", host: '4ae9.playfabapi.com', titleId: '4AE9', profileImage: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjyQYodaXJAK1A9Bi0YOIU2BhQubEYchhFx-2PZYB8hOIopqXIQ1FXK_goAxP0GPaXyXk6L5jnO3aOL6EuzkEgGxa2tohs7YJazYrVPZ8czUi8BSjWWkrTKVCTwk7wmhEZRWFPP1U2S-FjXUwDbi9duZ9ejBNm0xTLBFblyee8yY_Jk2MLtQj6v3E_bePI/s1600/Bussid.png' },
            "TRUCKSID": { name: "TRUCKSID", icon: "", host: '89a0b.playfabapi.com', titleId: '89A0B', profileImage: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4Q0wYqZDSD7VH-0QlvsqTDi4xnKg5NfRDLJHt92A-4qMcVNMXHpZPkGOQARhJWeZXr0VCCbMCUXJn2iAL-xbCOGELYZQqEgnJXD-VneGmLKQgjO5C9XhyphenhypheneMWD0RBl_bv3VKAGfhYxDzKLPhFjujKFMy7ITYuvLyiW-aDEp3AkM_Tn-jEAPuZXmPqarJY/s1600/images__1_-removebg-preview.png' }
        };
        const priceOptions = [{ text: "150.000.000 UB", price: 10000 }, { text: "371.000.000 UB", price: 22000 }, { text: "593.000.000 UB", price: 35000 }, { text: "815.000.000 UB", price: 48000 }, { text: "1,03M UB", price: 61000 }, { text: "1,26M UB", price: 73000 }, { text: "1,48M UB", price: 86000 }, { text: "1,7M UB", price: 99000 }, { text: "1,92M UB", price: 112000 }, { text: "2,1M UB", price: 125000 }];
        const SELL_PRICES = { Google: 2000, Facebook: 2200 };

        let loggedInUser = null;
        let isProfileLoading = false;
        let balanceListenerUnsubscribe = null;
        let stokAkunUnsubscribe = null;
        let appSettingsListenerUnsubscribe = null;
        let activeGameSessions = {};
        let currentTransactionTarget = null;
        let activeTopupRequest = {};
        let otherAccounts = [];
        let longPressTimer;
        let activeGameTab = 'topupBussid';
        let isSubscriptionExpired = false;
        let initialContentLoaded = false;
        let userToResetPasswordId = null;
let pendingGoogleAuthUser = null;
let pendingRegistrationData = null;
let accountsToSell = [];
let otpTimerInterval = null;

        function startOtpTimer() {
            let timeLeft = 50;
            const timerEl = document.getElementById('otp-timer');
            const resendBtn = document.getElementById('resend-otp-btn');
            
            timerEl.textContent = timeLeft;
            resendBtn.disabled = true;

            if (otpTimerInterval) clearInterval(otpTimerInterval);

            otpTimerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) {
                    clearInterval(otpTimerInterval);
                    resendBtn.disabled = false;
                    resendBtn.innerHTML = 'Minta OTP Baru';
                } else {
                    resendBtn.innerHTML = `Minta OTP Baru (<span id="otp-timer">${timeLeft}</span>s)`;
                }
            }, 1000);
        }

        async function handleOtpVerification(event) {
            event.preventDefault();
            const otpInput = document.getElementById('otp-input').value.trim();
            if (otpInput.length !== 5) {
                showToast("Kode OTP harus 5 digit.", "error");
                return;
            }
            
            if (!pendingRegistrationData) {
                showToast("Data pendaftaran tidak ditemukan. Silakan ulangi.", "error");
                return;
            }
            
            const btn = document.getElementById('verify-otp-btn');
            btn.disabled = true; btn.innerText = "Memverifikasi...";

            try {
                // 1. Ambil OTP yang valid dari RTDB
                const otpRef = ref(rtdb, 'settings/activeOTP');
                const snapshot = await get(otpRef);

                if (snapshot.exists() && snapshot.val() === otpInput) {
                    // 2. OTP BENAR
                    showToast("Verifikasi berhasil! Mendaftarkan akun...", "success");
                    
                    // 3. Hapus OTP agar tidak bisa dipakai lagi
                    await set(otpRef, null);

                    // 4. Lanjutkan pendaftaran (data sudah ada di pendingRegistrationData)
                    // Tambahkan createdAt yang sebelumnya tidak bisa disimpan di variabel
                    const finalUserData = {
                        ...pendingRegistrationData,
                        createdAt: serverTimestamp() // Tambahkan timestamp saat ini
                    };
                    
                    await addDoc(collection(db, "users"), finalUserData);
                    
                    showToast("Pendaftaran berhasil! Silakan masuk.", "success");
                    sendTelegramMessage(` *Pendaftaran Baru (via OTP)*\n*Username:* \`${pendingRegistrationData.username}\`\n*Email:* \`${pendingRegistrationData.email}\``, userActionBotToken);
                    
                    pendingRegistrationData = null;
                    localStorage.removeItem('pendingRegistration'); // Hapus sesi pendaftaran
                    if (otpTimerInterval) clearInterval(otpTimerInterval);
                    
                    document.getElementById('otp-verify-form').reset();
                    document.getElementById('otp-verification-container').style.display = 'none';
                    document.getElementById('register-form').reset();
                    showLoginScreen();

                } else {
                    // 5. OTP SALAH
                    throw new Error("Kode OTP salah atau sudah kadaluarsa.");
                }
            } catch (e) {
                console.error("Error saat verifikasi OTP: ", e);
                showToast(e.message, "error");
            } finally {
                btn.disabled = false; btn.innerText = "Verifikasi";
            }
        }
// --- Start: Live Chat Widget Vars ---
let chatSessionId = null; // Will be set on login
let chatsRef = null; // Will be set on login
let chatBubbleContainer, chatWindow, chatClose, chatMessages, chatText, chatSend, chatAttachButton, chatFileInput, imagePreviewModal, previewImage, modalClose, chatLoadingIndicator;
// --- End: Live Chat Widget Vars ---
        
        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639l4.433-7.447A1 1 0 017 4h10a1 1 0 01.531.175l4.433 7.447a1.012 1.012 0 010 .639l-4.433 7.447A1 1 0 0117 20H7a1 1 0 01-.531-.175L2.036 12.322z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
        const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" /></svg>`;
        
        const dom = {

profileModal: {
overlay: document.getElementById('profile-picture-modal'),
fullImage: document.getElementById('full-size-profile-picture'),
input: document.getElementById('profile-picture-input'),
closeBtn: document.getElementById('close-profile-picture-modal-btn'),
triggerBtn: document.getElementById('trigger-change-photo-btn'),
openBtn: document.getElementById('open-profile-modal-btn'),
currentImage: document.getElementById('current-profile-picture')
},
            authWrapper: document.getElementById('auth-wrapper'),
            appLayout: document.getElementById('app-layout'),
            content: {
                myAccount: document.getElementById('my-account-container'),
                profile: document.getElementById("profile-container"),
                topup: document.getElementById("topup-container"),
                buyUb: document.getElementById("buy-ub-container"),
                qris: document.getElementById('qris-display-container'),
                subscription: document.getElementById('subscription-container'),
                stokAkun: document.getElementById('stok-akun-container'),
                jualAkun: document.getElementById('jual-akun-container'),
            },
            nav: {
                stokAkun: document.getElementById('nav-stok-akun'),
                jualAkun: document.getElementById('nav-jual-akun'),
                topupBussid: document.getElementById('nav-topupBussid'),
                topupTrucksid: document.getElementById('nav-topupTrucksid'),
                topup: document.getElementById('nav-topup'),
                subscription: document.getElementById('nav-subscription'),
            },
            lightbox: {
                overlay: document.getElementById('image-lightbox'),
                image: document.getElementById('lightbox-image'),
                closeBtn: document.getElementById('close-lightbox-btn')
            },
            confirmationModal: {
                overlay: document.getElementById('confirmation-modal'),
                title: document.getElementById('confirm-modal-title'),
                message: document.getElementById('confirm-modal-message'),
                confirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                closeBtn: document.getElementById('confirm-modal-close-btn')
            },
            maintenanceModal: {
                overlay: document.getElementById('maintenance-modal'),
                message: document.getElementById('maintenance-modal-message'),
            },
            subscriptionExpiredModal: {
                overlay: document.getElementById('subscription-expired-modal'),
            },
            banModal: {
                overlay: document.getElementById('ban-modal')
            },
            statusModal: {
                overlay: document.getElementById('account-status-modal'),
                content: document.getElementById('status-modal-content'),
                closeBtn: document.getElementById('close-status-modal-btn'),
            },
            adminProfileModal: {
                 overlay: document.getElementById('admin-profile-modal'),
                 closeBtn: document.getElementById('close-admin-profile-modal-btn')
            },
            sellStatusModal: {
                overlay: document.getElementById('sell-status-modal'),
                content: document.getElementById('sell-status-content'),
                closeBtn: document.getElementById('close-sell-status-modal-btn')
            },
            akunPurchaseModal: {
                overlay: document.getElementById('akun-purchase-modal'),
                form: document.getElementById('akun-purchase-form'),
                stokIdInput: document.getElementById('purchase-stok-id'),
                usernameInput: document.getElementById('purchase-new-username'),
                detailsDisplay: document.getElementById('akun-purchase-details'),
                totalDisplay: document.getElementById('akun-purchase-total').querySelector('span'),
                closeBtn: document.getElementById('close-akun-purchase-modal-btn')
            },
            sellMenu: {
                floatingMenu: document.getElementById('sell-account-floating-menu'),
                step1: document.getElementById('sell-step-1'),
                step2: document.getElementById('sell-step-2'),
                step3: document.getElementById('sell-step-3'),
                step4: document.getElementById('sell-step-4'),
                showBtn: document.getElementById('show-sell-account-menu-btn'),
                checkStatusBtn: document.getElementById('check-sell-status-btn'),
                closeBtn: document.getElementById('close-sell-menu-btn'),
                closeProcessViewBtn: document.getElementById('close-sell-process-view-btn'),
                addAccountBtn: document.getElementById('add-account-to-sell-btn'),
                backToListBtn: document.getElementById('back-to-sell-list-btn'),
                processSellBtn: document.getElementById('process-sell-btn'),
                accountList: document.getElementById('sell-account-list'),
                totalPrice: document.getElementById('sell-total-price'),
                addForm: document.getElementById('add-sell-account-form'),
                loginType: document.getElementById('sell-login-type'),
                googleInputs: document.getElementById('sell-google-inputs'),
                facebookInputs: document.getElementById('sell-facebook-inputs'),
                paymentForm: document.getElementById('sell-payment-form'),
                paymentTotal: document.getElementById('payment-total-amount'),
                processingList: document.getElementById('processing-account-list'),
                statusDisplay: document.getElementById('sell-status-display'),
            },
            welcomeModal: {
                overlay: document.getElementById('welcome-message-modal'),
                title: document.getElementById('welcome-message-title'),
                content: document.getElementById('welcome-message-content'),
                closeBtn: document.getElementById('close-welcome-modal-btn'),
                okBtn: document.getElementById('ok-welcome-modal-btn')
            },
            purchaseLoading: {
                overlay: document.getElementById('purchase-loading-overlay'),
                title: document.getElementById('loading-status-title'),
                message: document.getElementById('loading-status-message'),
            }
        };

        async function sendTelegramMessage(message, token) {
            if (!token) {
                console.error("Telegram bot token not provided.");
                return;
            }
            const url = `https://api.telegram.org/bot${token}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(message)}&parse_mode=Markdown`;
            try {
                await fetch(url);
            } catch (error) {
                console.error("Gagal mengirim notifikasi Telegram:", error);
            }
        }
        
        async function sendTelegramSimpleMessage(message) {
            await sendTelegramMessage(message, TELEGRAM_BOT_TOKEN);
        }

        function showToast(msg, type = 'success', dur = 3000) { const c = document.getElementById('toast-container'); if (!c) return; const t = document.createElement('div'); t.className = `toast`; if (type === 'error') { t.style.borderLeftColor = 'var(--accent-red)'; } else { t.style.borderLeftColor = 'var(--accent-green)'; } t.innerText = msg; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, dur); }
        function setupPasswordToggle(inputId, toggleId) { const i = document.getElementById(inputId); const t = document.getElementById(toggleId); if (!i || !t) return; t.innerHTML = eyeIcon; t.addEventListener('click', () => { if (i.type === 'password') { i.type = 'text'; t.innerHTML = eyeSlashIcon; } else { i.type = 'password'; t.innerHTML = eyeIcon; } }); }
        function showModal(modalElement) { if (modalElement) modalElement.style.display = 'flex'; }
        function hideModal(modalElement) { if (modalElement) modalElement.style.display = 'none'; }
        function copyToClipboard(text, successMessage) { navigator.clipboard.writeText(text).then(() => { showToast(successMessage, "success"); }, (err) => { showToast("Gagal menyalin.", "error"); console.error('Clipboard copy failed: ', err); }); }
        function addLongPressListener(element, callback) { const start = (e) => { e.preventDefault(); longPressTimer = setTimeout(() => { callback(e); }, 800); }; const end = () => { clearTimeout(longPressTimer); }; element.addEventListener('mousedown', start); element.addEventListener('mouseup', end); element.addEventListener('mouseleave', end); element.addEventListener('touchstart', start, { passive: false }); element.addEventListener('touchend', end); element.addEventListener('contextmenu', e => e.preventDefault()); }
        
        async function showPage(pageName) {
            if (!checkSubscriptionStatus()) return;

            const pageToShow = (pageName === 'topupBussid' || pageName === 'topupTrucksid') ? 'profile' : pageName;
            
            Object.values(dom.content).forEach(container => {
                if(container) container.style.display = 'none';
            });
            Object.values(dom.nav).forEach(link => {
                if(link) link.parentElement.querySelector('a').classList.remove('active');
            });
            
            if (dom.nav[pageName]) {
                dom.nav[pageName].classList.add('active');
            }if (dom.content[pageToShow]) {
                dom.content[pageToShow].style.display = 'block';
                 if (pageToShow === 'profile') {
                    if (pageName === 'topupBussid' || pageName === 'topupTrucksid') {
                        activeGameTab = pageName;
                    }
                    await fetchAllGameProfiles();
                    await loadOtherAccounts();
                    const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
                    filterProfileCards(gameToShow);
                    document.getElementById('search-account-input').value = ''; 
                    filterProfileCardsBySearch(); 
                } else if (pageToShow === 'myAccount') {
                    displayMyAccountInfo();
                } else if (pageToShow === 'subscription') {
                    updateSubscriptionPage();
                } else if (pageToShow === 'stokAkun') {
                    // --- MODIFIKASI DIMULAI ---
                    const headerControls = document.querySelector('#stok-akun-container .stok-akun-header-controls');
                    const title = headerControls.querySelector('h2');
                    const subtitle = headerControls.querySelector('p.subtitle');
                    const quotaDisplay = document.getElementById('stok-akun-quota-display');
                    const quotaAmount = document.getElementById('stok-akun-quota-amount');

                    const isFreeAccess = (loggedInUser.accountType === 'PREMIUM' || loggedInUser.accountType === 'Langganan') && checkSubscriptionStatus();

                    if (isFreeAccess) {
                        if (title) title.style.display = 'none';
                        if (subtitle) subtitle.style.display = 'none';
                        if (quotaAmount) quotaAmount.textContent = loggedInUser.akunGratisQuota || 0;
                        if (quotaDisplay) quotaDisplay.style.display = 'block';
                    } else {
                        // Tampilkan untuk User biasa
                        if (title) title.style.display = 'block';
                        if (subtitle) subtitle.style.display = 'block';
                        if (quotaDisplay) quotaDisplay.style.display = 'none';
                    }
                    
                    setupStokAkunListeners();
                    // --- MODIFIKASI SELESAI ---
                }
            }
        }function filterProfileCards(gameName) {
            document.querySelectorAll('#all-profiles-grid .profile-card').forEach(card => {
                card.classList.toggle('hidden', card.dataset.gameName !== gameName);
            });
            const tutorialContainer = document.getElementById('device-id-tutorial-container');
            if (tutorialContainer) {
                if (gameName === 'BUSSID') {
                    tutorialContainer.style.display = 'block';
                } else {
                    tutorialContainer.style.display = 'none';
                }
            }
        }
        function showLoginScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'block'; document.getElementById('register-container').style.display = 'none'; document.getElementById('forgot-password-container').style.display = 'none';}
        function showRegisterScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'none'; document.getElementById('register-container').style.display = 'block'; document.getElementById('forgot-password-container').style.display = 'none'; }
        function showForgotPasswordScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'none'; document.getElementById('register-container').style.display = 'none'; document.getElementById('forgot-password-container').style.display = 'block'; document.getElementById('verify-user-view').style.display = 'block'; document.getElementById('reset-password-view').style.display = 'none'; }
        
        function manageNavVisibility() {
            const isAdmin = loggedInUser.accountType === 'Admin';
            document.querySelectorAll('.user-only').forEach(el => {
                if (el.querySelector('#nav-topup')) {
                    el.style.display = 'none';
                } else {
                    el.style.display = isAdmin ? 'none' : 'list-item';
                }
            });
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'list-item' : 'none');
        }

        async function showAppLayout() {
            if (initialContentLoaded) return;
            dom.authWrapper.style.display = 'none';
            if (!checkSubscriptionStatus()) {
                dom.appLayout.style.display = 'flex';
                return;
            }
            manageNavVisibility();
            dom.appLayout.style.display = 'flex';
            
            showPage('stokAkun'); // Default page is now Beli Akun
            
            initialContentLoaded = true;
        }

        function getRemainingDays(dateString) {
            if (!dateString) return 0;
            const endDate = new Date(dateString);
            const today = new Date();
            endDate.setUTCHours(0, 0, 0, 0);
            today.setUTCHours(0, 0, 0, 0);
            const diffTime = endDate.getTime() - today.getTime();
            if (diffTime < 0) return 0;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            return diffDays + 1;
        }
        function checkSubscriptionStatus() {
            if (loggedInUser?.accountType === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                if (remainingDays <= 0) {
                    showModal(dom.subscriptionExpiredModal.overlay);
                    dom.appLayout.style.pointerEvents = 'none';
                    dom.appLayout.style.opacity = '0.5';
                    isSubscriptionExpired = true;
                    return false;
                }
            }
            hideModal(dom.subscriptionExpiredModal.overlay);
            dom.appLayout.style.pointerEvents = 'auto';
            dom.appLayout.style.opacity = '1';
            isSubscriptionExpired = false;
            return true;
        }

        function updateHeaderInfo() {
     if (!loggedInUser) return;
    // Update username
    document.getElementById('sidebar-username').textContent = loggedInUser.username;
    // Update header profile pic
    if (loggedInUser.profilePictureBase64) {
        document.getElementById('header-profile-img').src = loggedInUser.profilePictureBase64;
    }
    
    // Update balance/status
    const balanceLabelEl = document.getElementById('sidebar-balance-label');
    const balanceAmountEl = document.getElementById('sidebar-balance-amount');
    const addBalanceBtn = document.getElementById('add-balance-btn');
    
    // --- ELEMEN BARU UNTUK KUOTA ---
    const quotaDisplayEl = document.getElementById('sidebar-quota-display');
    const quotaAmountEl = document.getElementById('sidebar-quota-amount');
    // --- AKHIR ELEMEN BARU ---

    balanceAmountEl.className = 'balance-amount';
    if (quotaDisplayEl) quotaDisplayEl.style.display = 'none'; // Sembunyikan secara default

    if (loggedInUser.accountType === 'Admin') {
        balanceLabelEl.textContent = 'Status';
        balanceAmountEl.textContent = 'ADMIN';
        balanceAmountEl.classList.add('admin');
        addBalanceBtn.style.display = 'none';
    } else if (loggedInUser.accountType === 'PREMIUM') {
        balanceLabelEl.textContent = 'Status';
        balanceAmountEl.textContent = 'PREMIUM';
        balanceAmountEl.classList.add('premium');
        addBalanceBtn.style.display = 'none';
        dom.nav.topup.parentElement.style.display = 'none';
        
        // --- TAMPILKAN KUOTA ---
        if (quotaAmountEl) quotaAmountEl.textContent = loggedInUser.akunGratisQuota || 0;
        if (quotaDisplayEl) quotaDisplayEl.style.display = 'block';
        // --- AKHIR TAMPILKAN KUOTA ---

    } else if (loggedInUser.accountType === 'Langganan') {
        const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
        balanceLabelEl.textContent = 'Masa Aktif';
        balanceAmountEl.textContent = `${remainingDays} hari`;
        balanceAmountEl.classList.add('subscription');
        addBalanceBtn.style.display = 'none';
        dom.nav.topup.parentElement.style.display = 'none';

        // --- TAMPILKAN KUOTA ---
        if (quotaAmountEl) quotaAmountEl.textContent = loggedInUser.akunGratisQuota || 0;
        if (quotaDisplayEl) quotaDisplayEl.style.display = 'block';
        // --- AKHIR TAMPILKAN KUOTA ---

    } else {
        // User Biasa
        balanceLabelEl.textContent = 'Saldo';
        const balance = loggedInUser.saldo || 0;
        balanceAmountEl.textContent = `Rp ${balance.toLocaleString('id-ID')}`;
        addBalanceBtn.style.display = 'flex';
        dom.nav.topup.parentElement.style.display = 'list-item';
    }
}
        function setupRealtimeBalanceListener() {
            if (!loggedInUser?.docId) return;
            if (balanceListenerUnsubscribe) balanceListenerUnsubscribe();
            const userRef = doc(db, "users", loggedInUser.docId);
            balanceListenerUnsubscribe = onSnapshot(userRef, async (d) => {
                if (d.exists()) {
                    const oldData = { ...loggedInUser };
                    const newData = d.data();
                    loggedInUser = { ...newData, docId: d.id };

                    // Ban System Check
                    if (loggedInUser.isBanned) {
                        showModal(dom.banModal.overlay);
                        dom.appLayout.style.pointerEvents = 'none';
                        dom.appLayout.style.filter = 'blur(4px)';
                    } else {
                        hideModal(dom.banModal.overlay);
                        if (!loggedInUser.profilePictureBase64) {
                             const forceModal = document.getElementById('force-profile-picture-modal');
                             if (forceModal.style.display !== 'flex') showModal(forceModal);
                             dom.appLayout.style.pointerEvents = 'none';
                             dom.appLayout.style.filter = 'blur(4px)';
                        } else {
                             hideModal(document.getElementById('force-profile-picture-modal'));
                             dom.appLayout.style.pointerEvents = 'auto';
                             dom.appLayout.style.filter = 'none';
                        }
                    }
                    
                    const wasPreviouslyExpired = isSubscriptionExpired;
                    updateHeaderInfo();
                    const isCurrentlyExpired = !checkSubscriptionStatus();

                    if (wasPreviouslyExpired && !isCurrentlyExpired) {
                        showToast("Masa aktif diperpanjang! Memuat ulang data...", "success");
                        initialContentLoaded = false;
                        await showAppLayout();
                    } else if (!initialContentLoaded) {
                        await showAppLayout();
                    }
                    
                    // --- REAL-TIME QRIS UPDATE ---
                    if (oldData.pendingTransaction > 0 && !newData.pendingTransaction) {
                        const balanceIncreased = newData.saldo > oldData.saldo;
                        showToast(balanceIncreased ? `Top up Rp ${oldData.pendingTransaction.toLocaleString('id-ID')} berhasil!` : "Transaksi top up dibatalkan/ditolak.", balanceIncreased ? 'success' : 'error');
                        if (dom.content.qris.style.display === 'block') showTopupMenu();
                    }
                    if (oldData.pendingSubscription && !newData.pendingSubscription) {
                        if (newData.accountType !== oldData.accountType) showToast(`Selamat! Akun Anda telah di-upgrade ke ${newData.accountType}.`, 'success', 5000);
                        else showToast("Transaksi langganan dibatalkan/ditolak.", 'error');
                        if (dom.content.qris.style.display === 'block') showPage('subscription');
                    }
                    if (oldData.pendingAkunPurchase && !newData.pendingAkunPurchase) {
                        showToast("Pembelian akun Anda telah dikonfirmasi oleh Admin!", "success", 5000);
                        if (dom.content.qris.style.display === 'block') showPage('stokAkun');
                    }
                    
                     // Cek status penjualan akun
                    if (newData.akunJualStatus && newData.akunJualStatus.status) {
                        dom.sellMenu.statusDisplay.textContent = newData.akunJualStatus.status;
                        if (newData.akunJualStatus.status === "Selesai(Terbayar Admin)") dom.sellMenu.statusDisplay.style.color = 'var(--accent-green)';
                        else dom.sellMenu.statusDisplay.style.color = 'var(--accent-cyan)';
                    }

                } else {
                    showToast("Data pengguna tidak ditemukan lagi.", "error");
                    logout();
                }
            }, (e) => {
                console.error("Firestore snapshot error: ", e);
                showToast("Koneksi data akun terputus.", "error");
            });
        }
        
// --// --- ONLINE PRESENCE SYSTEM (FINAL & ANDAL) ---
        function setupPresenceSystem() {
            if (!loggedInUser?.docId) return;

            // 1. Referensi ke Firestore (seperti sebelumnya, untuk dibaca oleh panel admin)
            const firestoreStatusRef = doc(db, 'presence', loggedInUser.docId);

            // 2. Referensi ke Realtime Database (RTDB) untuk deteksi koneksi
            const rtdbStatusRef = ref(rtdb, `/status/${loggedInUser.docId}`);
            
            // Objek data yang akan ditulis
            const isOfflineForFirestore = {
                status: 'offline',
                last_seen: serverTimestamp(), // Timestamp Firestore
                username: loggedInUser.username
            };
            const isOnlineForFirestore = {
                status: 'online',
                last_seen: serverTimestamp(), // Timestamp Firestore
                username: loggedInUser.username
            };
            
            // 3. Monitor status koneksi ke Realtime Database
            const connectedRef = ref(rtdb, '.info/connected');
            onValue(connectedRef, (snapshot) => {
                // Jika snapshot.val() adalah true, berarti klien terhubung ke RTDB
                if (snapshot.val() === true) {
                    // Beri "wasiat" ke server RTDB. Jika koneksi putus,
                    // server akan otomatis menulis data ini ke RTDB.
                    onDisconnect(rtdbStatusRef).set({ 
                        status: 'offline', 
                        last_seen: dbServerTimestamp() // Timestamp RTDB
                    }).then(() => {
                        // Setelah wasiat berhasil diatur, set status saat ini menjadi online
                        
                        // Tulis status 'online' ke FIRESTORE (untuk panel admin)
                        setDoc(firestoreStatusRef, isOnlineForFirestore);
                        
                        // Tulis juga status 'online' ke RTDB
                        set(rtdbStatusRef, {
                           status: 'online',
                           last_seen: dbServerTimestamp()
                        });
                    });
                } else {
                    // Ini akan berjalan jika koneksi terputus saat user masih di dalam aplikasi
                    // (misalnya, internet mati). Kita update Firestore.
                    setDoc(firestoreStatusRef, isOfflineForFirestore, { merge: true });
                }
            });
        }


        async function login(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Memeriksa...";
            try {
                const q = query(collection(db, "users"), where("username", "==", document.getElementById("username").value.trim()));
                const s = await getDocs(q);
                if (s.empty) { showToast("User tidak ditemukan!", "error"); return; }
                let f = false;
                s.forEach(d => {
                    if (d.data().password === document.getElementById("password").value) {
                        loggedInUser = { ...d.data(), docId: d.id };
                        initialContentLoaded = false;
                        isSubscriptionExpired = false;
                        f = true;
                    }
                });
                if (f) {
                    showToast("Login Berhasil! Memuat data...", "success");
                    new Audio('sambutan.wav').play();
                    sendTelegramMessage(` *Login Berhasil*\n*Username:* \`${loggedInUser.username}\``, userActionBotToken);
                    
                    const newLoginCount = (loggedInUser.loginCount || 0) + 1;
                    const userRef = doc(db, "users", loggedInUser.docId);
                    await updateDoc(userRef, { loginCount: newLoginCount });
                    loggedInUser.loginCount = newLoginCount;
                    
                    setupPresenceSystem();
                    checkAndShowWelcomeMessage();
activateLiveChat(loggedInUser.username); // <-- PANGGIL FUNGSI CHAT
                    
                    setupRealtimeBalanceListener();
                } else {
                    showToast("Kata Sandi salah!", "error");
                }
            } catch (e) {
                showToast("Gagal terhubung.", "error");
                console.error("Login error: ", e);
            } finally {
                btn.disabled = false; btn.innerText = "Masuk";
            }
        }async function register(event) {
    event.preventDefault();
    const btn = event.target.querySelector('button');
    btn.disabled = true; btn.innerText = "Memeriksa...";

    const username = document.getElementById('reg-username').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const whatsapp = document.getElementById('reg-whatsapp').value.trim();
    const password = document.getElementById('reg-password').value;

    if (!username || !email || !whatsapp || !password) {
        showToast("Semua kolom harus diisi!", "error");
        btn.disabled = false; btn.innerText = "Daftar";
        return;
    }
    if (!document.getElementById('reg-profile-pic').files[0]) {
        showToast("Wajib upload foto profil!", "error");
        btn.disabled = false; btn.innerText = "Daftar";
        return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showToast("Format email tidak valid!", "error");
        btn.disabled = false; btn.innerText = "Daftar";
        return;
    }

    try {
        btn.innerText = "Mengompres Foto...";
        const profileBase64 = await resizeAndCompressImage(document.getElementById('reg-profile-pic').files[0], 500, 0.8);
        // --- AWAL MODIFIKASI: Pengecekan Status OTP ---
        let isOtpEnabled = true; // Defaultnya, OTP aktif
        try {
            const appConfigRef = doc(db, "settings", "appConfig");
            const configSnap = await getDoc(appConfigRef);
            if (configSnap.exists() && configSnap.data().otp?.isActive === false) {
                isOtpEnabled = false; // OTP dinonaktifkan oleh admin
            }
        } catch (e) {
            console.warn("Tidak dapat mengambil config OTP, menganggap OTP aktif.", e);
        }

        // --- Lanjut validasi duplikat ---
        btn.innerText = "Memvalidasi...";
        const usernameQuery = query(collection(db, "users"), where("username", "==", username));
        const emailQuery = query(collection(db, "users"), where("email", "==", email));
        const [usernameSnapshot, emailSnapshot] = await Promise.all([getDocs(usernameQuery), getDocs(emailQuery)]);

        if (!usernameSnapshot.empty) { 
            showToast("Username sudah digunakan.", "error"); 
            btn.disabled = false; btn.innerText = "Daftar";
            return; 
        }
        if (!emailSnapshot.empty) { 
            showToast("Email sudah terdaftar.", "error"); 
            btn.disabled = false; btn.innerText = "Daftar";
            return; 
        }

        // --- Simpan data untuk pendaftaran ---
        pendingRegistrationData = {
            username: username,
            email: email,
            whatsapp: whatsapp,
            password: password,
            profilePictureBase64: profileBase64,
            saldo: 0,
            accountType: 'USER',
            loginCount: 0,
            isBanned: false,
            masaAktifHingga: null,
            pendingTransaction: 0,
            pendingSubscription: null,
            pendingAkunPurchase: null,
            otherAccountsList: [],
            akunJualStatus: null,
        };

        if (isOtpEnabled) {
            // --- AWAL LOGIKA BARU: Tampilkan layar OTP ---

            // 1. Kirim notif ke Admin
            // 1. Kirim notif ke Admin
                const notifMessage = ` *Permintaan OTP Baru*\n*Username:* \`${username}\`\n*Email:* \`${email}\`\n*WA:* \`${whatsapp}\`\n\n*Kirim OTP ke:*\nhttps://wa.me/${whatsapp}\n\nMohon berikan kode OTP.`;
            sendTelegramMessage(notifMessage, CHAT_NOTIF_BOT_TOKEN); // Ganti ke bot notif chat/otp
// --- MODIFIKASI: Simpan data pendaftaran ke localStorage ---
            try {
                localStorage.setItem('pendingRegistration', JSON.stringify(pendingRegistrationData));
            } catch (e) {
                console.error("Gagal menyimpan ke localStorage:", e);
                showToast("Gagal menyimpan sesi pendaftaran. Coba lagi.", "error");
                return; // Hentikan jika tidak bisa menyimpan
            }
            // --- AKHIR MODIFIKASI ---

            // 2. Tampilkan view OTP
            document.getElementById('register-container').style.display = 'none';
            document.getElementById('otp-wa-display').textContent = whatsapp;
            document.getElementById('otp-verification-container').style.display = 'block';

            // 3. Mulai timer
            startOtpTimer();

            showToast("Permintaan terkirim! Silakan hubungi admin.", "success");
            btn.disabled = false; btn.innerText = "Daftar"; // Reset tombol reg
            // --- AKHIR LOGIKA BARU ---
        } else {
            // --- LOGIKA LAMA: Langsung daftarkan jika OTP mati ---
            btn.innerText = "Mendaftar...";
            await addDoc(collection(db, "users"), {
                ...pendingRegistrationData,
                createdAt: serverTimestamp() // Tambah timestamp
            });

            showToast("Pendaftaran berhasil! Silakan masuk.", "success");
            sendTelegramMessage(` *Pendaftaran Baru (Tanpa OTP)*\n*Username:* \`${username}\`\n*Email:* \`${email}\``, userActionBotToken);

            pendingRegistrationData = null; // Hapus data pending
            event.target.reset();
            showLoginScreen();
        }
    } catch (e) {
        console.error("Error saat pendaftaran: ", e);
        showToast("Gagal mendaftar. Coba lagi nanti.", "error");
    } finally {
        // Pastikan tombol reset jika bukan skenario OTP
        if (document.getElementById('otp-verification-container').style.display !== 'block') {
             btn.disabled = false; btn.innerText = "Daftar";
        }
    }
}
            function logout() {
            if (loggedInUser) {
                const firestoreStatusRef = doc(db, 'presence', loggedInUser.docId);
                setDoc(firestoreStatusRef, { status: 'offline', last_seen: serverTimestamp() }, { merge: true });
            }
            if (balanceListenerUnsubscribe) { balanceListenerUnsubscribe(); balanceListenerUnsubscribe = null; }
            if (stokAkunUnsubscribe) { stokAkunUnsubscribe(); stokAkunUnsubscribe = null; }
            loggedInUser = null;
            activeGameSessions = {};
            currentTransactionTarget = null;
            initialContentLoaded = false;
            isSubscriptionExpired = false;
            accountsToSell = [];
            if (chatBubbleContainer) chatBubbleContainer.style.display = 'none'; // <-- SEMBUNYIKAN CHAT
        if (chatWindow) chatWindow.classList.add('chat-hidden'); // <-- SEMBUNYIKAN JENDELA CHAT
        chatSessionId = null; // <-- RESET SESI
        chatsRef = null; // <-- RESET REFERENSI
showToast('Logout berhasil.', "success");
            setTimeout(showLoginScreen, 500);
        }
        async function getSingleGameProfile(gp) {
            const { host, titleId, deviceId } = gp;
            const sRes = await fetch(`https://${host}/Client/LoginWithAndroidDeviceID?sdk=UnitySDK-2.206.241122`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ AndroidDevice: "AndroidPhone", AndroidDeviceId: deviceId, CreateAccount: true, TitleId: titleId }) });
            const sData = await sRes.json();
            if (sData.code !== 200 || !sData.data?.SessionTicket) throw new Error(sData.errorMessage || 'Akun tidak ditemukan.');
            const sessionTicket = sData.data.SessionTicket;

            const pRes = await fetch(`https://${host}/Client/GetPlayerCombinedInfo?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ InfoRequestParameters: { GetUserAccountInfo: true, GetUserVirtualCurrency: true, GetPlayerProfile: true } }) });
            const pResult = await pRes.json();
            if (pResult.code !== 200 || !pResult.data?.InfoResultPayload) throw new Error(pResult.errorMessage || 'Gagal mengambil info player.');
            
            return { profile: pResult.data.InfoResultPayload, session: sData.data, host: host };
        }
        function displayMyAccountInfo() {
            if (!loggedInUser) return;

if(dom.profileModal && dom.profileModal.currentImage) {
dom.profileModal.currentImage.src = loggedInUser.profilePictureBase64 || 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjD-D-aJ8x_Wu0k_4yL-h2Jb0jQ1wG-m2a3G1zB3n2a3H1j2B1H1G2B1h1g-h2j_b0jQ1wG-m2a3G1zB3n2a3/s1600/avatar.png';
}

            // Logika Tautkan Akun Google
            const linkGoogleBtn = document.getElementById('link-google-btn');
            if (loggedInUser.isGoogleLinked === true || loggedInUser.password === 'google_login') {
                linkGoogleBtn.style.display = 'none'; // Sembunyikan jika sudah tertaut
            } else {
                linkGoogleBtn.style.display = 'flex'; // Tampilkan jika login manual
            }

            document.getElementById('account-username').textContent = loggedInUser.username;
            const saldoEl = document.getElementById('account-saldo');
            const saldoLabelEl = document.getElementById('account-saldo-label');
            saldoEl.className = 'info-value';
            
            // --- MODIFIKASI: Tampilkan Kuota Akun Gratis ---
            const quotaItem = document.getElementById('account-quota-item');
            const quotaEl = document.getElementById('account-quota');

            if (loggedInUser.accountType === 'Admin') {
                saldoLabelEl.textContent = 'Status Akun';
                saldoEl.textContent = 'ADMIN';
                saldoEl.classList.add('admin');
                quotaItem.style.display = 'none'; // Admin tidak pakai kuota
            } else if (loggedInUser.accountType === 'PREMIUM') {
                saldoLabelEl.textContent = 'Status Akun';
                saldoEl.textContent = 'PREMIUM';
                saldoEl.classList.add('premium');
                // Tampilkan kuota
                quotaItem.style.display = 'flex';
                quotaEl.textContent = loggedInUser.akunGratisQuota || 0;
            } else if (loggedInUser.accountType === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                saldoLabelEl.textContent = 'Masa Aktif';
                saldoEl.textContent = `${remainingDays} hari lagi`;
                saldoEl.classList.add('subscription');
                // Tampilkan kuota
                quotaItem.style.display = 'flex';
                quotaEl.textContent = loggedInUser.akunGratisQuota || 0;
            } else {
                // User Biasa
                saldoLabelEl.textContent = 'Saldo Akun';
                saldoEl.textContent = `Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`;
                saldoEl.classList.add('accent-green');
                quotaItem.style.display = 'none'; // User biasa tidak pakai kuota
            }
            // --- AKHIR MODIFIKASI ---

            const deviceIdValue = document.getElementById('account-device-id');
            const changeIdBtn = document.getElementById('change-device-id-btn');
            if (loggedInUser.device_id) {
                deviceIdValue.textContent = loggedInUser.device_id;
                addLongPressListener(deviceIdValue, () => copyToClipboard(loggedInUser.device_id, 'Device ID disalin!'));
                changeIdBtn.textContent = 'Ganti Device ID';
            } else {
                deviceIdValue.textContent = 'Belum ditambahkan';
                deviceIdValue.classList.remove('small-text');
                changeIdBtn.textContent = 'Tambahkan Device ID';
            }

            document.getElementById('account-email').textContent = loggedInUser.email || 'Tidak ada';
            document.getElementById('account-whatsapp').textContent = loggedInUser.whatsapp || 'Tidak ada';
        }
        function createSkeletonCardHTML() { return `<div class="profile-card skeleton-card"><div class="skeleton-header"><div class="skeleton skeleton-avatar"></div><div class="skeleton-text-group"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text short"></div></div></div><div class="account-details"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line"></div></div><div class="fill-balance-btn"><div class="skeleton skeleton-button"></div></div></div>`; }
        
        async function fetchAllGameProfiles() {
            if (isProfileLoading || !loggedInUser) return;
            isProfileLoading = true;
            const grid = document.getElementById('all-profiles-grid');
            grid.innerHTML = '';
            if (!loggedInUser.device_id) {
                isProfileLoading = false;
                return;
            }
            grid.innerHTML = createSkeletonCardHTML() + createSkeletonCardHTML();
            const profilePromises = Object.values(gameConfigs).map(config =>
                getSingleGameProfile({ ...config, deviceId: loggedInUser.device_id })
                    .then(result => ({ status: 'fulfilled', value: result, config }))
                    .catch(error => ({ status: 'rejected', reason: error, config }))
            );
            const results = await Promise.all(profilePromises);
            grid.innerHTML = '';
            results.forEach(res => {
                const { config } = res;
                if (res.status === 'fulfilled') {
                    const result = res.value;
                    activeGameSessions[config.name] = result;
                    grid.insertAdjacentHTML('beforeend', createProfileCardHTML(config, result.profile));
                } else {
                    grid.insertAdjacentHTML('beforeend', createErrorCardHTML(config, res.reason));
                }
            });
            const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            filterProfileCards(gameToShow);
            
            isProfileLoading = false;
        }

        function createProfileCardHTML(game, pInfo, customName = null, index = null) {
            const displayName = pInfo.PlayerProfile?.DisplayName;
            const dName = customName || displayName || 'Nama Belum Diatur';
            const hasValidName = !!displayName;
            const deviceId = pInfo.AccountInfo.AndroidDeviceInfo?.AndroidDeviceId || 'N/A';
            const xAuth = pInfo.sessionTicket || activeGameSessions[game.name]?.session?.SessionTicket || 'N/A';
            const cardIdBase = index !== null ? `other-account-card-${index}` : `my-account-card-${game.name}`;
            const playerUb = pInfo.UserVirtualCurrency?.RP?.toLocaleString('id-ID') || '0';
            const dataIndexAttr = index !== null ? `data-index="${index}"` : '';

            const leaderboardPlaceholderHTML = `
                <div class="leaderboard-placeholder" style="display: flex; align-items: center; justify-content: center;">
                    <button class="action-button btn-secondary" data-action="check-rank" data-host="${gameConfigs[game.name].host}" data-xauth="${xAuth}" style="padding: 3px 8px; font-size: 0.6em; line-height: 1;">
                        Cek Peringkat
                    </button>
                </div>
                <div class="leaderboard-container" style="display: none; font-size: 0.45em; text-align: center; line-height: 1.1;">
                </div>`;
            
            const settingsView = `
                <div class="profile-card-settings-view">
                    <i class="ph ph-arrow-left profile-settings-icon" data-action="flip-back"></i>
                    <h3>Pengaturan Akun</h3>
                    <div class="settings-info-list">
                        <div class="settings-info-item" data-copy-value="${deviceId}" title="Tahan untuk menyalin Device ID"><span class="label">Device ID</span><div class="value">${deviceId}</div></div>
                    </div>
                    <div class="settings-actions">
                        <button class="action-button btn-secondary" data-action="change-name" data-game-name="${game.name}" data-x-auth="${xAuth}"><i class="ph ph-pencil-simple"></i> Ganti Nama</button>
                        <button class="action-button btn-red" data-action="delete-account" data-game-name="${game.name}" data-x-auth="${xAuth}"><i class="ph ph-trash"></i> Hapus Akun</button>
                    </div>
                </div>`;
            
            const deleteFromListButton = index !== null 
                ? `<button class="action-button btn-red" data-action="delete-from-list" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px; background-color: #991b1b;">
                       <i class="ph-bold ph-x-circle" style="vertical-align: middle; margin-right: 4px;"></i>
                       Hapus
                   </button>`
                : `<div style="flex-basis: calc(50% - 2.5px);"></div>`;

            return `
                <div class="profile-card" id="${cardIdBase}" data-game-name="${game.name}" ${dataIndexAttr}>
                    <div class="profile-card-main-view">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <img src="${game.profileImage}" alt="${game.name} Logo" style="width: 24px; height: 24px; border-radius: 50%;">
                                <h3 class="game-title" style="font-size: 0.75em;">${game.name}</h3>
                            </div>
                            ${leaderboardPlaceholderHTML}
                        </div>
                        
                        <div class="player-display-container">
                            <div class="player-name-plate">
                                <span class="plate-icon-placeholder"></span>
                                <span class="player-name-text" title="${dName}">${dName}</span>
                                <i class="ph-bold ph-pencil-simple plate-icon" data-action="change-name" data-game-name="${game.name}" data-x-auth="${xAuth}" title="Ganti Nama"></i>
                            </div>
                            <div class="player-ub-plate">
                                <span class="plate-icon-placeholder"></span>
                                <span class="player-ub-text">Rp. ${playerUb}</span>
                                <i class="ph-bold ph-plus-circle plate-icon" data-action="topup" data-game="${game.name}" data-session="${xAuth}" data-valid-name="${hasValidName}" data-index="${index}" title="Top Up"></i>
                            </div>
                        </div>

                        <div class="fill-balance-btn-grid" style="display: flex; flex-direction: column; gap: 5px; margin-top: auto;">
                            <div class="button-row" style="display: flex; gap: 5px; justify-content: space-between;">
                                <button class="action-button btn-green" data-action="topup" data-game="${game.name}" data-session="${xAuth}" data-valid-name="${hasValidName}" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                    <i class="ph-bold ph-rocket-launch" style="vertical-align: middle; margin-right: 4px;"></i>
                                    Top Up
                                </button>
                                <button class="action-button btn-cyan" data-action="reduce-ub" data-game="${game.name}" data-session="${xAuth}" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                   <i class="ph-bold ph-arrow-down" style="vertical-align: middle; margin-right: 4px;"></i>
                                   Kurangi UB
                                </button>
                            </div>
                            <div class="button-row" style="display: flex; gap: 5px; justify-content: space-between;">
                                <button class="action-button btn-secondary" data-action="flip" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                    <i class="ph-bold ph-gear-six" style="vertical-align: middle; margin-right: 4px;"></i>
                                    Pengaturan
                                </button>
                                ${deleteFromListButton}
                            </div>
                        </div>
                    </div>
                    ${settingsView}
                </div>`;
        }
        function createErrorCardHTML(game, error, customName = null, index = null) { const dName = customName || game.name; const cardId = index !== null ? `other-account-card-${index}` : `my-account-card-error-${game.name}`; return `<div class="profile-card" id="${cardId}" data-game-name="${game.name}"><div class="profile-card-main-view"><div class="profile-card-header"><h3 class="game-title" style="font-size:0.9em;">${dName}</h3><span class="game-icon">${game.icon}</span></div><div class="profile-card-error" style="padding: 15px; text-align: center; color: var(--accent-red); flex-grow: 1; display: flex; flex-direction: column; justify-content: center;"><h4>Gagal Muat</h4><p style="font-size: 0.8em; margin-top: 8px; color: var(--text-secondary);">${error.message}</p></div></div></div>`; }
        async function fetchProfileByKey(gameName, key) {
            const config = gameConfigs[gameName];
            if (!config) throw new Error("Game tidak valid.");
            let sessionTicket = '';
            if (key.length === 16 && /^[a-fA-F0-9]+$/.test(key)) {
                const sRes = await fetch(`https://${config.host}/Client/LoginWithAndroidDeviceID?sdk=UnitySDK-2.206.241122`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ AndroidDevice: "AndroidPhone", AndroidDeviceId: key, CreateAccount: false, TitleId: config.titleId }) });
                const sData = await sRes.json();
                if (sData.code !== 200 || !sData.data?.SessionTicket) throw new Error(sData.errorMessage || 'Device ID tidak ditemukan.');
                sessionTicket = sData.data.SessionTicket;
            } else {
                sessionTicket = key;
            }
            const pRes = await fetch(`https://${config.host}/Client/GetPlayerCombinedInfo?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ InfoRequestParameters: { GetUserAccountInfo: true, GetUserVirtualCurrency: true, GetPlayerProfile: true } }) });
            const pResult = await pRes.json();
            if (pResult.code === 401) throw new Error('Token tidak valid atau telah kadaluarsa.');
            if (pResult.code !== 200 || !pResult.data?.InfoResultPayload) throw new Error(pResult.errorMessage || 'Gagal mengambil info player.');
            pResult.data.InfoResultPayload.sessionTicket = sessionTicket;
            
            return pResult.data.InfoResultPayload;
        }
        async function handleAddOtherAccount(event) {
            event.preventDefault();
            const btn = document.getElementById('find-account-btn');
            btn.disabled = true; btn.innerText = "Mencari...";
            const game = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            const key = document.getElementById('other-account-key').value.trim();
            try {
                if (!game) { throw new Error("Silakan pilih game terlebih dahulu dari menu utama."); }
                if (otherAccounts.some(acc => acc.key.toLowerCase() === key.toLowerCase() && acc.game === game)) {
                    throw new Error("Akun ini sudah ada di dalam daftar Anda.");
                }
                const profileInfo = await fetchProfileByKey(game, key);
                const name = profileInfo.PlayerProfile?.DisplayName || `Akun ${key.substring(0, 5)}`;
                otherAccounts.unshift({ name, game, key });
                await saveOtherAccounts();
                await renderOtherAccounts();
                showToast("Akun berhasil ditambahkan!", "success");
                event.target.reset();
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                btn.disabled = false; btn.innerText = "Cari & Tambah Akun";
            }
        }
        async function saveOtherAccounts() { if (!loggedInUser?.docId) return; try { const userRef = doc(db, "users", loggedInUser.docId); await updateDoc(userRef, { otherAccountsList: otherAccounts }); } catch (error) { console.error("Gagal menyimpan akun ke Firebase:", error); showToast("Gagal menyimpan akun tambahan.", "error"); } }
        async function loadOtherAccounts() { if (!loggedInUser) return; otherAccounts = loggedInUser.otherAccountsList || []; await renderOtherAccounts(); }
        
        async function renderOtherAccounts() {
            const grid = document.getElementById('all-profiles-grid');
            
            grid.querySelectorAll('.profile-card[data-index]').forEach(card => card.remove());
            
            if (otherAccounts.length === 0) {
                filterProfileCardsBySearch();
                return;
            }
            
            const profilePromises = otherAccounts.map(account => fetchProfileByKey(account.game, account.key)
                .then(profileInfo => ({ status: 'fulfilled', value: profileInfo, account }))
                .catch(error => ({ status: 'rejected', reason: error, account }))
            );
            const results = await Promise.all(profilePromises);
            
            results.forEach((result, index) => {
                const { account } = result;
                const gameConfig = gameConfigs[account.game];
                let cardHTML;
                if (result.status === 'fulfilled') {
                    const profileInfo = result.value;
                    cardHTML = createProfileCardHTML(gameConfig, profileInfo, account.name, index);
                    activeGameSessions[`${account.name}-${account.game}`] = { profile: profileInfo, session: { SessionTicket: profileInfo.sessionTicket }, host: gameConfig.host };
                } else {
                    cardHTML = createErrorCardHTML(gameConfig, result.reason, account.name, index);
                }
                grid.insertAdjacentHTML('beforeend', cardHTML);
            });
            
            const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            filterProfileCards(gameToShow);
            filterProfileCardsBySearch();
        }

        function filterProfileCardsBySearch() {
            const searchTerm = document.getElementById('search-account-input').value.toLowerCase();
            const grid = document.getElementById('all-profiles-grid');
            const cards = Array.from(grid.querySelectorAll('.profile-card:not(.skeleton-card)'));

            const matches = [];
            const other = [];

            cards.forEach(card => {
                const gameName = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
                if (card.dataset.gameName !== gameName) {
                    card.style.display = 'none';
                    return;
                }

                const playerName = (card.querySelector('.player-name-text')?.textContent || '').toLowerCase();
                const deviceId = (card.querySelector('.settings-info-item[data-copy-value]')?.dataset.copyValue || '').toLowerCase();
                
                const isMatch = playerName.includes(searchTerm) || deviceId.includes(searchTerm);

                if (isMatch) {
                    if (playerName.startsWith(searchTerm) || deviceId.startsWith(searchTerm)) {
                        matches.unshift(card); 
                    } else {
                        matches.push(card);
                    }
                } else {
                    other.push(card);
                }
            });

            matches.forEach(card => {
                card.style.display = 'flex';
                grid.appendChild(card);
            });
            other.forEach(card => {
                card.style.display = 'none';
                grid.appendChild(card);
            });
        }

        async function handleDeleteOtherAccount(index) { 
            const isConfirmed = await showConfirmation(`Apakah Anda yakin ingin menghapus akun ini dari daftar?`, "Konfirmasi Hapus"); 
            if (isConfirmed) { 
                otherAccounts.splice(index, 1); 
                await saveOtherAccounts(); 
                document.getElementById(`other-account-card-${index}`)?.remove();
                showToast("Akun telah dihapus dari daftar.", "success"); 
            } 
        }
        async function handleUpdatePassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            if (!newPassword || newPassword !== confirmPassword) { showToast("Sandi baru tidak cocok atau kosong!", "error"); return; }
            const btn = event.target.querySelector('button');
            btn.disabled = true;
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { password: newPassword });
                loggedInUser.password = newPassword;
                showToast("Sandi berhasil diperbarui!", "success");
                hideModal(document.getElementById('change-password-modal'));
                event.target.reset();
            } catch (error) {
                showToast("Gagal memperbarui sandi: " + error.message, "error");
            } finally {
                btn.disabled = false;
            }
        }
        async function handleUpdateDeviceId(event) {
            event.preventDefault();
            const newDeviceId = document.getElementById('new-device-id').value.trim();
            if (newDeviceId.length !== 16) { showToast("Device ID harus 16 karakter!", "error"); return; }
            const btn = event.target.querySelector('button');
            btn.disabled = true;
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { device_id: newDeviceId });
                loggedInUser.device_id = newDeviceId;
                showToast("Device ID berhasil diperbarui! Memuat ulang profil...", "success");
                hideModal(document.getElementById('change-device-id-modal'));
                displayMyAccountInfo();
                event.target.reset();
                await fetchAllGameProfiles();
            } catch (error) {
                showToast("Gagal memperbarui Device ID: " + error.message, "error");
            } finally {
                btn.disabled = false;
            }
        }
        function showConfirmation(message, title = "Konfirmasi") {
            return new Promise(resolve => {
                const modal = dom.confirmationModal;
                const messageEl = modal.message;
                
                messageEl.classList.remove('invoice-style-confirmation');

                if (message.startsWith('<div class="invoice-style-confirmation">')) {
                    messageEl.classList.add('invoice-style-confirmation');
                }
                
                modal.title.textContent = title;
                messageEl.innerHTML = message;
                showModal(modal.overlay);
                const close = (result) => { hideModal(modal.overlay); modal.confirmBtn.onclick = null; modal.cancelBtn.onclick = null; modal.closeBtn.onclick = null; modal.overlay.onclick = null; resolve(result); };
                modal.confirmBtn.onclick = () => close(true);
                modal.cancelBtn.onclick = () => close(false);
                modal.closeBtn.onclick = () => close(false);
                modal.overlay.onclick = (e) => { if (e.target === modal.overlay) { close(false); } };
            });
        }
        
        function calculateRpFromUb(ub) {
            const maxUb = 2147483647;
            const maxRp = 130000;
            if (ub <= 0) return 0;
            if (ub >= maxUb) return maxRp;
            const price = 2.805 * Math.sqrt(ub);
            return Math.ceil(price / 100) * 100;
        }
        
        function updateUbDisplay(source = 'slider') {
            const slider = document.getElementById('ub-slider');
            const input = document.getElementById('ub-input');
            const maxUb = 2147483647;
            let ubVal;

            if (source === 'slider') {
                const percentage = parseFloat(slider.value) / 100;
                ubVal = Math.round(percentage * maxUb);
                input.value = ubVal > 0 ? ubVal.toLocaleString('id-ID') : '0';
            } else { 
                const cleanValue = input.value.replace(/\./g, '');
                ubVal = parseInt(cleanValue, 10);

                if (isNaN(ubVal) || ubVal < 0) ubVal = 0;
                if (ubVal > maxUb) ubVal = maxUb;
                
                input.value = ubVal.toLocaleString('id-ID');

                const newPercentage = (ubVal / maxUb) * 100;
                slider.value = newPercentage;
            }
            
            const isFreeAccess = ['PREMIUM', 'Admin', 'Langganan'].includes(loggedInUser.accountType) && checkSubscriptionStatus();
            
            if (isFreeAccess) {
                document.getElementById('rp-display-row').style.display = 'none';
            } else {
                const rpVal = calculateRpFromUb(ubVal);
                document.getElementById('rp-display').textContent = `Rp ${rpVal.toLocaleString('id-ID')}`;
                document.getElementById('rp-display-row').style.display = 'flex';
            }
        }function showBuyUbScreen(gameName, sessionTicket = null, otherAccountIndex = null) {
            let targetSessionKey = gameName;
            if (sessionTicket) { targetSessionKey = Object.keys(activeGameSessions).find(key => activeGameSessions[key]?.session?.SessionTicket === sessionTicket); }
            const sessionData = activeGameSessions[targetSessionKey];
            if (!sessionData) { showToast("Sesi game tidak valid atau kadaluarsa. Coba refresh.", "error"); return; }
            currentTransactionTarget = { name: gameName, otherAccountIndex: otherAccountIndex, ...sessionData };
            const isFreeAccess = ['PREMIUM', 'Admin', 'Langganan'].includes(loggedInUser.accountType) && checkSubscriptionStatus();
            const slider = document.getElementById('ub-slider');
            const input = document.getElementById('ub-input');
            
            slider.value = 0;
            input.value = '0';

            document.getElementById('buy-ub-game-name').textContent = gameName;
            const saldoDisplayWrapper = document.getElementById('buy-ub-balance-display-wrapper');
            const saldoDisplay = document.getElementById('buy-ub-current-saldo');
            if (isFreeAccess) {
                saldoDisplayWrapper.style.display = 'none';
            } else {
                saldoDisplayWrapper.style.display = 'block';
                saldoDisplay.textContent = `Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`;
                saldoDisplay.style.color = 'var(--accent-green)';
            }
            document.getElementById('player-name-display').textContent = sessionData.profile.PlayerProfile?.DisplayName || 'Tidak Ada Nama';
            document.getElementById('player-ub-display').textContent = (sessionData.profile.UserVirtualCurrency?.RP || 0).toLocaleString('id-ID');
            document.getElementById('buy-ub-error').style.display = 'none';
            updateUbDisplay();
            showPage('buyUb');
        }
        async function executeUbTransaction(amount) {
            const ub = parseInt(String(amount).replace(/\./g, ''), 10);
            if (isNaN(ub) || ub === 0) { showToast("Jumlah UB tidak valid.", "error"); return; }
            const isFreeAccess = ['PREMIUM', 'Admin', 'Langganan'].includes(loggedInUser.accountType) && checkSubscriptionStatus();
            const isAdding = ub > 0;
            const actionText = isAdding ? "menambahkan" : "mengurangi";
            const cost = isAdding && !isFreeAccess ? calculateRpFromUb(ub) : 0;
            const ubAbs = Math.abs(ub);
            
            if (isAdding && !isFreeAccess && loggedInUser.saldo < cost) {
                document.getElementById('buy-ub-error').innerText = 'Saldo tidak cukup.';
                document.getElementById('buy-ub-error').style.display = 'block';
                sendTelegramMessage(` *Topup Saldo GAGAL (Saldo Kurang)*\n*Username:* \`${loggedInUser.username}\`\n*Game:* ${currentTransactionTarget.name}\n*Ingin Beli:* ${ubAbs.toLocaleString('id-ID')} UB (Rp ${cost.toLocaleString('id-ID')})\n*Saldo:* Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`, userActionBotToken);
                return;
            }
            if (!currentTransactionTarget) { showToast("Target transaksi tidak valid.", "error"); return; }
            
            const message = `Anda akan <strong>${actionText} ${ubAbs.toLocaleString('id-ID')} UB</strong> ${isAdding && !isFreeAccess ? `seharga <strong style="color: var(--accent-green);">Rp ${cost.toLocaleString('id-ID')}</strong>` : (isAdding ? 'secara <strong>GRATIS</strong>' : '')}. Lanjutkan?`;
            const isConfirmed = await showConfirmation(message, `Konfirmasi ${actionText} UB`);
            if (!isConfirmed) { showToast("Tindakan dibatalkan.", "success"); return; }
            
            const btn = document.getElementById('confirm-buy-ub-btn');
            const reduceBtn = document.getElementById('confirm-reduce-ub-btn');
            btn.disabled = true; btn.innerText = "Memproses...";
            if (reduceBtn) { reduceBtn.disabled = true; reduceBtn.innerText = "Memproses..."; }
            document.getElementById('buy-ub-error').style.display = 'none';
            
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                if (isAdding && !isFreeAccess) { const newSaldo = loggedInUser.saldo - cost; await updateDoc(userRef, { saldo: newSaldo }); }
                const payload = { FunctionName: "AddRp", FunctionParameter: { addValue: ub }, GeneratePlayStreamEvent: false };
                const res = await fetch(`https://${currentTransactionTarget.host}/Client/ExecuteCloudScript?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': currentTransactionTarget.session.SessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.code !== 200) { if (isAdding && !isFreeAccess) { await updateDoc(userRef, { saldo: loggedInUser.saldo }); } throw new Error(result.errorMessage || 'Gagal mengubah UB.'); }
                await addDoc(collection(db, "purchase_history"), { userId: loggedInUser.docId, username: loggedInUser.username, game: currentTransactionTarget.name, rpCost: cost, ubAmount: ub, status: "Success", timestamp: serverTimestamp() });
                
                if (isAdding) {
                    if (isFreeAccess) {
                        sendTelegramMessage(` *Topup Gratis Berhasil*\n*Username:* \`${loggedInUser.username}\`\n*Status:* ${loggedInUser.accountType}\n*Game:* ${currentTransactionTarget.name}\n*Jumlah:* ${ubAbs.toLocaleString('id-ID')} UB`, userActionBotToken);
                    } else {
                        sendTelegramMessage(` *Topup Saldo Berhasil*\n*Username:* \`${loggedInUser.username}\`\n*Game:* ${currentTransactionTarget.name}\n*Jumlah:* ${ubAbs.toLocaleString('id-ID')} UB\n*Harga:* Rp ${cost.toLocaleString('id-ID')}`, userActionBotToken);
                    }
                }

                showToast(`Berhasil! ${ubAbs.toLocaleString('id-ID')} UB telah di${actionText}.`, "success");
                
                if (currentTransactionTarget.otherAccountIndex !== null && currentTransactionTarget.otherAccountIndex !== undefined) {
                    const indexToMove = parseInt(currentTransactionTarget.otherAccountIndex, 10);
                    if (indexToMove >= 0 && indexToMove < otherAccounts.length) {
                        const [accountToMove] = otherAccounts.splice(indexToMove, 1);
                        otherAccounts.unshift(accountToMove);
                        await saveOtherAccounts();
                    }
                }

                await fetchAllGameProfiles();
                await renderOtherAccounts();
                showPage(activeGameTab);
                if (!isAdding) hideModal(document.getElementById('reduce-ub-modal'));
            } catch (e) {
                 if(isAdding && !isFreeAccess){ sendTelegramMessage(` *Topup Saldo GAGAL*\n*Username:* \`${loggedInUser.username}\`\n*Game:* ${currentTransactionTarget.name}\n*Error:* ${e.message}`, userActionBotToken); }
                showToast(`Gagal: ${e.message}`, 'error');
                document.getElementById('buy-ub-error').innerText = `Error: ${e.message}`;
                document.getElementById('buy-ub-error').style.display = 'block';
            } finally {
                btn.disabled = false; btn.innerText = "Tambah UB";
                if (reduceBtn) { reduceBtn.disabled = false; reduceBtn.innerText = "Kurangi UB"; }
            }
        }
        async function showTopupMenu() { 
            showPage('topup'); 
            const opts = document.getElementById('topup-options-view'); 
            const pend = document.getElementById('topup-pending-view'); 
            if (loggedInUser.pendingTransaction > 0) { 
                opts.style.display = 'none'; 
                pend.style.display = 'block'; 
                document.getElementById('pending-info-text').innerHTML = `Selesaikan pembayaran <strong style="color: #f59e0b; font-size: 1.2em;">Rp ${loggedInUser.pendingTransaction.toLocaleString('id-ID')}</strong>.`; 
            } else { 
                opts.style.display = 'block'; 
                pend.style.display = 'none'; 
            } 
            displayTransactionHistory(); 
        }
        async function generateQrisScreen(baseAmount, type = 'Top Up Saldo', meta = {}) { 
            if (baseAmount < 10000 && type === 'Top Up Saldo') { 
                showToast("Minimum top up Rp 10.000", "error"); 
                return; 
            } 
            const uniqueCode = Math.floor(100 + Math.random() * 900); 
            const totalAmount = baseAmount + uniqueCode; 
            
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                let updateData = {};
                let notifMessage = "";

                if (type === 'Top Up Saldo') {
                    updateData = { pendingTransaction: totalAmount };
                    notifMessage = ` *Permintaan Pembayaran Dibuat (Top Up Saldo)*\n\n*Username:* \`${loggedInUser.username}\`\n*No. WA:* \`${loggedInUser.whatsapp}\`\n*Jumlah Transfer:* *Rp ${totalAmount.toLocaleString('id-ID')}*`;
                } else if (type === 'Beli Akun') {
                    updateData = { pendingAkunPurchase: { ...meta, uniqueAmount: totalAmount } };
                     notifMessage = ` *Permintaan Pembayaran Dibuat (Beli Akun)*\n\n*Username:* \`${loggedInUser.username}\`\n*No. WA:* \`${loggedInUser.whatsapp}\`\n*Nama Akun:* ${meta.usernameTampilan}\n*Jumlah Transfer:* *Rp ${totalAmount.toLocaleString('id-ID')}*`;
                } else if (type.includes('Langganan') || type.includes('Premium')) {
                     updateData = { pendingSubscription: { ...meta, uniqueAmount: totalAmount } };
                     notifMessage = ` *Permintaan Pembayaran Dibuat (Subscription)*\n\n*Username:* \`${loggedInUser.username}\`\n*No. WA:* \`${loggedInUser.whatsapp}\`\n*Paket:* ${type}\n*Jumlah Transfer:* *Rp ${totalAmount.toLocaleString('id-ID')}*`;
                }
                
                await updateDoc(userRef, updateData);
                await sendTelegramMessage(notifMessage, TELEGRAM_BOT_TOKEN);
                
                loggedInUser = { ...loggedInUser, ...updateData };
                activeTopupRequest = { baseAmount, totalAmount, username: loggedInUser.username, whatsapp: loggedInUser.whatsapp, type }; 
                
                document.getElementById('qris-title').textContent = `Pembayaran ${type}`;
                document.getElementById('qris-subtitle').textContent = `Paket: ${meta.usernameTampilan || type}`;
                document.getElementById('qris-amount-display').innerText = `Rp ${totalAmount.toLocaleString('id-ID')}`;
                
                showPage('qris');
            } catch (e) {
                showToast("Gagal memulai transaksi.", "error"); 
                console.error("QRIS Generation Error:", e);
            } 
        }

        async function sendTelegramNotification() { 
            const btn = document.getElementById('confirm-payment-btn'); 
            btn.disabled = true; btn.innerText = "Mengirim..."; 
            const { totalAmount, username, whatsapp, type } = activeTopupRequest; 
            const msg = ` *Konfirmasi Pembayaran (${type})*\n\n*Username:* \`${username}\`\n*No. WA:* \`${whatsapp}\`\n*Jumlah Transfer:* *Rp ${totalAmount.toLocaleString('id-ID')}*\n\nPengguna telah mengkonfirmasi.`; 
            try { 
                await sendTelegramMessage(msg, TELEGRAM_BOT_TOKEN);
                showToast("Konfirmasi terkirim! Admin akan segera memproses.", "success"); 
                if (type === 'Top Up Saldo') {
                    showTopupMenu(); 
                } else {
                    showPage('stokAkun');
                }
            } catch (e) { 
                showToast("Gagal kirim notifikasi. Hubungi admin manual.", "error"); 
            } finally { 
                btn.disabled = false; btn.innerText = "Saya Sudah Transfer"; 
            } 
        }

        async function cancelTopupTransaction(event) {
            const clickedButton = event.target;
            const isConfirmed = await showConfirmation(`Apakah Anda yakin ingin membatalkan transaksi ini?`, "Konfirmasi Pembatalan");
            if (!isConfirmed) {
                return;
            }
            const originalText = clickedButton.innerText;
            clickedButton.disabled = true;
            clickedButton.innerText = "Membatalkan...";
            const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
            if (confirmPaymentBtn) {
                confirmPaymentBtn.disabled = true;
            }
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                let updateData = {};
                 if (loggedInUser.pendingTransaction > 0) updateData = { pendingTransaction: 0 };
                 else if (loggedInUser.pendingSubscription) updateData = { pendingSubscription: deleteField() };
                 else if (loggedInUser.pendingAkunPurchase) updateData = { pendingAkunPurchase: deleteField() };

                await updateDoc(userRef, updateData);

                loggedInUser = {...loggedInUser, ...updateData};
                activeTopupRequest = {};
                showToast("Transaksi berhasil dibatalkan.", "success");
                showTopupMenu(); // Go back to the main topup menu
            } catch (e) {
                showToast("Gagal membatalkan transaksi: " + e.message, "error");
                console.error("Error cancelling transaction:", e);
            } finally {
                clickedButton.disabled = false;
                clickedButton.innerText = originalText;
                if (confirmPaymentBtn) {
                    confirmPaymentBtn.disabled = false;
                }
            }
        }
        async function displayTransactionHistory() {
            const topupList = document.getElementById('topup-history-list');
            const purchaseList = document.getElementById('purchase-history-list');
            topupList.innerHTML = '<li>Memuat...</li>';
            purchaseList.innerHTML = '<li>Memuat...</li>';
            const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
            try {
                const topupQuery = query(collection(db, "topup_history"), where("userId", "==", loggedInUser.docId), orderBy("timestamp", "desc"), limit(20));
                const topupSnapshot = await getDocs(topupQuery);
                topupList.innerHTML = '';
                if (topupSnapshot.empty) { topupList.innerHTML = '<li class="no-history">Tidak ada riwayat.</li>'; }
                else { topupSnapshot.forEach(doc => { const data = doc.data(); topupList.innerHTML += `<li class="topup"><div class="history-item-header"><span class="amount topup">+ Rp ${data.amount.toLocaleString('id-ID')}</span><span>${data.status}</span></div><div class="history-item-footer">${formatDate(data.timestamp)}</div></li>`; }); }
            } catch (error) { console.error("Error fetching topup history:", error); topupList.innerHTML = '<li class="no-history">Gagal memuat riwayat.</li>'; }
            try {
                const purchaseQuery = query(collection(db, "purchase_history"), where("userId", "==", loggedInUser.docId), orderBy("timestamp", "desc"), limit(40));
                const purchaseSnapshot = await getDocs(purchaseQuery);
                purchaseList.innerHTML = '';
                if (purchaseSnapshot.empty) { purchaseList.innerHTML = '<li class="no-history">Tidak ada riwayat pembelian.</li>'; }
                else {
                    purchaseSnapshot.forEach(doc => {
                        const item = doc.data();
                        let actionText;
                        if (typeof item.ubAmount === 'number') {
                             const isAdding = item.ubAmount > 0;
                             actionText = (isAdding ? `+${item.ubAmount.toLocaleString('id-ID')} UB` : `${item.ubAmount.toLocaleString('id-ID')} UB`);
                        } else if (item.package) {
                            actionText = `Langganan: ${item.package}`;
                        } else {
                            actionText = `Beli: ${item.ubAmount}`; 
                        }
                        const costText = item.rpCost > 0 ? `- Rp ${item.rpCost.toLocaleString('id-ID')}` : 'Gratis'; 
                        const costClass = item.rpCost > 0 ? 'purchase' : 'topup'; 
                        purchaseList.innerHTML += `<li class="${costClass}"><div class="history-item-header"><span class="amount ${costClass}">${costText}</span><span>${item.game || 'Layanan'}</span></div><div class="history-item-footer"><span>${actionText}</span> | <span>${formatDate(item.timestamp)}</span></div></li>`; 
                    });
                }
            } catch (error) { console.error("Error fetching purchase history:", error); purchaseList.innerHTML = '<li class="no-history">Gagal memuat riwayat.</li>'; }
        }
        
        async function moveOtherAccountToTop(index) {
            const indexNum = parseInt(index, 10);
            if (isNaN(indexNum) || indexNum < 0 || indexNum >= otherAccounts.length) return;
            
            const [accountToMove] = otherAccounts.splice(indexNum, 1);
            otherAccounts.unshift(accountToMove);
            
            await saveOtherAccounts();
            await fetchAllGameProfiles();
            await renderOtherAccounts();
        }

        async function handleDeleteAccount(gameName, xAuth, index) {
            const confirmation = prompt('Apakah Anda yakin ingin menghapus akun ini secara permanen? Tindakan ini tidak dapat diurungkan. Ketik "ok" untuk melanjutkan.');
            if (confirmation?.toLowerCase() !== 'ok') { showToast("Penghapusan akun dibatalkan.", "success"); return; }
            const button = document.querySelector(`.settings-actions button[data-action="delete-account"][data-game-name="${gameName}"]`);
            button.disabled = true; button.innerText = "Menghapus...";
            const host = gameConfigs[gameName].host;
            try {
                const res = await fetch(`https://${host}/Client/ExecuteCloudScript?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': xAuth, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ FunctionName: "DeleteUsers", FunctionParameter: null, GeneratePlayStreamEvent: false }) });
                const result = await res.json();
                if (result.code !== 200) throw new Error(result.errorMessage || 'Gagal menghapus akun.');
                showToast("Akun game berhasil dihapus secara permanen.", "success");
                if (index !== null && index !== undefined) {
                    await moveOtherAccountToTop(index);
                } else {
                    await fetchAllGameProfiles();
                    await renderOtherAccounts();
                }
            } catch (e) { showToast(`Gagal menghapus akun: ${e.message}`, 'error'); button.disabled = false; button.innerText = "Hapus Akun"; }
        }
        async function handleChangeName(gameName, xAuth, index) {
            const newName = prompt("Masukkan nama baru untuk akun game Anda:");
            if (!newName || newName.trim() === '') { showToast("Penggantian nama dibatalkan.", "success"); return; }
            const button = document.querySelector(`.settings-actions button[data-action="change-name"][data-game-name="${gameName}"]`);
            if (button) { button.disabled = true; button.innerText = "Menyimpan..."; }
            const host = gameConfigs[gameName].host;
            try {
                const res = await fetch(`https://${host}/Client/UpdateUserTitleDisplayName?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': xAuth, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ DisplayName: newName.trim() }) });
                const result = await res.json();
                if (result.code !== 200) throw new Error(result.errorMessage || 'Gagal mengganti nama.');
                showToast("Nama berhasil diganti!", "success");
                if (index !== null && index !== undefined) {
                    otherAccounts[index].name = newName.trim();
                    await moveOtherAccountToTop(index);
                } else {
                    await fetchAllGameProfiles();
                    await renderOtherAccounts();
                }
            } catch (e) { showToast(`Gagal mengganti nama: ${e.message}`, 'error'); } finally { if(button) { button.disabled = false; button.innerText = "Ganti Nama"; } }
        }
        
        async function refreshCurrentPageContent() {
            showToast("Koneksi kembali terhubung. Memuat ulang data...", "success");
            if (!loggedInUser) { return; }
            if(loggedInUser.accountType === 'Admin'){
                 showPage('stokAkun');
                 return;
            }
            await fetchAllGameProfiles();
            await renderOtherAccounts();
            const activePageKey = Object.keys(dom.nav).find(key => dom.nav[key].classList.contains('active'));
            if (!activePageKey) {
                if (dom.content.myAccount.style.display === 'block') {
                    displayMyAccountInfo();
                }
                return;
            };
            switch (activePageKey) {
                case 'topup': await showTopupMenu(); break;
                case 'subscription': updateSubscriptionPage(); break;
            }
        }

        function showAccountStatusModal() {
            const contentEl = dom.statusModal.content;
            let contentHTML = '';
            const type = loggedInUser?.accountType || 'USER';

            if (type === 'Admin') {
                contentHTML = `
                    <h4>Status: Administrator</h4>
                    <p>Anda memiliki akses penuh ke semua fitur tanpa biaya.</p>
                    <ul>
                        <li> Akses berlaku <strong>selamanya</strong>.</li>
                        <li> Top-up UB sepuasnya (GRATIS).</li>
                        <li> Akses ke menu Stok Akun.</li>
                    </ul>`;
            } else if (type === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                contentHTML = `
                    <h4>Status: Langganan</h4>
                    <p>Anda memiliki akses penuh selama masa langganan aktif.</p>
                    <ul>
                        <li> Sisa masa aktif: <strong>${remainingDays} hari</strong>.</li>
                        <li> Top-up UB sepuasnya tanpa biaya.</li>
                        <li> Gunakan fitur Joki via Admin tanpa biaya.</li>
                    </ul>`;
            } else if (type === 'PREMIUM') {
                contentHTML = `
                    <h4>Status: PREMIUM</h4>
                    <p>Anda memiliki akses penuh dan permanen ke semua fitur.</p>
                    <ul>
                        <li> Akses berlaku <strong>selamanya</strong>.</li>
                        <li> Top-up UB sepuasnya tanpa biaya (GRATIS).</li>
                        <li> Gunakan fitur Joki via Admin tanpa biaya (GRATIS).</li>
                        <li> Prioritas dukungan dari admin.</li>
                    </ul>`;
            }
            contentEl.innerHTML = contentHTML;
            showModal(dom.statusModal.overlay);
        }

        function updateSubscriptionPage() {
            if (loggedInUser.pendingSubscription) {
                document.getElementById('subscription-packages-view').style.display = 'none';
                 generateQrisScreen(loggedInUser.pendingSubscription.amount, loggedInUser.pendingSubscription.type, loggedInUser.pendingSubscription);
            } else {
                dom.content.qris.style.display = 'none';
                document.getElementById('subscription-packages-view').style.display = 'block';
                
                const monthlyBtn = document.getElementById('buy-monthly-sub-btn');
                const permanentBtn = document.getElementById('buy-permanent-sub-btn');

                monthlyBtn.disabled = false;
                monthlyBtn.innerText = 'Beli Langganan';
                permanentBtn.disabled = false;
                permanentBtn.innerText = 'Beli Premium';
                
                if (loggedInUser.accountType === 'Langganan') {
                    monthlyBtn.disabled = true;
                    monthlyBtn.innerText = 'Terbeli';
                } else if (loggedInUser.accountType === 'PREMIUM') {
                    monthlyBtn.disabled = true;
                    monthlyBtn.innerText = 'Terbeli';
                    permanentBtn.disabled = true;
                    permanentBtn.innerText = 'Terbeli';
                }
            }
        }

        async function initiateSubscriptionPayment(type, baseAmount) {
            if (loggedInUser.pendingSubscription || loggedInUser.pendingTransaction > 0 || loggedInUser.pendingAkunPurchase) {
                showToast("Anda memiliki transaksi lain yang belum selesai.", "error");
                return;
            }
            const pendingData = { type, amount: baseAmount };
            generateQrisScreen(baseAmount, type, pendingData);
        }

        async function handleVerifyUser(event) {
            event.preventDefault();
            const btn = document.getElementById('verify-user-btn');
            btn.disabled = true; btn.innerText = 'Memverifikasi...';
            const username = document.getElementById('verify-username').value;
            const email = document.getElementById('verify-email').value;
            const whatsapp = document.getElementById('verify-whatsapp').value;

            try {
                const q = query(collection(db, "users"), 
                    where("username", "==", username),
                    where("email", "==", email),
                    where("whatsapp", "==", whatsapp)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    showToast("Data pengguna tidak ditemukan atau tidak cocok.", "error");
                } else {
                    const userDoc = querySnapshot.docs[0];
                    userToResetPasswordId = userDoc.id;
                    document.getElementById('verify-user-view').style.display = 'none';
                    document.getElementById('reset-password-view').style.display = 'block';
                    showToast("Verifikasi berhasil! Silakan buat sandi baru.", "success");
                }
            } catch (e) {
                console.error("Verification error:", e);
                showToast("Terjadi kesalahan saat verifikasi.", "error");
            } finally {
                btn.disabled = false; btn.innerText = 'Verifikasi Akun';
            }
        }

                async function handleForceProfilePictureSubmit(event) {
            event.preventDefault();
            const fileInput = document.getElementById('force-profile-pic-input');
            if (!fileInput.files || !fileInput.files[0]) return;
            
            const btn = event.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Mengupload...";
            
            try {
                const base64 = await resizeAndCompressImage(fileInput.files[0], 500, 0.8);
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { profilePictureBase64: base64 });
                
                // Update state lokal & UI segera
                loggedInUser.profilePictureBase64 = base64;
                hideModal(document.getElementById('force-profile-picture-modal'));
                dom.appLayout.style.pointerEvents = 'auto';
                dom.appLayout.style.filter = 'none';
                updateHeaderInfo();

                showToast("Foto profil berhasil diupload!", "success");
            } catch (error) {
                showToast("Gagal upload: " + error.message, "error");
            } finally {
                btn.disabled = false; btn.innerText = "Upload & Lanjutkan";
            }
        }

        async function handleProfilePictureChange(event) {
const file = event.target.files[0];
if (!file) return;
if (!file.type.startsWith('image/')) { showToast("Hanya file gambar yang diperbolehkan.", "error"); return; }
if (file.size > 5 * 1024 * 1024) { showToast("Ukuran gambar maksimal 5MB.", "error"); return; }
const btn = dom.profileModal.triggerBtn;
btn.disabled = true; btn.innerHTML = "<i class='ph ph-spinner ph-spin'></i> Memproses...";
try {
const base64 = await resizeAndCompressImage(file, 500, 0.8);
const userRef = doc(db, "users", loggedInUser.docId);
await updateDoc(userRef, { profilePictureBase64: base64 });

loggedInUser.profilePictureBase64 = base64;
if (dom.profileModal && dom.profileModal.currentImage) {
    dom.profileModal.currentImage.src = base64;
}
showToast("Foto profil berhasil diperbarui!", "success");
hideModal(dom.profileModal.overlay);
} catch (error) {
console.error("Gagal upload foto:", error);
showToast("Gagal memperbarui foto: " + error.message, "error");
} finally {
btn.disabled = false; btn.innerHTML = "<i class='ph-bold ph-image'></i> Ganti Foto";
event.target.value = null;
}
}
function resizeAndCompressImage(file, maxWidth, quality) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.readAsDataURL(file);
reader.onload = (event) => {
const img = new Image();
img.src = event.target.result;
img.onload = () => {
let width = img.width, height = img.height;
if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } 
else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
const canvas = document.createElement('canvas');
canvas.width = width; canvas.height = height;
const ctx = canvas.getContext('2d');
ctx.drawImage(img, 0, 0, width, height);
resolve(canvas.toDataURL('image/jpeg', quality));
};
img.onerror = (error) => reject(error);
};
reader.onerror = (error) => reject(error);
});
}

async function handleResetPassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('reset-new-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;

            if (newPassword.length < 6) {
                showToast("Sandi minimal 6 karakter.", "error");
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast("Sandi baru tidak cocok.", "error");
                return;
            }

            const btn = document.getElementById('reset-password-btn');
            btn.disabled = true; btn.innerText = 'Menyimpan...';

            try {
                const userRef = doc(db, "users", userToResetPasswordId);
                await updateDoc(userRef, { password: newPassword });
                showToast("Kata sandi berhasil direset! Silakan login.", "success", 4000);
                userToResetPasswordId = null;
                setTimeout(showLoginScreen, 1000);
            } catch(e) {
                console.error("Password reset error:", e);
                showToast("Gagal menyimpan sandi baru.", "error");
            } finally {
                btn.disabled = false; btn.innerText = 'Simpan Sandi Baru';
            }
        }
        
        async function fetchAndDisplayLeaderboard(event) {
            const btn = event.target.closest('[data-action="check-rank"]');
            if (!btn) return;

            const host = btn.dataset.host;
            const sessionTicket = btn.dataset.xauth;
            const card = btn.closest('.profile-card');
            const placeholder = card.querySelector('.leaderboard-placeholder');
            const container = card.querySelector('.leaderboard-container');
            
            btn.disabled = true;
            btn.textContent = 'Memuat...';

            try {
                const weeklyPromise = fetch(`https://${host}/Client/GetLeaderboardAroundPlayer?sdk=UnitySDK-2.206.241122`,{method:'POST',headers:{'Content-Type':'application/json','X-Authorization':sessionTicket,'X-ReportErrorAsSuccess':'true'},body:JSON.stringify({StatisticName:"KekayaanMingguan"})}).then(res => res.json());
                const monthlyPromise = fetch(`https://${host}/Client/GetLeaderboardAroundPlayer?sdk=UnitySDK-2.206.241122`,{method:'POST',headers:{'Content-Type':'application/json','X-Authorization':sessionTicket,'X-ReportErrorAsSuccess':'true'},body:JSON.stringify({StatisticName:"KekayaanBulanan"})}).then(res => res.json());
                const allTimePromise = fetch(`https://${host}/Client/GetLeaderboardAroundPlayer?sdk=UnitySDK-2.206.241122`,{method:'POST',headers:{'Content-Type':'application/json','X-Authorization':sessionTicket,'X-ReportErrorAsSuccess':'true'},body:JSON.stringify({StatisticName:"Kekayaan"})}).then(res => res.json());

                const [weeklyData, monthlyData, allTimeData] = await Promise.all([weeklyPromise, monthlyData, allTimePromise]);

                const formatRank = (rank) => rank !== null ? `#${(rank + 1).toLocaleString('id-ID')}` : '-';
                const formatValue = (value) => value !== null ? value.toLocaleString('id-ID') : '-';
                const createRankColumn = (title, rank, value) => `<div class="rank-column" style="display:flex;flex-direction:column;align-items:center;"><span style="color:var(--text-secondary);font-weight:500;font-size:0.8em;">${title}</span><div style="font-weight:700;color:var(--premium-gold);font-size:1.2em;">${formatRank(rank)}</div><div style="font-weight:500;color:var(--text-secondary);font-size:0.9em;letter-spacing:-0.5px;">${formatValue(value)}</div></div>`;
                
                let leaderboardHTML = '<div style="display: flex; gap: 6px; width: 100%; justify-content: space-around;">';
                leaderboardHTML += createRankColumn('S. MASA', allTimeData.data?.Leaderboard[0]?.Position, allTimeData.data?.Leaderboard[0]?.StatValue);
                leaderboardHTML += createRankColumn('MINGGUAN', weeklyData.data?.Leaderboard[0]?.Position, weeklyData.data?.Leaderboard[0]?.StatValue);
                leaderboardHTML += createRankColumn('BULANAN', monthlyData.data?.Leaderboard[0]?.Position, monthlyData.data?.Leaderboard[0]?.StatValue);
                leaderboardHTML += '</div><button data-action="close-rank" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:1.5em;position:absolute;top:-2px;right:-2px;line-height:1;">&times;</button>';
                
                container.innerHTML = leaderboardHTML;
                placeholder.style.display = 'none';
                container.style.display = 'flex';

            } catch(e) {
                showToast('Gagal memuat peringkat.', 'error');
                btn.disabled = false;
                btn.textContent = 'Cek Peringkat';
            }
        }
        
        function sortStokAkun(sortType = 'termurah') {
    const mergedGrid = document.getElementById('stok-akun-grid-merged');

    const sortGrid = (grid) => {
        const cards = Array.from(grid.querySelectorAll('.stok-akun-card'));
        if (cards.length <= 1) return;

        cards.sort((a, b) => {
            const priceA = parseFloat(a.dataset.price) || 0;
            const priceB = parseFloat(b.dataset.price) || 0;
            return sortType === 'termahal' ? priceB - priceA : priceA - priceB;
        });

        cards.forEach(card => grid.appendChild(card));
    };

    sortGrid(mergedGrid);
}
function setupStokAkunListeners() {
    const mergedGrid = document.getElementById('stok-akun-grid-merged');
    const purchasedGrid = document.getElementById('purchased-akun-grid');

    if (stokAkunUnsubscribe) stokAkunUnsubscribe();

    let offeringsData = [];
    let purchasedData = [];
    let offeringsLoaded = false;
    let purchasedLoaded = false;

    const renderAll = () => {
        if (!offeringsLoaded || !purchasedLoaded) return;

        // Render Penawaran yang Tersedia
        mergedGrid.innerHTML = '';

        if (offeringsData.length === 0) {
            mergedGrid.innerHTML = '<p style="text-align: center; font-size: 0.8em;">Stok kosong.</p>';
        } else {
            // Urutkan berdasarkan harga termurah sebagai default saat render
            const sortedData = [...offeringsData].sort((a, b) => (a.price || 0) - (b.price || 0));
            sortedData.forEach(data => mergedGrid.innerHTML += createStokAkunCardHTML(data, false));
        }

        // Render Akun yang Sudah Terbeli
        purchasedGrid.innerHTML = '';
        if (purchasedData.length === 0) {
            purchasedGrid.innerHTML = '<p style="text-align: center;">Anda belum membeli akun apapun.</p>';
        } else {
            purchasedData.forEach(data => purchasedGrid.innerHTML += createStokAkunCardHTML(data, true));
        }

        // Panggil sort default saat pertama kali render
        sortStokAkun('termurah');
    };

    const offeringsQuery = query(collection(db, "stokAkun"), where("ownedBy", "==", null), orderBy("createdAt", "desc"));
    const purchasedQuery = query(collection(db, "stokKredensial"), where("ownedBy", "==", loggedInUser.username));

    const unsubOfferings = onSnapshot(offeringsQuery, (snapshot) => {
        offeringsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        offeringsLoaded = true;
        renderAll();
    }, (error) => {
        console.error("Error fetching offerings:", error);
        mergedGrid.innerHTML = '<p style="color:red;">Gagal memuat data.</p>';
    });

    const unsubPurchased = onSnapshot(purchasedQuery, (snapshot) => {
        purchasedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        purchasedLoaded = true;
        renderAll();
    }, (error) => {
         console.error("Error fetching purchased accounts:", error);
         purchasedGrid.innerHTML = '<p style="color:red;">Gagal memuat akun.</p>';
    });

    stokAkunUnsubscribe = () => {
        unsubOfferings();
        unsubPurchased();
    };
}
        
        function createStokAkunCardHTML(data, isPurchased = false) {
            const { id, gameType, loginType, email, password, deviceId, usernameTampilan, jumlahUB, price, detailInfo, stok, terjual, rating } = data;
            const gameLogo = gameConfigs[gameType]?.profileImage || '';
            const loginIcon = loginType === 'Facebook' ? `<i class="ph-fill ph-facebook-logo" style="color:#1877f2;"></i>` : `<i class="ph-fill ph-google-logo" style="color:#ea4335;"></i>`;
            
            // --- Variabel Teks Dinamis ---
            const loginMethod = loginType === 'Google' ? 'akun Google' : 'akun Facebook';
            const gameName = gameType === 'BUSSID' ? 'Bussid' : 'Trucksid';
            // --- Akhir Variabel ---
            
            if (isPurchased) {
                 // --- START: MODIFIKASI KARTU AKUN TERBELI ---
                 return `
                    <div class="stok-akun-card purchased-card" id="purchased-akun-${id}" data-device-id="${deviceId}" data-game-type="${gameType}">
                        
                        <div class="purchased-card-header">
                            <img src="${gameLogo}" alt="${gameType} Logo" class="purchased-card-logo">
                            <div class="purchased-header-info">
                                <span class="purchased-game-type">${gameType} - Milik Anda</span>
                                <span class="purchased-username username-display" title="Username Game"><i class="ph ph-spinner ph-spin"></i> Memuat...</span>
                            </div>
                            <i class="ph-fill ph-check-circle purchased-check-icon" title="Akun Terverifikasi"></i>
                        </div>

                        <div class="purchased-main-info">
                            <span class="purchased-info-label">Jumlah UB</span>
                            <span class="purchased-info-value ub-display"><i class="ph ph-spinner ph-spin"></i> Memuat...</span>
                        </div>

                        <p class="purchased-card-notice">
                            Ini adalah akun ${gameType} milik anda. Loginkan ${loginMethod} ini di handphone anda dan login ke ${gameName} dengan ${loginMethod} ini. Pastikan ${loginMethod} anda amankan, jangan lupa ganti sandinya ya. Terimakasih...
                        </p>

                        <div class="purchased-credential-grid">
                            <div class="purchased-credential-item">
                                <div class="purchased-credential-label-group">
                                    <i class="ph-bold ph-sign-in" title="Tipe Login"></i>
                                    <span>Jenis Login</span>
                                </div>
                                <span class="purchased-credential-value">${loginIcon} ${loginType}</span>
                            </div>
                            <div class="purchased-credential-item">
                                <div class="purchased-credential-label-group">
                                    <i class="ph-bold ph-at" title="Email/HP"></i>
                                    <span>Email</span>
                                </div>
                                <span class="purchased-credential-value">${email}</span>
                                <i class="ph-bold ph-copy copy-icon" onclick="copyToClipboard('${email}', 'Email disalin!')" title="Salin"></i>
                            </div>
                            <div class="purchased-credential-item">
                                <div class="purchased-credential-label-group">
                                    <i class="ph-bold ph-key" title="Kata Sandi"></i>
                                    <span>Sandi</span>
                                </div>
                                <span class="purchased-credential-value">${password}</span>
                                <i class="ph-bold ph-copy copy-icon" onclick="copyToClipboard('${password}', 'Sandi disalin!')" title="Salin"></i>
                            </div>
                            <div class="purchased-credential-item">
                                <div class="purchased-credential-label-group">
                                    <i class="ph-bold ph-device-mobile" title="Device ID"></i>
                                    <span>Device ID</span>
                                </div>
                                <span class="purchased-credential-value">${deviceId}</span>
                                <i class="ph-bold ph-copy copy-icon" onclick="copyToClipboard('${deviceId}', 'Device ID disalin!')" title="Salin"></i>
                            </div>
                        </div>
                        
                    </div>`;
                // --- END: MODIFIKASI KARTU AKUN TERBELI ---
            } else {
                const isOutOfStock = !stok || stok <= 0;
                const outOfStockClass = isOutOfStock ? 'out-of-stock' : '';
                const buttonHTML = isOutOfStock 
                    ? `<button class="action-button" disabled>Stok Habis</button>`
                    : `<button class="action-button btn-green" data-action="buy-stok-akun" data-id="${id}">Beli Akun</button>`;
                
                const ratingValue = rating || 0;
                let ratingStarsHTML = '';
                for (let i = 1; i <= 5; i++) {
                    ratingStarsHTML += i <= ratingValue ? '<i class="ph-fill ph-star"></i>' : '<i class="ph ph-star"></i>';
                }

                // --- MODIFIKASI HARGA DIMULAI ---
                const isFreeAccess = (loggedInUser.accountType === 'PREMIUM' || loggedInUser.accountType === 'Langganan') && checkSubscriptionStatus();
                
                let priceHTML = '';
                if (isFreeAccess) {
                    priceHTML = `
                        <div class="info-item price" style="background-color: rgba(6, 182, 212, 0.1);">
                            <span class="info-value" style="color: var(--accent-cyan); font-size: 0.9em; line-height: 1.2; white-space: normal; padding: 2px 0;">GRATIS<br>(Memakai Kuota Akun)</span>
                        </div>`;
                } else {
                    priceHTML = `
                        <div class="info-item price">
                            <span class="info-value">Rp ${(price || 0).toLocaleString('id-ID')}</span>
                        </div>`;
                }
                // --- MODIFIKASI HARGA SELESAI ---

                 return `
                    <div class="stok-akun-card ${gameType.toLowerCase()}-card ${outOfStockClass}" id="stok-akun-${id}" data-price="${price || 0}">
                        <div class="stok-habis-badge">HABIS</div>
                        <div class="stok-card-header">
                            <img src="${gameLogo}" alt="${gameType} Logo" class="stok-card-logo">
                            <h3 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${usernameTampilan || gameType}">${usernameTampilan || gameType}</h3>
                        </div>
                        <div class="info-grid">
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <span class="info-label"><i class="ph ph-coins"></i> Uang Game (UB)</span>
                                <span class="info-value">${(jumlahUB || 0).toLocaleString('id-ID')}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="ph ph-package"></i> Stok</span>
                                <span class="info-value">${stok || 0}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="ph ph-shopping-cart"></i> Terjual</span>
                                <span class="info-value">${terjual || 0}</span>
                            </div>
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <span class="info-label"><i class="ph ph-star"></i> Rating</span>
                                <div class="info-value rating-stars">${ratingStarsHTML}</div>
                            </div>
                        </div>
                        <div class="package-info">Paket Akun ${gameType} + Login via ${loginType}. Harga:</div>
                        ${priceHTML}
                        ${buttonHTML}
                    </div>`;

            }
        }
        
        async function showAkunPurchaseModal(offeringId) {
            const modal = dom.akunPurchaseModal;
            modal.form.reset();
            modal.stokIdInput.value = offeringId;
            
            modal.detailsDisplay.innerHTML = '<p>Memuat detail...</p>';
            modal.totalDisplay.textContent = 'Memuat...';
            showModal(modal.overlay);

            try {
                const docRef = doc(db, "stokAkun", offeringId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error("Penawaran akun tidak ditemukan.");
                
                const data = docSnap.data();
                modal.usernameInput.value = data.usernameTampilan || '';
                modal.detailsDisplay.innerHTML = `
                    <p><strong>Paket:</strong> ${data.usernameTampilan || 'Akun Siap Pakai'}</p>
                    <p><strong>Game:</strong> ${data.gameType}</p>
                    <p><strong>Login via:</strong> ${data.loginType}</p>
                    <p><strong>UB Didapat:</strong> ${data.jumlahUB.toLocaleString('id-ID')}</p>
                `;
                modal.totalDisplay.textContent = `Rp ${(data.price || 0).toLocaleString('id-ID')}`;
            } catch (error) {
                showToast(error.message, "error");
                modal.detailsDisplay.innerHTML = `<p style="color: var(--accent-red);">${error.message}</p>`;
                modal.totalDisplay.textContent = 'Error';
            }
        }

        function showPurchaseLoading(title, message = "Mohon tunggu sebentar...") {
            dom.purchaseLoading.title.textContent = title;
            dom.purchaseLoading.message.textContent = message;
            showModal(dom.purchaseLoading.overlay);
        }
        function updatePurchaseLoading(title, message) {
            dom.purchaseLoading.title.textContent = title;
            if(message) dom.purchaseLoading.message.textContent = message;
        }
        function hidePurchaseLoading() {
            hideModal(dom.purchaseLoading.overlay);
        }

        async function handleExecuteAkunPurchase(event) {
            event.preventDefault();
            const modal = dom.akunPurchaseModal;
            const btn = modal.form.querySelector('button[type="submit"]');
            const offeringId = modal.stokIdInput.value;
            const newUsername = modal.usernameInput.value.trim();

            if (!newUsername) {
                showToast("Username game baru tidak boleh kosong.", "error");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Memproses...";

            try {
                const offeringDocRef = doc(db, "stokAkun", offeringId);
                const offeringDocSnap = await getDoc(offeringDocRef);
                if (!offeringDocSnap.exists() || offeringDocSnap.data().ownedBy) {
                    throw new Error("Penawaran akun ini sudah tidak tersedia atau sudah dibeli.");
                }
                const offeringData = offeringDocSnap.data();
                const accountPrice = offeringData.price || 0;
                const userType = loggedInUser.accountType;

                const confirmationMessage = `
                <div class="invoice-style-confirmation">
                    <h4>** Struk Pembelian **</h4>
                    <div class="invoice-row"><span>Paket Akun ${offeringData.gameType}</span> <span class="price"></span></div>
                    <div class="invoice-row"><span>Nama Paket: ${offeringData.usernameTampilan}</span> <span class="price"></span></div>
                    <div class="invoice-row total"><span>TOTAL</span> <span class="price">${userType === 'Admin' ? 'GRATIS' : `Rp ${accountPrice.toLocaleString('id-ID')}`}</span></div>
                </div>`;
                const isConfirmed = await showConfirmation(confirmationMessage, "Struk Konfirmasi Pembelian");
                if (!isConfirmed) return; // Exit if not confirmed

                if (userType === 'Admin') {
                    // Admin gets it for free, direct execution
                    new Audio('proses.wav').play();
                    showPurchaseLoading("Mode Admin: Mempersiapkan Akun");
                    await executeServersidePurchase(offeringId, newUsername, updatePurchaseLoading);
                } else if (userType === 'Langganan' || userType === 'PREMIUM') {
                    // --- MODIFIKASI: Cek Kuota Akun Gratis ---
                    const kuotaGratis = loggedInUser.akunGratisQuota || 0;
                    if (kuotaGratis > 0) {
                        // Punya kuota, proses gratis (seperti Admin)
                        new Audio('proses.wav').play();
                        showPurchaseLoading(`Mode ${userType}: Mempersiapkan Akun (Sisa Kuota: ${kuotaGratis - 1})`);
                        await executeServersidePurchase(offeringId, newUsername, updatePurchaseLoading);
                    } else {
                        // Kuota habis, harus bayar via QRIS (logika lama)
                        hideModal(modal.overlay); // Hide the purchase modal
                        await generateQrisScreen(accountPrice, 'Beli Akun', { offeringId, newUsername, usernameTampilan: offeringData.usernameTampilan });
                        return; // Stop execution here, wait for payment
                    }
                    // --- AKHIR MODIFIKASI ---
                } else {
                    // Regular users pay with saldo
                    if (loggedInUser.saldo < accountPrice) {
                        throw new Error("Saldo Anda tidak mencukupi untuk pembelian ini.");
                    }
                    new Audio('proses.wav').play();
                    showPurchaseLoading("Memvalidasi Pembelian");
                    await executeServersidePurchase(offeringId, newUsername, updatePurchaseLoading);
                }
                
                showToast("Pembelian berhasil! Akun Anda telah ditambahkan.", "success", 4000);
                new Audio('sukses.wav').play();
                hideModal(modal.overlay);
                await displayTransactionHistory();
                document.getElementById('show-purchased-btn').click(); 

            } catch (error) {
                showToast(`Gagal: ${error.message}`, "error", 5000);
            } finally {
                btn.disabled = false;
                btn.innerText = "Beli Akun";
                hidePurchaseLoading();
            }
        }
        
        async function executeServersidePurchase(offeringId, originalUsername, updateStatusCallback) {
             try {
                await runTransaction(db, async (transaction) => {
                    updateStatusCallback("Mencari penawaran...");
                    const offeringDocRef = doc(db, "stokAkun", offeringId);
                    const offeringDoc = await transaction.get(offeringDocRef);
                    if (!offeringDoc.exists()) throw new Error("Penawaran akun ini tidak lagi valid.");
                    const offeringData = offeringDoc.data();
                    const accountPrice = offeringData.price || 0;
                    const targetUB = offeringData.jumlahUB || 0;
                    const gameType = offeringData.gameType;
                    
                    // --- MODIFIKASI: Logika Pembayaran/Kuota ---
                    const userRef = doc(db, "users", loggedInUser.docId);
                    const userDoc = await transaction.get(userRef);
                    const userData = userDoc.data();
                    const userType = userData.accountType;

                    if (userType === 'USER') {
                        // User biasa, potong saldo
                        updateStatusCallback("Memverifikasi saldo Anda...");
                        const currentUserSaldo = userData.saldo || 0;
                        if (currentUserSaldo < accountPrice) throw new Error("Saldo Anda tidak mencukupi.");
                        transaction.update(userRef, { saldo: currentUserSaldo - accountPrice });
                    
                    } else if (userType === 'Langganan' || userType === 'PREMIUM') {
                        // Langganan/Premium, potong kuota
                        updateStatusCallback("Memverifikasi kuota akun...");
                        const currentQuota = userData.akunGratisQuota || 0;
                        if (currentQuota <= 0) {
                            // Ini seharusnya tidak terjadi jika client-logic benar, tapi sebagai safeguard
                            throw new Error("Anda tidak memiliki kuota pembelian akun gratis.");
                        }
                        transaction.update(userRef, { akunGratisQuota: currentQuota - 1 });
                    
                    }
                    // Admin tidak melakukan apa-apa (gratis tanpa kuota)
                    // --- AKHIR MODIFIKASI ---
                    
                    updateStatusCallback("Menyiapkan kredensial akun...");
                    let kredensialDoc = null;
                    const primaryKredensialQuery = query(collection(db, "stokKredensial"), where("gameType", "==", gameType), where("ownedBy", "==", null), limit(1));
                    const primarySnapshot = await getDocs(primaryKredensialQuery);
                    
                    if (!primarySnapshot.empty) kredensialDoc = primarySnapshot.docs[0];
                    else {
                        updateStatusCallback("Mencari kredensial universal...");
                        const fallbackKredensialQuery = query(collection(db, "stokKredensial"), where("gameType", "==", "BUSSID/TRUCKSID"), where("ownedBy", "==", null), limit(1));
                        const fallbackSnapshot = await getDocs(fallbackKredensialQuery);
                        if (!fallbackSnapshot.empty) kredensialDoc = fallbackSnapshot.docs[0];
                    }

                    if (!kredensialDoc) throw new Error("Maaf, stok akun untuk game ini sedang habis. Silakan hubungi admin.");
                    const kredensialData = kredensialDoc.data();
                    const kredensialDocRef = kredensialDoc.ref;
                    
                    updateStatusCallback("Login ke akun game...");
                    const config = gameConfigs[gameType];
                    const loginRes = await fetch(`https://${config.host}/Client/LoginWithAndroidDeviceID?sdk=UnitySDK-2.206.241122`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ AndroidDevice: "AndroidPhone", AndroidDeviceId: kredensialData.deviceId, CreateAccount: false, TitleId: config.titleId }) });
                    const loginData = await loginRes.json();
                    if (loginData.code !== 200 || !loginData.data?.SessionTicket) throw new Error('Gagal login ke akun game untuk penyesuaian.');
                    const sessionTicket = loginData.data.SessionTicket;
                    
                    updateStatusCallback("Menyesuaikan UB...");
                    const pRes = await fetch(`https://${config.host}/Client/GetPlayerCombinedInfo?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ InfoRequestParameters: { GetUserVirtualCurrency: true } }) });
                    const pResult = await pRes.json();
                    const currentUB = pResult.data?.InfoResultPayload?.UserVirtualCurrency?.RP || 0;
                    
                    const ubDifference = targetUB - currentUB;
                    if (ubDifference !== 0) {
                        const payload = { FunctionName: "AddRp", FunctionParameter: { addValue: ubDifference }, GeneratePlayStreamEvent: false };
                        const execRes = await fetch(`https://${config.host}/Client/ExecuteCloudScript?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify(payload) });
                        const execResult = await execRes.json();
                        if (execResult.code !== 200) throw new Error('Gagal menyesuaikan UB akun.');
                    }

                    updateStatusCallback("Mengganti nama player...");
                    let nameChanged = false;
                    let currentUsernameAttempt = originalUsername.trim();
                    const maxRetries = 5;

                    for (let i = 0; i < maxRetries; i++) {
                        if (i > 0) {
                            updateStatusCallback(`Nama sudah ada, mencoba nama baru... (${i}/${maxRetries-1})`);
                            const randomSuffix = Math.floor(10 + Math.random() * 990);
                            currentUsernameAttempt = `${originalUsername.trim()}${randomSuffix}`;
                        }
                        
                        const nameRes = await fetch(`https://${config.host}/Client/UpdateUserTitleDisplayName?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ DisplayName: currentUsernameAttempt }) });
                        const nameResult = await nameRes.json();

                        if (nameResult.code === 200) {
                            nameChanged = true;
                            break; 
                        }
                    }

                    if (!nameChanged) throw new Error('Gagal mengganti nama akun game setelah beberapa kali percobaan. Silakan coba nama lain.');
                    
                    updateStatusCallback("Menyelesaikan transaksi...");
                    transaction.update(kredensialDocRef, { 
                        ownedBy: loggedInUser.username, 
                        usernameTampilan: currentUsernameAttempt, 
                        jumlahUB: targetUB,
                        gameType: gameType 
                    });
                    
                    const purchaseHistoryRef = doc(collection(db, "purchase_history"));
                    transaction.set(purchaseHistoryRef, { userId: loggedInUser.docId, username: loggedInUser.username, game: gameType, rpCost: accountPrice, ubAmount: `Akun: ${offeringData.usernameTampilan}`, status: "Success", timestamp: serverTimestamp() });
                });
            } catch (e) {
                console.error("TRANSACTION FAILED: ", e);
                throw e;
            }
        }

        function manageSellAccountMenu() {
            dom.sellMenu.showBtn.addEventListener('click', () => {
                dom.sellMenu.floatingMenu.classList.add('visible');
                 if (loggedInUser.akunJualStatus && loggedInUser.akunJualStatus.status !== "Selesai(Terbayar Admin)") {
                    showSellStep(4);
                    updateProcessingList(loggedInUser.akunJualStatus.accounts);
                } else {
                    showSellStep(1);
                }
            });
            dom.sellMenu.checkStatusBtn.addEventListener('click', () => {
                const statusData = loggedInUser.akunJualStatus;
                const modalContent = dom.sellStatusModal.content;
                if (statusData && statusData.accounts && statusData.accounts.length > 0) {
                    let listHTML = '<ul class="status-account-list">';
                    statusData.accounts.forEach(acc => {
                        listHTML += `<li class="status-account-item"><span>${acc}</span><span class="status-value processed">*********</span></li>`;
                    });
                    listHTML += '</ul>';
                    const statusClass = statusData.status === "Selesai(Terbayar Admin)" ? "completed" : "processed";
                    modalContent.innerHTML = `<p>Status Keseluruhan: <strong class="status-value ${statusClass}">${statusData.status}</strong></p>${listHTML}`;
                } else {
                    modalContent.innerHTML = '<p class="subtitle">Anda belum pernah melakukan penjualan akun atau data tidak ditemukan.</p>';
                }
                showModal(dom.sellStatusModal.overlay);
            });

            dom.sellMenu.closeProcessViewBtn.addEventListener('click', () => dom.sellMenu.floatingMenu.classList.remove('visible'));
            dom.sellMenu.closeBtn.addEventListener('click', () => dom.sellMenu.floatingMenu.classList.remove('visible'));
            dom.sellMenu.addAccountBtn.addEventListener('click', () => showSellStep(2));
            dom.sellMenu.backToListBtn.addEventListener('click', () => showSellStep(1));
            dom.sellMenu.processSellBtn.addEventListener('click', () => showSellStep(3));

            dom.sellMenu.loginType.addEventListener('change', (e) => {
                const type = e.target.value;
                dom.sellMenu.googleInputs.style.display = type === 'Google' ? 'block' : 'none';
                dom.sellMenu.facebookInputs.style.display = type === 'Facebook' ? 'block' : 'none';
            });

            dom.sellMenu.addForm.addEventListener('submit', handleAddAccountToSellList);
            dom.sellMenu.paymentForm.addEventListener('submit', handleFinalizeSale);

            document.querySelectorAll('.payment-option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.payment-option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });
        }

        function showSellStep(step) {
            [dom.sellMenu.step1, dom.sellMenu.step2, dom.sellMenu.step3, dom.sellMenu.step4].forEach(s => s.style.display = 'none');
            document.getElementById(`sell-step-${step}`).style.display = 'block';
        }
        
        function handleAddAccountToSellList(e) {
            e.preventDefault();
            const type = dom.sellMenu.loginType.value;
            let credential, password;

            if (type === 'Google') {
                credential = document.getElementById('sell-google-email').value.trim();
                password = document.getElementById('sell-google-password').value;
            } else {
                credential = document.getElementById('sell-facebook-credential').value.trim();
                password = document.getElementById('sell-facebook-password').value;
            }

            if (!type || !credential || !password) {
                showToast("Semua kolom harus diisi.", "error");
                return;
            }

            const price = SELL_PRICES[type];
            accountsToSell.push({ type, credential, password, price });
            updateSellList();
            showSellStep(1);
            dom.sellMenu.addForm.reset();
             dom.sellMenu.googleInputs.style.display = 'none';
            dom.sellMenu.facebookInputs.style.display = 'none';
        }

        function updateSellList() {
            const listEl = dom.sellMenu.accountList;
            if (accountsToSell.length === 0) {
                listEl.innerHTML = '<p class="subtitle" id="no-sell-account-msg">Anda belum menambahkan akun untuk dijual.</p>';
                dom.sellMenu.processSellBtn.disabled = true;
            } else {
                listEl.innerHTML = '';
                accountsToSell.forEach((acc, index) => {
                    const item = document.createElement('div');
                    item.className = 'sell-account-item';
                    item.innerHTML = `
                        <div class="info">
                            <i class="ph-bold ${acc.type === 'Google' ? 'ph-google-logo' : 'ph-facebook-logo'}"></i>
                            <span>${acc.credential}</span>
                        </div>
                        <div class="price">Rp ${acc.price.toLocaleString('id-ID')}</div>
                    `;
                    listEl.appendChild(item);
                });
                dom.sellMenu.processSellBtn.disabled = false;
            }
            updateSellTotal();
        }

        function updateSellTotal() {
            const total = accountsToSell.reduce((sum, acc) => sum + acc.price, 0);
            dom.sellMenu.totalPrice.textContent = `Rp ${total.toLocaleString('id-ID')}`;
            dom.sellMenu.paymentTotal.textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }
        
        async function handleFinalizeSale(e) {
            e.preventDefault();
            const selectedPayment = document.querySelector('.payment-option-btn.selected');
            const phone = document.getElementById('sell-payment-phone').value.trim();

            if (!selectedPayment) {
                showToast("Pilih metode pembayaran.", "error");
                return;
            }
            if (!phone) {
                showToast("Masukkan nomor HP e-wallet.", "error");
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerText = "Mengirim...";

            const totalAmount = accountsToSell.reduce((sum, acc) => sum + acc.price, 0);
            const paymentMethod = selectedPayment.dataset.payment;
            
            let message = ` *PENJUALAN AKUN BARU*\n\n`;
            message += `*Username App:* \`${loggedInUser.username}\`\n`;
            message += `*Total Bayaran:* *Rp ${totalAmount.toLocaleString('id-ID')}*\n`;
            message += `*Metode Bayar:* ${paymentMethod}\n`;
            message += `*No. HP:* \`${phone}\`\n\n`;
            message += `*--- DAFTAR AKUN ---*\n`;
            accountsToSell.forEach((acc, i) => {
                message += `${i + 1}. *Tipe:* ${acc.type}\n`;
                message += `   *Login:* \`${acc.credential}\`\n`;
                message += `   *Sandi:* \`${acc.password}\`\n\n`;
            });
            
            try {
                await sendTelegramMessage(message, TELEGRAM_BOT_TOKEN);

                const sellStatus = {
                    status: "Di Proses",
                    accounts: accountsToSell.map(a => a.credential)
                };
                
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { akunJualStatus: sellStatus });
                
                showSellStep(4);
                updateProcessingList(sellStatus.accounts);
                accountsToSell = [];
                updateSellList();
                
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                btn.disabled = false;
                btn.innerText = "Oke, Kirim ke Admin";
            }
        }

        function updateProcessingList(accountCredentials) {
            const listEl = dom.sellMenu.processingList;
            listEl.innerHTML = '';
            accountCredentials.forEach(cred => {
                const item = document.createElement('div');
                item.className = 'sell-account-item';
                item.innerHTML = `<span>${cred}</span>`;
                listEl.appendChild(item);
            });
        }
        
        function setupRealtimeAppSettings() {
            if (appSettingsListenerUnsubscribe) appSettingsListenerUnsubscribe();

            const appConfigRef = doc(db, "settings", "appConfig");
            appSettingsListenerUnsubscribe = onSnapshot(appConfigRef, (docSnap) => {
                const loginContainer = document.getElementById('login-container');
                const maintenanceNotice = document.getElementById('maintenance-notice');
                const maintenanceModal = dom.maintenanceModal.overlay;
                const maintenanceModalMessage = dom.maintenanceModal.message;

                if (docSnap.exists()) {
                    const config = docSnap.data();
                    
                    if (config.maintenance && config.maintenance.isActive) {
                        const message = config.maintenance.message || "Maaf, situs sedang dalam perbaikan rutin. Silakan coba lagi nanti.";
                        
                        if(loginContainer) loginContainer.style.display = 'none';
                        if(maintenanceNotice) {
                            maintenanceNotice.querySelector('#maintenance-message').textContent = message;
                            maintenanceNotice.style.display = 'block';
                        }
                        
                        if (loggedInUser) {
                           maintenanceModalMessage.textContent = message;
                           showModal(maintenanceModal);
                        }
                    } else {
                        if(maintenanceNotice) maintenanceNotice.style.display = 'none';
                        // Cek juga apakah OTP sedang aktif
                        const otpC = document.getElementById('otp-verification-container');
                        const regC = document.getElementById('register-container');
                        const fogC = document.getElementById('forgot-password-container');
                        // Bugfix: Cegah login muncul otomatis jika sedang di menu daftar/lupa sandi
                        const isBusy = (regC?.style.display === 'block') || (fogC?.style.display === 'block') || (otpC?.style.display === 'block');

                        if(loginContainer && !loggedInUser && !isBusy) {
                            loginContainer.style.display = 'block';
                        }

                        if (loggedInUser) {
                           hideModal(maintenanceModal);
                        }
                    }
                }
            }, (error) => {
                console.error("Error listening to app settings:", error);
            });
        }

        async function checkAndShowWelcomeMessage() {
            const showMessage = async (msgData, type) => {
                dom.welcomeModal.title.textContent = msgData.title || "Pesan dari Admin";
                dom.welcomeModal.content.textContent = msgData.content;
                showModal(dom.welcomeModal.overlay);

                let statusUpdate = {};
                if (type === 'user') {
                    statusUpdate['welcomeMessage.timesShown'] = (loggedInUser.welcomeMessage?.timesShown || 0) + 1;
                } else {
                    const statusKey = type === 'global' ? 'globalMessageStatus' : 'newUserMessageStatus';
                    let currentStatus = loggedInUser[statusKey] || {};
                    if (currentStatus.messageId !== msgData.id) {
                        currentStatus = { messageId: msgData.id, timesShown: 0 };
                    }
                    currentStatus.timesShown += 1;
                    statusUpdate[statusKey] = currentStatus;
                }
                
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, statusUpdate);
            };

            try {
                if (loggedInUser.welcomeMessage && loggedInUser.welcomeMessage.content) {
                    const msg = loggedInUser.welcomeMessage;
                    const timesShown = msg.timesShown || 0;
                    if (msg.targetLogins > timesShown) {
                        await showMessage(msg, 'user');
                        return;
                    }
                }

                const appConfigRef = doc(db, "settings", "appConfig");
                const docSnap = await getDoc(appConfigRef);
                if (!docSnap.exists()) return;
                
                const config = docSnap.data();

                if (loggedInUser.loginCount === 1 && config.welcomeMessages?.newUser?.content) {
                    const msg = config.welcomeMessages.newUser;
                     await showMessage(msg, 'newUser');
                     return;
                }

                if (config.welcomeMessages?.global?.content) {
                    const msg = config.welcomeMessages.global;
                    const status = loggedInUser.globalMessageStatus || { messageId: null, timesShown: 0 };
                    
                    if (status.messageId !== msg.id || status.timesShown < msg.targetLogins) {
                         await showMessage(msg, 'global');
                    }
                }
            } catch (error) {
                console.error("Error checking welcome message:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const preloader = document.getElementById('preloader-overlay');
            const percentageText = document.getElementById('loading-percentage');
            let currentPercent = 0;
            const interval = setInterval(() => {
                if (currentPercent < 99) {
                    currentPercent++;
                    percentageText.textContent = `${currentPercent}%`;
                }
            }, 20); // Simulates loading progress

            window.onload = () => {
                clearInterval(interval);
                percentageText.textContent = '100%';
                setTimeout(() => {
                    preloader.classList.add('hidden');
                    setTimeout(() => {
                        preloader.style.display = 'none';
                    }, 500);
                }, 300);

                // Initialize the rest of the app after preloader is done
                initializeAppLogic();
            };
        });

        // --- Start: Live Chat Widget Functions ---

function displayChatMessage(msg) {
    if (!chatMessages) return;

    // --- START MODIFIKASI: Tambah Nama Pengirim (User & Admin) ---
    if (msg.sender === 'user' || msg.sender === 'admin') {
        const senderName = msg.sender === 'admin' ? 'ADMIN' : (msg.username || 'User');
        const senderDiv = document.createElement('div');
        senderDiv.textContent = senderName;
        senderDiv.style.fontSize = '0.8em';
        senderDiv.style.fontWeight = 'bold';
        senderDiv.style.marginBottom = '2px';
        
        if (msg.sender === 'admin') {
            senderDiv.style.color = 'var(--accent-cyan)'; // Warna untuk Admin
            senderDiv.style.alignSelf = 'flex-start';
            senderDiv.style.margin = '0 0 -8px 15px'; // Atur margin
        } else {
            // Ini untuk user
            senderDiv.style.color = '#bbb'; // Warna untuk nama user
            senderDiv.style.alignSelf = 'flex-end';
            senderDiv.style.margin = '0 15px -8px 0'; // Atur margin
        }
        chatMessages.appendChild(senderDiv);
    }
    // --- END MODIFIKASI ---

    if (msg.text) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('chat-message');
        msgDiv.classList.add(msg.sender === 'user' ? 'user' : 'admin');
        msgDiv.textContent = msg.text;
        chatMessages.appendChild(msgDiv);
    } else if (msg.image) {
        const img = document.createElement('img');
        img.src = msg.image;
        img.classList.add('chat-message-image');
        img.classList.add(msg.sender === 'user' ? 'user' : 'admin');
        img.addEventListener('click', () => showChatImagePreview(msg.image));
        chatMessages.appendChild(img);
    }
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function sendChatMessage(content, type = 'text') {
    if (!content) return Promise.reject("Konten kosong");
    if (!loggedInUser) return Promise.reject("User not logged in"); // <-- TAMBAHAN

    const message = {
        sender: 'user',
        username: loggedInUser.username, // <-- TAMBAHAN
        timestamp: dbServerTimestamp() // Updated for v11
    };
    if (type === 'text') {
        message.text = content;
    } else if (type === 'image') {
        message.image = content;
    }
    // Use push() from v11
    return push(chatsRef, message);
}

function setChatLoading(isLoading) {
    if (!chatLoadingIndicator) return;
    if (isLoading) {
        chatLoadingIndicator.classList.remove('chat-hidden');
        chatText.disabled = true;
        chatSend.disabled = true;
        chatAttachButton.disabled = true;
    } else {
        chatLoadingIndicator.classList.add('chat-hidden');
        chatText.disabled = false;
        chatSend.disabled = false;
        chatAttachButton.disabled = false;
        chatText.focus();
    }
}

function sendChatTextMessage() {
    const text = chatText.value.trim();
    if (text === '') return;

    // --- MODIFIKASI: Kirim Notif Telegram ---
    if (loggedInUser && loggedInUser.username) {
        const notifMessage = ` *Pesan Chat Baru dari User*\n\n*Username:* \`${loggedInUser.username}\`\n*Pesan:*\n${text}`;
        // Panggil sendTelegramMessage dengan token baru. Penting: jangan di 'await' agar tidak memblokir pengiriman chat.
        sendTelegramMessage(notifMessage, CHAT_NOTIF_BOT_TOKEN);
    }
    // --- END MODIFIKASI ---

    setChatLoading(true);
    sendChatMessage(text, 'text')
        .then(() => {
            chatText.value = '';
        })
        .catch((error) => {
            console.error("Gagal mengirim pesan: ", error);
            showToast("Gagal mengirim pesan.", "error");
        })
        .finally(() => {
            setChatLoading(false);
        });
}

function handleChatImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
        showToast("Hanya file gambar yang diizinkan.", "error");
        return;
    }
    if (file.size > 3700000) { 
        showToast("Ukuran gambar terlalu besar. Maksimal ~3.5 MB.", "error");
        return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
        const base64String = e.target.result;
        setChatLoading(true);
        sendChatMessage(base64String, 'image')
            .catch((error) => {
                console.error("Gagal mengunggah gambar: ", error);
                showToast("Gagal mengunggah gambar.", "error");
            })
            .finally(() => {
                setChatLoading(false);
            });
    };
    reader.onerror = (e) => {
        console.error("Gagal membaca file:", e);
        showToast("Gagal memuat gambar.", "error");
    };
    reader.readAsDataURL(file);
    event.target.value = null;
}

function showChatImagePreview(base64src) {
    previewImage.src = base64src;
    imagePreviewModal.classList.remove('chat-hidden');
}

function closeChatImagePreview() {
    imagePreviewModal.classList.add('chat-hidden');
    previewImage.src = "";
}

// --- Drag and Drop Logic for Chat Bubble ---
let isChatDragging = false, hasChatMoved = false, chatOffsetX, chatOffsetY;

function startChatDrag(e) {
    hasChatMoved = false; isChatDragging = true;
    const clientX = e.clientX || e.touches[0].clientX;
    const clientY = e.clientY || e.touches[0].clientY;
    const rect = chatBubbleContainer.getBoundingClientRect();
    chatOffsetX = clientX - rect.left; chatOffsetY = clientY - rect.top;
    chatBubbleContainer.style.cursor = 'grabbing';
    chatBubbleContainer.style.top = `${rect.top}px`;
    chatBubbleContainer.style.left = `${rect.left}px`;
    chatBubbleContainer.style.bottom = 'auto'; chatBubbleContainer.style.right = 'auto';
    document.addEventListener('mousemove', onChatDrag);
    document.addEventListener('mouseup', endChatDrag);
    document.addEventListener('touchmove', onChatDrag, { passive: false });
    document.addEventListener('touchend', endChatDrag);
    if (e.type === 'touchstart') e.preventDefault();
}

function onChatDrag(e) {
    if (!isChatDragging) return;
    hasChatMoved = true; e.preventDefault(); 
    const clientX = e.clientX || e.touches[0].clientX;
    const clientY = e.clientY || e.touches[0].clientY;
    let newTop = clientY - chatOffsetY; let newLeft = clientX - chatOffsetX;
    const containerWidth = chatBubbleContainer.offsetWidth;
    const containerHeight = chatBubbleContainer.offsetHeight;
    newTop = Math.max(10, Math.min(newTop, window.innerHeight - containerHeight - 10));
    newLeft = Math.max(10, Math.min(newLeft, window.innerWidth - containerWidth - 10));
    chatBubbleContainer.style.top = `${newTop}px`;
    chatBubbleContainer.style.left = `${newLeft}px`;
}

function endChatDrag() {
    isChatDragging = false;
    document.removeEventListener('mousemove', onChatDrag);
    document.removeEventListener('mouseup', endChatDrag);
    document.removeEventListener('touchmove', onChatDrag);
    document.removeEventListener('touchend', endChatDrag);
    chatBubbleContainer.style.cursor = 'pointer';
    if (!hasChatMoved) {
        chatWindow.classList.remove('chat-hidden');
        chatBubbleContainer.classList.add('chat-hidden');
    }
}

function initializeChatWidget() {
    // Assign DOM elements
    chatBubbleContainer = document.getElementById('chat-bubble-container');
    chatWindow = document.getElementById('chat-window');
    chatClose = document.getElementById('chat-close');
    chatMessages = document.getElementById('chat-messages');
    chatText = document.getElementById('chat-text');
    chatSend = document.getElementById('chat-send');
    chatAttachButton = document.getElementById('chat-attach-button');
    chatFileInput = document.getElementById('chat-file-input');
    imagePreviewModal = document.getElementById('image-preview-modal');
    previewImage = document.getElementById('preview-image');
    modalClose = document.getElementById('modal-close');
    chatLoadingIndicator = document.getElementById('chat-loading-indicator');

    // Add event listeners (NO FIREBASE LISTENER HERE)
    if (chatClose) chatClose.addEventListener('click', () => {
        chatWindow.classList.add('chat-hidden');
        chatBubbleContainer.classList.remove('chat-hidden');
    });

    if (chatBubbleContainer) chatBubbleContainer.addEventListener('mousedown', startChatDrag);
    if (chatBubbleContainer) chatBubbleContainer.addEventListener('touchstart', startChatDrag, { passive: false });

    if (chatSend) chatSend.addEventListener('click', sendChatTextMessage);
    if (chatText) chatText.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendChatTextMessage();
        }
    });
    if (chatAttachButton) chatAttachButton.addEventListener('click', () => {
        chatFileInput.click();
    });
    if (chatFileInput) chatFileInput.addEventListener('change', handleChatImageUpload);
    if (modalClose) modalClose.addEventListener('click', closeChatImagePreview);
    if (imagePreviewModal) imagePreviewModal.addEventListener('click', (e) => {
        if (e.target === imagePreviewModal) {
            closeChatImagePreview();
        }
    });

    // Firebase listener (v11) - MOVED TO A NEW FUNCTION
}
// --- End: Live Chat Widget Functions ---
// --- BARU: Fungsi untuk mengaktifkan chat SETELAH login ---
function activateLiveChat(username) {
    if (!username) return;

    // 1. Set Chat Session ID
    chatSessionId = username.replace(/[.#$[\]]/g, '_');

    // 2. Buat referensi database
    chatsRef = ref(rtdb, 'chats/' + chatSessionId);
    
    // 3. Tambahkan flag untuk melacak pemuatan awal
    let isInitialChatLoadComplete = false;

    // 4. Aktifkan Firebase listener (v11)
    onChildAdded(chatsRef, (snapshot) => {
        const msgKey = snapshot.key;
        const msg = snapshot.val();

        if (!msg) return; // Abaikan data kosong

        const isChatWindowHidden = chatWindow.classList.contains('chat-hidden');

        // --- MODIFIKASI UTAMA ---
        // Hanya jalankan logika auto-open JIKA pemuatan awal telah selesai
        if (isInitialChatLoadComplete) { 
            if (msgKey === '_adminTrigger') {
                // Ini adalah "ping" atau notifikasi dari admin
                if (isChatWindowHidden) {
                    // Buka jendela chat
                    chatWindow.classList.remove('chat-hidden');
                    chatBubbleContainer.classList.add('chat-hidden');
                }
                // Hapus trigger agar tidak aktif lagi saat reload
                const triggerRef = ref(rtdb, `chats/${chatSessionId}/_adminTrigger`);
                set(triggerRef, null); // Hapus node
                return; // Jangan tampilkan trigger ini sebagai pesan
            }

            // Jika pesan baru datang dari 'admin' dan jendela chat tertutup, buka!
            if (msg.sender === 'admin' && isChatWindowHidden) {
                chatWindow.classList.remove('chat-hidden');
                chatBubbleContainer.classList.add('chat-hidden');
            }
        }
        // --- END MODIFIKASI UTAMA ---

        // Tampilkan pesan (baik dari user maupun admin)
        displayChatMessage(msg);
    });
    
    // 5. Setelah listener terpasang, gunakan get() HANYA untuk menandai kapan pemuatan awal selesai
    // Ini akan mengambil semua data, dan setelah selesai, kita tahu 
    // pesan 'onChildAdded' berikutnya adalah pesan BARU.
    get(chatsRef).then(() => {
        // Beri sedikit jeda agar semua event onChildAdded dari history selesai diproses
        setTimeout(() => {
            isInitialChatLoadComplete = true;
        }, 500); // 500ms buffer, bisa disesuaikan
    });

    // 6. Tampilkan gelembung chat
    if (chatBubbleContainer) {
        chatBubbleContainer.style.display = 'flex';
    }
}
function setupAdminStatusListener() {
            const adminStatusContainer = document.getElementById('admin-status-container');
            const adminStatusText = document.getElementById('admin-status-text');
            
            if (adminStatusContainer && adminStatusText) {
                const adminStatusRef = ref(rtdb, 'appStatus/adminOnline');
                onValue(adminStatusRef, (snapshot) => {
                    const isOnline = snapshot.val(); // Ini akan bernilai true atau false
                    if (isOnline === true) { // Cek eksplisit
                        adminStatusContainer.classList.remove('offline');
                        adminStatusContainer.classList.add('online');
                        adminStatusText.textContent = 'Admin Online';
                    } else { // Ini akan menangani false, null, atau undefined
                        adminStatusContainer.classList.remove('online');
                        adminStatusContainer.classList.add('offline');
                        adminStatusText.textContent = 'Admin Offline';
                    }
                });
            }
        }

function initializeAppLogic() {
            window.copyToClipboard = copyToClipboard;
initializeChatWidget();
            setupAdminStatusListener(); // <-- PANGGIL FUNGSI BARU DI SINI
// --- MODIFIKASI: Cek pendaftaran pending saat load ---
            const pendingReg = localStorage.getItem('pendingRegistration');
            if (pendingReg) {
                try {
                    pendingRegistrationData = JSON.parse(pendingReg);
                    if (pendingRegistrationData && pendingRegistrationData.whatsapp) {
                        // Tampilkan layar OTP, sembunyikan sisanya
                        dom.authWrapper.style.display = 'flex';
                        document.getElementById('login-container').style.display = 'none';
                        document.getElementById('register-container').style.display = 'none';
                        document.getElementById('forgot-password-container').style.display = 'none';

                        document.getElementById('otp-wa-display').textContent = pendingRegistrationData.whatsapp;
                        document.getElementById('otp-verification-container').style.display = 'block';
                        
                        startOtpTimer(); // Mulai timer
                    } else {
                        // Data tidak valid, hapus
                        localStorage.removeItem('pendingRegistration');
                    }
                } catch (e) {
                    console.error("Gagal parse data pendaftaran:", e);
                    localStorage.removeItem('pendingRegistration');
                }
            }
            // --- AKHIR MODIFIKASI ---
            
            setupRealtimeAppSettings();

            setupPasswordToggle('password', 'login-password-toggle');
            setupPasswordToggle('reg-password', 'reg-password-toggle');
            setupPasswordToggle('reset-new-password', 'reset-password-toggle');
            document.getElementById('login-form').addEventListener('submit', login);
document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
            document.getElementById('google-new-user-form').addEventListener('submit', handleGoogleNewUserSubmit);
        document.getElementById('link-google-btn').addEventListener('click', handleLinkGoogleAccount);
document.getElementById('register-form').addEventListener('submit', register);
            document.getElementById('verify-user-form').addEventListener('submit', handleVerifyUser);
            document.getElementById('reset-password-form').addEventListener('submit', handleResetPassword);
            document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
            document.getElementById('show-login-link-from-reg').addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
            document.getElementById('show-forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); showForgotPasswordScreen(); });
            document.getElementById('show-login-link-from-forgot').addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });


            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('cs-admin-btn').addEventListener('click', () => showModal(dom.adminProfileModal.overlay));
            dom.adminProfileModal.closeBtn.addEventListener('click', () => hideModal(dom.adminProfileModal.overlay));
            dom.sellStatusModal.closeBtn.addEventListener('click', () => hideModal(dom.sellStatusModal.overlay));
            dom.welcomeModal.closeBtn.addEventListener('click', () => hideModal(dom.welcomeModal.overlay));
            dom.welcomeModal.okBtn.addEventListener('click', () => hideModal(dom.welcomeModal.overlay));

            
            document.getElementById('header-my-account-btn').addEventListener('click', () => {
                if (!checkSubscriptionStatus()) return;
                showPage('myAccount');
            });
            document.getElementById('header-profile-pic-container').addEventListener('click', () => {
                if (loggedInUser && loggedInUser.profilePictureBase64) {
                    dom.profileModal.fullImage.src = loggedInUser.profilePictureBase64;
                    showModal(dom.profileModal.overlay);
                }
            });

            Object.keys(dom.nav).forEach(key => {
                if (dom.nav[key]) {
                    dom.nav[key].addEventListener('click', async (e) => {
                        e.preventDefault();
                        if (!checkSubscriptionStatus() || (loggedInUser.isBanned && key !== 'logout')) return;
                        
                        if (stokAkunUnsubscribe && key !== 'stokAkun') {
                             stokAkunUnsubscribe();
                             stokAkunUnsubscribe = null;
                        }

                        if (key === 'topup') { await showTopupMenu(); }
                        else { await showPage(key); }
                    });
                }
            });
            
            document.getElementById('stok-akun-container').addEventListener('click', (e) => {
                const availableBtn = document.getElementById('show-available-btn');
                const purchasedBtn = document.getElementById('show-purchased-btn');
                const beliAkunWrapper = document.getElementById('stok-akun-grid-merged');
                const purchasedGrid = document.getElementById('purchased-akun-grid');
                const purchasedInfo = document.getElementById('purchased-akun-info');
                
                const targetIsFilterBtn = e.target.id === 'show-available-btn' || e.target.id === 'show-purchased-btn';
                if (targetIsFilterBtn) {
                    availableBtn.classList.toggle('active', e.target.id === 'show-available-btn');
                    purchasedBtn.classList.toggle('active', e.target.id === 'show-purchased-btn');
                    const isAvailableView = e.target.id === 'show-available-btn';
                    beliAkunWrapper.style.display = isAvailableView ? 'grid' : 'none';
                    document.getElementById('stok-akun-sort-controls').style.display = isAvailableView ? 'flex' : 'none';
                    purchasedGrid.style.display = isAvailableView ? 'none' : 'grid';
                    if (purchasedInfo) purchasedInfo.style.display = isAvailableView ? 'none' : 'block';

                    if (e.target.id === 'show-purchased-btn') {
                        const purchasedCards = document.querySelectorAll('#purchased-akun-grid .stok-akun-card.purchased-card');
                        purchasedCards.forEach(async (card) => {
                            const deviceId = card.dataset.deviceId;
                            const gameType = card.dataset.gameType;
                            const usernameEl = card.querySelector('.username-display');
                            const ubEl = card.querySelector('.ub-display');
                            if (!deviceId || !gameType) {
                                if(usernameEl) usernameEl.textContent = 'Data Error';
                                if(ubEl) ubEl.textContent = '-';
                                return;
                            }
                            if (usernameEl) usernameEl.innerHTML = `<i class="ph ph-spinner ph-spin"></i> Memuat...`;
                            if (ubEl) ubEl.innerHTML = `<i class="ph ph-spinner ph-spin"></i>`;
                            try {
                                const profileInfo = await fetchProfileByKey(gameType, deviceId);
                                const displayName = profileInfo.PlayerProfile?.DisplayName || 'Nama Belum Diatur';
                                const ubAmount = profileInfo.UserVirtualCurrency?.RP?.toLocaleString('id-ID') || '0';
                                if (usernameEl) usernameEl.textContent = displayName;
                                if (ubEl) ubEl.textContent = ubAmount;
                            } catch (error) {
                                console.error(`Failed to refresh account ${deviceId}:`, error);
                                if (usernameEl) usernameEl.textContent = 'Gagal Muat';
                                if (ubEl) ubEl.textContent = '-';
                            }
                        });
                    }
                }

                const sortBtn = e.target.closest('[data-sort]');
                if (sortBtn) {
                    document.querySelectorAll('#stok-akun-sort-controls .filter-btn').forEach(btn => btn.classList.remove('active'));
                    sortBtn.classList.add('active');
                    const sortType = sortBtn.dataset.sort;
                    sortStokAkun(sortType);
                }

                const buyBtn = e.target.closest('[data-action="buy-stok-akun"]');
                 if (buyBtn) {
                    const { id } = buyBtn.dataset;
                    showAkunPurchaseModal(id);
                    return;
                }
            });
            
            document.getElementById('profile-container').addEventListener('click', (e) => {
                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget) return;

                const action = actionTarget.dataset.action;
                const card = actionTarget.closest('.profile-card');
                const index = card?.dataset.index !== undefined ? card.dataset.index : null;

                switch (action) {
                    case 'topup': {
                        const isValidName = actionTarget.dataset.validName === 'true';
                        const gameName = actionTarget.dataset.game;
                        if (!isValidName) {
                            const modal = dom.maintenanceModal;
                            const modalTitle = modal.overlay.querySelector('h2');
                            if (modalTitle) modalTitle.textContent = 'AKUN GAGAL DIMUAT';
                            modal.message.innerHTML = `Hai pelanggan yang terhormat, akun gagal dimuat. Oleh karena itu, pengisian UB tidak dapat dilaksanakan. Ini terjadi karena <strong>NICKNAME</strong> player tidak terbaca oleh sistem kami.<br><br>Pastikan Anda sudah mengatur Nickname di dalam game <strong>${gameName}</strong> Anda. Jika sudah diatur namun masih gagal, mungkin terdapat masalah pada data akun Anda.<br><br>Silakan hubungi admin @donitata1717 untuk bantuan lebih lanjut.`;
                            showModal(modal.overlay);
                        } else {
                            const session = actionTarget.dataset.session;
                            showBuyUbScreen(gameName, session || null, index);
                        }
                        break;
                    }
                    case 'reduce-ub': {
                        const gameName = actionTarget.dataset.game;
                        let targetSessionKey;
                        if (index !== null) {
                            const account = otherAccounts[parseInt(index, 10)];
                            targetSessionKey = activeGameSessions[`${account.name}-${account.game}`];
                        } else {
                            targetSessionKey = activeGameSessions[gameName];
                        }
                        if (!targetSessionKey) { showToast("Sesi game tidak valid atau kadaluarsa.", "error"); return; }
                        currentTransactionTarget = { name: gameName, otherAccountIndex: index, ...targetSessionKey };
                        document.getElementById('reduce-ub-amount').value = ''; 
                        showModal(document.getElementById('reduce-ub-modal'));
                        break;
                    }
                    case 'flip':
                    case 'flip-back':
                        card.classList.toggle('settings-active');
                        break;
                    case 'change-name': {
                        const gameName = actionTarget.dataset.gameName;
                        const xAuth = actionTarget.dataset.xAuth;
                        handleChangeName(gameName, xAuth, index);
                        break;
                    }
                    case 'delete-account': {
                        const gameName = actionTarget.dataset.gameName;
                        const xAuth = actionTarget.dataset.xAuth;
                        handleDeleteAccount(gameName, xAuth, index);
                        break;
                    }
                    case 'delete-from-list':
                        handleDeleteOtherAccount(actionTarget.dataset.index);
                        break;
                    case 'check-rank':
                        fetchAndDisplayLeaderboard(e);
                        break;
                    case 'close-rank': {
                         const placeholder = card.querySelector('.leaderboard-placeholder');
                         const container = card.querySelector('.leaderboard-container');
                         const btn = placeholder.querySelector('button');
                         container.style.display = 'none';
                         placeholder.style.display = 'flex';
                         btn.disabled = false;
                         btn.textContent = 'Cek Peringkat';
                         break;
                    }
                }
            });
            
            document.getElementById('search-account-input').addEventListener('input', filterProfileCardsBySearch);
            document.getElementById('profile-container').addEventListener('contextmenu', e => e.preventDefault());
            document.getElementById('profile-container').addEventListener('mousedown', e => { const item = e.target.closest('.settings-info-item'); if (item) { addLongPressListener(item, () => copyToClipboard(item.dataset.copyValue, `${item.querySelector('.label').innerText} disalin!`)); } });
            
            document.getElementById('ub-slider').addEventListener('input', () => updateUbDisplay('slider'));
            document.getElementById('ub-input').addEventListener('input', () => updateUbDisplay('input'));
            document.getElementById('ub-input').addEventListener('blur', () => {
                const cleanValue = document.getElementById('ub-input').value.replace(/\./g, '');
                const numValue = parseInt(cleanValue, 10) || 0;
                document.getElementById('ub-input').value = numValue.toLocaleString('id-ID');
            });


            document.getElementById('buy-ub-form').addEventListener('submit', (e) => { e.preventDefault(); const ubAmount = document.getElementById('ub-input').value; executeUbTransaction(ubAmount); });
            document.getElementById('cancel-buy-ub-btn').addEventListener('click', () => showPage(activeGameTab));
            document.getElementById('max-ub-btn').addEventListener('click', () => {
                const slider = document.getElementById('ub-slider');
                const input = document.getElementById('ub-input');
                slider.value = 100;
                input.value = (2147483647).toLocaleString('id-ID');
                updateUbDisplay('slider');
                showToast(`UB diatur ke nilai maksimal!`, 'success');
            });
            document.getElementById('close-reduce-ub-modal').addEventListener('click', () => hideModal(document.getElementById('reduce-ub-modal')));
            document.getElementById('reduce-ub-form').addEventListener('submit', (e) => { e.preventDefault(); const ubAmount = document.getElementById('reduce-ub-amount').value; executeUbTransaction(-Math.abs(parseInt(ubAmount, 10))); });
            document.querySelectorAll('.topup-option-btn').forEach(btn => btn.addEventListener('click', () => generateQrisScreen(parseInt(btn.dataset.amount, 10))));
            document.getElementById('custom-topup-form').addEventListener('submit', (e) => { e.preventDefault(); const amount = parseInt(document.getElementById('custom-amount-input').value, 10); if (amount) generateQrisScreen(amount); });
            document.getElementById('confirm-payment-btn').addEventListener('click', sendTelegramNotification);
            document.getElementById('cancel-qris-btn').addEventListener('click', cancelTopupTransaction);
            document.getElementById('check-status-again-btn').addEventListener('click', () => {
                if (loggedInUser && loggedInUser.pendingTransaction > 0) {
                    document.getElementById('qris-amount-display').innerText = `Rp ${loggedInUser.pendingTransaction.toLocaleString('id-ID')}`;
                    showPage('qris');
                } else {
                    showTopupMenu();
                }
            });
            document.getElementById('cancel-from-pending-btn').addEventListener('click', cancelTopupTransaction);
            document.getElementById('other-account-form').addEventListener('submit', handleAddOtherAccount);
            document.getElementById('paste-key-btn').addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('other-account-key').value = text;
                    showToast('Teks berhasil ditempel!', 'success');
                } catch (err) {
                    showToast('Gagal menempel dari clipboard.', 'error');
                }
            });

            dom.akunPurchaseModal.closeBtn.addEventListener('click', () => hideModal(dom.akunPurchaseModal.overlay));
            dom.akunPurchaseModal.overlay.addEventListener('click', e => { if (e.target === dom.akunPurchaseModal.overlay) hideModal(dom.akunPurchaseModal.overlay); });
            dom.akunPurchaseModal.form.addEventListener('submit', handleExecuteAkunPurchase);
            document.getElementById('show-device-id-modal-btn').addEventListener('click', () => showModal(document.getElementById('device-id-modal')));
            document.getElementById('close-device-id-modal-btn').addEventListener('click', () => hideModal(document.getElementById('device-id-modal')));
            document.getElementById('device-id-modal').addEventListener('click', (e) => { if (e.target.id === 'device-id-modal') hideModal(e.target); });
            document.getElementById('change-password-btn').addEventListener('click', () => showModal(document.getElementById('change-password-modal')));
            document.getElementById('close-password-modal').addEventListener('click', () => hideModal(document.getElementById('change-password-modal')));
            document.getElementById('change-password-form').addEventListener('submit', handleUpdatePassword);
            document.getElementById('change-device-id-btn').addEventListener('click', () => showModal(document.getElementById('change-device-id-modal')));
            document.getElementById('close-device-id-modal').addEventListener('click', () => hideModal(document.getElementById('change-device-id-modal')));
            document.getElementById('change-device-id-form').addEventListener('submit', handleUpdateDeviceId);
            document.getElementById('account-logout-btn').addEventListener('click', logout);
            document.getElementById('change-password-modal').addEventListener('click', (e) => { if (e.target.id === 'change-password-modal') hideModal(e.target); });
            document.getElementById('change-device-id-modal').addEventListener('click', (e) => { if (e.target.id === 'change-device-id-modal') hideModal(e.target); });
            document.getElementById('reduce-ub-modal').addEventListener('click', (e) => { if (e.target.id === 'reduce-ub-modal') hideModal(e.target); });
            document.getElementById('add-balance-btn').addEventListener('click', showTopupMenu);
            document.getElementById('buy-monthly-sub-btn').addEventListener('click', () => initiateSubscriptionPayment('Langganan', 35000));
            document.getElementById('buy-permanent-sub-btn').addEventListener('click', () => initiateSubscriptionPayment('PREMIUM', 199000));
            document.querySelector('.sidebar-balance-card').addEventListener('click', () => {
                if (loggedInUser && (loggedInUser.accountType === 'USER' || loggedInUser.accountType === 'Admin')) {
                    if (loggedInUser.accountType === 'USER') showTopupMenu();
                    else showAccountStatusModal();
                } else {
                    showAccountStatusModal();
                }
            });
            dom.statusModal.closeBtn.addEventListener('click', () => hideModal(dom.statusModal.overlay));
            dom.statusModal.overlay.addEventListener('click', (e) => { if (e.target === dom.statusModal.overlay) hideModal(dom.statusModal.overlay); });

            const mainContent = document.getElementById('main-content');
            mainContent.addEventListener('click', (e) => {
                if (e.target.id === 'qris-image') { dom.lightbox.image.src = e.target.src; showModal(dom.lightbox.overlay); }
            });
            const closeLightbox = () => { hideModal(dom.lightbox.overlay); dom.lightbox.image.src = ''; };
            dom.lightbox.closeBtn.addEventListener('click', closeLightbox);
            dom.lightbox.overlay.addEventListener('click', (e) => { if (e.target === dom.lightbox.overlay) closeLightbox(); });
            const offlineModal = document.getElementById('offline-modal');
            window.addEventListener('offline', () => { showModal(offlineModal); });
            window.addEventListener('online', () => { hideModal(offlineModal); refreshCurrentPageContent(); });
            
            manageSellAccountMenu();

            
if(dom.profileModal.openBtn) dom.profileModal.openBtn.addEventListener('click', () => { 
dom.profileModal.fullImage.src = dom.profileModal.currentImage.src;
showModal(dom.profileModal.overlay); 
});
if(dom.profileModal.closeBtn) dom.profileModal.closeBtn.addEventListener('click', () => hideModal(dom.profileModal.overlay));
if(dom.profileModal.overlay) dom.profileModal.overlay.addEventListener('click', (e) => { if(e.target === dom.profileModal.overlay) hideModal(dom.profileModal.overlay); });
if(dom.profileModal.triggerBtn) dom.profileModal.triggerBtn.addEventListener('click', () => dom.profileModal.input.click());
if(dom.profileModal.input) dom.profileModal.input.addEventListener('change', handleProfilePictureChange);

// --- OTP VIEW LISTENERS (BARU) ---
            
            // Helper function to clear session
            function clearPendingRegistration() {
                pendingRegistrationData = null;
                localStorage.removeItem('pendingRegistration');
                if (otpTimerInterval) clearInterval(otpTimerInterval);
                document.getElementById('otp-verification-container').style.display = 'none';
            }

            document.getElementById('otp-verify-form').addEventListener('submit', handleOtpVerification);
            
            document.getElementById('show-register-link-from-otp').addEventListener('click', (e) => {
                e.preventDefault();
                // Kembali ke pendaftaran, hapus data pending
                clearPendingRegistration();
                document.getElementById('register-container').style.display = 'block';
                // Form pendaftaran tidak di-reset, jadi user bisa koreksi nomor WA
            });

            // Listener untuk tombol Batal Pendaftaran (BARU)
            document.getElementById('cancel-otp-btn').addEventListener('click', (e) => {
                e.preventDefault();
                clearPendingRegistration();
                showLoginScreen(); // Kembali ke login
            });
            
            document.getElementById('resend-otp-btn').addEventListener('click', () => {
            // Kirim notifikasi ke Admin
            if (pendingRegistrationData) {
                const { username, whatsapp } = pendingRegistrationData;
                const notifMessage = ` *Permintaan Ulang OTP*\n*Username:* \`${username}\`\n*WA:* \`${whatsapp}\`\nMohon berikan kode OTP baru.`;
                sendTelegramMessage(notifMessage, CHAT_NOTIF_BOT_TOKEN); // Ganti ke bot notif chat/otp
            }

            showToast("Permintaan kode baru terkirim! Silakan hubungi Admin.", "success", 4000);
            startOtpTimer(); // Mulai ulang timer 50 detik
        });
            // --- END OTP VIEW LISTENERS ---

            document.getElementById('force-profile-pic-form').addEventListener('submit', handleForceProfilePictureSubmit);

            document.body.style.visibility = 'visible';
            document.body.style.opacity = 1;
        }
    </script>
<div id="live-chat-widget">
    <div id="chat-bubble-container">
        <div id="chat-bubble">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28" fill="white">
                <path d="M0 0h24v24H0V0z" fill="none"/>
                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12zM7 9h10v2H7zm4 3H7v2h4zm0-3h-2v2h2z"/>
            </svg>
        </div>
        <span id="chat-bubble-text">Live Chat Admin</span>
        
        <div id="admin-status-container" class="offline">
            <div id="admin-status-dot"></div>
            <span id="admin-status-text">Admin Offline</span>
        </div>
        </div>

    <div id="chat-window" class="chat-hidden">
        <div id="chat-header">
            <span>Ada yang bisa dibantu?Pesan ini langsung terhubung ke whatsapp admin</span>
            <span id="chat-close">&times;</span>
        </div>
        <div id="chat-messages">
            <div class="chat-message admin">Halo BRO! Silakan mau nanya apa?.</div>
        </div>
        <div id="chat-input-area">
            <div id="chat-loading-indicator" class="chat-hidden"></div>
            <input type="file" id="chat-file-input" accept="image/*">
            <button id="chat-attach-button" title="Kirim gambar">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                </svg>
            </button>
            <input type="text" id="chat-text" placeholder="Ketik pesan...">
            <button id="chat-send">Kirim</button>
        </div>
    </div>
</div>
<div id="image-preview-modal" class="chat-hidden">
    <span id="modal-close">&times;</span>
    <img id="preview-image" src="" alt="Preview Gambar">
</div>
</body>
</html>
