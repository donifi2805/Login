<!DOCTYPE html>
<html lang=id>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#111827">
<title>Maleo SHOP</title>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel=stylesheet>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel=stylesheet>
<script src=https://unpkg.com/@phosphor-icons/web></script>
<style>:root{--bg-primary:#111827;--bg-secondary:#1f2937;--bg-tertiary:#374151;--border-color:#4b5563;--text-primary:#f9fafb;--text-secondary:#d1d5db;--accent-blue:#3b82f6;--accent-green:#22c55e;--accent-red:#ef4444;--accent-cyan:#06b6d4;--premium-gold:#fbbf24}*{margin:0;padding:0;box-sizing:border-box}html,body{font-family:'Inter',sans-serif;background-color:var(--bg-primary);color:var(--text-primary);-webkit-user-select:none;user-select:none;font-size:12px}#app-layout{display:none;flex-direction:column;min-height:100vh;width:100%}#top-navbar{display:flex;flex-direction:column;align-items:stretch;padding:6px 10px;background:var(--bg-primary);border-bottom:1px solid var(--border-color);position:sticky;top:0;z-index:1001;gap:8px}.header-top-row{display:flex;justify-content:space-between;align-items:center;width:100%}#top-navbar h1{font-size:1.2em;font-weight:800;color:var(--text-primary);line-height:1}.subtitle-brand{display:block;font-size:.4em;font-weight:500;color:var(--text-secondary);margin-top:2px}.header-actions{display:flex;align-items:center;gap:8px}.sidebar-balance-card{display:flex;align-items:center;gap:6px;background-color:var(--bg-secondary);padding:4px 6px;border-radius:6px;border:1px solid var(--border-color);cursor:pointer;transition:all .2s ease}.sidebar-balance-card:hover{border-color:var(--accent-blue)}.balance-info{text-align:left}.sidebar-balance-card .balance-label{display:block;font-size:.7em;color:var(--text-secondary);line-height:1.1}.sidebar-balance-card .balance-amount{display:block;font-size:.9em;font-weight:700;color:var(--accent-green);line-height:1.2}.sidebar-balance-card .balance-amount.premium,.sidebar-balance-card .balance-amount.subscription{color:var(--premium-gold);font-size:.85em}.add-balance-icon{font-size:1.3em;color:var(--accent-green);cursor:pointer;transition:transform .2s;display:flex;align-items:center;justify-content:center}.add-balance-icon:hover{transform:scale(1.1)}#header-my-account-btn,#logout-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:6px!important;font-size:.8em!important;line-height:1;background-color:var(--bg-tertiary);width:32px;height:32px}#header-my-account-btn:hover{background-color:var(--accent-blue)}#logout-btn:hover{background-color:var(--accent-red)}#header-my-account-btn i,#logout-btn i{font-size:1.3em}.logout-text{display:none}#top-navbar nav{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}#top-navbar nav::-webkit-scrollbar{display:none}.sidebar-nav{display:flex;justify-content:space-between;gap:4px;list-style:none;padding:0;flex-wrap:nowrap}.nav-item a{display:flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:6px;color:var(--text-secondary);text-decoration:none;font-weight:600;font-size:.85em;white-space:nowrap;transition:all .3s ease-in-out;background-color:var(--bg-secondary);border:1px solid var(--border-color)}.nav-item a:hover{color:var(--text-primary);border-color:var(--accent-blue)}.nav-item a.active{background-color:var(--accent-blue);color:white;font-weight:700;border-color:var(--accent-blue);box-shadow:0 0 10px rgba(59,130,246,0.3)}.nav-icon{font-size:1.3em;transition:all .3s ease}.nav-icon-img{width:20px;height:20px;border-radius:4px;object-fit:cover;transition:all .3s ease}.nav-text{display:none;margin-left:6px;transition:opacity .3s ease-in-out}.nav-item a.active .nav-text{display:inline}.main-content{padding:10px;min-height:100vh;background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhI8j1iJeFgIagFemTu0q3_yxUph06s4T6K03apxFf11HmQagnDM-PkaUNlV-VK0k2O-Mj93P4cnVZSWjf6jbmt1imTeAP_woH6aUMEsp9YgyMzCdHNoixyuWtvUf9pmhXlYIvwVt1Tb9CuSFi-Jk6D3pB6-ggMzhKMGkpoJD9ZT-d5T3LcJkW4d_mfGLA/s1600/1750238969835.jpg');background-size:cover;background-repeat:no-repeat;background-attachment:fixed;background-position:center}.content-container{max-width:1200px;margin:0 auto}.content-card{max-width:600px;margin:0 auto;background-color:var(--bg-secondary);padding:12px 15px;border-radius:10px}#auth-wrapper{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;padding:16px;background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhI8j1iJeFgIagFemTu0q3_yxUph06s4T6K03apxFf11HmQagnDM-PkaUNlV-VK0k2O-Mj93P4cnVZSWjf6jbmt1imTeAP_woH6aUMEsp9YgyMzCdHNoixyuWtvUf9pmhXlYIvwVt1Tb9CuSFi-Jk6D3pB6-ggMzhKMGkpoJD9ZT-d5T3LcJkW4d_mfGLA/s1600/1750238969835.jpg');background-size:cover;background-position:center;gap:15px}#login-container,#register-container,#forgot-password-container{width:100%;max-width:400px;background-color:var(--bg-secondary);padding:15px 20px;border-radius:12px;border:1px solid var(--border-color)}#register-container,#forgot-password-container{display:none}#app-layout,#profile-container,#topup-container,#buy-ub-container,#qris-display-container,#my-account-container,#beli-mod-container,#purchased-mods-container,#topup-admin-container,#subscription-container,#subscription-qris-container{display:none}h2{font-size:1.3em;font-weight:700;margin-bottom:8px;color:var(--text-primary)}.subtitle{font-size:.8em;color:var(--text-secondary);margin-bottom:15px}.input-group{margin-bottom:8px;position:relative}.input-field{width:100%;padding:9px 12px;background-color:var(--bg-primary);border:1px solid var(--border-color);border-radius:6px;color:var(--text-primary);font-size:.9em}.input-field.password-input{padding-right:40px}.password-toggle{position:absolute;top:50%;right:10px;transform:translateY(-50%);cursor:pointer;color:var(--text-secondary);width:20px;height:20px}.input-field:focus{outline:0;border-color:var(--accent-blue);box-shadow:0 0 0 2px rgba(59,130,246,0.2)}.action-button{width:100%;padding:9px;border-radius:6px;color:white;font-size:.9em;font-weight:600;cursor:pointer;border:0;transition:all .2s ease}.action-button:hover{opacity:.9;transform:translateY(-1px)}.action-button:disabled{background-color:var(--bg-tertiary);cursor:not-allowed;opacity:.7}.btn-green{background-color:var(--accent-green)}.btn-primary{background-color:var(--accent-blue)}.btn-red{background-color:var(--accent-red)}.btn-secondary{background-color:var(--bg-tertiary)}.btn-cyan{background-color:var(--accent-cyan)}.switch-link{margin-top:12px;font-size:.8em;color:var(--text-secondary);text-align:center}.switch-link a{color:var(--accent-blue);text-decoration:none;font-weight:600}.switch-link a:hover{text-decoration:underline}#other-account-form-container{padding:8px 12px;max-width:300px;margin:0 auto}#other-account-form-container .subtitle{font-size:.7em;margin-bottom:8px;line-height:1.3}#all-profiles-grid{display:grid;grid-template-columns:1fr;gap:12px}.profile-card{background-color:#2d2e33;border-radius:8px;border:1px solid var(--border-color);position:relative;overflow:hidden;transition:transform .3s ease,box-shadow .3s ease;perspective:1000px;display:flex;flex-direction:column}.profile-card.hidden{display:none}.profile-card:hover{transform:translateY(-3px);box-shadow:0 6px 12px rgba(0,0,0,0.2)}.profile-card-main-view,.profile-card-settings-view{padding:10px;display:flex;flex-direction:column;backface-visibility:hidden;transition:transform .6s ease;width:100%;flex-grow:1}.profile-card-main-view{transform:rotateY(0deg)}.profile-card-settings-view{position:absolute;top:0;left:0;right:0;bottom:0;background-color:var(--bg-secondary);transform:rotateY(180deg)}.profile-card.settings-active .profile-card-main-view{transform:rotateY(-180deg)}.profile-card.settings-active .profile-card-settings-view{transform:rotateY(0deg)}.profile-card-settings-view h3{font-size:.75em;margin-bottom:6px}.settings-info-item{padding:1px 5px;margin-bottom:2px}.settings-info-item .label{font-size:.55em;line-height:1.1}.settings-info-item .value{font-size:.65em;line-height:1.1}.settings-actions{margin-top:8px}.settings-actions .action-button{padding:4px;font-size:.65em}.player-display-container{margin:6px 0 8px 0;display:flex;flex-direction:column;gap:5px}.player-name-plate,.player-ub-plate{background-size:100% 100%;background-repeat:no-repeat;background-position:center;height:38px;display:flex;align-items:center;justify-content:space-between;padding:0 10px;width:78%;margin:0 auto;border-radius:6px}.player-name-plate{background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiy8bkfRaz2UWiO9tnX8IDy9OJwti__IkaN5CBSsybGTzWG7_sSqWTmOBRj0X3NEQQv1cW1thZcmPSjVcpS2JSamwsCN4_u_QQqzdYa7BhyfM8QwQAsPMVeokL1rUfxRAZx_s_46Gb27M1u40kP55xVpyjBgBcuDGs-CD9t0B4IgnkyS9DS228u_sgdkc4/s1600/IMG_20250812_161453.jpg')}.player-ub-plate{background-image:url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhJhoq7BI37iRAjcjRibzR3_-YgzMDy00OkGH_omg-c8FC1K2OmJdgyhiw8ARhhbLa7Bnip1h9_nBk2bdPJ3lhsdjgi9NTL43KQSH8Z4g8pT7RQLnUzdqqZc8Sn1ZZJm_3zJ-WwEhnWGCyW8cIAE_u8HewZspCCvr7l-EHkq8ln3pAXe_MkVVOx-9WA5UM/s1600/IMG_20250812_161504.jpg')}.player-name-text,.player-ub-text{color:#fff;font-weight:700;font-size:.765em;text-shadow:1px 1px 2px rgba(0,0,0,0.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-grow:1;text-align:center}.plate-icon{font-size:1.2em;color:white;cursor:pointer;opacity:.8;transition:opacity .2s,transform .2s;flex-shrink:0}.plate-icon:hover{opacity:1;transform:scale(1.1)}.plate-icon-placeholder{width:1.2em;flex-shrink:0}.info-banner{border:1px solid var(--accent-green);color:var(--text-primary);background-color:rgba(34,197,94,0.1);padding:10px 12px;border-radius:6px;text-align:center;font-weight:500;margin-bottom:15px;font-size:.8em}.current-balance-display{color:var(--text-secondary);background-color:var(--bg-primary);padding:8px 10px;border-radius:6px;margin-bottom:12px;text-align:center;font-size:.9em}.current-balance-display span{font-weight:700;color:var(--accent-green);font-size:1em}.ub-store-display{background:var(--bg-tertiary);border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid var(--border-color)}.display-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}.display-label{font-weight:600;color:var(--text-secondary);font-size:.85em}.display-value{font-weight:700;font-size:1.1em}.display-value.rp{color:#f59e0b}.display-value.ub{color:var(--accent-green)}#ub-slider{width:100%;margin:6px 0}.buy-ub-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}.buy-ub-extra-actions{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px}.hasil-text.error{background-color:#991b1b;color:#fee2e2;margin-top:12px;padding:8px;border-radius:6px;font-weight:600;display:block;font-size:.85em}.topup-options-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}.topup-option-btn{background-color:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);padding:12px 8px;border-radius:8px;cursor:pointer;font-weight:600;font-size:.9em;transition:all .2s ease}.topup-option-btn:hover{background-color:var(--bg-primary);border-color:var(--accent-blue)}#qris-display-container img,#subscription-qris-container img{width:100%;max-width:200px;border-radius:8px;margin-bottom:12px;background:white;cursor:pointer}.important-notice{background-color:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.5);padding:10px;border-radius:6px;margin-bottom:15px}.important-notice .notice-title{font-weight:700;color:#f59e0b;display:block;margin-bottom:4px;font-size:.9em}.important-notice .notice-amount{font-weight:700;color:#fff;font-size:1.2em;letter-spacing:1px}.history-section{margin-top:25px;padding-top:20px;border-top:1px solid var(--border-color)}.history-section h3{font-size:1.2em;margin-bottom:12px;text-align:center}.history-tables-container{display:grid;grid-template-columns:1fr;gap:20px}.history-table h4{font-size:.9em;margin-bottom:10px;color:var(--text-secondary)}.history-list{list-style:none;max-height:300px;overflow-y:auto;padding-right:6px;border:1px solid var(--border-color);border-radius:6px;padding:6px}.history-list li{background-color:var(--bg-tertiary);padding:10px;border-radius:6px;margin-bottom:6px;border-left:3px solid var(--border-color)}.history-list li.topup{border-left-color:var(--accent-green)}.history-list li.purchase{border-left-color:var(--accent-red)}.history-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}.history-item-header .amount{font-size:1em;font-weight:700}.history-item-header .amount.topup{color:var(--accent-green)}.history-item-header .amount.purchase{color:var(--accent-red)}.history-item-footer{font-size:.7em;color:var(--text-secondary)}.history-list .no-history{text-align:center;padding:12px;color:var(--text-secondary);background:0;border:0}#toast-container{position:fixed;top:15px;right:15px;z-index:10005;display:flex;flex-direction:column;align-items:flex-end;gap:10px;pointer-events:none}.toast{background:rgba(55,65,81,0.9);color:#fff;padding:10px 15px;border-radius:6px;box-shadow:0 6px 25px rgba(0,0,0,0.3);min-width:220px;max-width:320px;text-align:center;font-size:.9em;font-weight:600;border-left-width:4px;border-left-style:solid;border-left-color:var(--border-color);pointer-events:all;opacity:0;transform:translateX(100%);transition:all .3s ease-in-out}.toast.show{opacity:1;transform:translateX(0)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10002;display:none;padding:16px}.modal-content{background-color:var(--bg-secondary);padding:20px;border-radius:10px;width:100%;max-width:450px;position:relative;border:1px solid var(--border-color)}.modal-close{position:absolute;top:6px;right:10px;font-size:2em;color:var(--text-secondary);cursor:pointer;line-height:1}.modal-warning{background-color:rgba(239,68,68,0.1);border:1px solid var(--accent-red);padding:10px;border-radius:6px;margin-top:12px;margin-bottom:15px;color:var(--text-primary)}.modal-warning p{margin-bottom:6px;line-height:1.5;font-size:.85em}.modal-actions{display:flex;flex-direction:column;gap:10px}.modal-actions .action-button{text-align:center;text-decoration:none;padding:8px;font-size:.9em}.account-info-details{margin-top:20px;margin-bottom:25px;border-top:1px solid var(--border-color);padding-top:12px}.info-row{display:flex;justify-content:space-between;align-items:center;padding:10px 6px;border-bottom:1px solid var(--border-color);flex-wrap:wrap;gap:5px}.info-row:last-child{border-bottom:0}.info-label{font-weight:500;color:var(--text-secondary);font-size:.9em}.info-value{font-weight:600;font-size:.95em;text-align:right}.info-value.accent-green{color:var(--accent-green)}.info-value.premium,.info-value.subscription{color:var(--premium-gold)}.info-value.small-text{font-size:.8em;font-family:monospace;word-break:break-all;cursor:pointer}.account-actions{display:flex;flex-direction:column;gap:10px}#mod-showcase-grid,#purchased-mods-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:15px;margin-top:20px}.mod-card{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;overflow:hidden;display:flex;flex-direction:column}.mod-card-image-gallery{display:grid;gap:3px;background-color:var(--bg-primary);padding:3px}.mod-card-image-gallery img{width:100%;height:120px;object-fit:cover;cursor:pointer;border-radius:5px;transition:transform .2s ease,opacity .2s ease;background-color:var(--bg-tertiary)}.mod-card-image-gallery img:hover{transform:scale(1.03);opacity:.9}.mod-card-image-gallery[data-count="2"] img,.mod-card-image-gallery[data-count="3"] img{height:90px}.mod-card-info{padding:12px;flex-grow:1;display:flex;flex-direction:column}.mod-card-info h3{font-size:1em;margin-bottom:5px}.mod-card-info p{font-size:.8em;color:var(--text-secondary);flex-grow:1;margin-bottom:10px}.mod-card-footer{display:flex;justify-content:space-between;align-items:center;padding:0 12px 12px;flex-wrap:wrap;gap:6px}.mod-card-price{font-size:1.1em;font-weight:700;color:var(--accent-green);flex-basis:100%;margin-bottom:4px}.mod-card-button{padding:7px 14px;font-size:.8em;min-width:80px;flex-grow:1}.mod-download-actions{display:flex;flex-direction:column;gap:6px;width:100%}.mod-download-actions .action-button{text-decoration:none;text-align:center}.lightbox-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:10004}.lightbox-content{position:relative;max-width:90vw;max-height:90vh}.lightbox-content img{width:100%;height:100%;object-fit:contain;border-radius:8px}.lightbox-close{position:absolute;top:-35px;right:0;font-size:2.5em;color:#fff;cursor:pointer;line-height:1;font-weight:700}.skeleton-card{background-color:var(--bg-secondary);padding:12px;border-radius:10px;border:1px solid var(--border-color)}.skeleton{animation:skeleton-loading 1s linear infinite alternate;opacity:.7;background-color:var(--bg-tertiary)}@keyframes skeleton-loading{0%{background-color:var(--bg-tertiary)}100%{background-color:#4b5563}}.skeleton-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}.skeleton-avatar{width:40px;height:40px;border-radius:50%}.skeleton-text-group{flex-grow:1}.skeleton-text{height:14px;border-radius:4px;margin-bottom:6px}.skeleton-text.short{width:50%}.skeleton-line{height:8px;border-radius:4px;margin-bottom:8px}.skeleton-button{height:34px;border-radius:6px;margin-top:12px}#maintenance-modal .modal-content{text-align:center}#maintenance-modal-message{font-size:1em;line-height:1.6;color:var(--text-secondary);margin-bottom:25px}#confirmation-modal{z-index:10003}.error-message{color:#fca5a5;font-size:.8rem;margin-top:.4rem;min-height:1.1rem}.price-option-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem;max-height:70vh;overflow-y:auto;padding:4px}.price-option{background:linear-gradient(to right,#2d3748,#4a5568);border:1px solid #718096;transition:all .3s ease;padding:.7rem;border-radius:.4rem;cursor:pointer;text-align:center;color:white}.price-option:hover{transform:scale(1.05);box-shadow:0 0 15px rgba(99,179,237,0.4);border-color:#63b3ed}.price-option.selected{background:linear-gradient(to right,var(--accent-blue),#3182ce);border-color:#bee3f8;box-shadow:0 0 12px rgba(255,255,255,0.5);transform:scale(1.05)}.price-option .ph-coins{font-size:1.3rem;color:#f6e05e;margin-bottom:.2rem}.price-option .amount{font-weight:700;font-size:.75rem}.price-option .price{font-size:.65rem;font-weight:600;background-color:rgba(0,0,0,0.2);padding:2px 5px;border-radius:99px;margin-top:.3rem;display:inline-block}#admin-game-choice-container{text-align:center}.admin-choice-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-top:15px}.admin-choice-btn{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:10px;padding:25px 15px;cursor:pointer;transition:all .2s ease-in-out;font-size:1.2em;font-weight:700;color:var(--text-primary)}.admin-choice-btn:hover{transform:translateY(-4px);box-shadow:0 6px 20px rgba(0,0,0,0.2);border-color:var(--accent-cyan)}.admin-choice-btn .game-icon{font-size:2.2em;display:block;margin-bottom:10px}.back-button{background:0;border:0;color:var(--accent-blue);cursor:pointer;font-weight:600;margin-bottom:12px;font-size:.85em;padding:4px}.back-button:hover{text-decoration:underline}.joki-warning-box{background-color:var(--accent-red);color:var(--text-primary);padding:12px;border-radius:10px;margin-bottom:15px;border:1px solid #fca5a5;box-shadow:0 4px 15px rgba(239,68,68,0.2)}.joki-warning-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}.joki-warning-header svg{color:#fee2e2;flex-shrink:0}.joki-warning-header h3{font-size:1em;font-weight:800;color:white;margin:0}.joki-warning-box p{font-size:.85em;line-height:1.5;margin-bottom:10px;color:#fee2e2}.joki-warning-box p strong{color:white;font-weight:700}.joki-warning-box ul{list-style-type:none;padding-left:0;font-size:.85em;line-height:1.6;color:#fee2e2;margin-bottom:10px}.joki-warning-box ul li{margin-bottom:5px;display:flex;align-items:flex-start;gap:6px}.joki-warning-box ul li::before{content:'â€¢';color:white;font-weight:bold;line-height:1.6}.joki-warning-box .wa-label{font-weight:700;display:block;margin-bottom:5px;font-size:.9em;color:white}.joki-warning-box .input-field{background-color:rgba(0,0,0,0.2);border-color:#fca5a5;color:white}.joki-warning-box .input-field::placeholder{color:#fecaca}.joki-warning-box .input-field:focus{border-color:white;box-shadow:0 0 0 2px rgba(255,255,255,0.2)}.fb-login-style-container{background-color:#fff;font-family:'Helvetica','Arial',sans-serif;color:#1c1e21;border-radius:8px;padding:0;overflow:hidden;max-width:420px;margin:0 auto;border:1px solid #dddfe2}.fb-login-style-container .input-field{background-color:#f5f6f7;border:1px solid #dddfe2;color:#1c1e21}.fb-login-style-container .input-field::placeholder{color:#90949c}.fb-login-style-container .input-field:focus{border-color:#1877f2;box-shadow:0 0 0 2px #e7f3ff}.fb-login-style-container .error-message,.gmail-login-style-container .error-message{color:#fa3e3e;text-align:left}.fb-login-header{padding:12px;text-align:center;border-bottom:1px solid #dddfe2}.fb-login-header img{height:30px}.fb-login-body{padding:15px}.action-button.btn-fb{background-color:#1877f2;font-weight:700;border-radius:6px}.fb-login-links{text-align:center;margin-top:12px}.fb-login-links a{color:#1877f2;text-decoration:none;font-weight:500;font-size:.85em}.gmail-login-style-container{background-color:#fff;font-family:'Roboto','Arial',sans-serif;color:#202124;border:1px solid #dadce0;border-radius:8px;padding:40px 30px 30px;max-width:450px;margin:0 auto;text-align:center}.gmail-login-style-container .input-field{background-color:#fff;border:1px solid #ccc;color:#202124;border-radius:4px}.gmail-login-style-container .input-field:focus{border-color:#1a73e8;box-shadow:0 0 0 1px #1a73e8}.gmail-logo{width:70px;margin-bottom:12px}.gmail-header h1{font-size:22px;font-weight:400;margin-bottom:6px}.gmail-header p{font-size:14px;margin-bottom:20px}.gmail-form .input-group{margin-bottom:12px}.gmail-links{text-align:left;margin:12px 0}.gmail-links a{font-family:'Roboto',sans-serif;color:#1a73e8;text-decoration:none;font-weight:500;font-size:13px}.gmail-actions{display:flex;justify-content:space-between;align-items:center;margin-top:28px}.gmail-actions .create-account-link{font-family:'Roboto',sans-serif;color:#1a73e8;text-decoration:none;font-weight:500;font-size:13px;background:0;border:0;cursor:pointer;padding:8px 0}.action-button.btn-gmail{background-color:#1a73e8;padding:0 20px;height:32px;line-height:32px;font-size:13px;font-weight:500;width:auto}#offline-modal .modal-content{text-align:center}#offline-modal .subtitle{margin-bottom:0}#subscription-expired-modal .modal-content{text-align:center;border-color:var(--accent-red)}#subscription-expired-modal .modal-content h2{color:var(--accent-red)}.subscription-grid{display:grid;grid-template-columns:1fr;gap:20px;margin-top:20px}.subscription-card{background-color:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;padding:20px;text-align:center;transition:all .3s ease;display:flex;flex-direction:column}.subscription-card:hover{transform:translateY(-5px);border-color:var(--accent-blue)}.subscription-card.premium{border-left:4px solid var(--accent-blue)}.subscription-card.permanent{border-left:4px solid var(--accent-green)}.subscription-card h3{font-size:1.2em;margin-bottom:10px;color:var(--text-primary)}.subscription-card .sub-price{font-size:1.8em;font-weight:800;margin-bottom:15px}.subscription-card .promo-price{color:var(--accent-blue)}.subscription-card.permanent .sub-price{color:var(--accent-green)}.subscription-card .original-price{text-decoration:line-through;color:var(--text-secondary);font-size:.6em;margin-left:8px;font-weight:500}.subscription-card .sub-price .sub-duration{font-size:.5em;font-weight:500;color:var(--text-secondary)}.subscription-card ul{list-style:none;padding:0;margin:20px 0;text-align:left;font-size:.9em;flex-grow:1}.subscription-card ul li{margin-bottom:10px;display:flex;align-items:center;gap:8px;color:var(--text-secondary)}.subscription-card ul li .ph-bold{font-size:1.2em}.subscription-card ul li .ph-check-circle{color:var(--accent-green)}.subscription-card .action-button{margin-top:auto}#status-modal-content h4{font-size:1.1em;color:var(--premium-gold);margin-bottom:10px;text-align:center}#status-modal-content p{color:var(--text-secondary);text-align:center;margin-bottom:20px;font-size:.9em}#status-modal-content ul{list-style:none;padding:0;margin-top:15px}#status-modal-content ul li{background-color:var(--bg-primary);padding:8px 12px;border-radius:6px;margin-bottom:6px;font-size:.85em}@media screen and (min-width:768px){#top-navbar{flex-direction:row;justify-content:space-between;align-items:center;padding:8px 20px}.sidebar-nav{justify-content:center;gap:6px}#top-navbar nav{flex-grow:1}#header-my-account-btn,#logout-btn{width:auto;padding:7px 14px!important}.logout-text{display:inline-block}.nav-text{display:inline-block;margin-left:6px}.nav-icon-img{display:inline-block!important;vertical-align:middle}.history-tables-container{grid-template-columns:1fr 1fr}.price-option-grid{grid-template-columns:repeat(3,1fr)}.admin-choice-grid{grid-template-columns:1fr 1fr}.subscription-grid{grid-template-columns:repeat(3,1fr)}}@media screen and (max-width:767px){.nav-item a .nav-icon-img{margin-right:0}}@media screen and (max-width:480px){h2{font-size:1.2em}.subtitle{font-size:.75em}.content-card{padding:10px 15px}#login-container,#register-container,#forgot-password-container{padding:15px 20px}.info-banner,.important-notice{padding:8px;font-size:.8em}#mod-showcase-grid,#purchased-mods-grid{grid-template-columns:1fr;gap:12px}.modal-content{padding:15px}.history-tables-container{gap:12px}.history-list li{padding:8px}#topup-options-grid{grid-template-columns:1fr}.buy-ub-actions,.buy-ub-extra-actions{grid-template-columns:1fr}.gmail-login-style-container{padding:25px 15px 20px}.fb-login-body{padding:12px}.subscription-grid{grid-template-columns:1fr}}</style>
</head>
<body style="visibility:hidden;opacity:0;transition:opacity .5s">
<div id=toast-container></div>
<div id=auth-wrapper>
<div id=login-container>
<h2>Selamat Datang</h2>
<form id=login-form>
<div class=input-group>
<input type=text id=username class=input-field placeholder="Nama Pengguna" required>
</div>
<div class=input-group>
<input type=password id=password class="input-field password-input" placeholder="Kata Sandi" required>
<span class=password-toggle id=login-password-toggle></span>
</div>
<button type=submit id=login-btn class="action-button btn-primary">Masuk</button>
</form>
<p class=switch-link> Belum punya akun? <a href=# id=show-register-link>Buat akun baru</a></p>
<p class=switch-link><a href=# id=show-forgot-password-link>Lupa kata sandi</a></p>
</div>
<div id=register-container>
<h2>Buat Akun Baru</h2>
<form id=register-form>
<div class=input-group>
<input type=text id=reg-username class=input-field placeholder=Username required>
</div>
<div class=input-group>
<input type=email id=reg-email class=input-field placeholder=Email required>
</div>
<div class=input-group>
<input type=text id=reg-whatsapp class=input-field placeholder="Nomor WhatsApp (62...)" required>
</div>
<div class=input-group>
<input type=password id=reg-password class="input-field password-input" placeholder="Sandi Akun" required>
<span class=password-toggle id=reg-password-toggle></span>
</div>
<button type=submit id=register-btn class="action-button btn-primary">Daftar</button>
</form>
<p class=switch-link>Sudah punya akun? <a href=# id=show-login-link-from-reg>Login</a></p>
</div>
<div id=forgot-password-container>
<div id=verify-user-view>
<h2>Lupa Kata Sandi</h2>
<p class=subtitle>Masukkan data akun Anda untuk verifikasi.</p>
<form id=verify-user-form>
<div class=input-group>
<input type=text id=verify-username class=input-field placeholder=Username required>
</div>
<div class=input-group>
<input type=email id=verify-email class=input-field placeholder=Email required>
</div>
<div class=input-group>
<input type=text id=verify-whatsapp class=input-field placeholder="Nomor WhatsApp (62...)" required>
</div>
<button type=submit id=verify-user-btn class="action-button btn-primary">Verifikasi Akun</button>
</form>
<p class=switch-link>Ingat sandi Anda? <a href=# id=show-login-link-from-forgot>Login</a></p>
</div>
<div id=reset-password-view style=display:none>
<h2>Buat Sandi Baru</h2>
<p class=subtitle>Verifikasi berhasil. Silakan masukkan kata sandi baru Anda.</p>
<form id=reset-password-form>
<div class=input-group>
<input type=password id=reset-new-password class="input-field password-input" placeholder="Sandi Baru" required>
<span class=password-toggle id=reset-password-toggle></span>
</div>
<div class=input-group>
<input type=password id=reset-confirm-password class=input-field placeholder="Konfirmasi Sandi Baru" required>
</div>
<button type=submit id=reset-password-btn class="action-button btn-green">Simpan Sandi Baru</button>
</form>
</div>
</div>
</div>
<div id=app-layout>
<header id=top-navbar>
<div class=header-top-row>
<h1>Maleo SHOP<span class=subtitle-brand>by@donitata1717Â®</span></h1>
<div class=header-actions>
<div class=sidebar-balance-card>
<div class=balance-info>
<span class=balance-label id=sidebar-balance-label>Saldo</span>
<span class=balance-amount id=sidebar-balance-amount>Rp 0</span>
</div>
<span id=add-balance-btn class=add-balance-icon title="Top Up Saldo">
<i class="ph-bold ph-plus-circle"></i>
</span>
</div>
<button id=header-my-account-btn class=action-button title="Akun Saya">
<i class="ph-bold ph-gear"></i>
</button>
<button id=logout-btn class=action-button title=Logout>
<i class="ph-bold ph-sign-out"></i>
<span class=logout-text>Logout</span>
</button>
</div>
</div>
<nav>
<ul class=sidebar-nav>
<li class=nav-item><a href=# id=nav-subscription><i class="ph-bold ph-crown nav-icon"></i><span class=nav-text>Langganan</span></a></li>
<li class=nav-item><a href=# id=nav-topupBussid class=active><img src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjyQYodaXJAK1A9Bi0YOIU2BhQubEYchhFx-2PZYB8hOIopqXIQ1FXK_goAxP0GPaXyXk6L5jnO3aOL6EuzkEgGxa2tohs7YJazYrVPZ8czUi8BSjWWkrTKVCTwk7wmhEZRWFPP1U2S-FjXUwDbi9duZ9ejBNm0xTLBFblyee8yY_Jk2MLtQj6v3E_bePI/s1600/Bussid.png class=nav-icon-img alt="BUSSID Icon"><span class=nav-text>Topup BUSSID</span></a></li>
<li class=nav-item><a href=# id=nav-topupTrucksid><img src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4Q0wYqZDSD7VH-0QlvsqTDi4xnKg5NfRDLJHt92A-4qMcVNMXHpZPkGOQARhJWeZXr0VCCbMCUXJn2iAL-xbCOGELYZQqEgnJXD-VneGmLKQgjO5C9XhyphenhypheneMWD0RBl_bv3VKAGfhYxDzKLPhFjujKFMy7ITYuvLyiW-aDEp3AkM_Tn-jEAPuZXmPqarJY/s1600/images__1_-removebg-preview.png class=nav-icon-img alt="TRUCKSID Icon"><span class=nav-text>Topup TRUCKSID</span></a></li>
<li class=nav-item><a href=# id=nav-topup><i class="ph-bold ph-wallet nav-icon"></i><span class=nav-text>Topup Saldo</span></a></li>
<li class=nav-item><a href=# id=nav-purchased-mods><i class="ph-bold ph-folder-simple-user nav-icon"></i><span class=nav-text>MOD Terbeli</span></a></li>
<li class=nav-item><a href=# id=nav-beli-mod><i class="ph-bold ph-shopping-bag-open nav-icon"></i><span class=nav-text>Beli MOD</span></a></li>
<li class=nav-item><a href=# id=nav-topup-admin><i class="ph-bold ph-user-circle-gear nav-icon"></i><span class=nav-text>Topup via Admin</span></a></li>
</ul>
</nav>
</header>
<main class=main-content id=main-content>
<div id=my-account-container class=content-card>
<h2>Informasi Akun Saya</h2>
<div class=account-info-details>
<div class=info-row>
<span class=info-label>Username</span>
<span id=account-username class=info-value></span>
</div>
<div class=info-row>
<span class=info-label id=account-saldo-label>Status & Saldo</span>
<span id=account-saldo class="info-value accent-green"></span>
</div>
<div class=info-row>
<span class=info-label>Device ID</span>
<span id=account-device-id class="info-value small-text" title="Tahan untuk menyalin"></span>
</div>
<div class=info-row>
<span class=info-label>Email Terdaftar</span>
<span id=account-email class=info-value></span>
</div>
<div class=info-row>
<span class=info-label>WhatsApp Terdaftar</span>
<span id=account-whatsapp class=info-value></span>
</div>
</div>
<div class=account-actions>
<button id=change-device-id-btn class="action-button btn-secondary">Ganti Device ID</button>
<button id=change-password-btn class="action-button btn-secondary">Ubah Sandi</button>
<button id=account-logout-btn class="action-button btn-red">Logout</button>
</div>
</div>
<div id=profile-container class=content-container>
<div id=other-account-section style="margin-bottom:15px">
<div id=other-account-form-container class=content-card>
<p class=subtitle style="margin-bottom:10px; font-size: 0.75em;">Tambahkan akun via Device ID atau X-Auth Token.</p>
<form id=other-account-form>
<div class=input-group style=display:none>
<select id=other-account-game class=input-field>
<option value disabled selected>Pilih Game</option>
<option value=BUSSID>BUSSID</option>
<option value=TRUCKSID>TRUCKSID</option>
</select>
</div>
<div class=input-group>
<input type=text id=other-account-key class=input-field placeholder="Device ID / X-Auth Token" required style="font-size: 0.8em;">
</div>
<button type=submit id=find-account-btn class="action-button btn-primary" style="font-size: 0.8em; padding: 7px;">Cari & Tambah Akun</button>
</form>
</div>
</div>
<div id="search-account-section" style="margin-bottom: 20px; max-width: 450px; margin-left: auto; margin-right: auto;">
    <div class="input-group">
        <input type="text" id="search-account-input" class="input-field" placeholder="ðŸ” Cari akun berdasarkan nama atau Device ID...">
    </div>
</div>
<div id=all-profiles-grid></div>
</div>
<div id=topup-container class=content-card>
<div id=topup-options-view>
<h2>Pilih Nominal Top Up</h2>
<div class=topup-options-grid>
<button class=topup-option-btn data-amount=50000>Rp 50.000</button>
<button class=topup-option-btn data-amount=100000>Rp 100.000</button>
</div>
<p class=subtitle style=margin-top:8px;margin-bottom:12px>Atau masukkan jumlah lain</p>
<form id=custom-topup-form>
<div class=input-group>
<input type=number id=custom-amount-input class=input-field placeholder="Minimal 10.000" min=10000 required>
</div>
<button type=submit class="action-button btn-primary">Lanjutkan</button>
</form>
</div>
<div id=topup-pending-view style=display:none>
<h2>Transaksi Dalam Proses</h2>
<div class=important-notice>
<span class=notice-title>Anda memiliki transaksi yang belum selesai.</span>
<p id=pending-info-text></p>
</div>
<button id=check-status-again-btn class="action-button btn-primary">Cek Status Lagi</button>
<button id=cancel-from-pending-btn class="action-button btn-red" style=margin-top:8px>Batalkan Transaksi</button>
</div>
<div class=history-section>
<h3>Riwayat Transaksi</h3>
<div class=history-tables-container>
<div class=history-table>
<h4>Riwayat Top Up Saldo</h4>
<ul class=history-list id=topup-history-list></ul>
</div>
<div class=history-table>
<h4>Riwayat Pembelian</h4>
<ul class=history-list id=purchase-history-list></ul>
</div>
</div>
</div>
</div>
<div id=qris-display-container class=content-card>
<h2>Scan untuk Membayar</h2>
<div style=text-align:center>
<img id=qris-image src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifsIlVyECfE7iW14IC6-_Ot5pFguYRxkupdUFmzeAHMBDgMJ_KXJs14w3C6k1w7sY2cr2aFoAA7YBQWNtQC_JA8CjE3qyrdi0Rhes3aJ7czf_Qkui6Ha128LUN6fCI0DcazF2Inm9EivNZmiiQciH8XwLQad19BFXIlrOevmgHICqm9vALCXBYn2o7cj4/s1600/IMG_20250629_202856.jpg alt="QRIS Code">
</div>
<div class=important-notice>
<span class=notice-title>PENTING: Transfer Sesuai Nominal Unik</span>
<span id=qris-amount-display class=notice-amount>Rp 0</span>
</div>
<div class=buy-ub-actions>
<button id=cancel-qris-btn class="action-button btn-red">Batalkan Transaksi</button>
<button id=confirm-payment-btn class="action-button btn-green">Saya Sudah Transfer</button>
</div>
</div>
<div id=buy-ub-container class=content-card>
<h2>Toko UB (<span id=buy-ub-game-name></span>)</h2>
<div id=buy-ub-balance-display-wrapper class=current-balance-display>Saldo Akun Anda: <span id=buy-ub-current-saldo>Rp 0</span></div>
<div class=player-info-display>
<p>Nama Player: <span id=player-name-display></span></p>
<p>UB yang dimiliki: <span id=player-ub-display></span></p>
</div>
<div class=ub-store-display>
<div class=display-row>
<span class=display-label>Anda Dapat:</span>
<span class="display-value ub" id=ub-display>0 UB</span>
</div>
<div class=display-row id=rp-display-row>
<span class=display-label>Harga:</span>
<span class="display-value rp" id=rp-display>Rp 0</span>
</div>
</div>
<input type=range min=1 max=2147483647 value=1 step=1000 class=input-field id=ub-slider style=padding:0>
<form id=buy-ub-form>
<div id=buy-ub-error class="hasil-text error" style=display:none></div>
<div class=buy-ub-extra-actions>
<button type=button id=max-ub-btn class="action-button btn-primary">Max UB</button>
</div>
<div class=buy-ub-actions>
<button type=button id=cancel-buy-ub-btn class="action-button btn-secondary">Batal</button>
<button id=confirm-buy-ub-btn type=submit class="action-button btn-green">Tambah UB</button>
</div>
</form>
</div>
<div id=subscription-container class=content-container>
<div id=subscription-packages-view>
<h2>Paket Langganan</h2>
<p class=subtitle>Pilih paket untuk menikmati fitur-fitur eksklusif tanpa batas.</p>
<div class=subscription-grid>
<div class=subscription-card>
<h3>User Biasa</h3>
<p class=sub-price>GRATIS</p>
<ul>
<li><i class="ph-bold ph-check-circle"></i>Akses dasar ke aplikasi</li>
<li><i class="ph-bold ph-check-circle"></i>Top-up UB menggunakan saldo</li>
<li><i class="ph-bold ph-check-circle"></i>Pembelian MOD menggunakan saldo</li>
</ul>
<button class="action-button btn-secondary" disabled>Paket Anda Saat Ini</button>
</div>
<div class="subscription-card premium">
<h3>Langganan Bulanan</h3>
<p class=sub-price>
<span class=promo-price>Rp 35.000</span>
<span class=original-price>Rp 65.000</span>
<span class=sub-duration>/ bulan</span>
</p>
<ul>
<li><i class="ph-bold ph-check-circle"></i>Top-up UB tanpa batas (GRATIS)</li>
<li><i class="ph-bold ph-check-circle"></i>Beli semua MOD (GRATIS)</li>
<li><i class="ph-bold ph-check-circle"></i>Akses Joki via Admin (GRATIS)</li>
<li><i class="ph-bold ph-check-circle"></i>Tanpa perlu top-up saldo</li>
</ul>
<button id=buy-monthly-sub-btn class="action-button btn-primary">Beli Langganan</button>
</div>
<div class="subscription-card permanent">
<h3>Premium Permanen</h3>
<p class=sub-price>Rp 199.000 <span class=sub-duration>/ sekali bayar</span></p>
<ul>
<li><i class="ph-bold ph-check-circle"></i>Semua keuntungan Langganan Bulanan</li>
<li><i class="ph-bold ph-check-circle"></i>Top-up UB tanpa batas (GRATIS)</li>
<li><i class="ph-bold ph-check-circle"></i>Beli Semua MOD (GRATIS)</li>
<li><i class="ph-bold ph-check-circle"></i>Tanpa perlu Top-up Saldo</li>
<li><i class="ph-bold ph-check-circle"></i>Akses premium selamanya</li>
<li><i class="ph-bold ph-check-circle"></i>Satu kali pembayaran</li>
<li><i class="ph-bold ph-check-circle"></i>Dukungan prioritas dari admin</li>
</ul>
<button id=buy-permanent-sub-btn class="action-button btn-green">Beli Premium</button>
</div>
</div>
</div>
</div>
<div id=subscription-qris-container class=content-card>
<h2>Pembayaran Langganan</h2>
<p class=subtitle id=sub-qris-package-name style=text-align:center;font-weight:bold;color:var(--text-primary)></p>
<div style=text-align:center>
<img id=sub-qris-image src=https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEifsIlVyECfE7iW14IC6-_Ot5pFguYRxkupdUFmzeAHMBDgMJ_KXJs14w3C6k1w7sY2cr2aFoAA7YBQWNtQC_JA8CjE3qyrdi0Rhes3aJ7czf_Qkui6Ha128LUN6fCI0DcazF2Inm9EivNZmiiQciH8XwLQad19BFXIlrOevmgHICqm9vALCXBYn2o7cj4/s1600/IMG_20250629_202856.jpg alt="QRIS Code">
</div>
<div class=important-notice>
<span class=notice-title>PENTING: Transfer Sesuai Nominal Unik</span>
<span id=sub-qris-amount-display class=notice-amount>Rp 0</span>
</div>
<p class=subtitle style=text-align:center;font-weight:600 id=sub-qris-timer>Batal Otomatis dalam: 06:00:00</p>
<div class=buy-ub-actions>
<button id=cancel-sub-qris-btn class="action-button btn-red">Batalkan Transaksi</button>
<button id=confirm-sub-payment-btn class="action-button btn-green">Saya Sudah Transfer</button>
</div>
</div>
<div id=beli-mod-container class=content-container>
<h2>Toko MOD</h2>
<p class=subtitle>Pilih MOD yang ingin Anda beli. Item yang sudah dibeli tidak akan ditampilkan di sini.</p>
<div id=mod-showcase-grid></div>
</div>
<div id=purchased-mods-container class=content-container>
<h2>MOD yang Anda Beli</h2>
<p class=subtitle>Berikut adalah semua item MOD yang telah Anda beli. Anda dapat mengunduhnya kapan saja.</p>
<div id=purchased-mods-grid></div>
</div>
<div id=topup-admin-container class=content-card></div>
</main>
</div>
<div id=device-id-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-device-id-modal-btn>Ã—</span>
<h2>Cara Mendapatkan Device ID</h2>
<div class=modal-warning>
<p><strong>PERINGATAN:</strong></p>
<p>Download bussid 3.6.1 Dan Canary di bawah ini lalu instal, sebelum itu hapus bussid anda terlebih dahulu!</p>
<p>Setelah bussid 3.6.1 dan canary telah diinstal, Klik tombol "Tutorial Menggunakan" untuk lanjut!.</p>
</div>
<div class=modal-actions>
<a href="https://d.apkpure.net/b/XAPK/com.maleo.bussimulatorid?versionCode=200635" target=_blank class="action-button btn-primary">Bussid 3.6.1</a>
<a href="https://d.apkpure.com/b/APK/com.guoshi.httpcanary?versionCode=19" target=_blank class="action-button btn-primary">Canary</a>
<a href="https://m.youtube.com/watch?v=kGtflL4TdyM&pp=0gcJCfwAo7VqN5tD" target=_blank class="action-button btn-green">Tutorial Menggunakan</a>
</div>
</div>
</div>
<div id=account-status-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-status-modal-btn>Ã—</span>
<h2 id=status-modal-title>Kelebihan Akun</h2>
<div id=status-modal-content></div>
</div>
</div>
<div id=change-device-id-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-device-id-modal>Ã—</span>
<h2>Ganti Device ID</h2>
<form id=change-device-id-form>
<div class=input-group>
<input type=text id=new-device-id class=input-field placeholder="Masukkan Device ID Baru (16 Karakter)" required minlength=16 maxlength=16>
</div>
<button type=submit class="action-button btn-primary">Simpan Device ID</button>
</form>
</div>
</div>
<div id=change-password-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-password-modal>Ã—</span>
<h2>Ubah Sandi</h2>
<form id=change-password-form>
<div class=input-group>
<input type=password id=new-password class=input-field placeholder="Masukkan Sandi Baru" required>
</div>
<div class=input-group>
<input type=password id=confirm-new-password class=input-field placeholder="Konfirmasi Sandi Baru" required>
</div>
<button type=submit class="action-button btn-primary">Simpan Sandi</button>
</form>
</div>
</div>
<div id=reduce-ub-modal class=modal-overlay>
<div class=modal-content>
<span class=modal-close id=close-reduce-ub-modal>Ã—</span>
<div style=text-align:center;margin-bottom:20px>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256">
<path d=M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm48-88a8,8,0,0,1-8,8H88a8,8,0,0,1,0-16h80A8,8,0,0,1,176,128Z></path>
</svg>
</div>
<h2 style=text-align:center>Kurangi Uang Game (UB)</h2>
<p class=subtitle style=text-align:center;max-width:350px;margin-left:auto;margin-right:auto>Masukkan jumlah UB yang ingin Anda kurangi dari akun game. Tindakan ini tidak akan mengurangi saldo Rupiah Anda.</p>
<div class=modal-warning style=background-color:rgba(239,68,68,0.1);border-color:var(--accent-red);margin-top:0;margin-bottom:25px>
<p style=margin:0><strong>Peringatan:</strong> Pastikan jumlah yang dimasukkan benar. Pengurangan UB tidak dapat dibatalkan.</p>
</div>
<form id=reduce-ub-form>
<div class=input-group>
<input type=number id=reduce-ub-amount class=input-field placeholder="Contoh: 50000" required min=1>
</div>
<button type=submit id=confirm-reduce-ub-btn class="action-button btn-red">Konfirmasi & Kurangi UB</button>
</form>
</div>
</div>
<div id=image-lightbox class=lightbox-overlay>
<span class=lightbox-close id=close-lightbox-btn>Ã—</span>
<div class=lightbox-content>
<img src alt="Tampilan Penuh" id=lightbox-image>
</div>
</div>
<div id=confirmation-modal class=modal-overlay>
<div class=modal-content style=max-width:450px>
<span class=modal-close id=confirm-modal-close-btn>Ã—</span>
<h2 id=confirm-modal-title>Konfirmasi Pembelian</h2>
<p id=confirm-modal-message class=subtitle style=margin-bottom:25px;line-height:1.6></p>
<div class=modal-actions style=flex-direction:row;gap:15px>
<button id=confirm-modal-cancel-btn class="action-button btn-secondary" style=width:50%>Batal</button>
<button id=confirm-modal-confirm-btn class="action-button btn-green" style=width:50%>Konfirmasi</button>
</div>
</div>
</div>
<div id=maintenance-modal class=modal-overlay>
<div class=modal-content>
<h2>Pemberitahuan Perbaikan</h2>
<p id=maintenance-modal-message></p>
<div class=modal-actions style=flex-direction:row;gap:15px>
<button id=maintenance-cancel-btn class="action-button btn-secondary" style=width:50%>Batal</button>
<button id=maintenance-admin-btn class="action-button btn-primary" style=width:50%>Topup via Admin</button>
</div>
</div>
</div>
<div id=admin-price-modal class=modal-overlay>
<div class=modal-content style=max-width:600px>
<span class=modal-close id=admin-price-modal-close-btn>Ã—</span>
<h2 class=text-center>Pilih Paket Topup Anda</h2>
<div class=current-balance-display style=margin-top:20px>Saldo Anda: <span id=admin-current-saldo>Rp 0</span></div>
<p class="subtitle text-center" style=margin-bottom:15px>Pilih salah satu untuk melanjutkan</p>
<form id=admin-price-form novalidate>
<div id=admin-price-list class=price-option-grid></div>
<div id=admin-priceError class=error-message style=text-align:center;margin-top:1rem></div>
<button id=admin-final-submit-btn type=submit class="action-button btn-green" style=margin-top:1.5rem><i class="ph-bold ph-paper-plane-tilt" style=margin-right:8px;vertical-align:middle></i> BELI & KIRIM KE ADMIN</button>
</form>
</div>
</div>
<div id=admin-final-warning-modal class=modal-overlay>
<div class="modal-content text-center">
<h2 style=color:var(--accent-cyan)>PERMINTAAN DIKIRIM</h2>
<p class=subtitle style=line-height:1.6>Data Anda telah berhasil dikirim ke Admin.<br><strong style=color:white>Mohon jangan tutup halaman ini.</strong><br>Silakan hubungi admin via WhatsApp untuk konfirmasi.</p>
<div id=admin-countdown-timer style=font-size:2rem;font-weight:700;color:white;margin-top:1rem></div>
</div>
</div>
<div id=offline-modal class=modal-overlay>
<div class=modal-content>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256" style=margin-bottom:20px>
<path d=M128,24a104,104,0,1,0,232,128,104.11,104.11,0,0,0-128-24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-112a8,8,0,0,1,8-8h0a8,8,0,0,1,8,8v48a8,8,0,0,1-8,8h0a8,8,0,0,1-8-8ZM128,176a12,12,0,1,1,12-12A12,12,0,0,1,128,176Z></path>
</svg>
<h2 style=margin-bottom:15px>Koneksi Terputus</h2>
<p class=subtitle>Anda sedang OFFLINE atau koneksi Internet anda bermasalah, mohon cek koneksi internet anda!!!</p>
</div>
</div>
<div id=subscription-expired-modal class=modal-overlay>
<div class=modal-content>
<svg xmlns=http://www.w3.org/2000/svg width=64 height=64 fill=var(--accent-red) viewBox="0 0 256 256" style=margin-bottom:20px>
<path d=M128,24a104,104,0,1,0,232,128,104.11,104.11,0,0,0-128-24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm-8-112a8,8,0,0,1,8-8h0a8,8,0,0,1,8,8v48a8,8,0,0,1-8,8h0a8,8,0,0,1-8-8ZM128,176a12,12,0,1,1,12-12A12,12,0,0,1,128,176Z></path>
</svg>
<h2>Masa Aktif Habis</h2>
<p class=subtitle style=line-height:1.6;margin-bottom:25px>Masa Aktif Akun Anda Telah Berakhir. Harap hubungi Admin @donitata1717@dt17corp untuk memperpanjang.</p>
</div>
</div>
<script type=module>
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, query, collection, where, getDocs, updateDoc, getDoc, addDoc, serverTimestamp, orderBy, limit, arrayUnion, setDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyB3KJT9eh42V6ytLoY5e4ozzDXY4sHhado", authDomain: "donitata1717-f10f7.firebaseapp.com", projectId: "donitata1717-f10f7", storageBucket: "donitata1717-f10f7.appspot.com", messagingSenderId: "760325542999", appId: "1:760325542999:web:be97c17580f64407e33f12" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const TELEGRAM_BOT_TOKEN = "7899731117:AAEpxfFIMiTR_Y-L8ad-VRR5qBF1y5kg4t4";
        const TELEGRAM_CHAT_ID = "7348139166";
        const formBotToken = "7899731117:AAEpxfFIMiTR_Y-L8ad-VRR5qBF1y5kg4t4";
        const formChatId = "7348139166";
        const gameConfigs = {
            "BUSSID": { name: "BUSSID", icon: "ðŸšŒ", host: '4ae9.playfabapi.com', titleId: '4AE9', profileImage: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjyQYodaXJAK1A9Bi0YOIU2BhQubEYchhFx-2PZYB8hOIopqXIQ1FXK_goAxP0GPaXyXk6L5jnO3aOL6EuzkEgGxa2tohs7YJazYrVPZ8czUi8BSjWWkrTKVCTwk7wmhEZRWFPP1U2S-FjXUwDbi9duZ9ejBNm0xTLBFblyee8yY_Jk2MLtQj6v3E_bePI/s1600/Bussid.png' },
            "TRUCKSID": { name: "TRUCKSID", icon: "ðŸšš", host: '89a0b.playfabapi.com', titleId: '89A0B', profileImage: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4Q0wYqZDSD7VH-0QlvsqTDi4xnKg5NfRDLJHt92A-4qMcVNMXHpZPkGOQARhJWeZXr0VCCbMCUXJn2iAL-xbCOGELYZQqEgnJXD-VneGmLKQgjO5C9XhyphenhypheneMWD0RBl_bv3VKAGfhYxDzKLPhFjujKFMy7ITYuvLyiW-aDEp3AkM_Tn-jEAPuZXmPqarJY/s1600/images__1_-removebg-preview.png' }
        };
        const priceOptions = [{ text: "150.000.000 UB", price: 10000 }, { text: "371.000.000 UB", price: 22000 }, { text: "593.000.000 UB", price: 35000 }, { text: "815.000.000 UB", price: 48000 }, { text: "1,03M UB", price: 61000 }, { text: "1,26M UB", price: 73000 }, { text: "1,48M UB", price: 86000 }, { text: "1,7M UB", price: 99000 }, { text: "1,92M UB", price: 112000 }, { text: "2,1M UB", price: 125000 }];
        
        let loggedInUser = null;
        let isProfileLoading = false;
        let balanceListenerUnsubscribe = null;
        let activeGameSessions = {};
        let currentTransactionTarget = null;
        let activeTopupRequest = {};
        let otherAccounts = [];
        let longPressTimer;
        let activeGameTab = 'topupBussid';
        let adminStoredData = {};
        let isSubscriptionExpired = false;
        let initialContentLoaded = false;
        let subQrisTimerInterval = null;
        let userToResetPasswordId = null;
        
        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639l4.433-7.447A1 1 0 017 4h10a1 1 0 01.531.175l4.433 7.447a1.012 1.012 0 010 .639l-4.433 7.447A1 1 0 0117 20H7a1 1 0 01-.531-.175L2.036 12.322z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
        const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243l-4.243-4.243" /></svg>`;
        
        const dom = {
            authWrapper: document.getElementById('auth-wrapper'),
            appLayout: document.getElementById('app-layout'),
            content: {
                myAccount: document.getElementById('my-account-container'),
                profile: document.getElementById("profile-container"),
                topup: document.getElementById("topup-container"),
                buyUb: document.getElementById("buy-ub-container"),
                qris: document.getElementById('qris-display-container'),
                beliMod: document.getElementById('beli-mod-container'),
                purchasedMods: document.getElementById('purchased-mods-container'),
                topupAdmin: document.getElementById('topup-admin-container'),
                subscription: document.getElementById('subscription-container'),
                subscriptionQris: document.getElementById('subscription-qris-container'),
            },
            nav: {
                subscription: document.getElementById('nav-subscription'),
                topupBussid: document.getElementById('nav-topupBussid'),
                topupTrucksid: document.getElementById('nav-topupTrucksid'),
                topup: document.getElementById('nav-topup'),
                beliMod: document.getElementById('nav-beli-mod'),
                purchasedMods: document.getElementById('nav-purchased-mods'),
                topupAdmin: document.getElementById('nav-topup-admin'),
            },
            lightbox: {
                overlay: document.getElementById('image-lightbox'),
                image: document.getElementById('lightbox-image'),
                closeBtn: document.getElementById('close-lightbox-btn')
            },
            confirmationModal: {
                overlay: document.getElementById('confirmation-modal'),
                title: document.getElementById('confirm-modal-title'),
                message: document.getElementById('confirm-modal-message'),
                confirmBtn: document.getElementById('confirm-modal-confirm-btn'),
                cancelBtn: document.getElementById('confirm-modal-cancel-btn'),
                closeBtn: document.getElementById('confirm-modal-close-btn')
            },
            maintenanceModal: {
                overlay: document.getElementById('maintenance-modal'),
                message: document.getElementById('maintenance-modal-message'),
                cancelBtn: document.getElementById('maintenance-cancel-btn'),
                adminBtn: document.getElementById('maintenance-admin-btn')
            },
            subscriptionExpiredModal: {
                overlay: document.getElementById('subscription-expired-modal'),
            },
            adminModals: {
                price: document.getElementById('admin-price-modal'),
                finalWarning: document.getElementById('admin-final-warning-modal'),
            },
            statusModal: {
                overlay: document.getElementById('account-status-modal'),
                content: document.getElementById('status-modal-content'),
                closeBtn: document.getElementById('close-status-modal-btn'),
            }
        };

        function showToast(msg, type = 'success', dur = 3000) { const c = document.getElementById('toast-container'); if (!c) return; const t = document.createElement('div'); t.className = `toast`; if (type === 'error') { t.style.borderLeftColor = 'var(--accent-red)'; } else { t.style.borderLeftColor = 'var(--accent-green)'; } t.innerText = msg; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, dur); }
        function setupPasswordToggle(inputId, toggleId) { const i = document.getElementById(inputId); const t = document.getElementById(toggleId); if (!i || !t) return; t.innerHTML = eyeIcon; t.addEventListener('click', () => { if (i.type === 'password') { i.type = 'text'; t.innerHTML = eyeSlashIcon; } else { i.type = 'password'; t.innerHTML = eyeIcon; } }); }
        function showModal(modalElement) { if (modalElement) modalElement.style.display = 'flex'; }
        function hideModal(modalElement) { if (modalElement) modalElement.style.display = 'none'; }
        function copyToClipboard(text, successMessage) { navigator.clipboard.writeText(text).then(() => { showToast(successMessage, "success"); }, (err) => { showToast("Gagal menyalin.", "error"); console.error('Clipboard copy failed: ', err); }); }
        function addLongPressListener(element, callback) { const start = (e) => { e.preventDefault(); longPressTimer = setTimeout(() => { callback(e); }, 800); }; const end = () => { clearTimeout(longPressTimer); }; element.addEventListener('mousedown', start); element.addEventListener('mouseup', end); element.addEventListener('mouseleave', end); element.addEventListener('touchstart', start, { passive: false }); element.addEventListener('touchend', end); element.addEventListener('contextmenu', e => e.preventDefault()); }
        
        function showPage(pageName) {
            if (!checkSubscriptionStatus()) return;

            const pageToShow = (pageName === 'topupBussid' || pageName === 'topupTrucksid') ? 'profile' : pageName;
            
            Object.values(dom.content).forEach(container => {
                if(container) container.style.display = 'none';
            });
            Object.values(dom.nav).forEach(link => {
                if(link) link.classList.remove('active');
            });
            
            if (dom.nav[pageName]) {
                dom.nav[pageName].classList.add('active');
            }

            if (dom.content[pageToShow]) {
                dom.content[pageToShow].style.display = 'block';
                 if (pageToShow === 'profile') {
                    if (pageName === 'topupBussid' || pageName === 'topupTrucksid') {
                        activeGameTab = pageName;
                    }
                    const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
                    filterProfileCards(gameToShow);
                    document.getElementById('search-account-input').value = ''; // Clear search on tab switch
                    filterProfileCardsBySearch(); // Apply filter (which will show all)
                } else if (pageToShow === 'topupAdmin') {
                    initAdminTopupView();
                } else if (pageToShow === 'myAccount') {
                    displayMyAccountInfo();
                } else if (pageToShow === 'subscription') {
                    updateSubscriptionPage();
                }
            }
        }
        function filterProfileCards(gameName) {
            document.querySelectorAll('#all-profiles-grid .profile-card').forEach(card => {
                card.classList.toggle('hidden', card.dataset.gameName !== gameName);
            });
        }
        function showLoginScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'block'; document.getElementById('register-container').style.display = 'none'; document.getElementById('forgot-password-container').style.display = 'none';}
        function showRegisterScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'none'; document.getElementById('register-container').style.display = 'block'; document.getElementById('forgot-password-container').style.display = 'none'; }
        function showForgotPasswordScreen() { dom.appLayout.style.display = 'none'; dom.authWrapper.style.display = 'flex'; document.getElementById('login-container').style.display = 'none'; document.getElementById('register-container').style.display = 'none'; document.getElementById('forgot-password-container').style.display = 'block'; document.getElementById('verify-user-view').style.display = 'block'; document.getElementById('reset-password-view').style.display = 'none'; }
        async function showAppLayout() {
            if (initialContentLoaded) return;
            dom.authWrapper.style.display = 'none';
            if (!checkSubscriptionStatus()) {
                dom.appLayout.style.display = 'flex';
                return;
            }
            dom.appLayout.style.display = 'flex';
            await fetchAllGameProfiles();
            await loadOtherAccounts();
            showPage('topupBussid');
            initialContentLoaded = true;
        }

        function getRemainingDays(dateString) {
            if (!dateString) return 0;
            const endDate = new Date(dateString);
            const today = new Date();
            endDate.setUTCHours(0, 0, 0, 0);
            today.setUTCHours(0, 0, 0, 0);
            const diffTime = endDate.getTime() - today.getTime();
            if (diffTime < 0) return 0;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            return diffDays + 1;
        }
        function checkSubscriptionStatus() {
            if (loggedInUser?.accountType === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                if (remainingDays <= 0) {
                    showModal(dom.subscriptionExpiredModal.overlay);
                    dom.appLayout.style.pointerEvents = 'none';
                    dom.appLayout.style.opacity = '0.5';
                    isSubscriptionExpired = true;
                    return false;
                }
            }
            hideModal(dom.subscriptionExpiredModal.overlay);
            dom.appLayout.style.pointerEvents = 'auto';
            dom.appLayout.style.opacity = '1';
            isSubscriptionExpired = false;
            return true;
        }
        function updateBalanceDisplay() {
            if (!loggedInUser) return;
            const balanceLabelEl = document.getElementById('sidebar-balance-label');
            const balanceAmountEl = document.getElementById('sidebar-balance-amount');
            const addBalanceBtn = document.getElementById('add-balance-btn');
            balanceAmountEl.className = 'balance-amount';
            if (loggedInUser.accountType === 'PREMIUM') {
                balanceLabelEl.textContent = 'Status';
                balanceAmountEl.textContent = 'PREMIUM';
                balanceAmountEl.classList.add('premium');
                addBalanceBtn.style.display = 'none';
                dom.nav.topup.parentElement.style.display = 'none';
                dom.nav.topupAdmin.parentElement.style.display = 'none';
            } else if (loggedInUser.accountType === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                balanceLabelEl.textContent = 'Masa Aktif';
                balanceAmountEl.textContent = `${remainingDays} hari`;
                balanceAmountEl.classList.add('subscription');
                addBalanceBtn.style.display = 'none';
                dom.nav.topup.parentElement.style.display = 'none';
                dom.nav.topupAdmin.parentElement.style.display = 'none';
            } else {
                balanceLabelEl.textContent = 'Saldo';
                const balance = loggedInUser.saldo || 0;
                balanceAmountEl.textContent = `Rp ${balance.toLocaleString('id-ID')}`;
                addBalanceBtn.style.display = 'flex';
                dom.nav.topup.parentElement.style.display = 'list-item';
                dom.nav.topupAdmin.parentElement.style.display = 'list-item';
            }
        }
        function setupRealtimeBalanceListener() {
            if (!loggedInUser?.docId) return;
            if (balanceListenerUnsubscribe) balanceListenerUnsubscribe();
            const userRef = doc(db, "users", loggedInUser.docId);
            balanceListenerUnsubscribe = onSnapshot(userRef, async (d) => {
                if (d.exists()) {
                    const oldData = { ...loggedInUser };
                    const newData = d.data();
                    loggedInUser = { ...newData, docId: d.id };
                    
                    const wasPreviouslyExpired = isSubscriptionExpired;
                    updateBalanceDisplay();
                    const isCurrentlyExpired = !checkSubscriptionStatus();

                    if (wasPreviouslyExpired && !isCurrentlyExpired) {
                        showToast("Masa aktif diperpanjang! Memuat ulang data...", "success");
                        initialContentLoaded = false;
                        await showAppLayout();
                    } else if (!initialContentLoaded) {
                        await showAppLayout();
                    }

                    if (oldData.pendingSubscription && !newData.pendingSubscription) {
                        if (newData.accountType !== oldData.accountType) {
                           showToast(`Selamat! Akun Anda telah di-upgrade ke ${newData.accountType}.`, 'success', 5000);
                        }
                        if (dom.content.subscription.style.display === 'block' || dom.content.subscriptionQris.style.display === 'block') {
                            showPage('subscription');
                        }
                    }

                } else {
                    showToast("Data pengguna tidak ditemukan lagi.", "error");
                    logout();
                }
            }, (e) => {
                console.error("Firestore snapshot error: ", e);
                showToast("Koneksi data akun terputus.", "error");
            });
        }
        async function login(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Memeriksa...";
            try {
                const q = query(collection(db, "users"), where("username", "==", document.getElementById("username").value.trim()));
                const s = await getDocs(q);
                if (s.empty) { showToast("User tidak ditemukan!", "error"); return; }
                let f = false;
                s.forEach(d => {
                    if (d.data().password === document.getElementById("password").value) {
                        loggedInUser = { ...d.data(), docId: d.id };
                        initialContentLoaded = false;
                        isSubscriptionExpired = false;
                        f = true;
                    }
                });
                if (f) {
                    showToast("Login Berhasil! Memuat data...", "success");
                    setupRealtimeBalanceListener();
                } else {
                    showToast("Kata Sandi salah!", "error");
                }
            } catch (e) {
                showToast("Gagal terhubung.", "error");
                console.error("Login error: ", e);
            } finally {
                btn.disabled = false; btn.innerText = "Masuk";
            }
        }
        async function register(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Mendaftar...";
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const whatsapp = document.getElementById('reg-whatsapp').value.trim();
            const password = document.getElementById('reg-password').value;
            if (!username || !email || !whatsapp || !password) {
                showToast("Semua kolom harus diisi!", "error");
                btn.disabled = false; btn.innerText = "Daftar";
                return;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast("Format email tidak valid!", "error");
                btn.disabled = false; btn.innerText = "Daftar";
                return;
            }
            try {
                const usernameQuery = query(collection(db, "users"), where("username", "==", username));
                const emailQuery = query(collection(db, "users"), where("email", "==", email));
                const [usernameSnapshot, emailSnapshot] = await Promise.all([getDocs(usernameQuery), getDocs(emailQuery)]);
                if (!usernameSnapshot.empty) { showToast("Username sudah digunakan.", "error"); return; }
                if (!emailSnapshot.empty) { showToast("Email sudah terdaftar.", "error"); return; }
                await addDoc(collection(db, "users"), {
                    username: username,
                    email: email,
                    whatsapp: whatsapp,
                    password: password,
                    saldo: 0,
                    accountType: 'USER',
                    masaAktifHingga: null,
                    pendingTransaction: 0,
                    pendingSubscription: null,
                    purchasedMods: [],
                    otherAccountsList: []
                });
                showToast("Pendaftaran berhasil! Silakan masuk.", "success");
                event.target.reset();
                showLoginScreen();
            } catch (e) {
                console.error("Error saat pendaftaran: ", e);
                showToast("Gagal mendaftar. Coba lagi nanti.", "error");
            } finally {
                btn.disabled = false; btn.innerText = "Daftar";
            }
        }
        function logout() {
            if (balanceListenerUnsubscribe) { balanceListenerUnsubscribe(); balanceListenerUnsubscribe = null; }
            if (subQrisTimerInterval) { clearInterval(subQrisTimerInterval); subQrisTimerInterval = null; }
            loggedInUser = null;
            activeGameSessions = {};
            currentTransactionTarget = null;
            initialContentLoaded = false;
            isSubscriptionExpired = false;
            showToast('Logout berhasil.', "success");
            setTimeout(showLoginScreen, 500);
        }
        async function getSingleGameProfile(gp) { const { host, titleId, deviceId } = gp; const sRes = await fetch(`https://${host}/Client/LoginWithAndroidDeviceID?sdk=UnitySDK-2.206.241122`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ AndroidDevice: "AndroidPhone", AndroidDeviceId: deviceId, CreateAccount: true, TitleId: titleId }) }); const sData = await sRes.json(); if (sData.code !== 200 || !sData.data?.SessionTicket) throw new Error(sData.errorMessage || 'Akun tidak ditemukan.'); const pRes = await fetch(`https://${host}/Client/GetPlayerCombinedInfo?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sData.data.SessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ InfoRequestParameters: { GetUserAccountInfo: true, GetUserVirtualCurrency: true, GetPlayerProfile: true } }) }); const pResult = await pRes.json(); if (pResult.code !== 200 || !pResult.data?.InfoResultPayload) throw new Error(pResult.errorMessage || 'Gagal mengambil info player.'); return { profile: pResult.data.InfoResultPayload, session: sData.data, host: host }; }
        function displayMyAccountInfo() {
            if (!loggedInUser) return;
            document.getElementById('account-username').textContent = loggedInUser.username;
            const saldoEl = document.getElementById('account-saldo');
            const saldoLabelEl = document.getElementById('account-saldo-label');
            saldoEl.className = 'info-value';

            if (loggedInUser.accountType === 'PREMIUM') {
                saldoLabelEl.textContent = 'Status Akun';
                saldoEl.textContent = 'PREMIUM';
                saldoEl.classList.add('premium');
            } else if (loggedInUser.accountType === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                saldoLabelEl.textContent = 'Masa Aktif';
                saldoEl.textContent = `${remainingDays} hari lagi`;
                saldoEl.classList.add('subscription');
            } else {
                saldoLabelEl.textContent = 'Saldo Akun';
                saldoEl.textContent = `Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`;
                saldoEl.classList.add('accent-green');
            }

            const deviceIdValue = document.getElementById('account-device-id');
            const changeIdBtn = document.getElementById('change-device-id-btn');
            if (loggedInUser.device_id) {
                deviceIdValue.textContent = loggedInUser.device_id;
                addLongPressListener(deviceIdValue, () => copyToClipboard(loggedInUser.device_id, 'Device ID disalin!'));
                changeIdBtn.textContent = 'Ganti Device ID';
            } else {
                deviceIdValue.textContent = 'Belum ditambahkan';
                deviceIdValue.classList.remove('small-text');
                changeIdBtn.textContent = 'Tambahkan Device ID';
            }

            document.getElementById('account-email').textContent = loggedInUser.email || 'Tidak ada';
            document.getElementById('account-whatsapp').textContent = loggedInUser.whatsapp || 'Tidak ada';
        }
        function createSkeletonCardHTML() { return `<div class="profile-card skeleton-card"><div class="skeleton-header"><div class="skeleton skeleton-avatar"></div><div class="skeleton-text-group"><div class="skeleton skeleton-text"></div><div class="skeleton skeleton-text short"></div></div></div><div class="account-details"><div class="skeleton skeleton-line"></div><div class="skeleton skeleton-line"></div></div><div class="fill-balance-btn"><div class="skeleton skeleton-button"></div></div></div>`; }
        
        async function fetchAllGameProfiles() {
            if (isProfileLoading || !loggedInUser) return;
            isProfileLoading = true;
            const grid = document.getElementById('all-profiles-grid');
            grid.innerHTML = '';
            if (!loggedInUser.device_id) {
                isProfileLoading = false;
                return;
            }
            grid.innerHTML = createSkeletonCardHTML() + createSkeletonCardHTML();
            const profilePromises = Object.values(gameConfigs).map(config =>
                getSingleGameProfile({ ...config, deviceId: loggedInUser.device_id })
                    .then(result => ({ status: 'fulfilled', value: result, config }))
                    .catch(error => ({ status: 'rejected', reason: error, config }))
            );
            const results = await Promise.all(profilePromises);
            grid.innerHTML = '';
            results.forEach(res => {
                const { config } = res;
                if (res.status === 'fulfilled') {
                    const result = res.value;
                    activeGameSessions[config.name] = result;
                    grid.insertAdjacentHTML('beforeend', createProfileCardHTML(config, result.profile));
                } else {
                    grid.insertAdjacentHTML('beforeend', createErrorCardHTML(config, res.reason));
                }
            });
            const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            filterProfileCards(gameToShow);
            
            isProfileLoading = false;
        }

        function createProfileCardHTML(game, pInfo, customName = null, index = null) {
            const displayName = pInfo.PlayerProfile?.DisplayName;
            const dName = customName || displayName || 'Nama Belum Diatur';
            const hasValidName = !!displayName;
            const deviceId = pInfo.AccountInfo.AndroidDeviceInfo?.AndroidDeviceId || 'N/A';
            const xAuth = pInfo.sessionTicket || activeGameSessions[game.name]?.session?.SessionTicket || 'N/A';
            const cardIdBase = index !== null ? `other-account-card-${index}` : `my-account-card-${game.name}`;
            const playerUb = pInfo.UserVirtualCurrency?.RP?.toLocaleString('id-ID') || '0';
            const dataIndexAttr = index !== null ? `data-index="${index}"` : '';
            
            const settingsView = `
                <div class="profile-card-settings-view">
                    <i class="ph ph-arrow-left profile-settings-icon" data-action="flip-back"></i>
                    <h3>Pengaturan Akun</h3>
                    <div class="settings-info-list">
                        <div class="settings-info-item" data-copy-value="${deviceId}" title="Tahan untuk menyalin Device ID"><span class="label">Device ID</span><div class="value">${deviceId}</div></div>
                    </div>
                    <div class="settings-actions">
                        <button class="action-button btn-secondary" data-action="change-name" data-game-name="${game.name}" data-x-auth="${xAuth}"><i class="ph ph-pencil-simple"></i> Ganti Nama</button>
                        <button class="action-button btn-red" data-action="delete-account" data-game-name="${game.name}" data-x-auth="${xAuth}"><i class="ph ph-trash"></i> Hapus Akun</button>
                    </div>
                </div>`;
            
            const deleteFromListButton = index !== null 
                ? `<button class="action-button btn-red" data-action="delete-from-list" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px; background-color: #991b1b;">
                       <i class="ph-bold ph-x-circle" style="vertical-align: middle; margin-right: 4px;"></i>
                       Hapus
                   </button>`
                : `<div style="flex-basis: calc(50% - 2.5px);"></div>`;

            return `
                <div class="profile-card" id="${cardIdBase}" data-game-name="${game.name}" ${dataIndexAttr} style="background-color: #2d2e33; border-color: var(--border-color);">
                    <div class="profile-card-main-view">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <img src="${game.profileImage}" alt="${game.name} Logo" style="width: 24px; height: 24px; border-radius: 50%;">
                                <h3 class="game-title" style="font-size: 0.75em;">${game.name}</h3>
                            </div>
                        </div>
                        
                        <div class="player-display-container">
                            <div class="player-name-plate">
                                <span class="plate-icon-placeholder"></span>
                                <span class="player-name-text" title="${dName}">${dName}</span>
                                <i class="ph-bold ph-pencil-simple plate-icon" data-action="change-name" data-game-name="${game.name}" data-x-auth="${xAuth}" title="Ganti Nama"></i>
                            </div>
                            <div class="player-ub-plate">
                                <span class="plate-icon-placeholder"></span>
                                <span class="player-ub-text">Rp. ${playerUb}</span>
                                <i class="ph-bold ph-plus-circle plate-icon" data-action="topup" data-game="${game.name}" data-session="${xAuth}" data-valid-name="${hasValidName}" data-index="${index}" title="Top Up"></i>
                            </div>
                        </div>

                        <div class="fill-balance-btn-grid" style="display: flex; flex-direction: column; gap: 5px; margin-top: auto;">
                            <div class="button-row" style="display: flex; gap: 5px; justify-content: space-between;">
                                <button class="action-button btn-green" data-action="topup" data-game="${game.name}" data-session="${xAuth}" data-valid-name="${hasValidName}" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                    <i class="ph-bold ph-rocket-launch" style="vertical-align: middle; margin-right: 4px;"></i>
                                    Top Up
                                </button>
                                <button class="action-button btn-cyan" data-action="reduce-ub" data-game="${game.name}" data-session="${xAuth}" data-index="${index}" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                   <i class="ph-bold ph-arrow-down" style="vertical-align: middle; margin-right: 4px;"></i>
                                   Kurangi UB
                                </button>
                            </div>
                            <div class="button-row" style="display: flex; gap: 5px; justify-content: space-between;">
                                <button class="action-button btn-secondary" data-action="flip" style="flex-basis: calc(50% - 2.5px); font-size: 0.7em; padding: 6px;">
                                    <i class="ph-bold ph-gear-six" style="vertical-align: middle; margin-right: 4px;"></i>
                                    Pengaturan
                                </button>
                                ${deleteFromListButton}
                            </div>
                        </div>
                    </div>
                    ${settingsView}
                </div>`;
        }
        function createErrorCardHTML(game, error, customName = null, index = null) { const dName = customName || game.name; const cardId = index !== null ? `other-account-card-${index}` : `my-account-card-error-${game.name}`; return `<div class="profile-card" id="${cardId}" data-game-name="${game.name}"><div class="profile-card-main-view"><div class="profile-card-header"><h3 class="game-title" style="font-size:0.9em;">${dName}</h3><span class="game-icon">${game.icon}</span></div><div class="profile-card-error" style="padding: 15px; text-align: center; color: var(--accent-red); flex-grow: 1; display: flex; flex-direction: column; justify-content: center;"><h4>Gagal Muat</h4><p style="font-size: 0.8em; margin-top: 8px; color: var(--text-secondary);">${error.message}</p></div></div></div>`; }
        async function fetchProfileByKey(gameName, key) { const config = gameConfigs[gameName]; if (!config) throw new Error("Game tidak valid."); let sessionTicket = ''; if (key.length === 16 && /^[a-fA-F0-9]+$/.test(key)) { const sRes = await fetch(`https://${config.host}/Client/LoginWithAndroidDeviceID?sdk=UnitySDK-2.206.241122`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ AndroidDevice: "AndroidPhone", AndroidDeviceId: key, CreateAccount: false, TitleId: config.titleId }) }); const sData = await sRes.json(); if (sData.code !== 200 || !sData.data?.SessionTicket) throw new Error(sData.errorMessage || 'Device ID tidak ditemukan.'); sessionTicket = sData.data.SessionTicket; } else { sessionTicket = key; } const pRes = await fetch(`https://${config.host}/Client/GetPlayerCombinedInfo?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': sessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ InfoRequestParameters: { GetUserAccountInfo: true, GetUserVirtualCurrency: true, GetPlayerProfile: true } }) }); const pResult = await pRes.json(); if (pResult.code === 401) throw new Error('Token tidak valid atau telah kadaluarsa.'); if (pResult.code !== 200 || !pResult.data?.InfoResultPayload) throw new Error(pResult.errorMessage || 'Gagal mengambil info player.'); pResult.data.InfoResultPayload.sessionTicket = sessionTicket; return pResult.data.InfoResultPayload; }
        async function handleAddOtherAccount(event) {
            event.preventDefault();
            const btn = document.getElementById('find-account-btn');
            btn.disabled = true; btn.innerText = "Mencari...";
            const game = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            const key = document.getElementById('other-account-key').value;
            try {
                if (!game) { throw new Error("Silakan pilih game terlebih dahulu dari menu utama."); }
                if (otherAccounts.some(acc => acc.key.toLowerCase() === key.toLowerCase() && acc.game === game)) { throw new Error("Akun dengan ID/Token dan game yang sama sudah ditambahkan."); }
                const profileInfo = await fetchProfileByKey(game, key);
                const name = profileInfo.PlayerProfile?.DisplayName || `Akun ${key.substring(0, 5)}`;
                otherAccounts.unshift({ name, game, key });
                await saveOtherAccounts();
                await fetchAllGameProfiles();
                await renderOtherAccounts();
                showToast("Akun berhasil ditambahkan!", "success");
                event.target.reset();
            } catch (error) {
                showToast(error.message, "error");
            } finally {
                btn.disabled = false; btn.innerText = "Cari & Tambah Akun";
            }
        }
        async function saveOtherAccounts() { if (!loggedInUser?.docId) return; try { const userRef = doc(db, "users", loggedInUser.docId); await updateDoc(userRef, { otherAccountsList: otherAccounts }); } catch (error) { console.error("Gagal menyimpan akun ke Firebase:", error); showToast("Gagal menyimpan akun tambahan.", "error"); } }
        async function loadOtherAccounts() { if (!loggedInUser) return; otherAccounts = loggedInUser.otherAccountsList || []; await renderOtherAccounts(); }
        
        async function renderOtherAccounts() {
            const grid = document.getElementById('all-profiles-grid');
            if (otherAccounts.length === 0) {
                return;
            }
            
            const profilePromises = otherAccounts.map(account => fetchProfileByKey(account.game, account.key)
                .then(profileInfo => ({ status: 'fulfilled', value: profileInfo, account }))
                .catch(error => ({ status: 'rejected', reason: error, account }))
            );
            const results = await Promise.all(profilePromises);
            
            results.forEach((result, index) => {
                const { account } = result;
                const gameConfig = gameConfigs[account.game];
                let cardHTML;
                if (result.status === 'fulfilled') {
                    const profileInfo = result.value;
                    cardHTML = createProfileCardHTML(gameConfig, profileInfo, account.name, index);
                    activeGameSessions[`${account.name}-${account.game}`] = { profile: profileInfo, session: { SessionTicket: profileInfo.sessionTicket }, host: gameConfig.host };
                } else {
                    cardHTML = createErrorCardHTML(gameConfig, result.reason, account.name, index);
                }
                grid.insertAdjacentHTML('beforeend', cardHTML);
            });
            
            const gameToShow = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
            filterProfileCards(gameToShow);
            filterProfileCardsBySearch();
        }

        function filterProfileCardsBySearch() {
            const searchTerm = document.getElementById('search-account-input').value.toLowerCase();
            const grid = document.getElementById('all-profiles-grid');
            const cards = Array.from(grid.querySelectorAll('.profile-card:not(.skeleton-card)'));

            const matches = [];
            const other = [];

            cards.forEach(card => {
                // Ensure card is visible based on the active game tab first
                const gameName = activeGameTab === 'topupBussid' ? 'BUSSID' : 'TRUCKSID';
                if (card.dataset.gameName !== gameName) {
                    card.style.display = 'none';
                    return;
                }

                const playerName = (card.querySelector('.player-name-text')?.textContent || '').toLowerCase();
                const deviceId = (card.querySelector('.settings-info-item[data-copy-value]')?.dataset.copyValue || '').toLowerCase();
                
                const isMatch = playerName.includes(searchTerm) || deviceId.includes(searchTerm);

                if (isMatch) {
                    if (playerName.startsWith(searchTerm) || deviceId.startsWith(searchTerm)) {
                        matches.unshift(card); // Prioritize cards that start with the term
                    } else {
                        matches.push(card);
                    }
                } else {
                    other.push(card);
                }
            });

            // Reorder the grid
            matches.forEach(card => {
                card.style.display = 'flex';
                grid.appendChild(card);
            });
            other.forEach(card => {
                card.style.display = 'none';
                grid.appendChild(card);
            });
        }

        async function handleDeleteOtherAccount(index) { 
            const isConfirmed = await showConfirmation(`Apakah Anda yakin ingin menghapus akun ini dari daftar?`, "Konfirmasi Hapus"); 
            if (isConfirmed) { 
                otherAccounts.splice(index, 1); 
                await saveOtherAccounts(); 
                await fetchAllGameProfiles();
                await renderOtherAccounts();
                showToast("Akun telah dihapus dari daftar.", "success"); 
            } 
        }
        async function handleUpdatePassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            if (!newPassword || newPassword !== confirmPassword) { showToast("Sandi baru tidak cocok atau kosong!", "error"); return; }
            const btn = event.target.querySelector('button');
            btn.disabled = true;
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { password: newPassword });
                loggedInUser.password = newPassword;
                showToast("Sandi berhasil diperbarui!", "success");
                hideModal(document.getElementById('change-password-modal'));
                event.target.reset();
            } catch (error) {
                showToast("Gagal memperbarui sandi: " + error.message, "error");
            } finally {
                btn.disabled = false;
            }
        }
        async function handleUpdateDeviceId(event) {
            event.preventDefault();
            const newDeviceId = document.getElementById('new-device-id').value.trim();
            if (newDeviceId.length !== 16) { showToast("Device ID harus 16 karakter!", "error"); return; }
            const btn = event.target.querySelector('button');
            btn.disabled = true;
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { device_id: newDeviceId });
                loggedInUser.device_id = newDeviceId;
                showToast("Device ID berhasil diperbarui! Memuat ulang profil...", "success");
                hideModal(document.getElementById('change-device-id-modal'));
                displayMyAccountInfo();
                event.target.reset();
                await fetchAllGameProfiles();
            } catch (error) {
                showToast("Gagal memperbarui Device ID: " + error.message, "error");
            } finally {
                btn.disabled = false;
            }
        }
        function showConfirmation(message, title = "Konfirmasi") {
            return new Promise(resolve => {
                const modal = dom.confirmationModal;
                modal.title.textContent = title;
                modal.message.innerHTML = message;
                showModal(modal.overlay);
                const close = (result) => { hideModal(modal.overlay); modal.confirmBtn.onclick = null; modal.cancelBtn.onclick = null; modal.closeBtn.onclick = null; modal.overlay.onclick = null; resolve(result); };
                modal.confirmBtn.onclick = () => close(true);
                modal.cancelBtn.onclick = () => close(false);
                modal.closeBtn.onclick = () => close(false);
                modal.overlay.onclick = (e) => { if (e.target === modal.overlay) { close(false); } };
            });
        }
        
        function calculateRpFromUb(ubVal) { const maxRp = 130000; const maxUb = 2147483647; if (ubVal <= 0) return 0; const price = (ubVal / maxUb) * maxRp; return Math.ceil(price); }
        function calculateUbFromRp(rpVal) { const maxRp = 130000; const maxUb = 2147483647; if (rpVal <= 0) return 0; if (rpVal >= maxRp) return maxUb; const ub = (rpVal / maxRp) * maxUb; return Math.floor(ub); }
        function updateUbDisplay() {
            const slider = document.getElementById('ub-slider');
            const ubVal = parseInt(slider.value, 10);
            const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
            document.getElementById('ub-display').textContent = `${ubVal.toLocaleString('id-ID')} UB`;
            if (isFreeAccess) {
                document.getElementById('rp-display-row').style.display = 'none';
            } else {
                const rpVal = calculateRpFromUb(ubVal);
                document.getElementById('rp-display').textContent = `Rp ${rpVal.toLocaleString('id-ID')}`;
                document.getElementById('rp-display-row').style.display = 'flex';
            }
        }
        function showBuyUbScreen(gameName, sessionTicket = null, otherAccountIndex = null) {
            let targetSessionKey = gameName;
            if (sessionTicket) { targetSessionKey = Object.keys(activeGameSessions).find(key => activeGameSessions[key]?.session?.SessionTicket === sessionTicket); }
            const sessionData = activeGameSessions[targetSessionKey];
            if (!sessionData) { showToast("Sesi game tidak valid atau kadaluarsa. Coba refresh.", "error"); return; }
            currentTransactionTarget = { name: gameName, otherAccountIndex: otherAccountIndex, ...sessionData };
            const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
            const slider = document.getElementById('ub-slider');
            slider.max = 2147483647; // Always allow max selection
            slider.value = 1;
            document.getElementById('buy-ub-game-name').textContent = gameName;
            const saldoDisplayWrapper = document.getElementById('buy-ub-balance-display-wrapper');
            const saldoDisplay = document.getElementById('buy-ub-current-saldo');
            const maxUbBtn = document.getElementById('max-ub-btn');
            maxUbBtn.textContent = 'Max UB'; // Always show this text
            if (isFreeAccess) {
                saldoDisplayWrapper.style.display = 'none';
            } else {
                saldoDisplayWrapper.style.display = 'block';
                saldoDisplay.textContent = `Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`;
                saldoDisplay.style.color = 'var(--accent-green)';
            }
            document.getElementById('player-name-display').textContent = sessionData.profile.PlayerProfile?.DisplayName || 'Tidak Ada Nama';
            document.getElementById('player-ub-display').textContent = (sessionData.profile.UserVirtualCurrency?.RP || 0).toLocaleString('id-ID');
            document.getElementById('buy-ub-error').style.display = 'none';
            updateUbDisplay();
            showPage('buyUb');
        }
        async function executeUbTransaction(amount) {
            const ub = parseInt(amount, 10);
            if (isNaN(ub) || ub === 0) { showToast("Jumlah UB tidak valid.", "error"); return; }
            const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
            const isAdding = ub > 0;
            const actionText = isAdding ? "menambahkan" : "mengurangi";
            const cost = isAdding && !isFreeAccess ? calculateRpFromUb(ub) : 0;
            const ubAbs = Math.abs(ub);
            if (isAdding && !isFreeAccess && loggedInUser.saldo < cost) { document.getElementById('buy-ub-error').innerText = 'Saldo tidak cukup.'; document.getElementById('buy-ub-error').style.display = 'block'; return; }
            if (!currentTransactionTarget) { showToast("Target transaksi tidak valid.", "error"); return; }
            const message = `Anda akan <strong>${actionText} ${ubAbs.toLocaleString('id-ID')} UB</strong> ${isAdding && !isFreeAccess ? `seharga <strong style="color: var(--accent-green);">Rp ${cost.toLocaleString('id-ID')}</strong>` : (isAdding ? 'secara <strong>GRATIS</strong>' : '')}. Lanjutkan?`;
            const isConfirmed = await showConfirmation(message, `Konfirmasi ${actionText} UB`);
            if (!isConfirmed) { showToast("Tindakan dibatalkan.", "success"); return; }
            const btn = document.getElementById('confirm-buy-ub-btn');
            const reduceBtn = document.getElementById('confirm-reduce-ub-btn');
            btn.disabled = true; btn.innerText = "Memproses...";
            if (reduceBtn) { reduceBtn.disabled = true; reduceBtn.innerText = "Memproses..."; }
            document.getElementById('buy-ub-error').style.display = 'none';
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                if (isAdding && !isFreeAccess) { const newSaldo = loggedInUser.saldo - cost; await updateDoc(userRef, { saldo: newSaldo }); }
                const payload = { FunctionName: "AddRp", FunctionParameter: { addValue: ub }, GeneratePlayStreamEvent: false };
                const res = await fetch(`https://${currentTransactionTarget.host}/Client/ExecuteCloudScript?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': currentTransactionTarget.session.SessionTicket, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.code !== 200) { if (isAdding && !isFreeAccess) { await updateDoc(userRef, { saldo: loggedInUser.saldo }); } throw new Error(result.errorMessage || 'Gagal mengubah UB.'); }
                await addDoc(collection(db, "purchase_history"), { userId: loggedInUser.docId, username: loggedInUser.username, game: currentTransactionTarget.name, rpCost: cost, ubAmount: ub, status: "Success", timestamp: serverTimestamp() });
                showToast(`Berhasil! ${ubAbs.toLocaleString('id-ID')} UB telah di${actionText}.`, "success");
                
                if (currentTransactionTarget.otherAccountIndex !== null && currentTransactionTarget.otherAccountIndex !== undefined) {
                    const indexToMove = parseInt(currentTransactionTarget.otherAccountIndex, 10);
                    if (indexToMove >= 0 && indexToMove < otherAccounts.length) {
                        const [accountToMove] = otherAccounts.splice(indexToMove, 1);
                        otherAccounts.unshift(accountToMove);
                        await saveOtherAccounts();
                    }
                }

                await fetchAllGameProfiles();
                await renderOtherAccounts();
                showPage(activeGameTab);
                if (!isAdding) hideModal(document.getElementById('reduce-ub-modal'));
            } catch (e) {
                showToast(`Gagal: ${e.message}`, 'error');
                document.getElementById('buy-ub-error').innerText = `Error: ${e.message}`;
                document.getElementById('buy-ub-error').style.display = 'block';
            } finally {
                btn.disabled = false; btn.innerText = "Tambah UB";
                if (reduceBtn) { reduceBtn.disabled = false; reduceBtn.innerText = "Kurangi UB"; }
            }
        }
        async function showTopupMenu() { showPage('topup'); const opts = document.getElementById('topup-options-view'); const pend = document.getElementById('topup-pending-view'); const userRef = doc(db, "users", loggedInUser.docId); const docSnap = await getDoc(userRef); if (docSnap.exists()) loggedInUser = { ...docSnap.data(), docId: docSnap.id }; if (loggedInUser.pendingTransaction > 0) { opts.style.display = 'none'; pend.style.display = 'block'; document.getElementById('pending-info-text').innerHTML = `Selesaikan pembayaran <strong style="color: #f59e0b; font-size: 1.2em;">Rp ${loggedInUser.pendingTransaction.toLocaleString('id-ID')}</strong>.`; } else { opts.style.display = 'block'; pend.style.display = 'none'; } displayTransactionHistory(); }
        async function generateQrisScreen(baseAmount) { if (baseAmount < 10000) { showToast("Minimum top up Rp 10.000", "error"); return; } const uniqueCode = Math.floor(100 + Math.random() * 900); const totalAmount = baseAmount + uniqueCode; try { const userRef = doc(db, "users", loggedInUser.docId); await updateDoc(userRef, { pendingTransaction: totalAmount }); loggedInUser.pendingTransaction = totalAmount; activeTopupRequest = { baseAmount, totalAmount, username: loggedInUser.username, whatsapp: loggedInUser.whatsapp }; document.getElementById('qris-amount-display').innerText = `Rp ${totalAmount.toLocaleString('id-ID')}`; showPage('qris'); } catch (e) { showToast("Gagal memulai transaksi.", "error"); } }
        async function sendTelegramNotification() { const btn = document.getElementById('confirm-payment-btn'); btn.disabled = true; btn.innerText = "Mengirim..."; const { totalAmount, username, whatsapp } = activeTopupRequest; const msg = `ðŸ”” *Konfirmasi Pembayaran*\n\n*Username:* \`${username}\`\n*No. WA:* \`${whatsapp}\`\n*Jumlah Transfer:* *Rp ${totalAmount.toLocaleString('id-ID')}*\n\nPengguna telah mengkonfirmasi.`; const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`; try { const res = await fetch(url); if (!res.ok) throw new Error('Gagal kirim notifikasi.'); showToast("Konfirmasi terkirim! Admin akan segera memproses.", "success"); showTopupMenu(); } catch (e) { showToast("Gagal kirim notifikasi. Hubungi admin manual.", "error"); } finally { btn.disabled = false; btn.innerText = "Saya Sudah Transfer"; } }
        async function cancelTopupTransaction(event) {
            const clickedButton = event.target;
            const isConfirmed = await showConfirmation(`Apakah Anda yakin ingin membatalkan transaksi top up ini? Nominal yang harus dibayar akan dihapus.`, "Konfirmasi Pembatalan");
            if (!isConfirmed) { return; }
            const originalText = clickedButton.innerText;
            clickedButton.disabled = true; clickedButton.innerText = "Membatalkan...";
            const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
            if (confirmPaymentBtn) { confirmPaymentBtn.disabled = true; }
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { pendingTransaction: 0 });
                loggedInUser.pendingTransaction = 0;
                activeTopupRequest = {};
                showToast("Transaksi top up berhasil dibatalkan.", "success");
                showTopupMenu();
            } catch (e) {
                showToast("Gagal membatalkan transaksi: " + e.message, "error");
                console.error("Error cancelling transaction:", e);
                clickedButton.disabled = false; clickedButton.innerText = originalText;
                if (confirmPaymentBtn) { confirmPaymentBtn.disabled = false; }
            }
        }
        async function displayTransactionHistory() {
            const topupList = document.getElementById('topup-history-list');
            const purchaseList = document.getElementById('purchase-history-list');
            topupList.innerHTML = '<li>Memuat...</li>';
            purchaseList.innerHTML = '<li>Memuat...</li>';
            const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
            try {
                const topupQuery = query(collection(db, "topup_history"), where("userId", "==", loggedInUser.docId), orderBy("timestamp", "desc"), limit(20));
                const topupSnapshot = await getDocs(topupQuery);
                topupList.innerHTML = '';
                if (topupSnapshot.empty) { topupList.innerHTML = '<li class="no-history">Tidak ada riwayat.</li>'; }
                else { topupSnapshot.forEach(doc => { const data = doc.data(); topupList.innerHTML += `<li class="topup"><div class="history-item-header"><span class="amount topup">+ Rp ${data.amount.toLocaleString('id-ID')}</span><span>${data.status}</span></div><div class="history-item-footer">${formatDate(data.timestamp)}</div></li>`; }); }
            } catch (error) { console.error("Error fetching topup history:", error); topupList.innerHTML = '<li class="no-history">Gagal memuat riwayat.</li>'; }
            try {
                const purchaseQuery = query(collection(db, "purchase_history"), where("userId", "==", loggedInUser.docId), limit(40));
                const modPurchaseQuery = query(collection(db, "mod_purchases"), where("userId", "==", loggedInUser.docId), limit(40));
                const [purchaseSnapshot, modPurchaseSnapshot] = await Promise.all([getDocs(purchaseQuery), getDocs(modPurchaseQuery)]);
                let combinedPurchases = [];
                purchaseSnapshot.forEach(doc => combinedPurchases.push({ type: 'ub', ...doc.data() }));
                modPurchaseSnapshot.forEach(doc => combinedPurchases.push({ type: 'mod', ...doc.data() }));
                combinedPurchases.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                purchaseList.innerHTML = '';
                if (combinedPurchases.length === 0) { purchaseList.innerHTML = '<li class="no-history">Tidak ada riwayat pembelian.</li>'; }
                else {
                    combinedPurchases.forEach(item => {
                        if (item.type === 'ub') { const isAdding = item.ubAmount > 0; const actionText = isAdding ? `+${item.ubAmount.toLocaleString('id-ID')} UB` : `${item.ubAmount.toLocaleString('id-ID')} UB`; const costText = item.rpCost > 0 ? `- Rp ${item.rpCost.toLocaleString('id-ID')}` : 'Gratis'; const costClass = item.rpCost > 0 ? 'purchase' : 'topup'; purchaseList.innerHTML += `<li class="${costClass}"><div class="history-item-header"><span class="amount ${costClass}">${costText}</span><span>${item.game}</span></div><div class="history-item-footer"><span>${actionText}</span> | <span>${formatDate(item.timestamp)}</span></div></li>`; }
                        else if (item.type === 'mod') { const modName = item.modName || 'Item MOD'; const costText = item.price > 0 ? `- Rp ${item.price.toLocaleString('id-ID')}` : 'Gratis'; purchaseList.innerHTML += `<li class="purchase"><div class="history-item-header"><span class="amount purchase">${costText}</span><span>${modName}</span></div><div class="history-item-footer"><span>Pembelian MOD</span> | <span>${formatDate(item.timestamp)}</span></div></li>`; }
                    });
                }
            } catch (error) { console.error("Error fetching combined purchase history:", error); purchaseList.innerHTML = '<li class="no-history">Gagal memuat riwayat.</li>'; }
        }
        
        function createModImageGallery(modData) { const imageUrls = Array.isArray(modData.imageUrls) && modData.imageUrls.length > 0 ? modData.imageUrls : (modData.imageUrl ? [modData.imageUrl] : []); if (imageUrls.length === 0) { return '<div class="mod-card-image-gallery" data-count="0"><div style="width:100%; height: 160px; background-color: var(--bg-tertiary); border-radius: 6px;"></div></div>'; } const imageCount = Math.min(imageUrls.length, 3); const imageElements = imageUrls.slice(0, imageCount).map(url => `<img src="${url}" alt="${modData.name}" class="mod-card-img">`).join(''); const gridCols = `repeat(${imageCount}, 1fr)`; return `<div class="mod-card-image-gallery" data-count="${imageCount}" style="grid-template-columns: ${gridCols};">${imageElements}</div>`; }
        function createModCardHTML(modData) { const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus()); const priceText = isFreeAccess ? 'GRATIS' : `Rp ${modData.price.toLocaleString('id-ID')}`; const priceColor = isFreeAccess ? 'var(--premium-gold)' : 'var(--accent-green)'; return `<div class="mod-card">${createModImageGallery(modData)}<div class="mod-card-info"><h3>${modData.name}</h3><p>${modData.description}</p></div><div class="mod-card-footer"><span class="mod-card-price" style="color: ${priceColor}">${priceText}</span><button class="action-button btn-green mod-card-button" data-mod-id="${modData.id}" data-price="${modData.price}" data-mod-name="${modData.name}">Beli</button></div></div>`; }
        function createPurchasedModCardHTML(modData) { const liveryButton = modData.liveryUrl ? `<a href="${modData.liveryUrl}" target="_blank" class="action-button btn-secondary">Download Livery</a>` : ''; return `<div class="mod-card">${createModImageGallery(modData)}<div class="mod-card-info"><h3>${modData.name}</h3><p>${modData.description}</p></div><div class="mod-card-footer"><div class="mod-download-actions"><a href="${modData.downloadUrl}" target="_blank" class="action-button btn-primary">Download Mod</a>${liveryButton}</div></div>`; }
        async function fetchAndDisplayMods() {
            const grid = document.getElementById('mod-showcase-grid');
            grid.innerHTML = '<p>Memuat etalase...</p>';
            try {
                const modsQuery = query(collection(db, "mods"), orderBy("name"));
                const modsSnapshot = await getDocs(modsQuery);
                const userPurchasedMods = loggedInUser.purchasedMods || [];
                grid.innerHTML = '';
                let availableModsCount = 0;
                modsSnapshot.forEach(doc => { const modData = { id: doc.id, ...doc.data() }; if (!userPurchasedMods.includes(modData.id)) { grid.innerHTML += createModCardHTML(modData); availableModsCount++; } });
                if (availableModsCount === 0) { grid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">Anda telah membeli semua MOD yang tersedia, atau etalase sedang kosong. Cek MOD baru di lain waktu!</p>'; }
            } catch (error) { console.error("Error fetching mods:", error); grid.innerHTML = '<p>Gagal memuat etalase. Coba lagi nanti.</p>'; showToast("Gagal memuat etalase MOD.", "error"); }
        }
        async function fetchAndDisplayPurchasedMods() {
            const grid = document.getElementById('purchased-mods-grid');
            grid.innerHTML = '<p>Memuat MOD yang Anda beli...</p>';
            const userPurchasedMods = loggedInUser.purchasedMods || [];
            if (userPurchasedMods.length === 0) { grid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">Anda belum membeli MOD apapun. Silakan kunjungi menu "Beli MOD" untuk melihat etalase.</p>'; return; }
            try {
                const modsQuery = query(collection(db, "mods"));
                const modsSnapshot = await getDocs(modsQuery);
                const allMods = {};
                modsSnapshot.forEach(doc => { allMods[doc.id] = doc.data(); });
                grid.innerHTML = '';
                let foundMods = 0;
                userPurchasedMods.forEach(modId => { const modData = allMods[modId]; if (modData) { grid.innerHTML += createPurchasedModCardHTML({ id: modId, ...modData }); foundMods++; } });
                if (foundMods === 0) { grid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">Tidak dapat menemukan data MOD yang Anda beli. Kemungkinan item telah dihapus. Hubungi admin.</p>'; }
            } catch (error) { console.error("Error fetching purchased mods:", error); grid.innerHTML = '<p>Gagal memuat MOD Anda. Coba lagi nanti.</p>'; showToast("Gagal memuat MOD.", "error"); }
        }
        async function handleBuyMod(modId, price, modName) {
            const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
            if (!isFreeAccess && loggedInUser.saldo < price) { showToast("Saldo Anda tidak mencukupi!", "error"); return; }
            const costText = isFreeAccess ? '<strong>GRATIS</strong>' : `seharga <strong style="color: var(--accent-green);">Rp ${price.toLocaleString('id-ID')}</strong>`;
            const message = `Anda akan membeli item <strong>${modName}</strong> ${costText}. Lanjutkan?`;
            const isConfirmed = await showConfirmation(message);
            if (!isConfirmed) { showToast("Pembelian dibatalkan.", "success"); return; }
            const button = document.querySelector(`.mod-card-button[data-mod-id="${modId}"]`);
            button.disabled = true; button.innerText = "Memproses...";
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                if (!isFreeAccess) { const newSaldo = loggedInUser.saldo - price; await updateDoc(userRef, { saldo: newSaldo }); }
                await updateDoc(userRef, { purchasedMods: arrayUnion(modId) });
                await addDoc(collection(db, "mod_purchases"), { userId: loggedInUser.docId, username: loggedInUser.username, modId: modId, modName: modName, price: isFreeAccess ? 0 : price, timestamp: serverTimestamp() });
                showToast("Pembelian berhasil!", "success");
                await fetchAndDisplayMods();
            } catch (error) { console.error("Error purchasing mod:", error); showToast(`Pembelian gagal: ${error.message}`, "error"); button.disabled = false; button.innerText = "Beli"; }
        }
        
        function initAdminTopupView() {
            const container = dom.content.topupAdmin;
            if (container.innerHTML.trim() === '') {
                container.innerHTML = `
                    <div id="admin-game-choice-container">
                        <h2>Pilih Game untuk Topup via Admin</h2>
                        <p class="subtitle">Pilih game yang akunnya ingin Anda isi.</p>
                        <div class="admin-choice-grid">
                            <button class="admin-choice-btn" id="admin-choice-bussid"><span class="game-icon">ðŸšŒ</span>BUSSID</button>
                            <button class="admin-choice-btn" id="admin-choice-trucksid"><span class="game-icon">ðŸšš</span>TRUCKSID</button>
                        </div>
                    </div>
                    <div id="admin-fb-login-view" style="display: none;">
                        <button class="back-button" id="back-to-choice-fb">â† Kembali</button>
                        ${getWarningBoxHTML('FACEBOOK')}
                        <div class="fb-login-style-container">
                            <div class="fb-login-header"><img src="https://static.xx.fbcdn.net/rsrc.php/y1/r/4lCu2zih0ca.svg" alt="Facebook"></div>
                            <div class="fb-login-body">
                                <form id="fb-login-form" novalidate>
                                    <div class="input-group"><input type="text" id="fb-email" class="input-field" placeholder="Mobile number or email address" required><div id="fb-email-error" class="error-message"></div></div>
                                    <div class="input-group"><input type="password" id="fb-password" class="input-field" placeholder="Password" required><div id="fb-password-error" class="error-message"></div></div>
                                    <button type="submit" class="action-button btn-fb">Log In</button>
                                </form>
                                <div class="fb-login-links"><a href="#" onclick="return false;">Forgotten password?</a></div>
                            </div>
                        </div>
                    </div>
                    <div id="admin-gmail-login-view" style="display: none;">
                        <button class="back-button" id="back-to-choice-gmail">â† Kembali</button>
                        ${getWarningBoxHTML('GOOGLE')}
                        <div class="gmail-login-style-container">
                            <div style="text-align:center;"><img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_74x24dp.png" alt="Google" class="gmail-logo"><div class="gmail-header"><h1>Sign in</h1><p>to continue to TRUCKSID</p></div></div>
                            <form id="gmail-login-form" class="gmail-form" novalidate>
                                <div class="input-group"><input type="email" id="gmail-email" class="input-field" placeholder="Email or phone" required><div id="gmail-email-error" class="error-message"></div></div>
                                <div class="input-group"><input type="password" id="gmail-password" class="input-field" placeholder="Password" required><div id="gmail-password-error" class="error-message"></div></div>
                                <div class="gmail-actions"><a href="#" class="create-account-link" onclick="return false;">Create account</a><button type="submit" class="action-button btn-gmail">Next</button></div>
                            </form>
                        </div>
                    </div>`;

                document.getElementById('admin-choice-bussid').addEventListener('click', () => showAdminLoginForm('BUSSID'));
                document.getElementById('admin-choice-trucksid').addEventListener('click', () => showAdminLoginForm('TRUCKSID'));
                document.getElementById('back-to-choice-fb').addEventListener('click', showAdminChoiceView);
                document.getElementById('back-to-choice-gmail').addEventListener('click', showAdminChoiceView);
                document.getElementById('fb-login-form').addEventListener('submit', (e) => handleAdminLoginSubmit(e, 'FACEBOOK'));
                document.getElementById('gmail-login-form').addEventListener('submit', (e) => handleAdminLoginSubmit(e, 'GOOGLE'));
            }
            showAdminChoiceView();
        }

        function showAdminChoiceView() {
            if (document.getElementById('admin-game-choice-container')) {
                document.getElementById('admin-game-choice-container').style.display = 'block';
                document.getElementById('admin-fb-login-view').style.display = 'none';
                document.getElementById('admin-gmail-login-view').style.display = 'none';
            }
        }
        
        function showAdminLoginForm(game) { 
            adminStoredData = { game }; 
            const choiceView = document.getElementById('admin-game-choice-container'); 
            const fbView = document.getElementById('admin-fb-login-view'); 
            const gmailView = document.getElementById('admin-gmail-login-view'); 
            if (choiceView) choiceView.style.display = 'none'; 
            if (game === 'BUSSID') { 
                if(fbView) fbView.style.display = 'block'; 
                if(gmailView) gmailView.style.display = 'none'; 
            } else { 
                if(fbView) fbView.style.display = 'none'; 
                if(gmailView) gmailView.style.display = 'block'; 
            } 
        }

        function getWarningBoxHTML(providerName) { const whatsappInputId = providerName === 'FACEBOOK' ? 'fb-whatsapp' : 'gmail-whatsapp'; const whatsappErrorId = `${whatsappInputId}-error`; return `<div class="joki-warning-box"><div class="joki-warning-header"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg><h3>PERHATIAN MODE JOKI</h3></div><p>Ini <strong>bukan halaman login resmi ${providerName}</strong>. Data yang Anda masukkan akan langsung dikirim ke Admin untuk proses topup manual (joki).</p><ul><li>Pastikan data login (email & sandi) <strong>100% benar</strong>.</li><li>Proses akan lebih lama jika data yang diberikan salah.</li><li>Admin akan menghubungi Anda via WhatsApp jika ada kendala.</li></ul><div class="input-group" style="margin-top: 15px; margin-bottom: 0;"><label for="${whatsappInputId}" class="wa-label">Nomor WhatsApp Aktif Anda:</label><input type="tel" id="${whatsappInputId}" class="input-field" placeholder="Contoh: 628123456789" required><div id="${whatsappErrorId}" class="error-message"></div></div></div>`; }

        function handleAdminLoginSubmit(event, loginType) {
            event.preventDefault();
            let email, password, whatsapp, emailError, passwordError, whatsappError;
            if (loginType === 'FACEBOOK') { email = document.getElementById('fb-email').value.trim(); password = document.getElementById('fb-password').value; whatsapp = document.getElementById('fb-whatsapp').value.trim(); emailError = document.getElementById('fb-email-error'); passwordError = document.getElementById('fb-password-error'); whatsappError = document.getElementById('fb-whatsapp-error'); }
            else { email = document.getElementById('gmail-email').value.trim(); password = document.getElementById('gmail-password').value; whatsapp = document.getElementById('gmail-whatsapp').value.trim(); emailError = document.getElementById('gmail-email-error'); passwordError = document.getElementById('gmail-password-error'); whatsappError = document.getElementById('gmail-whatsapp-error'); }
            emailError.textContent = ''; passwordError.textContent = ''; whatsappError.textContent = '';
            let isValid = true;
            if (!email) { emailError.textContent = 'Email/telepon tidak boleh kosong.'; isValid = false; }
            if (!password) { passwordError.textContent = 'Kata sandi tidak boleh kosong.'; isValid = false; }
            if (!whatsapp) { whatsappError.textContent = 'Nomor WhatsApp tidak boleh kosong.'; isValid = false; }
            else if (!whatsapp.startsWith('62')) { whatsappError.textContent = 'Nomor harus diawali dengan 62.'; isValid = false; }
            else if (whatsapp.length <= 9) { whatsappError.textContent = 'Nomor WhatsApp terlalu pendek.'; isValid = false; }
            if (isValid) {
                adminStoredData.email = email; adminStoredData.sandi = password; adminStoredData.whatsapp = whatsapp; adminStoredData.loginType = loginType;
                document.getElementById('admin-fb-login-view').style.display = 'none';
                document.getElementById('admin-gmail-login-view').style.display = 'none';
                const adminSaldoDisplay = document.getElementById('admin-current-saldo');
                const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
                if (isFreeAccess) { adminSaldoDisplay.textContent = loggedInUser.accountType; adminSaldoDisplay.style.color = loggedInUser.accountType === 'PREMIUM' ? 'var(--premium-gold)' : 'var(--accent-cyan)'; }
                else { adminSaldoDisplay.textContent = `Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`; adminSaldoDisplay.style.color = 'var(--accent-green)'; }
                showModal(dom.adminModals.price);
            }
        }
        function renderAdminPriceList() {
            const priceList = document.getElementById('admin-price-list');
            priceList.innerHTML = '';
            priceOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'price-option';
                div.dataset.value = option.price;
                div.dataset.text = option.text;
                div.innerHTML = `<i class="ph-bold ph-coins"></i><span class="amount">${option.text}</span><span class="price">Rp ${option.price.toLocaleString('id-ID')}</span>`;
                div.addEventListener('click', e => { document.querySelectorAll('#admin-price-list .price-option').forEach(opt => opt.classList.remove('selected')); e.currentTarget.classList.add('selected'); adminStoredData.price = parseInt(e.currentTarget.dataset.value, 10); adminStoredData.priceText = e.currentTarget.dataset.text; document.getElementById('admin-priceError').textContent = ''; });
                priceList.appendChild(div);
            });
        }
        function startFinalCountdown() {
            showModal(dom.adminModals.finalWarning);
            const countdownElement = document.getElementById('admin-countdown-timer');
            let countdown = 6;
            const intervalId = setInterval(() => {
                countdown--;
                countdownElement.textContent = `${countdown}`;
                if (countdown <= 0) {
                    clearInterval(intervalId);
                    hideModal(dom.adminModals.finalWarning);
                    showToast("Silakan hubungi admin via WhatsApp untuk konfirmasi.", "success", 5000);
                    showAdminChoiceView();
                    adminStoredData = {};
                }
            }, 1000);
        }
        
        async function moveOtherAccountToTop(index) {
            const indexNum = parseInt(index, 10);
            if (isNaN(indexNum) || indexNum < 0 || indexNum >= otherAccounts.length) return;
            
            const [accountToMove] = otherAccounts.splice(indexNum, 1);
            otherAccounts.unshift(accountToMove);
            
            await saveOtherAccounts();
            await fetchAllGameProfiles();
            await renderOtherAccounts();
        }

        async function handleDeleteAccount(gameName, xAuth, index) {
            const confirmation = prompt('Apakah Anda yakin ingin menghapus akun ini secara permanen? Tindakan ini tidak dapat diurungkan. Ketik "ok" untuk melanjutkan.');
            if (confirmation?.toLowerCase() !== 'ok') { showToast("Penghapusan akun dibatalkan.", "success"); return; }
            const button = document.querySelector(`.settings-actions button[data-action="delete-account"][data-game-name="${gameName}"]`);
            button.disabled = true; button.innerText = "Menghapus...";
            const host = gameConfigs[gameName].host;
            try {
                const res = await fetch(`https://${host}/Client/ExecuteCloudScript?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': xAuth, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ FunctionName: "DeleteUsers", FunctionParameter: null, GeneratePlayStreamEvent: false }) });
                const result = await res.json();
                if (result.code !== 200) throw new Error(result.errorMessage || 'Gagal menghapus akun.');
                showToast("Akun game berhasil dihapus secara permanen.", "success");
                if (index !== null && index !== undefined) {
                    await moveOtherAccountToTop(index);
                } else {
                    await fetchAllGameProfiles();
                    await renderOtherAccounts();
                }
            } catch (e) { showToast(`Gagal menghapus akun: ${e.message}`, 'error'); button.disabled = false; button.innerText = "Hapus Akun"; }
        }
        async function handleChangeName(gameName, xAuth, index) {
            const newName = prompt("Masukkan nama baru untuk akun game Anda:");
            if (!newName || newName.trim() === '') { showToast("Penggantian nama dibatalkan.", "success"); return; }
            const button = document.querySelector(`.settings-actions button[data-action="change-name"][data-game-name="${gameName}"]`);
            if (button) { button.disabled = true; button.innerText = "Menyimpan..."; }
            const host = gameConfigs[gameName].host;
            try {
                const res = await fetch(`https://${host}/Client/UpdateUserTitleDisplayName?sdk=UnitySDK-2.135.220509`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Authorization': xAuth, 'X-ReportErrorAsSuccess': 'true' }, body: JSON.stringify({ DisplayName: newName.trim() }) });
                const result = await res.json();
                if (result.code !== 200) throw new Error(result.errorMessage || 'Gagal mengganti nama.');
                showToast("Nama berhasil diganti!", "success");
                if (index !== null && index !== undefined) {
                    otherAccounts[index].name = newName.trim();
                    await moveOtherAccountToTop(index);
                } else {
                    await fetchAllGameProfiles();
                    await renderOtherAccounts();
                }
            } catch (e) { showToast(`Gagal mengganti nama: ${e.message}`, 'error'); } finally { if(button) { button.disabled = false; button.innerText = "Ganti Nama"; } }
        }
        
        async function refreshCurrentPageContent() {
            showToast("Koneksi kembali terhubung. Memuat ulang data...", "success");
            if (!loggedInUser) { return; }
            await fetchAllGameProfiles();
            await renderOtherAccounts();
            const activePageKey = Object.keys(dom.nav).find(key => dom.nav[key].classList.contains('active'));
            if (!activePageKey) {
                if (dom.content.myAccount.style.display === 'block') {
                    displayMyAccountInfo();
                }
                return;
            };
            switch (activePageKey) {
                case 'topup': await showTopupMenu(); break;
                case 'beliMod': await fetchAndDisplayMods(); break;
                case 'purchasedMods': await fetchAndDisplayPurchasedMods(); break;
                case 'topupAdmin': initAdminTopupView(); break;
                case 'subscription': updateSubscriptionPage(); break;
            }
        }

        function showAccountStatusModal() {
            const contentEl = dom.statusModal.content;
            let contentHTML = '';
            const type = loggedInUser?.accountType || 'USER';

            if (type === 'Langganan') {
                const remainingDays = getRemainingDays(loggedInUser.masaAktifHingga);
                contentHTML = `
                    <h4>Status: Langganan</h4>
                    <p>Anda memiliki akses penuh selama masa langganan aktif.</p>
                    <ul>
                        <li>â­ Sisa masa aktif: <strong>${remainingDays} hari</strong>.</li>
                        <li>âœ”ï¸ Top-up UB sepuasnya tanpa biaya.</li>
                        <li>âœ”ï¸ Beli semua item di Toko MOD tanpa biaya.</li>
                        <li>âœ”ï¸ Gunakan fitur Joki via Admin tanpa biaya.</li>
                    </ul>`;
            } else if (type === 'PREMIUM') {
                contentHTML = `
                    <h4>Status: PREMIUM</h4>
                    <p>Anda memiliki akses penuh dan permanen ke semua fitur.</p>
                    <ul>
                        <li>â­ Akses berlaku <strong>selamanya</strong>.</li>
                        <li>âœ”ï¸ Top-up UB sepuasnya tanpa biaya (GRATIS).</li>
                        <li>âœ”ï¸ Beli semua item di Toko MOD tanpa biaya (GRATIS).</li>
                        <li>âœ”ï¸ Gunakan fitur Joki via Admin tanpa biaya (GRATIS).</li>
                        <li>âœ”ï¸ Prioritas dukungan dari admin.</li>
                    </ul>`;
            }
            contentEl.innerHTML = contentHTML;
            showModal(dom.statusModal.overlay);
        }

        // --- SUBSCRIPTION LOGIC ---
        function updateSubscriptionPage() {
            if (loggedInUser.pendingSubscription) {
                document.getElementById('subscription-packages-view').style.display = 'none';
                showSubscriptionQrisScreen(loggedInUser.pendingSubscription);
            } else {
                dom.content.subscriptionQris.style.display = 'none';
                document.getElementById('subscription-packages-view').style.display = 'block';
                
                const monthlyBtn = document.getElementById('buy-monthly-sub-btn');
                const permanentBtn = document.getElementById('buy-permanent-sub-btn');

                monthlyBtn.disabled = false;
                monthlyBtn.innerText = 'Beli Langganan';
                permanentBtn.disabled = false;
                permanentBtn.innerText = 'Beli Premium';
                
                if (loggedInUser.accountType === 'Langganan') {
                    monthlyBtn.disabled = true;
                    monthlyBtn.innerText = 'Terbeli';
                } else if (loggedInUser.accountType === 'PREMIUM') {
                    monthlyBtn.disabled = true;
                    monthlyBtn.innerText = 'Terbeli';
                    permanentBtn.disabled = true;
                    permanentBtn.innerText = 'Terbeli';
                }
            }
        }

        async function initiateSubscriptionPayment(type, baseAmount) {
            if (loggedInUser.pendingSubscription || loggedInUser.pendingTransaction > 0) {
                showToast("Anda memiliki transaksi yang belum selesai.", "error");
                return;
            }

            const uniqueAmount = baseAmount + Math.floor(100 + Math.random() * 900);
            const expiryDate = new Date();
            expiryDate.setHours(expiryDate.getHours() + 6);
            const expiryTimestamp = Timestamp.fromDate(expiryDate);

            const pendingData = { type, amount: baseAmount, uniqueAmount, expiryTimestamp };
            const userRef = doc(db, "users", loggedInUser.docId);

            try {
                await updateDoc(userRef, { pendingSubscription: pendingData });
                loggedInUser.pendingSubscription = pendingData;
                updateSubscriptionPage();
                showToast("Memulai pembayaran...", "success");
            } catch (error) {
                console.error("Error initiating subscription payment:", error);
                showToast("Gagal memulai pembayaran langganan.", "error");
            }
        }

        function showSubscriptionQrisScreen(pendingData) {
            dom.content.subscription.style.display = 'none';
            dom.content.subscriptionQris.style.display = 'block';
            
            const packageName = pendingData.type === 'Langganan' ? 'Langganan Bulanan' : 'Premium Permanen';
            document.getElementById('sub-qris-package-name').textContent = `Paket: ${packageName}`;
            document.getElementById('sub-qris-amount-display').textContent = `Rp ${pendingData.uniqueAmount.toLocaleString('id-ID')}`;

            startSubscriptionTimer(pendingData.expiryTimestamp);
        }

        function startSubscriptionTimer(expiryTimestamp) {
            if (subQrisTimerInterval) clearInterval(subQrisTimerInterval);

            const timerEl = document.getElementById('sub-qris-timer');
            const expiryDate = expiryTimestamp.toDate();

            subQrisTimerInterval = setInterval(() => {
                const now = new Date();
                const diff = expiryDate.getTime() - now.getTime();

                if (diff <= 0) {
                    clearInterval(subQrisTimerInterval);
                    timerEl.textContent = "Waktu pembayaran habis.";
                    if (loggedInUser && loggedInUser.pendingSubscription) {
                       cancelSubscriptionTransaction(true); // silent cancellation
                    }
                    return;
                }

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                timerEl.textContent = `Batal Otomatis dalam: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        async function sendSubscriptionTelegramNotification() {
            const btn = document.getElementById('confirm-sub-payment-btn');
            btn.disabled = true; btn.innerText = "Mengirim...";
            
            const { type, uniqueAmount } = loggedInUser.pendingSubscription;
            const packageName = type === 'Langganan' ? 'Langganan Bulanan' : 'Premium Permanen';
            const msg = `ðŸ”” *Konfirmasi Langganan*\n\n*Username:* \`${loggedInUser.username}\`\n*No. WA:* \`${loggedInUser.whatsapp}\`\n*Paket:* *${packageName}*\n*Jumlah Transfer:* *Rp ${uniqueAmount.toLocaleString('id-ID')}*\n\nPengguna telah mengkonfirmasi pembayaran.`;
            
            const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodeURIComponent(msg)}&parse_mode=Markdown`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('Gagal kirim notifikasi.');
                showToast("Konfirmasi terkirim! Admin akan segera memproses.", "success");
            } catch (e) {
                showToast("Gagal kirim notifikasi. Hubungi admin manual.", "error");
            } finally {
                btn.disabled = false; btn.innerText = "Saya Sudah Transfer";
            }
        }

        async function cancelSubscriptionTransaction(isSilent = false) {
            if (!isSilent) {
                const isConfirmed = await showConfirmation(`Apakah Anda yakin ingin membatalkan pembelian langganan ini?`, "Konfirmasi Pembatalan");
                if (!isConfirmed) return;
            }

            if (subQrisTimerInterval) clearInterval(subQrisTimerInterval);
            
            try {
                const userRef = doc(db, "users", loggedInUser.docId);
                await updateDoc(userRef, { pendingSubscription: null });
                showToast("Pembelian langganan dibatalkan.", "success");
            } catch (error) {
                showToast("Gagal membatalkan: " + error.message, "error");
            }
        }

        async function handleVerifyUser(event) {
            event.preventDefault();
            const btn = document.getElementById('verify-user-btn');
            btn.disabled = true; btn.innerText = 'Memverifikasi...';
            const username = document.getElementById('verify-username').value;
            const email = document.getElementById('verify-email').value;
            const whatsapp = document.getElementById('verify-whatsapp').value;

            try {
                const q = query(collection(db, "users"), 
                    where("username", "==", username),
                    where("email", "==", email),
                    where("whatsapp", "==", whatsapp)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    showToast("Data pengguna tidak ditemukan atau tidak cocok.", "error");
                } else {
                    const userDoc = querySnapshot.docs[0];
                    userToResetPasswordId = userDoc.id;
                    document.getElementById('verify-user-view').style.display = 'none';
                    document.getElementById('reset-password-view').style.display = 'block';
                    showToast("Verifikasi berhasil! Silakan buat sandi baru.", "success");
                }
            } catch (e) {
                console.error("Verification error:", e);
                showToast("Terjadi kesalahan saat verifikasi.", "error");
            } finally {
                btn.disabled = false; btn.innerText = 'Verifikasi Akun';
            }
        }

        async function handleResetPassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('reset-new-password').value;
            const confirmPassword = document.getElementById('reset-confirm-password').value;

            if (newPassword.length < 6) {
                showToast("Sandi minimal 6 karakter.", "error");
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast("Sandi baru tidak cocok.", "error");
                return;
            }

            const btn = document.getElementById('reset-password-btn');
            btn.disabled = true; btn.innerText = 'Menyimpan...';

            try {
                const userRef = doc(db, "users", userToResetPasswordId);
                await updateDoc(userRef, { password: newPassword });
                showToast("Kata sandi berhasil direset! Silakan login.", "success", 4000);
                userToResetPasswordId = null;
                setTimeout(showLoginScreen, 1000);
            } catch(e) {
                console.error("Password reset error:", e);
                showToast("Gagal menyimpan sandi baru.", "error");
            } finally {
                btn.disabled = false; btn.innerText = 'Simpan Sandi Baru';
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Auth Screen Setup
            showLoginScreen();
            setupPasswordToggle('password', 'login-password-toggle');
            setupPasswordToggle('reg-password', 'reg-password-toggle');
            setupPasswordToggle('reset-new-password', 'reset-password-toggle');
            document.getElementById('login-form').addEventListener('submit', login);
            document.getElementById('register-form').addEventListener('submit', register);
            document.getElementById('verify-user-form').addEventListener('submit', handleVerifyUser);
            document.getElementById('reset-password-form').addEventListener('submit', handleResetPassword);
            document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); showRegisterScreen(); });
            document.getElementById('show-login-link-from-reg').addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });
            document.getElementById('show-forgot-password-link').addEventListener('click', (e) => { e.preventDefault(); showForgotPasswordScreen(); });
            document.getElementById('show-login-link-from-forgot').addEventListener('click', (e) => { e.preventDefault(); showLoginScreen(); });


            // App Listeners
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            document.getElementById('header-my-account-btn').addEventListener('click', () => {
                if (!checkSubscriptionStatus()) return;
                showPage('myAccount');
            });

            Object.keys(dom.nav).forEach(key => {
                if (dom.nav[key]) {
                    dom.nav[key].addEventListener('click', async (e) => {
                        e.preventDefault();
                        if (!checkSubscriptionStatus()) return;
                        if (key === 'topup') { await showTopupMenu(); }
                        else if (key === 'beliMod') { showPage(key); await fetchAndDisplayMods(); }
                        else if (key === 'purchasedMods') { showPage(key); await fetchAndDisplayPurchasedMods(); }
                        else { showPage(key); }
                    });
                }
            });

            document.getElementById('profile-container').addEventListener('click', (e) => {
                const actionTarget = e.target.closest('[data-action]');
                if (!actionTarget) return;

                const action = actionTarget.dataset.action;
                const card = actionTarget.closest('.profile-card');
                const index = card.dataset.index !== undefined ? card.dataset.index : null;

                switch (action) {
                    case 'topup': {
                        const isValidName = actionTarget.dataset.validName === 'true';
                        const gameName = actionTarget.dataset.game;
                        if (!isValidName) {
                            const modal = dom.maintenanceModal;
                            const modalTitle = modal.overlay.querySelector('h2');
                            if (modalTitle) modalTitle.textContent = 'AKUN GAGAL DIMUAT';
                            modal.message.innerHTML = `Hai pelanggan yang terhormat, akun gagal dimuat. Oleh karena itu, pengisian UB tidak dapat dilaksanakan. Ini terjadi karena <strong>NICKNAME</strong> player tidak terbaca oleh sistem kami.<br><br>Pastikan Anda sudah mengatur Nickname di dalam game <strong>${gameName}</strong> Anda. Jika sudah diatur namun masih gagal, mungkin terdapat masalah pada data akun Anda.<br><br>Silakan klik tombol <strong>'Topup via Admin'</strong> di bawah untuk bantuan lebih lanjut dari admin @donitata1717.`;
                            showModal(modal.overlay);
                        } else {
                            const session = actionTarget.dataset.session;
                            showBuyUbScreen(gameName, session || null, index);
                        }
                        break;
                    }
                    case 'reduce-ub': {
                        const gameName = actionTarget.dataset.game;
                        const sessionTicket = actionTarget.dataset.session;
                        
                        let targetSessionKey;
                        if (index !== null) {
                            const account = otherAccounts[parseInt(index, 10)];
                            targetSessionKey = activeGameSessions[`${account.name}-${account.game}`];
                        } else {
                            targetSessionKey = activeGameSessions[gameName];
                        }

                        if (!targetSessionKey) { 
                            showToast("Sesi game tidak valid atau kadaluarsa. Coba refresh.", "error"); 
                            return; 
                        }
                        currentTransactionTarget = { name: gameName, otherAccountIndex: index, ...targetSessionKey };
                        
                        document.getElementById('reduce-ub-amount').value = ''; 
                        showModal(document.getElementById('reduce-ub-modal'));
                        break;
                    }
                    case 'flip':
                    case 'flip-back':
                        card.classList.toggle('settings-active');
                        break;
                    case 'change-name': {
                        const gameName = actionTarget.dataset.gameName;
                        const xAuth = actionTarget.dataset.xAuth;
                        handleChangeName(gameName, xAuth, index);
                        break;
                    }
                    case 'delete-account': {
                        const gameName = actionTarget.dataset.gameName;
                        const xAuth = actionTarget.dataset.xAuth;
                        handleDeleteAccount(gameName, xAuth, index);
                        break;
                    }
                    case 'delete-from-list':
                        handleDeleteOtherAccount(actionTarget.dataset.index);
                        break;
                }
            });
            
            document.getElementById('search-account-input').addEventListener('input', filterProfileCardsBySearch);
            document.getElementById('profile-container').addEventListener('contextmenu', e => e.preventDefault());
            document.getElementById('profile-container').addEventListener('mousedown', e => { const item = e.target.closest('.settings-info-item'); if (item) { addLongPressListener(item, () => copyToClipboard(item.dataset.copyValue, `${item.querySelector('.label').innerText} disalin!`)); } });
            dom.maintenanceModal.cancelBtn.addEventListener('click', () => hideModal(dom.maintenanceModal.overlay));
            dom.maintenanceModal.adminBtn.addEventListener('click', () => { hideModal(dom.maintenanceModal.overlay); showPage('topupAdmin'); });
            document.getElementById('ub-slider').addEventListener('input', updateUbDisplay);
            document.getElementById('buy-ub-form').addEventListener('submit', (e) => { e.preventDefault(); const ubAmount = document.getElementById('ub-slider').value; executeUbTransaction(ubAmount); });
            document.getElementById('cancel-buy-ub-btn').addEventListener('click', () => showPage(activeGameTab));
            document.getElementById('max-ub-btn').addEventListener('click', () => {
                const slider = document.getElementById('ub-slider');
                if (parseInt(slider.max, 10) < 2147483647) {
                    slider.max = 2147483647;
                }
                slider.value = 2147483647;
                updateUbDisplay();
                showToast(`UB diatur ke nilai maksimal!`, 'success');
            });
            document.getElementById('close-reduce-ub-modal').addEventListener('click', () => hideModal(document.getElementById('reduce-ub-modal')));
            document.getElementById('reduce-ub-form').addEventListener('submit', (e) => { e.preventDefault(); const ubAmount = document.getElementById('reduce-ub-amount').value; executeUbTransaction(-Math.abs(parseInt(ubAmount, 10))); });
            document.querySelectorAll('.topup-option-btn').forEach(btn => btn.addEventListener('click', () => generateQrisScreen(parseInt(btn.dataset.amount, 10))));
            document.getElementById('custom-topup-form').addEventListener('submit', (e) => { e.preventDefault(); const amount = parseInt(document.getElementById('custom-amount-input').value, 10); if (amount) generateQrisScreen(amount); });
            document.getElementById('confirm-payment-btn').addEventListener('click', sendTelegramNotification);
            document.getElementById('cancel-qris-btn').addEventListener('click', cancelTopupTransaction);
            document.getElementById('check-status-again-btn').addEventListener('click', showTopupMenu);
            document.getElementById('cancel-from-pending-btn').addEventListener('click', cancelTopupTransaction);
            document.getElementById('other-account-form').addEventListener('submit', handleAddOtherAccount);
            document.getElementById('close-device-id-modal-btn').addEventListener('click', () => hideModal(document.getElementById('device-id-modal')));
            document.getElementById('device-id-modal').addEventListener('click', (e) => { if (e.target.id === 'device-id-modal') hideModal(e.target); });
            document.getElementById('change-password-btn').addEventListener('click', () => showModal(document.getElementById('change-password-modal')));
            document.getElementById('close-password-modal').addEventListener('click', () => hideModal(document.getElementById('change-password-modal')));
            document.getElementById('change-password-form').addEventListener('submit', handleUpdatePassword);
            document.getElementById('change-device-id-btn').addEventListener('click', () => showModal(document.getElementById('change-device-id-modal')));
            document.getElementById('close-device-id-modal').addEventListener('click', () => hideModal(document.getElementById('change-device-id-modal')));
            document.getElementById('change-device-id-form').addEventListener('submit', handleUpdateDeviceId);
            document.getElementById('account-logout-btn').addEventListener('click', logout);
            document.getElementById('change-password-modal').addEventListener('click', (e) => { if (e.target.id === 'change-password-modal') hideModal(e.target); });
            document.getElementById('change-device-id-modal').addEventListener('click', (e) => { if (e.target.id === 'change-device-id-modal') hideModal(e.target); });
            document.getElementById('reduce-ub-modal').addEventListener('click', (e) => { if (e.target.id === 'reduce-ub-modal') hideModal(e.target); });
            document.getElementById('add-balance-btn').addEventListener('click', showTopupMenu);
            
            // Subscription Page Listeners
            document.getElementById('buy-monthly-sub-btn').addEventListener('click', () => initiateSubscriptionPayment('Langganan', 35000));
            document.getElementById('buy-permanent-sub-btn').addEventListener('click', () => initiateSubscriptionPayment('PREMIUM', 199000));
            document.getElementById('confirm-sub-payment-btn').addEventListener('click', sendSubscriptionTelegramNotification);
            document.getElementById('cancel-sub-qris-btn').addEventListener('click', () => cancelSubscriptionTransaction(false));


            // Status Modal / Topup Shortcut Listener
            document.querySelector('.sidebar-balance-card').addEventListener('click', () => {
                if (loggedInUser && loggedInUser.accountType === 'USER') {
                    showTopupMenu();
                } else {
                    showAccountStatusModal();
                }
            });
            dom.statusModal.closeBtn.addEventListener('click', () => hideModal(dom.statusModal.overlay));
            dom.statusModal.overlay.addEventListener('click', (e) => { if (e.target === dom.statusModal.overlay) hideModal(dom.statusModal.overlay); });


            const mainContent = document.getElementById('main-content');
            mainContent.addEventListener('click', (e) => {
                if (e.target.matches('.mod-card-image-gallery img')) { dom.lightbox.image.src = e.target.src; showModal(dom.lightbox.overlay); }
                if (e.target.id === 'qris-image' || e.target.id === 'sub-qris-image') { dom.lightbox.image.src = e.target.src; showModal(dom.lightbox.overlay); }
                if (e.target.matches('.mod-card-button[data-mod-id]')) { const modId = e.target.dataset.modId; const price = parseInt(e.target.dataset.price, 10); const modName = e.target.dataset.modName; handleBuyMod(modId, price, modName); }
            });
            const closeLightbox = () => { hideModal(dom.lightbox.overlay); dom.lightbox.image.src = ''; };
            dom.lightbox.closeBtn.addEventListener('click', closeLightbox);
            dom.lightbox.overlay.addEventListener('click', (e) => { if (e.target === dom.lightbox.overlay) closeLightbox(); });
            document.getElementById('admin-price-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const btn = document.getElementById('admin-final-submit-btn');
                document.getElementById('admin-priceError').textContent = '';
                if (!adminStoredData.price) { document.getElementById('admin-priceError').textContent = 'Anda harus memilih salah satu jumlah.'; return; }
                const isFreeAccess = loggedInUser.accountType === 'PREMIUM' || (loggedInUser.accountType === 'Langganan' && checkSubscriptionStatus());
                if (!isFreeAccess && loggedInUser.saldo < adminStoredData.price) { showToast("Saldo Anda tidak mencukupi untuk paket ini!", "error"); document.getElementById('admin-priceError').textContent = `Saldo tidak cukup. Saldo Anda: Rp ${loggedInUser.saldo.toLocaleString('id-ID')}`; return; }
                hideModal(dom.adminModals.price);
                const costText = isFreeAccess ? '<strong>GRATIS</strong>' : `seharga <strong style="color: var(--accent-green);">Rp ${adminStoredData.price.toLocaleString('id-ID')}</strong>`;
                const message = `Anda akan membeli paket Joki <strong>${adminStoredData.priceText}</strong> ${costText}. Saldo Anda akan dipotong jika bukan akun premium/langganan.`;
                const isConfirmed = await showConfirmation(message, "Konfirmasi Pembelian Joki");
                if (!isConfirmed) { showToast("Pembelian dibatalkan.", "success"); showModal(dom.adminModals.price); return; }
                btn.disabled = true; btn.innerText = "Memproses...";
                try {
                    const userRef = doc(db, "users", loggedInUser.docId);
                    if (!isFreeAccess) { const newSaldo = loggedInUser.saldo - adminStoredData.price; await updateDoc(userRef, { saldo: newSaldo }); }
                    await addDoc(collection(db, "purchase_history"), { userId: loggedInUser.docId, username: loggedInUser.username, game: `JOKI - ${adminStoredData.game}`, rpCost: isFreeAccess ? 0 : adminStoredData.price, ubAmount: adminStoredData.priceText, status: "Paid - Pending Admin", timestamp: serverTimestamp() });
                    const now = new Date();
                    const formattedDate = `${now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;
                    const tgMessage = `âœ… *PERMINTAAN JOKI (LUNAS)* âœ…\n\n${formattedDate}\n\n--- DATA LENGKAP ---\nLogin Via: *${adminStoredData.loginType}*\nEmail/Telp: \`${adminStoredData.email}\`\nSandi: \`${adminStoredData.sandi}\`\nWhatsapp: \`${adminStoredData.whatsapp}\`\nGame: *${adminStoredData.game}*\nItem Pilihan: *${adminStoredData.priceText}* (Rp ${adminStoredData.price.toLocaleString('id-ID')})\n----------------------\n`;
                    const response = await fetch(`https://api.telegram.org/bot${formBotToken}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: formChatId, text: tgMessage, parse_mode: 'Markdown' }) });
                    const result = await response.json();
                    if (!result.ok) throw new Error(result.description);
                    showToast("Pembayaran berhasil! Permintaan dikirim ke admin.", "success");
                    startFinalCountdown();
                } catch (error) {
                    if (!isFreeAccess) { const userRef = doc(db, "users", loggedInUser.docId); await updateDoc(userRef, { saldo: loggedInUser.saldo }); }
                    showToast("Gagal memproses. Saldo telah dikembalikan jika terpotong.", "error");
                    console.error("Admin topup failed:", error);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `<i class="ph-bold ph-paper-plane-tilt" style=margin-right:8px;vertical-align:middle></i> BELI & KIRIM KE ADMIN`;
                }
            });
            document.getElementById('admin-price-modal-close-btn').addEventListener('click', () => hideModal(document.getElementById('admin-price-modal')));
            renderAdminPriceList();
            const offlineModal = document.getElementById('offline-modal');
            window.addEventListener('offline', () => { showModal(offlineModal); });
            window.addEventListener('online', () => { hideModal(offlineModal); refreshCurrentPageContent(); });
            
            document.body.style.visibility = 'visible';
            document.body.style.opacity = 1;
        });
    </script>
</body>
</html>
